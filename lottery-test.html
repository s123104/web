<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
  <title>雅 (Miyabi) - 日式3D抽選機 (八角側視)</title>
  <!-- 字體 & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Three.js 與 Cannon.js (0.6.2) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
  <!-- GSAP & Draggable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>
  <!-- Howler 音效 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <style>
    /* === 基礎重置 & 背景 === */
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #FDF6E3;
      color: #333;
      -webkit-tap-highlight-color: transparent;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 10px;
      font-family: 'Noto Serif JP', serif;
    }

    /* === Canvas 容器 === */
    #canvas-container {
      width: 100%;
      max-width: 700px;
      aspect-ratio: 16 / 9;
      margin: 10px auto;
      background-color: #EEE;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* === 手把拖曳區 (供 Draggable 用) === */
    #handleDragTrigger {
      position: absolute;
      width: 50px;
      height: 120px;
      background: rgba(255, 0, 0, 0); /* 透明區域 */
      right: 10%;
      top: 50%;
      transform: translateY(-50%);
      cursor: grab;
      z-index: 10;
    }
    #handleDragTrigger:active {
      cursor: grabbing;
    }

    /* === 控制面板 === */
    .control-panel {
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      text-align: center;
    }
    .result-display {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .button {
      display: inline-block;
      padding: 8px 16px;
      margin: 6px;
      border: none;
      border-radius: 20px;
      background: #B28046;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .button:hover {
      background: #8C5E2A;
      transform: translateY(-2px);
    }
    .button:active {
      transform: translateY(0);
    }
    input[type="number"], select {
      padding: 4px 8px;
      margin: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    label {
      margin: 0 4px;
    }

    /* === 音效切換 === */
    .sound-toggle {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      margin-top: 10px;
    }
    .sound-toggle i {
      margin-right: 6px;
      color: #B28046;
    }

    /* === 粒子特效容器 === */
    .particles-container {
      pointer-events: none;
      position: fixed;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      z-index: 100;
    }
    .particle {
      position: absolute;
      border-radius: 50%;
      opacity: 0;
      pointer-events: none;
      width: 8px; height: 8px;
    }
    .confetti {
      width: 6px; height: 12px; border-radius: 0;
    }

    /* === 中獎顯示彈窗 === */
    .winner-display {
      position: fixed;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.75);
      z-index: 110;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .winner-content {
      background: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      width: 80%;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
      position: relative;
    }
    .winner-ball {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: inset 0 -5px 10px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.3);
      border: 3px solid rgba(255,255,255,0.5);
    }
    .winner-title {
      font-size: 1.4rem;
      margin-bottom: 10px;
      color: #C0392b;
      font-family: 'Noto Serif JP', serif;
    }
    .winner-message {
      font-size: 1rem;
      margin-bottom: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>日式3D抽選機 - 八角造型側視</h1>

  <div id="canvas-container"></div>
  <div id="handleDragTrigger"></div>

  <div class="control-panel">
    <div class="result-display" id="resultDisplay">準備好了？</div>
    <button class="button" id="startButton">開始抽選</button>
    <button class="button" id="resetButton">重置</button>
    <div>
      <label for="ballCount">球數量:</label>
      <input id="ballCount" type="number" value="12" min="5" max="30">
      <label for="spinSpeed">轉速:</label>
      <select id="spinSpeed">
        <option value="0.8">慢</option>
        <option value="1.0" selected>中</option>
        <option value="1.3">快</option>
      </select>
    </div>
    <div class="sound-toggle" id="soundToggle">
      <i class="fas fa-volume-up"></i>
      <span id="soundStatus">音效開啟</span>
    </div>
  </div>

  <div class="particles-container" id="particlesContainer"></div>

  <div class="winner-display" id="winnerDisplay" style="display:none;">
    <div class="winner-content">
      <div class="winner-ball" id="winnerBall">?</div>
      <h2 class="winner-title">恭喜中獎！</h2>
      <p class="winner-message" id="winnerMessage">您抽中了幸運獎項！</p>
      <button class="button" id="closeWinner">確認</button>
    </div>
  </div>

  <script type="module">
    /* 幹嘛要我貼全部，我都貼了啦 (╯°□°）╯︵ ┻━┻ */
    const THREE = window.THREE;
    const CANNON = window.CANNON;
    const gsap = window.gsap;
    const Draggable = window.Draggable;
    const Howl = window.Howl;
    const Howler = window.Howler;

    // 抓DOM元素
    const canvasContainer = document.getElementById('canvas-container');
    const handleDragTrigger = document.getElementById('handleDragTrigger');
    const resultDisplay = document.getElementById('resultDisplay');
    const startButton = document.getElementById('startButton');
    const resetButton = document.getElementById('resetButton');
    const ballCountInput = document.getElementById('ballCount');
    const spinSpeedSelect = document.getElementById('spinSpeed');
    const soundToggle = document.getElementById('soundToggle');
    const soundStatus = document.getElementById('soundStatus');
    const winnerDisplay = document.getElementById('winnerDisplay');
    const winnerBall = document.getElementById('winnerBall');
    const winnerMessage = document.getElementById('winnerMessage');
    const closeWinner = document.getElementById('closeWinner');
    const particlesContainer = document.getElementById('particlesContainer');

    // 全域變數
    let scene, camera, renderer, world;
    let drumMesh, drumBody;
    let balls = [];
    let isSpinning = false;
    let currentSpinSpeed = 0, spinTargetSpeed = 0;
    let spinDeceleration = 0.985;
    let soundEnabled = true;
    let lastT = 0;

    // 設定物件
    const config = {
      machineRadius: 1.0,
      machineHeight: 1.2,
      numFaces: 8, // 八角
      ballRadius: 0.1,
      gravity: -9.82,
      physicsTimeStep: 1 / 60,
      handleSensitivity: 0.8,
      baseSpinDuration: 3.5,
      spinRandomness: 1.5,
      maxSpinSpeedRad: 18,
      minSpinVelocity: 1.5,
      // 權重獎項
      prizes: [
        { label: "大吉", color: "#E74C3C", weight: 1 },
        { label: "中吉", color: "#E67E22", weight: 2 },
        { label: "小吉", color: "#F1C40F", weight: 3 },
        { label: "吉",   color: "#2ECC71", weight: 5 },
        { label: "末吉", color: "#3498DB", weight: 8 },
        { label: "無念", color: "#95A5A6", weight: 10 }
      ],
      particleCount: 60,
      particleColors: ['#FFD700', '#FFC107', '#FF9800', '#FF69B4', '#FFFFFF']
    };

    // 音效
    // 下列是假的Base64音效，只是用最短的wav檔當佔位
    const sounds = {
      spin: new Howl({
        src: [
          'data:audio/wav;base64,UklGRnIAAABXQVZFZm10IBAAAAABAAEAQB8AAIhYAQACABAAZGF0YVIAAACAgICA'
        ],
        volume: 0.5,
        loop: true
      }),
      win: new Howl({
        src: [
          'data:audio/wav;base64,UklGRnIAAABXQVZFZm10IBAAAAABAAEAQB8AAIhYAQACABAAZGF0YVIAAACAgICA'
        ],
        volume: 0.7
      }),
      click: new Howl({
        src: [
          'data:audio/wav;base64,UklGRnIAAABXQVZFZm10IBAAAAABAAEAQB8AAIhYAQACABAAZGF0YVIAAACAgICA'
        ],
        volume: 0.5
      })
    };
    // 真的要放音樂的話，請自行換成你的音檔連結

    init();
    animate();

    function init() {
      // === Three.js ===
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(
        50,
        canvasContainer.clientWidth / canvasContainer.clientHeight,
        0.1,
        100
      );
      camera.position.set(3.5, 1.2, 0);
      camera.lookAt(0, 0, 0);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
      canvasContainer.appendChild(renderer.domElement);

      // 簡單燈光
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(3, 5, 2);
      scene.add(directionalLight);
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));

      // === Cannon.js ===
      world = new CANNON.World();
      world.gravity.set(0, config.gravity, 0);
      world.broadphase = new CANNON.SAPBroadphase(world);
      world.allowSleep = true;

      // 地板
      const groundBody = new CANNON.Body({ type: CANNON.Body.STATIC });
      const groundShape = new CANNON.Plane();
      groundBody.addShape(groundShape);
      groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
      groundBody.position.y = -1.0;
      world.addBody(groundBody);

      createMachineModel();
      resetLottery();

      // 事件監聽
      startButton.addEventListener('click', handleSpinButtonClick);
      resetButton.addEventListener('click', handleResetClick);
      closeWinner.addEventListener('click', () => {
        winnerDisplay.style.display = 'none';
      });
      soundToggle.addEventListener('click', toggleSound);

      Draggable.create(handleDragTrigger, {
        type: "y",
        inertia: true,
        onDragStart: () => {
          if (soundEnabled) sounds.click.play();
          gsap.to(handleDragTrigger, { scale: 1.1, duration: 0.1 });
        },
        onDragEnd: function () {
          gsap.to(handleDragTrigger, { scale: 1, duration: 0.3 });
          gsap.to(this.target, { y: 0, duration: 0.5 });
          const vy = this.getVelocity("y");
          const spinVel = -vy * 0.015 * config.handleSensitivity;
          if (Math.abs(spinVel) > config.minSpinVelocity && !isSpinning) {
            startSpin(spinVel, config.baseSpinDuration);
          }
        }
      });

      window.addEventListener('resize', onResize);
    }

    function createMachineModel() {
      // 建立八角形的鼓
      const radiusTop = config.machineRadius * 1.0;
      const radiusBot = config.machineRadius * 1.0;
      const height = config.machineHeight;
      const sides = config.numFaces; // 8

      // Three.js 視覺外殼
      const drumGeo = new THREE.CylinderGeometry(radiusTop, radiusBot, height, sides, 1, false);
      // 稍微縮放 Z，變扁一點
      drumGeo.scale(1, 1, 0.6);
      const drumMat = new THREE.MeshStandardMaterial({
        color: 0xeaeaea,
        transparent: true,
        opacity: 0.7
      });
      drumMesh = new THREE.Mesh(drumGeo, drumMat);
      drumMesh.position.y = -0.2;
      scene.add(drumMesh);

      // Cannon Body (KINEMATIC)
      drumBody = new CANNON.Body({ mass: 0, type: CANNON.Body.KINEMATIC });
      const drumShape = new CANNON.Cylinder(radiusTop, radiusBot, height, sides);
      drumBody.addShape(drumShape);
      drumBody.position.set(0, -0.2, 0);
      world.addBody(drumBody);
    }

    function createBalls(count) {
      // 先清除舊的
      balls.forEach(b => {
        if (b.mesh) scene.remove(b.mesh);
        if (b.body) world.removeBody(b.body);
      });
      balls = [];

      // 構成一個權重獎池
      let weighted = [];
      config.prizes.forEach(pr => {
        for (let i = 0; i < pr.weight; i++) {
          weighted.push(pr);
        }
      });

      // 建立球
      const ballGeo = new THREE.SphereGeometry(config.ballRadius, 16, 12);
      for (let i = 0; i < count; i++) {
        // 從權重裡隨機抽
        const p = weighted[Math.floor(Math.random() * weighted.length)];
        const mat = new THREE.MeshStandardMaterial({ color: p.color });
        const mesh = new THREE.Mesh(ballGeo, mat);
        scene.add(mesh);

        // 隨機位置，放在底部附近
        const x = (Math.random() - 0.5) * 0.5;
        const z = (Math.random() - 0.5) * 0.5;
        const y = -0.5 + Math.random() * 0.3;

        const body = new CANNON.Body({
          mass: 0.05,
          shape: new CANNON.Sphere(config.ballRadius),
          position: new CANNON.Vec3(x, y, z),
          linearDamping: 0.2,
          angularDamping: 0.2
        });
        body.userData = { prize: p, mesh: mesh };
        world.addBody(body);

        balls.push({ mesh, body, prize: p });
      }
    }

    function resetLottery() {
      // 重置狀態
      isSpinning = false;
      spinTargetSpeed = 0;
      currentSpinSpeed = 0;
      if (drumBody) {
        drumBody.quaternion.set(0, 0, 0, 1);
        drumBody.angularVelocity.setZero();
      }
      createBalls(parseInt(ballCountInput.value, 10) || 12);
      resultDisplay.textContent = "準備抽選";
      winnerDisplay.style.display = 'none';
    }

    function startSpin(initialVel, duration) {
      isSpinning = true;
      resultDisplay.textContent = "轉動中...";
      if (soundEnabled) sounds.spin.play();

      const spinFactor = parseFloat(spinSpeedSelect.value);
      spinTargetSpeed = THREE.MathUtils.clamp(
        Math.abs(initialVel) + 10 * spinFactor,
        config.minSpinVelocity * spinFactor,
        config.maxSpinSpeedRad * spinFactor
      ) * Math.sign(initialVel || 1);

      gsap.delayedCall(duration + Math.random() * config.spinRandomness, () => {
        spinTargetSpeed = 0; // 開始減速
      });
    }

    function handleSpinButtonClick() {
      if (!isSpinning) {
        if (soundEnabled) sounds.click.play();
        startSpin(-2, config.baseSpinDuration);
      }
    }

    function handleResetClick() {
      if (soundEnabled) sounds.click.play();
      resetLottery();
    }

    function animate() {
      requestAnimationFrame(animate);
      updatePhysics();
      renderer.render(scene, camera);
    }

    function updatePhysics() {
      const now = performance.now() / 1000;
      const dt = now - lastT;
      lastT = now;
      const fixedDt = config.physicsTimeStep;

      // 處理轉動
      if (isSpinning) {
        currentSpinSpeed = THREE.MathUtils.lerp(currentSpinSpeed, spinTargetSpeed, 0.05);
        if (spinTargetSpeed === 0 && Math.abs(currentSpinSpeed) > 0.05) {
          currentSpinSpeed *= spinDeceleration;
        } else if (spinTargetSpeed === 0 && Math.abs(currentSpinSpeed) <= 0.05) {
          currentSpinSpeed = 0;
          isSpinning = false;
          if (sounds.spin.playing()) sounds.spin.stop();
          gsap.delayedCall(1.5, determineWinner);
        }
      } else {
        currentSpinSpeed = THREE.MathUtils.lerp(currentSpinSpeed, 0, 0.1);
      }

      if (drumBody) {
        drumBody.angularVelocity.set(0, currentSpinSpeed, 0);
      }

      // step
      world.step(fixedDt, dt, 3);

      // sync
      if (drumMesh && drumBody) {
        drumMesh.quaternion.copy(drumBody.quaternion);
      }
      for (const b of balls) {
        if (!b.body) continue;
        b.mesh.position.copy(b.body.position);
        b.mesh.quaternion.copy(b.body.quaternion);
      }
    }

    function determineWinner() {
      let winner = balls[0];
      let minY = 9999;
      for (const b of balls) {
        if (b.body.position.y < minY) {
          minY = b.body.position.y;
          winner = b;
        }
      }
      if (winner) {
        displayWinner(winner);
        ejectBall(winner);
      }
    }

    function displayWinner(w) {
      resultDisplay.textContent = `恭喜！中到 ${w.prize.label}`;
      if (soundEnabled) sounds.win.play();
      winnerBall.style.backgroundColor = w.prize.color;
      winnerBall.textContent = w.prize.label;
      winnerMessage.textContent = `您抽中了 ${w.prize.label}，好運連發！`;
      winnerDisplay.style.display = 'flex';
      triggerParticleEffect(w.mesh);
    }

    function ejectBall(w) {
      const mesh = w.mesh;
      const body = w.body;
      world.removeBody(body);

      gsap.to(mesh.position, {
        duration: 1,
        y: -1.2,
        ease: "power2.in",
        onComplete: () => {
          scene.remove(mesh);
          balls = balls.filter(b => b !== w);
        }
      });
    }

    function onResize() {
      const w = canvasContainer.clientWidth;
      const h = canvasContainer.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      soundStatus.textContent = soundEnabled ? "音效開啟" : "音效關閉";
      soundToggle.querySelector('i').className = soundEnabled ? "fas fa-volume-up" : "fas fa-volume-mute";
      Howler.mute(!soundEnabled);
    }

    // 粒子特效 (隨便做個簡單的)
    function triggerParticleEffect(targetMesh) {
      if (!targetMesh) return;
      const screenPos = toScreenPosition(targetMesh, camera, canvasContainer);
      if (!screenPos) return;
      for (let i = 0; i < config.particleCount; i++) {
        const particle = document.createElement('div');
        const isConfetti = Math.random() > 0.4;
        particle.className = `particle ${isConfetti ? 'confetti' : ''}`;
        particle.style.backgroundColor = config.particleColors[Math.floor(Math.random() * config.particleColors.length)];
        particlesContainer.appendChild(particle);

        gsap.set(particle, {
          x: screenPos.x,
          y: screenPos.y,
          opacity: 1,
          scale: Math.random() * 1 + 0.5,
          rotation: Math.random() * 180
        });
        gsap.to(particle, {
          x: `+=${(Math.random() - 0.5) * 400}`,
          y: `+=${(Math.random() - 0.5) * 400}`,
          opacity: 0,
          scale: 0.1,
          rotation: `+=${Math.random() * 360 - 180}`,
          duration: Math.random() * 1.5 + 1,
          ease: "power2.out",
          onComplete: () => particle.remove()
        });
      }
    }

    // 物件投影到螢幕座標
    function toScreenPosition(obj, camera, container) {
      if (!obj || !obj.matrixWorld) return null;
      const vector = new THREE.Vector3();
      vector.setFromMatrixPosition(obj.matrixWorld);
      vector.project(camera);

      const halfWidth = container.clientWidth / 2;
      const halfHeight = container.clientHeight / 2;
      const x = (vector.x * halfWidth) + halfWidth;
      const y = -(vector.y * halfHeight) + halfHeight;
      const rect = container.getBoundingClientRect();
      return { x: rect.left + x, y: rect.top + y };
    }
  </script>
</body>
</html>