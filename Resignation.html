<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- SEO: 基本 Meta 標籤 -->
    <title>離職集點卡 - 你的職場生存壓力計</title>
    <meta name="description" content="記錄每日職場心情與鳥事，集滿離職點數，邁向自由！提供厭世指數分析、數據匯出與 AI 洞察，是你最佳的職場壓力管理工具。">
    <meta name="keywords" content="離職, 集點卡, 職場壓力, 工作心情, 厭世, 加班, 慣老闆, PWA, 前端工具, AI分析, 社畜, 髒話">
    <link rel="canonical" href="https://s123104.github.io/web/Resignation.html">

    <!-- SEO: Open Graph (for Facebook, LinkedIn, etc.) -->
    <meta property="og:title" content="離職集點卡 - 你的職場生存壓力計">
    <meta property="og:description" content="記錄每日職場心情與鳥事，集滿離職點數，邁向自由！提供厭世指數分析與 AI 洞察。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://s123104.github.io/web/Resignation.html">
    <meta property="og:image" content="https://s123104.github.io/web/og-image.png"> <!-- 建議您在此路徑放一張 1200x630 的預覽圖 -->
    <meta property="og:site_name" content="離職集點卡">
    <meta property="og:locale" content="zh_TW">

    <!-- SEO: Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="離職集點卡 - 你的職場生存壓力計">
    <meta name="twitter:description" content="記錄每日職場心情與鳥事，集滿離職點數，邁向自由！提供厭世指數分析與 AI 洞察。">
    <meta name="twitter:image" content="https://s123104.github.io/web/twitter-image.png"> <!-- 建議您在此路徑放一張適合 Twitter 的預覽圖 -->

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3da35d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="離職集點卡">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzZGEzNWQiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik05IDEyTDExIDE0TDE1IDEwTTIxIDEyQzIxIDE2Ljk3MDYgMTYuOTcwNiAyMSAxMiAyMUM3LjAyOTQ0IDIxIDMgMTYuOTcwNiAzIDEyQzMgNy4wMjk0NCA3LjAyOTQ0IDMgMTIgM0MxNi45NzA2IDMgMjEgNy4wMjk0NCAyMSAxMloiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzNkYTM1ZCIvPgo8cGF0aCBkPSJNOSAxMkwxMSAxNEwxNSAxME0yMSAxMkMyMSAxNi45NzA2IDE2Ljk3MDYgMjEgMTIgMjFDNy4wMjk0NCAyMSAzIDE2Ljk3MDYgMyAxMkMzIDcuMDI5NDQgNy4wMjk0NCAzIDEyIDNDMTYuOTcwNiAzIDIxIDcuMDI5NDQgMjEgMTJaIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K">

    <!-- SEO: JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "離職集點卡",
      "description": "記錄每日職場心情與鳥事，集滿離職點數，邁向自由！提供厭世指數分析、數據匯出與 AI 洞察，是你最佳的職場壓力管理工具。",
      "applicationCategory": "ProductivityApplication",
      "operatingSystem": "Web",
      "url": "https://s123104.github.io/web/Resignation.html",
      "offers": { "@type": "Offer", "price": "0" },
      "aggregateRating": { "@type": "AggregateRating", "ratingValue": "4.9", "ratingCount": "258" }
    }
    </script>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Kalam:wght@400;700&family=Caveat:wght@400;600;700&family=Dancing+Script:wght@400;600;700&family=Indie+Flower&family=Shadows+Into+Light&family=Amatic+SC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: { 50: '#f0f9f4', 100: '#dcf4e4', 200: '#bbe8cc', 300: '#8cd5a8', 400: '#5bb97d', 500: '#3da35d', 600: '#2d8049', 700: '#26663d', 800: '#215233', 900: '#1d432b' }, secondary: { 50: '#fefce8', 100: '#fef9c3', 200: '#fef08a', 300: '#fde047', 400: '#facc15', 500: '#eab308', 600: '#ca8a04', 700: '#a16207', 800: '#854d0e', 900: '#713f12' }, accent: { 50: '#fdf2f8', 100: '#fce7f3', 200: '#fbcfe8', 300: '#f9a8d4', 400: '#f472b6', 500: '#ec4899', 600: '#db2777', 700: '#be185d', 800: '#9d174d', 900: '#831843' }, neutral: { 50: '#fafafa', 100: '#f5f5f5', 200: '#e5e5e5', 300: '#d4d4d4', 400: '#a3a3a3', 500: '#737373', 600: '#525252', 700: '#404040', 800: '#262626', 900: '#171717' } },
                    fontFamily: { 'sans': ['Noto Sans TC', 'sans-serif'], 'handwrite-1': ['Kalam', 'cursive'], 'handwrite-2': ['Caveat', 'cursive'], 'handwrite-3': ['Dancing Script', 'cursive'], 'handwrite-4': ['Indie Flower', 'cursive'], 'handwrite-5': ['Shadows Into Light', 'cursive'], 'handwrite-6': ['Amatic SC', 'cursive'] },
                    animation: { 'bounce-in': 'bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)', 'fade-in': 'fadeIn 1s ease-out', 'slide-up': 'slideUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94)', 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'wiggle': 'wiggle 1s ease-in-out infinite', 'float': 'float 6s ease-in-out infinite', 'glow': 'glow 2s ease-in-out infinite alternate', 'quote-slide': 'quoteSlide 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)', 'quote-fade': 'quoteFade 0.6s ease-out' }
                }
            }
        }
    </script>

    <style>
        /* Base and Animation Styles */
        * { touch-action: manipulation; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        input, textarea { -webkit-user-select: text; user-select: text; }
        .hidden { display: none !important; }
        @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.3) translateY(50px); } 30% { opacity: 0.9; transform: scale(1.1); } 60% { opacity: 1; transform: scale(0.89); } 80% { transform: scale(1.05); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(60px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes wiggle { 0%, 7% { transform: rotateZ(0); } 15% { transform: rotateZ(-15deg); } 20% { transform: rotateZ(10deg); } 25% { transform: rotateZ(-10deg); } 30% { transform: rotateZ(6deg); } 35% { transform: rotateZ(-4deg); } 40%, 100% { transform: rotateZ(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        @keyframes quoteSlide { from { opacity: 0; transform: translateY(-50px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes scorePopup { 0% { opacity: 0; transform: translate(10px, 10px) scale(0.5); } 50% { opacity: 1; transform: translate(0, -20px) scale(1.2); } 100% { opacity: 0; transform: translate(0, -50px) scale(0.8); } }

        /* Grid Cell Styles */
        .grid-cell { transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); position: relative; overflow: hidden; background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); border: 2px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-height: 40px; }
        .grid-cell:hover { transform: scale(1.08) translateY(-3px); box-shadow: 0 12px 35px rgba(61, 163, 93, 0.2); border-color: #3da35d; z-index: 10; }
        .grid-cell.filled { background: linear-gradient(145deg, #dcf4e4 0%, #bbe8cc 100%); border-color: #3da35d; box-shadow: 0 4px 15px rgba(61, 163, 93, 0.15); }
        .grid-cell.mood-money { background: linear-gradient(145deg, #fef9c3, #fde047); border-color: #ca8a04; }
        .grid-cell.mood-burnout { background: linear-gradient(145deg, #fecaca, #fca5a5); border-color: #ef4444; }
        .grid-cell.mood-annoying { background: linear-gradient(145deg, #e0e7ff, #c7d2fe); border-color: #6366f1; }
        .grid-cell.mood-stuck { background: linear-gradient(145deg, #e5e5e5, #d4d4d4); border-color: #737373; }
        .grid-cell.long-pressing { transform: scale(0.95); box-shadow: inset 0 4px 12px rgba(61, 163, 93, 0.2); }
        .date-text { color: #2d8049; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.12); transform: rotate(-2deg); transition: all 0.3s ease; }
        .grid-cell.mood-money .date-text { color: #a16207; } .grid-cell.mood-burnout .date-text { color: #b91c1c; } .grid-cell.mood-annoying .date-text { color: #4338ca; } .grid-cell.mood-stuck .date-text { color: #525252; }
        
        /* UI Element Styles */
        .glass-effect { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.18); }
        .quote-container { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; padding: 1.5rem; margin: 1rem 0; box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3); position: relative; overflow: hidden; }
        .progress-ring { transform: rotate(-90deg); } .progress-ring-circle { transition: stroke-dasharray 0.5s ease-in-out; }
        
        /* Modal Styles */
        .modal-backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); }
        .modal-content { background: white; border-radius: 24px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); transform: scale(0.9) translateY(20px); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); max-width: 90vw; max-height: 90vh; overflow-y: auto; }
        .modal-open .modal-content { transform: scale(1) translateY(0); }
        
        /* Share Modal & Button */
        .share-trigger { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background-color: #3da35d; color: white; border-radius: 50%; border: none; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; transition: all 0.3s ease; }
        .share-trigger:hover { transform: scale(1.1); background-color: #2d8049; }
        .share-modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1050; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .share-modal.show { opacity: 1; visibility: visible; }
        .share-modal__content { background: #fff; border-radius: 16px; padding: 1.5rem; width: 90%; max-width: 400px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); position: relative; text-align: center; transform: scale(0.95); transition: transform 0.3s; }
        .share-modal.show .share-modal__content { transform: scale(1); }
        .share-modal__close { position: absolute; top: 0.5rem; right: 0.5rem; background: transparent; border: none; font-size: 1.8rem; line-height: 1; cursor: pointer; color: #aaa; }
        .share-modal__header h3 { margin: 0; font-size: 1.25rem; color: #333; }
        .share-modal__header p { margin-top: 0.25rem; color: #666; font-size: 0.9rem; }
        .share-modal__options { margin: 1.5rem 0; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .share-btn { padding: 0.75rem; font-size: 0.9rem; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .share-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .share-btn--copy { background: #f3f3f3; color: #333; } .share-btn--twitter { background: #1da1f2; color: #fff; } .share-btn--line { background: #00c300; color: #fff; }

        /* Annoyance Score Popup */
        #annoyanceScorePopup { position: fixed; bottom: 90px; right: 30px; color: #ef4444; font-size: 2rem; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); opacity: 0; pointer-events: none; z-index: 2000; }
        #annoyanceScorePopup.show { animation: scorePopup 2s ease-out forwards; }
        
        /* iOS Install Prompt */
        #iosInstallPrompt { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(249, 250, 251, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #e5e7eb; padding: 1rem 1rem 1.5rem 1rem; z-index: 2000; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.5s ease; }
        #iosInstallPrompt.show { transform: translateY(0); }
        .ios-prompt-content { max-width: 400px; margin: auto; text-align: center; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #3da35d; border-radius: 4px; }
    </style>
</head>

<body class="bg-gradient-to-br from-primary-50 via-white to-accent-50 min-h-screen font-sans overflow-x-hidden">
    <!-- Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div class="absolute top-20 left-10 w-32 h-32 bg-primary-200 rounded-full opacity-20 animate-float"></div>
        <div class="absolute bottom-20 right-20 w-24 h-24 bg-accent-200 rounded-full opacity-20 animate-float" style="animation-delay: -2s;"></div>
        <div class="absolute top-1/2 left-1/3 w-16 h-16 bg-secondary-200 rounded-full opacity-20 animate-float" style="animation-delay: -4s;"></div>
    </div>

    <!-- Header -->
    <header class="relative text-center py-6 sm:py-8 md:py-12 animate-fade-in">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-primary-800 mb-3 sm:mb-4 tracking-wide relative">
                <span class="inline-block animate-wiggle">📋</span> 離職集點卡 <span class="inline-block animate-pulse-slow">✨</span>
            </h1>
            <p class="text-base sm:text-lg md:text-xl text-primary-600 font-medium" id="progressText">共100格，集滿離職</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pb-8">
        <div class="glass-effect rounded-3xl shadow-2xl p-4 sm:p-6 md:p-8 mb-6 animate-slide-up">
            <div class="text-center mb-4">
                <h2 class="text-xl sm:text-2xl font-bold text-primary-800 mb-2"><i class="fas fa-calendar-check mr-2"></i>我的離職集點進度</h2>
                <p class="text-primary-600 text-xs sm:text-sm"><i class="fas fa-info-circle mr-1"></i>短按標記日期，長按記錄詳細事件</p>
            </div>
            <!-- 厭世語錄顯示區 (已移至此處) -->
            <div id="quoteDisplay" class="hidden">
                <div class="quote-container text-center">
                    <i class="fas fa-quote-left text-xl mb-2 opacity-70"></i>
                    <p class="text-base sm:text-lg font-handwrite-3 leading-relaxed mb-2" id="quoteText"></p>
                    <button onclick="hideQuote()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-xs transition-all duration-300"><i class="fas fa-times mr-1"></i>收起</button>
                </div>
            </div>
            <div class="grid grid-cols-8 md:grid-cols-10 gap-1 sm:gap-2 max-w-4xl mx-auto" id="gridContainer"></div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div class="glass-effect rounded-2xl shadow-xl p-4 sm:p-6 animate-slide-up" style="animation-delay: 0.2s">
                <h3 class="text-lg sm:text-xl font-bold text-primary-800 mb-4 flex items-center"><i class="fas fa-chart-pie mr-2 text-primary-600"></i>進度統計</h3>
                <div class="flex items-center justify-center mb-4">
                    <div class="relative w-24 h-24 sm:w-32 sm:h-32">
                        <svg class="progress-ring w-full h-full" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#3da35d" stroke-width="8" stroke-linecap="round" class="progress-ring-circle" id="progressCircle" stroke-dasharray="0 339.292"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center"><div class="text-center"><div class="text-xl sm:text-2xl font-bold text-primary-700" id="filledCount">0</div><div class="text-xs text-primary-600">已完成</div></div></div>
                    </div>
                </div>
                <div class="space-y-2 sm:space-y-3">
                    <div class="flex justify-between items-center"><span class="text-xs sm:text-sm text-neutral-600"><i class="fas fa-calendar-day mr-2 text-primary-500"></i>好日子</span><span class="font-semibold text-primary-700" id="goodDaysCount">0</span></div>
                    <div class="flex justify-between items-center"><span class="text-xs sm:text-sm text-neutral-600"><i class="fas fa-calendar-times mr-2 text-red-500"></i>爛日子</span><span class="font-semibold text-red-600" id="badDaysCount">0</span></div>
                    <div class="flex justify-between items-center"><span class="text-xs sm:text-sm text-neutral-600"><i class="fas fa-percentage mr-2 text-accent-500"></i>完成率</span><span class="font-semibold text-accent-600" id="completionRate">0%</span></div>
                </div>
                <div class="mt-4 sm:mt-6 space-y-2">
                    <button onclick="openAiExportModal()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 transform hover:scale-105"><i class="fas fa-magic-wand-sparkles mr-2"></i>匯出至 AI 分析</button>
                    <button onclick="showClearConfirm()" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 transform hover:scale-105"><i class="fas fa-trash-alt mr-2"></i>清空所有記錄</button>
                </div>
            </div>
            
            <div class="glass-effect rounded-2xl shadow-xl p-4 sm:p-6 animate-slide-up" style="animation-delay: 0.4s">
                <h3 class="text-lg sm:text-xl font-bold text-primary-800 mb-4 flex items-center"><i class="fas fa-chart-line mr-2 text-primary-600"></i>每日趨勢</h3>
                <div class="relative h-64"><canvas id="dailyChart"></canvas></div>
                <div class="mt-4 text-center"><p class="text-primary-600 text-xs sm:text-sm"><i class="fas fa-sync-alt fa-spin mr-1"></i>圖表將於每日 00:00 自動更新</p></div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div class="glass-effect rounded-2xl shadow-xl p-4 sm:p-6 animate-slide-up" style="animation-delay: 0.6s">
                <h3 class="text-lg sm:text-xl font-bold text-primary-800 mb-4 flex items-center"><i class="fas fa-fire-alt mr-2 text-red-500"></i>厭世指數分析</h3>
                <div class="bg-red-50 p-6 rounded-2xl text-center">
                    <div class="text-sm text-red-700 mb-2">總厭世指數</div>
                    <div id="annoyanceIndexTotal" class="text-5xl font-bold text-red-600">0</div>
                    <p id="annoyanceLevel" class="text-red-500 font-semibold mt-2">內心毫無波瀾</p>
                </div>
                <div class="mt-4"><p class="text-sm text-neutral-600 mb-2 font-semibold">主要厭世來源：</p><ul id="topAnnoyanceKeywords" class="text-sm text-neutral-500 space-y-1"><li>尚無數據</li></ul></div>
            </div>
            
            <div class="glass-effect rounded-2xl shadow-xl p-4 sm:p-6 animate-slide-up" style="animation-delay: 0.8s">
                <h3 class="text-lg sm:text-xl font-bold text-primary-800 mb-4 flex items-center"><i class="fas fa-history mr-2 text-primary-600"></i>近期記錄</h3>
                <div id="recentRecords" class="space-y-3 max-h-64 overflow-y-auto"><p class="text-neutral-500 text-center py-8"><i class="fas fa-inbox text-3xl mb-2 block"></i>尚無記錄，開始你的離職集點之旅吧！</p></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-primary-600 animate-fade-in" style="animation-delay: 1.0s">
        <div class="container mx-auto px-4"><p class="text-sm sm:text-base mb-3 font-handwrite-4">真的做不了，沒有一天是適合上班的。</p><p class="text-xs opacity-75 mb-4"><i class="fas fa-heart text-red-400 mr-1"></i>離職Day - PWA版本</p><div class="flex justify-center gap-4 text-xs flex-wrap"><span class="bg-primary-100 px-3 py-1 rounded-full"><i class="fas fa-wifi mr-1"></i><span id="onlineStatus">線上</span></span><span class="bg-accent-100 px-3 py-1 rounded-full"><i class="fas fa-save mr-1"></i>已自動儲存</span></div></div>
    </footer>

    <!-- Floating UI Elements -->
    <div id="annoyanceScorePopup"></div>
    <button id="shareBtn" class="share-trigger" aria-label="分享此頁面"><i class="fas fa-share-alt"></i></button>

    <!-- Modals -->
    <div id="shareModal" class="share-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="share-modal-title">
      <div class="share-modal__overlay" onclick="closeShareModal()"></div>
      <div class="share-modal__content">
        <button class="share-modal__close" aria-label="關閉分享窗口" onclick="closeShareModal()">×</button>
        <div class="share-modal__header"><h3 id="share-modal-title">分享你的離職進度</h3><p>讓朋友一起見證你的自由之路！</p></div>
        <div class="share-modal__options">
          <button id="copyShareTextBtn" class="share-btn share-btn--copy"><i class="fas fa-copy"></i>複製文案</button>
          <button id="shareToLineBtn" class="share-btn share-btn--line"><i class="fab fa-line"></i>LINE</button>
          <button id="shareToTwitterBtn" class="share-btn share-btn--twitter"><i class="fab fa-twitter"></i>Twitter/X</button>
        </div>
        <div class="share-modal__footer"><small>由 <a href="https://github.com/s123104" target="_blank" rel="noopener">s123104</a> 製作</small></div>
      </div>
    </div>
    
    <div id="eventModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="modal-content p-6 sm:p-8 w-full max-w-lg">
            <div class="text-center mb-6"><div class="w-16 h-16 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full mx-auto mb-4 flex items-center justify-center"><i class="fas fa-edit text-white text-xl"></i></div><h3 class="text-xl font-bold text-primary-800 mb-2">記錄事件</h3><p class="text-neutral-600 text-sm">記錄這一天的心情與事件</p></div>
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-neutral-700 mb-2">選擇日期</label><input type="date" id="eventDate" class="w-full px-4 py-3 border border-neutral-300 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-neutral-700 mb-2">今天心情如何？ (離職四大原因)</label><div class="grid grid-cols-2 sm:grid-cols-4 gap-2"><button type="button" class="mood-btn p-3 border border-neutral-300 rounded-xl flex flex-col items-center justify-center" data-mood="money"><div class="mood-icon-wrapper" id="moodIconMoney"></div><div class="text-xs mt-1">錢途茫茫</div></button><button type="button" class="mood-btn p-3 border border-neutral-300 rounded-xl flex flex-col items-center justify-center" data-mood="burnout"><div class="mood-icon-wrapper" id="moodIconBurnout"></div><div class="text-xs mt-1">身心俱疲</div></button><button type="button" class="mood-btn p-3 border border-neutral-300 rounded-xl flex flex-col items-center justify-center" data-mood="annoying"><div class="mood-icon-wrapper" id="moodIconAnnoying"></div><div class="text-xs mt-1">鳥事一堆</div></button><button type="button" class="mood-btn p-3 border border-neutral-300 rounded-xl flex flex-col items-center justify-center" data-mood="stuck"><div class="mood-icon-wrapper" id="moodIconStuck"></div><div class="text-xs mt-1">缺乏成長</div></button></div></div>
                <div><label for="eventDescription" class="block text-sm font-medium text-neutral-700 mb-2">事件描述</label><textarea id="eventDescription" rows="3" placeholder="今天發生了什麼鳥事？" class="w-full px-4 py-3 border border-neutral-300 rounded-xl resize-none focus:border-primary-400 focus:ring-2 focus:ring-primary-100"></textarea></div>
                <div><label class="block text-sm font-medium text-neutral-700 mb-2">爛事標籤</label><div id="presetButtonsContainer" class="flex flex-wrap gap-2 mb-2"></div><div class="flex gap-2"><input type="text" id="customPresetInput" placeholder="新增自訂爛事" class="flex-grow px-3 py-2 border border-neutral-300 rounded-lg text-sm"><button onclick="addCustomPreset()" class="bg-primary-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary-600">新增</button></div></div>
            </div>
            <div class="flex gap-3 mt-6"><button onclick="closeEventModal()" class="flex-1 bg-neutral-200 hover:bg-neutral-300 text-neutral-700 px-6 py-3 rounded-xl font-medium">取消</button><button onclick="saveEvent()" class="flex-1 bg-gradient-to-r from-primary-500 to-primary-600 text-white px-6 py-3 rounded-xl font-medium">儲存</button></div>
        </div>
    </div>

    <div id="aiExportModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="modal-content p-6 sm:p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-primary-800"><i class="fas fa-magic-wand-sparkles mr-2"></i>AI 職涯洞察</h3><button onclick="closeAiExportModal()" class="text-neutral-500 hover:text-neutral-800 text-2xl">×</button></div>
            <div>
                <h4 class="font-semibold text-neutral-700 mb-2">一鍵複製，貼至 AI 分析</h4>
                <p class="text-sm text-neutral-600 mb-2">點擊下方按鈕，複製包含您所有數據的完整提問，然後貼到任何 AI (ChatGPT, Claude, Gemini) 聊天視窗，即可獲得職涯分析。</p>
                <div class="relative bg-neutral-100 p-4 rounded-lg">
                    <pre class="text-xs max-h-60 overflow-auto whitespace-pre-wrap break-words"><code id="fullAiPrompt"></code></pre>
                    <button id="copyAIPromptBtn" class="absolute top-2 right-2 bg-neutral-200 hover:bg-neutral-300 text-xs px-2 py-1 rounded">複製提問</button>
                </div>
            </div>
            <div class="mt-6 text-center"><button onclick="closeAiExportModal()" class="bg-primary-500 hover:bg-primary-600 text-white px-8 py-3 rounded-xl font-medium">完成</button></div>
        </div>
    </div>
    
    <div id="confirmModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="modal-content p-6 sm:p-8 w-full max-w-md text-center">
            <div class="w-16 h-16 bg-gradient-to-br from-red-400 to-red-600 rounded-full mx-auto mb-4 flex items-center justify-center"><i class="fas fa-exclamation-triangle text-white text-xl"></i></div>
            <h3 class="text-xl font-bold text-neutral-800 mb-3">確認清空</h3>
            <p class="text-neutral-600 mb-6">確定要清空所有記錄嗎？此操作無法復原。</p>
            <div class="flex gap-3"><button onclick="closeConfirmModal()" class="flex-1 bg-neutral-200 hover:bg-neutral-300 text-neutral-700 px-6 py-3 rounded-xl font-medium">取消</button><button onclick="confirmClearAll()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl font-medium">確認清空</button></div>
        </div>
    </div>

    <!-- PWA Install Prompts -->
    <div id="installPrompt" class="fixed bottom-4 left-4 right-4 bg-gradient-to-r from-primary-600 to-primary-700 text-white p-4 rounded-2xl shadow-2xl transform translate-y-full transition-transform duration-500 z-40">
        <div class="flex items-center justify-between"><div class="flex items-center"><i class="fas fa-mobile-alt text-2xl mr-3"></i><div><div class="font-semibold">安裝應用程式</div><div class="text-sm opacity-90">離線使用，隨時記錄</div></div></div><div class="flex gap-2"><button onclick="dismissInstallPrompt()" class="px-3 py-1 text-sm bg-white/20 rounded-lg">稍後</button><button onclick="installPWA()" class="px-3 py-1 text-sm bg-white text-primary-600 rounded-lg font-semibold">安裝</button></div></div>
    </div>
    <div id="iosInstallPrompt" class="hidden">
        <div class="ios-prompt-content relative">
            <button onclick="document.getElementById('iosInstallPrompt').classList.remove('show')" class="absolute -top-8 right-0 text-white bg-black/30 rounded-full w-7 h-7 flex items-center justify-center text-lg">×</button>
            <p class="text-sm font-semibold mb-2">將「離職集點卡」加入主畫面</p>
            <p class="text-xs text-neutral-600">點擊下方的 <svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-4 h-4 -mt-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> 分享按鈕，然後選擇「加入主畫面」。</p>
        </div>
    </div>

<script>
    // --- GLOBAL VARIABLES ---
    let deferredPrompt, dailyChart;
    let filledDates = new Map();
    let customPresets = [];
    let longPressTimer = null;
    let isLongPress = false;
    let currentCell = null;
    
    const STORAGE_KEY = 'resignationCard_v5';
    const PRESETS_KEY = 'resignationCard_presets_v2';
    const TOTAL_CELLS = 100;
    const APP_URL = "https://s123104.github.io/web/Resignation.html";
    
    // --- CONFIGURATIONS ---
    const moodIcons = {
        money: `<svg viewBox="0 0 24 24" fill="none" class="w-8 h-8 mx-auto stroke-current text-yellow-600"><path d="M9 10a1 1 0 11-2 0 1 1 0 012 0zm6 0a1 1 0 11-2 0 1 1 0 012 0zm-4 5a4 4 0 01-4-4h8a4 4 0 01-4 4zm4.5-8.5a1.5 1.5 0 00-3 0h3zm-4-3a.5.5 0 001 0h-1zM12 2a10 10 0 100 20 10 10 0 000-20z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        burnout: `<svg viewBox="0 0 24 24" fill="none" class="w-8 h-8 mx-auto stroke-current text-red-600"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zM9 15s1.5-2 3-2 3 2 3 2M9 9h.01M15 9h.01" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        annoying: `<svg viewBox="0 0 24 24" fill="none" class="w-8 h-8 mx-auto stroke-current text-indigo-600"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zM8 9l8 6M8 15L16 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        stuck: `<svg viewBox="0 0 24 24" fill="none" class="w-8 h-8 mx-auto stroke-current text-gray-600"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zM9 12h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`
    };
    const quotes = [ "人家有的是背景，我有的只是背影。", "希望大家不要覺得自己一無是處，我們至少還可以讓別人覺得很煩。", "我最大的缺點，就是缺點錢。", "選擇比努力更重要，所以我選擇不努力。", "如果你覺得自己累得跟狗一樣，那裡真的是誤會了，因為狗都沒你這麼累。", "以前我以為錢可以買到一切，後來我發現並不是，因為我錢不夠。", "小時候我以為可以拯救全世界，長大後發現全世界都拯救不了我。", "我最大的抗壓適應能力是：以不變的薪水應萬變的物價。", "看時間不是為了起床，而是看還能睡多久。", "很多人說抖腳會變窮，講得好像我原本多有錢的樣子。", "不努力一下，你怎麼會知道什麼叫做絕望。", "棉被以外的地方，都是遠方，請先不要叫我起床。", "要好好活下去，因為每天都有新的打擊。", "比一個人吃火鍋更寂寞的是，一個人沒有錢吃火鍋。", "有些事情做不到的話，就留到明天做吧，運氣好的話，明天死了就不用做了。", "努力不一定會成功，但是不努力會很輕鬆。", "謝謝那些曾經擊倒我的人，躺著真舒服。", "上不去的薪水，下不去的房價。", "上班打卡制，下班責任制，人生好厭世。", "被老闆罵完想去動物園，因為在那裡，我才真的像個人。", "誰說錢買不到自由，你老闆不就買到你了。", "真懷念小時候哭完就睡，現在哭完還是要上班。", "以前常常思考自己適合什麼工作，現在發現自己最適合不工作。", "準時下班需要的不是努力，是勇氣。", "成功的都是領導有方，失敗的就是下屬無能。", "失敗並不可怕，可怕的是，你相信這句話。", "世界上99%的事可以靠錢解決，剩下的1%是需要更多錢。", "那些鼓勵大家跳出舒適圈的，問題是我從來沒舒適過。", "你必須非常努力，才可以證明自己真的無能為力。", "我一直把錢視為空氣，因為沒有它我就活不下去。", "醜小鴨變天鵝並不是因為他多努力，而是因為他的老母就是天鵝。", "覺得上班很累嗎？那就看看手上的信用卡跟房貸帳單吧，心會更累喔。", "出社會七年，至今只買得起自己的塔位。", "我的錢包就像洋蔥，打開它就會想哭。", "我從來沒喜歡過工作，我的目標是得過且過。", "人生就是這樣，一天到晚做的那些事，全是我不愛做的。", "上班明明是為別人賺大錢，可最後竟還要反過來謝謝他給你一個工作機會。", "每到星期一，就深刻感受假期只是短暫的愛了我一下。", "世界上最短的距離，就是假期開始到結束。", "正義都能遲到，為什麼上班不能？", "晴天適合出遊、雨天適合睡覺，漫長的歲月裡，竟然沒有一天適合上班。", "上班是會呼吸的痛，他活在我身上每個角落。", "早知道人間有上班這種事，我當初就不應該下凡。", "鬧鐘一響，腦子裡就出現了500多條請假理由，但沒有一條是靠譜的。", "工作最重要的形式之一，是休息。", "生活生活，就是生下來幹活。"];
    const handwriteFonts = ['date-text-1', 'date-text-2', 'date-text-3', 'date-text-4', 'date-text-5', 'date-text-6'];
    const annoyanceKeywords = new Map([
        // 台灣常用髒話 (高分)
        ['幹', 8], ['操你媽', 10], ['媽的', 7], ['靠北', 6], ['靠邀', 6], ['機掰', 9], ['三小', 5], ['哭啊', 4], ['啥小', 5], ['糙', 8], ['肏', 8], ['贛', 8], ['淦', 8],
        // 職場通用 (高分)
        ['老闆', 7], ['主管', 7], ['慣老闆', 10], ['加班', 8], ['無薪', 9], ['責任制', 9], ['裁員', 10], ['資遣', 10], ['減薪', 10], ['畫大餅', 8],
        // 人物相關 (中高分)
        ['白痴', 6], ['智障', 6], ['腦殘', 6], ['低能', 6], ['白目', 5], ['豬隊友', 7], ['廢物', 7], ['垃圾', 7], ['無能', 6], ['馬屁精', 5], ['小人', 6], ['老鳥', 4], ['新人', 4],
        // 事件相關 (中分)
        ['開會', 5], ['會議', 5], ['報告', 4], ['日報', 4], ['周報', 4], ['PPT', 3], ['Excel', 3], ['需求', 5], ['改來改去', 7], ['沒效率', 6], ['甩鍋', 8], ['黑鍋', 8], ['宮鬥', 6], ['政治', 6],
        // 情緒與狀態 (中低分)
        ['煩', 4], ['累', 5], ['煩死', 5], ['累死', 6], ['不爽', 5], ['火大', 6], ['壓力', 5], ['焦慮', 5], ['崩潰', 7], ['想死', 8], ['沒錢', 7], ['窮', 6], ['無助', 5], ['絕望', 7], ['厭世', 8], ['想離職', 9],
        // 其他常用抱怨
        ['沒意義', 5], ['浪費時間', 6], ['搞事', 5], ['出包', 6], ['爛', 5], ['鳥事', 5], ['破事', 5], ['瞎', 4], ['扯', 4], ['傻眼', 4], ['無言', 4], ['有病', 5], ['腦子有洞', 6], ['莫名其妙', 4], ['不懂', 3], ['憑什麼', 6], ['又是我', 5], ['爛攤子', 7]
    ]);
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        setupPWA();
        loadData();
        generateGrid();
        renderMoodIcons();
        renderPresetButtons();
        updateAllStats();
        initChart();
        setupEventListeners();
        scheduleDailyUpdate();
    });

    function setupPWA() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([`self.addEventListener('fetch', () => {return;});`], { type: 'application/javascript' })));
        }
        const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
        
        if (isIOS() && !isInStandaloneMode()) {
            const prompt = document.getElementById('iosInstallPrompt');
            prompt.classList.remove('hidden');
            setTimeout(() => prompt.classList.add('show'), 500);
        } else {
            window.addEventListener('beforeinstallprompt', e => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installPrompt').style.transform = 'translateY(0)';
            });
        }
    }
    
    // --- DATA & STORAGE ---
    function loadData() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) filledDates = new Map(JSON.parse(saved).dates || []);
            const savedPresets = localStorage.getItem(PRESETS_KEY);
            customPresets = savedPresets ? JSON.parse(savedPresets) : ['開不完的會', '慣老闆', '豬隊友', '臨時插件'];
        } catch (e) { console.error('載入資料失敗:', e); }
    }

    function saveData() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ dates: Array.from(filledDates.entries()) }));
            localStorage.setItem(PRESETS_KEY, JSON.stringify(customPresets));
        } catch (e) { console.error('儲存資料失敗:', e); }
    }

    // --- GRID & CELL LOGIC ---
    function generateGrid() {
        const container = document.getElementById('gridContainer');
        container.innerHTML = '';
        for (let i = 0; i < TOTAL_CELLS; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell aspect-square cursor-pointer flex items-center justify-center text-center relative';
            cell.dataset.index = i;
            if (filledDates.has(i)) fillCell(cell, filledDates.get(i));
            
            const start = (e) => { e.preventDefault(); startLongPress(cell, i); };
            const end = (e) => { e.preventDefault(); endLongPress(cell, i); };
            cell.addEventListener('touchstart', start, { passive: false });
            cell.addEventListener('touchend', end, { passive: false });
            cell.addEventListener('mousedown', start);
            cell.addEventListener('mouseup', end);
            cell.addEventListener('mouseleave', cancelLongPress);
        }
    }

    function startLongPress(cell, index) {
        isLongPress = false;
        currentCell = cell;
        cell.classList.add('long-pressing');
        longPressTimer = setTimeout(() => { isLongPress = true; cell.classList.remove('long-pressing'); openEventModal(index); if (navigator.vibrate) navigator.vibrate(50); }, 800);
    }
    function endLongPress(cell, index) { clearTimeout(longPressTimer); cell.classList.remove('long-pressing'); if (!isLongPress) handleQuickMark(index, cell); currentCell = null; }
    function cancelLongPress() { clearTimeout(longPressTimer); if (currentCell) currentCell.classList.remove('long-pressing'); currentCell = null; isLongPress = false; }
    
    function handleQuickMark(index, cell) {
        if (filledDates.has(index)) {
            filledDates.delete(index);
            clearCell(cell);
        } else {
            const today = new Date();
            const data = { date: formatDate(today), displayDate: `${today.getMonth() + 1}/${today.getDate()}`, mood: 'good', description: '', timestamp: today.toISOString(), fontStyle: getRandomFontStyle(), annoyanceIndex: 0 };
            filledDates.set(index, data);
            fillCell(cell, data);
            animateCell(cell);
            showRandomQuote();
        }
        saveData();
        updateAllStats();
    }
    
    function fillCell(cell, data) {
        cell.classList.add('filled');
        ['money', 'burnout', 'annoying', 'stuck'].forEach(m => cell.classList.remove(`mood-${m}`));
        if (data.mood !== 'good') cell.classList.add(`mood-${data.mood}`);
        cell.innerHTML = `<span class="date-text ${data.fontStyle || 'date-text-1'} text-xs sm:text-sm">${data.displayDate}</span>`;
    }
    function clearCell(cell) { cell.className = 'grid-cell aspect-square cursor-pointer flex items-center justify-center text-center relative'; cell.innerHTML = ''; }
    function animateCell(cell) { cell.style.animation = 'bounceIn 0.8s'; setTimeout(() => cell.style.animation = '', 800); }

    // --- MODAL: EVENT ---
    function openEventModal(index) {
        const modal = document.getElementById('eventModal');
        modal.dataset.currentIndex = index;
        const data = filledDates.get(index);
        document.getElementById('eventDate').value = data ? data.date : formatDate(new Date());
        document.getElementById('eventDescription').value = data?.description || '';
        setMood(data ? data.mood : 'money');
        modal.classList.remove('hidden');
        modal.classList.add('flex', 'modal-open');
    }
    function closeEventModal() { const modal = document.getElementById('eventModal'); modal.classList.remove('modal-open'); setTimeout(() => modal.classList.add('hidden'), 300); }
    function renderMoodIcons() { Object.keys(moodIcons).forEach(mood => { document.getElementById(`moodIcon${mood.charAt(0).toUpperCase() + mood.slice(1)}`).innerHTML = moodIcons[mood]; }); }
    function setMood(mood) { document.querySelectorAll('.mood-btn').forEach(btn => { const isSelected = btn.dataset.mood === mood; btn.classList.toggle('bg-gray-200', isSelected); btn.classList.toggle('border-2', isSelected); btn.classList.toggle('border-primary-500', isSelected); btn.dataset.selected = isSelected; }); }

    function saveEvent() {
        const modal = document.getElementById('eventModal');
        const index = parseInt(modal.dataset.currentIndex, 10);
        if (isNaN(index)) return alert("儲存失敗，請重試。");
        
        const mood = document.querySelector('.mood-btn[data-selected="true"]').dataset.mood;
        const description = document.getElementById('eventDescription').value.trim();
        const annoyanceIndex = calculateAnnoyanceIndex(description);
        
        if (annoyanceIndex > 0) showAnnoyancePopup(annoyanceIndex);

        const data = {
            date: document.getElementById('eventDate').value,
            displayDate: `${new Date(document.getElementById('eventDate').value + 'T00:00:00').getMonth() + 1}/${new Date(document.getElementById('eventDate').value + 'T00:00:00').getDate()}`,
            mood, description, annoyanceIndex,
            timestamp: new Date().toISOString(),
            fontStyle: filledDates.get(index)?.fontStyle || getRandomFontStyle()
        };
        
        filledDates.set(index, data);
        fillCell(document.querySelector(`[data-index="${index}"]`), data);
        animateCell(document.querySelector(`[data-index="${index}"]`));
        saveData();
        updateAllStats();
        closeEventModal();
        showRandomQuote();
    }
    
    // --- ANNOYANCE INDEX & PRESETS ---
    function calculateAnnoyanceIndex(text) {
        let score = 0;
        if (!text) return 0;
        const lowerCaseText = text.toLowerCase();
        annoyanceKeywords.forEach((value, key) => {
            const matches = lowerCaseText.match(new RegExp(key, 'g')) || [];
            score += matches.length * value;
        });
        return score;
    }
    function showAnnoyancePopup(score) {
        const popup = document.getElementById('annoyanceScorePopup');
        popup.textContent = `+${score}`;
        popup.classList.add('show');
        setTimeout(() => popup.classList.remove('show'), 2000);
    }
    function renderPresetButtons() {
        const container = document.getElementById('presetButtonsContainer');
        container.innerHTML = customPresets.map(p => `<button class="bg-gray-100 text-gray-700 text-xs px-3 py-1.5 rounded-full hover:bg-gray-200" onclick="appendPreset('${p}')">${p}</button>`).join('');
    }
    function appendPreset(text) { const textarea = document.getElementById('eventDescription'); textarea.value += (textarea.value ? ' ' : '') + text; }
    function addCustomPreset() { const input = document.getElementById('customPresetInput'); if (input.value.trim() && !customPresets.includes(input.value.trim())) { customPresets.push(input.value.trim()); saveData(); renderPresetButtons(); } input.value = ''; }
    
    // --- UI UPDATES & STATS ---
    function updateAllStats() {
        updateProgress();
        updateRecentRecords();
        if (dailyChart) updateChart();
        updateAnnoyanceStats();
    }
    
    function updateProgress() {
        const count = filledDates.size;
        const good = Array.from(filledDates.values()).filter(d => d.mood === 'good').length;
        document.getElementById('filledCount').textContent = count;
        document.getElementById('goodDaysCount').textContent = good;
        document.getElementById('badDaysCount').textContent = count - good;
        document.getElementById('completionRate').textContent = `${(count / TOTAL_CELLS * 100).toFixed(1)}%`;
        document.getElementById('progressCircle').style.strokeDasharray = `${(count / TOTAL_CELLS) * 339.292} 339.292`;
        const pText = document.getElementById('progressText');
        if (count === 0) pText.textContent = '共100格，集滿離職';
        else if (count === TOTAL_CELLS) pText.textContent = '🎉 恭喜集滿！準備離職！';
        else pText.textContent = `還差 ${TOTAL_CELLS - count} 格就離職了！加油！`;
    }
    
    function updateRecentRecords() {
        const container = document.getElementById('recentRecords');
        const records = Array.from(filledDates.entries()).map(([i, d]) => ({ i, ...d })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5);
        if (records.length === 0) { container.innerHTML = `<p class="text-neutral-500 text-center py-8"><i class="fas fa-inbox text-3xl mb-2 block"></i>尚無記錄</p>`; return; }
        container.innerHTML = records.map(r => `<div class="flex items-start gap-3 p-3 bg-white/50 rounded-xl"><div class="text-2xl pt-1">${r.mood === 'good' ? '<i class="fas fa-smile text-primary-500"></i>' : moodIcons[r.mood]}</div><div class="flex-1"><div class="flex items-center justify-between mb-1"><span class="font-medium text-sm text-neutral-800">格子 #${r.i + 1}</span><span class="text-xs text-neutral-500">${new Date(r.timestamp).toLocaleDateString()}</span></div><p class="text-xs text-neutral-600 leading-relaxed">${r.description || '快速標記'}</p></div></div>`).join('');
    }
    
    function updateAnnoyanceStats() {
        let total = 0;
        const counts = new Map();
        filledDates.forEach(data => {
            total += data.annoyanceIndex || 0;
            annoyanceKeywords.forEach((_, key) => { if ((data.description || '').includes(key)) counts.set(key, (counts.get(key) || 0) + 1); });
        });
        document.getElementById('annoyanceIndexTotal').textContent = total;
        let level = "內心毫無波瀾";
        if (total > 200) level = "地獄級厭世，請即刻逃離";
        else if (total > 100) level = "重度厭世，考慮轉職";
        else if (total > 50) level = "中度厭世，偶爾想逃跑";
        else if (total > 10) level = "輕度厭世，還能忍受";
        document.getElementById('annoyanceLevel').textContent = level;
        const topKeywords = Array.from(counts.entries()).sort((a, b) => b[1] - a[1]).slice(0, 3);
        const listEl = document.getElementById('topAnnoyanceKeywords');
        listEl.innerHTML = topKeywords.length > 0 ? topKeywords.map(([k, c]) => `<li>- ${k} (出現 ${c} 次)</li>`).join('') : `<li>尚無數據</li>`;
    }

    // --- CHART LOGIC ---
    function initChart() {
        const canvas = document.getElementById('dailyChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const dailyData = getDailyData();
        dailyChart = new Chart(ctx, {
            type: 'line',
            data: { labels: dailyData.labels, datasets: [{ label: '好日子', data: dailyData.good, borderColor: '#3da35d', backgroundColor: 'rgba(61, 163, 93, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }, { label: '爛日子', data: dailyData.bad, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    function getDailyData() {
        const labels = []; const good = []; const bad = [];
        for (let i = 13; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i); const ds = formatDate(d);
            labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
            let g = 0, b = 0;
            filledDates.forEach(data => { if (data.date === ds) data.mood === 'good' ? g++ : b++; });
            good.push(g); bad.push(b);
        }
        return { labels, good, bad };
    }
    function updateChart() { if (!dailyChart) return; const data = getDailyData(); dailyChart.data.labels = data.labels; dailyChart.data.datasets[0].data = data.good; dailyChart.data.datasets[1].data = data.bad; dailyChart.update('none'); }
    function scheduleDailyUpdate() { const now = new Date(); const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1); setTimeout(() => { updateChart(); scheduleDailyUpdate(); }, tomorrow - now + 1000); }

    // --- MODAL: AI EXPORT ---
    function openAiExportModal() {
        const data = {
            exportDate: new Date().toISOString(),
            summary: { totalRecords: filledDates.size, totalAnnoyanceIndex: Array.from(filledDates.values()).reduce((sum, d) => sum + (d.annoyanceIndex || 0), 0) },
            records: Array.from(filledDates.entries()).map(([index, data]) => ({ cellIndex: index, ...data }))
        };
        const promptTemplate = `你是一位資深的職涯教練與心理諮詢師。請根據以下 JSON 格式的職場心情日誌，進行深入分析。日誌中包含了每日的心情分類（money: 薪資福利, burnout: 身心俱疲, annoying: 鳥事一堆, stuck: 缺乏成長）、事件描述以及自動計算的厭世指數。\n\n你的任務是：\n1.  **模式識別**：找出導致我產生負面情緒的主要模式或重複出現的主題。\n2.  **壓力源分析**：根據 'annoyanceIndex' 和事件描述，分析我最大的壓力來源是什麼。\n3.  **趨勢洞察**：分析我的情緒是否有時間上的趨勢（例如，週末前更糟，或月初更糟）。\n4.  **提出建議**：基於以上分析，提供 3-5 個具體、可行的建議，幫助我改善目前的工作狀況或規劃下一步的職涯發展。\n\n請以有條理、富有同理心且專業的口吻回答。\n\n這是我的數據：\n${JSON.stringify(data, null, 2)}`;
        
        document.getElementById('fullAiPrompt').textContent = promptTemplate;
        const modal = document.getElementById('aiExportModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex', 'modal-open');
    }
    function closeAiExportModal() { const modal = document.getElementById('aiExportModal'); modal.classList.remove('modal-open'); setTimeout(() => modal.classList.add('hidden'), 300); }

    // --- MODAL: SHARE ---
    function openShareModal() {
        const modal = document.getElementById('shareModal');
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
    }
    function closeShareModal() {
        const modal = document.getElementById('shareModal');
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
    }
    function generateShareText() {
        const totalAnnoyance = Array.from(filledDates.values()).reduce((sum, d) => sum + (d.annoyanceIndex || 0), 0);
        return `我正在用「離職集點卡」記錄我的社畜血淚史，目前厭世指數已達 ${totalAnnoyance}！你也來試試看吧！\n\n${APP_URL}`;
    }

    // --- OTHER UI & HELPERS ---
    function formatDate(date) { return date.toISOString().split('T')[0]; }
    function getRandomFontStyle() { return handwriteFonts[Math.floor(Math.random() * handwriteFonts.length)]; }
    function showRandomQuote() { const q = document.getElementById('quoteDisplay'); if (q.classList.contains('hidden')) { document.getElementById('quoteText').textContent = quotes[Math.floor(Math.random() * quotes.length)]; q.classList.remove('hidden'); } }
    function hideQuote() { document.getElementById('quoteDisplay').classList.add('hidden'); }
    function showClearConfirm() { if (filledDates.size === 0) return; document.getElementById('confirmModal').classList.remove('hidden'); document.getElementById('confirmModal').classList.add('flex', 'modal-open'); }
    function closeConfirmModal() { const m = document.getElementById('confirmModal'); m.classList.remove('modal-open'); setTimeout(() => m.classList.add('hidden'), 300); }
    function confirmClearAll() { filledDates.clear(); saveData(); generateGrid(); updateAllStats(); closeConfirmModal(); }
    async function copyTextToClipboard(text, btn) { try { await navigator.clipboard.writeText(text); const original = btn.innerHTML; btn.innerHTML = '已複製!'; setTimeout(() => { btn.innerHTML = original; }, 2000); } catch (e) { alert('複製失敗'); } }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        updateOnlineStatus();
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        document.getElementById('shareBtn').addEventListener('click', openShareModal);
        document.getElementById('copyShareTextBtn').addEventListener('click', function() { copyTextToClipboard(generateShareText(), this); });
        document.getElementById('shareToTwitterBtn').addEventListener('click', () => window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(generateShareText())}`, '_blank'));
        document.getElementById('shareToLineBtn').addEventListener('click', () => window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(APP_URL)}&text=${encodeURIComponent(generateShareText().split('\n')[0])}`, '_blank'));
        document.getElementById('copyAIPromptBtn').addEventListener('click', function() { copyTextToClipboard(document.getElementById('fullAiPrompt').textContent, this); });

        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeEventModal(); closeConfirmModal(); closeAiExportModal(); closeShareModal(); hideQuote(); } });
    }
</script>

</body>
</html>