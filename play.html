<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>完善行程表</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTTXJN4K59qN/OjXy2gV1lTI7V3SThv5Ibt3Hn7VjzoS1VPhbfX4JhecoyexkclVtqvUx3PzQw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- SortableJS for Drag-and-Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background: #f0f2f5;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* 頂部固定工具列 */
        .top-bar {
            position: fixed;
            top:0; left:0; right:0;
            background: linear-gradient(135deg, #4e54c8, #8f94fb);
            color:#fff;
            padding: 15px 20px;
            display:flex;
            align-items:center;
            justify-content: space-between;
            z-index:1000;
            box-shadow:0 2px 8px rgba(0,0,0,0.15);
        }

        .top-bar h1 {
            margin:0;
            font-size:1.5rem;
            font-weight:600;
        }

        .add-schedule-btn {
            background: #fff;
            border: none;
            color: #4e54c8;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow:0 2px 6px rgba(0,0,0,0.1);
            transition:0.3s;
        }

        .add-schedule-btn:hover {
            background:#eee;
        }

        /* 切換行程表的下拉選單 */
        .schedule-selector {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            color:#fff;
            font-size:1rem;
            margin-right: 10px;
        }

        /* 行程表名稱與年份顯示 */
        .title-year {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-left: 20px;
        }

        .title-input {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            color:#fff;
            font-size:1rem;
            width: 200px;
        }

        .year-display {
            font-size: 0.9rem;
            margin-top: 3px;
        }

        /* 行程表容器 */
        .container {
            max-width: 1200px;
            margin: 80px auto 0 auto; /* 調整頂部間距 */
            padding: 20px;
        }

        /* 單個行程表 */
        .schedule-bookmark {
            background: #fff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: 12px;
            margin-bottom: 40px;
            overflow: hidden;
            position: relative;
            transition:0.3s;
        }

        .schedule-bookmark-header {
            background: linear-gradient(135deg, #3e3e3e, #555);
            color: #fff;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .schedule-bookmark-header .icon {
            margin-right: 10px;
        }

        .schedule-bookmark-header .day-info {
            display: flex;
            flex-direction: column;
        }

        .schedule-list {
            list-style: none;
            margin: 0;
            padding: 20px;
            transition:0.3s;
        }

        .schedule-list li {
            margin-bottom: 15px;
            background: #fdfdfd;
            padding: 12px;
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            box-shadow:0 1px 3px rgba(0,0,0,0.1);
            transition:0.3s;
        }

        .schedule-list li:active {
            transform:scale(0.98);
        }

        .schedule-list li.dragging {
            opacity: 0.5;
            border: 2px dashed #ccc;
        }

        /* 拖曳手把 */
        .drag-handle {
            cursor: grab;
            color:#777;
            margin-right:10px;
            font-size:1.2rem;
        }

        .schedule-list li .time {
            font-weight: 600;
            color: #555;
            margin-right: 10px;
            min-width: 100px;
        }

        .schedule-list li i {
            color: #777;
            margin-right: 8px;
        }

        .schedule-list li .desc {
            flex: 1;
            font-size:1rem;
        }

        .schedule-list li .location a {
            color:#007aff;
            text-decoration:none;
        }

        .schedule-list li .location a:hover {
            text-decoration:underline;
        }

        .schedule-list li .note {
            margin-top: 5px;
            font-size:0.9rem;
            color:#666;
        }

        .delete-btn {
            color: #cc0000;
            cursor: pointer;
            padding:5px;
            border-radius:50%;
            transition:0.3s;
            margin-left:10px;
        }

        .delete-btn:hover {
            background:#f5f5f5;
        }

        .export-ics-btn {
            background:#4e54c8;
            color:#fff;
            border:none;
            padding:5px 8px;
            border-radius:4px;
            font-size:0.8rem;
            cursor:pointer;
            margin-left:10px;
            transition:0.3s;
        }

        .export-ics-btn:hover {
            opacity:0.9;
        }

        /* 每日匯出按鈕 */
        .export-day-btn {
            background: #28a745;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow:0 2px 6px rgba(0,0,0,0.1);
            transition:0.3s;
            margin: 20px;
        }

        .export-day-btn:hover {
            background:#218838;
        }

        /* 書籤管理 */
        .bookmark-bar {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .bookmark-bar .bookmark-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .bookmark-item {
            background: #fff;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow:0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition:0.3s;
        }

        .bookmark-item.active {
            background: #4e54c8;
            color: #fff;
        }

        .bookmark-item:hover {
            background: #ddd;
        }

        /* 備註欄位 */
        .schedule-list li .note {
            margin-left: 120px;
        }

        /* 批次匯入的浮動按鈕 */
        .import-fab {
            position: fixed;
            right:20px;
            bottom:80px;
            width:50px;
            height:50px;
            background: linear-gradient(135deg, #4e54c8, #8f94fb);
            color:#fff;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
            cursor:pointer;
            z-index:999;
            transition:0.3s;
        }

        .import-fab:hover {
            transform:scale(1.1);
        }

        /* 新增行程的浮動按鈕 */
        .add-event-fab {
            position: fixed;
            right:20px;
            bottom:20px;
            width:50px;
            height:50px;
            background: linear-gradient(135deg, #28a745, #5cd65c);
            color:#fff;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
            cursor:pointer;
            z-index:999;
            transition:0.3s;
        }

        .add-event-fab:hover {
            transform:scale(1.1);
        }

        /* Modal Styles */
        .modal-overlay, .modal-overlay-import {
            position: fixed;
            top:0;left:0;right:0;bottom:0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index:10000;
        }

        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .modal h2 {
            margin-top:0;
            margin-bottom:20px;
            font-size:1.5rem;
            text-align:center;
        }

        .modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .modal input[type="text"], 
        .modal input[type="datetime-local"],
        .modal textarea {
            width: 100%;
            padding: 8px;
            margin-bottom:15px;
            box-sizing:border-box;
            border:1px solid #ccc;
            border-radius:4px;
            font-size:1rem;
        }

        .modal textarea {
            height:100px;
            resize: vertical;
        }

        .modal .modal-btns {
            text-align: right;
        }

        .modal-btns button {
            background: linear-gradient(135deg, #4e54c8, #8f94fb);
            color:#fff;
            border: none;
            padding: 10px 15px;
            border-radius:4px;
            cursor: pointer;
            margin-left:10px;
            font-size:1rem;
            transition:0.3s;
        }

        .modal-btns .cancel {
            background: linear-gradient(135deg, #aaa, #bbb);
        }

        .modal-btns button:hover {
            opacity:0.9;
        }

        /* 日期標頭顏色對應星期 */
        .schedule-bookmark-header.monday {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }

        .schedule-bookmark-header.tuesday {
            background: linear-gradient(135deg, #FF512F, #DD2476);
        }

        .schedule-bookmark-header.wednesday {
            background: linear-gradient(135deg, #FC466B, #3F5EFB);
        }

        .schedule-bookmark-header.thursday {
            background: linear-gradient(135deg, #00C9FF, #92FE9D);
        }

        .schedule-bookmark-header.friday {
            background: linear-gradient(135deg, #f7971e, #ffd200);
        }

        .schedule-bookmark-header.saturday {
            background: linear-gradient(135deg, #f12711, #f5af19);
        }

        .schedule-bookmark-header.sunday {
            background: linear-gradient(135deg, #89f7fe, #66a6ff);
        }

        /* Responsiveness */
        @media(max-width:768px){
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .title-year {
                margin-left: 0;
                margin-top: 10px;
            }

            .schedule-bookmark-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .schedule-list li .time {
                min-width: 80px;
            }

            .schedule-list li .desc {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- 頂部工具列 -->
    <div class="top-bar">
        <h1>行程表管理</h1>
        <button class="add-schedule-btn" id="add-schedule-btn"><i class="fas fa-plus"></i> 新增行程表</button>
    </div>

    <!-- 書籤管理區 -->
    <div class="container">
        <div class="bookmark-bar">
            <label for="schedule-selector" style="margin-right:10px; font-weight:600;">選擇行程表：</label>
            <select id="schedule-selector" class="schedule-selector">
                <!-- 選項將動態生成 -->
            </select>
        </div>

        <div class="schedule-container">
            <!-- 行程表將動態生成 -->
        </div>

        <div class="footer-note">
            © 行程表管理有限公司
        </div>
    </div>

    <!-- 批次匯入的浮動按鈕 -->
    <div class="import-fab" id="import-fab" title="批次匯入行程">
        <i class="fas fa-file-import"></i>
    </div>

    <!-- 新增行程的浮動按鈕 -->
    <div class="add-event-fab" id="add-event-fab" title="新增行程">
        <i class="fas fa-plus"></i>
    </div>

    <!-- 新增行程表的modal -->
    <div class="modal-overlay" id="add-schedule-modal">
        <div class="modal">
            <h2>新增行程表</h2>
            <label for="new-schedule-name">行程表名稱</label>
            <input type="text" id="new-schedule-name" placeholder="例如：假期行程">
            <div class="modal-btns">
                <button class="cancel">取消</button>
                <button class="confirm">新增</button>
            </div>
        </div>
    </div>

    <!-- 新增行程的modal -->
    <div class="modal-overlay" id="add-event-modal">
        <div class="modal">
            <h2>新增行程</h2>
            <label for="new-datetime">日期時間（必填）</label>
            <input type="datetime-local" id="new-datetime">
            <label for="new-desc">描述（必填）</label>
            <input type="text" id="new-desc" placeholder="行程描述">
            <label for="new-location">地點（選填）</label>
            <input type="text" id="new-location" placeholder="地點">
            <label for="new-note">備註（選填）</label>
            <textarea id="new-note" placeholder="備註..."></textarea>
            <div class="modal-btns">
                <button class="cancel">取消</button>
                <button class="confirm">新增</button>
            </div>
        </div>
    </div>

    <!-- 批次匯入的modal -->
    <div class="modal-overlay-import" id="batch-import-modal">
        <div class="modal">
            <h2>批次匯入行程</h2>
            <textarea id="batch-input" placeholder="將行程文本貼在這裡..."></textarea>
            <div class="modal-btns">
                <button class="cancel-import">取消</button>
                <button class="confirm-import">匯入</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化變數與元素
        const addScheduleBtn = document.getElementById('add-schedule-btn');
        const addScheduleModal = document.getElementById('add-schedule-modal');
        const addScheduleCancel = addScheduleModal.querySelector('.cancel');
        const addScheduleConfirm = addScheduleModal.querySelector('.confirm');
        const newScheduleNameInput = document.getElementById('new-schedule-name');

        const scheduleSelector = document.getElementById('schedule-selector');
        const scheduleContainer = document.querySelector('.schedule-container');

        const addEventFab = document.getElementById('add-event-fab');
        const addEventModal = document.getElementById('add-event-modal');
        const addEventCancel = addEventModal.querySelector('.cancel');
        const addEventConfirm = addEventModal.querySelector('.confirm');
        const newDatetimeInput = document.getElementById('new-datetime');
        const newDescInput = document.getElementById('new-desc');
        const newLocationInput = document.getElementById('new-location');
        const newNoteInput = document.getElementById('new-note');

        const importFab = document.getElementById('import-fab');
        const batchImportModal = document.getElementById('batch-import-modal');
        const batchImportCancel = batchImportModal.querySelector('.cancel-import');
        const batchImportConfirm = batchImportModal.querySelector('.confirm-import');
        const batchInput = document.getElementById('batch-input');

        // 管理多個行程表
        let schedules = {};
        let currentSchedule = '';

        // 初始化
        window.onload = () => {
            loadSchedules();
            if(Object.keys(schedules).length > 0){
                currentSchedule = Object.keys(schedules)[0];
                populateScheduleSelector();
                renderSchedule();
            }
        };

        // 讀取 localStorage
        function loadSchedules(){
            const data = localStorage.getItem('schedules');
            if(data){
                schedules = JSON.parse(data);
            } else {
                // 初始化一個預設行程表
                schedules = {
                    "預設行程表": {
                        title: "預設行程表",
                        days: {}
                    }
                };
                saveSchedules();
            }
        }

        // 儲存到 localStorage
        function saveSchedules(){
            localStorage.setItem('schedules', JSON.stringify(schedules));
        }

        // 生成行程表選擇下拉選單
        function populateScheduleSelector(){
            scheduleSelector.innerHTML = '';
            for(let scheduleName in schedules){
                const option = document.createElement('option');
                option.value = scheduleName;
                option.textContent = scheduleName;
                if(scheduleName === currentSchedule){
                    option.selected = true;
                }
                scheduleSelector.appendChild(option);
            }
        }

        // 切換行程表
        scheduleSelector.addEventListener('change', (e) => {
            currentSchedule = e.target.value;
            renderSchedule();
        });

        // 新增行程表
        addScheduleBtn.addEventListener('click', () => {
            addScheduleModal.style.display = 'flex';
            newScheduleNameInput.value = '';
        });

        addScheduleCancel.addEventListener('click', () => {
            addScheduleModal.style.display = 'none';
        });

        addScheduleConfirm.addEventListener('click', () => {
            const newName = newScheduleNameInput.value.trim();
            if(newName === ''){
                alert('行程表名稱不能為空。');
                return;
            }
            if(schedules.hasOwnProperty(newName)){
                alert('此行程表名稱已存在。請使用其他名稱。');
                return;
            }
            schedules[newName] = {
                title: newName,
                days: {}
            };
            saveSchedules();
            populateScheduleSelector();
            scheduleSelector.value = newName;
            currentSchedule = newName;
            renderSchedule();
            addScheduleModal.style.display = 'none';
        });

        // 渲染當前行程表
        function renderSchedule(){
            scheduleContainer.innerHTML = '';
            const schedule = schedules[currentSchedule];
            const days = schedule.days;

            for(let date in days){
                const day = days[date];
                const dayDiv = createDayBlock(date, day);
                scheduleContainer.appendChild(dayDiv);
            }

            // Initialize SortableJS for drag-and-drop
            initializeSortable();
        }

        // 建立單個日期區塊
        function createDayBlock(dateStr, dayData){
            const dayDiv = document.createElement('div');
            dayDiv.className = 'schedule-bookmark';

            // 解析日期與星期幾
            const dateObj = new Date(dateStr);
            const options = { weekday: 'long' };
            const dayOfWeek = dateObj.toLocaleDateString('zh-TW', options);
            const weekday = dayOfWeek.slice(0,3).toLowerCase(); // e.g., "mon", "tue"

            // 設定對應星期的顏色
            const headerClass = `schedule-bookmark-header ${weekday}`;
            const dayHeader = document.createElement('div');
            dayHeader.className = headerClass;
            dayHeader.innerHTML = `<i class="fas fa-calendar-day icon"></i>
                                   <div class="day-info">
                                       <span>${dateStr}</span>
                                       <span>${dayOfWeek}</span>
                                   </div>`;
            dayDiv.appendChild(dayHeader);

            // 行程列表
            const ul = document.createElement('ul');
            ul.className = 'schedule-list';
            ul.setAttribute('data-date', dateStr);

            dayData.events.forEach(event => {
                const li = document.createElement('li');
                li.setAttribute('data-datetime', event.datetime);
                if(event.loc) li.setAttribute('data-loc', event.loc);
                if(event.note) li.setAttribute('data-note', event.note);

                // 時間顯示
                const timeSpan = document.createElement('span');
                timeSpan.className = 'time';
                const eventDate = new Date(event.datetime);
                const hours = eventDate.getHours();
                const minutes = eventDate.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedHour = hours % 12 === 0 ? 12 : hours % 12;
                timeSpan.textContent = `${formattedHour}:${minutes} ${ampm}`;

                // 拖曳手把
                const dragHandle = document.createElement('span');
                dragHandle.className = 'drag-handle';
                dragHandle.innerHTML = '≡';

                // 描述
                const descSpan = document.createElement('span');
                descSpan.className = 'desc';
                descSpan.textContent = event.desc;

                // 地點
                const locationDiv = document.createElement('div');
                locationDiv.className = 'location';
                if(event.loc){
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.loc)}`;
                    const mapLink = document.createElement('a');
                    mapLink.href = mapUrl;
                    mapLink.target = '_blank';
                    mapLink.textContent = event.loc;
                    locationDiv.innerHTML = `<i class="fas fa-map-marker-alt"></i>`;
                    locationDiv.appendChild(mapLink);
                }

                // 備註
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note';
                if(event.note){
                    noteDiv.innerHTML = `<i class="fas fa-sticky-note"></i> ${event.note}`;
                }

                // 匯出ICS按鈕
                const exportBtn = document.createElement('button');
                exportBtn.className = 'export-ics-btn';
                exportBtn.textContent = '匯出日曆';
                exportBtn.addEventListener('click', () => {
                    exportICS(event);
                });

                // 刪除按鈕
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', () => {
                    deleteEvent(dateStr, event.datetime);
                });

                // 組合
                li.appendChild(dragHandle);
                li.appendChild(timeSpan);
                li.appendChild(descSpan);
                li.appendChild(locationDiv);
                if(event.note) li.appendChild(noteDiv);
                li.appendChild(exportBtn);
                li.appendChild(deleteBtn);

                ul.appendChild(li);
            });

            dayDiv.appendChild(ul);

            // 每日匯出按鈕
            const exportDayBtn = document.createElement('button');
            exportDayBtn.className = 'export-day-btn';
            exportDayBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> 匯出當日行程';
            exportDayBtn.addEventListener('click', () => {
                exportDayICS(dateStr);
            });
            dayDiv.appendChild(exportDayBtn);

            return dayDiv;
        }

        // 新增行程
        addEventFab.addEventListener('click', () => {
            addEventModal.style.display = 'flex';
            newDatetimeInput.value = '';
            newDescInput.value = '';
            newLocationInput.value = '';
            newNoteInput.value = '';
        });

        addEventCancel.addEventListener('click', () => {
            addEventModal.style.display = 'none';
        });

        addEventConfirm.addEventListener('click', () => {
            const datetime = newDatetimeInput.value.trim();
            const desc = newDescInput.value.trim();
            const loc = newLocationInput.value.trim();
            const note = newNoteInput.value.trim();

            if(!datetime || !desc){
                alert('日期時間與描述為必填項目。');
                return;
            }

            const schedule = schedules[currentSchedule];
            const datePart = datetime.split('T')[0];
            if(!schedule.days[datePart]){
                schedule.days[datePart] = { events: [] };
            }

            schedule.days[datePart].events.push({
                datetime: datetime,
                desc: desc,
                loc: loc,
                note: note
            });

            saveSchedules();
            renderSchedule();
            addEventModal.style.display = 'none';
        });

        // 批次匯入
        importFab.addEventListener('click', () => {
            batchImportModal.style.display = 'flex';
            batchInput.value = '';
        });

        batchImportCancel.addEventListener('click', () => {
            batchImportModal.style.display = 'none';
        });

        batchImportConfirm.addEventListener('click', () => {
            const text = batchInput.value.trim();
            if(text === ''){
                alert('請貼入行程資料。');
                return;
            }
            importBatch(text);
            batchImportModal.style.display = 'none';
        });

        // 匯入批次行程
        function importBatch(text){
            const lines = text.split('\n').map(l => l.trim()).filter(l=>l);

            let currentDate = '';
            let schedule = schedules[currentSchedule];

            lines.forEach(line => {
                // 檢查是否為日期行
                const dateMatch = line.match(/^(\d{1,2}\/\d{1,2})$/);
                if(dateMatch){
                    currentDate = dateMatch[1];
                    if(!schedule.days[currentDate]){
                        schedule.days[currentDate] = { events: [] };
                    }
                    return;
                }

                // 檢查是否為地點行
                const locMatch = line.match(/^•\s*地點：(.*)$/);
                if(locMatch && currentDate !== ''){
                    const lastEvent = schedule.days[currentDate].events[schedule.days[currentDate].events.length -1];
                    if(lastEvent){
                        lastEvent.loc = locMatch[1].trim();
                    }
                    return;
                }

                // 檢查是否為備註行
                const noteMatch = line.match(/^•\s*備註：(.*)$/);
                if(noteMatch && currentDate !== ''){
                    const lastEvent = schedule.days[currentDate].events[schedule.days[currentDate].events.length -1];
                    if(lastEvent){
                        lastEvent.note = noteMatch[1].trim();
                    }
                    return;
                }

                // 一般行程行
                const eventMatch = line.match(/^•\s*(\d{1,2}:\d{2}\s?(AM|PM)?)\s*[:：]\s*(.*)$/i);
                if(eventMatch && currentDate !== ''){
                    const timeStr = eventMatch[1];
                    const desc = eventMatch[3];
                    let datetime = '';

                    // 解析時間
                    const now = new Date();
                    const year = now.getFullYear();
                    const [month, day] = currentDate.split('/').map(num => parseInt(num,10));

                    let hours = 0;
                    let minutes = 0;
                    let ampm = 'AM';

                    const timeParts = timeStr.match(/(\d{1,2}):(\d{2})\s?(AM|PM)?/i);
                    if(timeParts){
                        hours = parseInt(timeParts[1],10);
                        minutes = parseInt(timeParts[2],10);
                        if(timeParts[3]){
                            ampm = timeParts[3].toUpperCase();
                            if(ampm === 'PM' && hours < 12){
                                hours += 12;
                            }
                            if(ampm === 'AM' && hours === 12){
                                hours = 0;
                            }
                        }
                    }

                    const eventDate = new Date(year, month -1, day, hours, minutes);
                    datetime = eventDate.toISOString();

                    schedule.days[currentDate].events.push({
                        datetime: datetime,
                        desc: desc,
                        loc: '',
                        note: ''
                    });
                }
            });

            saveSchedules();
            renderSchedule();
        }

        // 刪除行程
        function deleteEvent(dateStr, datetime){
            const schedule = schedules[currentSchedule];
            if(schedule.days[dateStr]){
                schedule.days[dateStr].events = schedule.days[dateStr].events.filter(ev => ev.datetime !== datetime);
                if(schedule.days[dateStr].events.length === 0){
                    delete schedule.days[dateStr];
                }
                saveSchedules();
                renderSchedule();
            }
        }

        // 初始化 SortableJS
        function initializeSortable(){
            const lists = document.querySelectorAll('.schedule-list');
            lists.forEach(list => {
                new Sortable(list, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: function (evt) {
                        const dateStr = list.getAttribute('data-date');
                        const schedule = schedules[currentSchedule];
                        const events = schedule.days[dateStr].events;
                        const newOrder = [];
                        list.querySelectorAll('li').forEach(li => {
                            const datetime = li.getAttribute('data-datetime');
                            const event = events.find(ev => ev.datetime === datetime);
                            if(event){
                                newOrder.push(event);
                            }
                        });
                        schedule.days[dateStr].events = newOrder;
                        saveSchedules();
                    }
                });
            });
        }

        // 匯出單一行程的 ICS
        function exportICS(event){
            const summary = event.desc;
            const location = event.loc || '';
            const description = event.note || '';

            const eventDate = new Date(event.datetime);
            const start = formatICSDate(eventDate);
            const end = formatICSDate(new Date(eventDate.getTime() + 60*60*1000)); // 假設活動持續1小時

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//YourProduct//Event//EN
BEGIN:VEVENT
UID:${Date.now()}@yourdomain.com
DTSTAMP:${start}Z
DTSTART:${start}Z
DTEND:${end}Z
SUMMARY:${escapeICS(summary)}
LOCATION:${escapeICS(location)}
DESCRIPTION:${escapeICS(description)}
END:VEVENT
END:VCALENDAR`;

            downloadICS(icsContent, `${summary}.ics`);
        }

        // 匯出當日所有行程的 ICS
        function exportDayICS(dateStr){
            const schedule = schedules[currentSchedule];
            const events = schedule.days[dateStr].events;
            if(events.length === 0){
                alert('當天沒有行程。');
                return;
            }

            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//YourProduct//Events//EN
`;

            events.forEach(event => {
                const summary = event.desc;
                const location = event.loc || '';
                const description = event.note || '';

                const eventDate = new Date(event.datetime);
                const start = formatICSDate(eventDate);
                const end = formatICSDate(new Date(eventDate.getTime() + 60*60*1000)); // 假設活動持續1小時

                icsContent += `BEGIN:VEVENT
UID:${Date.now()}@yourdomain.com
DTSTAMP:${start}Z
DTSTART:${start}Z
DTEND:${end}Z
SUMMARY:${escapeICS(summary)}
LOCATION:${escapeICS(location)}
DESCRIPTION:${escapeICS(description)}
END:VEVENT
`;
            });

            icsContent += `END:VCALENDAR`;

            downloadICS(icsContent, `行程_${dateStr}.ics`);
        }

        // 生成 ICS 格式的日期時間
        function formatICSDate(dateObj){
            const pad = n => n.toString().padStart(2, '0');
            return `${dateObj.getUTCFullYear()}${pad(dateObj.getUTCMonth()+1)}${pad(dateObj.getUTCDate())}T${pad(dateObj.getUTCHours())}${pad(dateObj.getUTCMinutes())}${pad(dateObj.getUTCSeconds())}`;
        }

        // 下載 ICS 檔案
        function downloadICS(content, filename){
            const blob = new Blob([content], {type: 'text/calendar;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 轉義 ICS 內容
        function escapeICS(str){
            if(!str) return '';
            return str.replace(/\\/g, "\\\\")
                      .replace(/;/g, "\\;")
                      .replace(/,/g, "\\,")
                      .replace(/\n/g, "\\n");
        }

        // 匯入批次行程
        function importBatch(text){
            const lines = text.split('\n').map(l => l.trim()).filter(l=>l);
            let currentDate = '';
            let schedule = schedules[currentSchedule];

            lines.forEach(line => {
                // 檢查是否為日期行
                const dateMatch = line.match(/^(\d{1,2}\/\d{1,2})$/);
                if(dateMatch){
                    currentDate = dateMatch[1];
                    if(!schedule.days[currentDate]){
                        schedule.days[currentDate] = { events: [] };
                    }
                    return;
                }

                // 檢查是否為地點行
                const locMatch = line.match(/^•\s*地點：(.*)$/);
                if(locMatch && currentDate !== ''){
                    const lastEvent = schedule.days[currentDate].events[schedule.days[currentDate].events.length -1];
                    if(lastEvent){
                        lastEvent.loc = locMatch[1].trim();
                    }
                    return;
                }

                // 檢查是否為備註行
                const noteMatch = line.match(/^•\s*備註：(.*)$/);
                if(noteMatch && currentDate !== ''){
                    const lastEvent = schedule.days[currentDate].events[schedule.days[currentDate].events.length -1];
                    if(lastEvent){
                        lastEvent.note = noteMatch[1].trim();
                    }
                    return;
                }

                // 一般行程行
                const eventMatch = line.match(/^•\s*(\d{1,2}:\d{2}\s?(AM|PM)?)\s*[:：]\s*(.*)$/i);
                if(eventMatch && currentDate !== ''){
                    const timeStr = eventMatch[1];
                    const desc = eventMatch[3];
                    let datetime = '';

                    // 解析時間
                    const now = new Date();
                    const year = now.getFullYear();
                    const [month, day] = currentDate.split('/').map(num => parseInt(num,10));

                    let hours = 0;
                    let minutes = 0;
                    let ampm = 'AM';

                    const timeParts = timeStr.match(/(\d{1,2}):(\d{2})\s?(AM|PM)?/i);
                    if(timeParts){
                        hours = parseInt(timeParts[1],10);
                        minutes = parseInt(timeParts[2],10);
                        if(timeParts[3]){
                            ampm = timeParts[3].toUpperCase();
                            if(ampm === 'PM' && hours < 12){
                                hours += 12;
                            }
                            if(ampm === 'AM' && hours === 12){
                                hours = 0;
                            }
                        }
                    }

                    const eventDate = new Date(year, month -1, day, hours, minutes);
                    datetime = eventDate.toISOString();

                    schedule.days[currentDate].events.push({
                        datetime: datetime,
                        desc: desc,
                        loc: '',
                        note: ''
                    });
                }
            });

            saveSchedules();
            renderSchedule();
        }
    </script>
</body>
</html>