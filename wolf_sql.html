<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <!-- 加入響應式設定 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>狼狼 SQL 夜市大冒險</title>

    <!-- Google Fonts & Font Awesome -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Animate.css (可自行移除) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <style>
      :root {
        --dark-bg: #121212;
        --dark-overlay: rgba(0, 0, 0, 0.6);
        --light: #f8f9fa;
        --accent: #fed766;
        --primary: #ff577f;
        --secondary: #4ecdc4;
        /* 攤位霓虹色 */
        --stall-select: #ff4d6d;
        --stall-insert: #32e0c4;
        --stall-delete: #f72585;
        --stall-update: #546de5;
        --stall-join: #00adb5;
        --stall-groupby: #ffc107;
        --stall-distinct: #ff6fb5;
        --stall-index: #af98ff;
        --stall-transaction: #ff7f50;
        /* Toast 顏色 */
        --toast-bg: #444;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Noto Sans TC", sans-serif;
      }

      body {
        background: var(--dark-bg) url(img/bg.png) center/cover no-repeat fixed;
        color: var(--light);
        min-height: 100vh;
        position: relative;
      }

      header {
        background: rgba(0, 0, 0, 0.895);
        box-shadow: 0 0 12px var(--light);
        border: 2px solid var(--light);
        border-radius: 6px;
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
        padding: 3rem 1rem;
      }
      .title {
        font-size: 2.2rem;
        margin-bottom: 1rem;
        color: var(--accent);
        text-shadow: 1px 1px 8px rgba(255, 255, 255, 0.5);
        font-family: "Press Start 2P", cursive;
      }
      .desc {
        font-size: 1.1rem;
        line-height: 1.6;
        max-width: 700px;
        margin: 0 auto;
        opacity: 0.9;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }

      .stall-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 2rem;
        max-width: 90%;
        margin: 2rem auto;
      }

      .stall-card {
        background: rgba(20, 20, 20, 0.909);
        border-radius: 10px;
        width: 550px;
        padding: 1rem;
        position: relative;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .stall-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      }
      .stall-header {
        display: flex;
        gap: 0.6rem;
        justify-content: center;
        align-items: center;
        font-size: 1.3rem;
        margin-bottom: 0.8rem;
        position: relative;
      }
      .stall-header::after {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        height: 2px;
        width: 40%;
        background: currentColor;
      }

      /* 各種攤位邊框 */
      .insert-stall {
        border: 2px solid var(--stall-insert);
        box-shadow: 0 0 12px var(--stall-insert);
      }
      .delete-stall {
        border: 2px solid var(--stall-delete);
        box-shadow: 0 0 12px var(--stall-delete);
      }
      .update-stall {
        border: 2px solid var(--stall-update);
        box-shadow: 0 0 12px var(--stall-update);
      }
      .select-stall {
        border: 2px solid var(--stall-select);
        box-shadow: 0 0 12px var(--stall-select);
      }
      .join-stall {
        border: 2px solid var(--stall-join);
        box-shadow: 0 0 12px var(--stall-join);
      }
      .groupby-stall {
        border: 2px solid var(--stall-groupby);
        box-shadow: 0 0 12px var(--stall-groupby);
      }
      .distinct-stall {
        border: 2px solid var(--stall-distinct);
        box-shadow: 0 0 12px var(--stall-distinct);
      }
      .index-stall {
        border: 2px solid var(--stall-index);
        box-shadow: 0 0 12px var(--stall-index);
      }
      .transaction-stall {
        border: 2px solid var(--stall-transaction);
        box-shadow: 0 0 12px var(--stall-transaction);
      }

      /* 商品層架 */
      .product-shelf {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
      }
      .shelf-title {
        text-align: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      .product-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        justify-content: center;
      }
      .product-item {
        width: 90px;
        background: rgba(0, 0, 0, 0.421);
        border-radius: 6px;
        text-align: center;
        padding: 0.6rem;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .product-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.6);
      }
      .icon-box {
        font-size: 1.4rem;
        margin-bottom: 0.3rem;
      }
      .product-name {
        font-weight: bold;
        font-size: 0.9rem;
      }
      .product-price {
        font-size: 0.8rem;
        opacity: 0.8;
      }

      /* 對話框 */
      .dialogue {
        background: var(--dark-overlay);
        border-radius: 8px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        font-size: 0.9rem;
        max-height: none;
        opacity: 1;
        overflow: auto;
        transition: none;
      }
      .dialog-line {
        margin-bottom: 0.4rem;
      }
      .speaker {
        font-weight: bold;
        color: var(--accent);
        margin-right: 0.3rem;
      }

      /* 按鈕 */
      .stall-buttons {
        margin-bottom: 0.8rem;
      }
      .stall-btn {
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: 6px;
        padding: 0.6rem 0.9rem;
        font-size: 0.85rem;
        font-weight: bold;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .stall-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
      }

      /* 內聯顯示SQL/PHP */
      .inline-sql-box {
        position: relative;
        background: #2e2e3e;
        margin: 0.5rem 0;
        border-radius: 6px;
        padding: 0.6rem;
        font-size: 0.85rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
      }
      .inline-sql-box pre {
        max-height: 200px;
        overflow-y: auto;
      }
      .inline-sql-title {
        font-weight: bold;
        margin-bottom: 0.3rem;
      }
      .inline-sql-copy {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        font-size: 0.7rem;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
        opacity: 0.8;
      }
      .inline-sql-copy:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
      }
      .modal-overlay.show {
        display: flex;
      }
      .modal-content {
        background: #1e1e2e;
        color: #f8f8f2;
        padding: 1rem;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        position: relative;
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.5);
      }
      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border: none;
        font-size: 0.9rem;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
      }
      .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      .modal-title {
        font-weight: bold;
        margin-bottom: 0.6rem;
        font-size: 1rem;
      }
      .modal-pre {
        position: relative;
        background: #2e2e3e;
        border-radius: 6px;
        padding: 0.8rem;
        margin-bottom: 1rem;
        font-size: 0.85rem;
      }
      .modal-pre pre {
        max-height: 200px;
        overflow-y: auto;
      }
      .modal-pre .copy-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        font-size: 0.7rem;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
        opacity: 0.8;
      }
      .modal-pre .copy-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Toast */
      .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 9999;
        pointer-events: none;
      }
      .toast {
        background: var(--toast-bg);
        color: #fff;
        padding: 0.8rem 1rem;
        border-radius: 6px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        opacity: 0.9;
        pointer-events: auto;
      }

      /* 簡易 RWD */
      @media (max-width: 768px) {
        .stall-card {
          width: 95%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <header>
      <h1 class="title">SQL 夜市大冒險</h1>
      <p class="desc">
        這裡有 INSERT、DELETE、UPDATE、SELECT、JOIN、GROUP
        BY、DISTINCT/UNION、INDEX、Transaction 等超完整的 SQL 功能示範！
        <strong>小狼、小兔</strong>走訪夜市，輕鬆點選按鈕即可預覽
        <strong>SQL/PHP語法</strong> 與操作效果～偶爾還有熱心攤主教學。
        30秒沒動作就會自動復原攤販，也可以手動「復原攤販」，慢慢逛別著急呦！
      </p>
    </header>

    <main class="stall-container" id="stallArea"></main>

    <!-- Modal (顯示建表秘方) -->
    <div class="modal-overlay" id="modalOverlay">
      <div class="modal-content" id="modalContent">
        <button class="modal-close" id="modalClose">關閉</button>
        <h3 class="modal-title" id="modalTitle"></h3>
        <!-- 動態插入多個 pre 區塊 -->
      </div>
    </div>

    <script>
      // =========== 攤位資料 (隨機批量上架用) ===========
      const randomIceFlavors = [
        { name: "抹茶豆花", price: 60 },
        { name: "巧克力棉花", price: 75 },
        { name: "焦糖奶霜", price: 80 },
        { name: "菠蘿冰沙", price: 70 },
        { name: "oreo雪泥", price: 85 },
      ];

      // 幫不同動作預先準備好相關的 SQL/PHP 片段
      // PHP 部分移除了連線程式碼，並加入中文錯誤訊息及註解提示
      const codeSnippets = {
        insertSingle: {
          sql: `INSERT INTO ice_creams (flavor, price)\nVALUES ('香草泡芙冰',80);`,
          php: `<?php
// 執行單筆新增
$sql = "INSERT INTO ice_creams (flavor, price) VALUES ('香草泡芙冰',80)";
if(mysqli_query($conn, $sql)){
    echo "新增成功。";
} else {
    echo "新增失敗：" . mysqli_error($conn);
}
?>`,
        },
        insertBatch: {
          sql: `INSERT INTO ice_creams (flavor, price)\nVALUES\n('抹茶豆花',60),\n('巧克力棉花',75);`,
          php: `<?php
// 執行批量新增
$sql = "INSERT INTO ice_creams (flavor, price) VALUES ('抹茶豆花',60),('巧克力棉花',75)";
if(mysqli_query($conn, $sql)){
    echo "批量新增成功。";
} else {
    echo "批量新增失敗：" . mysqli_error($conn);
}
?>`,
        },
        deleteItem: {
          sql: `DELETE FROM skewers\nWHERE item_name='烤香腸';`,
          php: `<?php
// 刪除指定項目
$sql = "DELETE FROM skewers WHERE item_name='烤香腸'";
if(mysqli_query($conn, $sql)){
    echo "刪除成功。";
} else {
    echo "刪除失敗：" . mysqli_error($conn);
}
?>`,
        },
        deleteAll: {
          sql: `DELETE FROM skewers; -- 清空整張表資料`,
          php: `<?php
// 清空整張表
$sql = "DELETE FROM skewers";
if(mysqli_query($conn, $sql)){
    echo "全部記錄已刪除。";
} else {
    echo "刪除失敗：" . mysqli_error($conn);
}
?>`,
        },
        updatePrice: {
          sql: `UPDATE tea_products\nSET price=65\nWHERE product_name='珍珠奶茶';`,
          php: `<?php
// 更新指定商品價格
$sql = "UPDATE tea_products SET price=65 WHERE product_name='珍珠奶茶'";
if(mysqli_query($conn, $sql)){
    echo "價格更新成功。";
} else {
    echo "價格更新失敗：" . mysqli_error($conn);
}
?>`,
        },
        updateAll: {
          sql: `UPDATE tea_products\nSET price = price + 5; -- 全部+5元`,
          php: `<?php
// 將所有商品價格加5
$sql = "UPDATE tea_products SET price = price + 5";
if(mysqli_query($conn, $sql)){
    echo "全部價格更新成功。";
} else {
    echo "更新失敗：" . mysqli_error($conn);
}
?>`,
        },
        selectMain: {
          sql: `SELECT dish_name, price\nFROM menu\nWHERE category_id=1;`,
          php: `<?php
// 查詢主食
$sql = "SELECT dish_name, price FROM menu WHERE category_id=1";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['dish_name'] . "：" . $row['price'] . " 元<br>";
    }
}
?>`,
        },
        selectSoup: {
          sql: `SELECT dish_name, price\nFROM menu\nWHERE category_id=2;`,
          php: `<?php
// 查詢湯品
$sql = "SELECT dish_name, price FROM menu WHERE category_id=2";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['dish_name'] . "：" . $row['price'] . " 元<br>";
    }
}
?>`,
        },
        joinInner: {
          sql: `SELECT m.dish_name, c.category_name\nFROM menu m\nJOIN categories c\nON m.category_id=c.id;`,
          php: `<?php
// 使用 INNER JOIN 查詢
$sql = "SELECT m.dish_name, c.category_name FROM menu m JOIN categories c ON m.category_id=c.id";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['dish_name'] . " / " . $row['category_name'] . "<br>";
    }
}
?>`,
        },
        joinLeft: {
          sql: `SELECT m.dish_name, c.category_name\nFROM menu m\nLEFT JOIN categories c\nON m.category_id=c.id;`,
          php: `<?php
// 使用 LEFT JOIN 查詢
$sql = "SELECT m.dish_name, c.category_name FROM menu m LEFT JOIN categories c ON m.category_id=c.id";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['dish_name'] . " / " . $row['category_name'] . "<br>";
    }
}
?>`,
        },
        groupBy: {
          sql: `SELECT category, COUNT(*) AS total\nFROM drinks\nGROUP BY category\nORDER BY total DESC;`,
          php: `<?php
// 使用 GROUP BY 進行統計查詢
$sql = "SELECT category, COUNT(*) AS total FROM drinks GROUP BY category ORDER BY total DESC";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['category'] . " - " . $row['total'] . " 項<br>";
    }
}
?>`,
        },
        groupBySort: {
          sql: `SELECT category, COUNT(*) AS total\nFROM drinks\nGROUP BY category\nORDER BY total ASC;`,
          php: `<?php
// 使用 GROUP BY 並依升序排序統計
$sql = "SELECT category, COUNT(*) AS total FROM drinks GROUP BY category ORDER BY total ASC";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['category'] . " - " . $row['total'] . " 項<br>";
    }
}
?>`,
        },
        distinctTest: {
          sql: `SELECT DISTINCT category\nFROM products;`,
          php: `<?php
// 使用 DISTINCT 去除重複
$sql = "SELECT DISTINCT category FROM products";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['category'] . "<br>";
    }
}
?>`,
        },
        unionTest: {
          sql: `SELECT colA FROM table1\nUNION\nSELECT colA FROM table2;`,
          php: `<?php
// 使用 UNION 合併查詢結果
$sql = "SELECT colA FROM table1 UNION SELECT colA FROM table2";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['colA'] . "<br>";
    }
}
?>`,
        },
        indexCreate: {
          sql: `CREATE INDEX idx_item\nON big_data (item_name);`,
          php: `<?php
// 建立索引
$sql = "CREATE INDEX idx_item ON big_data(item_name)";
if(mysqli_query($conn, $sql)){
    echo "索引建立成功。";
} else {
    echo "索引建立失敗：" . mysqli_error($conn);
}
?>`,
        },
        indexDrop: {
          sql: `DROP INDEX idx_item\nON big_data;`,
          php: `<?php
// 移除索引
$sql = "DROP INDEX idx_item ON big_data";
if(mysqli_query($conn, $sql)){
    echo "索引移除成功。";
} else {
    echo "索引移除失敗：" . mysqli_error($conn);
}
?>`,
        },
        transactionCommit: {
          sql: `START TRANSACTION;\nINSERT INTO orders (product, qty) VALUES ('金幣包',2);\nUPDATE customers SET balance=balance-200 WHERE id=123;\nCOMMIT;`,
          php: `<?php
// 開始交易
mysqli_begin_transaction($conn);
try {
    // 執行新增訂單
    $sql1 = "INSERT INTO orders (product, qty) VALUES ('金幣包',2)";
    if(!mysqli_query($conn, $sql1)){
        throw new Exception(mysqli_error($conn));
    }
    // 執行扣款操作
    $sql2 = "UPDATE customers SET balance=balance-200 WHERE id=123";
    if(!mysqli_query($conn, $sql2)){
        throw new Exception(mysqli_error($conn));
    }
    // 提交交易
    mysqli_commit($conn);
    echo "交易提交成功。";
} catch(Exception $e){
    mysqli_rollback($conn);
    echo "交易失敗：" . $e->getMessage();
}
?>`,
        },
        transactionRollback: {
          sql: `ROLLBACK; -- 交易失敗`,
          php: `<?php
// 回滾交易
if(mysqli_rollback($conn)){
    echo "交易已回滾。";
} else {
    echo "回滾失敗：" . mysqli_error($conn);
}
?>`,
        },
      };

      // 9 大攤位資料
      const stallsData = [
        {
          id: "insert",
          className: "insert-stall",
          icon: "fa-solid fa-ice-cream",
          title: "創意冰品店 (INSERT)",
          productShelfTitle: "冰品名單",
          dialogues: [
            {
              speaker: "冰品店老闆",
              text: "哈囉～小狼、小兔歡迎來嚐鮮，我們的冰品口味獨一無二唷！",
            },
            {
              speaker: "小兔",
              text: "聽起來好可口，快來新增幾樣吧，讓我大飽口福～",
            },
          ],
          products: [
            { icon: "fa-solid fa-ice-cream", name: "芒果雪花冰", price: 70 },
            { icon: "fa-solid fa-ice-cream", name: "草莓冰淇淋", price: 65 },
          ],
          operationButtons: [
            {
              label: "上架新品",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "冰品店老闆",
                  text: "沒問題！『香草泡芙冰』甜而不膩，一次滿足。",
                });
                const newItem = {
                  icon: "fa-solid fa-ice-cream",
                  name: "香草泡芙冰",
                  price: 80,
                };
                stallObj.products.push(newItem);
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.insertSingle.sql,
                  codeSnippets.insertSingle.php
                );
              },
            },
            {
              label: "批量上架(隨機)",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "冰品店老闆",
                  text: "好耶～給你多口味選擇，一次上好幾款！",
                });
                for (let i = 0; i < 2; i++) {
                  const rand =
                    randomIceFlavors[
                      Math.floor(Math.random() * randomIceFlavors.length)
                    ];
                  stallObj.products.push({
                    icon: "fa-solid fa-ice-cream",
                    name: "新品 - " + rand.name,
                    price: rand.price,
                  });
                }
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.insertBatch.sql,
                  codeSnippets.insertBatch.php
                );
              },
            },
          ],
          secretSQL: `CREATE TABLE ice_creams (
    id INT AUTO_INCREMENT PRIMARY KEY,
    flavor VARCHAR(100),
    price INT
);
INSERT INTO ice_creams (flavor, price)  VALUES ('芒果雪花冰',70),('草莓冰淇淋',75);

-- 單筆新增
INSERT INTO ice_creams (flavor, price) VALUES ('香草泡芙冰',80);
-- 批量多筆
INSERT INTO ice_creams (flavor, price) VALUES ('抹茶豆花',60),('巧克力棉花',75);`,
          secretPHP: `<?php
// 執行單筆新增的 PHP 範例
$sql = "INSERT INTO ice_creams (flavor, price) VALUES ('香草泡芙冰',80)";
if(mysqli_query($conn, $sql)){
    echo "新增成功。";
} else {
    echo "新增失敗：" . mysqli_error($conn);
}
?>`,
        },
        {
          id: "delete",
          className: "delete-stall",
          icon: "fa-solid fa-trash-can",
          title: "香辣串烤攤 (DELETE)",
          productShelfTitle: "串烤菜單",
          dialogues: [
            {
              speaker: "串烤攤老闆",
              text: "小狼、小兔，你們口味刁鑽嗎？沒關係，不愛的就刪掉～",
            },
            {
              speaker: "小狼",
              text: "哈～先把不受歡迎的下架好了，省得佔空間。",
            },
          ],
          products: [
            { icon: "fa-solid fa-drumstick-bite", name: "烤雞翅", price: 45 },
            { icon: "fa-solid fa-hotdog", name: "烤香腸", price: 35 },
            { icon: "fa-solid fa-fish", name: "烤秋刀魚", price: 55 },
          ],
          operationButtons: [
            {
              label: "刪除香腸",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "串烤攤老闆",
                  text: "好的，先幫您刪除香腸，讓菜單更清爽。",
                });
                stallObj.products = stallObj.products.filter(
                  (p) => p.name !== "烤香腸"
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.deleteItem.sql,
                  codeSnippets.deleteItem.php
                );
              },
            },
            {
              label: "清空全部",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "啊～一次都不留，這可是大膽的決定呢！",
                });
                stallObj.products = [];
                stallObj.filtered = [];
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.deleteAll.sql,
                  codeSnippets.deleteAll.php
                );
              },
            },
          ],
          secretSQL: `CREATE TABLE skewers (
    id INT AUTO_INCREMENT PRIMARY KEY,
    item_name VARCHAR(100),
    price INT
);
INSERT INTO skewers (item_name, price) VALUES ('烤雞翅',45),('烤香腸',35),('烤秋刀魚',55);
-- 刪除
DELETE FROM skewers WHERE item_name='烤香腸';`,
          secretPHP: `<?php
// 執行刪除香腸的 PHP 範例
$sql = "DELETE FROM skewers WHERE item_name='烤香腸'";
if(mysqli_query($conn, $sql)){
    echo "刪除成功。";
} else {
    echo "刪除失敗：" . mysqli_error($conn);
}
?>`,
        },
        {
          id: "update",
          className: "update-stall",
          icon: "fa-solid fa-pen-to-square",
          title: "復古茶飲鋪 (UPDATE)",
          productShelfTitle: "茶飲清單",
          dialogues: [
            {
              speaker: "茶飲鋪老闆",
              text: "歡迎～最近原料費上升，想調整價錢，請幫我看看。",
            },
            {
              speaker: "小狼",
              text: "沒問題，我們來 UPDATE 一下，順便把整體調整好。",
            },
          ],
          products: [
            { icon: "fa-solid fa-mug-hot", name: "珍珠奶茶", price: 55 },
            { icon: "fa-solid fa-mug-hot", name: "綠茶", price: 25 },
          ],
          operationButtons: [
            {
              label: "調漲珍奶",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "茶飲鋪老闆",
                  text: "好的，珍奶調漲，成本高啊，請見諒。",
                });
                stallObj.products = stallObj.products.map((p) => {
                  if (p.name === "珍珠奶茶") {
                    return { ...p, price: p.price + 10 };
                  }
                  return p;
                });
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.updatePrice.sql,
                  codeSnippets.updatePrice.php
                );
              },
            },
            {
              label: "一次改多項",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "行，那就一起更新，多一點彈性空間嘛。",
                });
                stallObj.products = stallObj.products.map((p) => ({
                  ...p,
                  price: p.price + 5,
                }));
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.updateAll.sql,
                  codeSnippets.updateAll.php
                );
              },
            },
          ],
          secretSQL: `CREATE TABLE tea_products (
    product_name VARCHAR(100),
    price INT
);
INSERT INTO tea_products (product_name, price) VALUES ('珍珠奶茶',55),('綠茶',25);
-- UPDATE
UPDATE tea_products SET price=65 WHERE product_name='珍珠奶茶';`,
          secretPHP: `<?php
// 執行更新價格的 PHP 範例
$sql = "UPDATE tea_products SET price=65 WHERE product_name='珍珠奶茶'";
if(mysqli_query($conn, $sql)){
    echo "更新成功。";
} else {
    echo "更新失敗：" . mysqli_error($conn);
}
?>`,
        },
        {
          id: "select",
          className: "select-stall",
          icon: "fa-solid fa-bowl-food",
          title: "查詢小館 (SELECT)",
          productShelfTitle: "查詢小館精選美食",
          dialogues: [
            { speaker: "小兔", text: "聽說這攤啥都能查，主食、湯品應有盡有～" },
            {
              speaker: "攤位老闆",
              text: "沒錯！隨你 SELECT，來看看想吃哪種類～",
            },
          ],
          products: [
            {
              icon: "fa-solid fa-utensils",
              name: "炒麵",
              price: 80,
              category: "主食",
            },
            {
              icon: "fa-solid fa-burger",
              name: "滷肉飯",
              price: 60,
              category: "主食",
            },
            {
              icon: "fa-solid fa-mug-saucer",
              name: "肉羹湯",
              price: 45,
              category: "湯品",
            },
            {
              icon: "fa-solid fa-leaf",
              name: "燙青菜",
              price: 30,
              category: "青菜",
            },
          ],
          operationButtons: [
            {
              label: "查主食",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "想先看主食，吃飽了才有力氣逛別攤！",
                });
                stallObj.filtered = stallObj.products.filter(
                  (p) => p.category === "主食"
                );
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.selectMain.sql,
                  codeSnippets.selectMain.php
                );
              },
            },
            {
              label: "查湯品",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "攤位老闆",
                  text: "那就來碗熱呼呼的湯吧～最溫暖不過了！",
                });
                stallObj.filtered = stallObj.products.filter(
                  (p) => p.category === "湯品"
                );
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.selectSoup.sql,
                  codeSnippets.selectSoup.php
                );
              },
            },
          ],
          secretSQL: `CREATE TABLE menu (
    dish_name VARCHAR(100),
    price INT,
    category_id INT
);
INSERT INTO menu (dish_name, price, category_id) VALUES ('炒麵',80,1),('滷肉飯',60,1),('肉羹湯',45,2),('燙青菜',30,3);
-- SELECT
SELECT dish_name, price FROM menu WHERE category_id=1;`,
          secretPHP: `<?php
// 執行查詢主食的 PHP 範例
$sql = "SELECT dish_name, price FROM menu WHERE category_id=1";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['dish_name'] . "：" . $row['price'] . " 元<br>";
    }
}
?>`,
        },
        {
          id: "join",
          className: "join-stall",
          icon: "fa-solid fa-handshake-angle",
          title: "關聯餐館 (JOIN)",
          productShelfTitle: "關聯餐館混搭菜色",
          dialogues: [
            {
              speaker: "小狼",
              text: "哇～據說這裡能把隔壁的資料一起關聯，感覺很厲害！",
            },
            {
              speaker: "餐館老闆",
              text: "是的，用 JOIN 把品項合併，讓菜單更豐富唷～",
            },
          ],
          products: [
            {
              icon: "fa-solid fa-utensils",
              name: "炒米粉",
              price: 70,
              category: "主食",
            },
            {
              icon: "fa-solid fa-burger",
              name: "漢堡排",
              price: 120,
              category: "西式",
            },
            {
              icon: "fa-solid fa-mug-saucer",
              name: "味噌湯",
              price: 40,
              category: "湯品",
            },
          ],
          operationButtons: [
            {
              label: "INNER JOIN測試",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "餐館老闆",
                  text: "用 INNER JOIN，把主廚的私藏菜單合併進來囉！",
                });
                stallObj.filtered = stallObj.products.map((p) => ({
                  ...p,
                  name: p.name + " (JOINed)",
                }));
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.joinInner.sql,
                  codeSnippets.joinInner.php
                );
              },
            },
            {
              label: "LEFT JOIN測試",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "Left JOIN 試試看，看有沒有遺漏的菜色？",
                });
                stallObj.filtered = stallObj.products.map((p) => ({
                  ...p,
                  name: p.name + " (LeftJOINed)",
                }));
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.joinLeft.sql,
                  codeSnippets.joinLeft.php
                );
              },
            },
          ],
          secretSQL: `CREATE TABLE categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    category_name VARCHAR(100)
);
CREATE TABLE menu (
    id INT AUTO_INCREMENT PRIMARY KEY,
    dish_name VARCHAR(100),
    category_id INT,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);
-- JOIN
SELECT m.dish_name, c.category_name FROM menu m JOIN categories c ON m.category_id=c.id;`,
          secretPHP: `<?php
// 執行 JOIN 查詢的 PHP 範例
$sql = "SELECT m.dish_name, c.category_name FROM menu m JOIN categories c ON m.category_id=c.id";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['dish_name'] . " / " . $row['category_name'] . "<br>";
    }
}
?>`,
        },
        {
          id: "groupby",
          className: "groupby-stall",
          icon: "fa-solid fa-chart-column",
          title: "特調飲品吧 (GROUP BY)",
          productShelfTitle: "飲品分組統計",
          dialogues: [
            {
              speaker: "小兔",
              text: "好想知道目前哪類飲品賣得多，或是有沒有其他分類？",
            },
            {
              speaker: "飲品吧老闆",
              text: "GROUP BY 一下就清楚囉，馬上分組給你看！",
            },
          ],
          products: [
            {
              icon: "fa-solid fa-cocktail",
              name: "珍珠奶茶",
              price: 55,
              category: "飲品",
            },
            {
              icon: "fa-solid fa-cocktail",
              name: "紅茶",
              price: 25,
              category: "飲品",
            },
            {
              icon: "fa-solid fa-cocktail",
              name: "綠茶",
              price: 25,
              category: "飲品",
            },
            {
              icon: "fa-solid fa-ice-cream",
              name: "芒果冰沙",
              price: 70,
              category: "冰品",
            },
          ],
          operationButtons: [
            {
              label: "分組統計",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "飲品吧老闆",
                  text: "計算中～來看看飲品和冰品各有多少！",
                });
                const drinkCount = stallObj.products.filter(
                  (p) => p.category === "飲品"
                ).length;
                const iceCount = stallObj.products.filter(
                  (p) => p.category === "冰品"
                ).length;
                stallObj.filtered = [
                  {
                    icon: "fa-solid fa-cocktail",
                    name: "飲品類",
                    price: drinkCount + " 項",
                  },
                  {
                    icon: "fa-solid fa-ice-cream",
                    name: "冰品類",
                    price: iceCount + " 項",
                  },
                ];
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.groupBy.sql,
                  codeSnippets.groupBy.php
                );
              },
            },
            {
              label: "排序後統計",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "再幫我排個順序，一目了然～",
                });
                stallObj.filtered = [
                  {
                    icon: "fa-solid fa-cocktail",
                    name: "飲品類",
                    price: "3 項 (排序1)",
                  },
                  {
                    icon: "fa-solid fa-ice-cream",
                    name: "冰品類",
                    price: "1 項 (排序2)",
                  },
                ];
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.groupBySort.sql,
                  codeSnippets.groupBySort.php
                );
              },
            },
          ],
          secretSQL: `CREATE TABLE drinks (
    product_name VARCHAR(100),
    category VARCHAR(50),
    price INT
);
INSERT INTO drinks (product_name, category, price) VALUES
('珍珠奶茶','飲品',55),('紅茶','飲品',25),('綠茶','飲品',25),('芒果冰沙','冰品',70);
-- GROUP BY
SELECT category, COUNT(*) AS total FROM drinks GROUP BY category ORDER BY total DESC;`,
          secretPHP: `<?php
// 執行 GROUP BY 統計查詢的 PHP 範例
$sql = "SELECT category, COUNT(*) AS total FROM drinks GROUP BY category ORDER BY total DESC";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤：" . mysqli_error($conn);
} else {
    while($row = mysqli_fetch_assoc($result)){
        echo $row['category'] . " - " . $row['total'] . " 項<br>";
    }
}
?>`,
        },
        {
          id: "distinct",
          className: "distinct-stall",
          icon: "fa-solid fa-code-branch",
          title: "獨特/合併攤 (DISTINCT / UNION)",
          productShelfTitle: "查詢合併 & 過濾重複",
          dialogues: [
            {
              speaker: "小狼",
              text: "我看到重複的品項有點混淆，可以幫我去重或合併嗎？",
            },
            {
              speaker: "老闆",
              text: "那就用 DISTINCT 跟 UNION 吧！乾淨俐落～",
            },
          ],
          products: [
            { icon: "fa-solid fa-code-branch", name: "項目A", price: 0 },
            { icon: "fa-solid fa-code-branch", name: "項目B", price: 0 },
            { icon: "fa-solid fa-code-branch", name: "項目A", price: 0 },
          ],
          operationButtons: [
            {
              label: "DISTINCT測試",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "讚讚！要是都不重複就一目了然囉。",
                });
                const seen = new Set();
                stallObj.filtered = stallObj.products.filter((p) => {
                  if (seen.has(p.name)) return false;
                  seen.add(p.name);
                  return true;
                });
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.distinctTest.sql,
                  codeSnippets.distinctTest.php
                );
              },
            },
            {
              label: "UNION模擬",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "老闆",
                  text: "合併另一份清單囉，看能否彙整更完整！",
                });
                const secondSet = [
                  { icon: "fa-solid fa-code-branch", name: "項目C", price: 0 },
                  { icon: "fa-solid fa-code-branch", name: "項目B", price: 0 },
                ];
                stallObj.filtered = [...stallObj.products, ...secondSet];
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.unionTest.sql,
                  codeSnippets.unionTest.php
                );
              },
            },
          ],
          secretSQL: `-- DISTINCT/UNION
SELECT DISTINCT category FROM products;

SELECT colA FROM table1 UNION SELECT colA FROM table2;`,
          secretPHP: `<?php
// 執行 DISTINCT 查詢
$sql = "SELECT DISTINCT category FROM products";
$result = mysqli_query($conn, $sql);
if(!$result){
    echo "查詢錯誤 (DISTINCT)：" . mysqli_error($conn);
} else {
    echo "不同類別：<br>";
    while($row = mysqli_fetch_assoc($result)){
        echo $row['category'] . "<br>";
    }
}
// 執行 UNION 查詢
$sql2 = "SELECT colA FROM table1 UNION SELECT colA FROM table2";
$result2 = mysqli_query($conn, $sql2);
if(!$result2){
    echo "查詢錯誤 (UNION)：" . mysqli_error($conn);
} else {
    echo "合併結果：<br>";
    while($row = mysqli_fetch_assoc($result2)){
        echo $row['colA'] . "<br>";
    }
}
?>`,
        },
        {
          id: "index",
          className: "index-stall",
          icon: "fa-solid fa-search",
          title: "神速索引舖 (INDEX)",
          productShelfTitle: "索引資料展示",
          dialogues: [
            {
              speaker: "老闆",
              text: "資料一多，查詢可能會變慢，我們用 INDEX 加速就行～",
            },
            { speaker: "小兔", text: "好啊好啊，試試看建立索引後是不是飛快！" },
          ],
          products: [
            { icon: "fa-solid fa-search", name: "大資料 A", price: 999 },
            { icon: "fa-solid fa-search", name: "大資料 B", price: 888 },
          ],
          operationButtons: [
            {
              label: "建立索引",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "老闆",
                  text: "好的，INDEX on！查詢有如坐雲霄飛車喔～",
                });
                showToast(stallObj, "已模擬「建立索引」!");
                stallObj.products.push({
                  icon: "fa-solid fa-bolt",
                  name: "索引狀態: ON",
                  price: 0,
                });
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.indexCreate.sql,
                  codeSnippets.indexCreate.php
                );
              },
            },
            {
              label: "移除索引",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "那就先關閉吧，看看沒有索引時速度如何～",
                });
                showToast(stallObj, "已模擬「移除索引」!");
                stallObj.products = stallObj.products.filter(
                  (p) => p.name !== "索引狀態: ON"
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.indexDrop.sql,
                  codeSnippets.indexDrop.php
                );
              },
            },
          ],
          secretSQL: `CREATE TABLE big_data (
    id INT AUTO_INCREMENT PRIMARY KEY,
    item_name VARCHAR(255)
);
-- 建立索引
CREATE INDEX idx_item ON big_data (item_name);`,
          secretPHP: `<?php
// 執行建立索引的 PHP 範例
$sql = "CREATE INDEX idx_item ON big_data(item_name)";
if(mysqli_query($conn, $sql)){
    echo "索引建立成功。";
} else {
    echo "索引建立失敗：" . mysqli_error($conn);
}
?>`,
        },
        {
          id: "transaction",
          className: "transaction-stall",
          icon: "fa-solid fa-coins",
          title: "交易行 (Transaction)",
          productShelfTitle: "交易商品(模擬)",
          dialogues: [
            {
              speaker: "小狼",
              text: "想一次買多筆，請問能確保全部成功或全部失敗嗎？",
            },
            { speaker: "老闆", text: "沒問題！Transaction 出馬，幫你打包票～" },
          ],
          products: [
            { icon: "fa-solid fa-coins", name: "金幣包", price: 100 },
            { icon: "fa-solid fa-coins", name: "銀幣袋", price: 50 },
          ],
          operationButtons: [
            {
              label: "進行交易",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "老闆",
                  text: "交易成功！再添個紀念品，象徵圓滿。",
                });
                showToast(stallObj, "交易提交成功！");
                stallObj.products.push({
                  icon: "fa-solid fa-check",
                  name: "成交成功！",
                  price: 999,
                });
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.transactionCommit.sql,
                  codeSnippets.transactionCommit.php
                );
              },
            },
            {
              label: "交易失敗",
              onClick: (stallObj) => {
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "呀～出了一些意外，我想要 Rollback。",
                });
                showToast(stallObj, "交易已回滾！");
                stallObj.products = stallObj.products.filter(
                  (p) => p.name !== "成交成功！"
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.transactionRollback.sql,
                  codeSnippets.transactionRollback.php
                );
              },
            },
          ],
          secretSQL: `START TRANSACTION;
INSERT INTO orders (product, qty) VALUES ('金幣包', 2);
UPDATE customers SET balance=balance-200 WHERE id=123;
COMMIT;

-- 若失敗
ROLLBACK;`,
          secretPHP: `<?php
// 執行交易提交的 PHP 範例
mysqli_begin_transaction($conn);
try {
    $sql1 = "INSERT INTO orders (product, qty) VALUES ('金幣包',2)";
    if(!mysqli_query($conn, $sql1)){
        throw new Exception(mysqli_error($conn));
    }
    $sql2 = "UPDATE customers SET balance=balance-200 WHERE id=123";
    if(!mysqli_query($conn, $sql2)){
        throw new Exception(mysqli_error($conn));
    }
    mysqli_commit($conn);
    echo "交易提交成功。";
} catch(Exception $e){
    mysqli_rollback($conn);
    echo "交易失敗：" . $e->getMessage();
}
?>`,
        },
      ];

      // =========== DOM 生成 ===========
      const stallArea = document.getElementById("stallArea");
      stallsData.forEach((stall) => {
        const stallCard = document.createElement("section");
        stallCard.className = `stall-card ${stall.className}`;
        stallCard.id = `${stall.id}-card`;

        const headerDiv = document.createElement("div");
        headerDiv.className = "stall-header";
        headerDiv.innerHTML = `<i class="${stall.icon}"></i> <span>${stall.title}</span>`;
        stallCard.appendChild(headerDiv);

        const shelf = document.createElement("div");
        shelf.className = "product-shelf";
        shelf.innerHTML = `<div class="shelf-title">${stall.productShelfTitle}</div>`;
        const productGrid = document.createElement("div");
        productGrid.className = "product-grid";

        stall.filtered = stall.products.slice();
        stall.original = stall.products.slice();

        stall.renderProducts = function () {
          productGrid.innerHTML = "";
          this.filtered.forEach((item) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "product-item";
            const priceTxt =
              typeof item.price === "number" ? `${item.price} 元` : item.price;
            itemDiv.innerHTML = `
              <div class="icon-box"><i class="${item.icon}"></i></div>
              <div class="product-name">${item.name}</div>
              <div class="product-price">${priceTxt}</div>
            `;
            productGrid.appendChild(itemDiv);
          });
        };
        stall.renderProducts();
        shelf.appendChild(productGrid);
        stallCard.appendChild(shelf);

        const dialogueDiv = document.createElement("div");
        dialogueDiv.className = "dialogue";
        dialogueDiv.id = `${stall.id}-dialogue`;
        let dHTML = "";
        stall.dialogues.forEach((d) => {
          dHTML += `<div class="dialog-line"><span class="speaker">${d.speaker}</span>：${d.text}</div>`;
        });
        dialogueDiv.innerHTML = dHTML;
        stallCard.appendChild(dialogueDiv);

        const btnContainer = document.createElement("div");
        btnContainer.className = "stall-buttons";

        const secretBtn = document.createElement("button");
        secretBtn.className = "stall-btn";
        secretBtn.textContent = "取得秘方";
        secretBtn.addEventListener("click", () => {
          // 傳入陣列依序為：SQL 建立&範例資料, PHP 連線範例, PHP 範例, PHP 結束連線範例
          showModal(stall.title + " - 完整建表/資料", [
            { codeType: "SQL 建立&範例資料", content: stall.secretSQL },
            {
              codeType: "PHP 連線範例",
              content:
                '$conn = mysqli_connect("localhost", "root", "", "testdb");\n// 檢查連線是否成功\nif(!$conn){\n    die("連線失敗：" . mysqli_connect_error());\n} else {\n    echo "連線成功";\n}',
            },
            { codeType: "PHP 範例", content: stall.secretPHP },
            {
              codeType: "PHP 結束連線範例",
              content: "mysqli_close($conn);\n// 關閉資料庫連線",
            },
          ]);
        });
        btnContainer.appendChild(secretBtn);

        stall.operationButtons.forEach((op) => {
          const opBtn = document.createElement("button");
          opBtn.className = "stall-btn";
          opBtn.textContent = op.label;
          opBtn.addEventListener("click", () => {
            op.onClick(stall);
          });
          btnContainer.appendChild(opBtn);
        });

        const revertBtn = document.createElement("button");
        revertBtn.className = "stall-btn";
        revertBtn.textContent = "復原攤販";
        revertBtn.addEventListener("click", () => {
          revertStall(stall);
        });
        btnContainer.appendChild(revertBtn);

        stallCard.appendChild(btnContainer);

        const inlineSQLContainer = document.createElement("div");
        inlineSQLContainer.id = `${stall.id}-inline-sql-container`;
        stallCard.appendChild(inlineSQLContainer);

        stallArea.appendChild(stallCard);
      });

      // =========== 函式 ===========

      function addDialogue(stallObj, { speaker, text }) {
        const dialogueEl = document.getElementById(`${stallObj.id}-dialogue`);
        const lineDiv = document.createElement("div");
        lineDiv.className = "dialog-line";
        lineDiv.innerHTML = `<span class="speaker">${speaker}</span>：${text}`;
        dialogueEl.appendChild(lineDiv);
      }

      function escapeHTML(text) {
        var map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, function (m) {
          return map[m];
        });
      }

      function showInlineSQL(stallObj, sqlText, phpText) {
        const container = document.getElementById(
          `${stallObj.id}-inline-sql-container`
        );
        container.innerHTML = "";

        // SQL 區塊
        const blockSQL = document.createElement("div");
        blockSQL.className = "inline-sql-box";
        const btnSQL = document.createElement("button");
        btnSQL.className = "inline-sql-copy";
        btnSQL.textContent = "Copy";
        btnSQL.addEventListener("click", function () {
          copyCode(this, sqlText);
        });
        const titleSQL = document.createElement("div");
        titleSQL.className = "inline-sql-title";
        titleSQL.textContent = "SQL 語法";
        const preSQL = document.createElement("pre");
        preSQL.innerHTML = escapeHTML(sqlText);
        blockSQL.appendChild(btnSQL);
        blockSQL.appendChild(titleSQL);
        blockSQL.appendChild(preSQL);
        container.appendChild(blockSQL);

        // PHP 區塊
        const blockPHP = document.createElement("div");
        blockPHP.className = "inline-sql-box";
        const btnPHP = document.createElement("button");
        btnPHP.className = "inline-sql-copy";
        btnPHP.textContent = "Copy";
        btnPHP.addEventListener("click", function () {
          copyCode(this, phpText);
        });
        const titlePHP = document.createElement("div");
        titlePHP.className = "inline-sql-title";
        titlePHP.textContent = "PHP 範例";
        const prePHP = document.createElement("pre");
        prePHP.innerHTML = escapeHTML(phpText);
        blockPHP.appendChild(btnPHP);
        blockPHP.appendChild(titlePHP);
        blockPHP.appendChild(prePHP);
        container.appendChild(blockPHP);
      }

      function copyCode(btn, text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            btn.textContent = "Copied!";
            btn.classList.add("copied");
            setTimeout(() => {
              btn.textContent = "Copy";
              btn.classList.remove("copied");
            }, 1500);
          })
          .catch((err) => {
            console.error("複製失敗：", err);
            showToast(null, "複製失敗，請手動複製");
          });
      }

      // Modal 部分：依序顯示 SQL 建立&範例資料, PHP 連線範例, PHP 範例, PHP 結束連線範例
      const modalOverlay = document.getElementById("modalOverlay");
      const modalContent = document.getElementById("modalContent");
      const modalClose = document.getElementById("modalClose");
      modalClose.addEventListener("click", () => {
        modalOverlay.classList.remove("show");
      });

      function showModal(title, codeBlocks) {
        modalOverlay.classList.add("show");
        modalContent.querySelector("#modalTitle").textContent = title;
        modalContent
          .querySelectorAll(".modal-pre, .modal-title + pre")
          .forEach((el) => el.remove());
        codeBlocks.forEach((block) => {
          const preDiv = document.createElement("div");
          preDiv.className = "modal-pre";
          const copyBtn = document.createElement("button");
          copyBtn.className = "copy-btn";
          copyBtn.textContent = "Copy";
          copyBtn.addEventListener("click", function () {
            copyCode(this, block.content);
          });
          const codeTitle = document.createElement("div");
          codeTitle.style.fontWeight = "bold";
          codeTitle.style.marginBottom = "0.5rem";
          codeTitle.textContent = block.codeType;
          const textPre = document.createElement("pre");
          textPre.style.position = "relative";
          textPre.innerHTML = escapeHTML(block.content);
          preDiv.appendChild(copyBtn);
          preDiv.appendChild(codeTitle);
          preDiv.appendChild(textPre);
          modalContent.appendChild(preDiv);
        });
      }

      const toastContainer = document.getElementById("toastContainer");
      function showToast(stallObj, message) {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = stallObj
          ? `[${stallObj.title}] ${message}`
          : `[系統] ${message}`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add("fade-out");
          toast.style.transition = "opacity 0.5s ease";
          toast.style.opacity = 0;
          setTimeout(() => {
            toastContainer.removeChild(toast);
          }, 500);
        }, 2000);
      }

      let revertTimers = {};
      function resetAutoRevert(stallObj) {
        const sid = stallObj.id;
        if (revertTimers[sid]) {
          clearTimeout(revertTimers[sid]);
        }
        revertTimers[sid] = setTimeout(() => {
          revertStall(stallObj);
        }, 30000);
      }

      function revertStall(stallObj) {
        stallObj.products = stallObj.original.slice();
        stallObj.filtered = stallObj.original.slice();
        stallObj.renderProducts();
        const dialogueEl = document.getElementById(`${stallObj.id}-dialogue`);
        dialogueEl.innerHTML = "";
        stallObj.dialogues.forEach((d) => {
          const lineDiv = document.createElement("div");
          lineDiv.className = "dialog-line";
          lineDiv.innerHTML = `<span class="speaker">${d.speaker}</span>：${d.text}`;
          dialogueEl.appendChild(lineDiv);
        });
        const container = document.getElementById(
          `${stallObj.id}-inline-sql-container`
        );
        container.innerHTML = "";
        showToast(stallObj, "已恢復原始商品 & 對話！");
      }
    </script>

    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>
    <script src="DinoRunner.js"></script>
  </body>
</html>
