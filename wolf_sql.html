<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL 夜市大冒險 - 沉浸式學習體驗</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash/4.17.21/lodash.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --stall-primary: #ff9234;
      --stall-secondary: #ffcd3c;
      --text-light: #f1f2f6;
      --text-dark: #2f3542;
      --neon-red: #ff4757;
      --neon-blue: #70a1ff;
      --neon-green: #2ed573;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Sans TC', sans-serif;
    }
    body {
      background: #1a1a1a;
      color: var(--text-light);
      min-height: 100vh;
      overflow-x: hidden;
    }
    /* 夜市背景效果 */
    .market-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
        url('https://picsum.photos/1920/1080') center/cover;
      z-index: -1;
    }
    /* 霓虹燈效果 */
    .neon-sign {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--neon-red);
      text-shadow: 
        0 0 5px var(--neon-red),
        0 0 10px var(--neon-red),
        0 0 20px var(--neon-red);
      animation: neonFlicker 1.5s infinite alternate;
    }
    @keyframes neonFlicker {
      0%, 18%, 22%, 25%, 53%, 57%, 100% {
        text-shadow: 
          0 0 5px var(--neon-red),
          0 0 10px var(--neon-red),
          0 0 20px var(--neon-red);
      }
      20%, 24%, 55% {
        text-shadow: none;
      }
    }
    /* 夜市入口說明 */
    .market-entrance {
      text-align: center;
      margin-top: 100px;
      padding: 1rem;
    }
    .entrance-desc {
      font-size: 1.2rem;
      margin-top: 10px;
      color: var(--neon-blue);
    }
    /* 互動區塊 */
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 2rem;
      gap: 2rem;
    }
    .market-stall {
      background: linear-gradient(45deg, var(--stall-primary), var(--stall-secondary));
      border-radius: 15px;
      padding: 2rem;
      width: 320px;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transform-style: preserve-3d;
      transition: transform 0.3s ease;
    }
    .stall-canopy {
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 30px;
      background: repeating-linear-gradient(
          45deg,
          var(--stall-primary),
          var(--stall-primary) 10px,
          var(--stall-secondary) 10px,
          var(--stall-secondary) 20px
      );
      border-radius: 10px 10px 0 0;
      transform: perspective(100px) rotateX(5deg);
    }
    .stall-counter {
      background: rgba(255,255,255,0.1);
      padding: 1.5rem;
      border-radius: 10px;
      backdrop-filter: blur(5px);
      margin-top: 1rem;
    }
    .sql-learning-area h3 {
      margin-bottom: 1rem;
      font-size: 1.4rem;
      color: var(--stall-secondary);
      text-align: center;
    }
    .sql-code {
      background: #2f3542;
      padding: 1rem;
      border-radius: 10px;
      font-family: monospace;
      margin-bottom: 1rem;
      position: relative;
    }
    .sql-code::before {
      content: 'SQL';
      position: absolute;
      top: -10px;
      left: 10px;
      background: var(--neon-blue);
      padding: 2px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      color: var(--text-dark);
    }
    .stall-btn {
      background: var(--neon-green);
      color: var(--text-dark);
      border: none;
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .stall-btn:hover::after {
      left: 100%;
    }
    .stall-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
          transparent,
          rgba(255,255,255,0.2),
          transparent
      );
      transform: rotate(45deg);
      transition: 0.5s;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .product-card {
      background: rgba(255,255,255,0.1);
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      transition: transform 0.3s ease;
    }
    .product-card:hover {
      transform: translateY(-5px);
    }
    .product-image {
      width: 80px;
      height: 80px;
      margin: 0 auto;
      background: var(--stall-secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .result-display {
      background: rgba(0,0,0,0.9);
      padding: 1rem;
      border-radius: 10px;
      margin-top: 1rem;
      border: 1px solid var(--neon-blue);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      font-size: 0.9rem;
      overflow-x: auto;
    }
    .result-display.show {
      opacity: 1;
      transform: translateY(0);
    }
    /* RWD */
    @media (max-width: 768px) {
      .market-stall {
        width: 90%;
        padding: 1rem;
      }
    }
    /* 動態效果 */
    .stall-animation {
      animation: stallAppear 0.5s ease-out;
    }
    @keyframes stallAppear {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* 劇情對話 */
    .dialogue {
      text-align: center;
      margin: 1rem;
      font-size: 1.1rem;
      color: var(--neon-blue);
    }
  </style>
</head>
<body>
  <div class="market-scene"></div>
  <!-- 夜市入口 -->
  <header class="market-entrance">
    <div class="neon-sign">SQL 夜市大冒險</div>
    <p class="entrance-desc">和小狼、小兔一起探索 SQL 的美味世界～</p>
  </header>
  
  <!-- 互動攤位 -->
  <div class="container">
    <!-- SELECT 查詢攤位 -->
    <section class="market-stall stall-animation">
      <div class="stall-canopy"></div>
      <h2>🍜 查詢小館</h2>
      <div class="sql-learning-area">
        <h3>SELECT 查詢基礎</h3>
        <div class="sql-code">
          SELECT column1, column2<br>
          FROM table_name<br>
          WHERE condition;
        </div>
        <div class="product-grid">
          <div class="product-card">
            <div class="product-image">🍜</div>
            <h4>基礎查詢</h4>
            <button class="stall-btn" onclick="demonstrateSelect('basic')">試試看</button>
          </div>
          <div class="product-card">
            <div class="product-image">🥘</div>
            <h4>條件查詢</h4>
            <button class="stall-btn" onclick="demonstrateSelect('where')">試試看</button>
          </div>
        </div>
        <div class="result-display" id="select-result"></div>
      </div>
    </section>
    
    <!-- JOIN 關聯攤位 -->
    <section class="market-stall stall-animation">
      <div class="stall-canopy"></div>
      <h2>🍲 關聯餐館</h2>
      <div class="sql-learning-area">
        <h3>JOIN 查詢</h3>
        <div class="sql-code">
          SELECT a.column1, b.column2<br>
          FROM table1 a<br>
          JOIN table2 b ON a.id = b.id;
        </div>
        <div class="product-grid">
          <div class="product-card">
            <div class="product-image">🤝</div>
            <h4>INNER JOIN</h4>
            <button class="stall-btn" onclick="demonstrateJoin('inner')">試試看</button>
          </div>
          <div class="product-card">
            <div class="product-image">🔄</div>
            <h4>LEFT JOIN</h4>
            <button class="stall-btn" onclick="demonstrateJoin('left')">試試看</button>
          </div>
        </div>
        <div class="result-display" id="join-result"></div>
      </div>
    </section>
    
    <!-- 其他功能可用 action-buttons 模擬（不重複攤位外觀） -->
    <section class="market-stall stall-animation">
      <div class="stall-canopy"></div>
      <h2>🔧 進階操作攤</h2>
      <div class="sql-learning-area">
        <h3>進階功能展示</h3>
        <div class="product-grid">
          <div class="product-card">
            <div class="product-image">↕️</div>
            <h4>排序 (ORDER BY)</h4>
            <button class="stall-btn" onclick="demonstrateSort()">試試看</button>
          </div>
          <div class="product-card">
            <div class="product-image">📊</div>
            <h4>銷量排行榜</h4>
            <button class="stall-btn" onclick="demonstrateGroupBy()">試試看</button>
          </div>
          <div class="product-card">
            <div class="product-image">🔍</div>
            <h4>子查詢</h4>
            <button class="stall-btn" onclick="demonstrateSubQuery()">試試看</button>
          </div>
          <div class="product-card">
            <div class="product-image">🏆</div>
            <h4>排名功能</h4>
            <button class="stall-btn" onclick="demonstrateWindowFunc()">試試看</button>
          </div>
          <div class="product-card">
            <div class="product-image">💰</div>
            <h4>交易控制</h4>
            <button class="stall-btn" onclick="demonstrateTransaction()">試試看</button>
          </div>
          <div class="product-card">
            <div class="product-image">⚙️</div>
            <h4>自動促銷</h4>
            <button class="stall-btn" onclick="demonstrateProcTrigger()">試試看</button>
          </div>
          <div class="product-card">
            <div class="product-image">🔑</div>
            <h4>索引與權限</h4>
            <button class="stall-btn" onclick="demonstrateIndexPerm()">試試看</button>
          </div>
        </div>
        <div class="result-display" id="advanced-result"></div>
      </div>
    </section>
  </div>
  
  <!-- 劇情對話區 -->
  <div class="dialogue" id="dialogueBox">
    <strong>小狼</strong>：嗨嗨～各位資料庫狂人，歡迎來到 SQL 夜市！<br>
    <strong>小兔</strong>：靠夭～小狼，你這話說得跟我媽的夜市攤位一樣有味道！
  </div>
  
  <script>
    // 模擬資料庫物件
    let db = {
      name: "",
      tables: {}
    };

    function logOutput(selector, text) {
      document.querySelector(selector).innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${text}</div>
      `;
      document.querySelector(selector).classList.add('show');
    }

    function updateDialogue(speaker, message) {
      document.getElementById('dialogueBox').innerHTML = `<strong>${speaker}</strong>：${message}`;
    }

    function updateDBStructure() {
      // 可擴充左側資料庫結構展示（此處略）
    }

    // SELECT 查詢示範
    function demonstrateSelect(type) {
      const queryResult = document.getElementById('select-result');
      let query = '', explanation = '';
      if (type === 'basic') {
        query = `SELECT dish_name, price FROM menu;`;
        explanation = '查詢菜單中的菜名和價格';
      } else if (type === 'where') {
        query = `SELECT dish_name, price FROM menu WHERE price < 100;`;
        explanation = '查詢價格 100 元以下的菜品';
      }
      queryResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
        <div class="sample-result">
          <table border="1" cellpadding="5">
            <tr><th>菜名</th><th>價格</th></tr>
            <tr><td>炒麵</td><td>80</td></tr>
            <tr><td>滷肉飯</td><td>60</td></tr>
          </table>
        </div>
      `;
      queryResult.classList.add('show');
      updateDialogue("小狼", "SELECT 查詢完成！看來菜單資訊都很清楚了。");
    }

    // JOIN 查詢示範
    function demonstrateJoin(type) {
      const joinResult = document.getElementById('join-result');
      let query = '', explanation = '';
      if (type === 'inner') {
        query = `SELECT m.dish_name, c.category_name
FROM menu m
INNER JOIN categories c ON m.category_id = c.id;`;
        explanation = '查詢所有菜品及其分類（INNER JOIN）';
      } else if (type === 'left') {
        query = `SELECT m.dish_name, o.order_count
FROM menu m
LEFT JOIN orders o ON m.id = o.menu_id;`;
        explanation = '查詢所有菜品的訂單數量，包括未被訂購的菜品（LEFT JOIN）';
      }
      joinResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
        <div class="sample-result">
          <table border="1" cellpadding="5">
            <tr><th>菜名</th><th>分類/訂單數</th></tr>
            <tr><td>炒麵</td><td>主食 / 25</td></tr>
            <tr><td>滷肉飯</td><td>主食 / 30</td></tr>
          </table>
        </div>
      `;
      joinResult.classList.add('show');
      updateDialogue("小狼", "JOIN 查詢完成！攤位合作，套餐組合搞定。");
    }

    // 排序功能示範（ORDER BY）
    function demonstrateSort() {
      const advResult = document.getElementById('advanced-result');
      const query = `SELECT * FROM menu ORDER BY price ASC;`;
      const explanation = '依價格升冪排序，讓你一眼看出最划算的菜品';
      advResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
        <div class="sample-result">
          <table border="1" cellpadding="5">
            <tr><th>菜名</th><th>價格</th></tr>
            <tr><td>滷肉飯</td><td>60</td></tr>
            <tr><td>炒麵</td><td>80</td></tr>
            <tr><td>牛肉麵</td><td>120</td></tr>
          </table>
        </div>
      `;
      advResult.classList.add('show');
      updateDialogue("小狼", "排序完成！這排列就像夜市燈箱，光彩奪目。");
    }

    // 群組統計與篩選示範（GROUP BY / HAVING）
    function demonstrateGroupBy() {
      const advResult = document.getElementById('advanced-result');
      const query = `SELECT category, COUNT(*) AS dish_count
FROM menu
GROUP BY category
HAVING COUNT(*) > 0;`;
      const explanation = '統計各分類菜品數量，製作銷量排行榜';
      advResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
        <div class="sample-result">
          <table border="1" cellpadding="5">
            <tr><th>分類</th><th>菜品數量</th></tr>
            <tr><td>主食</td><td>10</td></tr>
            <tr><td>小吃</td><td>8</td></tr>
          </table>
        </div>
      `;
      advResult.classList.add('show');
      updateDialogue("小狼", "銷量排行榜出爐！攤位人氣一覽無遺。");
    }

    // 子查詢示範
    function demonstrateSubQuery() {
      const advResult = document.getElementById('advanced-result');
      const query = `SELECT dish_name, price
FROM menu
WHERE price > (SELECT AVG(price) FROM menu);`;
      const explanation = '查詢價格高於平均值的菜品，找出高端選擇';
      advResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
        <div class="sample-result">
          <table border="1" cellpadding="5">
            <tr><th>菜名</th><th>價格</th></tr>
            <tr><td>牛肉麵</td><td>120</td></tr>
            <tr><td>招牌炒飯</td><td>110</td></tr>
          </table>
        </div>
      `;
      advResult.classList.add('show');
      updateDialogue("小狼", "子查詢完成！內幕消息已揭露。");
    }

    // Window Functions 示範
    function demonstrateWindowFunc() {
      const advResult = document.getElementById('advanced-result');
      const query = `SELECT dish_name, price,
       RANK() OVER (ORDER BY price DESC) AS rank
FROM menu;`;
      const explanation = '依照價格排名，顯示各菜品的市場排名';
      advResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
        <div class="sample-result">
          <table border="1" cellpadding="5">
            <tr><th>菜名</th><th>價格</th><th>排名</th></tr>
            <tr><td>牛肉麵</td><td>120</td><td>1</td></tr>
            <tr><td>招牌炒飯</td><td>110</td><td>2</td></tr>
            <tr><td>炒麵</td><td>80</td><td>3</td></tr>
          </table>
        </div>
      `;
      advResult.classList.add('show');
      updateDialogue("小狼", "即時排名展示完畢！你看這市場競爭，多激烈！");
    }

    // 交易控制示範（Transaction）
    function demonstrateTransaction() {
      const advResult = document.getElementById('advanced-result');
      const query = `START TRANSACTION;
    UPDATE accounts SET balance = balance - 500 WHERE user_id = 1;
    UPDATE accounts SET balance = balance + 500 WHERE user_id = 2;
COMMIT;`;
      const explanation = '模擬轉帳交易，確保所有操作要嘛全做，要嘛全撤';
      advResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
      `;
      advResult.classList.add('show');
      updateDialogue("小狼", "交易控制成功！操作就像點貨一樣精準。");
    }

    // 儲存程序、觸發器與檢視表示範
    function demonstrateProcTrigger() {
      const advResult = document.getElementById('advanced-result');
      const query = `-- 儲存程序：設定自動折扣促銷
DELIMITER $$
CREATE PROCEDURE auto_discount()
BEGIN
    UPDATE products SET price = price * 0.9 WHERE stock > 100;
END $$
DELIMITER ;

-- 觸發器：新訂單插入後自動通知
DELIMITER $$
CREATE TRIGGER after_order_insert
AFTER INSERT ON orders
FOR EACH ROW
BEGIN
    INSERT INTO notifications(message) VALUES (CONCAT('新訂單來了！訂單編號：', NEW.order_id));
END $$
DELIMITER ;

-- 檢視表：建立人氣排行榜檢視表
CREATE VIEW popular_users AS
SELECT u.name, COUNT(o.order_id) AS orders_count
FROM users u
JOIN orders o ON u.user_id = o.user_id
GROUP BY u.user_id, u.name
HAVING COUNT(o.order_id) > 5;`;
      const explanation = '設定自動促銷、觸發通知及人氣排行榜檢視表';
      advResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
      `;
      advResult.classList.add('show');
      updateDialogue("小狼", "自動促銷與觸發器設定完畢，完全自動化！");
    }

    // 索引與權限管理示範
    function demonstrateIndexPerm() {
      const advResult = document.getElementById('advanced-result');
      const query = `-- 建立索引，加速查詢
CREATE INDEX idx_users_email ON users (email);

-- 權限管理：授權操作
GRANT SELECT, INSERT, UPDATE ON NightMarket.* TO 'assistant_user'@'localhost' IDENTIFIED BY 'secret';

-- 收回權限
REVOKE UPDATE ON NightMarket.orders FROM 'assistant_user'@'localhost';`;
      const explanation = '透過索引優化查詢，並設定權限管理確保安全';
      advResult.innerHTML = `
        <h4>SQL語法：</h4>
        <div class="sql-code">${query}</div>
        <p>${explanation}</p>
      `;
      advResult.classList.add('show');
      updateDialogue("小狼", "索引與權限管理搞定，資料庫運作如同夜市保安般嚴密！");
    }

    // DOMContentLoaded 事件，添加視覺效果
    document.addEventListener('DOMContentLoaded', () => {
      // 霓虹燈閃爍效果（已內建於 CSS）
      // 攤位懸停效果
      const stalls = document.querySelectorAll('.market-stall');
      stalls.forEach(stall => {
        stall.addEventListener('mouseenter', () => {
          stall.style.transform = 'scale(1.02)';
        });
        stall.addEventListener('mouseleave', () => {
          stall.style.transform = 'scale(1)';
        });
      });
    });
  </script>
</body>
</html>