<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQL 夜市大冒險 - 統合版</title>
    <link rel="icon" href="img/wolf.ico" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Animate.css 引入 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <style>
      :root {
        --dark-bg: #121212;
        --dark-overlay: rgba(0, 0, 0, 0.6);
        --light: #f8f9fa;
        --accent: #fed766;
        --primary: #ff577f;
        --secondary: #4ecdc4;
        /* 攤位邊框顏色 */
        --stall-select: #ff4d6d;
        --stall-insert: #32e0c4;
        --stall-delete: #f72585;
        --stall-update: #546de5;
        --stall-join: #00adb5;
        --stall-groupby: #ffc107;
        --stall-distinct: #ff6fb5;
        --stall-index: #af98ff;
        --stall-transaction: #ff7f50;
        --toast-bg: #444;
      }
      /* 重置與字型 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Noto Sans TC", sans-serif;
      }
      body {
        background: var(--dark-bg) url("img/bg.png") center/cover no-repeat
          fixed;
        color: var(--light);
        min-height: 100vh;
        position: relative;
      }
      @media (max-width: 768px) {
        body {
          background: var(--dark-bg) url("img/bg_l.png") center/cover no-repeat
            fixed;
          background-size: 100% auto;
          background-attachment: scroll;
        }
      }
      header {
        background: rgba(0, 0, 0, 0.895);
        box-shadow: 0 0 12px var(--light);
        border: 2px solid var(--light);
        border-radius: 6px;
        max-width: 800px;
        margin: 1rem auto;
        text-align: center;
        padding: 3rem 1rem;
      }
      .title {
        font-size: 2.2rem;
        margin-bottom: 1rem;
        color: var(--accent);
        text-shadow: 1px 1px 8px rgba(255, 255, 255, 0.5);
        font-family: "Press Start 2P", cursive;
      }
      .desc {
        font-size: 1.1rem;
        line-height: 1.6;
        max-width: 700px;
        margin: 0 auto;
        opacity: 0.9;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }
      .stall-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 2rem;
        max-width: 90%;
        margin: 2rem auto;
      }
      .stall-card {
        background: rgba(20, 20, 20, 0.909);
        border-radius: 10px;
        width: 550px;
        padding: 1rem;
        position: relative;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        backdrop-filter: blur(6px);
      }
      .stall-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      }
      .stall-header {
        display: flex;
        gap: 0.6rem;
        justify-content: center;
        align-items: center;
        font-size: 1.3rem;
        margin-bottom: 0.8rem;
        position: relative;
      }
      .stall-header::after {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        height: 2px;
        width: 40%;
        background: currentColor;
      }
      /* 攤位邊框 */
      .insert-stall {
        border: 2px solid var(--stall-insert);
        box-shadow: 0 0 12px var(--stall-insert);
      }
      .delete-stall {
        border: 2px solid var(--stall-delete);
        box-shadow: 0 0 12px var(--stall-delete);
      }
      .update-stall {
        border: 2px solid var(--stall-update);
        box-shadow: 0 0 12px var(--stall-update);
      }
      .select-stall {
        border: 2px solid var(--stall-select);
        box-shadow: 0 0 12px var(--stall-select);
      }
      .join-stall {
        border: 2px solid var(--stall-join);
        box-shadow: 0 0 12px var(--stall-join);
      }
      .groupby-stall {
        border: 2px solid var(--stall-groupby);
        box-shadow: 0 0 12px var(--stall-groupby);
      }
      .distinct-stall {
        border: 2px solid var(--stall-distinct);
        box-shadow: 0 0 12px var(--stall-distinct);
      }
      .index-stall {
        border: 2px solid var(--stall-index);
        box-shadow: 0 0 12px var(--stall-index);
      }
      .transaction-stall {
        border: 2px solid var(--stall-transaction);
        box-shadow: 0 0 12px var(--stall-transaction);
      }
      .product-shelf {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(4px);
      }
      .shelf-title {
        text-align: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      .product-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        justify-content: center;
      }
      .product-item {
        width: 100px;
        background: rgba(0, 0, 0, 0.421);
        border-radius: 6px;
        text-align: center;
        padding: 0.6rem;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s ease, opacity 0.3s ease;
        backdrop-filter: blur(4px);
      }
      .product-item:hover {
        transform: scale(1.05);
      }
      .icon-box {
        font-size: 1.4rem;
        margin-bottom: 0.3rem;
      }
      .product-name {
        font-weight: bold;
        font-size: 0.9rem;
      }
      .product-price {
        font-size: 0.8rem;
        opacity: 0.8;
      }
      .dialogue {
        background: var(--dark-overlay);
        border-radius: 8px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        font-size: 0.9rem;
        overflow: auto;
        max-height: 150px;
        backdrop-filter: blur(4px);
      }
      .dialog-line {
        margin-bottom: 0.4rem;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .speaker {
        font-weight: bold;
        color: var(--accent);
        margin-right: 0.3rem;
      }
      .stall-buttons {
        margin-bottom: 0.8rem;
      }
      .stall-btn {
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: 6px;
        padding: 0.6rem 0.9rem;
        font-size: 0.85rem;
        font-weight: bold;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .stall-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
      }
      .inline-sql-box {
        background: #2e2e3e;
        margin: 0.5rem 0;
        border-radius: 6px;
        padding: 0.6rem;
        font-size: 0.85rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        position: relative;
        white-space: pre-wrap;
      }
      .inline-sql-box pre {
        max-height: 200px;
        overflow-y: auto;
      }
      .inline-sql-title {
        font-weight: bold;
        margin-bottom: 0.3rem;
      }
      .inline-sql-copy {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        font-size: 0.7rem;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
      }
      .inline-sql-copy:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
      }
      .modal-overlay.show {
        display: flex;
      }
      .modal-content {
        background: #1e1e2e;
        color: #f8f8f2;
        padding: 1rem;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.5);
      }
      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border: none;
        font-size: 0.9rem;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
      }
      .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      .modal-title {
        font-weight: bold;
        margin-bottom: 0.6rem;
        font-size: 1rem;
      }
      .modal-pre {
        background: #2e2e3e;
        border-radius: 6px;
        padding: 0.8rem;
        margin-bottom: 1rem;
        font-size: 0.85rem;
        position: relative;
        white-space: pre-wrap;
      }
      .modal-pre pre {
        max-height: 200px;
        overflow-y: auto;
      }
      .modal-pre .copy-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        font-size: 0.7rem;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
      }
      .modal-pre .copy-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 9999;
      }
      .toast {
        background: var(--toast-bg);
        color: #fff;
        padding: 0.8rem 1rem;
        border-radius: 6px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
        animation: slideInToast 0.5s ease;
      }
      @keyframes slideInToast {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 0.9;
        }
      }
      .toast.fade-out {
        animation: slideOutToast 0.5s ease forwards;
      }
      @keyframes slideOutToast {
        from {
          transform: translateY(0);
          opacity: 0.9;
        }
        to {
          transform: translateY(-100%);
          opacity: 0;
        }
      }
      /* 自訂動畫效果 */
      @keyframes bounceIn {
        0% {
          transform: scale(0);
          opacity: 0;
        }
        60% {
          transform: scale(1.1);
          opacity: 1;
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
          transform: scale(0.8);
        }
      }
      @keyframes flash {
        0%,
        100% {
          background: rgba(0, 0, 0, 0.421);
        }
        50% {
          background: rgba(255, 215, 0, 0.5);
        }
      }
      @keyframes highlight {
        0% {
          box-shadow: 0 0 10px var(--accent);
        }
        50% {
          box-shadow: 0 0 20px var(--accent);
        }
        100% {
          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        }
      }
      @media (max-width: 768px) {
        .stall-card {
          width: 95%;
        }
      }
    </style>
  </head>
  <body>
    <audio id="clickSound" src="click.mp3" preload="auto"></audio>
    <audio id="successSound" src="success.mp3" preload="auto"></audio>
    <div class="toast-container" id="toastContainer"></div>
    <header role="banner">
      <h1 class="title">SQL 夜市大冒險</h1>
      <p class="desc">
        小狼與小兔走進熱鬧夜市，現場模擬
        INSERT、DELETE、UPDATE、SELECT、JOIN、GROUP BY、DISTINCT/UNION、INDEX 與
        Transaction 各式 SQL 魔法操作，並以 PHP 範例完整呈現！點擊按鈕即可看到
        SQL 語法與 PHP
        實例，還有下載功能，讓你親身體驗如何打造正確的網站程式～<br />
        <span id="operationCount">已執行操作：0 次</span>
      </p>
    </header>
    <main class="stall-container" id="stallArea" role="main"></main>
    <div class="modal-overlay" id="modalOverlay">
      <div
        class="modal-content"
        id="modalContent"
        role="dialog"
        aria-modal="true"
      >
        <button class="modal-close" id="modalClose" aria-label="關閉">
          關閉
        </button>
        <h3 class="modal-title" id="modalTitle"></h3>
      </div>
    </div>
    <script>
      // 全域變數與音效
      let operationCount = 0;
      const operationCountEl = document.getElementById("operationCount");
      const clickSound = document.getElementById("clickSound");
      const successSound = document.getElementById("successSound");

      // 建立各攤販的 PHP 完整範例對應，靠北，這才不會混一塊兒，爽啦～😈
      const phpCompleteExamples = {
        insert: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 單筆進貨
$sql = "INSERT INTO inventory (item_name, price, stock, category) VALUES ('雞排', 70, 20, '主食')";
if(mysqli_query($conn, $sql)){
    echo "新增成功！客人肯定愛上這口味～";
} else {
    echo "新增失敗：" . mysqli_error($conn);
}
// 批量進貨
$sql = "INSERT INTO inventory (item_name, price, stock, category) VALUES ('珍珠奶茶', 50, 30, '飲料'), ('滷蛋', 10, 50, '小吃')";
if(mysqli_query($conn, $sql)){
    echo "批量新增成功！夜市人氣飆升～";
} else {
    echo "批量新增失敗：" . mysqli_error($conn);
}
// 結束連線
mysqli_close($conn);
?>`,
        delete: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 刪除低庫存商品
$sql = "DELETE FROM inventory WHERE stock < 10";
if(mysqli_query($conn, $sql)){
    echo "低庫存商品已清除！";
} else {
    echo "刪除失敗：" . mysqli_error($conn);
}
// 刪除小吃類商品
$sql = "DELETE FROM inventory WHERE category = '小吃'";
if(mysqli_query($conn, $sql)){
    echo "小吃類商品已下架！";
} else {
    echo "刪除失敗：" . mysqli_error($conn);
}
// 結束連線
mysqli_close($conn);
?>`,
        update: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 更新飲料價格
$sql = "UPDATE inventory SET price = price + 5 WHERE category = '飲料'";
if(mysqli_query($conn, $sql)){
    echo "飲料價格調整成功！";
} else {
    echo "更新失敗：" . mysqli_error($conn);
}
// 更新雞排庫存
$sql = "UPDATE inventory SET stock = stock - 5 WHERE item_name = '雞排'";
if(mysqli_query($conn, $sql)){
    echo "雞排庫存更新成功！";
} else {
    echo "更新失敗：" . mysqli_error($conn);
}
// 結束連線
mysqli_close($conn);
?>`,
        select: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 查全部商品
$sql = "SELECT * FROM inventory";
$result = mysqli_query($conn, $sql);
echo "全部商品：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . " - " . $row['price'] . "元, 庫存：" . $row['stock'] . "<br>";
}
// 查主食
$sql = "SELECT * FROM inventory WHERE category = '主食'";
$result = mysqli_query($conn, $sql);
echo "<br>主食：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . " - " . $row['price'] . "元, 庫存：" . $row['stock'] . "<br>";
}
// 查便宜貨
$sql = "SELECT item_name, price FROM inventory WHERE price < 50 ORDER BY price ASC";
$result = mysqli_query($conn, $sql);
echo "<br>便宜貨：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['price'] . "元<br>";
}
// 查高庫存
$sql = "SELECT item_name, stock FROM inventory WHERE stock > (SELECT AVG(stock) FROM inventory)";
$result = mysqli_query($conn, $sql);
echo "<br>高庫存：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['stock'] . "份<br>";
}
// 查熱門商品
$sql = "SELECT item_name, price FROM inventory ORDER BY price DESC";
$result = mysqli_query($conn, $sql);
echo "<br>熱門商品：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['price'] . "元<br>";
}
// 結束連線
mysqli_close($conn);
?>`,
        join: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 查今日銷售
$sql = "SELECT i.item_name, s.quantity FROM inventory i INNER JOIN sales s ON i.id = s.item_id WHERE s.sale_date = CURDATE()";
$result = mysqli_query($conn, $sql);
echo "今日銷售：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['quantity'] . "份<br>";
}
// 查顧客訂單
$sql = "SELECT i.item_name, c.name, s.quantity FROM inventory i JOIN sales s ON i.id = s.item_id JOIN customers c ON s.customer_id = c.id";
$result = mysqli_query($conn, $sql);
echo "<br>顧客訂單：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . " - " . $row['name'] . ": " . $row['quantity'] . "份<br>";
}
// 結束連線
mysqli_close($conn);
?>`,
        groupby: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 統計銷售額
$sql = "SELECT category, SUM(price * stock) AS total_value FROM inventory GROUP BY category HAVING total_value > 1000";
$result = mysqli_query($conn, $sql);
echo "銷售額統計：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['category'] . ": " . $row['total_value'] . "元<br>";
}
// 價格排名
$sql = "SELECT item_name, price, RANK() OVER (PARTITION BY category ORDER BY price DESC) AS rank FROM inventory";
$result = mysqli_query($conn, $sql);
echo "<br>價格排名：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['price'] . "元, 排名: " . $row['rank'] . "<br>";
}
// 結束連線
mysqli_close($conn);
?>`,
        distinct: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 去重類別
$sql = "SELECT DISTINCT category FROM inventory";
$result = mysqli_query($conn, $sql);
echo "獨特類別：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['category'] . "<br>";
}
// 合併查詢
$sql = "SELECT item_name FROM inventory WHERE stock > 0 UNION SELECT item_name FROM sold_items WHERE quantity > 0";
$result = mysqli_query($conn, $sql);
echo "<br>合併查詢：<br>";
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . "<br>";
}
// 結束連線
mysqli_close($conn);
?>`,
        index: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 建立索引
$sql = "CREATE INDEX idx_category ON inventory (category)";
if(mysqli_query($conn, $sql)){
    echo "索引建立成功，查詢速度飛快！";
} else {
    echo "索引建立失敗：" . mysqli_error($conn);
}
// 移除索引
$sql = "DROP INDEX idx_category ON inventory";
if(mysqli_query($conn, $sql)){
    echo "索引移除成功，查詢速度回復正常！";
} else {
    echo "索引移除失敗：" . mysqli_error($conn);
}
// 結束連線
mysqli_close($conn);
?>`,
        transaction: `<?php
// 連線資料庫 (db_connect.php)
$conn = mysqli_connect("localhost", "root", "", "night_market");
if(!$conn){
    die("連線失敗：" . mysqli_connect_error());
}
// 結帳操作：交易提交
mysqli_begin_transaction($conn);
try {
    mysqli_query($conn, "INSERT INTO sales (item_id, customer_id, quantity) VALUES (1, 1, 2)");
    mysqli_query($conn, "UPDATE inventory SET stock = stock - 2 WHERE id = 1");
    mysqli_commit($conn);
    echo "交易成功！結帳完成～";
} catch(Exception $e) {
    mysqli_rollback($conn);
    echo "交易失敗：" . $e->getMessage();
}
// 取消訂單：交易回滾
mysqli_begin_transaction($conn);
try {
    mysqli_query($conn, "UPDATE inventory SET stock = stock + 10 WHERE id = 2");
    throw new Exception("模擬錯誤");
    mysqli_commit($conn);
} catch(Exception $e) {
    mysqli_rollback($conn);
    echo "交易已回滾，請重新操作！";
}
// 結束連線
mysqli_close($conn);
?>`,
      };

      // 修改 getPhpFullExample 依攤販 id 回傳對應的 PHP 完整範例
      function getPhpFullExample(stallId) {
        return phpCompleteExamples[stallId] || "";
      }

      // SQL 與 PHP 範例片段（各功能的語法，換行排版）
      const codeSnippets = {
        insertSingle: {
          sql: "INSERT INTO inventory (item_name, price, stock, category) \nVALUES ('雞排', 70, 20, '主食');",
          php: `<?php
// 單筆進貨
$sql = "INSERT INTO inventory (item_name, price, stock, category) VALUES ('雞排', 70, 20, '主食')";
if(mysqli_query($conn, $sql)){
    echo "新增成功！客人肯定愛上這口味～";
} else {
    echo "新增失敗：" . mysqli_error($conn);
}
?>`,
        },
        insertBatch: {
          sql: "INSERT INTO inventory (item_name, price, stock, category) \nVALUES ('珍珠奶茶', 50, 30, '飲料'),\n('滷蛋', 10, 50, '小吃');",
          php: `<?php
// 批量進貨
$sql = "INSERT INTO inventory (item_name, price, stock, category) VALUES ('珍珠奶茶', 50, 30, '飲料'), ('滷蛋', 10, 50, '小吃')";
if(mysqli_query($conn, $sql)){
    echo "批量新增成功！夜市人氣飆升～";
} else {
    echo "批量新增失敗：" . mysqli_error($conn);
}
?>`,
        },
        deleteLowStock: {
          sql: "DELETE FROM inventory \nWHERE stock < 10;",
          php: `<?php
// 刪除低庫存商品 (僅刪除庫存 < 10 的)
$sql = "DELETE FROM inventory WHERE stock < 10";
if(mysqli_query($conn, $sql)){
    echo "低庫存商品已清除！";
} else {
    echo "刪除失敗：" . mysqli_error($conn);
}
?>`,
        },
        deleteCategory: {
          sql: "DELETE FROM inventory \nWHERE category = '小吃';",
          php: `<?php
// 刪除小吃類商品
$sql = "DELETE FROM inventory WHERE category = '小吃'";
if(mysqli_query($conn, $sql)){
    echo "小吃類商品已下架！";
} else {
    echo "刪除失敗：" . mysqli_error($conn);
}
?>`,
        },
        updatePrice: {
          sql: "UPDATE inventory \nSET price = price + 5 \nWHERE category = '飲料';",
          php: `<?php
// 更新飲料價格
$sql = "UPDATE inventory SET price = price + 5 WHERE category = '飲料'";
if(mysqli_query($conn, $sql)){
    echo "飲料價格調整成功！";
} else {
    echo "更新失敗：" . mysqli_error($conn);
}
?>`,
        },
        updateStock: {
          sql: "UPDATE inventory \nSET stock = stock - 5 \nWHERE item_name = '雞排';",
          php: `<?php
// 更新雞排庫存
$sql = "UPDATE inventory SET stock = stock - 5 WHERE item_name = '雞排'";
if(mysqli_query($conn, $sql)){
    echo "雞排庫存更新成功！";
} else {
    echo "更新失敗：" . mysqli_error($conn);
}
?>`,
        },
        selectCheap: {
          sql: "SELECT item_name, price \nFROM inventory \nWHERE price < 50 \nORDER BY price ASC;",
          php: `<?php
// 查詢便宜貨 (50元以下)
$sql = "SELECT item_name, price FROM inventory WHERE price < 50 ORDER BY price ASC";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['price'] . "元<br>";
}
?>`,
        },
        selectSubquery: {
          sql: "SELECT item_name, stock \nFROM inventory \nWHERE stock > (SELECT AVG(stock) FROM inventory);",
          php: `<?php
// 查詢高庫存商品
$sql = "SELECT item_name, stock FROM inventory WHERE stock > (SELECT AVG(stock) FROM inventory)";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['stock'] . "份<br>";
}
?>`,
        },
        selectPopular: {
          sql: "SELECT item_name, price \nFROM inventory \nORDER BY price DESC;",
          php: `<?php
// 查詢熱門商品（依價格排序）
$sql = "SELECT item_name, price FROM inventory ORDER BY price DESC";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['price'] . "元<br>";
}
?>`,
        },
        selectAll: {
          sql: "SELECT * \nFROM inventory;",
          php: `<?php
// 查詢全部商品（最基礎查詢）
$sql = "SELECT * FROM inventory";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . " - " . $row['price'] . "元, 庫存：" . $row['stock'] . "<br>";
}
?>`,
        },
        selectMain: {
          sql: "SELECT * FROM inventory WHERE category = '主食';",
          php: `<?php
// 查詢主食類商品
$sql = "SELECT * FROM inventory WHERE category = '主食'";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . " - " . $row['price'] . "元, 庫存：" . $row['stock'] . "<br>";
}
?>`,
        },
        joinSales: {
          sql: "SELECT i.item_name, s.quantity \nFROM inventory i \nINNER JOIN sales s ON i.id = s.item_id \nWHERE s.sale_date = CURDATE();",
          php: `<?php
// 查詢今日銷售
$sql = "SELECT i.item_name, s.quantity FROM inventory i INNER JOIN sales s ON i.id = s.item_id WHERE s.sale_date = CURDATE()";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['quantity'] . "份<br>";
}
?>`,
        },
        joinMulti: {
          sql: "SELECT i.item_name, c.name AS customer, s.quantity \nFROM inventory i \nJOIN sales s ON i.id = s.item_id \nJOIN customers c ON s.customer_id = c.id;",
          php: `<?php
// 查詢顧客訂單
$sql = "SELECT i.item_name, c.name, s.quantity FROM inventory i JOIN sales s ON i.id = s.item_id JOIN customers c ON s.customer_id = c.id";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . " - " . $row['name'] . ": " . $row['quantity'] . "份<br>";
}
?>`,
        },
        groupSales: {
          sql: "SELECT category, SUM(price * stock) AS total_value \nFROM inventory \nGROUP BY category \nHAVING total_value > 1000;",
          php: `<?php
// 統計銷售額
$sql = "SELECT category, SUM(price * stock) AS total_value FROM inventory GROUP BY category HAVING total_value > 1000";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['category'] . ": " . $row['total_value'] . "元<br>";
}
?>`,
        },
        groupRank: {
          sql: "SELECT item_name, price, RANK() OVER (PARTITION BY category ORDER BY price DESC) AS rank \nFROM inventory;",
          php: `<?php
// 價格排名
$sql = "SELECT item_name, price, RANK() OVER (PARTITION BY category ORDER BY price DESC) AS rank FROM inventory";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . ": " . $row['price'] . "元, 排名: " . $row['rank'] . "<br>";
}
?>`,
        },
        distinctCategories: {
          sql: "SELECT DISTINCT category \nFROM inventory;",
          php: `<?php
// 去重類別
$sql = "SELECT DISTINCT category FROM inventory";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['category'] . "<br>";
}
?>`,
        },
        unionItems: {
          sql: "SELECT item_name \nFROM inventory \nWHERE stock > 0 \nUNION \nSELECT item_name \nFROM sold_items \nWHERE quantity > 0;",
          php: `<?php
// 合併查詢
$sql = "SELECT item_name FROM inventory WHERE stock > 0 UNION SELECT item_name FROM sold_items WHERE quantity > 0";
$result = mysqli_query($conn, $sql);
while($row = mysqli_fetch_assoc($result)){
    echo $row['item_name'] . "<br>";
}
?>`,
        },
        indexCreate: {
          sql: "CREATE INDEX idx_category \nON inventory (category);",
          php: `<?php
// 建立索引
$sql = "CREATE INDEX idx_category ON inventory (category)";
if(mysqli_query($conn, $sql)){
    echo "索引建立成功，查詢速度飛快！";
} else {
    echo "索引建立失敗：" . mysqli_error($conn);
}
?>`,
        },
        indexDrop: {
          sql: "DROP INDEX idx_category \nON inventory;",
          php: `<?php
// 移除索引
$sql = "DROP INDEX idx_category ON inventory";
if(mysqli_query($conn, $sql)){
    echo "索引移除成功，查詢速度回復正常！";
} else {
    echo "索引移除失敗：" . mysqli_error($conn);
}
?>`,
        },
        transactionSale: {
          sql: "START TRANSACTION;\nINSERT INTO sales (item_id, customer_id, quantity) VALUES (1, 1, 2);\nUPDATE inventory SET stock = stock - 2 WHERE id = 1;\nCOMMIT;",
          php: `<?php
// 交易提交
mysqli_begin_transaction($conn);
try {
    mysqli_query($conn, "INSERT INTO sales (item_id, customer_id, quantity) VALUES (1, 1, 2)");
    mysqli_query($conn, "UPDATE inventory SET stock = stock - 2 WHERE id = 1");
    mysqli_commit($conn);
    echo "交易成功！結帳完成～";
} catch(Exception $e) {
    mysqli_rollback($conn);
    echo "交易失敗：" . $e->getMessage();
}
?>`,
        },
        transactionRollback: {
          sql: "START TRANSACTION;\nUPDATE inventory SET stock = stock + 10 WHERE id = 2;\nROLLBACK;",
          php: `<?php
// 交易回滾
mysqli_begin_transaction($conn);
try {
    mysqli_query($conn, "UPDATE inventory SET stock = stock + 10 WHERE id = 2");
    throw new Exception("模擬錯誤");
    mysqli_commit($conn);
} catch(Exception $e) {
    mysqli_rollback($conn);
    echo "交易已回滾，請重新操作！";
}
?>`,
        },
      };

      // 根據攤販 id 回傳對應的 PHP 完整範例及 SQL 秘方
      function getSecretCodeBlocks(stallId, stallSecretSQL) {
        const blocks = [
          {
            codeType: "SQL 建立與範例資料 (db_setup.sql)",
            content:
              "CREATE DATABASE night_market;\nUSE night_market;\n" +
              stallSecretSQL,
          },
          {
            codeType: "PHP 完整範例 (store_example.php)",
            content: getPhpFullExample(stallId),
          },
        ];
        return blocks;
      }

      // 顯示模態窗，並在模態窗中加入「下載 PHP 完整範例」按鈕
      function showModal(title, codeBlocks) {
        modalOverlay.classList.add("show");
        modalContent.querySelector("#modalTitle").textContent = title;
        modalContent
          .querySelectorAll(".modal-pre, #downloadPhpBtn")
          .forEach((el) => el.remove());
        codeBlocks.forEach((block) => {
          const preDiv = document.createElement("div");
          preDiv.className = "modal-pre";
          const copyBtn = document.createElement("button");
          copyBtn.className = "copy-btn";
          copyBtn.textContent = "複製";
          copyBtn.addEventListener("click", () =>
            copyCode(copyBtn, block.content)
          );
          const codeTitle = document.createElement("div");
          codeTitle.style.fontWeight = "bold";
          codeTitle.style.marginBottom = "0.5rem";
          codeTitle.textContent = block.codeType;
          const textPre = document.createElement("pre");
          textPre.innerHTML = escapeHTML(block.content);
          preDiv.appendChild(copyBtn);
          preDiv.appendChild(codeTitle);
          preDiv.appendChild(textPre);
          modalContent.appendChild(preDiv);
        });
        // 加入下載 PHP 完整範例按鈕，使用對應攤販的 PHP 程式碼
        const downloadBtn = document.createElement("button");
        downloadBtn.id = "downloadPhpBtn";
        downloadBtn.className = "stall-btn";
        downloadBtn.textContent = "下載 PHP 完整範例";
        downloadBtn.addEventListener("click", () => {
          const element = document.createElement("a");
          element.setAttribute(
            "href",
            "data:text/plain;charset=utf-8," +
              encodeURIComponent(codeBlocks[1].content)
          );
          element.setAttribute("download", "store_example.php");
          element.style.display = "none";
          document.body.appendChild(element);
          element.click();
          document.body.removeChild(element);
        });
        modalContent.appendChild(downloadBtn);
      }

      // 修改 showInlineSQL，使用傳入的 phpText 而非全局範例
      function showInlineSQL(stallObj, sqlText, phpText) {
        const container = document.getElementById(
          `${stallObj.id}-inline-sql-container`
        );
        container.innerHTML = "";
        const blocks = [
          { title: "SQL 建立與範例資料", code: sqlText },
          { title: "PHP 完整範例", code: phpText },
        ];
        blocks.forEach((block) => {
          const div = document.createElement("div");
          div.className = "inline-sql-box";
          const copyBtn = document.createElement("button");
          copyBtn.className = "inline-sql-copy";
          copyBtn.textContent = "複製";
          copyBtn.addEventListener("click", () =>
            copyCode(copyBtn, block.code)
          );
          const titleEl = document.createElement("div");
          titleEl.className = "inline-sql-title";
          titleEl.textContent = block.title;
          const pre = document.createElement("pre");
          pre.innerHTML = escapeHTML(block.code);
          div.appendChild(copyBtn);
          div.appendChild(titleEl);
          div.appendChild(pre);
          container.appendChild(div);
        });
      }

      function copyCode(btn, text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            btn.textContent = "已複製";
            setTimeout(() => (btn.textContent = "複製"), 1500);
          })
          .catch(() => showToast(null, "複製失敗"));
      }

      const modalOverlay = document.getElementById("modalOverlay");
      const modalContent = document.getElementById("modalContent");
      const modalClose = document.getElementById("modalClose");
      modalClose.addEventListener("click", () =>
        modalOverlay.classList.remove("show")
      );
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) modalOverlay.classList.remove("show");
      });

      function escapeHTML(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, (m) => map[m]);
      }

      const stallsData = [
        {
          id: "insert",
          className: "insert-stall",
          icon: "fa-solid fa-plus",
          title: "進貨補給站 (INSERT)",
          productShelfTitle: "庫存商品",
          dialogues: [
            {
              speaker: "進貨老闆",
              text: "小狼、小兔，夜市開張啦，趕快進貨讓顧客滿意！",
            },
            { speaker: "小兔", text: "收到！雞排與奶茶，人氣保證賣翻天～" },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞排",
              price: 70,
              stock: 20,
              category: "主食",
            },
            {
              id: 2,
              icon: "fa-solid fa-mug-hot",
              name: "珍珠奶茶",
              price: 50,
              stock: 30,
              category: "飲料",
            },
          ],
          operationButtons: [
            {
              label: "單筆進貨",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "雞排再補一波，讓貨架更豐富！",
                });
                const newItem = {
                  id: stallObj.products.length + 1,
                  icon: "fa-solid fa-drumstick-bite",
                  name: "雞排",
                  price: 70,
                  stock: 20,
                  category: "主食",
                };
                stallObj.products.push(newItem);
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts("animate__animated animate__bounceIn");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.insertSingle.sql,
                  codeSnippets.insertSingle.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "批量進貨",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "進貨老闆",
                  text: "一次進兩樣，奶茶與滷蛋上架！",
                });
                const newItems = [
                  {
                    id: stallObj.products.length + 1,
                    icon: "fa-solid fa-mug-hot",
                    name: "珍珠奶茶",
                    price: 50,
                    stock: 30,
                    category: "飲料",
                  },
                  {
                    id: stallObj.products.length + 2,
                    icon: "fa-solid fa-egg",
                    name: "滷蛋",
                    price: 10,
                    stock: 50,
                    category: "小吃",
                  },
                ];
                stallObj.products.push(...newItems);
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts("animate__animated animate__bounceIn");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.insertBatch.sql,
                  codeSnippets.insertBatch.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  price INT,\n  stock INT,\n  category VARCHAR(50)\n);\nINSERT INTO inventory (item_name, price, stock, category) VALUES ('雞排', 70, 20, '主食'), ('珍珠奶茶', 50, 30, '飲料');",
        },
        {
          id: "delete",
          className: "delete-stall",
          icon: "fa-solid fa-trash",
          title: "庫存清理站 (DELETE)",
          productShelfTitle: "待清商品",
          dialogues: [
            {
              speaker: "清理老闆",
              text: "小狼，庫存堆積如山，得先清除沒人氣的貨品！",
            },
            { speaker: "小狼", text: "放心，低庫存（<10）與小吃類全部下架！" },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞翅",
              price: 40,
              stock: 5,
              category: "主食",
            },
            {
              id: 2,
              icon: "fa-solid fa-egg",
              name: "滷蛋",
              price: 10,
              stock: 10,
              category: "小吃",
            },
            {
              id: 3,
              icon: "fa-solid fa-mug-hot",
              name: "綠茶",
              price: 30,
              stock: 20,
              category: "飲料",
            },
            {
              id: 4,
              icon: "fa-solid fa-mug-hot",
              name: "紅茶",
              price: 30,
              stock: 3,
              category: "飲料",
            },
          ],
          operationButtons: [
            {
              label: "刪除低庫存",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "只刪除庫存低於10的商品～",
                });
                stallObj.products = stallObj.products.filter(
                  (p) => p.stock >= 10
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.deleteLowStock.sql,
                  codeSnippets.deleteLowStock.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "刪除小吃類",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "清理老闆",
                  text: "移除所有小吃類商品～",
                });
                stallObj.products = stallObj.products.filter(
                  (p) => p.category !== "小吃"
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts();
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.deleteCategory.sql,
                  codeSnippets.deleteCategory.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  price INT,\n  stock INT,\n  category VARCHAR(50)\n);\nINSERT INTO inventory (item_name, price, stock, category) VALUES ('雞翅', 40, 5, '主食'), ('滷蛋', 10, 10, '小吃'), ('綠茶', 30, 20, '飲料'), ('紅茶', 30, 3, '飲料');",
        },
        {
          id: "update",
          className: "update-stall",
          icon: "fa-solid fa-pen",
          title: "價格調整站 (UPDATE)",
          productShelfTitle: "商品價格",
          dialogues: [
            {
              speaker: "價格老闆",
              text: "小兔，飲料成本上漲了，必須調整價格；雞排銷售火熱，庫存也要更新！",
            },
            { speaker: "小兔", text: "馬上調整，讓價格與庫存更貼近現實～" },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-mug-hot",
              name: "珍珠奶茶",
              price: 50,
              stock: 30,
              category: "飲料",
            },
            {
              id: 2,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞排",
              price: 70,
              stock: 20,
              category: "主食",
            },
          ],
          operationButtons: [
            {
              label: "更新飲料價格",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "飲料每樣漲5元，調整成功！",
                });
                stallObj.products = stallObj.products.map((p) =>
                  p.category === "飲料" ? { ...p, price: p.price + 5 } : p
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts("animate__animated animate__flash");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.updatePrice.sql,
                  codeSnippets.updatePrice.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "更新雞排庫存",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "雞排賣出5份，庫存更新成功！",
                });
                stallObj.products = stallObj.products.map((p) =>
                  p.name === "雞排" ? { ...p, stock: p.stock - 5 } : p
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts("animate__animated animate__flash");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.updateStock.sql,
                  codeSnippets.updateStock.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  price INT,\n  stock INT,\n  category VARCHAR(50)\n);\nINSERT INTO inventory (item_name, price, stock, category) VALUES ('珍珠奶茶', 50, 30, '飲料'), ('雞排', 70, 20, '主食');",
        },
        {
          id: "select",
          className: "select-stall",
          icon: "fa-solid fa-search",
          title: "顧客查詢站 (SELECT)",
          productShelfTitle: "查詢美食",
          dialogues: [
            {
              speaker: "查詢老闆",
              text: "小狼，顧客想知道哪些商品物美價廉，先查便宜貨！",
            },
            { speaker: "小狼", text: "此外，還有高庫存、熱門及全部查詢喔！" },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞排",
              price: 70,
              stock: 20,
              category: "主食",
            },
            {
              id: 2,
              icon: "fa-solid fa-egg",
              name: "滷蛋",
              price: 10,
              stock: 50,
              category: "小吃",
            },
            {
              id: 3,
              icon: "fa-solid fa-mug-hot",
              name: "綠茶",
              price: 30,
              stock: 15,
              category: "飲料",
            },
          ],
          operationButtons: [
            {
              label: "查全部商品",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "全部商品查詢完成！",
                });
                stallObj.filtered = stallObj.products.slice();
                stallObj.renderProducts("animate__animated animate__bounceIn");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.selectAll.sql,
                  codeSnippets.selectAll.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "查主食",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "主食查詢完成！",
                });
                stallObj.filtered = stallObj.products.filter(
                  (p) => p.category === "主食"
                );
                stallObj.renderProducts("animate__animated animate__bounceIn");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.selectMain.sql,
                  codeSnippets.selectMain.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "查便宜貨",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "便宜貨（50元以下）查詢完成！",
                });
                stallObj.filtered = stallObj.products.filter(
                  (p) => p.price < 50
                );
                stallObj.renderProducts("animate__animated animate__highlight");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.selectCheap.sql,
                  codeSnippets.selectCheap.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "查高庫存",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "高庫存（超過平均）查詢完成！",
                });
                stallObj.filtered = stallObj.products.filter(
                  (p) =>
                    p.stock >
                    stallObj.products.reduce((sum, p) => sum + p.stock, 0) /
                      stallObj.products.length
                );
                stallObj.renderProducts("animate__animated animate__highlight");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.selectSubquery.sql,
                  codeSnippets.selectSubquery.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "查熱門商品",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "熱門商品依價格排序查詢完成！",
                });
                stallObj.filtered = stallObj.products
                  .slice()
                  .sort((a, b) => b.price - a.price);
                stallObj.renderProducts("animate__animated animate__highlight");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.selectPopular.sql,
                  codeSnippets.selectPopular.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  price INT,\n  stock INT,\n  category VARCHAR(50)\n);\nINSERT INTO inventory (item_name, price, stock, category) VALUES ('雞排', 70, 20, '主食'), ('滷蛋', 10, 50, '小吃'), ('綠茶', 30, 15, '飲料');",
        },
        {
          id: "join",
          className: "join-stall",
          icon: "fa-solid fa-link",
          title: "銷售關聯站 (JOIN)",
          productShelfTitle: "銷售紀錄",
          dialogues: [
            {
              speaker: "銷售老闆",
              text: "小兔，請查詢今日銷售數據，看看銷量如何！",
            },
            { speaker: "小兔", text: "今日銷售與顧客訂單數據馬上呈現～" },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞排",
              quantity: 5,
            },
            {
              id: 2,
              icon: "fa-solid fa-mug-hot",
              name: "珍珠奶茶",
              quantity: 10,
            },
          ],
          operationButtons: [
            {
              label: "查今日銷售",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "今日銷售數據查詢完成，銷售火熱！",
                });
                stallObj.filtered = stallObj.products.map((p) => ({
                  ...p,
                  name: p.name + " (今日)",
                }));
                stallObj.renderProducts("animate__animated animate__highlight");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.joinSales.sql,
                  codeSnippets.joinSales.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "查顧客訂單",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "銷售老闆",
                  text: "顧客訂單查詢完成，詳細資料如下～",
                });
                stallObj.filtered = [
                  {
                    id: 1,
                    icon: "fa-solid fa-drumstick-bite",
                    name: "雞排 - 阿明",
                    quantity: 5,
                  },
                  {
                    id: 2,
                    icon: "fa-solid fa-mug-hot",
                    name: "珍珠奶茶 - 小芳",
                    quantity: 10,
                  },
                ];
                stallObj.renderProducts("animate__animated animate__highlight");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.joinMulti.sql,
                  codeSnippets.joinMulti.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50)\n);\nCREATE TABLE customers (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  name VARCHAR(50)\n);\nCREATE TABLE sales (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_id INT,\n  customer_id INT,\n  quantity INT,\n  sale_date DATE,\n  FOREIGN KEY (item_id) REFERENCES inventory(id),\n  FOREIGN KEY (customer_id) REFERENCES customers(id)\n);\nINSERT INTO inventory (item_name) VALUES ('雞排'), ('珍珠奶茶');\nINSERT INTO customers (name) VALUES ('阿明'), ('小芳');\nINSERT INTO sales (item_id, customer_id, quantity, sale_date) VALUES (1, 1, 5, CURDATE()), (2, 2, 10, CURDATE());",
        },
        {
          id: "groupby",
          className: "groupby-stall",
          icon: "fa-solid fa-chart-bar",
          title: "統計分析站 (GROUP BY)",
          productShelfTitle: "銷售統計",
          dialogues: [
            { speaker: "統計老闆", text: "小狼，統計各類銷售額，讓數據說話！" },
            { speaker: "小狼", text: "統計數據來了，精彩數字呈現～" },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞排",
              price: 70,
              stock: 20,
              category: "主食",
            },
            {
              id: 2,
              icon: "fa-solid fa-mug-hot",
              name: "珍珠奶茶",
              price: 50,
              stock: 30,
              category: "飲料",
            },
            {
              id: 3,
              icon: "fa-solid fa-egg",
              name: "滷蛋",
              price: 10,
              stock: 50,
              category: "小吃",
            },
          ],
          operationButtons: [
            {
              label: "統計銷售額",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "銷售額超過1000元的類別如下～",
                });
                const salesByCategory = stallObj.products.reduce((acc, p) => {
                  acc[p.category] = (acc[p.category] || 0) + p.price * p.stock;
                  return acc;
                }, {});
                stallObj.filtered = Object.entries(salesByCategory)
                  .filter(([_, total]) => total > 1000)
                  .map(([cat, total]) => ({
                    id: cat,
                    icon: "fa-solid fa-chart-bar",
                    name: cat,
                    price: `${total} 元`,
                    stock: 0,
                    category: cat,
                  }));
                stallObj.renderProducts("animate__animated animate__highlight");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.groupSales.sql,
                  codeSnippets.groupSales.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "價格排名",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "各類商品依價格排名，數據如下～",
                });
                const ranked = stallObj.products
                  .map((p) => ({ ...p, name: p.name + " (排名)" }))
                  .sort((a, b) => b.price - a.price);
                stallObj.filtered = ranked;
                stallObj.renderProducts("animate__animated animate__highlight");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.groupRank.sql,
                  codeSnippets.groupRank.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  price INT,\n  stock INT,\n  category VARCHAR(50)\n);\nINSERT INTO inventory (item_name, price, stock, category) VALUES ('雞排', 70, 20, '主食'), ('珍珠奶茶', 50, 30, '飲料'), ('滷蛋', 10, 50, '小吃');",
        },
        {
          id: "distinct",
          className: "distinct-stall",
          icon: "fa-solid fa-filter",
          title: "類別篩選站 (DISTINCT/UNION)",
          productShelfTitle: "商品類別",
          dialogues: [
            {
              speaker: "篩選老闆",
              text: "小兔，市場上重複的品項太多，先去重類別！",
            },
            { speaker: "小兔", text: "獨特的類別馬上呈現，貨架乾淨整潔～" },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞排",
              price: 70,
              stock: 20,
              category: "主食",
            },
            {
              id: 2,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞翅",
              price: 40,
              stock: 5,
              category: "主食",
            },
            {
              id: 3,
              icon: "fa-solid fa-mug-hot",
              name: "珍珠奶茶",
              price: 50,
              stock: 30,
              category: "飲料",
            },
          ],
          operationButtons: [
            {
              label: "去重類別",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "獨特類別呈現，市場更清晰～",
                });
                const uniqueCategories = [
                  ...new Set(stallObj.products.map((p) => p.category)),
                ];
                stallObj.filtered = uniqueCategories.map((cat, i) => ({
                  id: i + 1,
                  icon: "fa-solid fa-box",
                  name: cat,
                  price: "-",
                  stock: "-",
                  category: cat,
                }));
                stallObj.renderProducts("animate__animated animate__highlight");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.distinctCategories.sql,
                  codeSnippets.distinctCategories.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "合併已售",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "篩選老闆",
                  text: "合併賣出資料，讓清單更完整～",
                });
                const soldItems = [
                  {
                    id: 4,
                    icon: "fa-solid fa-egg",
                    name: "滷蛋",
                    price: 10,
                    stock: 0,
                    category: "小吃",
                  },
                ];
                stallObj.filtered = [...stallObj.products, ...soldItems];
                stallObj.renderProducts("animate__animated animate__bounceIn");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.unionItems.sql,
                  codeSnippets.unionItems.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  price INT,\n  stock INT,\n  category VARCHAR(50)\n);\nCREATE TABLE sold_items (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  quantity INT\n);\nINSERT INTO inventory (item_name, price, stock, category) VALUES ('雞排', 70, 20, '主食'), ('雞翅', 40, 5, '主食'), ('珍珠奶茶', 50, 30, '飲料');\nINSERT INTO sold_items (item_name, quantity) VALUES ('滷蛋', 10);",
        },
        {
          id: "index",
          className: "index-stall",
          icon: "fa-solid fa-tachometer-alt",
          title: "快速查詢站 (INDEX)",
          productShelfTitle: "庫存查詢",
          dialogues: [
            { speaker: "查詢老闆", text: "小狼，查詢速度太慢，先來建立索引！" },
            { speaker: "小狼", text: "索引建立後，查詢快如閃電～" },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞排",
              price: 70,
              stock: 20,
              category: "主食",
            },
            {
              id: 2,
              icon: "fa-solid fa-mug-hot",
              name: "珍珠奶茶",
              price: 50,
              stock: 30,
              category: "飲料",
            },
          ],
          operationButtons: [
            {
              label: "建立索引",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "索引建立中，查詢速度馬上提速～",
                });
                stallObj.products.push({
                  id: 3,
                  icon: "fa-solid fa-bolt",
                  name: "索引啟用",
                  price: "-",
                  stock: "-",
                  category: "-",
                });
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts("animate__animated animate__bounceIn");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.indexCreate.sql,
                  codeSnippets.indexCreate.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "移除索引",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小狼",
                  text: "索引移除，查詢速度恢復正常～",
                });
                stallObj.products = stallObj.products.filter(
                  (p) => p.name !== "索引啟用"
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts("animate__animated animate__fadeOut");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.indexDrop.sql,
                  codeSnippets.indexDrop.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  price INT,\n  stock INT,\n  category VARCHAR(50)\n);\nINSERT INTO inventory (item_name, price, stock, category) VALUES ('雞排', 70, 20, '主食'), ('珍珠奶茶', 50, 30, '飲料');",
        },
        {
          id: "transaction",
          className: "transaction-stall",
          icon: "fa-solid fa-exchange-alt",
          title: "交易結帳站 (TRANSACTION)",
          productShelfTitle: "結帳紀錄",
          dialogues: [
            {
              speaker: "結帳老闆",
              text: "小兔，顧客結帳務必全額成功，請執行交易操作！",
            },
            {
              speaker: "小兔",
              text: "交易包裝完畢，成功就結帳，失敗則全數回滾～",
            },
          ],
          products: [
            {
              id: 1,
              icon: "fa-solid fa-drumstick-bite",
              name: "雞排",
              price: 70,
              stock: 20,
              status: "待結帳",
            },
          ],
          operationButtons: [
            {
              label: "結帳雞排",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "小兔",
                  text: "賣出2份雞排，結帳完成！",
                });
                stallObj.products = stallObj.products.map((p) =>
                  p.name === "雞排"
                    ? { ...p, stock: p.stock - 2, status: "已結帳" }
                    : p
                );
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts("animate__animated animate__flash");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.transactionSale.sql,
                  codeSnippets.transactionSale.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
            {
              label: "取消訂單",
              onClick: (stallObj) => {
                clickSound.play();
                addDialogue(stallObj, {
                  speaker: "結帳老闆",
                  text: "顧客反悔，訂單取消！",
                });
                stallObj.products = stallObj.products.map((p) => ({
                  ...p,
                  status: "已取消",
                }));
                stallObj.filtered = stallObj.products;
                stallObj.renderProducts("animate__animated animate__fadeOut");
                resetAutoRevert(stallObj);
                showInlineSQL(
                  stallObj,
                  codeSnippets.transactionRollback.sql,
                  codeSnippets.transactionRollback.php
                );
                incrementOperationCount();
                successSound.play();
              },
            },
          ],
          secretSQL:
            "CREATE TABLE customers (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  name VARCHAR(50),\n  balance INT\n);\nCREATE TABLE inventory (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_name VARCHAR(50),\n  price INT,\n  stock INT\n);\nCREATE TABLE sales (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  item_id INT,\n  customer_id INT,\n  quantity INT,\n  FOREIGN KEY (item_id) REFERENCES inventory(id),\n  FOREIGN KEY (customer_id) REFERENCES customers(id)\n);\nINSERT INTO customers (name, balance) VALUES ('阿明', 100);\nINSERT INTO inventory (item_name, price, stock) VALUES ('雞排', 70, 20);",
        },
      ];

      const stallArea = document.getElementById("stallArea");
      stallsData.forEach((stall) => {
        const stallCard = document.createElement("section");
        stallCard.className = `stall-card ${stall.className}`;
        stallCard.id = `${stall.id}-card`;
        stallCard.setAttribute("role", "region");
        stallCard.setAttribute("aria-label", stall.title);

        const headerDiv = document.createElement("div");
        headerDiv.className = "stall-header";
        headerDiv.innerHTML = `<i class="${stall.icon}" aria-hidden="true"></i> <span>${stall.title}</span>`;
        stallCard.appendChild(headerDiv);

        const shelf = document.createElement("div");
        shelf.className = "product-shelf";
        shelf.innerHTML = `<div class="shelf-title">${stall.productShelfTitle}</div>`;
        const productGrid = document.createElement("div");
        productGrid.className = "product-grid";

        stall.filtered = stall.products.slice();
        stall.original = stall.products.slice();

        stall.renderProducts = function (animation = "") {
          productGrid.innerHTML = "";
          this.filtered.forEach((item) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = `product-item ${animation}`;
            const displayText = item.status
              ? item.status
              : item.price !== undefined
              ? `${item.price} 元${
                  item.stock !== undefined
                    ? `, 庫存: ${item.stock}`
                    : item.quantity !== undefined
                    ? `, 數量: ${item.quantity}`
                    : ""
                }`
              : "";
            itemDiv.innerHTML = `
              <div class="icon-box"><i class="${item.icon}" aria-hidden="true"></i></div>
              <div class="product-name">${item.name}</div>
              <div class="product-price">${displayText}</div>
            `;
            itemDiv.setAttribute("aria-label", `${item.name} ${displayText}`);
            productGrid.appendChild(itemDiv);
          });
        };
        stall.renderProducts();
        shelf.appendChild(productGrid);
        stallCard.appendChild(shelf);

        const dialogueDiv = document.createElement("div");
        dialogueDiv.className = "dialogue";
        dialogueDiv.id = `${stall.id}-dialogue`;
        dialogueDiv.setAttribute("aria-live", "polite");
        let dHTML = "";
        stall.dialogues.forEach((d) => {
          dHTML += `<div class="dialog-line"><span class="speaker">${d.speaker}</span>：${d.text}</div>`;
        });
        dialogueDiv.innerHTML = dHTML;
        stallCard.appendChild(dialogueDiv);

        const btnContainer = document.createElement("div");
        btnContainer.className = "stall-buttons";
        stall.btnContainer = btnContainer;

        const secretBtn = document.createElement("button");
        secretBtn.className = "stall-btn";
        secretBtn.textContent = "查看秘方";
        secretBtn.addEventListener("click", () => {
          clickSound.play();
          const codeBlocks = getSecretCodeBlocks(stall.id, stall.secretSQL);
          showModal(stall.title + " - 秘方示範", codeBlocks);
        });
        btnContainer.appendChild(secretBtn);

        stall.operationButtons.forEach((op) => {
          const opBtn = document.createElement("button");
          opBtn.className = "stall-btn";
          opBtn.textContent = op.label;
          opBtn.addEventListener("click", () => {
            clickSound.play();
            op.onClick(stall);
          });
          btnContainer.appendChild(opBtn);
        });

        const revertBtn = document.createElement("button");
        revertBtn.className = "stall-btn";
        revertBtn.textContent = "復原攤販";
        revertBtn.addEventListener("click", () => revertStall(stall));
        btnContainer.appendChild(revertBtn);

        stallCard.appendChild(btnContainer);

        const timerDiv = document.createElement("div");
        timerDiv.className = "timer";
        timerDiv.id = `${stall.id}-timer`;
        timerDiv.textContent = "自動復原倒數：30 秒";
        stallCard.appendChild(timerDiv);

        const inlineSQLContainer = document.createElement("div");
        inlineSQLContainer.id = `${stall.id}-inline-sql-container`;
        stallCard.appendChild(inlineSQLContainer);

        stallArea.appendChild(stallCard);
      });

      function addDialogue(stallObj, { speaker, text }) {
        const dialogueEl = document.getElementById(`${stallObj.id}-dialogue`);
        const lineDiv = document.createElement("div");
        lineDiv.className = "dialog-line";
        lineDiv.innerHTML = `<span class="speaker">${speaker}</span>：${text}`;
        dialogueEl.appendChild(lineDiv);
        dialogueEl.scrollTop = dialogueEl.scrollHeight;
      }

      let revertTimers = {};
      let timerIntervals = {};
      function resetAutoRevert(stallObj) {
        const sid = stallObj.id;
        if (revertTimers[sid]) clearTimeout(revertTimers[sid]);
        if (timerIntervals[sid]) clearInterval(timerIntervals[sid]);
        let timeLeft = 30;
        const timerEl = document.getElementById(`${sid}-timer`);
        timerEl.textContent = `自動復原倒數：${timeLeft} 秒`;
        timerIntervals[sid] = setInterval(() => {
          timeLeft--;
          timerEl.textContent = `自動復原倒數：${timeLeft} 秒`;
          if (timeLeft <= 0) clearInterval(timerIntervals[sid]);
        }, 1000);
        revertTimers[sid] = setTimeout(() => revertStall(stallObj), 30000);
      }

      function revertStall(stallObj) {
        clickSound.play();
        stallObj.products = stallObj.original.slice();
        stallObj.filtered = stallObj.original.slice();
        stallObj.renderProducts();
        const dialogueEl = document.getElementById(`${stallObj.id}-dialogue`);
        dialogueEl.innerHTML = "";
        stallObj.dialogues.forEach((d) => {
          const lineDiv = document.createElement("div");
          lineDiv.className = "dialog-line";
          lineDiv.innerHTML = `<span class="speaker">${d.speaker}</span>：${d.text}`;
          dialogueEl.appendChild(lineDiv);
        });
        const container = document.getElementById(
          `${stallObj.id}-inline-sql-container`
        );
        container.innerHTML = "";
        showToast(stallObj, "攤販已復原，大家重新出發！");
        const sid = stallObj.id;
        if (timerIntervals[sid]) clearInterval(timerIntervals[sid]);
        document.getElementById(`${sid}-timer`).textContent =
          "自動復原倒數：30 秒";
      }

      function incrementOperationCount() {
        operationCount++;
        operationCountEl.textContent = `已執行操作：${operationCount} 次`;
      }

      const toastContainer = document.getElementById("toastContainer");
      function showToast(stallObj, message) {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = stallObj
          ? `[${stallObj.title}] ${message}`
          : `[系統] ${message}`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add("fade-out");
          setTimeout(() => toastContainer.removeChild(toast), 500);
        }, 2000);
      }
    </script>

    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>
    <script src="DinoRunner.js"></script>
  </body>
</html>
