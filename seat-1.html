<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºèƒ½åº§ä½è¡¨ç”Ÿæˆå™¨</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª‘</text></svg>"
    />
    <!-- å¼•å…¥XLSXå’ŒFileSaver.jsåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
      :root {
        --primary-color: #4a90e2;
        --secondary-color: #f39c12;
        --background-color: #f5f7fa;
        --text-color: #333;
        --border-color: #e0e0e0;
        --disabled-color: #ccc;
        --seat-height: 80px; /* èª¿æ•´åº§ä½é«˜åº¦ */
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
        background-color: #ffffff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
      }

      .header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .header input {
        padding: 8px;
        font-size: 16px;
        width: 200px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      .podium {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background-color: var(--secondary-color);
        color: white;
        font-weight: bold;
        border-radius: 4px;
      }

      .seating-chart-container {
        overflow-x: auto;
        outline: none; /* ç§»é™¤ç„¦é»é‚Šæ¡† */
      }

      .seating-chart {
        display: grid;
        gap: 2px;
        justify-content: center;
        margin-bottom: 20px;
        outline: none; /* ç§»é™¤ç„¦é»é‚Šæ¡† */
      }

      .seating-chart .label-row {
        display: contents;
      }

      .seating-chart .label-cell {
        background-color: #f0f0f0;
        text-align: center;
        font-weight: bold;
        padding: 10px;
        border: 1px solid var(--border-color);
        min-width: 60px;
      }

      .seating-chart .seat {
        width: 100%;
        height: var(--seat-height);
        padding: 5px;
        text-align: center;
        background-color: #fff;
        border: 1px solid var(--border-color);
        cursor: grab;
        user-select: none;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 14px;
        box-sizing: border-box;
        position: relative;
      }

      .seating-chart .seat:active {
        cursor: grabbing;
      }

      .seat:hover {
        background-color: #e0f7fa;
      }

      .seat.disabled {
        background-color: var(--disabled-color) !important;
        cursor: not-allowed !important;
      }

      .seat .seat-id,
      .seat .seat-name {
        flex: 1;
        padding: 2px 0;
        border: none;
        background: transparent;
        text-align: center;
        outline: none;
      }

      .seat .seat-id[contenteditable="true"],
      .seat .seat-name[contenteditable="true"] {
        border-bottom: 1px dashed #4a90e2;
      }

      .seat .disable-symbol {
        position: absolute;
        top: 5px;
        right: 5px;
        font-size: 16px;
        color: red;
        cursor: pointer;
        display: none;
      }

      .seat.disabled .disable-symbol {
        display: block;
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .button {
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-size: 16px;
        border-radius: 4px;
      }

      .button:hover {
        background-color: #3476c5;
      }

      #message {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        border-radius: 5px;
        display: none;
      }

      #message.success {
        background-color: #d4edda;
        color: #155724;
      }

      #message.error {
        background-color: #f8d7da;
        color: #721c24;
      }

      /* Modal Styles */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0, 0, 0, 0.5); /* Black w/ opacity */
      }

      .modal-content {
        background-color: #fefefe;
        margin: 10% auto; /* 10% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
        max-width: 500px;
        border-radius: 8px;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
      }

      .saved-list {
        list-style-type: none;
        padding: 0;
      }

      .saved-list li {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
      }

      .saved-list li:hover {
        background-color: #f0f0f0;
      }

      @media (max-width: 768px) {
        .seat {
          height: 60px;
          font-size: 12px;
        }

        .header input {
          width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>æ™ºèƒ½åº§ä½è¡¨ç”Ÿæˆå™¨</h1>

      <div class="header">
        <input type="text" id="className" placeholder="è«‹è¼¸å…¥ç­ç´šåç¨±" />
        <div>
          <label for="rows">æ’æ•¸ï¼š</label>
          <input type="number" id="rows" min="1" value="8" />
          <label for="columns">è¡Œæ•¸ï¼š</label>
          <input type="number" id="columns" min="1" value="10" />
        </div>
      </div>

      <div class="podium">è¬›å°</div>

      <div
        class="seating-chart-container"
        tabindex="0"
        id="seatingChartContainer"
      >
        <div class="seating-chart" id="seatingChart"></div>
      </div>

      <div class="button-group">
        <button class="button" onclick="randomlyArrangeSeats()">
          éš¨æ©Ÿæ’åº§
        </button>
        <button class="button" onclick="exportToExcel()">åŒ¯å‡º Excel</button>
        <button class="button" onclick="exportToWord()">åŒ¯å‡º Word</button>
        <button class="button" onclick="saveStudentList()">å„²å­˜å­¸ç”Ÿåå–®</button>
        <button class="button" onclick="openLoadModal()">è¼‰å…¥å­¸ç”Ÿåå–®</button>
      </div>

      <div id="message"></div>
    </div>

    <!-- Load Modal -->
    <div id="loadModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeLoadModal()">&times;</span>
        <h2>è¼‰å…¥å­¸ç”Ÿåå–®</h2>
        <ul class="saved-list" id="savedList"></ul>
      </div>
    </div>

    <script>
      let students = [];
      let disabledSeats = new Set();
      let rows = 8; // å°‡é è¨­æ’æ•¸æ”¹ç‚º8
      let columns = 10; // é è¨­è¡Œæ•¸ä¿æŒ10

      // å°‡æ•¸å­—è½‰ç‚ºåœ‹å­—
      function numberToChinese(number) {
        const mapping = [
          "ä¸€",
          "äºŒ",
          "ä¸‰",
          "å››",
          "äº”",
          "å…­",
          "ä¸ƒ",
          "å…«",
          "ä¹",
          "å",
          "åä¸€",
          "åäºŒ",
          "åä¸‰",
          "åå››",
          "åäº”",
          "åå…­",
          "åä¸ƒ",
          "åå…«",
          "åä¹",
          "äºŒå",
        ];
        return mapping[number - 1] || number;
      }

      // é¡¯ç¤ºè¨Šæ¯
      function showMessage(text, type) {
        const messageElement = document.getElementById("message");
        messageElement.textContent = text;
        messageElement.className = type;
        messageElement.style.display = "block";
        setTimeout(() => {
          messageElement.style.display = "none";
        }, 3000);
      }

      // ç”Ÿæˆåº§ä½è¡¨
      function generateSeatingChart() {
        const rowsInput = document.getElementById("rows");
        const columnsInput = document.getElementById("columns");

        rows = parseInt(rowsInput.value) || 8; // ä½¿ç”¨8ä½œç‚ºé è¨­å€¼
        columns = parseInt(columnsInput.value) || 10;

        const seatingChart = document.getElementById("seatingChart");
        seatingChart.innerHTML = "";
        seatingChart.style.gridTemplateColumns = `60px repeat(${columns}, 1fr)`; // èª¿æ•´ç¬¬ä¸€åˆ—ç‚ºæ¨™ç±¤åˆ—

        // æ·»åŠ ä¸Šæ–¹åˆ—æ¨™ç±¤ï¼ˆç¬¬å¹¾åˆ—ï¼‰
        const labelRow = document.createElement("div");
        labelRow.classList.add("label-row");

        // å·¦ä¸Šè§’ç©ºç™½
        const emptyLabel = document.createElement("div");
        emptyLabel.classList.add("label-cell");
        labelRow.appendChild(emptyLabel);

        for (let c = 1; c <= columns; c++) {
          const colLabel = document.createElement("div");
          colLabel.classList.add("label-cell");
          colLabel.textContent = numberToChinese(c);
          labelRow.appendChild(colLabel);
        }
        seatingChart.appendChild(labelRow);

        // æ·»åŠ åº§ä½å’Œè¡Œæ¨™ç±¤ï¼ˆç¬¬å¹¾æ’ï¼‰
        for (let r = 1; r <= rows; r++) {
          // è¡Œå®¹å™¨
          const rowDiv = document.createElement("div");
          rowDiv.classList.add("label-row");

          // è¡Œæ¨™ç±¤
          const rowLabel = document.createElement("div");
          rowLabel.classList.add("label-cell");
          rowLabel.textContent = numberToChinese(r);
          // å³éµç¦ç”¨æ•´æ’
          rowLabel.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            toggleRowDisabled(r);
          });
          rowDiv.appendChild(rowLabel);

          // åº§ä½
          for (let c = 1; c <= columns; c++) {
            const seat = document.createElement("div");
            seat.classList.add("seat");
            seat.dataset.row = r;
            seat.dataset.column = c;
            seat.dataset.index = (r - 1) * columns + c;

            // åˆå§‹é¡¯ç¤º
            seat.innerHTML = `
                      <div class="seat-id" contenteditable="true">åº§è™Ÿ</div>
                      <div class="seat-name" contenteditable="true">å§“å</div>
                      <div class="disable-symbol" onclick="toggleSeatDisabled(event)">âŒ</div>
                  `;
            rowDiv.appendChild(seat);

            // æ·»åŠ æ‹–æ›³äº‹ä»¶
            seat.setAttribute("draggable", "true");
            seat.addEventListener("dragstart", handleDragStart);
            seat.addEventListener("dragover", handleDragOver);
            seat.addEventListener("drop", handleDrop);
            seat.addEventListener("dragend", handleDragEnd);
          }

          seatingChart.appendChild(rowDiv);
        }

        // ä¸å†è‡ªå‹•åŠ è¼‰å·²ä¿å­˜çš„è³‡æ–™
        // å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ‰‹å‹•åŠ è¼‰ç‰¹å®šåå–®
      }

      // ç¦ç”¨æˆ–å•Ÿç”¨æ•´æ’åº§ä½
      function toggleRowDisabled(rowNumber) {
        for (let c = 1; c <= columns; c++) {
          const index = (rowNumber - 1) * columns + c;
          const seat = document.querySelector(`.seat[data-index='${index}']`);
          if (disabledSeats.has(index)) {
            disabledSeats.delete(index);
            seat.classList.remove("disabled");
          } else {
            disabledSeats.add(index);
            seat.classList.add("disabled");
            // æ¸…é™¤è©²åº§ä½çš„å­¸ç”Ÿ
            seat.querySelector(".seat-id").textContent = "åº§è™Ÿ";
            seat.querySelector(".seat-name").textContent = "å§“å";
            students = students.filter((student) => student.position != index);
          }
        }
        showMessage(
          `ç¬¬${numberToChinese(rowNumber)}æ’å·²${
            disabledSeats.has(rowNumber) ? "ç¦ç”¨" : "å•Ÿç”¨"
          }`,
          "success"
        );
      }

      // ç¦ç”¨æˆ–å•Ÿç”¨å–®ä¸€åº§ä½
      function toggleSeatDisabled(event) {
        event.stopPropagation();
        const seat = event.currentTarget.parentElement;
        const index = seat.dataset.index;
        if (disabledSeats.has(index)) {
          disabledSeats.delete(index);
          seat.classList.remove("disabled");
        } else {
          disabledSeats.add(index);
          seat.classList.add("disabled");
          // æ¸…é™¤è©²åº§ä½çš„å­¸ç”Ÿ
          seat.querySelector(".seat-id").textContent = "åº§è™Ÿ";
          seat.querySelector(".seat-name").textContent = "å§“å";
          students = students.filter((student) => student.position != index);
        }
        showMessage(
          `åº§ä½å·²${disabledSeats.has(index) ? "ç¦ç”¨" : "å•Ÿç”¨"}`,
          "success"
        );
      }

      // æ‹–æ›³äº¤æ›åº§ä½
      let draggedSeat = null;

      function handleDragStart(e) {
        if (this.classList.contains("disabled")) {
          e.preventDefault();
          return;
        }
        draggedSeat = this;
        e.dataTransfer.setData("text/plain", this.dataset.index);
        setTimeout(() => {
          this.classList.add("dragging");
        }, 0);
      }

      function handleDragOver(e) {
        e.preventDefault();
        if (this.classList.contains("disabled") || this === draggedSeat) return;
        this.classList.add("highlight");
      }

      function handleDrop(e) {
        e.preventDefault();
        this.classList.remove("highlight");
        const fromIndex = e.dataTransfer.getData("text/plain");
        const toIndex = this.dataset.index;

        if (fromIndex === toIndex) return;

        const fromSeat = document.querySelector(
          `.seat[data-index='${fromIndex}']`
        );
        const toSeat = document.querySelector(`.seat[data-index='${toIndex}']`);

        // äº¤æ›åº§ä½å…§å®¹
        const tempId = fromSeat.querySelector(".seat-id").textContent;
        const tempName = fromSeat.querySelector(".seat-name").textContent;

        fromSeat.querySelector(".seat-id").textContent =
          toSeat.querySelector(".seat-id").textContent;
        fromSeat.querySelector(".seat-name").textContent =
          toSeat.querySelector(".seat-name").textContent;

        toSeat.querySelector(".seat-id").textContent = tempId;
        toSeat.querySelector(".seat-name").textContent = tempName;

        // æ›´æ–°å­¸ç”Ÿä½ç½®
        updateStudentPosition(fromIndex, toIndex);

        // æ·»åŠ äº¤æ›å‹•ç•«
        fromSeat.classList.add("swapping");
        toSeat.classList.add("swapping");
        setTimeout(() => {
          fromSeat.classList.remove("swapping");
          toSeat.classList.remove("swapping");
        }, 500);

        showMessage("åº§ä½å·²äº¤æ›", "success");
      }

      function handleDragEnd(e) {
        this.classList.remove("dragging");
        document
          .querySelectorAll(".seat")
          .forEach((seat) => seat.classList.remove("highlight"));
      }

      // æ›´æ–°å­¸ç”Ÿåº§ä½ä½ç½®
      function updateStudentPosition(fromIndex, toIndex) {
        const fromStudent = students.find(
          (student) => student.position == fromIndex
        );
        const toStudent = students.find(
          (student) => student.position == toIndex
        );

        if (fromStudent) {
          fromStudent.position = toIndex;
        }

        if (toStudent) {
          toStudent.position = fromIndex;
        }
      }

      // éš¨æ©Ÿæ’åº§
      function randomlyArrangeSeats() {
        const seatingChart = document.getElementById("seatingChart");
        const seats = Array.from(seatingChart.querySelectorAll(".seat")).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) &&
            seat.querySelector(".seat-name").textContent !== "å§“å"
        );

        const availableSeats = seats.length;
        const shuffledStudents = [...students].filter(
          (student) => !disabledSeats.has(student.position)
        );

        // æ‰“äº‚å­¸ç”Ÿé †åº
        for (let i = shuffledStudents.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffledStudents[i], shuffledStudents[j]] = [
            shuffledStudents[j],
            shuffledStudents[i],
          ];
        }

        // æ¸…é™¤åº§ä½
        seats.forEach((seat) => {
          seat.querySelector(".seat-id").textContent = "åº§è™Ÿ";
          seat.querySelector(".seat-name").textContent = "å§“å";
        });

        // åˆ†é…åº§ä½
        shuffledStudents.forEach((student, index) => {
          if (index < availableSeats) {
            const seat = seats[index];
            seat.querySelector(".seat-id").textContent = student.id;
            seat.querySelector(".seat-name").textContent = student.name;
            student.position = seat.dataset.index;
          }
        });

        showMessage("åº§ä½å·²éš¨æ©Ÿæ’åˆ—", "success");
      }

      // åŒ¯å‡ºç‚º Excel
      function exportToExcel() {
        const className = document.getElementById("className").value || "ç­ç´š";
        const timestamp = getFormattedTimestamp();
        const seatingChart = document.getElementById("seatingChart");
        const seats = seatingChart.querySelectorAll(".seat");

        const data = [];

        // æ·»åŠ æ¨™é¡Œè¡Œ
        const headerRow = ["è¡Œ\\åˆ—"];
        for (let c = 1; c <= columns; c++) {
          headerRow.push(numberToChinese(c));
        }
        data.push(headerRow);

        // æ·»åŠ æ¯ä¸€æ’
        for (let r = 1; r <= rows; r++) {
          const row = [numberToChinese(r)];
          for (let c = 1; c <= columns; c++) {
            const index = (r - 1) * columns + c;
            const seat = seatingChart.querySelector(
              `.seat[data-index='${index}']`
            );
            if (seat) {
              const id = seat.querySelector(".seat-id").textContent;
              const name = seat.querySelector(".seat-name").textContent;
              row.push(`${id}\n${name}`);
            } else {
              row.push("");
            }
          }
          data.push(row);
        }

        const worksheet = XLSX.utils.aoa_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, `${className}åº§ä½è¡¨`);

        XLSX.writeFile(workbook, `${className}åº§ä½è¡¨_${timestamp}.xlsx`);
        showMessage("Excel æª”æ¡ˆå·²åŒ¯å‡º", "success");
      }

      // åŒ¯å‡ºç‚º Word
      function exportToWord() {
        const className = document.getElementById("className").value || "ç­ç´š";
        const timestamp = getFormattedTimestamp();
        const seatingChart = document.getElementById("seatingChart");
        const seats = seatingChart.querySelectorAll(".seat");

        let docContent = `<h1>${className}åº§ä½è¡¨</h1>`;
        docContent +=
          '<table border="1" style="border-collapse:collapse;width:100%;">';

        // æ·»åŠ æ¨™é¡Œè¡Œ
        docContent += "<tr><th>è¡Œ\\åˆ—</th>";
        for (let c = 1; c <= columns; c++) {
          docContent += `<th>${numberToChinese(c)}</th>`;
        }
        docContent += "</tr>";

        // æ·»åŠ æ¯ä¸€æ’
        for (let r = 1; r <= rows; r++) {
          docContent += `<tr><td>${numberToChinese(r)}</td>`;
          for (let c = 1; c <= columns; c++) {
            const index = (r - 1) * columns + c;
            const seat = seatingChart.querySelector(
              `.seat[data-index='${index}']`
            );
            if (seat) {
              const id = seat.querySelector(".seat-id").textContent;
              const name = seat.querySelector(".seat-name").textContent;
              docContent += `<td>${id}<br>${name}</td>`;
            } else {
              docContent += "<td></td>";
            }
          }
          docContent += "</tr>";
        }

        docContent += "</table>";

        const blob = new Blob(["\ufeff", docContent], {
          type: "application/msword",
        });
        saveAs(blob, `${className}åº§ä½è¡¨_${timestamp}.doc`);
        showMessage("Word æª”æ¡ˆå·²åŒ¯å‡º", "success");
      }

      // å„²å­˜å­¸ç”Ÿåå–®åˆ° LocalStorage
      function saveStudentList() {
        const className = document.getElementById("className").value || "ç­ç´š";
        const timestamp = getFormattedTimestamp();
        const listName = prompt(
          "è«‹è¼¸å…¥å­¸ç”Ÿåå–®åç¨±ï¼š",
          `${className}_${timestamp}`
        );
        if (!listName) {
          showMessage("æœªè¼¸å…¥åå–®åç¨±ï¼Œå–æ¶ˆä¿å­˜ã€‚", "error");
          return;
        }

        const data = {
          className: className,
          timestamp: timestamp,
          rows: rows,
          columns: columns,
          students: students,
          disabledSeats: Array.from(disabledSeats),
        };

        // ç²å–å·²ä¿å­˜çš„åå–®
        let savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];

        // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒåç¨±çš„åå–®
        if (savedLists.find((list) => list.listName === listName)) {
          if (!confirm("å·²å­˜åœ¨ç›¸åŒåç¨±çš„åå–®ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ")) {
            showMessage("å–æ¶ˆä¿å­˜ã€‚", "error");
            return;
          }
          // è¦†è“‹å·²æœ‰åå–®
          savedLists = savedLists.filter((list) => list.listName !== listName);
        }

        // æ·»åŠ æ–°çš„åå–®
        savedLists.push({ listName: listName, data: data });

        // å„²å­˜å› LocalStorage
        localStorage.setItem("seatChartSavedLists", JSON.stringify(savedLists));
        showMessage("å­¸ç”Ÿåå–®å·²ä¿å­˜", "success");
      }

      // æ‰“é–‹è¼‰å…¥æ¨¡æ…‹çª—å£
      function openLoadModal() {
        const modal = document.getElementById("loadModal");
        const savedListContainer = document.getElementById("savedList");
        savedListContainer.innerHTML = "";

        const savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];

        if (savedLists.length === 0) {
          savedListContainer.innerHTML = "<li>æ²’æœ‰å·²ä¿å­˜çš„å­¸ç”Ÿåå–®ã€‚</li>";
        } else {
          savedLists.forEach((list, index) => {
            const li = document.createElement("li");
            li.textContent = list.listName;
            li.onclick = () => {
              loadStudentListByName(list.listName);
              closeLoadModal();
            };
            savedListContainer.appendChild(li);
          });
        }

        modal.style.display = "block";
      }

      // é—œé–‰è¼‰å…¥æ¨¡æ…‹çª—å£
      function closeLoadModal() {
        const modal = document.getElementById("loadModal");
        modal.style.display = "none";
      }

      // é»æ“Šæ¨¡æ…‹çª—å£å¤–éƒ¨é—œé–‰
      window.onclick = function (event) {
        const modal = document.getElementById("loadModal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      // è¼‰å…¥ç‰¹å®šåç¨±çš„å­¸ç”Ÿåå–®
      function loadStudentListByName(listName) {
        const savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];
        const list = savedLists.find((item) => item.listName === listName);
        if (!list) {
          showMessage("æ‰¾ä¸åˆ°é¸å®šçš„å­¸ç”Ÿåå–®ã€‚", "error");
          return;
        }

        const data = list.data;
        document.getElementById("className").value = data.className || "";
        document.getElementById("rows").value = data.rows || 8;
        document.getElementById("columns").value = data.columns || 10;
        rows = data.rows || 8;
        columns = data.columns || 10;
        students = data.students || [];
        disabledSeats = new Set(data.disabledSeats || []);

        generateSeatingChart();

        // æ›´æ–°åº§ä½ç‹€æ…‹
        document.querySelectorAll(".seat").forEach((seat) => {
          const index = seat.dataset.index;
          if (disabledSeats.has(index)) {
            seat.classList.add("disabled");
            seat.querySelector(".seat-id").textContent = "åº§è™Ÿ";
            seat.querySelector(".seat-name").textContent = "å§“å";
          } else {
            seat.classList.remove("disabled");
          }
        });

        // åˆ†é…å­¸ç”Ÿ
        students.forEach((student) => {
          const seat = document.querySelector(
            `.seat[data-index='${student.position}']`
          );
          if (seat && !disabledSeats.has(student.position)) {
            seat.querySelector(".seat-id").textContent = student.id;
            seat.querySelector(".seat-name").textContent = student.name;
          }
        });

        showMessage(`å·²è¼‰å…¥å­¸ç”Ÿåå–®ï¼šã€Œ${listName}ã€`, "success");
      }

      // ä¸å†ä½¿ç”¨åŸæœ‰çš„è¼‰å…¥ JSON åŠŸèƒ½

      // ä¿å­˜åˆ° LocalStorage çš„åŠŸèƒ½å·²è¢«ç§»é™¤
      // åªä¿ç•™ saveStudentList å’Œ loadStudentListByName

      // è™•ç†è²¼ä¸Šäº‹ä»¶
      function handlePaste(e) {
        e.preventDefault();
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData("Text");

        const lines = pastedData.trim().split("\n");
        const newStudents = [];
        lines.forEach((line) => {
          const [id, name] = line.trim().split("\t");
          if (id && name) {
            newStudents.push({ name: name.trim(), id: id.trim() });
          }
        });

        // åˆ†é…å­¸ç”Ÿåˆ°åº§ä½
        distributeStudents(newStudents);
        showMessage("å­¸ç”Ÿè³‡æ–™å·²è²¼ä¸Š", "success");
      }

      // åˆ†é…å­¸ç”Ÿåˆ°åº§ä½
      function distributeStudents(newStudents) {
        const seatingChart = document.getElementById("seatingChart");
        const seats = Array.from(seatingChart.querySelectorAll(".seat")).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) &&
            seat.querySelector(".seat-name").textContent === "å§“å"
        );

        newStudents.forEach((student, index) => {
          if (index < seats.length) {
            const seat = seats[index];
            seat.querySelector(".seat-id").textContent = student.id;
            seat.querySelector(".seat-name").textContent = student.name;
            seat.dataset.studentId = student.id || "";
            students.push({
              name: student.name,
              id: student.id,
              position: seat.dataset.index,
            });
          }
        });
      }

      // äº‹ä»¶ç¶å®š
      document
        .getElementById("seatingChartContainer")
        .addEventListener("paste", handlePaste);

      // ç•¶æ’æ•¸æˆ–è¡Œæ•¸æ”¹è®Šæ™‚è‡ªå‹•ç”Ÿæˆåº§ä½è¡¨
      document
        .getElementById("rows")
        .addEventListener("change", generateSeatingChart);
      document
        .getElementById("columns")
        .addEventListener("change", generateSeatingChart);
      document.getElementById("className").addEventListener("input", () => {
        // ä¸å†è‡ªå‹•ä¿å­˜
      });

      // å…è¨±ç›´æ¥ç·¨è¼¯åº§è™Ÿå’Œå§“å
      document.addEventListener("input", function (e) {
        if (
          e.target.classList.contains("seat-id") ||
          e.target.classList.contains("seat-name")
        ) {
          const seat = e.target.parentElement;
          const id = seat.querySelector(".seat-id").textContent;
          const name = seat.querySelector(".seat-name").textContent;
          const index = seat.dataset.index;

          // æ›´æ–°å­¸ç”Ÿè³‡æ–™
          const student = students.find((s) => s.position == index);
          if (student) {
            student.id = id;
            student.name = name;
          } else {
            if (name !== "å§“å" && id !== "åº§è™Ÿ") {
              students.push({ id: id, name: name, position: index });
            }
          }
          // ä¸å†è‡ªå‹•ä¿å­˜
        }
      });

      // åˆå§‹åŒ–åº§ä½è¡¨
      window.onload = function () {
        generateSeatingChart();
        document.getElementById("seatingChartContainer").focus();
      };

      // æ ¼å¼åŒ–æ™‚é–“æˆ³ï¼Œé¿å…æ–‡ä»¶åä¸­å‡ºç¾ä¸å…è¨±çš„å­—ç¬¦
      function getFormattedTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const seconds = String(now.getSeconds()).padStart(2, "0");
        return `${year}${month}${day}_${hours}${minutes}${seconds}`;
      }
    </script>
  </body>
</html>
