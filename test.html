<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è£œç¿’ç­è–ªè³‡ç®¡ç†ç³»çµ± - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background-color: #3B82F6;
            color: white;
        }

        .attendance-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background-color: #f3f4f6;
        }

        .calendar-day.has-class {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        .calendar-day.selected {
            background-color: #3b82f6;
            color: white;
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
        }

        .sortable-header:hover {
            background-color: #f9fafb;
        }

        .sort-icon {
            transition: transform 0.2s ease;
        }

        .sort-icon.desc {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é€šçŸ¥è¨Šæ¯ -->
    <div id="notification" class="notification">
        <div class="bg-white border-l-4 p-4 shadow-lg rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg id="notification-icon" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"></svg>
                </div>
                <div class="ml-3">
                    <p id="notification-text" class="text-sm text-gray-700"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-white text-xl font-bold">ğŸ“š è£œç¿’ç­è–ªè³‡ç®¡ç†ç³»çµ±</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-sm bg-white bg-opacity-20 px-3 py-1 rounded">
                        <span id="current-time"></span>
                    </div>
                    <button onclick="showBackupModal()" class="text-white hover:text-gray-200 transition-colors" title="å‚™ä»½èˆ‡é‚„åŸ">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </button>
                    <button onclick="showReportsModal()" class="text-white hover:text-gray-200 transition-colors" title="å ±è¡¨åˆ†æ">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </button>
                    <button onclick="resetAllData()" class="text-white hover:text-gray-200 transition-colors px-3 py-1 border border-white rounded" title="é‡ç½®è³‡æ–™">
                        é‡ç½®
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- åŠŸèƒ½é¸å–® -->
        <div class="px-4 py-6 sm:px-0">
            <!-- å„€è¡¨æ¿çµ±è¨ˆ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('teachers')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">ğŸ‘¨â€ğŸ«</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">æ•™å¸«ç®¡ç†</h3>
                                <p class="text-sm text-gray-500" id="teacher-count">è¼‰å…¥ä¸­...</p>
                                <p class="text-xs text-gray-400" id="teacher-avg-rate">å¹³å‡é˜é»è²»: è¨ˆç®—ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('courses')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">ğŸ“–</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">èª²ç¨‹ç®¡ç†</h3>
                                <p class="text-sm text-gray-500" id="course-count">è¼‰å…¥ä¸­...</p>
                                <p class="text-xs text-gray-400" id="course-avg-rate">å¹³å‡è²»ç‡: è¨ˆç®—ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('students')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">ğŸ‘¨â€ğŸ“</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">å­¸ç”Ÿç®¡ç†</h3>
                                <p class="text-sm text-gray-500" id="student-count">è¼‰å…¥ä¸­...</p>
                                <p class="text-xs text-gray-400" id="payment-rate">ç¹³è²»ç‡: è¨ˆç®—ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('attendance')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">ğŸ“…</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">å‡ºå‹¤ç®¡ç†</h3>
                                <p class="text-sm text-gray-500" id="attendance-count">è¼‰å…¥ä¸­...</p>
                                <p class="text-xs text-gray-400" id="attendance-rate">å‡ºå¸­ç‡: è¨ˆç®—ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('salary')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">ğŸ’°</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">è–ªè³‡è¨ˆç®—</h3>
                                <p class="text-sm text-gray-500">å³æ™‚è¨ˆç®—</p>
                                <p class="text-xs text-gray-400" id="total-salary-month">æœ¬æœˆç¸½æ”¯å‡º: è¨ˆç®—ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•™å¸«ç®¡ç†å€åŸŸ -->
            <div id="teachers-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900">æ•™å¸«ç®¡ç†</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="relative">
                                <input type="text" id="teacher-search" placeholder="æœå°‹æ•™å¸«å§“åæˆ–ç§‘ç›®" 
                                       class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <select id="teacher-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">æ‰€æœ‰ç­‰ç´š</option>
                                <option value="æ–°é€²">æ–°é€²</option>
                                <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
                                <option value="è³‡æ·±">è³‡æ·±</option>
                                <option value="åå¸«">åå¸«</option>
                            </select>
                            <button onclick="showAddTeacherModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors whitespace-nowrap">
                                + æ–°å¢æ•™å¸«
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('teachers', 'name')">
                                        å§“å <span class="sort-icon">â†‘</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('teachers', 'subject')">
                                        å°ˆé•·ç§‘ç›® <span class="sort-icon">â†‘</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('teachers', 'hourlyRate')">
                                        é˜é»è²» <span class="sort-icon">â†‘</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('teachers', 'performanceLevel')">
                                        ç¸¾æ•ˆç­‰ç´š <span class="sort-icon">â†‘</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‹›ç”Ÿçé‡‘ç‡</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¯çµ¡è³‡è¨Š</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="teachers-table" class="bg-white divide-y divide-gray-200">
                                <!-- æ•™å¸«è³‡æ–™å°‡å‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- èª²ç¨‹ç®¡ç†å€åŸŸ -->
            <div id="courses-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900">èª²ç¨‹ç®¡ç†</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="relative">
                                <input type="text" id="course-search" placeholder="æœå°‹èª²ç¨‹åç¨±æˆ–ç§‘ç›®" 
                                       class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <select id="course-level-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">æ‰€æœ‰ç´šåˆ¥</option>
                                <option value="åœ‹å°">åœ‹å°</option>
                                <option value="åœ‹ä¸­">åœ‹ä¸­</option>
                                <option value="é«˜ä¸­">é«˜ä¸­</option>
                                <option value="æˆäºº">æˆäºº</option>
                            </select>
                            <button onclick="showAddCourseModal()" class="bg-secondary text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors whitespace-nowrap">
                                + æ–°å¢èª²ç¨‹
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="courses-grid">
                        <!-- èª²ç¨‹å¡ç‰‡å°‡å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>

            <!-- å­¸ç”Ÿç®¡ç†å€åŸŸ -->
            <div id="students-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900">å­¸ç”Ÿç®¡ç†</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="relative">
                                <input type="text" id="student-search" placeholder="æœå°‹å­¸ç”Ÿå§“å" 
                                       class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <select id="student-status-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="å·²ç¹³è²»">å·²ç¹³è²»</option>
                                <option value="éƒ¨åˆ†ç¹³è²»">éƒ¨åˆ†ç¹³è²»</option>
                                <option value="æœªç¹³è²»">æœªç¹³è²»</option>
                            </select>
                            <button onclick="showAddStudentModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors whitespace-nowrap">
                                + æ–°å¢å­¸ç”Ÿ
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('students', 'name')">
                                        å­¸ç”Ÿå§“å <span class="sort-icon">â†‘</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å°±è®€èª²ç¨‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('students', 'totalFee')">
                                        å­¸è²» <span class="sort-icon">â†‘</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¹³è²»é€²åº¦</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¹³è²»ç‹€æ…‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä»‹ç´¹äºº</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('students', 'enrollDate')">
                                        å ±åæ—¥æœŸ <span class="sort-icon">â†‘</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="students-table" class="bg-white divide-y divide-gray-200">
                                <!-- å­¸ç”Ÿè³‡æ–™å°‡å‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å‡ºå‹¤ç®¡ç†å€åŸŸ -->
            <div id="attendance-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900">å‡ºå‹¤ç®¡ç†</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <input type="month" id="attendance-month" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <select id="attendance-teacher-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">æ‰€æœ‰æ•™å¸«</option>
                            </select>
                            <button onclick="showAddAttendanceModal()" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors whitespace-nowrap">
                                + æ–°å¢ç´€éŒ„
                            </button>
                        </div>
                    </div>

                    <!-- å‡ºå‹¤æ—¥æ›†æª¢è¦– -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">æœˆæ›†æª¢è¦–</h3>
                            <div class="flex space-x-2">
                                <button onclick="previousMonth()" class="p-2 text-gray-500 hover:text-gray-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <span id="calendar-month-year" class="text-lg font-medium px-4 py-2"></span>
                                <button onclick="nextMonth()" class="p-2 text-gray-500 hover:text-gray-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="attendance-calendar" id="attendance-calendar">
                            <!-- æ—¥æ›†å°‡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- å‡ºå‹¤ç´€éŒ„è¡¨æ ¼ -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ•™å¸«</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">èª²ç¨‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ™‚æ•¸</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸ç”Ÿæ•¸</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‚™è¨»</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table" class="bg-white divide-y divide-gray-200">
                                <!-- å‡ºå‹¤ç´€éŒ„å°‡å‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- è–ªè³‡è¨ˆç®—å€åŸŸ -->
            <div id="salary-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">è–ªè³‡è¨ˆç®—èˆ‡åˆ†æ</h2>
                    
                    <!-- è¨ˆç®—åƒæ•¸é¸æ“‡ -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡æ•™å¸«</label>
                            <select id="salary-teacher" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">è«‹é¸æ“‡æ•™å¸«</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è¨ˆç®—å¹´æœˆ</label>
                            <input type="month" id="salary-month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                        <div class="flex items-end">
                            <button onclick="calculateSalary()" class="w-full bg-accent text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
                                è¨ˆç®—è–ªè³‡
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="calculateAllSalaries()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                è¨ˆç®—å…¨éƒ¨
                            </button>
                        </div>
                    </div>

                    <!-- è–ªè³‡æ˜ç´°é¡¯ç¤º -->
                    <div id="salary-result" class="hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">è–ªè³‡æ˜ç´°</h3>
                                <div class="flex space-x-2">
                                    <button onclick="printSalarySlip()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        åˆ—å°è–ªè³‡å–®
                                    </button>
                                    <button onclick="exportSalaryPDF()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                        åŒ¯å‡ºPDF
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                <div class="text-center bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-2">åŸºæœ¬é˜é»è²»</h4>
                                    <div id="basic-salary" class="text-2xl font-bold text-primary">$0</div>
                                    <div id="basic-hours" class="text-sm text-gray-500">0 å°æ™‚</div>
                                </div>
                                <div class="text-center bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-2">æ‹›ç”Ÿçé‡‘</h4>
                                    <div id="recruitment-bonus" class="text-2xl font-bold text-secondary">$0</div>
                                    <div id="recruitment-count" class="text-sm text-gray-500">0 ä½æ–°ç”Ÿ</div>
                                </div>
                                <div class="text-center bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-2">ç¸¾æ•ˆçé‡‘</h4>
                                    <div id="performance-bonus" class="text-2xl font-bold text-accent">$0</div>
                                    <div id="performance-rate" class="text-sm text-gray-500">0% çé‡‘ç‡</div>
                                </div>
                                <div class="text-center bg-white rounded-lg p-4 border-2 border-gray-300">
                                    <h4 class="font-medium text-gray-700 mb-2">ç¸½è–ªè³‡</h4>
                                    <div id="total-salary" class="text-3xl font-bold text-gray-900">$0</div>
                                    <div id="salary-teacher-name" class="text-sm text-gray-500"></div>
                                </div>
                            </div>
                            
                            <!-- è©³ç´°è¨ˆç®—æ˜ç´° -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-3">èª²ç¨‹æ˜ç´°</h4>
                                    <div id="course-breakdown" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-3">æ‹›ç”Ÿæ˜ç´°</h4>
                                    <div id="recruitment-breakdown" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å…¨é«”æ•™å¸«è–ªè³‡ç¸½è¦½ -->
                    <div id="all-salaries-result" class="hidden">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4">å…¨é«”æ•™å¸«è–ªè³‡ç¸½è¦½</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ•™å¸«</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åŸºæœ¬è–ªè³‡</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‹›ç”Ÿçé‡‘</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸¾æ•ˆçé‡‘</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½è–ªè³‡</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="all-salaries-table" class="bg-white divide-y divide-gray-200">
                                        <!-- å…¨é«”è–ªè³‡è³‡æ–™å°‡å‹•æ…‹è¼‰å…¥ -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div class="text-sm text-gray-500">ç¸½åŸºæœ¬è–ªè³‡</div>
                                        <div id="total-basic-salary" class="text-lg font-bold text-primary">$0</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">ç¸½æ‹›ç”Ÿçé‡‘</div>
                                        <div id="total-recruitment-bonus" class="text-lg font-bold text-secondary">$0</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">ç¸½ç¸¾æ•ˆçé‡‘</div>
                                        <div id="total-performance-bonus" class="text-lg font-bold text-accent">$0</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">ç¸½æ”¯å‡º</div>
                                        <div id="grand-total-salary" class="text-xl font-bold text-gray-900">$0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æ•™å¸«æ¨¡æ…‹æ¡† -->
    <div id="teacher-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4" id="teacher-modal-title">æ–°å¢æ•™å¸«</h3>
            <form id="teacher-form">
                <input type="hidden" id="teacher-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ•™å¸«å§“å *</label>
                        <input type="text" id="teacher-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆé•·ç§‘ç›® *</label>
                        <input type="text" id="teacher-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åŸºæœ¬é˜é»è²» (å…ƒ/å°æ™‚) *</label>
                        <input type="number" id="teacher-rate" min="100" max="5000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç¸¾æ•ˆç­‰ç´š *</label>
                        <select id="teacher-level" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">è«‹é¸æ“‡ç­‰ç´š</option>
                            <option value="æ–°é€²">æ–°é€² (ç„¡ç¸¾æ•ˆçé‡‘)</option>
                            <option value="ä¸€èˆ¬">ä¸€èˆ¬ (5% ç¸¾æ•ˆçé‡‘)</option>
                            <option value="è³‡æ·±">è³‡æ·± (10% ç¸¾æ•ˆçé‡‘)</option>
                            <option value="åå¸«">åå¸« (15% ç¸¾æ•ˆçé‡‘)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ‹›ç”Ÿçé‡‘æ¯”ä¾‹ (%)</label>
                        <input type="number" id="teacher-bonus-rate" min="0" max="20" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="ä¾‹ï¼š3.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡è³‡è¨Š</label>
                        <input type="text" id="teacher-contact" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="é›»è©±æˆ–email">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideModal('teacher-modal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
                        <span id="teacher-submit-text">æ–°å¢</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ–°å¢èª²ç¨‹æ¨¡æ…‹æ¡† -->
    <div id="course-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4" id="course-modal-title">æ–°å¢èª²ç¨‹</h3>
            <form id="course-form">
                <input type="hidden" id="course-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">èª²ç¨‹åç¨± *</label>
                        <input type="text" id="course-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">èª²ç¨‹ç´šåˆ¥ *</label>
                        <select id="course-level" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">è«‹é¸æ“‡ç´šåˆ¥</option>
                            <option value="åœ‹å°">åœ‹å°</option>
                            <option value="åœ‹ä¸­">åœ‹ä¸­</option>
                            <option value="é«˜ä¸­">é«˜ä¸­</option>
                            <option value="æˆäºº">æˆäºº</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç§‘ç›® *</label>
                        <input type="text" id="course-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™æº–é˜é»è²» (å…ƒ/å°æ™‚) *</label>
                        <input type="number" id="course-rate" min="100" max="5000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">èª²ç¨‹æ™‚æ•¸ (å°æ™‚) *</label>
                        <input type="number" id="course-duration" min="0.5" max="5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ€å¤§å­¸ç”Ÿæ•¸</label>
                        <input type="number" id="course-max-students" min="1" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="ä¾‹ï¼š15">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideModal('course-modal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-green-600">
                        <span id="course-submit-text">æ–°å¢</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ–°å¢å­¸ç”Ÿæ¨¡æ…‹æ¡† -->
    <div id="student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4" id="student-modal-title">æ–°å¢å­¸ç”Ÿ</h3>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å­¸ç”Ÿå§“å *</label>
                        <input type="text" id="student-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å ±è®€èª²ç¨‹ *</label>
                        <select id="student-course" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">è«‹é¸æ“‡èª²ç¨‹</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å­¸è²» (å…ƒ) *</label>
                        <input type="number" id="student-fee" min="1000" max="100000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å·²ç¹³é‡‘é¡ (å…ƒ)</label>
                        <input type="number" id="student-paid" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç¹³è²»ç‹€æ…‹ *</label>
                        <select id="student-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">è«‹é¸æ“‡ç‹€æ…‹</option>
                            <option value="å·²ç¹³è²»">å·²ç¹³è²»</option>
                            <option value="æœªç¹³è²»">æœªç¹³è²»</option>
                            <option value="éƒ¨åˆ†ç¹³è²»">éƒ¨åˆ†ç¹³è²»</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä»‹ç´¹äººæ•™å¸«</label>
                        <select id="student-referrer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <option value="">è‡ªè¡Œå ±å</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡è³‡è¨Š</label>
                        <input type="text" id="student-contact" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="å®¶é•·é›»è©±">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideModal('student-modal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <span id="student-submit-text">æ–°å¢</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ–°å¢å‡ºå‹¤æ¨¡æ…‹æ¡† -->
    <div id="attendance-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4" id="attendance-modal-title">æ–°å¢å‡ºå‹¤ç´€éŒ„</h3>
            <form id="attendance-form">
                <input type="hidden" id="attendance-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¸Šèª²æ—¥æœŸ *</label>
                        <input type="date" id="attendance-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æˆèª²æ•™å¸« *</label>
                        <select id="attendance-teacher" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">è«‹é¸æ“‡æ•™å¸«</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æˆèª²èª²ç¨‹ *</label>
                        <select id="attendance-course" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">è«‹é¸æ“‡èª²ç¨‹</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¯¦éš›ä¸Šèª²æ™‚æ•¸ *</label>
                        <input type="number" id="attendance-hours" min="0.5" max="8" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å­¸ç”Ÿå‡ºå¸­æ•¸ *</label>
                        <input type="number" id="attendance-students" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">èª²ç¨‹ç‹€æ…‹</label>
                        <select id="attendance-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <option value="completed">æ­£å¸¸å®Œæˆ</option>
                            <option value="makeup">è£œèª²</option>
                            <option value="cancelled">å–æ¶ˆ</option>
                            <option value="rescheduled">èª¿èª²</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                        <textarea id="attendance-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="ç‰¹æ®Šç‹€æ³èªªæ˜"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideModal('attendance-modal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-yellow-600">
                        <span id="attendance-submit-text">æ–°å¢</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- å ±è¡¨åˆ†ææ¨¡æ…‹æ¡† -->
    <div id="reports-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">å ±è¡¨åˆ†æä¸­å¿ƒ</h3>
                <button onclick="hideModal('reports-modal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- å ±è¡¨é¸é …å¡ -->
            <div class="flex space-x-4 mb-6">
                <button onclick="showReportTab('financial')" class="tab-button px-4 py-2 rounded-lg active">è²¡å‹™å ±è¡¨</button>
                <button onclick="showReportTab('performance')" class="tab-button px-4 py-2 rounded-lg">ç¸¾æ•ˆåˆ†æ</button>
                <button onclick="showReportTab('attendance')" class="tab-button px-4 py-2 rounded-lg">å‡ºå‹¤çµ±è¨ˆ</button>
            </div>

            <!-- è²¡å‹™å ±è¡¨ -->
            <div id="financial-report" class="report-tab-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">æœ¬æœˆç¸½æ”¶å…¥</div>
                        <div id="total-income" class="text-2xl font-bold text-blue-600">$0</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">æœ¬æœˆç¸½æ”¯å‡º</div>
                        <div id="total-expense" class="text-2xl font-bold text-red-600">$0</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">æœ¬æœˆæ·¨åˆ©</div>
                        <div id="net-profit" class="text-2xl font-bold text-green-600">$0</div>
                    </div>
                </div>
                <canvas id="financial-chart" width="400" height="200"></canvas>
            </div>

            <!-- ç¸¾æ•ˆåˆ†æ -->
            <div id="performance-report" class="report-tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-2">æ•™å¸«ç¸¾æ•ˆæ’å</h4>
                        <div id="teacher-performance-list" class="space-y-2">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- å‡ºå‹¤çµ±è¨ˆ -->
            <div id="attendance-report" class="report-tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-2">èª²ç¨‹å‡ºå‹¤ç‡</h4>
                        <div id="course-attendance-list" class="space-y-2">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-2">æ•™å¸«å‡ºå‹¤çµ±è¨ˆ</h4>
                        <div id="teacher-attendance-list" class="space-y-2">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‚™ä»½èˆ‡é‚„åŸæ¨¡æ…‹æ¡† -->
    <div id="backup-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
                <button onclick="hideModal('backup-modal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium mb-2">å‚™ä»½è³‡æ–™</h4>
                    <button onclick="exportData()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        åŒ¯å‡ºå®Œæ•´è³‡æ–™å‚™ä»½
                    </button>
                </div>
                
                <div>
                    <h4 class="font-medium mb-2">é‚„åŸè³‡æ–™</h4>
                    <input type="file" id="import-file" accept=".json" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <button onclick="importData()" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        å¾æª”æ¡ˆé‚„åŸè³‡æ–™
                    </button>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="font-medium mb-2 text-red-600">å±éšªæ“ä½œ</h4>
                    <button onclick="resetAllData()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        æ¸…é™¤æ‰€æœ‰è³‡æ–™
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ -->
    <div id="loading" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="loading-spinner"></div>
            <span class="text-gray-700">è™•ç†ä¸­...</span>
        </div>
    </div>

    <script>
        // ===== å…¨åŸŸè®Šæ•¸èˆ‡å¸¸æ•¸ =====
        
        const STORAGE_KEYS = {
            TEACHERS: 'cramSchool_teachers',
            COURSES: 'cramSchool_courses',
            STUDENTS: 'cramSchool_students',
            ATTENDANCE: 'cramSchool_attendance',
            SETTINGS: 'cramSchool_settings'
        };

        let appData = {
            teachers: [],
            courses: [],
            students: [],
            attendance: [],
            currentSection: null,
            sortConfig: { table: null, column: null, direction: 'asc' },
            currentCalendarDate: new Date(),
            filters: {
                teachers: { search: '', level: '' },
                courses: { search: '', level: '' },
                students: { search: '', status: '' }
            }
        };

        let financialChart = null;

        // ===== åˆå§‹åŒ–èˆ‡è³‡æ–™è¼‰å…¥ =====
        
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromStorage();
            initializeDefaultData();
            updateAllDisplays();
            setupEventHandlers();
            setupFormHandlers();
            showSection('teachers');
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });

        function loadDataFromStorage() {
            try {
                appData.teachers = JSON.parse(localStorage.getItem(STORAGE_KEYS.TEACHERS) || '[]');
                appData.courses = JSON.parse(localStorage.getItem(STORAGE_KEYS.COURSES) || '[]');
                appData.students = JSON.parse(localStorage.getItem(STORAGE_KEYS.STUDENTS) || '[]');
                appData.attendance = JSON.parse(localStorage.getItem(STORAGE_KEYS.ATTENDANCE) || '[]');
                
                // è½‰æ›æ—¥æœŸå­—ä¸²å› Date ç‰©ä»¶
                appData.students.forEach(student => {
                    if (student.enrollDate) {
                        student.enrollDate = new Date(student.enrollDate);
                    }
                });
                
                appData.attendance.forEach(record => {
                    if (record.date) {
                        record.date = new Date(record.date);
                    }
                });
                
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                showNotification('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå°‡ä½¿ç”¨é è¨­è³‡æ–™', 'error');
            }
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.TEACHERS, JSON.stringify(appData.teachers));
                localStorage.setItem(STORAGE_KEYS.COURSES, JSON.stringify(appData.courses));
                localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(appData.students));
                localStorage.setItem(STORAGE_KEYS.ATTENDANCE, JSON.stringify(appData.attendance));
            } catch (error) {
                console.error('å„²å­˜è³‡æ–™å¤±æ•—:', error);
                showNotification('è³‡æ–™å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨å„²å­˜ç©ºé–“', 'error');
            }
        }

        function initializeDefaultData() {
            if (appData.teachers.length === 0) {
                appData.teachers = [
                    {
                        id: 1,
                        name: 'ç‹å¿—æ˜',
                        subject: 'æ•¸å­¸',
                        hourlyRate: 800,
                        performanceLevel: 'è³‡æ·±',
                        recruitmentBonusRate: 5.0,
                        contactInfo: '0912-345-678',
                        joinDate: new Date('2020-01-15')
                    },
                    {
                        id: 2,
                        name: 'æç¾ç²',
                        subject: 'è‹±æ–‡',
                        hourlyRate: 600,
                        performanceLevel: 'ä¸€èˆ¬',
                        recruitmentBonusRate: 3.0,
                        contactInfo: 'lee@example.com',
                        joinDate: new Date('2021-08-01')
                    },
                    {
                        id: 3,
                        name: 'å¼µåšå£«',
                        subject: 'ç‰©ç†',
                        hourlyRate: 1200,
                        performanceLevel: 'åå¸«',
                        recruitmentBonusRate: 8.0,
                        contactInfo: '0922-987-654',
                        joinDate: new Date('2018-03-10')
                    },
                    {
                        id: 4,
                        name: 'é™³è€å¸«',
                        subject: 'åŒ–å­¸',
                        hourlyRate: 750,
                        performanceLevel: 'ä¸€èˆ¬',
                        recruitmentBonusRate: 4.0,
                        contactInfo: '0933-111-222',
                        joinDate: new Date('2022-02-20')
                    }
                ];
            }

            if (appData.courses.length === 0) {
                appData.courses = [
                    {
                        id: 1,
                        name: 'åœ‹ä¸­æ•¸å­¸åŸºç¤ç­',
                        level: 'åœ‹ä¸­',
                        subject: 'æ•¸å­¸',
                        standardRate: 800,
                        duration: 2,
                        maxStudents: 15
                    },
                    {
                        id: 2,
                        name: 'é«˜ä¸­è‹±æ–‡é€²éšç­',
                        level: 'é«˜ä¸­',
                        subject: 'è‹±æ–‡',
                        standardRate: 900,
                        duration: 2,
                        maxStudents: 12
                    },
                    {
                        id: 3,
                        name: 'é«˜ä¸­ç‰©ç†ç²¾ä¿®ç­',
                        level: 'é«˜ä¸­',
                        subject: 'ç‰©ç†',
                        standardRate: 1200,
                        duration: 1.5,
                        maxStudents: 10
                    },
                    {
                        id: 4,
                        name: 'åœ‹å°æ•¸å­¸å•Ÿè’™ç­',
                        level: 'åœ‹å°',
                        subject: 'æ•¸å­¸',
                        standardRate: 600,
                        duration: 1.5,
                        maxStudents: 20
                    },
                    {
                        id: 5,
                        name: 'é«˜ä¸­åŒ–å­¸å¯¦é©—ç­',
                        level: 'é«˜ä¸­',
                        subject: 'åŒ–å­¸',
                        standardRate: 1000,
                        duration: 2,
                        maxStudents: 8
                    }
                ];
            }

            if (appData.students.length === 0) {
                appData.students = [
                    {
                        id: 1,
                        name: 'é™³å°æ˜',
                        courseIds: [1],
                        totalFee: 12000,
                        paidAmount: 12000,
                        paymentStatus: 'å·²ç¹³è²»',
                        referrerTeacherId: 1,
                        enrollDate: new Date('2025-01-15'),
                        contactInfo: '0912-111-222'
                    },
                    {
                        id: 2,
                        name: 'æ—å°è¯',
                        courseIds: [2],
                        totalFee: 15000,
                        paidAmount: 7500,
                        paymentStatus: 'éƒ¨åˆ†ç¹³è²»',
                        referrerTeacherId: 2,
                        enrollDate: new Date('2025-02-01'),
                        contactInfo: '0923-333-444'
                    },
                    {
                        id: 3,
                        name: 'é»ƒå°ç¾',
                        courseIds: [3],
                        totalFee: 18000,
                        paidAmount: 0,
                        paymentStatus: 'æœªç¹³è²»',
                        referrerTeacherId: null,
                        enrollDate: new Date('2025-02-10'),
                        contactInfo: '0934-555-666'
                    },
                    {
                        id: 4,
                        name: 'æå°å¼·',
                        courseIds: [1, 4],
                        totalFee: 20000,
                        paidAmount: 20000,
                        paymentStatus: 'å·²ç¹³è²»',
                        referrerTeacherId: 1,
                        enrollDate: new Date('2025-01-20'),
                        contactInfo: '0945-777-888'
                    },
                    {
                        id: 5,
                        name: 'ç‹å°èŠ³',
                        courseIds: [5],
                        totalFee: 16000,
                        paidAmount: 8000,
                        paymentStatus: 'éƒ¨åˆ†ç¹³è²»',
                        referrerTeacherId: 4,
                        enrollDate: new Date('2025-02-15'),
                        contactInfo: '0956-999-000'
                    }
                ];
            }

            if (appData.attendance.length === 0) {
                generateSampleAttendanceData();
            }

            saveDataToStorage();
        }

        function generateSampleAttendanceData() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            appData.attendance = [];
            let recordId = 1;

            // ç”Ÿæˆéå»3å€‹æœˆçš„å‡ºå‹¤è³‡æ–™
            for (let monthOffset = 2; monthOffset >= 0; monthOffset--) {
                const targetMonth = currentMonth - monthOffset;
                const targetYear = targetMonth < 0 ? currentYear - 1 : currentYear;
                const adjustedMonth = targetMonth < 0 ? 12 + targetMonth : targetMonth;
                
                // ç‚ºæ¯å€‹æ•™å¸«åœ¨è©²æœˆä»½ç”Ÿæˆå‡ºå‹¤ç´€éŒ„
                appData.teachers.forEach(teacher => {
                    // æ¯å€‹æ•™å¸«æ¯æœˆå¤§ç´„ä¸Šèª²12-16æ¬¡
                    const classCount = Math.floor(Math.random() * 5) + 12;
                    
                    for (let i = 0; i < classCount; i++) {
                        const day = Math.floor(Math.random() * 28) + 1;
                        const classDate = new Date(targetYear, adjustedMonth, day);
                        
                        // éš¨æ©Ÿé¸æ“‡èª²ç¨‹ï¼ˆæ ¹æ“šæ•™å¸«å°ˆé•·ï¼‰
                        const relevantCourses = appData.courses.filter(course => 
                            course.subject === teacher.subject
                        );
                        const course = relevantCourses.length > 0 
                            ? relevantCourses[Math.floor(Math.random() * relevantCourses.length)]
                            : appData.courses[Math.floor(Math.random() * appData.courses.length)];
                        
                        appData.attendance.push({
                            id: recordId++,
                            teacherId: teacher.id,
                            courseId: course.id,
                            date: classDate,
                            actualHours: course.duration,
                            studentCount: Math.floor(Math.random() * (course.maxStudents || 15)) + 5,
                            notes: Math.random() > 0.9 ? ['è£œèª²', 'èª¿èª²', 'ç‰¹åˆ¥èª²ç¨‹'][Math.floor(Math.random() * 3)] : '',
                            isCompleted: Math.random() > 0.05,
                            status: Math.random() > 0.1 ? 'completed' : 
                                   Math.random() > 0.5 ? 'makeup' : 'rescheduled'
                        });
                    }
                });
            }
        }

        // ===== äº‹ä»¶è™•ç†å™¨è¨­å®š =====
        
        function setupEventHandlers() {
            // æœå°‹åŠŸèƒ½
            document.getElementById('teacher-search').addEventListener('input', function() {
                appData.filters.teachers.search = this.value;
                updateTeachersTable();
            });

            document.getElementById('teacher-filter').addEventListener('change', function() {
                appData.filters.teachers.level = this.value;
                updateTeachersTable();
            });

            document.getElementById('course-search').addEventListener('input', function() {
                appData.filters.courses.search = this.value;
                updateCoursesGrid();
            });

            document.getElementById('course-level-filter').addEventListener('change', function() {
                appData.filters.courses.level = this.value;
                updateCoursesGrid();
            });

            document.getElementById('student-search').addEventListener('input', function() {
                appData.filters.students.search = this.value;
                updateStudentsTable();
            });

            document.getElementById('student-status-filter').addEventListener('change', function() {
                appData.filters.students.status = this.value;
                updateStudentsTable();
            });

            // å‡ºå‹¤ç®¡ç†äº‹ä»¶
            document.getElementById('attendance-month').addEventListener('change', function() {
                updateAttendanceTable();
                updateAttendanceCalendar();
            });

            document.getElementById('attendance-teacher-filter').addEventListener('change', function() {
                updateAttendanceTable();
            });

            // è–ªè³‡è¨ˆç®—æœˆä»½è¨­å®š
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('salary-month').value = currentMonth;
            document.getElementById('attendance-month').value = currentMonth;
        }

        function setupFormHandlers() {
            // æ•™å¸«è¡¨å–®
            document.getElementById('teacher-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleTeacherSubmit();
            });
            
            // èª²ç¨‹è¡¨å–®
            document.getElementById('course-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleCourseSubmit();
            });
            
            // å­¸ç”Ÿè¡¨å–®
            document.getElementById('student-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleStudentSubmit();
            });

            // å‡ºå‹¤è¡¨å–®
            document.getElementById('attendance-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleAttendanceSubmit();
            });
        }

        // ===== è¡¨å–®è™•ç†åŠŸèƒ½ =====
        
        function handleTeacherSubmit() {
            const teacherId = document.getElementById('teacher-id').value;
            const teacherData = {
                name: document.getElementById('teacher-name').value,
                subject: document.getElementById('teacher-subject').value,
                hourlyRate: parseInt(document.getElementById('teacher-rate').value),
                performanceLevel: document.getElementById('teacher-level').value,
                recruitmentBonusRate: parseFloat(document.getElementById('teacher-bonus-rate').value) || 0,
                contactInfo: document.getElementById('teacher-contact').value || ''
            };

            if (teacherId) {
                updateTeacher(parseInt(teacherId), teacherData);
                showNotification('æ•™å¸«è³‡æ–™æ›´æ–°æˆåŠŸ');
            } else {
                addTeacher(teacherData);
                showNotification('æ•™å¸«æ–°å¢æˆåŠŸ');
            }

            hideModal('teacher-modal');
            document.getElementById('teacher-form').reset();
        }

        function handleCourseSubmit() {
            const courseId = document.getElementById('course-id').value;
            const courseData = {
                name: document.getElementById('course-name').value,
                level: document.getElementById('course-level').value,
                subject: document.getElementById('course-subject').value,
                standardRate: parseInt(document.getElementById('course-rate').value),
                duration: parseFloat(document.getElementById('course-duration').value),
                maxStudents: parseInt(document.getElementById('course-max-students').value) || null
            };

            if (courseId) {
                updateCourse(parseInt(courseId), courseData);
                showNotification('èª²ç¨‹è³‡æ–™æ›´æ–°æˆåŠŸ');
            } else {
                addCourse(courseData);
                showNotification('èª²ç¨‹æ–°å¢æˆåŠŸ');
            }

            hideModal('course-modal');
            document.getElementById('course-form').reset();
        }

        function handleStudentSubmit() {
            const studentId = document.getElementById('student-id').value;
            const totalFee = parseInt(document.getElementById('student-fee').value);
            const paidAmount = parseInt(document.getElementById('student-paid').value) || 0;
            
            // è‡ªå‹•åˆ¤æ–·ç¹³è²»ç‹€æ…‹
            let paymentStatus;
            if (paidAmount >= totalFee) {
                paymentStatus = 'å·²ç¹³è²»';
            } else if (paidAmount > 0) {
                paymentStatus = 'éƒ¨åˆ†ç¹³è²»';
            } else {
                paymentStatus = 'æœªç¹³è²»';
            }

            const studentData = {
                name: document.getElementById('student-name').value,
                courseIds: [parseInt(document.getElementById('student-course').value)],
                totalFee: totalFee,
                paidAmount: paidAmount,
                paymentStatus: paymentStatus,
                referrerTeacherId: document.getElementById('student-referrer').value 
                    ? parseInt(document.getElementById('student-referrer').value) : null,
                contactInfo: document.getElementById('student-contact').value || ''
            };

            if (studentId) {
                updateStudent(parseInt(studentId), studentData);
                showNotification('å­¸ç”Ÿè³‡æ–™æ›´æ–°æˆåŠŸ');
            } else {
                addStudent(studentData);
                showNotification('å­¸ç”Ÿæ–°å¢æˆåŠŸ');
            }

            hideModal('student-modal');
            document.getElementById('student-form').reset();
        }

        function handleAttendanceSubmit() {
            const attendanceId = document.getElementById('attendance-id').value;
            const attendanceData = {
                date: new Date(document.getElementById('attendance-date').value),
                teacherId: parseInt(document.getElementById('attendance-teacher').value),
                courseId: parseInt(document.getElementById('attendance-course').value),
                actualHours: parseFloat(document.getElementById('attendance-hours').value),
                studentCount: parseInt(document.getElementById('attendance-students').value),
                status: document.getElementById('attendance-status').value,
                notes: document.getElementById('attendance-notes').value || '',
                isCompleted: document.getElementById('attendance-status').value === 'completed'
            };

            if (attendanceId) {
                updateAttendance(parseInt(attendanceId), attendanceData);
                showNotification('å‡ºå‹¤ç´€éŒ„æ›´æ–°æˆåŠŸ');
            } else {
                addAttendance(attendanceData);
                showNotification('å‡ºå‹¤ç´€éŒ„æ–°å¢æˆåŠŸ');
            }

            hideModal('attendance-modal');
            document.getElementById('attendance-form').reset();
            updateAttendanceTable();
            updateAttendanceCalendar();
        }

        // ===== è³‡æ–™æ“ä½œåŠŸèƒ½ =====
        
        function addTeacher(teacherData) {
            const newId = Math.max(...appData.teachers.map(t => t.id), 0) + 1;
            const newTeacher = {
                id: newId,
                ...teacherData,
                joinDate: new Date()
            };
            
            appData.teachers.push(newTeacher);
            saveDataToStorage();
            updateAllDisplays();
            
            return newTeacher;
        }

        function updateTeacher(id, teacherData) {
            const index = appData.teachers.findIndex(t => t.id === id);
            if (index !== -1) {
                appData.teachers[index] = { ...appData.teachers[index], ...teacherData };
                saveDataToStorage();
                updateAllDisplays();
                return true;
            }
            return false;
        }

        function addCourse(courseData) {
            const newId = Math.max(...appData.courses.map(c => c.id), 0) + 1;
            const newCourse = {
                id: newId,
                ...courseData
            };
            
            appData.courses.push(newCourse);
            saveDataToStorage();
            updateAllDisplays();
            
            return newCourse;
        }

        function updateCourse(id, courseData) {
            const index = appData.courses.findIndex(c => c.id === id);
            if (index !== -1) {
                appData.courses[index] = { ...appData.courses[index], ...courseData };
                saveDataToStorage();
                updateAllDisplays();
                return true;
            }
            return false;
        }

        function addStudent(studentData) {
            const newId = Math.max(...appData.students.map(s => s.id), 0) + 1;
            const newStudent = {
                id: newId,
                ...studentData,
                enrollDate: new Date()
            };
            
            appData.students.push(newStudent);
            saveDataToStorage();
            updateAllDisplays();
            
            return newStudent;
        }

        function updateStudent(id, studentData) {
            const index = appData.students.findIndex(s => s.id === id);
            if (index !== -1) {
                appData.students[index] = { ...appData.students[index], ...studentData };
                saveDataToStorage();
                updateAllDisplays();
                return true;
            }
            return false;
        }

        function addAttendance(attendanceData) {
            const newId = Math.max(...appData.attendance.map(a => a.id), 0) + 1;
            const newAttendance = {
                id: newId,
                ...attendanceData
            };
            
            appData.attendance.push(newAttendance);
            saveDataToStorage();
            updateAllDisplays();
            
            return newAttendance;
        }

        function updateAttendance(id, attendanceData) {
            const index = appData.attendance.findIndex(a => a.id === id);
            if (index !== -1) {
                appData.attendance[index] = { ...appData.attendance[index], ...attendanceData };
                saveDataToStorage();
                updateAllDisplays();
                return true;
            }
            return false;
        }

        // ===== UI æ›´æ–°åŠŸèƒ½ =====
        
        function updateAllDisplays() {
            updateTeachersTable();
            updateCoursesGrid();
            updateStudentsTable();
            updateAttendanceTable();
            updateSalaryTeacherSelect();
            updateCourseSelects();
            updateTeacherSelects();
            updateCounters();
            updateAttendanceCalendar();
        }

        function updateCounters() {
            // æ•™å¸«çµ±è¨ˆ
            const teacherCount = appData.teachers.length;
            const avgRate = teacherCount > 0 
                ? Math.round(appData.teachers.reduce((sum, t) => sum + t.hourlyRate, 0) / teacherCount)
                : 0;
            
            document.getElementById('teacher-count').textContent = `${teacherCount} ä½æ•™å¸«`;
            document.getElementById('teacher-avg-rate').textContent = `å¹³å‡é˜é»è²»: $${avgRate}`;

            // èª²ç¨‹çµ±è¨ˆ
            const courseCount = appData.courses.length;
            const avgCourseRate = courseCount > 0 
                ? Math.round(appData.courses.reduce((sum, c) => sum + c.standardRate, 0) / courseCount)
                : 0;
            
            document.getElementById('course-count').textContent = `${courseCount} é–€èª²ç¨‹`;
            document.getElementById('course-avg-rate').textContent = `å¹³å‡è²»ç‡: $${avgCourseRate}`;

            // å­¸ç”Ÿçµ±è¨ˆ
            const studentCount = appData.students.length;
            const paidStudents = appData.students.filter(s => s.paymentStatus === 'å·²ç¹³è²»').length;
            const paymentRate = studentCount > 0 ? Math.round((paidStudents / studentCount) * 100) : 0;
            
            document.getElementById('student-count').textContent = `${studentCount} ä½å­¸ç”Ÿ`;
            document.getElementById('payment-rate').textContent = `ç¹³è²»ç‡: ${paymentRate}%`;

            // å‡ºå‹¤çµ±è¨ˆ
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const currentMonthAttendance = appData.attendance.filter(a => {
                const date = new Date(a.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const completedClasses = currentMonthAttendance.filter(a => a.isCompleted).length;
            const attendanceRate = currentMonthAttendance.length > 0 
                ? Math.round((completedClasses / currentMonthAttendance.length) * 100)
                : 100;
            
            document.getElementById('attendance-count').textContent = `${currentMonthAttendance.length} å ‚èª²`;
            document.getElementById('attendance-rate').textContent = `å®Œæˆç‡: ${attendanceRate}%`;

            // è¨ˆç®—æœ¬æœˆç¸½è–ªè³‡æ”¯å‡º
            calculateMonthlyTotalSalary();
        }

        function calculateMonthlyTotalSalary() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            let totalSalary = 0;

            appData.teachers.forEach(teacher => {
                const monthlyAttendance = appData.attendance.filter(a => {
                    const date = new Date(a.date);
                    return a.teacherId === teacher.id && 
                           date.getMonth() === currentMonth && 
                           date.getFullYear() === currentYear &&
                           a.isCompleted;
                });

                let basicSalary = 0;
                monthlyAttendance.forEach(record => {
                    const course = appData.courses.find(c => c.id === record.courseId);
                    const rate = course ? course.standardRate : teacher.hourlyRate;
                    basicSalary += record.actualHours * rate;
                });

                // ç¸¾æ•ˆçé‡‘
                const levelMultiplier = {
                    'æ–°é€²': 0.00, 'ä¸€èˆ¬': 0.05, 'è³‡æ·±': 0.10, 'åå¸«': 0.15
                };
                const performanceBonus = basicSalary * (levelMultiplier[teacher.performanceLevel] || 0);

                // æ‹›ç”Ÿçé‡‘
                const newStudents = appData.students.filter(student => {
                    const enrollDate = new Date(student.enrollDate);
                    return student.referrerTeacherId === teacher.id &&
                           enrollDate.getMonth() === currentMonth &&
                           enrollDate.getFullYear() === currentYear;
                });
                
                const recruitmentBonus = newStudents.reduce((sum, student) => 
                    sum + (student.totalFee * (teacher.recruitmentBonusRate / 100)), 0);

                totalSalary += basicSalary + performanceBonus + recruitmentBonus;
            });

            document.getElementById('total-salary-month').textContent = `æœ¬æœˆç¸½æ”¯å‡º: $${Math.round(totalSalary).toLocaleString()}`;
        }

        function updateTeachersTable() {
            const tableBody = document.getElementById('teachers-table');
            tableBody.innerHTML = '';
            
            let filteredTeachers = appData.teachers;
            
            // æœå°‹ç¯©é¸
            if (appData.filters.teachers.search) {
                const search = appData.filters.teachers.search.toLowerCase();
                filteredTeachers = filteredTeachers.filter(teacher => 
                    teacher.name.toLowerCase().includes(search) ||
                    teacher.subject.toLowerCase().includes(search)
                );
            }
            
            // ç­‰ç´šç¯©é¸
            if (appData.filters.teachers.level) {
                filteredTeachers = filteredTeachers.filter(teacher => 
                    teacher.performanceLevel === appData.filters.teachers.level
                );
            }
            
            // æ’åºè™•ç†
            if (appData.sortConfig.table === 'teachers' && appData.sortConfig.column) {
                filteredTeachers.sort((a, b) => {
                    let aValue = a[appData.sortConfig.column];
                    let bValue = b[appData.sortConfig.column];
                    
                    if (typeof aValue === 'string') {
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                    }
                    
                    if (aValue < bValue) return appData.sortConfig.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return appData.sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            filteredTeachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.hourlyRate}/å°æ™‚</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getLevelColor(teacher.performanceLevel)}">
                            ${teacher.performanceLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.recruitmentBonusRate}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.contactInfo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editTeacher(${teacher.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 transition-colors">ç·¨è¼¯</button>
                        <button onclick="deleteTeacher(${teacher.id})" class="text-red-600 hover:text-red-900 transition-colors">åˆªé™¤</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            if (filteredTeachers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                        ${appData.filters.teachers.search || appData.filters.teachers.level ? 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•™å¸«' : 'å°šæœªæ–°å¢ä»»ä½•æ•™å¸«'}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        function updateCoursesGrid() {
            const grid = document.getElementById('courses-grid');
            grid.innerHTML = '';
            
            let filteredCourses = appData.courses;
            
            // æœå°‹ç¯©é¸
            if (appData.filters.courses.search) {
                const search = appData.filters.courses.search.toLowerCase();
                filteredCourses = filteredCourses.filter(course => 
                    course.name.toLowerCase().includes(search) ||
                    course.subject.toLowerCase().includes(search)
                );
            }
            
            // ç´šåˆ¥ç¯©é¸
            if (appData.filters.courses.level) {
                filteredCourses = filteredCourses.filter(course => 
                    course.level === appData.filters.courses.level
                );
            }
            
            filteredCourses.forEach(course => {
                const enrolledStudents = appData.students.filter(student => 
                    student.courseIds.includes(course.id)
                ).length;
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover border border-gray-200';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 leading-tight">${course.name}</h3>
                        <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${course.level}</span>
                    </div>
                    <div class="space-y-3 text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span class="font-medium">ç§‘ç›®ï¼š</span>
                            <span>${course.subject}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">é˜é»è²»ï¼š</span>
                            <span class="text-green-600 font-semibold">${course.standardRate}/å°æ™‚</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">èª²ç¨‹æ™‚æ•¸ï¼š</span>
                            <span>${course.duration} å°æ™‚</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">å­¸ç”Ÿäººæ•¸ï¼š</span>
                            <span class="text-blue-600">${enrolledStudents}/${course.maxStudents || 'ç„¡é™åˆ¶'}</span>
                        </div>
                        ${course.maxStudents && enrolledStudents >= course.maxStudents ? 
                            '<div class="text-red-500 text-xs font-medium">ç­ç´šå·²æ»¿</div>' : ''}
                    </div>
                    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-100">
                        <div class="flex space-x-3">
                            <button onclick="editCourse(${course.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors">ç·¨è¼¯</button>
                            <button onclick="deleteCourse(${course.id})" class="text-red-600 hover:text-red-800 text-sm font-medium transition-colors">åˆªé™¤</button>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${enrolledStudents > 0 ? `${enrolledStudents} ä½å­¸ç”Ÿ` : 'å°šç„¡å­¸ç”Ÿ'}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            if (filteredCourses.length === 0) {
                const emptyCard = document.createElement('div');
                emptyCard.className = 'col-span-full bg-gray-50 rounded-lg p-8 text-center text-gray-500';
                emptyCard.innerHTML = `
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <p>${appData.filters.courses.search || appData.filters.courses.level ? 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„èª²ç¨‹' : 'å°šæœªæ–°å¢ä»»ä½•èª²ç¨‹'}</p>
                `;
                grid.appendChild(emptyCard);
            }
        }

        function updateStudentsTable() {
            const tableBody = document.getElementById('students-table');
            tableBody.innerHTML = '';
            
            let filteredStudents = appData.students;
            
            // æœå°‹ç¯©é¸
            if (appData.filters.students.search) {
                const search = appData.filters.students.search.toLowerCase();
                filteredStudents = filteredStudents.filter(student => 
                    student.name.toLowerCase().includes(search)
                );
            }
            
            // ç‹€æ…‹ç¯©é¸
            if (appData.filters.students.status) {
                filteredStudents = filteredStudents.filter(student => 
                    student.paymentStatus === appData.filters.students.status
                );
            }
            
            // æ’åºè™•ç†
            if (appData.sortConfig.table === 'students' && appData.sortConfig.column) {
                filteredStudents.sort((a, b) => {
                    let aValue = a[appData.sortConfig.column];
                    let bValue = b[appData.sortConfig.column];
                    
                    if (appData.sortConfig.column === 'enrollDate') {
                        aValue = new Date(aValue);
                        bValue = new Date(bValue);
                    } else if (typeof aValue === 'string') {
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                    }
                    
                    if (aValue < bValue) return appData.sortConfig.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return appData.sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            filteredStudents.forEach(student => {
                const course = appData.courses.find(c => c.id === student.courseIds[0]);
                const referrer = student.referrerTeacherId 
                    ? appData.teachers.find(t => t.id === student.referrerTeacherId)
                    : null;
                
                const paymentPercentage = Math.round((student.paidAmount / student.totalFee) * 100);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${course ? course.name : 'æœªçŸ¥èª²ç¨‹'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.totalFee.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: ${paymentPercentage}%"></div>
                        </div>
                        <div class="text-xs text-gray-500">${paymentPercentage}% (${student.paidAmount.toLocaleString()})</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(student.paymentStatus)}">
                            ${student.paymentStatus}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${referrer ? referrer.name : 'è‡ªè¡Œå ±å'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.enrollDate.toLocaleDateString('zh-TW')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editStudent(${student.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 transition-colors">ç·¨è¼¯</button>
                        <button onclick="deleteStudent(${student.id})" class="text-red-600 hover:text-red-900 transition-colors">åˆªé™¤</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            if (filteredStudents.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                        ${appData.filters.students.search || appData.filters.students.status ? 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿ' : 'å°šæœªæ–°å¢ä»»ä½•å­¸ç”Ÿ'}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        function updateAttendanceTable() {
            const tableBody = document.getElementById('attendance-table');
            tableBody.innerHTML = '';
            
            const monthInput = document.getElementById('attendance-month').value;
            const teacherFilter = document.getElementById('attendance-teacher-filter').value;
            
            let filteredAttendance = appData.attendance;
            
            // æœˆä»½ç¯©é¸
            if (monthInput) {
                const [year, month] = monthInput.split('-').map(Number);
                filteredAttendance = filteredAttendance.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === year && recordDate.getMonth() + 1 === month;
                });
            }
            
            // æ•™å¸«ç¯©é¸
            if (teacherFilter) {
                filteredAttendance = filteredAttendance.filter(record => 
                    record.teacherId === parseInt(teacherFilter)
                );
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            filteredAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredAttendance.forEach(record => {
                const teacher = appData.teachers.find(t => t.id === record.teacherId);
                const course = appData.courses.find(c => c.id === record.courseId);
                
                const statusMap = {
                    'completed': { text: 'æ­£å¸¸å®Œæˆ', color: 'bg-green-100 text-green-800' },
                    'makeup': { text: 'è£œèª²', color: 'bg-yellow-100 text-yellow-800' },
                    'cancelled': { text: 'å–æ¶ˆ', color: 'bg-red-100 text-red-800' },
                    'rescheduled': { text: 'èª¿èª²', color: 'bg-blue-100 text-blue-800' }
                };
                
                const status = statusMap[record.status] || statusMap['completed'];
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(record.date).toLocaleDateString('zh-TW')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher ? teacher.name : 'æœªçŸ¥æ•™å¸«'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${course ? course.name : 'æœªçŸ¥èª²ç¨‹'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.actualHours} å°æ™‚</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.studentCount} äºº</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${status.color}">
                            ${status.text}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.notes || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editAttendance(${record.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 transition-colors">ç·¨è¼¯</button>
                        <button onclick="deleteAttendance(${record.id})" class="text-red-600 hover:text-red-900 transition-colors">åˆªé™¤</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            if (filteredAttendance.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                        ${monthInput || teacherFilter ? 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å‡ºå‹¤ç´€éŒ„' : 'å°šæœªæ–°å¢ä»»ä½•å‡ºå‹¤ç´€éŒ„'}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        function updateAttendanceCalendar() {
            const calendar = document.getElementById('attendance-calendar');
            const monthYearDisplay = document.getElementById('calendar-month-year');
            
            const year = appData.currentCalendarDate.getFullYear();
            const month = appData.currentCalendarDate.getMonth();
            
            monthYearDisplay.textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // æ¸…ç©ºæ—¥æ›†
            calendar.innerHTML = '';
            
            // æ–°å¢æ˜ŸæœŸæ¨™é¡Œ
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center text-sm font-medium text-gray-500 p-2';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // è¨ˆç®—æœˆä»½é–‹å§‹æ—¥æœŸ
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ç”Ÿæˆæ—¥æ›†æ ¼å­
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day text-sm';
                dayElement.textContent = currentDate.getDate();
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰æœˆä»½
                if (currentDate.getMonth() !== month) {
                    dayElement.classList.add('text-gray-300');
                } else {
                    dayElement.classList.add('text-gray-700');
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰èª²ç¨‹
                const hasClass = appData.attendance.some(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.toDateString() === currentDate.toDateString();
                });
                
                if (hasClass) {
                    dayElement.classList.add('has-class');
                }
                
                // ä»Šå¤©ç‰¹æ®Šæ¨™è¨˜
                if (currentDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('bg-blue-600', 'text-white');
                }
                
                dayElement.addEventListener('click', () => {
                    showDayAttendance(currentDate);
                });
                
                calendar.appendChild(dayElement);
            }
        }

        function updateSalaryTeacherSelect() {
            const select = document.getElementById('salary-teacher');
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ•™å¸«</option>';
            
            appData.teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                select.appendChild(option);
            });
        }

        function updateCourseSelects() {
            const selects = document.querySelectorAll('#student-course, #attendance-course');
            selects.forEach(select => {
                select.innerHTML = '<option value="">è«‹é¸æ“‡èª²ç¨‹</option>';
                appData.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    select.appendChild(option);
                });
            });
        }

        function updateTeacherSelects() {
            const selects = document.querySelectorAll('#student-referrer, #attendance-teacher, #attendance-teacher-filter');
            selects.forEach(select => {
                const isFilter = select.id === 'attendance-teacher-filter';
                select.innerHTML = isFilter ? '<option value="">æ‰€æœ‰æ•™å¸«</option>' : '<option value="">è‡ªè¡Œå ±å</option>';
                
                appData.teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.name;
                    select.appendChild(option);
                });
            });
        }

        // ===== è–ªè³‡è¨ˆç®—åŠŸèƒ½ =====
        
        function calculateSalary() {
            const teacherId = parseInt(document.getElementById('salary-teacher').value);
            const month = document.getElementById('salary-month').value;
            
            if (!teacherId || !month) {
                showNotification('è«‹é¸æ“‡æ•™å¸«å’Œè¨ˆç®—æœˆä»½', 'error');
                return;
            }
            
            showLoading(true);
            
            setTimeout(() => {
                const result = performSalaryCalculation(teacherId, month);
                displaySalaryResult(result);
                document.getElementById('salary-result').classList.remove('hidden');
                showLoading(false);
                showNotification('è–ªè³‡è¨ˆç®—å®Œæˆ');
            }, 800);
        }

        function calculateAllSalaries() {
            const month = document.getElementById('salary-month').value;
            
            if (!month) {
                showNotification('è«‹é¸æ“‡è¨ˆç®—æœˆä»½', 'error');
                return;
            }
            
            showLoading(true);
            
            setTimeout(() => {
                const allResults = [];
                let totalBasic = 0, totalRecruitment = 0, totalPerformance = 0;
                
                appData.teachers.forEach(teacher => {
                    const result = performSalaryCalculation(teacher.id, month);
                    allResults.push(result);
                    totalBasic += result.basicSalary;
                    totalRecruitment += result.recruitmentBonus;
                    totalPerformance += result.performanceBonus;
                });
                
                displayAllSalariesResult(allResults, {
                    totalBasic,
                    totalRecruitment,
                    totalPerformance,
                    grandTotal: totalBasic + totalRecruitment + totalPerformance
                });
                
                document.getElementById('all-salaries-result').classList.remove('hidden');
                showLoading(false);
                showNotification('å…¨é«”è–ªè³‡è¨ˆç®—å®Œæˆ');
            }, 1200);
        }

        function performSalaryCalculation(teacherId, month) {
            const teacher = appData.teachers.find(t => t.id === teacherId);
            const [year, monthNum] = month.split('-').map(Number);
            
            // å–å¾—è©²æœˆä»½çš„ä¸Šèª²ç´€éŒ„
            const attendanceRecords = appData.attendance.filter(record => {
                const recordDate = new Date(record.date);
                return record.teacherId === teacherId && 
                       recordDate.getFullYear() === year && 
                       recordDate.getMonth() + 1 === monthNum &&
                       record.isCompleted;
            });
            
            // è¨ˆç®—åŸºæœ¬è–ªè³‡
            let totalHours = 0;
            let basicSalary = 0;
            const courseBreakdown = {};
            
            attendanceRecords.forEach(record => {
                const course = appData.courses.find(c => c.id === record.courseId);
                const rate = course ? course.standardRate : teacher.hourlyRate;
                
                if (!courseBreakdown[record.courseId]) {
                    courseBreakdown[record.courseId] = {
                        name: course ? course.name : 'æœªçŸ¥èª²ç¨‹',
                        hours: 0,
                        rate: rate,
                        subtotal: 0
                    };
                }
                
                courseBreakdown[record.courseId].hours += record.actualHours;
                totalHours += record.actualHours;
            });
            
            // è¨ˆç®—å„èª²ç¨‹å°è¨ˆ
            Object.values(courseBreakdown).forEach(breakdown => {
                breakdown.subtotal = breakdown.hours * breakdown.rate;
                basicSalary += breakdown.subtotal;
            });
            
            // è¨ˆç®—æ‹›ç”Ÿçé‡‘
            const newStudents = appData.students.filter(student => {
                const enrollDate = new Date(student.enrollDate);
                return student.referrerTeacherId === teacherId &&
                       enrollDate.getFullYear() === year &&
                       enrollDate.getMonth() + 1 === monthNum;
            });
            
            let recruitmentBonus = 0;
            const recruitmentBreakdown = [];
            newStudents.forEach(student => {
                const bonus = student.totalFee * (teacher.recruitmentBonusRate / 100);
                recruitmentBonus += bonus;
                recruitmentBreakdown.push({
                    studentName: student.name,
                    studentFee: student.totalFee,
                    bonusAmount: bonus
                });
            });
            
            // è¨ˆç®—ç¸¾æ•ˆçé‡‘
            const levelMultiplier = {
                'æ–°é€²': 0.00,
                'ä¸€èˆ¬': 0.05,
                'è³‡æ·±': 0.10,
                'åå¸«': 0.15
            };
            
            const performanceRate = levelMultiplier[teacher.performanceLevel] || 0;
            let performanceBonus = Math.round(basicSalary * performanceRate);
            
            // å‡ºå¸­ç‡èª¿æ•´
            const attendanceRate = attendanceRecords.length > 0 ? 
                attendanceRecords.filter(r => r.isCompleted).length / attendanceRecords.length : 1;
            
            if (attendanceRate >= 0.95) {
                performanceBonus = Math.round(performanceBonus * 1.2);
            } else if (attendanceRate >= 0.90) {
                performanceBonus = Math.round(performanceBonus * 1.1);
            } else if (attendanceRate < 0.80) {
                performanceBonus = Math.round(performanceBonus * 0.8);
            }
            
            const totalSalary = basicSalary + recruitmentBonus + performanceBonus;
            
            return {
                teacherId,
                teacherName: teacher.name,
                month,
                basicSalary,
                recruitmentBonus,
                performanceBonus,
                totalHours,
                totalSalary,
                performanceRate: performanceRate * 100,
                courseBreakdown: Object.values(courseBreakdown),
                recruitmentBreakdown,
                attendanceRate: Math.round(attendanceRate * 100)
            };
        }

        function displaySalaryResult(result) {
            document.getElementById('basic-salary').textContent = `${result.basicSalary.toLocaleString()}`;
            document.getElementById('basic-hours').textContent = `${result.totalHours} å°æ™‚`;
            document.getElementById('recruitment-bonus').textContent = `${result.recruitmentBonus.toLocaleString()}`;
            document.getElementById('recruitment-count').textContent = `${result.recruitmentBreakdown.length} ä½æ–°ç”Ÿ`;
            document.getElementById('performance-bonus').textContent = `${result.performanceBonus.toLocaleString()}`;
            document.getElementById('performance-rate').textContent = `${result.performanceRate}% çé‡‘ç‡`;
            document.getElementById('total-salary').textContent = `${result.totalSalary.toLocaleString()}`;
            document.getElementById('salary-teacher-name').textContent = result.teacherName;
            
            // æ›´æ–°èª²ç¨‹æ˜ç´°
            const courseBreakdownEl = document.getElementById('course-breakdown');
            courseBreakdownEl.innerHTML = '';
            
            if (result.courseBreakdown.length > 0) {
                result.courseBreakdown.forEach(breakdown => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded border';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium text-gray-900">${breakdown.name}</div>
                            <div class="text-sm text-gray-500">${breakdown.hours}å°æ™‚ Ã— ${breakdown.rate}</div>
                        </div>
                        <div class="text-lg font-bold text-primary">${breakdown.subtotal.toLocaleString()}</div>
                    `;
                    courseBreakdownEl.appendChild(div);
                });
            } else {
                courseBreakdownEl.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">æœ¬æœˆç„¡ä¸Šèª²ç´€éŒ„</p>';
            }
            
            // æ›´æ–°æ‹›ç”Ÿæ˜ç´°
            const recruitmentBreakdownEl = document.getElementById('recruitment-breakdown');
            recruitmentBreakdownEl.innerHTML = '';
            
            if (result.recruitmentBreakdown.length > 0) {
                result.recruitmentBreakdown.forEach(breakdown => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded border';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium text-gray-900">${breakdown.studentName}</div>
                            <div class="text-sm text-gray-500">å­¸è²» ${breakdown.studentFee.toLocaleString()}</div>
                        </div>
                        <div class="text-lg font-bold text-secondary">${breakdown.bonusAmount.toLocaleString()}</div>
                    `;
                    recruitmentBreakdownEl.appendChild(div);
                });
            } else {
                recruitmentBreakdownEl.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">æœ¬æœˆç„¡æ–°å¢å­¸ç”Ÿ</p>';
            }
        }

        function displayAllSalariesResult(results, totals) {
            const tableBody = document.getElementById('all-salaries-table');
            tableBody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.teacherName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.basicSalary.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.recruitmentBonus.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.performanceBonus.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.totalSalary.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showIndividualSalary(${result.teacherId})" class="text-blue-600 hover:text-blue-800">æŸ¥çœ‹æ˜ç´°</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // æ›´æ–°ç¸½è¨ˆ
            document.getElementById('total-basic-salary').textContent = `${totals.totalBasic.toLocaleString()}`;
            document.getElementById('total-recruitment-bonus').textContent = `${totals.totalRecruitment.toLocaleString()}`;
            document.getElementById('total-performance-bonus').textContent = `${totals.totalPerformance.toLocaleString()}`;
            document.getElementById('grand-total-salary').textContent = `${totals.grandTotal.toLocaleString()}`;
        }

        // ===== æ¨¡æ…‹æ¡†èˆ‡UIæ§åˆ¶ =====
        
        function showSection(sectionName) {
            // éš±è—æ‰€æœ‰å€æ®µ
            const sections = document.querySelectorAll('.section-content');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„å€æ®µ
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                appData.currentSection = sectionName;
            }
        }

        function showAddTeacherModal() {
            resetTeacherForm();
            document.getElementById('teacher-modal-title').textContent = 'æ–°å¢æ•™å¸«';
            document.getElementById('teacher-submit-text').textContent = 'æ–°å¢';
            document.getElementById('teacher-modal').classList.remove('hidden');
            document.getElementById('teacher-modal').classList.add('flex');
        }

        function showAddCourseModal() {
            resetCourseForm();
            document.getElementById('course-modal-title').textContent = 'æ–°å¢èª²ç¨‹';
            document.getElementById('course-submit-text').textContent = 'æ–°å¢';
            document.getElementById('course-modal').classList.remove('hidden');
            document.getElementById('course-modal').classList.add('flex');
        }

        function showAddStudentModal() {
            resetStudentForm();
            updateCourseSelects();
            updateTeacherSelects();
            document.getElementById('student-modal-title').textContent = 'æ–°å¢å­¸ç”Ÿ';
            document.getElementById('student-submit-text').textContent = 'æ–°å¢';
            document.getElementById('student-modal').classList.remove('hidden');
            document.getElementById('student-modal').classList.add('flex');
        }

        function showAddAttendanceModal() {
            resetAttendanceForm();
            updateTeacherSelects();
            updateCourseSelects();
            document.getElementById('attendance-modal-title').textContent = 'æ–°å¢å‡ºå‹¤ç´€éŒ„';
            document.getElementById('attendance-submit-text').textContent = 'æ–°å¢';
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-modal').classList.remove('hidden');
            document.getElementById('attendance-modal').classList.add('flex');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        // ===== ç·¨è¼¯åŠŸèƒ½ =====
        
        function editTeacher(id) {
            const teacher = appData.teachers.find(t => t.id === id);
            if (!teacher) return;
            
            document.getElementById('teacher-id').value = teacher.id;
            document.getElementById('teacher-name').value = teacher.name;
            document.getElementById('teacher-subject').value = teacher.subject;
            document.getElementById('teacher-rate').value = teacher.hourlyRate;
            document.getElementById('teacher-level').value = teacher.performanceLevel;
            document.getElementById('teacher-bonus-rate').value = teacher.recruitmentBonusRate;
            document.getElementById('teacher-contact').value = teacher.contactInfo;
            
            document.getElementById('teacher-modal-title').textContent = 'ç·¨è¼¯æ•™å¸«';
            document.getElementById('teacher-submit-text').textContent = 'æ›´æ–°';
            document.getElementById('teacher-modal').classList.remove('hidden');
            document.getElementById('teacher-modal').classList.add('flex');
        }

        function editCourse(id) {
            const course = appData.courses.find(c => c.id === id);
            if (!course) return;
            
            document.getElementById('course-id').value = course.id;
            document.getElementById('course-name').value = course.name;
            document.getElementById('course-level').value = course.level;
            document.getElementById('course-subject').value = course.subject;
            document.getElementById('course-rate').value = course.standardRate;
            document.getElementById('course-duration').value = course.duration;
            document.getElementById('course-max-students').value = course.maxStudents || '';
            
            document.getElementById('course-modal-title').textContent = 'ç·¨è¼¯èª²ç¨‹';
            document.getElementById('course-submit-text').textContent = 'æ›´æ–°';
            document.getElementById('course-modal').classList.remove('hidden');
            document.getElementById('course-modal').classList.add('flex');
        }

        function editStudent(id) {
            const student = appData.students.find(s => s.id === id);
            if (!student) return;
            
            updateCourseSelects();
            updateTeacherSelects();
            
            document.getElementById('student-id').value = student.id;
            document.getElementById('student-name').value = student.name;
            document.getElementById('student-course').value = student.courseIds[0];
            document.getElementById('student-fee').value = student.totalFee;
            document.getElementById('student-paid').value = student.paidAmount;
            document.getElementById('student-status').value = student.paymentStatus;
            document.getElementById('student-referrer').value = student.referrerTeacherId || '';
            document.getElementById('student-contact').value = student.contactInfo;
            
            document.getElementById('student-modal-title').textContent = 'ç·¨è¼¯å­¸ç”Ÿ';
            document.getElementById('student-submit-text').textContent = 'æ›´æ–°';
            document.getElementById('student-modal').classList.remove('hidden');
            document.getElementById('student-modal').classList.add('flex');
        }

        function editAttendance(id) {
            const attendance = appData.attendance.find(a => a.id === id);
            if (!attendance) return;
            
            updateTeacherSelects();
            updateCourseSelects();
            
            document.getElementById('attendance-id').value = attendance.id;
            document.getElementById('attendance-date').value = new Date(attendance.date).toISOString().split('T')[0];
            document.getElementById('attendance-teacher').value = attendance.teacherId;
            document.getElementById('attendance-course').value = attendance.courseId;
            document.getElementById('attendance-hours').value = attendance.actualHours;
            document.getElementById('attendance-students').value = attendance.studentCount;
            document.getElementById('attendance-status').value = attendance.status || 'completed';
            document.getElementById('attendance-notes').value = attendance.notes;
            
            document.getElementById('attendance-modal-title').textContent = 'ç·¨è¼¯å‡ºå‹¤ç´€éŒ„';
            document.getElementById('attendance-submit-text').textContent = 'æ›´æ–°';
            document.getElementById('attendance-modal').classList.remove('hidden');
            document.getElementById('attendance-modal').classList.add('flex');
        }

        // ===== åˆªé™¤åŠŸèƒ½ =====
        
        function deleteTeacher(id) {
            const teacher = appData.teachers.find(t => t.id === id);
            if (!teacher) return;
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤æ•™å¸«ã€Œ${teacher.name}ã€å—ï¼Ÿ\n\næ³¨æ„ï¼šé€™æœƒåŒæ™‚åˆªé™¤ç›¸é—œçš„å‡ºå‹¤ç´€éŒ„ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                // åˆªé™¤ç›¸é—œå‡ºå‹¤ç´€éŒ„
                appData.attendance = appData.attendance.filter(a => a.teacherId !== id);
                
                // æ¸…é™¤å­¸ç”Ÿçš„ä»‹ç´¹äººé—œè¯
                appData.students.forEach(student => {
                    if (student.referrerTeacherId === id) {
                        student.referrerTeacherId = null;
                    }
                });
                
                // åˆªé™¤æ•™å¸«
                appData.teachers = appData.teachers.filter(t => t.id !== id);
                
                saveDataToStorage();
                updateAllDisplays();
                showNotification(`æ•™å¸«ã€Œ${teacher.name}ã€å·²åˆªé™¤`);
            }
        }

        function deleteCourse(id) {
            const course = appData.courses.find(c => c.id === id);
            if (!course) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿå ±è®€æ­¤èª²ç¨‹
            const enrolledStudents = appData.students.filter(s => s.courseIds.includes(id));
            
            if (enrolledStudents.length > 0) {
                showNotification(`ç„¡æ³•åˆªé™¤èª²ç¨‹ã€Œ${course.name}ã€ï¼Œä»æœ‰ ${enrolledStudents.length} ä½å­¸ç”Ÿå ±è®€æ­¤èª²ç¨‹`, 'error');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤èª²ç¨‹ã€Œ${course.name}ã€å—ï¼Ÿ\n\né€™æœƒåŒæ™‚åˆªé™¤ç›¸é—œçš„å‡ºå‹¤ç´€éŒ„ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                // åˆªé™¤ç›¸é—œå‡ºå‹¤ç´€éŒ„
                appData.attendance = appData.attendance.filter(a => a.courseId !== id);
                
                // åˆªé™¤èª²ç¨‹
                appData.courses = appData.courses.filter(c => c.id !== id);
                
                saveDataToStorage();
                updateAllDisplays();
                showNotification(`èª²ç¨‹ã€Œ${course.name}ã€å·²åˆªé™¤`);
            }
        }

        function deleteStudent(id) {
            const student = appData.students.find(s => s.id === id);
            if (!student) return;
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${student.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                appData.students = appData.students.filter(s => s.id !== id);
                saveDataToStorage();
                updateAllDisplays();
                showNotification(`å­¸ç”Ÿã€Œ${student.name}ã€å·²åˆªé™¤`);
            }
        }

        function deleteAttendance(id) {
            const attendance = appData.attendance.find(a => a.id === id);
            if (!attendance) return;
            
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å‡ºå‹¤ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                appData.attendance = appData.attendance.filter(a => a.id !== id);
                saveDataToStorage();
                updateAttendanceTable();
                updateAttendanceCalendar();
                updateCounters();
                showNotification('å‡ºå‹¤ç´€éŒ„å·²åˆªé™¤');
            }
        }

        // ===== è¡¨å–®é‡ç½®åŠŸèƒ½ =====
        
        function resetTeacherForm() {
            document.getElementById('teacher-form').reset();
            document.getElementById('teacher-id').value = '';
        }

        function resetCourseForm() {
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
        }

        function resetStudentForm() {
            document.getElementById('student-form').reset();
            document.getElementById('student-id').value = '';
        }

        function resetAttendanceForm() {
            document.getElementById('attendance-form').reset();
            document.getElementById('attendance-id').value = '';
        }

        // ===== æ’åºåŠŸèƒ½ =====
        
        function sortTable(table, column) {
            const currentSort = appData.sortConfig;
            
            if (currentSort.table === table && currentSort.column === column) {
                // åˆ‡æ›æ’åºæ–¹å‘
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // æ–°çš„æ’åºæ¬„ä½
                currentSort.table = table;
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // æ›´æ–°æ’åºåœ–æ¨™
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = 'â†‘';
                icon.classList.remove('desc');
            });
            
            const activeIcon = event.target.querySelector('.sort-icon');
            if (activeIcon) {
                if (currentSort.direction === 'desc') {
                    activeIcon.classList.add('desc');
                }
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            if (table === 'teachers') {
                updateTeachersTable();
            } else if (table === 'students') {
                updateStudentsTable();
            }
        }

        // ===== æ—¥æ›†åŠŸèƒ½ =====
        
        function previousMonth() {
            appData.currentCalendarDate.setMonth(appData.currentCalendarDate.getMonth() - 1);
            updateAttendanceCalendar();
        }

        function nextMonth() {
            appData.currentCalendarDate.setMonth(appData.currentCalendarDate.getMonth() + 1);
            updateAttendanceCalendar();
        }

        function showDayAttendance(date) {
            const dayAttendance = appData.attendance.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.toDateString() === date.toDateString();
            });
            
            if (dayAttendance.length === 0) {
                showNotification(`${date.toLocaleDateString('zh-TW')} ç„¡èª²ç¨‹å®‰æ’`, 'info');
                return;
            }
            
            let message = `${date.toLocaleDateString('zh-TW')} èª²ç¨‹å®‰æ’ï¼š\n\n`;
            dayAttendance.forEach(record => {
                const teacher = appData.teachers.find(t => t.id === record.teacherId);
                const course = appData.courses.find(c => c.id === record.courseId);
                message += `â€¢ ${teacher?.name || 'æœªçŸ¥æ•™å¸«'} - ${course?.name || 'æœªçŸ¥èª²ç¨‹'}\n`;
                message += `  æ™‚æ•¸ï¼š${record.actualHours}å°æ™‚ï¼Œå­¸ç”Ÿï¼š${record.studentCount}äºº\n`;
                if (record.notes) {
                    message += `  å‚™è¨»ï¼š${record.notes}\n`;
                }
                message += '\n';
            });
            
            alert(message);
        }

        // ===== å ±è¡¨åŠŸèƒ½ =====
        
        function showReportsModal() {
            updateFinancialReport();
            document.getElementById('reports-modal').classList.remove('hidden');
            document.getElementById('reports-modal').classList.add('flex');
        }

        function showReportTab(tabName) {
            // åˆ‡æ›é¸é …å¡
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åˆ‡æ›å…§å®¹
            document.querySelectorAll('.report-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + '-report').classList.remove('hidden');
            
            // è¼‰å…¥å°æ‡‰å ±è¡¨
            if (tabName === 'financial') {
                updateFinancialReport();
            } else if (tabName === 'performance') {
                updatePerformanceReport();
            } else if (tabName === 'attendance') {
                updateAttendanceReport();
            }
        }

        function updateFinancialReport() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // è¨ˆç®—æœ¬æœˆæ”¶å…¥ï¼ˆå­¸è²»ï¼‰
            const monthlyIncome = appData.students
                .filter(student => {
                    const enrollDate = new Date(student.enrollDate);
                    return enrollDate.getMonth() === currentMonth && 
                           enrollDate.getFullYear() === currentYear;
                })
                .reduce((sum, student) => sum + student.paidAmount, 0);
            
            // è¨ˆç®—æœ¬æœˆæ”¯å‡ºï¼ˆè–ªè³‡ï¼‰
            let monthlyExpense = 0;
            appData.teachers.forEach(teacher => {
                const result = performSalaryCalculation(teacher.id, `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`);
                monthlyExpense += result.totalSalary;
            });
            
            const netProfit = monthlyIncome - monthlyExpense;
            
            document.getElementById('total-income').textContent = `${monthlyIncome.toLocaleString()}`;
            document.getElementById('total-expense').textContent = `${monthlyExpense.toLocaleString()}`;
            document.getElementById('net-profit').textContent = `${netProfit.toLocaleString()}`;
            
            // ç¹ªè£½åœ–è¡¨
            const ctx = document.getElementById('financial-chart').getContext('2d');
            
            if (financialChart) {
                financialChart.destroy();
            }
            
            financialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æ”¶å…¥', 'æ”¯å‡º', 'æ·¨åˆ©'],
                    datasets: [{
                        label: 'é‡‘é¡ (å…ƒ)',
                        data: [monthlyIncome, monthlyExpense, netProfit],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.6)',
                            'rgba(239, 68, 68, 0.6)',
                            'rgba(16, 185, 129, 0.6)'
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(16, 185, 129, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updatePerformanceReport() {
            const currentDate = new Date();
            const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            
            const teacherPerformance = appData.teachers.map(teacher => {
                const result = performSalaryCalculation(teacher.id, currentMonth);
                return {
                    name: teacher.name,
                    totalSalary: result.totalSalary,
                    totalHours: result.totalHours,
                    newStudents: result.recruitmentBreakdown.length
                };
            });
            
            teacherPerformance.sort((a, b) => b.totalSalary - a.totalSalary);
            
            const performanceList = document.getElementById('teacher-performance-list');
            performanceList.innerHTML = '';
            
            teacherPerformance.forEach((teacher, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-white rounded border';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-sm font-bold text-blue-600">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium">${teacher.name}</div>
                            <div class="text-sm text-gray-500">${teacher.totalHours}å°æ™‚ â€¢ ${teacher.newStudents}ä½æ–°ç”Ÿ</div>
                        </div>
                    </div>
                    <div class="text-lg font-bold text-gray-900">${teacher.totalSalary.toLocaleString()}</div>
                `;
                performanceList.appendChild(div);
            });
        }

        function updateAttendanceReport() {
            // èª²ç¨‹å‡ºå‹¤ç‡çµ±è¨ˆ
            const courseAttendance = {};
            appData.courses.forEach(course => {
                const courseRecords = appData.attendance.filter(a => a.courseId === course.id);
                const completedRecords = courseRecords.filter(a => a.isCompleted);
                const rate = courseRecords.length > 0 ? (completedRecords.length / courseRecords.length) * 100 : 0;
                
                courseAttendance[course.id] = {
                    name: course.name,
                    total: courseRecords.length,
                    completed: completedRecords.length,
                    rate: Math.round(rate)
                };
            });
            
            const courseList = document.getElementById('course-attendance-list');
            courseList.innerHTML = '';
            
            Object.values(courseAttendance)
                .sort((a, b) => b.rate - a.rate)
                .forEach(course => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-white rounded border';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium">${course.name}</div>
                            <div class="text-sm text-gray-500">${course.completed}/${course.total} å ‚èª²å®Œæˆ</div>
                        </div>
                        <div class="text-lg font-bold ${course.rate >= 90 ? 'text-green-600' : course.rate >= 70 ? 'text-yellow-600' : 'text-red-600'}">
                            ${course.rate}%
                        </div>
                    `;
                    courseList.appendChild(div);
                });
            
            // æ•™å¸«å‡ºå‹¤çµ±è¨ˆ
            const teacherAttendance = {};
            appData.teachers.forEach(teacher => {
                const teacherRecords = appData.attendance.filter(a => a.teacherId === teacher.id);
                const totalHours = teacherRecords.reduce((sum, record) => sum + record.actualHours, 0);
                
                teacherAttendance[teacher.id] = {
                    name: teacher.name,
                    totalClasses: teacherRecords.length,
                    totalHours: totalHours
                };
            });
            
            const teacherList = document.getElementById('teacher-attendance-list');
            teacherList.innerHTML = '';
            
            Object.values(teacherAttendance)
                .sort((a, b) => b.totalHours - a.totalHours)
                .forEach(teacher => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-white rounded border';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium">${teacher.name}</div>
                            <div class="text-sm text-gray-500">${teacher.totalClasses} å ‚èª²</div>
                        </div>
                        <div class="text-lg font-bold text-blue-600">${teacher.totalHours}h</div>
                    `;
                    teacherList.appendChild(div);
                });
        }

        // ===== å‚™ä»½èˆ‡é‚„åŸåŠŸèƒ½ =====
        
        function showBackupModal() {
            document.getElementById('backup-modal').classList.remove('hidden');
            document.getElementById('backup-modal').classList.add('flex');
        }

        function exportData() {
            const exportData = {
                teachers: appData.teachers,
                courses: appData.courses,
                students: appData.students,
                attendance: appData.attendance,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è£œç¿’ç­è³‡æ–™å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('è³‡æ–™å·²åŒ¯å‡ºè‡³ä¸‹è¼‰è³‡æ–™å¤¾');
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('è«‹é¸æ“‡è¦åŒ¯å…¥çš„æª”æ¡ˆ', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // é©—è­‰è³‡æ–™æ ¼å¼
                    if (!importedData.teachers || !importedData.courses || !importedData.students || !importedData.attendance) {
                        throw new Error('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                    }
                    
                    if (confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿé€™æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è³‡æ–™ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                        // è½‰æ›æ—¥æœŸå­—ä¸²å› Date ç‰©ä»¶
                        importedData.students.forEach(student => {
                            if (student.enrollDate) {
                                student.enrollDate = new Date(student.enrollDate);
                            }
                        });
                        
                        importedData.attendance.forEach(record => {
                            if (record.date) {
                                record.date = new Date(record.date);
                            }
                        });
                        
                        // æ›¿æ›è³‡æ–™
                        appData.teachers = importedData.teachers;
                        appData.courses = importedData.courses;
                        appData.students = importedData.students;
                        appData.attendance = importedData.attendance;
                        
                        saveDataToStorage();
                        updateAllDisplays();
                        hideModal('backup-modal');
                        
                        showNotification('è³‡æ–™åŒ¯å…¥æˆåŠŸ');
                    }
                } catch (error) {
                    showNotification('åŒ¯å…¥å¤±æ•—ï¼š' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function resetAllData() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰æ•™å¸«ã€èª²ç¨‹ã€å­¸ç”Ÿå’Œå‡ºå‹¤è³‡æ–™ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                localStorage.clear();
                appData = { 
                    teachers: [], 
                    courses: [], 
                    students: [], 
                    attendance: [],
                    currentSection: null,
                    sortConfig: { table: null, column: null, direction: 'asc' },
                    currentCalendarDate: new Date(),
                    filters: {
                        teachers: { search: '', level: '' },
                        courses: { search: '', level: '' },
                        students: { search: '', status: '' }
                    }
                };
                initializeDefaultData();
                updateAllDisplays();
                hideModal('backup-modal');
                showNotification('è³‡æ–™å·²é‡ç½®ç‚ºé è¨­ç‹€æ…‹');
            }
        }

        // ===== è¼”åŠ©åŠŸèƒ½ =====
        
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = timeString;
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
                loading.classList.add('flex');
            } else {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            const notificationIcon = document.getElementById('notification-icon');
            const notificationEl = notification.querySelector('.border-l-4');
            
            notificationText.textContent = message;
            
            // è¨­å®šé€šçŸ¥æ¨£å¼
            notificationEl.className = 'bg-white border-l-4 p-4 shadow-lg rounded';
            
            if (type === 'success') {
                notificationEl.classList.add('border-green-400');
                notificationIcon.className = 'h-5 w-5 text-green-400';
                notificationIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>';
            } else if (type === 'error') {
                notificationEl.classList.add('border-red-400');
                notificationIcon.className = 'h-5 w-5 text-red-400';
                notificationIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>';
            } else if (type === 'info') {
                notificationEl.classList.add('border-blue-400');
                notificationIcon.className = 'h-5 w-5 text-blue-400';
                notificationIcon.innerHTML = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                hideNotification();
            }, 4000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        function getLevelColor(level) {
            const colors = {
                'æ–°é€²': 'bg-gray-100 text-gray-800',
                'ä¸€èˆ¬': 'bg-blue-100 text-blue-800',
                'è³‡æ·±': 'bg-green-100 text-green-800',
                'åå¸«': 'bg-purple-100 text-purple-800'
            };
            return colors[level] || 'bg-gray-100 text-gray-800';
        }

        function getStatusColor(status) {
            const colors = {
                'å·²ç¹³è²»': 'bg-green-100 text-green-800',
                'æœªç¹³è²»': 'bg-red-100 text-red-800',
                'éƒ¨åˆ†ç¹³è²»': 'bg-yellow-100 text-yellow-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function showIndividualSalary(teacherId) {
            document.getElementById('salary-teacher').value = teacherId;
            calculateSalary();
            showSection('salary');
        }

        function printSalarySlip() {
            const teacherName = document.getElementById('salary-teacher-name').textContent;
            const month = document.getElementById('salary-month').value;
            
            if (!teacherName) {
                showNotification('è«‹å…ˆè¨ˆç®—è–ªè³‡', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const salaryContent = document.getElementById('salary-result').innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>è–ªè³‡å–® - ${teacherName} (${month})</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .salary-details { margin: 20px 0; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>è£œç¿’ç­è–ªè³‡å–®</h1>
                        <h2>${teacherName} - ${month}</h2>
                    </div>
                    <div class="salary-details">
                        ${salaryContent}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function exportSalaryPDF() {
            showNotification('PDF åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹ä½¿ç”¨åˆ—å°åŠŸèƒ½', 'info');
        }
    </script>
</body>
</html>