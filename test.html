<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>補習班薪資管理系統 - 專業版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background-color: #3B82F6;
            color: white;
        }

        .attendance-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background-color: #f3f4f6;
        }

        .calendar-day.has-class {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        .calendar-day.selected {
            background-color: #3b82f6;
            color: white;
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
        }

        .sortable-header:hover {
            background-color: #f9fafb;
        }

        .sort-icon {
            transition: transform 0.2s ease;
        }

        .sort-icon.desc {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 通知訊息 -->
    <div id="notification" class="notification">
        <div class="bg-white border-l-4 p-4 shadow-lg rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg id="notification-icon" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"></svg>
                </div>
                <div class="ml-3">
                    <p id="notification-text" class="text-sm text-gray-700"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 頂部導航欄 -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-white text-xl font-bold">📚 補習班薪資管理系統</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-sm bg-white bg-opacity-20 px-3 py-1 rounded">
                        <span id="current-time"></span>
                    </div>
                    <button onclick="showBackupModal()" class="text-white hover:text-gray-200 transition-colors" title="備份與還原">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </button>
                    <button onclick="showReportsModal()" class="text-white hover:text-gray-200 transition-colors" title="報表分析">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </button>
                    <button onclick="resetAllData()" class="text-white hover:text-gray-200 transition-colors px-3 py-1 border border-white rounded" title="重置資料">
                        重置
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容區域 -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- 功能選單 -->
        <div class="px-4 py-6 sm:px-0">
            <!-- 儀表板統計 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('teachers')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">👨‍🏫</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">教師管理</h3>
                                <p class="text-sm text-gray-500" id="teacher-count">載入中...</p>
                                <p class="text-xs text-gray-400" id="teacher-avg-rate">平均鐘點費: 計算中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('courses')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">📖</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">課程管理</h3>
                                <p class="text-sm text-gray-500" id="course-count">載入中...</p>
                                <p class="text-xs text-gray-400" id="course-avg-rate">平均費率: 計算中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('students')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">👨‍🎓</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">學生管理</h3>
                                <p class="text-sm text-gray-500" id="student-count">載入中...</p>
                                <p class="text-xs text-gray-400" id="payment-rate">繳費率: 計算中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('attendance')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">📅</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">出勤管理</h3>
                                <p class="text-sm text-gray-500" id="attendance-count">載入中...</p>
                                <p class="text-xs text-gray-400" id="attendance-rate">出席率: 計算中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover cursor-pointer" onclick="showSection('salary')">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">💰</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">薪資計算</h3>
                                <p class="text-sm text-gray-500">即時計算</p>
                                <p class="text-xs text-gray-400" id="total-salary-month">本月總支出: 計算中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 教師管理區域 -->
            <div id="teachers-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900">教師管理</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="relative">
                                <input type="text" id="teacher-search" placeholder="搜尋教師姓名或科目" 
                                       class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <select id="teacher-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">所有等級</option>
                                <option value="新進">新進</option>
                                <option value="一般">一般</option>
                                <option value="資深">資深</option>
                                <option value="名師">名師</option>
                            </select>
                            <button onclick="showAddTeacherModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors whitespace-nowrap">
                                + 新增教師
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('teachers', 'name')">
                                        姓名 <span class="sort-icon">↑</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('teachers', 'subject')">
                                        專長科目 <span class="sort-icon">↑</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('teachers', 'hourlyRate')">
                                        鐘點費 <span class="sort-icon">↑</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('teachers', 'performanceLevel')">
                                        績效等級 <span class="sort-icon">↑</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">招生獎金率</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">聯絡資訊</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="teachers-table" class="bg-white divide-y divide-gray-200">
                                <!-- 教師資料將動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 課程管理區域 -->
            <div id="courses-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900">課程管理</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="relative">
                                <input type="text" id="course-search" placeholder="搜尋課程名稱或科目" 
                                       class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <select id="course-level-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">所有級別</option>
                                <option value="國小">國小</option>
                                <option value="國中">國中</option>
                                <option value="高中">高中</option>
                                <option value="成人">成人</option>
                            </select>
                            <button onclick="showAddCourseModal()" class="bg-secondary text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors whitespace-nowrap">
                                + 新增課程
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="courses-grid">
                        <!-- 課程卡片將動態載入 -->
                    </div>
                </div>
            </div>

            <!-- 學生管理區域 -->
            <div id="students-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900">學生管理</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="relative">
                                <input type="text" id="student-search" placeholder="搜尋學生姓名" 
                                       class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <select id="student-status-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">所有狀態</option>
                                <option value="已繳費">已繳費</option>
                                <option value="部分繳費">部分繳費</option>
                                <option value="未繳費">未繳費</option>
                            </select>
                            <button onclick="showAddStudentModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors whitespace-nowrap">
                                + 新增學生
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('students', 'name')">
                                        學生姓名 <span class="sort-icon">↑</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">就讀課程</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('students', 'totalFee')">
                                        學費 <span class="sort-icon">↑</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">繳費進度</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">繳費狀態</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">介紹人</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="sortTable('students', 'enrollDate')">
                                        報名日期 <span class="sort-icon">↑</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="students-table" class="bg-white divide-y divide-gray-200">
                                <!-- 學生資料將動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 出勤管理區域 -->
            <div id="attendance-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900">出勤管理</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <input type="month" id="attendance-month" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <select id="attendance-teacher-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">所有教師</option>
                            </select>
                            <button onclick="showAddAttendanceModal()" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors whitespace-nowrap">
                                + 新增紀錄
                            </button>
                        </div>
                    </div>

                    <!-- 出勤日曆檢視 -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">月曆檢視</h3>
                            <div class="flex space-x-2">
                                <button onclick="previousMonth()" class="p-2 text-gray-500 hover:text-gray-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <span id="calendar-month-year" class="text-lg font-medium px-4 py-2"></span>
                                <button onclick="nextMonth()" class="p-2 text-gray-500 hover:text-gray-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="attendance-calendar" id="attendance-calendar">
                            <!-- 日曆將動態生成 -->
                        </div>
                    </div>

                    <!-- 出勤紀錄表格 -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">教師</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">課程</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時數</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">學生數</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table" class="bg-white divide-y divide-gray-200">
                                <!-- 出勤紀錄將動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 薪資計算區域 -->
            <div id="salary-section" class="section-content fade-in">
                <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">薪資計算與分析</h2>
                    
                    <!-- 計算參數選擇 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">選擇教師</label>
                            <select id="salary-teacher" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option value="">請選擇教師</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">計算年月</label>
                            <input type="month" id="salary-month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                        <div class="flex items-end">
                            <button onclick="calculateSalary()" class="w-full bg-accent text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
                                計算薪資
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="calculateAllSalaries()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                計算全部
                            </button>
                        </div>
                    </div>

                    <!-- 薪資明細顯示 -->
                    <div id="salary-result" class="hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">薪資明細</h3>
                                <div class="flex space-x-2">
                                    <button onclick="printSalarySlip()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        列印薪資單
                                    </button>
                                    <button onclick="exportSalaryPDF()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                        匯出PDF
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                <div class="text-center bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-2">基本鐘點費</h4>
                                    <div id="basic-salary" class="text-2xl font-bold text-primary">$0</div>
                                    <div id="basic-hours" class="text-sm text-gray-500">0 小時</div>
                                </div>
                                <div class="text-center bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-2">招生獎金</h4>
                                    <div id="recruitment-bonus" class="text-2xl font-bold text-secondary">$0</div>
                                    <div id="recruitment-count" class="text-sm text-gray-500">0 位新生</div>
                                </div>
                                <div class="text-center bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-2">績效獎金</h4>
                                    <div id="performance-bonus" class="text-2xl font-bold text-accent">$0</div>
                                    <div id="performance-rate" class="text-sm text-gray-500">0% 獎金率</div>
                                </div>
                                <div class="text-center bg-white rounded-lg p-4 border-2 border-gray-300">
                                    <h4 class="font-medium text-gray-700 mb-2">總薪資</h4>
                                    <div id="total-salary" class="text-3xl font-bold text-gray-900">$0</div>
                                    <div id="salary-teacher-name" class="text-sm text-gray-500"></div>
                                </div>
                            </div>
                            
                            <!-- 詳細計算明細 -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-3">課程明細</h4>
                                    <div id="course-breakdown" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- 動態生成 -->
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 mb-3">招生明細</h4>
                                    <div id="recruitment-breakdown" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- 動態生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 全體教師薪資總覽 -->
                    <div id="all-salaries-result" class="hidden">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4">全體教師薪資總覽</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">教師</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">基本薪資</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">招生獎金</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">績效獎金</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總薪資</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="all-salaries-table" class="bg-white divide-y divide-gray-200">
                                        <!-- 全體薪資資料將動態載入 -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div class="text-sm text-gray-500">總基本薪資</div>
                                        <div id="total-basic-salary" class="text-lg font-bold text-primary">$0</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">總招生獎金</div>
                                        <div id="total-recruitment-bonus" class="text-lg font-bold text-secondary">$0</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">總績效獎金</div>
                                        <div id="total-performance-bonus" class="text-lg font-bold text-accent">$0</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">總支出</div>
                                        <div id="grand-total-salary" class="text-xl font-bold text-gray-900">$0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增教師模態框 -->
    <div id="teacher-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4" id="teacher-modal-title">新增教師</h3>
            <form id="teacher-form">
                <input type="hidden" id="teacher-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">教師姓名 *</label>
                        <input type="text" id="teacher-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">專長科目 *</label>
                        <input type="text" id="teacher-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">基本鐘點費 (元/小時) *</label>
                        <input type="number" id="teacher-rate" min="100" max="5000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">績效等級 *</label>
                        <select id="teacher-level" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">請選擇等級</option>
                            <option value="新進">新進 (無績效獎金)</option>
                            <option value="一般">一般 (5% 績效獎金)</option>
                            <option value="資深">資深 (10% 績效獎金)</option>
                            <option value="名師">名師 (15% 績效獎金)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">招生獎金比例 (%)</label>
                        <input type="number" id="teacher-bonus-rate" min="0" max="20" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="例：3.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">聯絡資訊</label>
                        <input type="text" id="teacher-contact" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="電話或email">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideModal('teacher-modal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
                        <span id="teacher-submit-text">新增</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 新增課程模態框 -->
    <div id="course-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4" id="course-modal-title">新增課程</h3>
            <form id="course-form">
                <input type="hidden" id="course-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">課程名稱 *</label>
                        <input type="text" id="course-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">課程級別 *</label>
                        <select id="course-level" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">請選擇級別</option>
                            <option value="國小">國小</option>
                            <option value="國中">國中</option>
                            <option value="高中">高中</option>
                            <option value="成人">成人</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">科目 *</label>
                        <input type="text" id="course-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">標準鐘點費 (元/小時) *</label>
                        <input type="number" id="course-rate" min="100" max="5000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">課程時數 (小時) *</label>
                        <input type="number" id="course-duration" min="0.5" max="5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">最大學生數</label>
                        <input type="number" id="course-max-students" min="1" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="例：15">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideModal('course-modal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-green-600">
                        <span id="course-submit-text">新增</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 新增學生模態框 -->
    <div id="student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4" id="student-modal-title">新增學生</h3>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">學生姓名 *</label>
                        <input type="text" id="student-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">報讀課程 *</label>
                        <select id="student-course" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">請選擇課程</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">學費 (元) *</label>
                        <input type="number" id="student-fee" min="1000" max="100000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">已繳金額 (元)</label>
                        <input type="number" id="student-paid" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">繳費狀態 *</label>
                        <select id="student-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">請選擇狀態</option>
                            <option value="已繳費">已繳費</option>
                            <option value="未繳費">未繳費</option>
                            <option value="部分繳費">部分繳費</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">介紹人教師</label>
                        <select id="student-referrer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <option value="">自行報名</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">聯絡資訊</label>
                        <input type="text" id="student-contact" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="家長電話">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideModal('student-modal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <span id="student-submit-text">新增</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 新增出勤模態框 -->
    <div id="attendance-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4" id="attendance-modal-title">新增出勤紀錄</h3>
            <form id="attendance-form">
                <input type="hidden" id="attendance-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">上課日期 *</label>
                        <input type="date" id="attendance-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">授課教師 *</label>
                        <select id="attendance-teacher" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">請選擇教師</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">授課課程 *</label>
                        <select id="attendance-course" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                            <option value="">請選擇課程</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">實際上課時數 *</label>
                        <input type="number" id="attendance-hours" min="0.5" max="8" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">學生出席數 *</label>
                        <input type="number" id="attendance-students" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">課程狀態</label>
                        <select id="attendance-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <option value="completed">正常完成</option>
                            <option value="makeup">補課</option>
                            <option value="cancelled">取消</option>
                            <option value="rescheduled">調課</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                        <textarea id="attendance-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="特殊狀況說明"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideModal('attendance-modal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-yellow-600">
                        <span id="attendance-submit-text">新增</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 報表分析模態框 -->
    <div id="reports-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">報表分析中心</h3>
                <button onclick="hideModal('reports-modal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- 報表選項卡 -->
            <div class="flex space-x-4 mb-6">
                <button onclick="showReportTab('financial')" class="tab-button px-4 py-2 rounded-lg active">財務報表</button>
                <button onclick="showReportTab('performance')" class="tab-button px-4 py-2 rounded-lg">績效分析</button>
                <button onclick="showReportTab('attendance')" class="tab-button px-4 py-2 rounded-lg">出勤統計</button>
            </div>

            <!-- 財務報表 -->
            <div id="financial-report" class="report-tab-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">本月總收入</div>
                        <div id="total-income" class="text-2xl font-bold text-blue-600">$0</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">本月總支出</div>
                        <div id="total-expense" class="text-2xl font-bold text-red-600">$0</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">本月淨利</div>
                        <div id="net-profit" class="text-2xl font-bold text-green-600">$0</div>
                    </div>
                </div>
                <canvas id="financial-chart" width="400" height="200"></canvas>
            </div>

            <!-- 績效分析 -->
            <div id="performance-report" class="report-tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-2">教師績效排名</h4>
                        <div id="teacher-performance-list" class="space-y-2">
                            <!-- 動態生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 出勤統計 -->
            <div id="attendance-report" class="report-tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-2">課程出勤率</h4>
                        <div id="course-attendance-list" class="space-y-2">
                            <!-- 動態生成 -->
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-2">教師出勤統計</h4>
                        <div id="teacher-attendance-list" class="space-y-2">
                            <!-- 動態生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 備份與還原模態框 -->
    <div id="backup-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">資料備份與還原</h3>
                <button onclick="hideModal('backup-modal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium mb-2">備份資料</h4>
                    <button onclick="exportData()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        匯出完整資料備份
                    </button>
                </div>
                
                <div>
                    <h4 class="font-medium mb-2">還原資料</h4>
                    <input type="file" id="import-file" accept=".json" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <button onclick="importData()" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        從檔案還原資料
                    </button>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="font-medium mb-2 text-red-600">危險操作</h4>
                    <button onclick="resetAllData()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        清除所有資料
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入中指示器 -->
    <div id="loading" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="loading-spinner"></div>
            <span class="text-gray-700">處理中...</span>
        </div>
    </div>

    <script>
        // ===== 全域變數與常數 =====
        
        const STORAGE_KEYS = {
            TEACHERS: 'cramSchool_teachers',
            COURSES: 'cramSchool_courses',
            STUDENTS: 'cramSchool_students',
            ATTENDANCE: 'cramSchool_attendance',
            SETTINGS: 'cramSchool_settings'
        };

        let appData = {
            teachers: [],
            courses: [],
            students: [],
            attendance: [],
            currentSection: null,
            sortConfig: { table: null, column: null, direction: 'asc' },
            currentCalendarDate: new Date(),
            filters: {
                teachers: { search: '', level: '' },
                courses: { search: '', level: '' },
                students: { search: '', status: '' }
            }
        };

        let financialChart = null;

        // ===== 初始化與資料載入 =====
        
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromStorage();
            initializeDefaultData();
            updateAllDisplays();
            setupEventHandlers();
            setupFormHandlers();
            showSection('teachers');
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });

        function loadDataFromStorage() {
            try {
                appData.teachers = JSON.parse(localStorage.getItem(STORAGE_KEYS.TEACHERS) || '[]');
                appData.courses = JSON.parse(localStorage.getItem(STORAGE_KEYS.COURSES) || '[]');
                appData.students = JSON.parse(localStorage.getItem(STORAGE_KEYS.STUDENTS) || '[]');
                appData.attendance = JSON.parse(localStorage.getItem(STORAGE_KEYS.ATTENDANCE) || '[]');
                
                // 轉換日期字串回 Date 物件
                appData.students.forEach(student => {
                    if (student.enrollDate) {
                        student.enrollDate = new Date(student.enrollDate);
                    }
                });
                
                appData.attendance.forEach(record => {
                    if (record.date) {
                        record.date = new Date(record.date);
                    }
                });
                
            } catch (error) {
                console.error('載入資料失敗:', error);
                showNotification('資料載入失敗，將使用預設資料', 'error');
            }
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.TEACHERS, JSON.stringify(appData.teachers));
                localStorage.setItem(STORAGE_KEYS.COURSES, JSON.stringify(appData.courses));
                localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(appData.students));
                localStorage.setItem(STORAGE_KEYS.ATTENDANCE, JSON.stringify(appData.attendance));
            } catch (error) {
                console.error('儲存資料失敗:', error);
                showNotification('資料儲存失敗，請檢查瀏覽器儲存空間', 'error');
            }
        }

        function initializeDefaultData() {
            if (appData.teachers.length === 0) {
                appData.teachers = [
                    {
                        id: 1,
                        name: '王志明',
                        subject: '數學',
                        hourlyRate: 800,
                        performanceLevel: '資深',
                        recruitmentBonusRate: 5.0,
                        contactInfo: '0912-345-678',
                        joinDate: new Date('2020-01-15')
                    },
                    {
                        id: 2,
                        name: '李美玲',
                        subject: '英文',
                        hourlyRate: 600,
                        performanceLevel: '一般',
                        recruitmentBonusRate: 3.0,
                        contactInfo: 'lee@example.com',
                        joinDate: new Date('2021-08-01')
                    },
                    {
                        id: 3,
                        name: '張博士',
                        subject: '物理',
                        hourlyRate: 1200,
                        performanceLevel: '名師',
                        recruitmentBonusRate: 8.0,
                        contactInfo: '0922-987-654',
                        joinDate: new Date('2018-03-10')
                    },
                    {
                        id: 4,
                        name: '陳老師',
                        subject: '化學',
                        hourlyRate: 750,
                        performanceLevel: '一般',
                        recruitmentBonusRate: 4.0,
                        contactInfo: '0933-111-222',
                        joinDate: new Date('2022-02-20')
                    }
                ];
            }

            if (appData.courses.length === 0) {
                appData.courses = [
                    {
                        id: 1,
                        name: '國中數學基礎班',
                        level: '國中',
                        subject: '數學',
                        standardRate: 800,
                        duration: 2,
                        maxStudents: 15
                    },
                    {
                        id: 2,
                        name: '高中英文進階班',
                        level: '高中',
                        subject: '英文',
                        standardRate: 900,
                        duration: 2,
                        maxStudents: 12
                    },
                    {
                        id: 3,
                        name: '高中物理精修班',
                        level: '高中',
                        subject: '物理',
                        standardRate: 1200,
                        duration: 1.5,
                        maxStudents: 10
                    },
                    {
                        id: 4,
                        name: '國小數學啟蒙班',
                        level: '國小',
                        subject: '數學',
                        standardRate: 600,
                        duration: 1.5,
                        maxStudents: 20
                    },
                    {
                        id: 5,
                        name: '高中化學實驗班',
                        level: '高中',
                        subject: '化學',
                        standardRate: 1000,
                        duration: 2,
                        maxStudents: 8
                    }
                ];
            }

            if (appData.students.length === 0) {
                appData.students = [
                    {
                        id: 1,
                        name: '陳小明',
                        courseIds: [1],
                        totalFee: 12000,
                        paidAmount: 12000,
                        paymentStatus: '已繳費',
                        referrerTeacherId: 1,
                        enrollDate: new Date('2025-01-15'),
                        contactInfo: '0912-111-222'
                    },
                    {
                        id: 2,
                        name: '林小華',
                        courseIds: [2],
                        totalFee: 15000,
                        paidAmount: 7500,
                        paymentStatus: '部分繳費',
                        referrerTeacherId: 2,
                        enrollDate: new Date('2025-02-01'),
                        contactInfo: '0923-333-444'
                    },
                    {
                        id: 3,
                        name: '黃小美',
                        courseIds: [3],
                        totalFee: 18000,
                        paidAmount: 0,
                        paymentStatus: '未繳費',
                        referrerTeacherId: null,
                        enrollDate: new Date('2025-02-10'),
                        contactInfo: '0934-555-666'
                    },
                    {
                        id: 4,
                        name: '李小強',
                        courseIds: [1, 4],
                        totalFee: 20000,
                        paidAmount: 20000,
                        paymentStatus: '已繳費',
                        referrerTeacherId: 1,
                        enrollDate: new Date('2025-01-20'),
                        contactInfo: '0945-777-888'
                    },
                    {
                        id: 5,
                        name: '王小芳',
                        courseIds: [5],
                        totalFee: 16000,
                        paidAmount: 8000,
                        paymentStatus: '部分繳費',
                        referrerTeacherId: 4,
                        enrollDate: new Date('2025-02-15'),
                        contactInfo: '0956-999-000'
                    }
                ];
            }

            if (appData.attendance.length === 0) {
                generateSampleAttendanceData();
            }

            saveDataToStorage();
        }

        function generateSampleAttendanceData() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            appData.attendance = [];
            let recordId = 1;

            // 生成過去3個月的出勤資料
            for (let monthOffset = 2; monthOffset >= 0; monthOffset--) {
                const targetMonth = currentMonth - monthOffset;
                const targetYear = targetMonth < 0 ? currentYear - 1 : currentYear;
                const adjustedMonth = targetMonth < 0 ? 12 + targetMonth : targetMonth;
                
                // 為每個教師在該月份生成出勤紀錄
                appData.teachers.forEach(teacher => {
                    // 每個教師每月大約上課12-16次
                    const classCount = Math.floor(Math.random() * 5) + 12;
                    
                    for (let i = 0; i < classCount; i++) {
                        const day = Math.floor(Math.random() * 28) + 1;
                        const classDate = new Date(targetYear, adjustedMonth, day);
                        
                        // 隨機選擇課程（根據教師專長）
                        const relevantCourses = appData.courses.filter(course => 
                            course.subject === teacher.subject
                        );
                        const course = relevantCourses.length > 0 
                            ? relevantCourses[Math.floor(Math.random() * relevantCourses.length)]
                            : appData.courses[Math.floor(Math.random() * appData.courses.length)];
                        
                        appData.attendance.push({
                            id: recordId++,
                            teacherId: teacher.id,
                            courseId: course.id,
                            date: classDate,
                            actualHours: course.duration,
                            studentCount: Math.floor(Math.random() * (course.maxStudents || 15)) + 5,
                            notes: Math.random() > 0.9 ? ['補課', '調課', '特別課程'][Math.floor(Math.random() * 3)] : '',
                            isCompleted: Math.random() > 0.05,
                            status: Math.random() > 0.1 ? 'completed' : 
                                   Math.random() > 0.5 ? 'makeup' : 'rescheduled'
                        });
                    }
                });
            }
        }

        // ===== 事件處理器設定 =====
        
        function setupEventHandlers() {
            // 搜尋功能
            document.getElementById('teacher-search').addEventListener('input', function() {
                appData.filters.teachers.search = this.value;
                updateTeachersTable();
            });

            document.getElementById('teacher-filter').addEventListener('change', function() {
                appData.filters.teachers.level = this.value;
                updateTeachersTable();
            });

            document.getElementById('course-search').addEventListener('input', function() {
                appData.filters.courses.search = this.value;
                updateCoursesGrid();
            });

            document.getElementById('course-level-filter').addEventListener('change', function() {
                appData.filters.courses.level = this.value;
                updateCoursesGrid();
            });

            document.getElementById('student-search').addEventListener('input', function() {
                appData.filters.students.search = this.value;
                updateStudentsTable();
            });

            document.getElementById('student-status-filter').addEventListener('change', function() {
                appData.filters.students.status = this.value;
                updateStudentsTable();
            });

            // 出勤管理事件
            document.getElementById('attendance-month').addEventListener('change', function() {
                updateAttendanceTable();
                updateAttendanceCalendar();
            });

            document.getElementById('attendance-teacher-filter').addEventListener('change', function() {
                updateAttendanceTable();
            });

            // 薪資計算月份設定
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('salary-month').value = currentMonth;
            document.getElementById('attendance-month').value = currentMonth;
        }

        function setupFormHandlers() {
            // 教師表單
            document.getElementById('teacher-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleTeacherSubmit();
            });
            
            // 課程表單
            document.getElementById('course-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleCourseSubmit();
            });
            
            // 學生表單
            document.getElementById('student-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleStudentSubmit();
            });

            // 出勤表單
            document.getElementById('attendance-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleAttendanceSubmit();
            });
        }

        // ===== 表單處理功能 =====
        
        function handleTeacherSubmit() {
            const teacherId = document.getElementById('teacher-id').value;
            const teacherData = {
                name: document.getElementById('teacher-name').value,
                subject: document.getElementById('teacher-subject').value,
                hourlyRate: parseInt(document.getElementById('teacher-rate').value),
                performanceLevel: document.getElementById('teacher-level').value,
                recruitmentBonusRate: parseFloat(document.getElementById('teacher-bonus-rate').value) || 0,
                contactInfo: document.getElementById('teacher-contact').value || ''
            };

            if (teacherId) {
                updateTeacher(parseInt(teacherId), teacherData);
                showNotification('教師資料更新成功');
            } else {
                addTeacher(teacherData);
                showNotification('教師新增成功');
            }

            hideModal('teacher-modal');
            document.getElementById('teacher-form').reset();
        }

        function handleCourseSubmit() {
            const courseId = document.getElementById('course-id').value;
            const courseData = {
                name: document.getElementById('course-name').value,
                level: document.getElementById('course-level').value,
                subject: document.getElementById('course-subject').value,
                standardRate: parseInt(document.getElementById('course-rate').value),
                duration: parseFloat(document.getElementById('course-duration').value),
                maxStudents: parseInt(document.getElementById('course-max-students').value) || null
            };

            if (courseId) {
                updateCourse(parseInt(courseId), courseData);
                showNotification('課程資料更新成功');
            } else {
                addCourse(courseData);
                showNotification('課程新增成功');
            }

            hideModal('course-modal');
            document.getElementById('course-form').reset();
        }

        function handleStudentSubmit() {
            const studentId = document.getElementById('student-id').value;
            const totalFee = parseInt(document.getElementById('student-fee').value);
            const paidAmount = parseInt(document.getElementById('student-paid').value) || 0;
            
            // 自動判斷繳費狀態
            let paymentStatus;
            if (paidAmount >= totalFee) {
                paymentStatus = '已繳費';
            } else if (paidAmount > 0) {
                paymentStatus = '部分繳費';
            } else {
                paymentStatus = '未繳費';
            }

            const studentData = {
                name: document.getElementById('student-name').value,
                courseIds: [parseInt(document.getElementById('student-course').value)],
                totalFee: totalFee,
                paidAmount: paidAmount,
                paymentStatus: paymentStatus,
                referrerTeacherId: document.getElementById('student-referrer').value 
                    ? parseInt(document.getElementById('student-referrer').value) : null,
                contactInfo: document.getElementById('student-contact').value || ''
            };

            if (studentId) {
                updateStudent(parseInt(studentId), studentData);
                showNotification('學生資料更新成功');
            } else {
                addStudent(studentData);
                showNotification('學生新增成功');
            }

            hideModal('student-modal');
            document.getElementById('student-form').reset();
        }

        function handleAttendanceSubmit() {
            const attendanceId = document.getElementById('attendance-id').value;
            const attendanceData = {
                date: new Date(document.getElementById('attendance-date').value),
                teacherId: parseInt(document.getElementById('attendance-teacher').value),
                courseId: parseInt(document.getElementById('attendance-course').value),
                actualHours: parseFloat(document.getElementById('attendance-hours').value),
                studentCount: parseInt(document.getElementById('attendance-students').value),
                status: document.getElementById('attendance-status').value,
                notes: document.getElementById('attendance-notes').value || '',
                isCompleted: document.getElementById('attendance-status').value === 'completed'
            };

            if (attendanceId) {
                updateAttendance(parseInt(attendanceId), attendanceData);
                showNotification('出勤紀錄更新成功');
            } else {
                addAttendance(attendanceData);
                showNotification('出勤紀錄新增成功');
            }

            hideModal('attendance-modal');
            document.getElementById('attendance-form').reset();
            updateAttendanceTable();
            updateAttendanceCalendar();
        }

        // ===== 資料操作功能 =====
        
        function addTeacher(teacherData) {
            const newId = Math.max(...appData.teachers.map(t => t.id), 0) + 1;
            const newTeacher = {
                id: newId,
                ...teacherData,
                joinDate: new Date()
            };
            
            appData.teachers.push(newTeacher);
            saveDataToStorage();
            updateAllDisplays();
            
            return newTeacher;
        }

        function updateTeacher(id, teacherData) {
            const index = appData.teachers.findIndex(t => t.id === id);
            if (index !== -1) {
                appData.teachers[index] = { ...appData.teachers[index], ...teacherData };
                saveDataToStorage();
                updateAllDisplays();
                return true;
            }
            return false;
        }

        function addCourse(courseData) {
            const newId = Math.max(...appData.courses.map(c => c.id), 0) + 1;
            const newCourse = {
                id: newId,
                ...courseData
            };
            
            appData.courses.push(newCourse);
            saveDataToStorage();
            updateAllDisplays();
            
            return newCourse;
        }

        function updateCourse(id, courseData) {
            const index = appData.courses.findIndex(c => c.id === id);
            if (index !== -1) {
                appData.courses[index] = { ...appData.courses[index], ...courseData };
                saveDataToStorage();
                updateAllDisplays();
                return true;
            }
            return false;
        }

        function addStudent(studentData) {
            const newId = Math.max(...appData.students.map(s => s.id), 0) + 1;
            const newStudent = {
                id: newId,
                ...studentData,
                enrollDate: new Date()
            };
            
            appData.students.push(newStudent);
            saveDataToStorage();
            updateAllDisplays();
            
            return newStudent;
        }

        function updateStudent(id, studentData) {
            const index = appData.students.findIndex(s => s.id === id);
            if (index !== -1) {
                appData.students[index] = { ...appData.students[index], ...studentData };
                saveDataToStorage();
                updateAllDisplays();
                return true;
            }
            return false;
        }

        function addAttendance(attendanceData) {
            const newId = Math.max(...appData.attendance.map(a => a.id), 0) + 1;
            const newAttendance = {
                id: newId,
                ...attendanceData
            };
            
            appData.attendance.push(newAttendance);
            saveDataToStorage();
            updateAllDisplays();
            
            return newAttendance;
        }

        function updateAttendance(id, attendanceData) {
            const index = appData.attendance.findIndex(a => a.id === id);
            if (index !== -1) {
                appData.attendance[index] = { ...appData.attendance[index], ...attendanceData };
                saveDataToStorage();
                updateAllDisplays();
                return true;
            }
            return false;
        }

        // ===== UI 更新功能 =====
        
        function updateAllDisplays() {
            updateTeachersTable();
            updateCoursesGrid();
            updateStudentsTable();
            updateAttendanceTable();
            updateSalaryTeacherSelect();
            updateCourseSelects();
            updateTeacherSelects();
            updateCounters();
            updateAttendanceCalendar();
        }

        function updateCounters() {
            // 教師統計
            const teacherCount = appData.teachers.length;
            const avgRate = teacherCount > 0 
                ? Math.round(appData.teachers.reduce((sum, t) => sum + t.hourlyRate, 0) / teacherCount)
                : 0;
            
            document.getElementById('teacher-count').textContent = `${teacherCount} 位教師`;
            document.getElementById('teacher-avg-rate').textContent = `平均鐘點費: $${avgRate}`;

            // 課程統計
            const courseCount = appData.courses.length;
            const avgCourseRate = courseCount > 0 
                ? Math.round(appData.courses.reduce((sum, c) => sum + c.standardRate, 0) / courseCount)
                : 0;
            
            document.getElementById('course-count').textContent = `${courseCount} 門課程`;
            document.getElementById('course-avg-rate').textContent = `平均費率: $${avgCourseRate}`;

            // 學生統計
            const studentCount = appData.students.length;
            const paidStudents = appData.students.filter(s => s.paymentStatus === '已繳費').length;
            const paymentRate = studentCount > 0 ? Math.round((paidStudents / studentCount) * 100) : 0;
            
            document.getElementById('student-count').textContent = `${studentCount} 位學生`;
            document.getElementById('payment-rate').textContent = `繳費率: ${paymentRate}%`;

            // 出勤統計
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const currentMonthAttendance = appData.attendance.filter(a => {
                const date = new Date(a.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const completedClasses = currentMonthAttendance.filter(a => a.isCompleted).length;
            const attendanceRate = currentMonthAttendance.length > 0 
                ? Math.round((completedClasses / currentMonthAttendance.length) * 100)
                : 100;
            
            document.getElementById('attendance-count').textContent = `${currentMonthAttendance.length} 堂課`;
            document.getElementById('attendance-rate').textContent = `完成率: ${attendanceRate}%`;

            // 計算本月總薪資支出
            calculateMonthlyTotalSalary();
        }

        function calculateMonthlyTotalSalary() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            let totalSalary = 0;

            appData.teachers.forEach(teacher => {
                const monthlyAttendance = appData.attendance.filter(a => {
                    const date = new Date(a.date);
                    return a.teacherId === teacher.id && 
                           date.getMonth() === currentMonth && 
                           date.getFullYear() === currentYear &&
                           a.isCompleted;
                });

                let basicSalary = 0;
                monthlyAttendance.forEach(record => {
                    const course = appData.courses.find(c => c.id === record.courseId);
                    const rate = course ? course.standardRate : teacher.hourlyRate;
                    basicSalary += record.actualHours * rate;
                });

                // 績效獎金
                const levelMultiplier = {
                    '新進': 0.00, '一般': 0.05, '資深': 0.10, '名師': 0.15
                };
                const performanceBonus = basicSalary * (levelMultiplier[teacher.performanceLevel] || 0);

                // 招生獎金
                const newStudents = appData.students.filter(student => {
                    const enrollDate = new Date(student.enrollDate);
                    return student.referrerTeacherId === teacher.id &&
                           enrollDate.getMonth() === currentMonth &&
                           enrollDate.getFullYear() === currentYear;
                });
                
                const recruitmentBonus = newStudents.reduce((sum, student) => 
                    sum + (student.totalFee * (teacher.recruitmentBonusRate / 100)), 0);

                totalSalary += basicSalary + performanceBonus + recruitmentBonus;
            });

            document.getElementById('total-salary-month').textContent = `本月總支出: $${Math.round(totalSalary).toLocaleString()}`;
        }

        function updateTeachersTable() {
            const tableBody = document.getElementById('teachers-table');
            tableBody.innerHTML = '';
            
            let filteredTeachers = appData.teachers;
            
            // 搜尋篩選
            if (appData.filters.teachers.search) {
                const search = appData.filters.teachers.search.toLowerCase();
                filteredTeachers = filteredTeachers.filter(teacher => 
                    teacher.name.toLowerCase().includes(search) ||
                    teacher.subject.toLowerCase().includes(search)
                );
            }
            
            // 等級篩選
            if (appData.filters.teachers.level) {
                filteredTeachers = filteredTeachers.filter(teacher => 
                    teacher.performanceLevel === appData.filters.teachers.level
                );
            }
            
            // 排序處理
            if (appData.sortConfig.table === 'teachers' && appData.sortConfig.column) {
                filteredTeachers.sort((a, b) => {
                    let aValue = a[appData.sortConfig.column];
                    let bValue = b[appData.sortConfig.column];
                    
                    if (typeof aValue === 'string') {
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                    }
                    
                    if (aValue < bValue) return appData.sortConfig.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return appData.sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            filteredTeachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.hourlyRate}/小時</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getLevelColor(teacher.performanceLevel)}">
                            ${teacher.performanceLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.recruitmentBonusRate}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.contactInfo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editTeacher(${teacher.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 transition-colors">編輯</button>
                        <button onclick="deleteTeacher(${teacher.id})" class="text-red-600 hover:text-red-900 transition-colors">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            if (filteredTeachers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                        ${appData.filters.teachers.search || appData.filters.teachers.level ? '沒有符合條件的教師' : '尚未新增任何教師'}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        function updateCoursesGrid() {
            const grid = document.getElementById('courses-grid');
            grid.innerHTML = '';
            
            let filteredCourses = appData.courses;
            
            // 搜尋篩選
            if (appData.filters.courses.search) {
                const search = appData.filters.courses.search.toLowerCase();
                filteredCourses = filteredCourses.filter(course => 
                    course.name.toLowerCase().includes(search) ||
                    course.subject.toLowerCase().includes(search)
                );
            }
            
            // 級別篩選
            if (appData.filters.courses.level) {
                filteredCourses = filteredCourses.filter(course => 
                    course.level === appData.filters.courses.level
                );
            }
            
            filteredCourses.forEach(course => {
                const enrolledStudents = appData.students.filter(student => 
                    student.courseIds.includes(course.id)
                ).length;
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover border border-gray-200';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 leading-tight">${course.name}</h3>
                        <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${course.level}</span>
                    </div>
                    <div class="space-y-3 text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span class="font-medium">科目：</span>
                            <span>${course.subject}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">鐘點費：</span>
                            <span class="text-green-600 font-semibold">${course.standardRate}/小時</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">課程時數：</span>
                            <span>${course.duration} 小時</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">學生人數：</span>
                            <span class="text-blue-600">${enrolledStudents}/${course.maxStudents || '無限制'}</span>
                        </div>
                        ${course.maxStudents && enrolledStudents >= course.maxStudents ? 
                            '<div class="text-red-500 text-xs font-medium">班級已滿</div>' : ''}
                    </div>
                    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-100">
                        <div class="flex space-x-3">
                            <button onclick="editCourse(${course.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors">編輯</button>
                            <button onclick="deleteCourse(${course.id})" class="text-red-600 hover:text-red-800 text-sm font-medium transition-colors">刪除</button>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${enrolledStudents > 0 ? `${enrolledStudents} 位學生` : '尚無學生'}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            if (filteredCourses.length === 0) {
                const emptyCard = document.createElement('div');
                emptyCard.className = 'col-span-full bg-gray-50 rounded-lg p-8 text-center text-gray-500';
                emptyCard.innerHTML = `
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <p>${appData.filters.courses.search || appData.filters.courses.level ? '沒有符合條件的課程' : '尚未新增任何課程'}</p>
                `;
                grid.appendChild(emptyCard);
            }
        }

        function updateStudentsTable() {
            const tableBody = document.getElementById('students-table');
            tableBody.innerHTML = '';
            
            let filteredStudents = appData.students;
            
            // 搜尋篩選
            if (appData.filters.students.search) {
                const search = appData.filters.students.search.toLowerCase();
                filteredStudents = filteredStudents.filter(student => 
                    student.name.toLowerCase().includes(search)
                );
            }
            
            // 狀態篩選
            if (appData.filters.students.status) {
                filteredStudents = filteredStudents.filter(student => 
                    student.paymentStatus === appData.filters.students.status
                );
            }
            
            // 排序處理
            if (appData.sortConfig.table === 'students' && appData.sortConfig.column) {
                filteredStudents.sort((a, b) => {
                    let aValue = a[appData.sortConfig.column];
                    let bValue = b[appData.sortConfig.column];
                    
                    if (appData.sortConfig.column === 'enrollDate') {
                        aValue = new Date(aValue);
                        bValue = new Date(bValue);
                    } else if (typeof aValue === 'string') {
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                    }
                    
                    if (aValue < bValue) return appData.sortConfig.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return appData.sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            filteredStudents.forEach(student => {
                const course = appData.courses.find(c => c.id === student.courseIds[0]);
                const referrer = student.referrerTeacherId 
                    ? appData.teachers.find(t => t.id === student.referrerTeacherId)
                    : null;
                
                const paymentPercentage = Math.round((student.paidAmount / student.totalFee) * 100);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${course ? course.name : '未知課程'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.totalFee.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: ${paymentPercentage}%"></div>
                        </div>
                        <div class="text-xs text-gray-500">${paymentPercentage}% (${student.paidAmount.toLocaleString()})</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(student.paymentStatus)}">
                            ${student.paymentStatus}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${referrer ? referrer.name : '自行報名'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.enrollDate.toLocaleDateString('zh-TW')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editStudent(${student.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 transition-colors">編輯</button>
                        <button onclick="deleteStudent(${student.id})" class="text-red-600 hover:text-red-900 transition-colors">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            if (filteredStudents.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                        ${appData.filters.students.search || appData.filters.students.status ? '沒有符合條件的學生' : '尚未新增任何學生'}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        function updateAttendanceTable() {
            const tableBody = document.getElementById('attendance-table');
            tableBody.innerHTML = '';
            
            const monthInput = document.getElementById('attendance-month').value;
            const teacherFilter = document.getElementById('attendance-teacher-filter').value;
            
            let filteredAttendance = appData.attendance;
            
            // 月份篩選
            if (monthInput) {
                const [year, month] = monthInput.split('-').map(Number);
                filteredAttendance = filteredAttendance.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === year && recordDate.getMonth() + 1 === month;
                });
            }
            
            // 教師篩選
            if (teacherFilter) {
                filteredAttendance = filteredAttendance.filter(record => 
                    record.teacherId === parseInt(teacherFilter)
                );
            }
            
            // 按日期排序（最新的在前面）
            filteredAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredAttendance.forEach(record => {
                const teacher = appData.teachers.find(t => t.id === record.teacherId);
                const course = appData.courses.find(c => c.id === record.courseId);
                
                const statusMap = {
                    'completed': { text: '正常完成', color: 'bg-green-100 text-green-800' },
                    'makeup': { text: '補課', color: 'bg-yellow-100 text-yellow-800' },
                    'cancelled': { text: '取消', color: 'bg-red-100 text-red-800' },
                    'rescheduled': { text: '調課', color: 'bg-blue-100 text-blue-800' }
                };
                
                const status = statusMap[record.status] || statusMap['completed'];
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(record.date).toLocaleDateString('zh-TW')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher ? teacher.name : '未知教師'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${course ? course.name : '未知課程'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.actualHours} 小時</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.studentCount} 人</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${status.color}">
                            ${status.text}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.notes || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editAttendance(${record.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 transition-colors">編輯</button>
                        <button onclick="deleteAttendance(${record.id})" class="text-red-600 hover:text-red-900 transition-colors">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            if (filteredAttendance.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                        ${monthInput || teacherFilter ? '沒有符合條件的出勤紀錄' : '尚未新增任何出勤紀錄'}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        function updateAttendanceCalendar() {
            const calendar = document.getElementById('attendance-calendar');
            const monthYearDisplay = document.getElementById('calendar-month-year');
            
            const year = appData.currentCalendarDate.getFullYear();
            const month = appData.currentCalendarDate.getMonth();
            
            monthYearDisplay.textContent = `${year}年${month + 1}月`;
            
            // 清空日曆
            calendar.innerHTML = '';
            
            // 新增星期標題
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center text-sm font-medium text-gray-500 p-2';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // 計算月份開始日期
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // 生成日曆格子
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day text-sm';
                dayElement.textContent = currentDate.getDate();
                
                // 檢查是否為當前月份
                if (currentDate.getMonth() !== month) {
                    dayElement.classList.add('text-gray-300');
                } else {
                    dayElement.classList.add('text-gray-700');
                }
                
                // 檢查是否有課程
                const hasClass = appData.attendance.some(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.toDateString() === currentDate.toDateString();
                });
                
                if (hasClass) {
                    dayElement.classList.add('has-class');
                }
                
                // 今天特殊標記
                if (currentDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('bg-blue-600', 'text-white');
                }
                
                dayElement.addEventListener('click', () => {
                    showDayAttendance(currentDate);
                });
                
                calendar.appendChild(dayElement);
            }
        }

        function updateSalaryTeacherSelect() {
            const select = document.getElementById('salary-teacher');
            select.innerHTML = '<option value="">請選擇教師</option>';
            
            appData.teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                select.appendChild(option);
            });
        }

        function updateCourseSelects() {
            const selects = document.querySelectorAll('#student-course, #attendance-course');
            selects.forEach(select => {
                select.innerHTML = '<option value="">請選擇課程</option>';
                appData.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    select.appendChild(option);
                });
            });
        }

        function updateTeacherSelects() {
            const selects = document.querySelectorAll('#student-referrer, #attendance-teacher, #attendance-teacher-filter');
            selects.forEach(select => {
                const isFilter = select.id === 'attendance-teacher-filter';
                select.innerHTML = isFilter ? '<option value="">所有教師</option>' : '<option value="">自行報名</option>';
                
                appData.teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.name;
                    select.appendChild(option);
                });
            });
        }

        // ===== 薪資計算功能 =====
        
        function calculateSalary() {
            const teacherId = parseInt(document.getElementById('salary-teacher').value);
            const month = document.getElementById('salary-month').value;
            
            if (!teacherId || !month) {
                showNotification('請選擇教師和計算月份', 'error');
                return;
            }
            
            showLoading(true);
            
            setTimeout(() => {
                const result = performSalaryCalculation(teacherId, month);
                displaySalaryResult(result);
                document.getElementById('salary-result').classList.remove('hidden');
                showLoading(false);
                showNotification('薪資計算完成');
            }, 800);
        }

        function calculateAllSalaries() {
            const month = document.getElementById('salary-month').value;
            
            if (!month) {
                showNotification('請選擇計算月份', 'error');
                return;
            }
            
            showLoading(true);
            
            setTimeout(() => {
                const allResults = [];
                let totalBasic = 0, totalRecruitment = 0, totalPerformance = 0;
                
                appData.teachers.forEach(teacher => {
                    const result = performSalaryCalculation(teacher.id, month);
                    allResults.push(result);
                    totalBasic += result.basicSalary;
                    totalRecruitment += result.recruitmentBonus;
                    totalPerformance += result.performanceBonus;
                });
                
                displayAllSalariesResult(allResults, {
                    totalBasic,
                    totalRecruitment,
                    totalPerformance,
                    grandTotal: totalBasic + totalRecruitment + totalPerformance
                });
                
                document.getElementById('all-salaries-result').classList.remove('hidden');
                showLoading(false);
                showNotification('全體薪資計算完成');
            }, 1200);
        }

        function performSalaryCalculation(teacherId, month) {
            const teacher = appData.teachers.find(t => t.id === teacherId);
            const [year, monthNum] = month.split('-').map(Number);
            
            // 取得該月份的上課紀錄
            const attendanceRecords = appData.attendance.filter(record => {
                const recordDate = new Date(record.date);
                return record.teacherId === teacherId && 
                       recordDate.getFullYear() === year && 
                       recordDate.getMonth() + 1 === monthNum &&
                       record.isCompleted;
            });
            
            // 計算基本薪資
            let totalHours = 0;
            let basicSalary = 0;
            const courseBreakdown = {};
            
            attendanceRecords.forEach(record => {
                const course = appData.courses.find(c => c.id === record.courseId);
                const rate = course ? course.standardRate : teacher.hourlyRate;
                
                if (!courseBreakdown[record.courseId]) {
                    courseBreakdown[record.courseId] = {
                        name: course ? course.name : '未知課程',
                        hours: 0,
                        rate: rate,
                        subtotal: 0
                    };
                }
                
                courseBreakdown[record.courseId].hours += record.actualHours;
                totalHours += record.actualHours;
            });
            
            // 計算各課程小計
            Object.values(courseBreakdown).forEach(breakdown => {
                breakdown.subtotal = breakdown.hours * breakdown.rate;
                basicSalary += breakdown.subtotal;
            });
            
            // 計算招生獎金
            const newStudents = appData.students.filter(student => {
                const enrollDate = new Date(student.enrollDate);
                return student.referrerTeacherId === teacherId &&
                       enrollDate.getFullYear() === year &&
                       enrollDate.getMonth() + 1 === monthNum;
            });
            
            let recruitmentBonus = 0;
            const recruitmentBreakdown = [];
            newStudents.forEach(student => {
                const bonus = student.totalFee * (teacher.recruitmentBonusRate / 100);
                recruitmentBonus += bonus;
                recruitmentBreakdown.push({
                    studentName: student.name,
                    studentFee: student.totalFee,
                    bonusAmount: bonus
                });
            });
            
            // 計算績效獎金
            const levelMultiplier = {
                '新進': 0.00,
                '一般': 0.05,
                '資深': 0.10,
                '名師': 0.15
            };
            
            const performanceRate = levelMultiplier[teacher.performanceLevel] || 0;
            let performanceBonus = Math.round(basicSalary * performanceRate);
            
            // 出席率調整
            const attendanceRate = attendanceRecords.length > 0 ? 
                attendanceRecords.filter(r => r.isCompleted).length / attendanceRecords.length : 1;
            
            if (attendanceRate >= 0.95) {
                performanceBonus = Math.round(performanceBonus * 1.2);
            } else if (attendanceRate >= 0.90) {
                performanceBonus = Math.round(performanceBonus * 1.1);
            } else if (attendanceRate < 0.80) {
                performanceBonus = Math.round(performanceBonus * 0.8);
            }
            
            const totalSalary = basicSalary + recruitmentBonus + performanceBonus;
            
            return {
                teacherId,
                teacherName: teacher.name,
                month,
                basicSalary,
                recruitmentBonus,
                performanceBonus,
                totalHours,
                totalSalary,
                performanceRate: performanceRate * 100,
                courseBreakdown: Object.values(courseBreakdown),
                recruitmentBreakdown,
                attendanceRate: Math.round(attendanceRate * 100)
            };
        }

        function displaySalaryResult(result) {
            document.getElementById('basic-salary').textContent = `${result.basicSalary.toLocaleString()}`;
            document.getElementById('basic-hours').textContent = `${result.totalHours} 小時`;
            document.getElementById('recruitment-bonus').textContent = `${result.recruitmentBonus.toLocaleString()}`;
            document.getElementById('recruitment-count').textContent = `${result.recruitmentBreakdown.length} 位新生`;
            document.getElementById('performance-bonus').textContent = `${result.performanceBonus.toLocaleString()}`;
            document.getElementById('performance-rate').textContent = `${result.performanceRate}% 獎金率`;
            document.getElementById('total-salary').textContent = `${result.totalSalary.toLocaleString()}`;
            document.getElementById('salary-teacher-name').textContent = result.teacherName;
            
            // 更新課程明細
            const courseBreakdownEl = document.getElementById('course-breakdown');
            courseBreakdownEl.innerHTML = '';
            
            if (result.courseBreakdown.length > 0) {
                result.courseBreakdown.forEach(breakdown => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded border';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium text-gray-900">${breakdown.name}</div>
                            <div class="text-sm text-gray-500">${breakdown.hours}小時 × ${breakdown.rate}</div>
                        </div>
                        <div class="text-lg font-bold text-primary">${breakdown.subtotal.toLocaleString()}</div>
                    `;
                    courseBreakdownEl.appendChild(div);
                });
            } else {
                courseBreakdownEl.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">本月無上課紀錄</p>';
            }
            
            // 更新招生明細
            const recruitmentBreakdownEl = document.getElementById('recruitment-breakdown');
            recruitmentBreakdownEl.innerHTML = '';
            
            if (result.recruitmentBreakdown.length > 0) {
                result.recruitmentBreakdown.forEach(breakdown => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded border';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium text-gray-900">${breakdown.studentName}</div>
                            <div class="text-sm text-gray-500">學費 ${breakdown.studentFee.toLocaleString()}</div>
                        </div>
                        <div class="text-lg font-bold text-secondary">${breakdown.bonusAmount.toLocaleString()}</div>
                    `;
                    recruitmentBreakdownEl.appendChild(div);
                });
            } else {
                recruitmentBreakdownEl.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">本月無新增學生</p>';
            }
        }

        function displayAllSalariesResult(results, totals) {
            const tableBody = document.getElementById('all-salaries-table');
            tableBody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.teacherName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.basicSalary.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.recruitmentBonus.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.performanceBonus.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.totalSalary.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showIndividualSalary(${result.teacherId})" class="text-blue-600 hover:text-blue-800">查看明細</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // 更新總計
            document.getElementById('total-basic-salary').textContent = `${totals.totalBasic.toLocaleString()}`;
            document.getElementById('total-recruitment-bonus').textContent = `${totals.totalRecruitment.toLocaleString()}`;
            document.getElementById('total-performance-bonus').textContent = `${totals.totalPerformance.toLocaleString()}`;
            document.getElementById('grand-total-salary').textContent = `${totals.grandTotal.toLocaleString()}`;
        }

        // ===== 模態框與UI控制 =====
        
        function showSection(sectionName) {
            // 隱藏所有區段
            const sections = document.querySelectorAll('.section-content');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // 顯示選中的區段
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                appData.currentSection = sectionName;
            }
        }

        function showAddTeacherModal() {
            resetTeacherForm();
            document.getElementById('teacher-modal-title').textContent = '新增教師';
            document.getElementById('teacher-submit-text').textContent = '新增';
            document.getElementById('teacher-modal').classList.remove('hidden');
            document.getElementById('teacher-modal').classList.add('flex');
        }

        function showAddCourseModal() {
            resetCourseForm();
            document.getElementById('course-modal-title').textContent = '新增課程';
            document.getElementById('course-submit-text').textContent = '新增';
            document.getElementById('course-modal').classList.remove('hidden');
            document.getElementById('course-modal').classList.add('flex');
        }

        function showAddStudentModal() {
            resetStudentForm();
            updateCourseSelects();
            updateTeacherSelects();
            document.getElementById('student-modal-title').textContent = '新增學生';
            document.getElementById('student-submit-text').textContent = '新增';
            document.getElementById('student-modal').classList.remove('hidden');
            document.getElementById('student-modal').classList.add('flex');
        }

        function showAddAttendanceModal() {
            resetAttendanceForm();
            updateTeacherSelects();
            updateCourseSelects();
            document.getElementById('attendance-modal-title').textContent = '新增出勤紀錄';
            document.getElementById('attendance-submit-text').textContent = '新增';
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-modal').classList.remove('hidden');
            document.getElementById('attendance-modal').classList.add('flex');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        // ===== 編輯功能 =====
        
        function editTeacher(id) {
            const teacher = appData.teachers.find(t => t.id === id);
            if (!teacher) return;
            
            document.getElementById('teacher-id').value = teacher.id;
            document.getElementById('teacher-name').value = teacher.name;
            document.getElementById('teacher-subject').value = teacher.subject;
            document.getElementById('teacher-rate').value = teacher.hourlyRate;
            document.getElementById('teacher-level').value = teacher.performanceLevel;
            document.getElementById('teacher-bonus-rate').value = teacher.recruitmentBonusRate;
            document.getElementById('teacher-contact').value = teacher.contactInfo;
            
            document.getElementById('teacher-modal-title').textContent = '編輯教師';
            document.getElementById('teacher-submit-text').textContent = '更新';
            document.getElementById('teacher-modal').classList.remove('hidden');
            document.getElementById('teacher-modal').classList.add('flex');
        }

        function editCourse(id) {
            const course = appData.courses.find(c => c.id === id);
            if (!course) return;
            
            document.getElementById('course-id').value = course.id;
            document.getElementById('course-name').value = course.name;
            document.getElementById('course-level').value = course.level;
            document.getElementById('course-subject').value = course.subject;
            document.getElementById('course-rate').value = course.standardRate;
            document.getElementById('course-duration').value = course.duration;
            document.getElementById('course-max-students').value = course.maxStudents || '';
            
            document.getElementById('course-modal-title').textContent = '編輯課程';
            document.getElementById('course-submit-text').textContent = '更新';
            document.getElementById('course-modal').classList.remove('hidden');
            document.getElementById('course-modal').classList.add('flex');
        }

        function editStudent(id) {
            const student = appData.students.find(s => s.id === id);
            if (!student) return;
            
            updateCourseSelects();
            updateTeacherSelects();
            
            document.getElementById('student-id').value = student.id;
            document.getElementById('student-name').value = student.name;
            document.getElementById('student-course').value = student.courseIds[0];
            document.getElementById('student-fee').value = student.totalFee;
            document.getElementById('student-paid').value = student.paidAmount;
            document.getElementById('student-status').value = student.paymentStatus;
            document.getElementById('student-referrer').value = student.referrerTeacherId || '';
            document.getElementById('student-contact').value = student.contactInfo;
            
            document.getElementById('student-modal-title').textContent = '編輯學生';
            document.getElementById('student-submit-text').textContent = '更新';
            document.getElementById('student-modal').classList.remove('hidden');
            document.getElementById('student-modal').classList.add('flex');
        }

        function editAttendance(id) {
            const attendance = appData.attendance.find(a => a.id === id);
            if (!attendance) return;
            
            updateTeacherSelects();
            updateCourseSelects();
            
            document.getElementById('attendance-id').value = attendance.id;
            document.getElementById('attendance-date').value = new Date(attendance.date).toISOString().split('T')[0];
            document.getElementById('attendance-teacher').value = attendance.teacherId;
            document.getElementById('attendance-course').value = attendance.courseId;
            document.getElementById('attendance-hours').value = attendance.actualHours;
            document.getElementById('attendance-students').value = attendance.studentCount;
            document.getElementById('attendance-status').value = attendance.status || 'completed';
            document.getElementById('attendance-notes').value = attendance.notes;
            
            document.getElementById('attendance-modal-title').textContent = '編輯出勤紀錄';
            document.getElementById('attendance-submit-text').textContent = '更新';
            document.getElementById('attendance-modal').classList.remove('hidden');
            document.getElementById('attendance-modal').classList.add('flex');
        }

        // ===== 刪除功能 =====
        
        function deleteTeacher(id) {
            const teacher = appData.teachers.find(t => t.id === id);
            if (!teacher) return;
            
            if (confirm(`確定要刪除教師「${teacher.name}」嗎？\n\n注意：這會同時刪除相關的出勤紀錄，此操作無法復原。`)) {
                // 刪除相關出勤紀錄
                appData.attendance = appData.attendance.filter(a => a.teacherId !== id);
                
                // 清除學生的介紹人關聯
                appData.students.forEach(student => {
                    if (student.referrerTeacherId === id) {
                        student.referrerTeacherId = null;
                    }
                });
                
                // 刪除教師
                appData.teachers = appData.teachers.filter(t => t.id !== id);
                
                saveDataToStorage();
                updateAllDisplays();
                showNotification(`教師「${teacher.name}」已刪除`);
            }
        }

        function deleteCourse(id) {
            const course = appData.courses.find(c => c.id === id);
            if (!course) return;
            
            // 檢查是否有學生報讀此課程
            const enrolledStudents = appData.students.filter(s => s.courseIds.includes(id));
            
            if (enrolledStudents.length > 0) {
                showNotification(`無法刪除課程「${course.name}」，仍有 ${enrolledStudents.length} 位學生報讀此課程`, 'error');
                return;
            }
            
            if (confirm(`確定要刪除課程「${course.name}」嗎？\n\n這會同時刪除相關的出勤紀錄，此操作無法復原。`)) {
                // 刪除相關出勤紀錄
                appData.attendance = appData.attendance.filter(a => a.courseId !== id);
                
                // 刪除課程
                appData.courses = appData.courses.filter(c => c.id !== id);
                
                saveDataToStorage();
                updateAllDisplays();
                showNotification(`課程「${course.name}」已刪除`);
            }
        }

        function deleteStudent(id) {
            const student = appData.students.find(s => s.id === id);
            if (!student) return;
            
            if (confirm(`確定要刪除學生「${student.name}」嗎？\n\n此操作無法復原。`)) {
                appData.students = appData.students.filter(s => s.id !== id);
                saveDataToStorage();
                updateAllDisplays();
                showNotification(`學生「${student.name}」已刪除`);
            }
        }

        function deleteAttendance(id) {
            const attendance = appData.attendance.find(a => a.id === id);
            if (!attendance) return;
            
            if (confirm('確定要刪除這筆出勤紀錄嗎？此操作無法復原。')) {
                appData.attendance = appData.attendance.filter(a => a.id !== id);
                saveDataToStorage();
                updateAttendanceTable();
                updateAttendanceCalendar();
                updateCounters();
                showNotification('出勤紀錄已刪除');
            }
        }

        // ===== 表單重置功能 =====
        
        function resetTeacherForm() {
            document.getElementById('teacher-form').reset();
            document.getElementById('teacher-id').value = '';
        }

        function resetCourseForm() {
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
        }

        function resetStudentForm() {
            document.getElementById('student-form').reset();
            document.getElementById('student-id').value = '';
        }

        function resetAttendanceForm() {
            document.getElementById('attendance-form').reset();
            document.getElementById('attendance-id').value = '';
        }

        // ===== 排序功能 =====
        
        function sortTable(table, column) {
            const currentSort = appData.sortConfig;
            
            if (currentSort.table === table && currentSort.column === column) {
                // 切換排序方向
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // 新的排序欄位
                currentSort.table = table;
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // 更新排序圖標
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = '↑';
                icon.classList.remove('desc');
            });
            
            const activeIcon = event.target.querySelector('.sort-icon');
            if (activeIcon) {
                if (currentSort.direction === 'desc') {
                    activeIcon.classList.add('desc');
                }
            }
            
            // 重新渲染表格
            if (table === 'teachers') {
                updateTeachersTable();
            } else if (table === 'students') {
                updateStudentsTable();
            }
        }

        // ===== 日曆功能 =====
        
        function previousMonth() {
            appData.currentCalendarDate.setMonth(appData.currentCalendarDate.getMonth() - 1);
            updateAttendanceCalendar();
        }

        function nextMonth() {
            appData.currentCalendarDate.setMonth(appData.currentCalendarDate.getMonth() + 1);
            updateAttendanceCalendar();
        }

        function showDayAttendance(date) {
            const dayAttendance = appData.attendance.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.toDateString() === date.toDateString();
            });
            
            if (dayAttendance.length === 0) {
                showNotification(`${date.toLocaleDateString('zh-TW')} 無課程安排`, 'info');
                return;
            }
            
            let message = `${date.toLocaleDateString('zh-TW')} 課程安排：\n\n`;
            dayAttendance.forEach(record => {
                const teacher = appData.teachers.find(t => t.id === record.teacherId);
                const course = appData.courses.find(c => c.id === record.courseId);
                message += `• ${teacher?.name || '未知教師'} - ${course?.name || '未知課程'}\n`;
                message += `  時數：${record.actualHours}小時，學生：${record.studentCount}人\n`;
                if (record.notes) {
                    message += `  備註：${record.notes}\n`;
                }
                message += '\n';
            });
            
            alert(message);
        }

        // ===== 報表功能 =====
        
        function showReportsModal() {
            updateFinancialReport();
            document.getElementById('reports-modal').classList.remove('hidden');
            document.getElementById('reports-modal').classList.add('flex');
        }

        function showReportTab(tabName) {
            // 切換選項卡
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 切換內容
            document.querySelectorAll('.report-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + '-report').classList.remove('hidden');
            
            // 載入對應報表
            if (tabName === 'financial') {
                updateFinancialReport();
            } else if (tabName === 'performance') {
                updatePerformanceReport();
            } else if (tabName === 'attendance') {
                updateAttendanceReport();
            }
        }

        function updateFinancialReport() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // 計算本月收入（學費）
            const monthlyIncome = appData.students
                .filter(student => {
                    const enrollDate = new Date(student.enrollDate);
                    return enrollDate.getMonth() === currentMonth && 
                           enrollDate.getFullYear() === currentYear;
                })
                .reduce((sum, student) => sum + student.paidAmount, 0);
            
            // 計算本月支出（薪資）
            let monthlyExpense = 0;
            appData.teachers.forEach(teacher => {
                const result = performSalaryCalculation(teacher.id, `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`);
                monthlyExpense += result.totalSalary;
            });
            
            const netProfit = monthlyIncome - monthlyExpense;
            
            document.getElementById('total-income').textContent = `${monthlyIncome.toLocaleString()}`;
            document.getElementById('total-expense').textContent = `${monthlyExpense.toLocaleString()}`;
            document.getElementById('net-profit').textContent = `${netProfit.toLocaleString()}`;
            
            // 繪製圖表
            const ctx = document.getElementById('financial-chart').getContext('2d');
            
            if (financialChart) {
                financialChart.destroy();
            }
            
            financialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['收入', '支出', '淨利'],
                    datasets: [{
                        label: '金額 (元)',
                        data: [monthlyIncome, monthlyExpense, netProfit],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.6)',
                            'rgba(239, 68, 68, 0.6)',
                            'rgba(16, 185, 129, 0.6)'
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(16, 185, 129, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updatePerformanceReport() {
            const currentDate = new Date();
            const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            
            const teacherPerformance = appData.teachers.map(teacher => {
                const result = performSalaryCalculation(teacher.id, currentMonth);
                return {
                    name: teacher.name,
                    totalSalary: result.totalSalary,
                    totalHours: result.totalHours,
                    newStudents: result.recruitmentBreakdown.length
                };
            });
            
            teacherPerformance.sort((a, b) => b.totalSalary - a.totalSalary);
            
            const performanceList = document.getElementById('teacher-performance-list');
            performanceList.innerHTML = '';
            
            teacherPerformance.forEach((teacher, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-white rounded border';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-sm font-bold text-blue-600">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium">${teacher.name}</div>
                            <div class="text-sm text-gray-500">${teacher.totalHours}小時 • ${teacher.newStudents}位新生</div>
                        </div>
                    </div>
                    <div class="text-lg font-bold text-gray-900">${teacher.totalSalary.toLocaleString()}</div>
                `;
                performanceList.appendChild(div);
            });
        }

        function updateAttendanceReport() {
            // 課程出勤率統計
            const courseAttendance = {};
            appData.courses.forEach(course => {
                const courseRecords = appData.attendance.filter(a => a.courseId === course.id);
                const completedRecords = courseRecords.filter(a => a.isCompleted);
                const rate = courseRecords.length > 0 ? (completedRecords.length / courseRecords.length) * 100 : 0;
                
                courseAttendance[course.id] = {
                    name: course.name,
                    total: courseRecords.length,
                    completed: completedRecords.length,
                    rate: Math.round(rate)
                };
            });
            
            const courseList = document.getElementById('course-attendance-list');
            courseList.innerHTML = '';
            
            Object.values(courseAttendance)
                .sort((a, b) => b.rate - a.rate)
                .forEach(course => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-white rounded border';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium">${course.name}</div>
                            <div class="text-sm text-gray-500">${course.completed}/${course.total} 堂課完成</div>
                        </div>
                        <div class="text-lg font-bold ${course.rate >= 90 ? 'text-green-600' : course.rate >= 70 ? 'text-yellow-600' : 'text-red-600'}">
                            ${course.rate}%
                        </div>
                    `;
                    courseList.appendChild(div);
                });
            
            // 教師出勤統計
            const teacherAttendance = {};
            appData.teachers.forEach(teacher => {
                const teacherRecords = appData.attendance.filter(a => a.teacherId === teacher.id);
                const totalHours = teacherRecords.reduce((sum, record) => sum + record.actualHours, 0);
                
                teacherAttendance[teacher.id] = {
                    name: teacher.name,
                    totalClasses: teacherRecords.length,
                    totalHours: totalHours
                };
            });
            
            const teacherList = document.getElementById('teacher-attendance-list');
            teacherList.innerHTML = '';
            
            Object.values(teacherAttendance)
                .sort((a, b) => b.totalHours - a.totalHours)
                .forEach(teacher => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-white rounded border';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium">${teacher.name}</div>
                            <div class="text-sm text-gray-500">${teacher.totalClasses} 堂課</div>
                        </div>
                        <div class="text-lg font-bold text-blue-600">${teacher.totalHours}h</div>
                    `;
                    teacherList.appendChild(div);
                });
        }

        // ===== 備份與還原功能 =====
        
        function showBackupModal() {
            document.getElementById('backup-modal').classList.remove('hidden');
            document.getElementById('backup-modal').classList.add('flex');
        }

        function exportData() {
            const exportData = {
                teachers: appData.teachers,
                courses: appData.courses,
                students: appData.students,
                attendance: appData.attendance,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `補習班資料備份_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('資料已匯出至下載資料夾');
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('請選擇要匯入的檔案', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 驗證資料格式
                    if (!importedData.teachers || !importedData.courses || !importedData.students || !importedData.attendance) {
                        throw new Error('檔案格式不正確');
                    }
                    
                    if (confirm('確定要匯入資料嗎？這會覆蓋現有的所有資料，此操作無法復原。')) {
                        // 轉換日期字串回 Date 物件
                        importedData.students.forEach(student => {
                            if (student.enrollDate) {
                                student.enrollDate = new Date(student.enrollDate);
                            }
                        });
                        
                        importedData.attendance.forEach(record => {
                            if (record.date) {
                                record.date = new Date(record.date);
                            }
                        });
                        
                        // 替換資料
                        appData.teachers = importedData.teachers;
                        appData.courses = importedData.courses;
                        appData.students = importedData.students;
                        appData.attendance = importedData.attendance;
                        
                        saveDataToStorage();
                        updateAllDisplays();
                        hideModal('backup-modal');
                        
                        showNotification('資料匯入成功');
                    }
                } catch (error) {
                    showNotification('匯入失敗：' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function resetAllData() {
            if (confirm('確定要重置所有資料嗎？這會清除所有教師、課程、學生和出勤資料，此操作無法復原。')) {
                localStorage.clear();
                appData = { 
                    teachers: [], 
                    courses: [], 
                    students: [], 
                    attendance: [],
                    currentSection: null,
                    sortConfig: { table: null, column: null, direction: 'asc' },
                    currentCalendarDate: new Date(),
                    filters: {
                        teachers: { search: '', level: '' },
                        courses: { search: '', level: '' },
                        students: { search: '', status: '' }
                    }
                };
                initializeDefaultData();
                updateAllDisplays();
                hideModal('backup-modal');
                showNotification('資料已重置為預設狀態');
            }
        }

        // ===== 輔助功能 =====
        
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = timeString;
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
                loading.classList.add('flex');
            } else {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            const notificationIcon = document.getElementById('notification-icon');
            const notificationEl = notification.querySelector('.border-l-4');
            
            notificationText.textContent = message;
            
            // 設定通知樣式
            notificationEl.className = 'bg-white border-l-4 p-4 shadow-lg rounded';
            
            if (type === 'success') {
                notificationEl.classList.add('border-green-400');
                notificationIcon.className = 'h-5 w-5 text-green-400';
                notificationIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>';
            } else if (type === 'error') {
                notificationEl.classList.add('border-red-400');
                notificationIcon.className = 'h-5 w-5 text-red-400';
                notificationIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>';
            } else if (type === 'info') {
                notificationEl.classList.add('border-blue-400');
                notificationIcon.className = 'h-5 w-5 text-blue-400';
                notificationIcon.innerHTML = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                hideNotification();
            }, 4000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        function getLevelColor(level) {
            const colors = {
                '新進': 'bg-gray-100 text-gray-800',
                '一般': 'bg-blue-100 text-blue-800',
                '資深': 'bg-green-100 text-green-800',
                '名師': 'bg-purple-100 text-purple-800'
            };
            return colors[level] || 'bg-gray-100 text-gray-800';
        }

        function getStatusColor(status) {
            const colors = {
                '已繳費': 'bg-green-100 text-green-800',
                '未繳費': 'bg-red-100 text-red-800',
                '部分繳費': 'bg-yellow-100 text-yellow-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function showIndividualSalary(teacherId) {
            document.getElementById('salary-teacher').value = teacherId;
            calculateSalary();
            showSection('salary');
        }

        function printSalarySlip() {
            const teacherName = document.getElementById('salary-teacher-name').textContent;
            const month = document.getElementById('salary-month').value;
            
            if (!teacherName) {
                showNotification('請先計算薪資', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const salaryContent = document.getElementById('salary-result').innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>薪資單 - ${teacherName} (${month})</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .salary-details { margin: 20px 0; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>補習班薪資單</h1>
                        <h2>${teacherName} - ${month}</h2>
                    </div>
                    <div class="salary-details">
                        ${salaryContent}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function exportSalaryPDF() {
            showNotification('PDF 匯出功能開發中，請使用列印功能', 'info');
        }
    </script>
</body>
</html>