<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>Bybit WebSocket æ¸¬è©¦ - publicTrade & orderbook</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .status {
        font-size: 16px;
        margin: 5px 0;
      }
      .error {
        color: red;
        font-weight: bold;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
      }
      table,
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
      }
      th {
        background: #f4f4f4;
      }
      #orderbookTable td {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>Bybit WebSocket æ¸¬è©¦ - publicTrade & orderbook</h2>

    <div class="status">
      WebSocket é€£ç·šç‹€æ…‹ï¼š<span id="connStatus">æœªé€£ç·š</span>
    </div>
    <div class="status error">éŒ¯èª¤è¨Šæ¯ï¼š<span id="errorMsg"></span></div>

    <h3>å³æ™‚æˆäº¤æ•¸æ“š (`publicTrade.ETHUSDT`)</h3>
    <table>
      <thead>
        <tr>
          <th>æ™‚é–“</th>
          <th>åƒ¹æ ¼ (USD)</th>
          <th>æˆäº¤é‡ (ETH)</th>
          <th>æ–¹å‘</th>
        </tr>
      </thead>
      <tbody id="tradeBody"></tbody>
    </table>

    <h3>è¨‚å–®ç°¿ (`orderbook.1.ETHUSDT`)</h3>
    <table id="orderbookTable">
      <thead>
        <tr>
          <th>è²·å–®åƒ¹æ ¼</th>
          <th>è²·å–®æ•¸é‡</th>
          <th>è³£å–®åƒ¹æ ¼</th>
          <th>è³£å–®æ•¸é‡</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="bidPrice">-</td>
          <td id="bidSize">-</td>
          <td id="askPrice">-</td>
          <td id="askSize">-</td>
        </tr>
      </tbody>
    </table>

    <script>
      let ws;
      let tradeBody = document.getElementById("tradeBody");
      let bidPriceEl = document.getElementById("bidPrice");
      let bidSizeEl = document.getElementById("bidSize");
      let askPriceEl = document.getElementById("askPrice");
      let askSizeEl = document.getElementById("askSize");

      // åˆå§‹åŒ– WebSocket
      function initWebSocket() {
        ws = new WebSocket("wss://stream.bybit.com/v5/public/linear");

        ws.onopen = () => {
          document.getElementById("connStatus").innerText = "âœ… å·²é€£ç·š";
          ws.send(
            JSON.stringify({
              op: "subscribe",
              args: ["publicTrade.ETHUSDT", "orderbook.1.ETHUSDT"],
            })
          );

          // æ¯ 20 ç§’ç™¼é€ ping
          setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ op: "ping" }));
            }
          }, 20000);
        };

        ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);

            // è™•ç† `publicTrade`
            if (msg.topic === "publicTrade.ETHUSDT" && msg.data) {
              updateTradeTable(msg.data[0]);
            }

            // è™•ç† `orderbook.1`
            if (msg.topic === "orderbook.1.ETHUSDT" && msg.data) {
              updateOrderbook(msg.data);
            }

            if (msg.op === "pong") {
              console.log("âœ… æ”¶åˆ° PONGï¼Œé€£ç·šä¿æŒä¸­...");
            }
          } catch (e) {
            document.getElementById("errorMsg").innerText =
              "è§£æéŒ¯èª¤: " + e.message;
          }
        };

        ws.onclose = () =>
          (document.getElementById("connStatus").innerText = "âŒ å·²é—œé–‰");
        ws.onerror = (error) =>
          (document.getElementById("errorMsg").innerText =
            "âŒ é€£ç·šéŒ¯èª¤: " + error.message);
      }

      // æ›´æ–°æˆäº¤è¡¨æ ¼
      function updateTradeTable(trade) {
        let time = new Date(trade.T).toLocaleTimeString();
        let price = parseFloat(trade.p).toFixed(2);
        let size = parseFloat(trade.q).toFixed(4);
        let side = trade.S === "Buy" ? "ğŸŸ¢ è²·å…¥" : "ğŸ”´ è³£å‡º";

        let row = `<tr>
    <td>${time}</td>
    <td>${price}</td>
    <td>${size}</td>
    <td>${side}</td>
  </tr>`;

        tradeBody.insertAdjacentHTML("afterbegin", row);
        if (tradeBody.rows.length > 10) {
          tradeBody.deleteRow(tradeBody.rows.length - 1);
        }
      }

      // æ›´æ–°è¨‚å–®ç°¿
      function updateOrderbook(data) {
        if (data.b.length > 0) {
          bidPriceEl.innerText = parseFloat(data.b[0][0]).toFixed(2);
          bidSizeEl.innerText = parseFloat(data.b[0][1]).toFixed(4);
        }
        if (data.a.length > 0) {
          askPriceEl.innerText = parseFloat(data.a[0][0]).toFixed(2);
          askSizeEl.innerText = parseFloat(data.a[0][1]).toFixed(4);
        }
      }

      // å•Ÿå‹• WebSocket
      initWebSocket();
    </script>
  </body>
</html>
