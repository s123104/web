<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>Bybit åˆç´„å…¬å…±æµæ¥å…¥æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .status {
        font-size: 16px;
        margin: 5px 0;
      }
      .error {
        color: red;
        font-weight: bold;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
        font-size: 14px;
      }
      table,
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
      }
      th {
        background: #f4f4f4;
      }
      #chartContainer {
        width: 600px;
        height: 300px;
        margin-top: 10px;
      }
      #controls {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <h2>Bybit åˆç´„å…¬å…±æµæ¥å…¥æ¸¬è©¦</h2>

    <!-- å¹£ç¨®åˆ‡æ›æ§åˆ¶ -->
    <div id="controls">
      <label for="symbolSelect">é¸æ“‡å¹£ç¨®ï¼š</label>
      <select id="symbolSelect">
        <option value="BTCUSDT">BTCUSDT</option>
        <option value="ETHUSDT" selected>ETHUSDT</option>
        <option value="XRPUSDT">XRPUSDT</option>
        <option value="LTCUSDT">LTCUSDT</option>
      </select>
      <button onclick="switchSymbol()">åˆ‡æ›å¹£ç¨®</button>
    </div>

    <!-- ç‹€æ…‹é¢æ¿ -->
    <div class="status">
      WebSocket é€£ç·šç‹€æ…‹ï¼š<span id="connStatus">æœªé€£ç·š</span>
    </div>
    <div class="status">æœ€æ–°åƒ¹æ ¼ (K ç·š)ï¼š<span id="latestPrice">-</span></div>
    <div class="status">Ticker è³‡æ–™ï¼š<span id="tickerInfo">-</span></div>
    <div class="status error">éŒ¯èª¤è¨Šæ¯ï¼š<span id="errorMsg"></span></div>

    <!-- K ç·šåœ–è¡¨ -->
    <div id="chartContainer"></div>

    <!-- æˆäº¤æ•¸æ“šè¡¨ -->
    <h3>æˆäº¤æ•¸æ“š (publicTrade)</h3>
    <table>
      <thead>
        <tr>
          <th>æ™‚é–“</th>
          <th>åƒ¹æ ¼ (USD)</th>
          <th>æˆäº¤é‡</th>
          <th>æ–¹å‘</th>
        </tr>
      </thead>
      <tbody id="tradeBody"></tbody>
    </table>

    <!-- è¨‚å–®ç°¿è¡¨ -->
    <h3>è¨‚å–®ç°¿ (orderbook.1)</h3>
    <table>
      <thead>
        <tr>
          <th>è²·å–®åƒ¹æ ¼</th>
          <th>è²·å–®æ•¸é‡</th>
          <th>è³£å–®åƒ¹æ ¼</th>
          <th>è³£å–®æ•¸é‡</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="bidPrice">-</td>
          <td id="bidSize">-</td>
          <td id="askPrice">-</td>
          <td id="askSize">-</td>
        </tr>
      </tbody>
    </table>

    <script>
      let ws;
      let candleSeries;
      let currentCandle = null;
      let lastCandleTime = null;
      let currentSymbol = document.getElementById("symbolSelect").value;

      const tradeBody = document.getElementById("tradeBody");
      const bidPriceEl = document.getElementById("bidPrice");
      const bidSizeEl = document.getElementById("bidSize");
      const askPriceEl = document.getElementById("askPrice");
      const askSizeEl = document.getElementById("askSize");
      const latestPriceEl = document.getElementById("latestPrice");
      const tickerInfoEl = document.getElementById("tickerInfo");

      // åˆå§‹åŒ– K ç·šåœ–è¡¨
      function initChart() {
        if (typeof LightweightCharts === "undefined") {
          document.getElementById("errorMsg").innerText = "âŒ åœ–è¡¨åº«è¼‰å…¥å¤±æ•—";
          return;
        }
        const chart = LightweightCharts.createChart(
          document.getElementById("chartContainer"),
          { width: 600, height: 300 }
        );
        candleSeries = chart.addCandlestickSeries();
      }

      // æ›´æ–° K ç·šè³‡æ–™èˆ‡æœ€æ–°åƒ¹æ ¼
      function updateKline(time, open, high, low, close) {
        latestPriceEl.innerText = close.toFixed(2);
        if (candleSeries) {
          if (currentCandle === null || time !== lastCandleTime) {
            currentCandle = {
              time: time,
              open: open,
              high: high,
              low: low,
              close: close,
            };
            lastCandleTime = time;
            candleSeries.update(currentCandle);
          } else {
            currentCandle.high = Math.max(currentCandle.high, high);
            currentCandle.low = Math.min(currentCandle.low, low);
            currentCandle.close = close;
            candleSeries.update(currentCandle);
          }
        }
      }

      // æ›´æ–°æˆäº¤æ•¸æ“šè¡¨ï¼Œå˜—è©¦è®€å–å¤šç¨®å¯èƒ½çš„æˆäº¤é‡æ¬„ä½
      function updateTradeTable(trade) {
        let time = new Date(trade.T).toLocaleTimeString();
        let volume = 0;
        if (trade.q) {
          volume = parseFloat(trade.q);
        } else if (trade.qty) {
          volume = parseFloat(trade.qty);
        } else if (trade.v) {
          volume = parseFloat(trade.v);
        } else if (trade.volume) {
          volume = parseFloat(trade.volume);
        }
        let price = parseFloat(trade.p).toFixed(2);
        let volumeStr = volume.toFixed(4);
        let side = trade.S === "Buy" ? "ğŸŸ¢ è²·å…¥" : "ğŸ”´ è³£å‡º";
        let row = `<tr>
          <td>${time}</td>
          <td>${price}</td>
          <td>${volumeStr}</td>
          <td>${side}</td>
        </tr>`;
        tradeBody.insertAdjacentHTML("afterbegin", row);
        if (tradeBody.rows.length > 10) {
          tradeBody.deleteRow(tradeBody.rows.length - 1);
        }
      }

      // æ›´æ–°è¨‚å–®ç°¿æ•¸æ“š
      function updateOrderbook(data) {
        if (data.b && data.b.length > 0) {
          bidPriceEl.innerText = parseFloat(data.b[0][0]).toFixed(2);
          bidSizeEl.innerText = parseFloat(data.b[0][1]).toFixed(4);
        }
        if (data.a && data.a.length > 0) {
          askPriceEl.innerText = parseFloat(data.a[0][0]).toFixed(2);
          askSizeEl.innerText = parseFloat(data.a[0][1]).toFixed(4);
        }
      }

      // æ›´æ–° Ticker è³‡æ–™ (åŒ…å«æœ€æ–°åƒ¹ã€æˆäº¤é‡ã€æ¨™è¨˜åƒ¹ã€æŒ‡æ•¸åƒ¹ã€æ¼²è·Œ)
      function updateTicker(data) {
        if (data && data.length > 0) {
          const t = data[0];
          let info = `æœ€æ–°åƒ¹: ${parseFloat(t.lastPrice).toFixed(
            2
          )} USD, æˆäº¤é‡: ${parseFloat(t.volume).toFixed(2)}`;
          if (t.markPrice) {
            info += `, æ¨™è¨˜åƒ¹: ${parseFloat(t.markPrice).toFixed(2)}`;
          }
          if (t.indexPrice) {
            info += `, æŒ‡æ•¸åƒ¹: ${parseFloat(t.indexPrice).toFixed(2)}`;
          }
          if (t.change) {
            info += `, æ¼²è·Œ: ${t.change}`;
          }
          tickerInfoEl.innerText = info;
        }
      }

      // åˆå§‹åŒ– WebSocket æ¥å…¥ï¼ŒæŒ‰ Bybit æ–‡æª”æ ¼å¼ç™¼é€è¨‚é–±è¨Šæ¯
      function initWebSocket() {
        // è‹¥å·²æœ‰é€£ç·šï¼Œå…ˆé—œé–‰
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
        }
        currentCandle = null;
        lastCandleTime = null;
        tradeBody.innerHTML = "";

        // é€£æ¥åˆ°ä¸»ç¶²åˆç´„å…¬å…±æµ
        ws = new WebSocket("wss://stream.bybit.com/v5/public/linear");
        ws.onopen = () => {
          document.getElementById("connStatus").innerText = "âœ… å·²é€£ç·š";
          // æŒ‰å®˜æ–¹æ ¼å¼ç™¼é€è¨‚é–±è¨Šæ¯ï¼ŒåŒ…å« req_id èˆ‡ op
          const subscribeMsg = {
            req_id: "test001",
            op: "subscribe",
            args: [
              "kline.1." + currentSymbol, // 1ç§’ K ç·š
              "publicTrade." + currentSymbol, // æˆäº¤æ•¸æ“š
              "orderbook.1." + currentSymbol, // L1 è¨‚å–®ç°¿
              "tickers." + currentSymbol, // Ticker è³‡æ–™
              // è‹¥æœ‰å…¶ä»–æ•¸æ“šéœ€æ±‚ï¼Œå¦‚é–‹å€‰é‡ã€è³‡é‡‘è²»ç‡ï¼Œå¯è£œä¸Š
              // "openInterest." + currentSymbol,
              // "fundingRate." + currentSymbol
            ],
          };
          ws.send(JSON.stringify(subscribeMsg));
          // æ¯ 20 ç§’ç™¼é€ pingï¼Œä¿æŒé€£ç·š
          setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ req_id: "ping001", op: "ping" }));
            }
          }, 20000);
        };

        ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            if (msg.op === "pong") {
              console.log("âœ… æ”¶åˆ° PONG");
            }
            // è™•ç† K ç·šæ•¸æ“š
            if (msg.topic === "kline.1." + currentSymbol && msg.data) {
              const kline = msg.data[0];
              updateKline(
                kline.start,
                parseFloat(kline.open),
                parseFloat(kline.high),
                parseFloat(kline.low),
                parseFloat(kline.close)
              );
            }
            // è™•ç†æˆäº¤æ•¸æ“š
            if (msg.topic === "publicTrade." + currentSymbol && msg.data) {
              updateTradeTable(msg.data[0]);
            }
            // è™•ç†è¨‚å–®ç°¿æ•¸æ“š
            if (msg.topic === "orderbook.1." + currentSymbol && msg.data) {
              updateOrderbook(msg.data);
            }
            // è™•ç† Ticker è³‡æ–™
            if (msg.topic === "tickers." + currentSymbol && msg.data) {
              updateTicker(msg.data);
            }
          } catch (e) {
            document.getElementById("errorMsg").innerText =
              "è§£æéŒ¯èª¤: " + e.message;
          }
        };

        ws.onclose = () => {
          document.getElementById("connStatus").innerText = "âŒ å·²é—œé–‰";
        };
        ws.onerror = (error) => {
          document.getElementById("errorMsg").innerText =
            "âŒ é€£ç·šéŒ¯èª¤: " + error.message;
        };
      }

      // åˆ‡æ›å¹£ç¨®ï¼Œé‡æ–°åˆå§‹åŒ–é€£ç·š
      function switchSymbol() {
        const select = document.getElementById("symbolSelect");
        currentSymbol = select.value;
        document.getElementById("connStatus").innerText = "é‡æ–°é€£ç·šä¸­...";
        initWebSocket();
      }

      function startApp() {
        initChart();
        initWebSocket();
      }

      startApp();
    </script>

    <!-- è¼‰å…¥ Lightweight Charts åœ–è¡¨åº« -->
    <script
      src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"
      onerror="document.getElementById('errorMsg').innerText='âŒ åœ–è¡¨åº«è¼‰å…¥å¤±æ•—'"
    ></script>
  </body>
</html>
