<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>薪資管理系統（純前端單檔）</title>
  <style>
    :root {
      --bg:#0b1220; --paper:#0f172a; --ink:#e5e7eb; --muted:#93a2b1;
      --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#334155;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, Arial; background: var(--bg); color: var(--ink); }
    header { padding: 16px; border-bottom: 1px solid var(--line); background: linear-gradient(180deg,#0b132c,#0b1220); }
    h1 { margin:0; font-size: 20px; }
    .sub { color: var(--muted); font-size: 12px; }
    nav { display:flex; gap:8px; flex-wrap: wrap; margin-top:8px; }
    nav button { background:#1e293b; color:#fff; border:1px solid #263241; padding:8px 12px; border-radius:8px; cursor:pointer; }
    nav button.active { background:#2563eb; }
    main { max-width: 1100px; margin: 0 auto; padding: 16px; }
    section.view { display:none; border:1px solid var(--line); background: #0f172a; border-radius: 12px; padding: 16px; margin: 12px 0; }
    section.view.active { display:block; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    input, select, textarea, button { padding: 8px; border-radius: 8px; border:1px solid #263241; background:#0b132c; color:#e5e7eb; }
    button.primary { background:#2563eb; border-color:#1d4ed8; }
    button.danger { background:#7f1d1d; border-color:#991b1b; }
    table { width:100%; border-collapse: collapse; background:#0b132c; border-radius:10px; overflow:hidden; }
    th, td { border-bottom:1px solid #1f2a3a; padding:8px; text-align:left; }
    th { color:#cbd5e1; }
    .card { border:1px solid var(--line); border-radius:12px; padding:12px; background:#0b132c; }
    .grid { display:grid; gap:12px; }
    @media (min-width: 900px) { .grid.cols-2 { grid-template-columns: 1fr 1fr; } .grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; } }
    .template { border: 1px dashed #415269; border-radius: 10px; padding: 10px; background:#0f1626; margin-bottom:8px; }
    .total { font-size: 18px; }
    .hint { color: var(--muted); font-size: 12px; }
    .pill { padding:2px 8px; border-radius:999px; border:1px solid #2a3a4a; background:#0b132c; color:#93c5fd; font-size: 12px; }
    .right { text-align:right; }
    .sticky-actions { position: sticky; bottom: 0; padding: 8px; background: #0b132c; border-top: 1px solid #1f2a3a; }
    .hr { height:1px; background:#1f2a3a; margin:8px 0; }
    .footnote { color:#93a2b1; font-size:12px; margin-top:8px; }
    @media print {
      body { background: #fff; color:#000; }
      header, nav, .no-print { display:none !important; }
      section.view { border:0; background:#fff; }
      .template { border:1px solid #000; background:#fff; }
    }
  </style>
</head>
<body>
  <header>
    <h1>薪資管理系統（純前端單檔）</h1>
    <div class="sub">離線可用．localStorage 儲存．產生時間：2025-07-29 18:20:59</div>
    <nav class="no-print">
      <button data-view="dashboard" class="active">總覽</button>
      <button data-view="teachers">教師管理</button>
      <button data-view="slips">薪資單</button>
      <button data-view="version">版號</button>
      <button data-view="io">匯入/匯出</button>
      <button data-view="about">說明</button>
    </nav>
  </header>

  <main>
    <section id="dashboard" class="view active">
      <h2>總覽</h2>
      <div class="row">
        <label>年份 <input id="year" type="number" min="2000" max="2100" value="2025"></label>
        <label>月份 <input id="month" type="number" min="1" max="12" value="5"></label>
        <button id="savePeriod" class="primary">儲存期間</button>
        <span class="hint">期間會套用到薪資單輸出。</span>
      </div>
      <div class="row">
        <button id="recalcAll" class="primary">重新計算所有教師總計</button>
        <button id="clearConsolidated" class="danger">清空薪資單統整</button>
        <button id="printConsolidated">列印/另存 PDF</button>
      </div>
      <div class="grid cols-2">
        <div class="card">
          <h3>教師清單</h3>
          <table id="summaryTable">
            <thead><tr><th>教師代號</th><th>姓名</th><th>分店</th><th class="right">總計 N13</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="3" class="right"><strong>整體總計</strong></td><td id="grandTotal" class="right">$0</td></tr></tfoot>
          </table>
        </div>
        <div class="card">
          <h3>分店小計</h3>
          <table id="storeTable">
            <thead><tr><th>分店</th><th class="right">小計</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td class="right"><strong>合計</strong></td><td id="storeGrand" class="right">$0</td></tr></tfoot>
          </table>
        </div>
      </div>
    </section>

    <section id="teachers" class="view">
      <h2>教師管理</h2>
      <div class="card">
        <div class="row">
          <input id="tId" placeholder="教師代號（T01）" style="width:120px">
          <input id="tName" placeholder="姓名" style="width:160px">
          <select id="tStore">
            <option value="">未指定</option>
            <option>虎尾</option><option>斗六</option><option>立昇</option>
          </select>
          <button id="addTeacher" class="primary">新增/更新教師</button>
          <button id="delTeacher" class="danger">刪除教師</button>
        </div>
        <div class="row">
          <select id="pickTeacher"></select>
          <button id="loadTeacher">載入</button>
          <button id="clearRecords">清除上課記錄</button>
        </div>
      </div>

      <div class="card">
        <h3>計算明細（entries）</h3>
        <div class="row">
          <button id="addHourly">新增「時薪」</button>
          <button id="addFixed">新增「固定金額」</button>
          <span id="currentTeacherLabel" class="pill">未選擇教師</span>
        </div>
        <table id="entriesTable">
          <thead>
            <tr><th>#</th><th>類型</th><th>小時</th><th>時薪</th><th>固定金額</th><th class="right">小計</th><th>操作</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="5" class="right"><strong>合計（N13）</strong></td><td id="entriesTotal" class="right">$0</td><td></td></tr>
          </tfoot>
        </table>
        <div class="sticky-actions no-print">
          <button id="saveEntries" class="primary">儲存並重算</button>
        </div>
      </div>
    </section>

    <section id="slips" class="view">
      <h2>薪資單</h2>
      <div class="row">
        <select id="slipTeacher"></select>
        <button id="copySmall">小格複製</button>
        <button id="copyLarge">大格複製</button>
        <button id="clearConsolidated2" class="danger">清空統整</button>
      </div>
      <div class="grid cols-3">
        <div class="card">
          <h3>小格模板</h3>
          <div id="smallTemplate" class="template">
            <div class="row"><strong>教師</strong>&nbsp;<span data-bind="name"></span></div>
            <div class="row"><strong>代號</strong>&nbsp;<span data-bind="id"></span></div>
            <div class="row total"><strong>總計</strong>&nbsp;<span data-bind="total"></span></div>
          </div>
        </div>
        <div class="card">
          <h3>大格模板</h3>
          <div id="largeTemplate" class="template">
            <div class="row"><strong>年份</strong>&nbsp;<span data-bind="year"></span></div>
            <div class="row"><strong>月份</strong>&nbsp;<span data-bind="month"></span></div>
            <div class="row"><strong>教師</strong>&nbsp;<span data-bind="name"></span> (<span data-bind="id"></span>)</div>
            <div class="row"><strong>明細</strong></div>
            <ul id="detailList"></ul>
            <div class="row total"><strong>總計 N13</strong>&nbsp;<span data-bind="total"></span></div>
          </div>
        </div>
        <div class="card">
          <h3>薪資單統整（列印區）</h3>
          <div id="consolidated"></div>
          <div class="footnote">提示：此區內容將列印或匯出為 PDF。</div>
        </div>
      </div>
    </section>

    <section id="version" class="view">
      <h2>版號</h2>
      <div class="row">
        <input id="verNow" placeholder="例如 2025.05">
        <input id="verOperator" placeholder="操作人（預設會詢問）">
        <button id="recordVersion" class="primary">新增版號紀錄</button>
      </div>
      <table id="verTable">
        <thead><tr><th>版號</th><th>操作人</th><th>裝置資訊</th><th>日期</th><th>時間</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="io" class="view">
      <h2>匯入 / 匯出</h2>
      <div class="row">
        <button id="exportJson" class="primary">匯出 JSON</button>
        <input id="importFile" type="file" accept="application/json">
        <button id="importJson">匯入 JSON</button>
        <button id="resetDb" class="danger">重置資料庫</button>
      </div>
      <div class="hr"></div>
      <div class="hint">資料保存在你的瀏覽器 <code>localStorage</code>。匯出檔可備份/轉移。</div>
    </section>

    <section id="about" class="view">
      <h2>說明</h2>
      <p>本工具為「Excel（含 VBA）→ 純前端」重構的最小可行實作。核心對應：</p>
      <ul>
        <li><strong>N13 計算</strong>：以 <code>calcN13(entries)</code> 實作</li>
        <li><strong>Workbook_Open</strong>：以「新增版號紀錄」取代</li>
        <li><strong>小格/大格複製</strong>：渲染成 HTML 到「薪資單統整」</li>
        <li><strong>清除上課記錄</strong>：清空該教師 entries</li>
        <li><strong>新資料頁/新增目錄資料</strong>：建立教師節點並在總覽自動顯示</li>
      </ul>
    </section>
  </main>

  <script>
    const DB_KEY = "salary_db_v1";
    let db = loadDB();
    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if (raw) { try { return JSON.parse(raw); } catch (e) { console.warn("DB parse error", e); } }
      return {
        period: { year: 2025, month: 5 },
        teachers: {},
        versions: [],
        consolidatedHTML: ""
      };
    }
    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function calcN13(entries) {
      let sum = 0;
      for (const e of entries || []) {
        if (e.type === "hourly") sum += (Number(e.hours)||0) * (Number(e.rate)||0);
        if (e.type === "fixed")  sum += (Number(e.amount)||0);
      }
      return Math.round(sum);
    }
    function upsertTeacher(id, name, store) {
      if (!/^T\d{2}$/i.test(id)) return alert("教師代號需為 T 加兩位數字，例如 T01");
      const t = db.teachers[id] || { id, name:"", store:"", entries:[], total:0 };
      t.name = name || t.name;
      t.store = store || t.store;
      db.teachers[id] = t;
      saveDB(); refreshAll();
    }
    function deleteTeacher(id) {
      if (!db.teachers[id]) return alert("找不到教師");
      if (!confirm("確定刪除教師 "+id+" 嗎？此動作不可復原")) return;
      delete db.teachers[id];
      saveDB(); refreshAll();
    }
    function clearTeachingRecords(id) {
      const t = db.teachers[id];
      if (!t) return alert("找不到教師");
      t.entries = [];
      t.total = 0;
      saveDB(); refreshAll();
      alert("已清除 "+id+" 的上課記錄");
    }
    function saveEntriesFor(id, entries) {
      const t = db.teachers[id] || { id, name:"", store:"", entries:[], total:0 };
      t.entries = entries;
      t.total = calcN13(entries);
      db.teachers[id] = t;
      saveDB(); refreshAll();
    }
    function renderSlip(id, size) {
      const t = db.teachers[id];
      if (!t) return alert("找不到教師");
      const wrap = document.createElement("div");
      wrap.className = "template";
      if (size === "small") {
        wrap.innerHTML = `
          <div><strong>教師</strong> ${t.name||""}</div>
          <div><strong>代號</strong> ${t.id}</div>
          <div class="total"><strong>總計</strong> $ ${(t.total||0).toLocaleString()}</div>`;
      } else {
        const li = (t.entries||[]).map(e => {
          if (e.type === "hourly") return `<li>時薪 ${e.rate} × ${e.hours} 小時 = $ ${(e.rate*e.hours).toLocaleString()}</li>`;
          return `<li>固定項目 = $ ${(Number(e.amount)||0).toLocaleString()}</li>`;
        }).join("");
        wrap.innerHTML = `
          <div><strong>年份</strong> ${db.period.year}</div>
          <div><strong>月份</strong> ${db.period.month}</div>
          <div><strong>教師</strong> ${t.name||""} (${t.id})</div>
          <div><strong>明細</strong></div>
          <ul>${li}</ul>
          <div class="total"><strong>總計 N13</strong> $ ${(t.total||0).toLocaleString()}</div>`;
      }
      document.querySelector("#consolidated").prepend(wrap);
      db.consolidatedHTML = document.querySelector("#consolidated").innerHTML;
      saveDB();
    }
    function recordVersion(ver, operator) {
      if (!ver) return alert("請輸入版號");
      const op = operator || prompt("請輸入操作人") || "unknown";
      const ua = navigator.userAgent;
      const now = new Date();
      db.versions.unshift({
        ver, operator: op, device: ua,
        date: now.toLocaleDateString(), time: now.toLocaleTimeString()
      });
      saveDB(); renderVersionTable();
    }
    function exportJson() {
      const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "salary_db_export.json"; a.click();
      URL.revokeObjectURL(url);
    }
    function importJson(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const imported = JSON.parse(reader.result);
          localStorage.setItem(DB_KEY, JSON.stringify(imported));
          location.reload();
        } catch (e) { alert("JSON 格式錯誤"); }
      };
      reader.readAsText(file);
    }
    function resetDb() {
      if (!confirm("重置資料庫？此動作不可復原")) return;
      localStorage.removeItem(DB_KEY);
      location.reload();
    }
    function $(sel) { return document.querySelector(sel); }
    function $all(sel) { return [...document.querySelectorAll(sel)]; }
    function on(el, ev, fn) { el.addEventListener(ev, fn); }
    on($("#savePeriod"), "click", () => {
      db.period.year = Number($("#year").value)||2025;
      db.period.month = Number($("#month").value)||5;
      saveDB(); refreshAll();
    });
    on($("#recalcAll"), "click", () => {
      for (const id of Object.keys(db.teachers)) {
        db.teachers[id].total = calcN13(db.teachers[id].entries||[]);
      }
      saveDB(); refreshAll(); alert("已重新計算所有教師總計");
    });
    on($("#clearConsolidated"), "click", clearConsolidated);
    on($("#clearConsolidated2"), "click", clearConsolidated);
    function clearConsolidated(){
      $("#consolidated").innerHTML = "";
      db.consolidatedHTML = "";
      saveDB();
    }
    on($("#printConsolidated"), "click", () => window.print());
    on($("#addTeacher"), "click", () => upsertTeacher($("#tId").value.trim(), $("#tName").value.trim(), $("#tStore").value));
    on($("#delTeacher"), "click", () => deleteTeacher($("#tId").value.trim()));
    on($("#loadTeacher"), "click", loadPickedTeacher);
    on($("#clearRecords"), "click", () => {
      const id = $("#tId").value.trim() || $("#pickTeacher").value;
      if (!id) return alert("請先選擇教師");
      clearTeachingRecords(id);
      loadPickedTeacher();
    });
    on($("#addHourly"), "click", () => addEntryRow("hourly"));
    on($("#addFixed"), "click", () => addEntryRow("fixed"));
    on($("#saveEntries"), "click", saveEntriesUI);
    function loadPickedTeacher() {
      const id = $("#pickTeacher").value || $("#tId").value.trim();
      const t = db.teachers[id];
      if (!t) return alert("找不到教師");
      $("#tId").value = t.id; $("#tName").value = t.name||""; $("#tStore").value = t.store||"";
      $("#currentTeacherLabel").textContent = `目標教師：${t.id} ${t.name? " / "+t.name : ""}`;
      renderEntriesTable(t.entries||[]);
      updateEntriesTotal();
    }
    function renderEntriesTable(entries) {
      const tbody = $("#entriesTable tbody"); tbody.innerHTML = "";
      (entries||[]).forEach((e, i) => tbody.appendChild(entryRow(i+1, e)));
    }
    function entryRow(idx, e) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx}</td>
        <td>
          <select class="etype">
            <option value="hourly" ${e.type==="hourly"?"selected":""}>hourly</option>
            <option value="fixed"  ${e.type==="fixed" ?"selected":""}>fixed</option>
          </select>
        </td>
        <td><input class="hours" type="number" step="0.1" value="${e.hours||""}"></td>
        <td><input class="rate"  type="number" step="1"   value="${e.rate||""}"></td>
        <td><input class="amount"type="number" step="1"   value="${e.amount||""}"></td>
        <td class="right cell-sub">$ 0</td>
        <td>
          <button class="delRow">刪除</button>
          <button class="dupRow">複製</button>
        </td>`;
      tr.querySelectorAll("input,select").forEach(el => el.addEventListener("input", updateEntriesTotal));
      tr.querySelector(".delRow").addEventListener("click", () => { tr.remove(); updateEntriesTotal(); });
      tr.querySelector(".dupRow").addEventListener("click", () => {
        const clone = tr.cloneNode(true);
        const tbody = $("#entriesTable tbody");
        tbody.insertBefore(clone, tr.nextSibling);
        clone.querySelectorAll("input,select").forEach(el => el.addEventListener("input", updateEntriesTotal));
        clone.querySelector(".delRow").addEventListener("click", () => { clone.remove(); updateEntriesTotal(); });
        updateEntriesTotal();
      });
      return tr;
    }
    function addEntryRow(type) {
      const e = (type==="hourly") ? {type, hours:"", rate:""} : {type, amount:""};
      $("#entriesTable tbody").appendChild(entryRow($("#entriesTable tbody").children.length+1, e));
      updateEntriesTotal();
    }
    function collectEntriesFromUI() {
      const rows = [...$("#entriesTable tbody").children];
      return rows.map(r => {
        const type = r.querySelector(".etype").value;
        const hours = Number(r.querySelector(".hours").value)||0;
        const rate  = Number(r.querySelector(".rate").value)||0;
        const amount= Number(r.querySelector(".amount").value)||0;
        return type==="hourly" ? { type, hours, rate } : { type, amount };
      });
    }
    function updateEntriesTotal() {
      const rows = [...$("#entriesTable tbody").children];
      let sum = 0;
      rows.forEach(r => {
        const type = r.querySelector(".etype").value;
        const hours = Number(r.querySelector(".hours").value)||0;
        const rate  = Number(r.querySelector(".rate").value)||0;
        const amount= Number(r.querySelector(".amount").value)||0;
        const sub = (type==="hourly") ? hours*rate : amount;
        r.querySelector(".cell-sub").textContent = "$ " + (sub||0).toLocaleString();
        sum += sub||0;
      });
      $("#entriesTotal").textContent = "$ " + Math.round(sum).toLocaleString();
    }
    function saveEntriesUI() {
      const id = $("#tId").value.trim() || $("#pickTeacher").value;
      if (!id) return alert("請先選擇教師");
      const entries = collectEntriesFromUI();
      saveEntriesFor(id, entries);
      alert("已儲存並重算");
    }
    on($("#copySmall"), "click", () => { const id = $("#slipTeacher").value; if(!id) return alert("請選教師"); renderSlip(id,"small"); });
    on($("#copyLarge"), "click", () => { const id = $("#slipTeacher").value; if(!id) return alert("請選教師"); renderSlip(id,"large"); });
    on($("#recordVersion"), "click", () => recordVersion($("#verNow").value.trim(), $("#verOperator").value.trim()));
    on($("#exportJson"), "click", exportJson);
    on($("#importJson"), "click", () => { const f = $("#importFile").files[0]; if(!f) return alert("請選檔案"); importJson(f); });
    on($("#resetDb"), "click", resetDb);
    function refreshAll() {
      $("#year").value = db.period.year;
      $("#month").value = db.period.month;
      const opts = Object.values(db.teachers).sort((a,b)=>a.id.localeCompare(b.id))
        .map(t => `<option value="${t.id}">${t.id} - ${t.name||""}</option>`).join("");
      $("#pickTeacher").innerHTML = `<option value="">選擇教師</option>` + opts;
      $("#slipTeacher").innerHTML = `<option value="">選擇教師</option>` + opts;
      renderSummaryTable();
      renderStoreTable();
      renderVersionTable();
      $("#consolidated").innerHTML = db.consolidatedHTML || "";
    }
    function renderSummaryTable() {
      const tbody = $("#summaryTable tbody"); tbody.innerHTML = "";
      let total = 0;
      Object.values(db.teachers).sort((a,b)=>a.id.localeCompare(b.id)).forEach(t => {
        total += Number(t.total)||0;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${t.id}</td><td>${t.name||""}</td><td>${t.store||""}</td><td class="right">$ ${(t.total||0).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
      $("#grandTotal").textContent = "$ " + total.toLocaleString();
    }
    function renderStoreTable() {
      const map = {};
      for (const t of Object.values(db.teachers)) {
        const key = t.store || "未指定";
        map[key] = (map[key]||0) + (Number(t.total)||0);
      }
      const tbody = $("#storeTable tbody"); tbody.innerHTML = "";
      let sum = 0;
      Object.keys(map).sort().forEach(store => {
        sum += map[store]||0;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${store}</td><td class="right">$ ${(map[store]||0).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
      $("#storeGrand").textContent = "$ " + sum.toLocaleString();
    }
    function renderVersionTable() {
      const tbody = $("#verTable tbody"); tbody.innerHTML = "";
      for (const v of db.versions) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${v.ver}</td><td>${v.operator}</td><td>${v.device}</td><td>${v.date}</td><td>${v.time}</td>`;
        tbody.appendChild(tr);
      }
    }
    $all("nav button").forEach(btn => btn.addEventListener("click", () => {
      const view = btn.dataset.view;
      $all("nav button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      $all("section.view").forEach(s => s.classList.remove("active"));
      document.getElementById(view).classList.add("active");
    }));
    refreshAll();
  </script>
</body>
</html>