<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>薪資管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    body { padding: 20px; font-family: 'Noto Sans TC', sans-serif; }
    .section { margin-bottom: 30px; }
    .grid-template { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; page-break-inside: avoid; }
    .smallGrid { font-size: 14px; }
    .largeGrid { font-size: 16px; }
    #payrollOutput { background: #f8f9fa; padding: 20px; min-height: 200px; }
    .table th, .table td { vertical-align: middle; text-align: center; }
    .error { color: red; font-size: 0.9em; }
    .nav-tabs { margin-bottom: 20px; }
    @media print {
      .grid-template { break-inside: avoid; }
      .no-print { display: none; }
      body { font-size: 12pt; color: #000; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs no-print">
      <li class="nav-item"><a class="nav-link active" href="#overview">總覽</a></li>
      <li class="nav-item"><a class="nav-link" href="#teacherManagement">教師管理</a></li>
      <li class="nav-item"><a class="nav-link" href="#payroll">薪資單</a></li>
      <li class="nav-item"><a class="nav-link" href="#version">版號</a></li>
      <li class="nav-item"><a class="nav-link" href="#importExport">匯入/匯出</a></li>
      <li class="nav-item"><a class="nav-link" href="#help">說明</a></li>
    </ul>

    <!-- 總覽 -->
    <section id="overview" class="section">
      <h2>總覽</h2>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="year">年份</label>
          <input id="year" type="number" class="form-control" min="2000" max="2100" value="2025">
          <div id="yearError" class="error"></div>
        </div>
        <div class="col-md-3">
          <label for="month">月份</label>
          <input id="month" type="number" class="form-control" min="1" max="12" value="5">
          <div id="monthError" class="error"></div>
        </div>
        <div class="col-md-6">
          <label>儲存期間</label>
          <p id="storagePeriod" class="form-control-plaintext">2025-05</p>
        </div>
      </div>
      <p class="text-muted">期間會套用到薪資單輸出。</p>
      <div class="mb-3">
        <button class="btn btn-primary" onclick="recalculateAll()">重新計算所有教師總計</button>
        <button class="btn btn-danger" onclick="clearPayroll()">清空薪資單統整</button>
        <button class="btn btn-success" onclick="exportToPDF()">列印/另存 PDF</button>
      </div>
      <h4>教師清單</h4>
      <table id="teacherList" class="table table-bordered">
        <thead><tr><th>教師代號</th><th>姓名</th><th>分店</th><th>總計 N13</th><th class="no-print">操作</th></tr></thead>
        <tbody></tbody>
      </table>
      <h4>分店小計</h4>
      <table id="branchSubtotals" class="table table-bordered">
        <thead><tr><th>分店</th><th>小計</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 教師管理 -->
    <section id="teacherManagement" class="section no-print">
      <h2>教師管理</h2>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="teacherBranch">分店</label>
          <select id="teacherBranch" class="form-select">
            <option value="">未指定</option>
            <option value="虎尾">虎尾</option>
            <option value="斗六">斗六</option>
            <option value="立昇">立昇</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="teacherName">姓名</label>
          <input id="teacherName" type="text" class="form-control" placeholder="教師姓名">
          <div id="teacherNameError" class="error"></div>
        </div>
        <div class="col-md-3">
          <label for="teacherId">教師代號</label>
          <input id="teacherId" type="text" class="form-control" readonly>
          <div id="teacherIdError" class="error"></div>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary mt-4" onclick="addOrUpdateTeacher()">新增/更新教師</button>
          <button class="btn btn-danger mt-4" onclick="deleteTeacher()">刪除教師</button>
        </div>
      </div>
      <div class="mb-3">
        <button class="btn btn-primary" onclick="loadTeacher(currentTeacherId)">載入</button>
        <button class="btn btn-warning" onclick="clearEntries()">清除上課記錄</button>
      </div>
      <h4>計算明細（entries）</h4>
      <p id="noTeacherWarning" class="text-danger" style="display: none;">未選擇教師</p>
      <table id="entryList" class="table table-bordered">
        <thead><tr><th>#</th><th>類型</th><th>小時</th><th>時薪</th><th>固定金額</th><th>類別碼</th><th>小計</th><th class="no-print">操作</th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-primary" onclick="addEntry('hourly')">新增「時薪」</button>
      <button class="btn btn-primary" onclick="addEntry('fixed')">新增「固定金額」</button>
      <button class="btn btn-primary" onclick="addEntry('allowance')">新增「津貼」</button>
      <button class="btn btn-primary" onclick="addEntry('deduction')">新增「扣款」</button>
      <button class="btn btn-success" onclick="saveAndRecalculate()">儲存並重算</button>
    </section>

    <!-- 薪資單 -->
    <section id="payroll" class="section">
      <h2>薪資單</h2>
      <div class="mb-3">
        <button class="btn btn-primary no-print" onclick="renderPayroll('smallGrid')">小格複製</button>
        <button class="btn btn-primary no-print" onclick="renderPayroll('largeGrid')">大格複製</button>
        <button class="btn btn-danger no-print" onclick="clearPayroll()">清空統整</button>
      </div>
      <h4>薪資單統整（列印區）</h4>
      <div id="payrollOutput" class="mt-3"></div>
      <p class="text-muted">提示：此區內容將列印或匯出為 PDF。</p>
    </section>

    <!-- 版號 -->
    <section id="version" class="section no-print">
      <h2>版號</h2>
      <div class="row mb-3">
        <div class="col-md-3">
          <input id="versionInput" type="text" class="form-control" placeholder="版號 (e.g., 2025.05)">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary" onclick="logVersion()">新增版號紀錄</button>
        </div>
      </div>
      <table id="versionHistory" class="table table-bordered">
        <thead><tr><th>版號</th><th>操作人</th><th>裝置資訊</th><th>日期</th><th>時間</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 匯入/匯出 -->
    <section id="importExport" class="section no-print">
      <h2>匯入/匯出</h2>
      <div class="mb-3">
        <button class="btn btn-primary" onclick="exportJSON()">匯出 JSON</button>
        <input id="jsonFile" type="file" accept=".json" class="form-control d-inline-block w-auto">
        <button class="btn btn-primary" onclick="importJSON()">匯入 JSON</button>
        <button class="btn btn-danger" onclick="resetData()">重置資料庫</button>
      </div>
      <p class="text-muted">資料保存在你的瀏覽器 localStorage。匯出檔可備份/轉移。</p>
    </section>

    <!-- 說明 -->
    <section id="help" class="section no-print">
      <h2>說明</h2>
      <p>本工具為「Excel（含 VBA）→ 純前端」重構的最小可行實作。核心對應：</p>
      <ul>
        <li>N13 計算：以 calcN13(entries) 實作</li>
        <li>Workbook_Open：以「新增版號紀錄」取代</li>
        <li>小格/大格複製：渲染成 HTML 到「薪資單統整」</li>
        <li>清除上課記錄：清空該教師 entries</li>
        <li>新資料頁/新增目錄資料：建立教師節點並在總覽自動顯示</li>
      </ul>
    </section>

    <!-- Getting Started Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">歡迎使用薪資管理系統</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>1. 設定年份與月份（總覽）。</p>
            <p>2. 新增教師並輸入薪資明細（教師管理）。</p>
            <p>3. 計算總計並匯出薪資單（薪資單）。</p>
            <p>4. 記錄版號（版號）。</p>
            <p>5. 備份資料（匯入/匯出）。</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">開始使用</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let teachers = [];
    let versionHistory = [];
    let currentTeacherId = null;

    // Initialize app
    window.onload = () => {
      loadData();
      updateStoragePeriod();
      const modal = new bootstrap.Modal(document.getElementById('welcomeModal'));
      if (!localStorage.getItem('salaryData')) {
        modal.show();
      }
      logVersionOnLoad(); // R-003
    };

    // Data Management
    function saveData() {
      const data = {
        period: {
          year: parseInt(document.getElementById('year').value),
          month: parseInt(document.getElementById('month').value)
        },
        teachers: teachers.reduce((obj, t) => ({ ...obj, [t.id]: t }), {}),
        versions: versionHistory,
        consolidatedHTML: document.getElementById('payrollOutput').innerHTML
      };
      localStorage.setItem('salaryData', JSON.stringify(data));
    }

    function loadData() {
      try {
        const data = JSON.parse(localStorage.getItem('salaryData') || '{}');
        if (validateData(data)) {
          document.getElementById('year').value = data.period?.year || 2025;
          document.getElementById('month').value = data.period?.month || 5;
          teachers = Object.values(data.teachers || {});
          versionHistory = data.versions || [];
          document.getElementById('payrollOutput').innerHTML = data.consolidatedHTML || '';
          renderTeacherList();
          renderBranchSubtotals();
          renderVersionHistory();
          updateStoragePeriod();
        } else {
          alert('載入資料格式錯誤，已使用預設值');
        }
      } catch (e) {
        alert('載入資料失敗: ' + e.message);
      }
    }

    function validateData(data) {
      return data && typeof data === 'object' &&
             (data.period ? (data.period.year >= 2000 && data.period.year <= 2100 && data.period.month >= 1 && data.period.month <= 12) : true) &&
             (data.teachers ? Object.values(data.teachers).every(t => /^T\d{2}$/.test(t.id)) : true) &&
             Array.isArray(data.versions) &&
             (typeof data.consolidatedHTML === 'string' || !data.consolidatedHTML);
    }

    function updateStoragePeriod() {
      const year = document.getElementById('year').value;
      const month = document.getElementById('month').value.padStart(2, '0');
      document.getElementById('storagePeriod').textContent = `${year}-${month}`;
    }

    // Calculations (R-020 to R-024)
    function calcN13(entries) {
      return Math.round(entries.reduce((sum, entry) => sum + (entry.subtotal || 0), 0)); // R-023
    }

    function calculateOverallTotal() {
      return teachers.reduce((sum, teacher) => sum + (teacher.total || 0), 0);
    }

    function calculateBranchSubtotals() {
      const branches = { '': 0 }; // Default for unspecified store (R-011)
      teachers.forEach(teacher => {
        const branch = teacher.store || '';
        branches[branch] = (branches[branch] || 0) + (teacher.total || 0);
      });
      return Object.entries(branches).map(([name, subtotal]) => ({ name: name || '未指定', subtotal }));
    }

    // Rendering
    function renderTeacherList() {
      const tbody = document.querySelector('#teacherList tbody');
      tbody.innerHTML = teachers
        .sort((a, b) => a.id.localeCompare(b.id)) // R-030
        .map(teacher => `
          <tr>
            <td>${teacher.id}</td>
            <td>${teacher.name || ''}</td>
            <td>${teacher.store || '未指定'}</td>
            <td>$${teacher.total?.toLocaleString('zh-TW') || 0}</td>
            <td class="no-print"><button class="btn btn-sm btn-primary" onclick="loadTeacher('${teacher.id}')">載入</button></td>
          </tr>
        `).join('');
      tbody.innerHTML += `
        <tr>
          <td colspan="3">整體總計</td>
          <td>$${calculateOverallTotal().toLocaleString('zh-TW')}</td>
          <td class="no-print"></td>
        </tr>
      `;
    }

    function renderBranchSubtotals() {
      const tbody = document.querySelector('#branchSubtotals tbody');
      const branches = calculateBranchSubtotals();
      tbody.innerHTML = branches.map(branch => `
        <tr>
          <td>${branch.name}</td>
          <td>$${branch.subtotal.toLocaleString('zh-TW')}</td>
        </tr>
      `).join('');
      tbody.innerHTML += `
        <tr>
          <td>合計</td>
          <td>$${calculateOverallTotal().toLocaleString('zh-TW')}</td>
        </tr>
      `;
    }

    function renderVersionHistory() {
      const tbody = document.querySelector('#versionHistory tbody');
      tbody.innerHTML = versionHistory.map(v => `
        <tr>
          <td>${v.ver}</td>
          <td>${v.operator}</td>
          <td>${v.device}</td>
          <td>${v.date}</td>
          <td>${v.time}</td>
        </tr>
      `).join('');
    }

    function renderEntryList() {
      const teacher = teachers.find(t => t.id === currentTeacherId);
      document.getElementById('noTeacherWarning').style.display = teacher ? 'none' : 'block';
      const tbody = document.querySelector('#entryList tbody');
      tbody.innerHTML = teacher ? teacher.entries.map((entry, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${{ hourly: '時薪', fixed: '固定金額', allowance: '津貼', deduction: '扣款' }[entry.type]}</td>
          <td>${entry.hours ?? '-'}</td>
          <td>${entry.rate ?? '-'}</td>
          <td>${entry.amount ?? '-'}</td>
          <td>${entry.code || '-'}</td>
          <td>$${entry.subtotal.toLocaleString('zh-TW')}</td>
          <td class="no-print"><button class="btn btn-sm btn-danger" onclick="deleteEntry(${index})">刪除</button></td>
        </tr>
      `).join('') : '';
      tbody.innerHTML += teacher ? `
        <tr>
          <td colspan="6">合計（N13）</td>
          <td>$${teacher.total?.toLocaleString('zh-TW') || 0}</td>
          <td class="no-print"></td>
        </tr>
      ` : '';
    }

    // Teacher Management
    function addOrUpdateTeacher() {
      const id = document.getElementById('teacherId').value || `T${(teachers.length + 1).toString().padStart(2, '0')}`;
      const name = document.getElementById('teacherName').value.trim();
      const branch = document.getElementById('teacherBranch').value;

      // R-010: Validate ID
      if (!/^T\d{2}$/.test(id) || (teachers.some(t => t.id === id && id !== currentTeacherId))) {
        document.getElementById('teacherIdError').textContent = '教師代號格式錯誤或重複';
        return;
      }
      // Suggest name if empty
      if (!name) {
        document.getElementById('teacherNameError').textContent = '建議輸入教師姓名';
      }

      const existing = teachers.find(t => t.id === id);
      if (existing) {
        existing.name = name;
        existing.store = branch;
      } else {
        teachers.push({ id, name, store: branch, entries: [], total: 0 });
      }
      saveData();
      renderTeacherList();
      renderBranchSubtotals();
      clearTeacherForm();
      document.getElementById('teacherIdError').textContent = '';
      document.getElementById('teacherNameError').textContent = '';
    }

    function deleteTeacher() {
      if (!currentTeacherId) {
        alert('請先選擇一位教師');
        return;
      }
      if (confirm('確定刪除此教師？此操作無法復原。')) { // R-012, E-004
        teachers = teachers.filter(t => t.id !== currentTeacherId);
        saveData();
        renderTeacherList();
        renderBranchSubtotals();
        clearTeacherForm();
      }
    }

    function loadTeacher(id) {
      currentTeacherId = id;
      const teacher = teachers.find(t => t.id === id);
      if (teacher) {
        document.getElementById('teacherId').value = teacher.id;
        document.getElementById('teacherName').value = teacher.name || '';
        document.getElementById('teacherBranch').value = teacher.store || '';
        renderEntryList();
      }
    }

    function clearTeacherForm() {
      currentTeacherId = null;
      document.getElementById('teacherId').value = '';
      document.getElementById('teacherName').value = '';
      document.getElementById('teacherBranch').value = '';
      document.querySelector('#entryList tbody').innerHTML = '';
      document.getElementById('teacherIdError').textContent = '';
      document.getElementById('teacherNameError').textContent = '';
      document.getElementById('noTeacherWarning').style.display = 'block';
    }

    function clearEntries() {
      if (!currentTeacherId) {
        alert('請先選擇一位教師');
        return;
      }
      if (confirm('確定清除此教師的上課記錄？')) { // R-025
        const teacher = teachers.find(t => t.id === currentTeacherId);
        teacher.entries = [];
        teacher.total = 0;
        saveData();
        renderEntryList();
        renderTeacherList();
        renderBranchSubtotals();
      }
    }

    // Entry Management
    function addEntry(type) {
      if (!currentTeacherId) {
        alert('請先選擇或新增一位教師');
        return;
      }
      let hours = null, rate = null, amount = null, code = null;
      if (type === 'hourly') {
        hours = prompt('請輸入小時數（可含小數）', '0');
        rate = prompt('請輸入時薪', '0');
        if (isNaN(hours) || isNaN(rate) || hours < 0 || rate < 0) { // R-021
          alert('小時數與時薪必須為非負數');
          return;
        }
      } else {
        amount = prompt('請輸入金額（可正負）', '0');
        if (isNaN(amount)) { // R-022
          alert('金額必須為數字');
          return;
        }
        code = prompt('請輸入類別碼（可選）', '');
      }

      const teacher = teachers.find(t => t.id === currentTeacherId);
      const entry = {
        type,
        hours: hours ? parseFloat(hours) : null,
        rate: rate ? parseFloat(rate) : null,
        amount: amount ? parseFloat(amount) : null,
        code: code || null,
        subtotal: type === 'hourly' ? parseFloat(hours) * parseFloat(rate) : parseFloat(amount)
      };
      teacher.entries.push(entry);
      teacher.total = calcN13(teacher.entries); // R-024
      saveData();
      renderEntryList();
      renderTeacherList();
      renderBranchSubtotals();
    }

    function deleteEntry(index) {
      const teacher = teachers.find(t => t.id === currentTeacherId);
      teacher.entries.splice(index, 1);
      teacher.total = calcN13(teacher.entries); // R-024
      saveData();
      renderEntryList();
      renderTeacherList();
      renderBranchSubtotals();
    }

    function saveAndRecalculate() {
      recalculateAll();
      alert('已儲存並重新計算');
    }

    function recalculateAll() {
      teachers.forEach(teacher => {
        teacher.total = calcN13(teacher.entries); // R-024
      });
      saveData();
      renderTeacherList();
      renderBranchSubtotals();
    }

    // Payroll (R-040 to R-043)
    function renderPayroll(templateType) {
      const output = document.getElementById('payrollOutput');
      const year = document.getElementById('year').value;
      const month = document.getElementById('month').value;
      output.innerHTML = teachers.map(teacher => `
        <div class="grid-template ${templateType}">
          <p>教師: ${teacher.name || '未命名'}</p>
          <p>代號: ${teacher.id}</p>
          ${templateType === 'largeGrid' ? `
            <p>年份: ${year}</p>
            <p>月份: ${month}</p>
            <p>明細: ${teacher.entries.map(e => `${{ hourly: '時薪', fixed: '固定金額', allowance: '津貼', deduction: '扣款' }[e.type]}${e.code ? `(${e.code})` : ''}: $${e.subtotal.toLocaleString('zh-TW')}`).join(', ')}</p>
          ` : ''}
          <p>總計: $${teacher.total?.toLocaleString('zh-TW') || 0}</p>
        </div>
      `).join('');
      saveData(); // Save consolidated HTML
    }

    function clearPayroll() {
      if (confirm('確定清空薪資單統整？')) { // R-043
        document.getElementById('payrollOutput').innerHTML = '';
        saveData();
      }
    }

    function exportToPDF() {
      const element = document.getElementById('payrollOutput');
      if (!element.innerHTML) {
        alert('請先產生薪資單內容'); // E-005
        return;
      }
      html2pdf().from(element).set({
        filename: `salary_${document.getElementById('year').value}_${document.getElementById('month').value}.pdf`,
        margin: 10,
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        html2canvas: { scale: 2 }
      }).save();
    }

    // Versioning (R-002, R-003)
    function logVersionOnLoad() {
      if (!versionHistory.some(v => v.date === new Date().toLocaleDateString('zh-TW'))) {
        logVersion();
      }
    }

    function logVersion() {
      const version = document.getElementById('versionInput').value || `${document.getElementById('year').value}.${document.getElementById('month').value.padStart(2, '0')}`;
      const operator = prompt('請輸入操作者名稱') || 'Unknown';
      const newVersion = {
        ver: version,
        operator,
        device: navigator.userAgent,
        date: new Date().toLocaleDateString('zh-TW'),
        time: new Date().toLocaleTimeString('zh-TW')
      };
      versionHistory.unshift(newVersion);
      saveData();
      renderVersionHistory();
      document.getElementById('versionInput').value = '';
    }

    // Import/Export (R-050 to R-053)
    function exportJSON() {
      const data = JSON.stringify(loadData(), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `salary_${document.getElementById('year').value}_${document.getElementById('month').value}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJSON() {
      try {
        const file = document.getElementById('jsonFile').files[0];
        if (!file) {
          alert('請選擇一個 JSON 檔案');
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          const data = JSON.parse(reader.result);
          if (validateData(data)) {
            localStorage.setItem('salaryData', reader.result);
            loadData();
            alert('匯入成功');
          } else {
            alert('無效的 JSON 格式'); // E-003
          }
        };
        reader.readAsText(file);
      } catch (e) {
        alert('匯入失敗: ' + e.message); // E-003
      }
    }

    function resetData() {
      if (confirm('確定重置所有資料？此操作無法復原。')) { // R-053
        localStorage.removeItem('salaryData');
        teachers = [];
        versionHistory = [];
        currentTeacherId = null;
        document.getElementById('year').value = 2025;
        document.getElementById('month').value = 5;
        renderTeacherList();
        renderBranchSubtotals();
        renderVersionHistory();
        clearTeacherForm();
        clearPayroll();
        alert('資料已重置');
      }
    }

    // Event Listeners
    document.getElementById('year').addEventListener('change', () => {
      const year = parseInt(document.getElementById('year').value);
      if (year < 2000 || year > 2100) {
        document.getElementById('yearError').textContent = '年份必須在 2000-2100 之間'; // R-001
      } else {
        document.getElementById('yearError').textContent = '';
        updateStoragePeriod();
        saveData();
      }
    });

    document.getElementById('month').addEventListener('change', () => {
      const month = parseInt(document.getElementById('month').value);
      if (month < 1 || month > 12) {
        document.getElementById('monthError').textContent = '月份必須在 1-12 之間'; // R-001
      } else {
        document.getElementById('monthError').textContent = '';
        updateStoragePeriod();
        saveData();
      }
    });
  </script>
</body>
</html>