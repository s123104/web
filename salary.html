<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>薪資管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    body { padding: 20px; }
    .section { margin-bottom: 30px; }
    .grid-template { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
    .smallGrid { font-size: 14px; }
    .largeGrid { font-size: 16px; }
    #payrollOutput { background: #f8f9fa; padding: 20px; }
    .table th, .table td { vertical-align: middle; }
    .modal-body p { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 總覽 -->
    <section id="overview" class="section">
      <h2>總覽</h2>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="year">年份</label>
          <input id="year" type="number" class="form-control" value="2025">
        </div>
        <div class="col-md-3">
          <label for="month">月份</label>
          <input id="month" type="number" class="form-control" value="5">
        </div>
      </div>
      <table id="teacherList" class="table table-bordered">
        <thead><tr><th>教師代號</th><th>姓名</th><th>分店</th><th>總計 N13</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
      <table id="branchSubtotals" class="table table-bordered">
        <thead><tr><th>分店</th><th>小計</th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-primary" onclick="recalculateAll()">重新計算所有教師總計</button>
      <button class="btn btn-danger" onclick="clearPayroll()">清空薪資單統整</button>
      <button class="btn btn-success" onclick="exportToPDF()">列印/另存 PDF</button>
    </section>

    <!-- 教師管理 -->
    <section id="teacherManagement" class="section">
      <h2>教師管理</h2>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="teacherId">教師代號</label>
          <input id="teacherId" type="text" class="form-control" readonly>
        </div>
        <div class="col-md-3">
          <label for="teacherName">姓名</label>
          <input id="teacherName" type="text" class="form-control" placeholder="教師姓名">
        </div>
        <div class="col-md-3">
          <label for="teacherBranch">分店</label>
          <select id="teacherBranch" class="form-select">
            <option value="未指定">未指定</option>
            <option value="虎尾">虎尾</option>
            <option value="斗六">斗六</option>
            <option value="立昇">立昇</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary mt-4" onclick="addOrUpdateTeacher()">新增/更新教師</button>
          <button class="btn btn-danger mt-4" onclick="deleteTeacher()">刪除教師</button>
        </div>
      </div>
      <table id="entryList" class="table table-bordered">
        <thead><tr><th>#</th><th>類型</th><th>小時</th><th>時薪</th><th>固定金額</th><th>小計</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-primary" onclick="addEntry('hourly')">新增「時薪」</button>
      <button class="btn btn-primary" onclick="addEntry('fixed')">新增「固定金額」</button>
      <button class="btn btn-success" onclick="saveAndRecalculate()">儲存並重算</button>
    </section>

    <!-- 薪資單 -->
    <section id="payroll" class="section">
      <h2>薪資單</h2>
      <button class="btn btn-primary" onclick="renderPayroll('smallGrid')">小格複製</button>
      <button class="btn btn-primary" onclick="renderPayroll('largeGrid')">大格複製</button>
      <button class="btn btn-danger" onclick="clearPayroll()">清空統整</button>
      <div id="payrollOutput" class="mt-3"></div>
      <p class="text-muted">提示：此區內容將列印或匯出為 PDF。</p>
    </section>

    <!-- 版號 -->
    <section id="version" class="section">
      <h2>版號</h2>
      <div class="row mb-3">
        <div class="col-md-3">
          <input id="versionInput" type="text" class="form-control" placeholder="版號 (e.g., 1.0)">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary" onclick="logVersion()">新增版號紀錄</button>
        </div>
      </div>
      <table id="versionHistory" class="table table-bordered">
        <thead><tr><th>版號</th><th>操作人</th><th>裝置資訊</th><th>日期</th><th>時間</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 匯入/匯出 -->
    <section id="importExport" class="section">
      <h2>匯入/匯出</h2>
      <button class="btn btn-primary" onclick="exportJSON()">匯出 JSON</button>
      <input id="jsonFile" type="file" accept=".json" class="form-control d-inline-block w-auto">
      <button class="btn btn-primary" onclick="importJSON()">匯入 JSON</button>
      <button class="btn btn-danger" onclick="resetData()">重置資料庫</button>
      <p class="text-muted">資料保存在你的瀏覽器 localStorage。匯出檔可備份/轉移。</p>
    </section>

    <!-- 說明 -->
    <section id="help" class="section">
      <h2>說明</h2>
      <p>本工具為 Excel 薪資管理系統的重構版本，支援離線使用，資料儲存於 localStorage。核心功能對應 Excel：</p>
      <ul>
        <li>N13 計算：以 calcN13(entries) 實作</li>
        <li>Workbook_Open：以「新增版號紀錄」取代</li>
        <li>小格/大格複製：渲染成 HTML 到「薪資單統整」</li>
        <li>清除上課記錄：清空該教師 entries</li>
        <li>新資料頁/新增目錄資料：建立教師節點並在總覽自動顯示</li>
      </ul>
    </section>

    <!-- Getting Started Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">歡迎使用薪資管理系統</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>1. 設定年份與月份（總覽）。</p>
            <p>2. 新增教師並輸入薪資明細（教師管理）。</p>
            <p>3. 計算總計並匯出薪資單（薪資單）。</p>
            <p>4. 記錄版號（版號）。</p>
            <p>5. 備份資料（匯入/匯出）。</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">開始使用</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let teachers = [];
    let versionHistory = [];
    let currentTeacherId = null;

    // Initialize app
    window.onload = () => {
      loadData();
      const modal = new bootstrap.Modal(document.getElementById('welcomeModal'));
      if (!localStorage.getItem('salaryData')) {
        modal.show();
      }
    };

    // Data Management
    function saveData() {
      const data = {
        year: document.getElementById('year').value,
        month: document.getElementById('month').value,
        storagePeriod: `${document.getElementById('year').value}-${document.getElementById('month').value.padStart(2, '0')}`,
        teachers,
        branches: calculateBranchSubtotals(),
        versionHistory,
        overallTotal: calculateOverallTotal()
      };
      localStorage.setItem('salaryData', JSON.stringify(data));
    }

    function loadData() {
      try {
        const data = JSON.parse(localStorage.getItem('salaryData') || '{}');
        if (data.teachers) {
          teachers = data.teachers;
          document.getElementById('year').value = data.year || 2025;
          document.getElementById('month').value = data.month || 5;
          renderTeacherList();
          renderBranchSubtotals();
        }
        if (data.versionHistory) {
          versionHistory = data.versionHistory;
          renderVersionHistory();
        }
      } catch (e) {
        alert('載入資料失敗: ' + e.message);
      }
    }

    // Calculations
    function calcN13(entries) {
      return entries.reduce((sum, entry) => sum + (entry.subtotal || 0), 0);
    }

    function calculateOverallTotal() {
      return teachers.reduce((sum, teacher) => sum + (teacher.totalN13 || 0), 0);
    }

    function calculateBranchSubtotals() {
      const branches = {};
      teachers.forEach(teacher => {
        const branch = teacher.branch || '未指定';
        branches[branch] = (branches[branch] || 0) + (teacher.totalN13 || 0);
      });
      return Object.entries(branches).map(([name, subtotal]) => ({ name, subtotal }));
    }

    // Rendering
    function renderTeacherList() {
      const tbody = document.querySelector('#teacherList tbody');
      tbody.innerHTML = teachers.map(teacher => `
        <tr>
          <td>${teacher.id}</td>
          <td>${teacher.name}</td>
          <td>${teacher.branch}</td>
          <td>$${teacher.totalN13 || 0}</td>
          <td><button class="btn btn-sm btn-primary" onclick="loadTeacher('${teacher.id}')">載入</button></td>
        </tr>
      `).join('');
      tbody.innerHTML += `
        <tr>
          <td colspan="3">整體總計</td>
          <td>$${calculateOverallTotal()}</td>
          <td></td>
        </tr>
      `;
    }

    function renderBranchSubtotals() {
      const tbody = document.querySelector('#branchSubtotals tbody');
      const branches = calculateBranchSubtotals();
      tbody.innerHTML = branches.map(branch => `
        <tr>
          <td>${branch.name}</td>
          <td>$${branch.subtotal}</td>
        </tr>
      `).join('');
      tbody.innerHTML += `
        <tr>
          <td>合計</td>
          <td>$${calculateOverallTotal()}</td>
        </tr>
      `;
    }

    function renderVersionHistory() {
      const tbody = document.querySelector('#versionHistory tbody');
      tbody.innerHTML = versionHistory.map(v => `
        <tr>
          <td>${v.version}</td>
          <td>${v.operator}</td>
          <td>${v.deviceInfo}</td>
          <td>${v.date}</td>
          <td>${v.time}</td>
        </tr>
      `).join('');
    }

    function renderEntryList() {
      const teacher = teachers.find(t => t.id === currentTeacherId);
      const tbody = document.querySelector('#entryList tbody');
      tbody.innerHTML = teacher ? teacher.entries.map((entry, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${entry.type === 'hourly' ? '時薪' : '固定金額'}</td>
          <td>${entry.hours || '-'}</td>
          <td>${entry.rate || '-'}</td>
          <td>${entry.amount || '-'}</td>
          <td>$${entry.subtotal}</td>
          <td><button class="btn btn-sm btn-danger" onclick="deleteEntry(${index})">刪除</button></td>
        </tr>
      `).join('') : '';
      tbody.innerHTML += teacher ? `
        <tr>
          <td colspan="5">合計（N13）</td>
          <td>$${teacher.totalN13 || 0}</td>
          <td></td>
        </tr>
      ` : '';
    }

    // Teacher Management
    function addOrUpdateTeacher() {
      const id = document.getElementById('teacherId').value || `T${(teachers.length + 1).toString().padStart(2, '0')}`;
      const name = document.getElementById('teacherName').value.trim();
      const branch = document.getElementById('teacherBranch').value;
      if (!name) {
        alert('請輸入教師姓名');
        return;
      }
      const existing = teachers.find(t => t.id === id);
      if (existing) {
        existing.name = name;
        existing.branch = branch;
      } else {
        teachers.push({ id, name, branch, entries: [], totalN13: 0 });
      }
      saveData();
      renderTeacherList();
      renderBranchSubtotals();
      clearTeacherForm();
    }

    function deleteTeacher() {
      if (!currentTeacherId) {
        alert('請先選擇一位教師');
        return;
      }
      if (confirm('確定刪除此教師？')) {
        teachers = teachers.filter(t => t.id !== currentTeacherId);
        saveData();
        renderTeacherList();
        renderBranchSubtotals();
        clearTeacherForm();
      }
    }

    function loadTeacher(id) {
      currentTeacherId = id;
      const teacher = teachers.find(t => t.id === id);
      if (teacher) {
        document.getElementById('teacherId').value = teacher.id;
        document.getElementById('teacherName').value = teacher.name;
        document.getElementById('teacherBranch').value = teacher.branch;
        renderEntryList();
      }
    }

    function clearTeacherForm() {
      currentTeacherId = null;
      document.getElementById('teacherId').value = '';
      document.getElementById('teacherName').value = '';
      document.getElementById('teacherBranch').value = '未指定';
      document.querySelector('#entryList tbody').innerHTML = '';
    }

    // Entry Management
    function addEntry(type) {
      if (!currentTeacherId) {
        alert('請先選擇或新增一位教師');
        return;
      }
      const hours = type === 'hourly' ? prompt('請輸入小時數', '0') : null;
      const rate = type === 'hourly' ? prompt('請輸入時薪', '0') : null;
      const amount = type === 'fixed' ? prompt('請輸入固定金額', '0') : null;
      const teacher = teachers.find(t => t.id === currentTeacherId);
      const entry = {
        type,
        hours: hours ? parseFloat(hours) : null,
        rate: rate ? parseFloat(rate) : null,
        amount: amount ? parseFloat(amount) : null,
        subtotal: type === 'hourly' ? parseFloat(hours) * parseFloat(rate) : parseFloat(amount)
      };
      if (isNaN(entry.subtotal)) {
        alert('請輸入有效數字');
        return;
      }
      teacher.entries.push(entry);
      teacher.totalN13 = calcN13(teacher.entries);
      saveData();
      renderEntryList();
      renderTeacherList();
      renderBranchSubtotals();
    }

    function deleteEntry(index) {
      const teacher = teachers.find(t => t.id === currentTeacherId);
      teacher.entries.splice(index, 1);
      teacher.totalN13 = calcN13(teacher.entries);
      saveData();
      renderEntryList();
      renderTeacherList();
      renderBranchSubtotals();
    }

    function saveAndRecalculate() {
      recalculateAll();
      alert('已儲存並重新計算');
    }

    function recalculateAll() {
      teachers.forEach(teacher => {
        teacher.totalN13 = calcN13(teacher.entries);
      });
      saveData();
      renderTeacherList();
      renderBranchSubtotals();
    }

    // Payroll
    function renderPayroll(templateType) {
      const output = document.getElementById('payrollOutput');
      const year = document.getElementById('year').value;
      const month = document.getElementById('month').value;
      output.innerHTML = teachers.map(teacher => `
        <div class="grid-template ${templateType}">
          <p>教師: ${teacher.name}</p>
          <p>代號: ${teacher.id}</p>
          ${templateType === 'largeGrid' ? `
            <p>年份: ${year}</p>
            <p>月份: ${month}</p>
            <p>明細: ${teacher.entries.map(e => `${e.type === 'hourly' ? '時薪' : '固定金額'}: $${e.subtotal}`).join(', ')}</p>
          ` : ''}
          <p>總計: $${teacher.totalN13 || 0}</p>
        </div>
      `).join('');
    }

    function clearPayroll() {
      if (confirm('確定清空薪資單統整？')) {
        document.getElementById('payrollOutput').innerHTML = '';
      }
    }

    function exportToPDF() {
      const element = document.getElementById('payrollOutput');
      if (!element.innerHTML) {
        alert('請先產生薪資單內容');
        return;
      }
      html2pdf().from(element).set({
        filename: `salary_${document.getElementById('year').value}_${document.getElementById('month').value}.pdf`,
        margin: 10,
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).save();
    }

    // Versioning
    function logVersion() {
      const version = document.getElementById('versionInput').value || '1.0';
      const operator = prompt('請輸入操作者名稱') || 'Unknown';
      const newVersion = {
        version,
        operator,
        deviceInfo: navigator.userAgent,
        date: new Date().toISOString().split('T')[0],
        time: new Date().toTimeString().split(' ')[0]
      };
      versionHistory.unshift(newVersion);
      saveData();
      renderVersionHistory();
      document.getElementById('versionInput').value = '';
    }

    // Import/Export
    function exportJSON() {
      const data = JSON.stringify(loadData(), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `salary_${document.getElementById('year').value}_${document.getElementById('month').value}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJSON() {
      try {
        const file = document.getElementById('jsonFile').files[0];
        if (!file) {
          alert('請選擇一個 JSON 檔案');
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          const data = JSON.parse(reader.result);
          if (validateData(data)) {
            localStorage.setItem('salaryData', reader.result);
            loadData();
            alert('匯入成功');
          } else {
            alert('無效的 JSON 格式');
          }
        };
        reader.readAsText(file);
      } catch (e) {
        alert('匯入失敗: ' + e.message);
      }
    }

    function validateData(data) {
      return data.year && data.month && Array.isArray(data.teachers) && Array.isArray(data.versionHistory);
    }

    function resetData() {
      if (confirm('確定重置所有資料？此操作無法復原。')) {
        localStorage.removeItem('salaryData');
        teachers = [];
        versionHistory = [];
        currentTeacherId = null;
        document.getElementById('year').value = 2025;
        document.getElementById('month').value = 5;
        renderTeacherList();
        renderBranchSubtotals();
        renderVersionHistory();
        clearTeacherForm();
        clearPayroll();
        alert('資料已重置');
      }
    }
  </script>
</body>
</html>