<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <!-- iOS å®‰å…¨å€ï¼‹é¿å…å·¥å…·åˆ—ä½”é«˜ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#f6a8d8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Elite Tap Battle - å°ˆæ¥­é»æ“Šå°æˆ°</title>

  <style>
    /* === å°ˆæ¥­ç´šè‰²å½©ç³»çµ±ï¼ˆç²‰è‰²ï¼‹å¤©è—ç³»ï¼‰ === */
    :root {
      --pink-50:  #fff1f8;
      --pink-100: #ffe6f3;
      --pink-200: #ffcfe9;
      --pink-300: #ffb2dc;
      --pink-400: #ff94d0;
      --pink-500: #f66fb9;
      --pink-600: #e054a3;
      --pink-700: #c24389;

      --sky-50:  #ecf6ff;
      --sky-100: #d9efff;
      --sky-200: #bfe6ff;
      --sky-300: #9ed9ff;
      --sky-400: #7ccaff;
      --sky-500: #52b7ff;
      --sky-600: #349ff0;

      --purple-400: #bf9cff;

      --gray-50: #f9fafb;
      --gray-100:#f3f4f6;
      --gray-200:#e5e7eb;
      --gray-300:#d1d5db;
      --gray-400:#9ca3af;
      --gray-700:#374151;
      --gray-900:#111827;

      --primary: var(--pink-500);
      --primary-dark: var(--pink-600);
      --accent: var(--sky-500);

      --bg-primary:#ffffff;
      --bg-secondary:var(--gray-50);
      --bg-tertiary:var(--gray-100);
      --text-primary:var(--gray-900);
      --text-secondary:var(--gray-400);

      --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
      --shadow-md: 0 6px 18px rgba(0,0,0,.08);
      --shadow-xl: 0 20px 45px rgba(246,111,185,.28);

      --space-2: .5rem;
      --space-3: .75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-16: 4rem;

      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      --radius-full: 9999px;

      --duration-fast: 150ms;
      --duration-normal: 300ms;

      --font-size-sm: .875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-2xl: 1.5rem;
      --font-size-4xl: 2.25rem;
      --font-size-6xl: 3.75rem;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary:#0f1220;
        --bg-secondary:#0b1020;
        --bg-tertiary:#0b1226;
        --text-primary:#f3f4f6;
        --text-secondary:#9ca3af;
      }
    }

    /* åŸºç¤é‡ç½® */
    * { box-sizing:border-box; margin:0; padding:0; touch-action:manipulation; }
    html, body {
      height:100svh; width:100vw; overflow:hidden;
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
      background:var(--bg-primary); color:var(--text-primary);
      overscroll-behavior:none; -webkit-text-size-adjust:100%;
    }

    /* ä¸»å®¹å™¨ï¼šç²‰è‰²å¯æ„›ï¼‹å¤©è—æ¼¸å±¤é›²éœ§ */
    .app {
      position:fixed; inset:0; width:100vw; height:100svh; overflow:hidden;
      background:
        radial-gradient(1100px 800px at 20% 10%, rgba(255,210,236,.55), transparent 60%),
        radial-gradient(1100px 800px at 85% 85%, rgba(124,202,255,.45), transparent 60%),
        linear-gradient(135deg, var(--pink-100) 0%, var(--pink-50) 40%, var(--sky-100) 100%);
    }
    .app.rgb-burst { animation: hueCycle .8s linear infinite; }
    @keyframes hueCycle { from{ filter:hue-rotate(0deg);} to{ filter:hue-rotate(360deg);} }

    /* ä¸»é¸å–® */
    .menu-screen {
      height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;
      gap:var(--space-10); padding:var(--space-8);
    }
    .menu-screen.hidden { opacity:0; visibility:hidden; transition:all var(--duration-normal) ease; }
    .brand { text-align:center; }
    .brand-icon {
      width:120px; height:120px; margin:0 auto var(--space-6);
      background: conic-gradient(from 0deg, #ffd9ef, #dff2ff, #ffd9ef);
      border-radius:28px; display:grid; place-items:center;
      box-shadow: var(--shadow-xl);
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-10px);} }
    .brand-title {
      font-size:2.4rem; font-weight:900; letter-spacing:-.02em;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 60%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .brand-subtitle { color:var(--text-secondary); margin-top:.4rem; }

    .menu-buttons { display:grid; gap:var(--space-4); width:min(90vw, 360px); }
    .menu-btn {
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:16px 20px; border:0; border-radius:16px; font-weight:800; cursor:pointer;
      box-shadow:var(--shadow-md); transition:transform var(--duration-fast) ease, box-shadow var(--duration-fast) ease;
      min-height:64px;
    }
    .menu-btn:active{ transform:scale(.98); }
    .menu-btn-primary{ color:#fff; background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
    .menu-btn-primary:hover{ transform:translateY(-2px); box-shadow:0 16px 36px rgba(246,111,185,.35); }
    .menu-btn-secondary{ background:var(--bg-primary); color:var(--text-primary); border:2px solid var(--gray-200); }

    /* éŠæˆ²ç•«é¢ */
    .game-screen { position:absolute; inset:0; display:none; flex-direction:column; }
    .game-screen.active { display:flex; }

    /* å–®äººæ¨¡å¼é ‚æ¬„ */
    .game-header {
      position:absolute; left:0; right:0; top:0; z-index:100;
      height:80px; padding-top:env(safe-area-inset-top);
      background:rgba(255,255,255,.92); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(246,111,185,.28);
      display:flex; align-items:center; justify-content:space-between;
      padding-left:var(--space-6); padding-right:var(--space-6);
    }
    .game-header.hidden{ display:none; }
    .game-timer{ display:flex; align-items:center; gap:8px; font-weight:900; color:var(--primary); font-size:var(--font-size-2xl); }
    .game-mode{ font-size:var(--font-size-sm); color:var(--text-secondary); background:var(--bg-tertiary); padding:6px 10px; border-radius:999px; }
    .game-exit{ background:none; border:none; color:var(--text-secondary); padding:6px; border-radius:10px; cursor:pointer; }
    .game-exit:hover{ background:var(--bg-tertiary); color:var(--text-primary); }

    .game-area{ position:relative; flex:1; margin-top:calc(80px + env(safe-area-inset-top)); touch-action:none; overflow:hidden; }

    /* æ•ˆæœç•«å¸ƒï¼ˆé›·é›»ï¼‹åœ“å½¢è§¸æ§æ³¢ç´‹ï¼‰ */
    .fx-canvas{ position:absolute; inset:0; width:100%; height:100%; z-index:5; pointer-events:none; }

    /* å–®äºº */
    .single-player-area{
      position:absolute; inset:0; z-index:1;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background: linear-gradient(135deg, var(--pink-100) 0%, var(--pink-200) 56%, var(--sky-100) 100%);
    }

    /* é›™äººï¼ˆä¸Šä¸‹å„åŠï¼Œå›ºå®šï¼‰ */
    .dual-player-area{
      position:absolute; inset:0; z-index:1;
      display:grid; grid-template-rows:1fr 1fr; grid-template-columns:1fr;
    }
    .player-zone{
      position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow:hidden;
      transition:transform var(--duration-fast) ease;
      background: linear-gradient(135deg, var(--pink-100) 0%, var(--pink-200) 100%);
    }
    .player-zone.player2{ background: linear-gradient(135deg, var(--sky-100) 0%, var(--sky-200) 100%); }
    /* ä¸Šæ–¹ç©å®¶é¡åƒï¼ˆé¢å°é¢ï¼‰ */
    .dual-player-area .player-zone.player1{ transform: rotate(180deg); }
    .dual-player-area .player-zone.player1.active{ transform: rotate(180deg) scale(1.02); }
    .dual-player-area .player-zone.player2.active{ transform: scale(1.02); }

    /* åˆ†éš”ç·šï¼ˆæ°´å¹³ï¼‰ */
    .divider{ position:absolute; left:0; right:0; top:50%; height:4px; transform:translateY(-50%);
      background: linear-gradient(90deg, var(--primary), var(--accent)); z-index:2; }

    /* é›™äºº HUDï¼ˆå„è‡ªé¡¯ç¤ºæ™‚é–“èˆ‡æ¨¡å¼ï¼‰ */
    .player-hud{
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      display:flex; gap:8px; align-items:center; z-index:10;
      padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.86); backdrop-filter:blur(8px);
      border:1px solid rgba(246,111,185,.25); box-shadow:0 6px 14px rgba(0,0,0,.06);
      font-weight:800;
    }
    .player-hud .hud-timer{ color:var(--primary); }
    .player-hud .hud-mode{ color:var(--text-secondary); font-size:var(--font-size-sm); padding:2px 8px; background:var(--bg-tertiary); border-radius:999px; }

    .player-name{ color:var(--text-secondary); font-weight:600; margin-bottom:var(--space-6); }
    .score-display{
      font-size:var(--font-size-6xl); font-weight:900; color:var(--primary);
      text-shadow:0 6px 16px rgba(246,111,185,.35); z-index:3;
    }

    /* æµ®å‹•åˆ†æ•¸ï¼ˆå¤–å±¤å…è¨±é¡åƒï¼Œå…§å±¤è·‘å‹•ç•«ï¼‰ */
    .tap-number{ position:absolute; z-index:25; pointer-events:none; filter:drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
    .tap-number .inner{
      font-size:var(--font-size-2xl); font-weight:900; color:#fff;
      text-shadow:0 0 10px currentColor, 0 2px 4px rgba(0,0,0,.5);
      animation:number-float 1s ease-out forwards; display:inline-block;
    }
    .tap-number.mirror{ transform: rotate(180deg); }
    @keyframes number-float{
      0%{ transform:scale(.85) translateY(0); opacity:.9; }
      20%{ transform:scale(1.12) translateY(-8px); opacity:1; }
      100%{ transform:scale(.95) translateY(-46px); opacity:0; }
    }

    /* è¼•é‡ç²’å­ */
    .particle{
      position:absolute; width:6px; height:6px; border-radius:50%;
      pointer-events:none; z-index:15; opacity:.9; box-shadow:0 0 6px currentColor;
      animation:particleFloat 900ms ease-out forwards; will-change:transform, opacity;
    }
    @keyframes particleFloat{
      0%{ transform:translateY(0) scale(1); opacity:1; }
      100%{ transform:translateY(-60px) scale(.4); opacity:0; }
    }

    /* ç…™ç« */
    .firework-container{ position:fixed; inset:0; pointer-events:none; z-index:200; }
    .firework{ position:absolute; width:4px; height:4px; border-radius:50%; }

    /* çµæœèˆ‡å…±ç”¨å½ˆçª— */
    .modal{
      position:fixed; inset:0; padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.8); z-index:1000; opacity:0; visibility:hidden; transition:all var(--duration-normal) ease;
    }
    .modal.show{ opacity:1; visibility:visible; }
    .modal-card{
      background:var(--bg-primary); border-radius:var(--radius-2xl); padding:var(--space-8); text-align:center;
      box-shadow: var(--shadow-xl); transform:scale(.92); transition:transform var(--duration-normal) ease; max-width:90vw;
    }
    .modal.show .modal-card{ transform:scale(1); }
    .title-gradient{ font-size:1.8rem; font-weight:900; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 60%); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
    .result-score{ margin-top:10px; font-size:var(--font-size-4xl); font-weight:800; color:var(--primary); }

    .btn{ border:0; border-radius:14px; padding:12px 18px; font-weight:800; cursor:pointer; }
    .btn-primary{ color:#fff; background:linear-gradient(135deg, var(--primary) 0%, var(--pink-700) 100%); box-shadow:0 10px 24px rgba(246,111,185,.35); }
    .btn-secondary{ background:var(--bg-secondary); border:1px solid var(--gray-300); }

    /* å€’æ•¸ */
    @keyframes pulse{ from{ transform:scale(1);} to{ transform:scale(1.08);} }

    @media (max-width:640px){
      .game-header{ height:70px; }
      .game-area{ margin-top:calc(70px + env(safe-area-inset-top)); }
      .score-display{ font-size:2.6rem; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- ä¸»é¸å–® -->
    <div class="menu-screen" id="menuScreen">
      <div class="brand">
        <div class="brand-icon">
          <svg viewBox="0 0 24 24" width="54" height="54" aria-hidden="true"><path fill="#f66fb9" d="M12 2l2.39 6.26L21 9.27l-5.18 4.87L17.18 21 12 18.26 6.82 21l1.36-6.86L3 9.27l6.61-1.01L12 2z"/></svg>
        </div>
        <div class="brand-title">Elite Tap Battle</div>
        <div class="brand-subtitle">ç²‰è‰² Ã— å¤©è—ï½œå°ˆæ¥­ç´šé»æ“Šå°æˆ°</div>
      </div>

      <div class="menu-buttons">
        <button class="menu-btn menu-btn-primary" id="startSingleBtn" aria-label="å–®äººæŒ‘æˆ°æ¨¡å¼">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          å–®äººæŒ‘æˆ°æ¨¡å¼
        </button>
        <button class="menu-btn menu-btn-primary" id="startDualBtn" aria-label="é›™äººå°æˆ°æ¨¡å¼">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M16 4a4 4 0 110 8 4 4 0 010-8zM8 4a4 4 0 110 8 4 4 0 010-8zM8 14c-2.67 0-8 1.34-8 4v2h12v-2c0-2.66-1.33-4-4-4zm8 0c-2.67 0-4 1.34-4 4v2h12v-2c0-2.66-5.33-4-8-4z"/></svg>
          é›™äººå°æˆ°æ¨¡å¼
        </button>
        <button class="menu-btn menu-btn-secondary" id="leaderboardBtn" aria-label="æ’è¡Œæ¦œ">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M7 14H4v6h3v-6zm6-4h-3v10h3V10zm9-6h-5v16h5V4z"/></svg>
          æ’è¡Œæ¦œ
        </button>
        <button class="menu-btn menu-btn-secondary" id="settingsBtn" aria-label="éŠæˆ²è¨­å®š">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7m7.43-2.53c.04-.32.07-.64.07-.97s-.03-.66-.07-.98l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46a.5.5 0 0 0-.61-.22l-2.49 1a7.03 7.03 0 0 0-1.69-.98l-.37-2.65A.5.5 0 0 0 13 2h-2a.5.5 0 0 0-.5.42l-.37 2.65c-.61.24-1.18.56-1.69.98l-2.49-1a.5.5 0 0 0-.61.22l-2 3.46a.5.5 0 0 0 .12.64L4.57 11c-.04.32-.07.65-.07.98s.03.65.07.97l-2.11 1.63a.5.5 0 0 0-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.51.42 1.08.74 1.69.98l.37 2.65c.04.24.25.42.5.42h2c.25 0 .46-.18.5-.42l.37-2.65c.61-.24 1.18-.56 1.69-.98l2.49 1c.22.08.49 0 .61-.22l2-3.46a.5.5 0 0 0-.12-.64z"/></svg>
          éŠæˆ²è¨­å®š
        </button>
      </div>
    </div>

    <!-- éŠæˆ²ç•«é¢ -->
    <div class="game-screen" id="gameScreen" aria-hidden="true">
      <!-- å–®äººæ¨¡å¼é ‚æ¬„ -->
      <div class="game-header" id="gameHeader">
        <div class="game-timer" aria-live="polite">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16m0-18a10 10 0 1 1 0 20 10 10 0 0 1 0-20m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5z"/></svg>
          <span id="gameTimer">30</span>
        </div>
        <div class="game-mode" id="gameMode">å–®äººæ¨¡å¼</div>
        <button class="game-exit" id="gameExit" aria-label="é›¢é–‹éŠæˆ²">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </div>

      <div class="game-area" id="gameArea">
        <canvas id="fxCanvas" class="fx-canvas"></canvas>

        <!-- å–®äºº -->
        <div class="single-player-area" id="singlePlayerArea" style="display:none">
          <div class="player-name">é–‹å§‹é»æ“ŠæŒ‘æˆ°ï¼</div>
          <div class="score-display" id="singleScore">0</div>
        </div>

        <!-- é›™äººï¼ˆä¸Šä¸‹ï¼‰ -->
        <div class="dual-player-area" id="dualPlayerArea" style="display:none">
          <div class="divider"></div>

          <div class="player-zone player1" data-player="1">
            <div class="player-hud">
              <div class="hud-timer" id="hudTimerP1">30</div>
              <div class="hud-mode" id="hudModeP1">é›™äººå°æˆ°</div>
            </div>
            <div class="player-name">ç©å®¶ 1</div>
            <div class="score-display" id="player1Score">0</div>
          </div>

          <div class="player-zone player2" data-player="2">
            <div class="player-hud">
              <div class="hud-timer" id="hudTimerP2">30</div>
              <div class="hud-mode" id="hudModeP2">é›™äººå°æˆ°</div>
            </div>
            <div class="player-name">ç©å®¶ 2</div>
            <div class="score-display" id="player2Score">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç…™ç« -->
    <div class="firework-container" id="fireworkContainer"></div>

    <!-- çµæœ -->
    <div class="modal" id="resultModal" aria-hidden="true" role="dialog">
      <div class="modal-card">
        <h2 class="title-gradient" id="resultTitle">éŠæˆ²çµæŸï¼</h2>
        <div class="result-score" id="resultScore">0</div>
        <div style="display:flex; gap:12px; justify-content:center; margin-top:18px;">
          <button class="btn btn-primary" id="playAgainBtn">å†ä¾†ä¸€å±€</button>
          <button class="btn btn-secondary" id="backToMenuBtn">è¿”å›ä¸»é¸å–®</button>
        </div>
      </div>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div class="modal" id="leaderboardModal" aria-hidden="true" role="dialog">
      <div class="modal-card" style="max-width: 90vw; width: 560px;">
        <h2 class="title-gradient">æ’è¡Œæ¦œ</h2>
        <div id="leaderboardContent" style="margin-top: 12px;"></div>
        <div style="display:flex; gap:12px; justify-content:center; margin-top:18px;">
          <button class="btn btn-secondary" id="clearLeaderboardBtn">æ¸…é™¤è¨˜éŒ„</button>
          <button class="btn btn-primary" id="closeLeaderboardBtn">é—œé–‰</button>
        </div>
      </div>
    </div>

    <!-- è¨­å®š -->
    <div class="modal" id="settingsModal" aria-hidden="true" role="dialog">
      <div class="modal-card" style="max-width: 90vw; width: 560px; text-align:left;">
        <h2 class="title-gradient">éŠæˆ²è¨­å®š</h2>
        <div style="margin-top: 12px;">
          <label style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <input type="checkbox" id="soundEnabled" /> éŸ³æ•ˆé–‹å•Ÿ
          </label>
          <label style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <input type="checkbox" id="vibrationEnabled" /> éœ‡å‹•å›é¥‹
          </label>
          <label style="display:flex; align-items:center; gap:10px;">
            éŠæˆ²æ™‚é–“ï¼š
            <select id="gameDuration" style="padding:6px 8px;">
              <option value="15">15 ç§’</option>
              <option value="30" selected>30 ç§’</option>
              <option value="60">60 ç§’</option>
            </select>
          </label>
        </div>
        <div style="display:flex; justify-content:center; margin-top:18px;">
          <button class="btn btn-primary" id="closeSettingsBtn">å„²å­˜è¨­å®š</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* éœéŸ³ console */
    (function(){ const noop=()=>{}; ["log","warn","error","info","debug","time","timeEnd"].forEach(m=>{ try{console[m]=noop;}catch(e){} }); })();

    // === éŠæˆ²ç‹€æ…‹ ===
    const GameState = {
      isPlaying:false,
      mode:"single",
      timeLeft:30,
      scores:{ single:0, player1:0, player2:0 },
      settings:{ soundEnabled:true, vibrationEnabled:true, gameDuration:30 },

      pointers:new Map(),           // pointerId -> { playerId, element }
      activePointers:new Map(),     // pointerId -> { x,y, color, tier, playerId }
      lastTapTime:{ single:0, player1:0, player2:0 }, // ms
      tapTrail:{ single:[], player1:[], player2:[] }, // [{x,y,tier,color,ts}]
      colorIndex:0
    };

    const GAME_CONFIG = {
      VIBRATION_DURATION:40,
      TAP_NUMBER_LIFETIME:1000,
      PARTICLE_LIFETIME:900,
      TRAIL_WINDOW:650,               // ç´°é›·é›»ï¼šæ™‚é–“çª—å£ç•¥çŸ­ï¼Œç¶­æŒæ¸…çˆ½
      TRAIL_MAX_POINTS:32,            // é™åˆ¶é»æ•¸
      LIGHTNING_BASE_WIDTH:1.2,       // ç´°é›·é›»åŸºç¤ç·šå¯¬
      LIGHTNING_BASE_JITTER:0.045,    // æŠ˜ç·šåç§»æ¯”ä¾‹ï¼ˆæ›´ç´°ã€æ›´ç©©ï¼‰
      RING_BASE_DURATION:680          // è§¸æ§åœ“å½¢æ³¢ç´‹åŸºæº–æ™‚é•·
    };

    // é€Ÿåº¦ç­‰ç´šï¼šæ¯ 0.5 taps/s ä¸€ç´šï¼Œ1..10
    const SPEED_STEP = 0.5;
    function tpsToLevel(tps){ const lvl = Math.floor(tps / SPEED_STEP) + 1; return Math.max(1, Math.min(10, lvl)); }

    // 10 ç´šç²‰Ã—è—ç³»è¦–è¦ºåƒæ•¸ï¼ˆé¡è‰²ã€ç·šå¯¬ä¹˜æ•¸ã€æŠ–å‹•ä¹˜æ•¸ã€å…‰æšˆã€ç²’å­æ•¸ã€åˆ†æ”¯å¯†åº¦ã€ç’°æ•¸ï¼‰
    const TIER = {
      1:  { name:"æš–èº«",    color:"#ffe6f3", widthMul:1.00, jitterMul:0.85, glow:0.12, halo:18, particles:3, branch:0, rings:1 },
      2:  { name:"å¾®ç†±",    color:"#ffd9ef", widthMul:1.04, jitterMul:0.92, glow:0.14, halo:20, particles:4, branch:0, rings:1 },
      3:  { name:"æ‰‹æ„Ÿ",    color:"#ffb2dc", widthMul:1.08, jitterMul:1.00, glow:0.16, halo:22, particles:5, branch:1, rings:1 },
      4:  { name:"é€²å…¥ç‹€æ³", color:"#ff94d0", widthMul:1.12, jitterMul:1.05, glow:0.18, halo:24, particles:6, branch:1, rings:1 },
      5:  { name:"é †é¢¨",    color:"#f66fb9", widthMul:1.18, jitterMul:1.10, glow:0.20, halo:26, particles:7, branch:1, rings:2 },
      6:  { name:"ç†±æ©Ÿ",    color:"#d9efff", widthMul:1.26, jitterMul:1.15, glow:0.22, halo:28, particles:8, branch:2, rings:2 },
      7:  { name:"å…¨é€Ÿ",    color:"#9ed9ff", widthMul:1.34, jitterMul:1.22, glow:0.24, halo:30, particles:9, branch:2, rings:2 },
      8:  { name:"ç‹‚æš´",    color:"#7ccaff", widthMul:1.46, jitterMul:1.28, glow:0.27, halo:32, particles:11, branch:2, rings:3 },
      9:  { name:"é¢¨æš´",    color:"#52b7ff", widthMul:1.60, jitterMul:1.35, glow:0.30, halo:34, particles:13, branch:3, rings:3 },
      10: { name:"é›·ç¥",    color:"#ffffff", widthMul:1.82, jitterMul:1.45, glow:0.36, halo:38, particles:15, branch:3, rings:3, rgbBurst:true }
    };

    /* === éŸ³æ•ˆï¼ˆè¼•é‡ï¼‰ === */
    class AdvancedAudioManager {
      constructor(){ this.audioContext=null; this.masterGain=null; this.sounds={}; this.isInitialized=false; }
      async init(){
        if(this.isInitialized) return;
        try{
          this.audioContext = new (window.AudioContext||window.webkitAudioContext)({ latencyHint:"interactive", sampleRate:44100 });
          this.masterGain = this.audioContext.createGain(); this.masterGain.connect(this.audioContext.destination);
          if(this.audioContext.state==="suspended") await this.audioContext.resume();
          const sr=this.audioContext.sampleRate;
          this.sounds.tap=this.renderTap(sr);
          this.sounds.countdown=this.renderBeep(sr);
          this.sounds.victory=this.renderVictory(sr);
          this.sounds.firework=this.renderFirework(sr);
          this.isInitialized=true;
        }catch(e){}
      }
      renderTap(sr){ const n=Math.floor(sr*.06), b=this.audioContext.createBuffer(1,n,sr), d=b.getChannelData(0); for(let i=0;i<n;i++){ const t=i/sr; d[i]=Math.sin(2*Math.PI*(900-400*t)*t)*Math.exp(-t*28)*.35; } return b; }
      renderBeep(sr){ const n=Math.floor(sr*.18), b=this.audioContext.createBuffer(1,n,sr), d=b.getChannelData(0); for(let i=0;i<n;i++){ const t=i/sr; d[i]=Math.sin(2*Math.PI*1000*t)*Math.exp(-t*12)*.4; } return b; }
      renderVictory(sr){ const n=Math.floor(sr*.9), b=this.audioContext.createBuffer(2,n,sr); const m=[261.63,329.63,392,523.25,659.25,784]; for(let c=0;c<2;c++){const d=b.getChannelData(c); for(let i=0;i<n;i++){ const t=i/sr, idx=Math.floor(t*6)%m.length; d[i]=Math.sin(2*Math.PI*m[idx]*t)*Math.max(0,1-t)*.24; }} return b; }
      renderFirework(sr){ const n=Math.floor(sr*.35), b=this.audioContext.createBuffer(2,n,sr); for(let c=0;c<2;c++){const d=b.getChannelData(c); for(let i=0;i<n;i++){ const t=i/sr; d[i]=(Math.random()-.5)*2*Math.exp(-t*10)*.3; }} return b; }
      play(name, vol=1){ if(!this.isInitialized||!GameState.settings.soundEnabled) return; const buf=this.sounds[name]; if(!buf) return; try{ const src=this.audioContext.createBufferSource(); const g=this.audioContext.createGain(); g.gain.value=vol; src.buffer=buf; src.connect(g); g.connect(this.masterGain); src.start(); }catch(e){} }
      vibrate(ms=40){ if(!GameState.settings.vibrationEnabled) return; if("vibrate" in navigator){ try{ navigator.vibrate(ms);}catch(e){} } }
    }

    /* === ç´°é›·é›»ï¼‹åœ“å½¢æ³¢ç´‹æ¸²æŸ“å™¨ === */
    class EffectsRenderer {
      constructor(id){
        this.canvas=document.getElementById(id);
        this.ctx=this.canvas.getContext("2d");
        this.dpr=Math.max(1, window.devicePixelRatio||1);
        this.ripples=[]; // {x,y, start, tier}
        this.resize=this.resize.bind(this);
        window.addEventListener("resize", this.resize);
        this.resize();
      }
      resize(){
        const r=this.canvas.getBoundingClientRect();
        this.canvas.width=Math.floor(r.width*this.dpr);
        this.canvas.height=Math.floor(r.height*this.dpr);
        this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0);
      }
      static rand(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }

      addRipple(x,y,tier){ this.ripples.push({x,y,start:performance.now(),tier}); }

      render(ts){
        const ctx=this.ctx;
        const w=this.canvas.clientWidth, h=this.canvas.clientHeight;
        ctx.clearRect(0,0,w,h);

        // 1) åœ“å½¢è§¸æ§æ³¢ç´‹ï¼ˆä¾é€Ÿåº¦ç´šåˆ¥æ±ºå®šç’°æ•¸èˆ‡åŠå¾‘ï¼‰
        const now=performance.now();
        const nextRipples=[];
        for(const rp of this.ripples){
          const conf=TIER[rp.tier];
          const dur = GAME_CONFIG.RING_BASE_DURATION * (1 - (rp.tier-1)*0.02); // é«˜ç´šæ›´å¿«
          const t = Math.min(1, (now - rp.start)/dur);
          const rings = conf.rings;
          for(let i=0;i<rings;i++){
            const p = Math.min(1, t + i*0.08); if(p<=0) continue;
            const r = (30 + rp.tier*10) * p * (1 + i*0.3);
            ctx.beginPath();
            ctx.arc(rp.x, rp.y, r, 0, Math.PI*2);
            ctx.strokeStyle = conf.color;
            ctx.globalAlpha = (1 - p) * (0.55 - i*0.12);
            ctx.lineWidth = 2 + rp.tier*0.15 - i*0.5;
            ctx.stroke();
            ctx.globalAlpha = 1;
          }
          if(t<1) nextRipples.push(rp);
        }
        this.ripples = nextRipples;

        // 2) æŒ‡å°–å…‰æšˆï¼ˆæ´»èºæŒ‡æ¨™ï¼‰
        for(const p of GameState.activePointers.values()){
          const halo = TIER[p.tier].halo;
          const grd = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,halo);
          grd.addColorStop(0, TIER[p.tier].color + "cc");
          grd.addColorStop(1, TIER[p.tier].color + "00");
          ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(p.x,p.y,halo,0,Math.PI*2); ctx.fill();
        }

        // 3) ç´°é›·é›»ï¼šä¾ç©å®¶ tapTrail çš„é»æ“Šé †åºé€£ç·šï¼Œä¸¦ç¹ªè£½å¾®åˆ†æ”¯ï¼ˆå°‘é‡ï¼Œä¿æ•ˆèƒ½ï¼‰
        const slice=Math.floor(ts/48); // è¿‘ä¼¼ 21 FPS çš„æŠ–å‹•åˆ·æ–°
        ["single","player1","player2"].forEach(pid=>{
          const trail=GameState.tapTrail[pid];
          if(trail.length<2) return;
          // åªå–è¿‘æœŸï¼ˆçª—å£å…§ï¼Œä¸”é™åˆ¶é»æ•¸ï¼‰
          const cutoff=performance.now()-GAME_CONFIG.TRAIL_WINDOW;
          const points = trail.filter(p=>p.ts>=cutoff).slice(-GAME_CONFIG.TRAIL_MAX_POINTS);
          if(points.length<2) return;
          for(let i=0;i<points.length-1;i++){
            const a=points[i], b=points[i+1];
            this.drawFineLightning(a,b,slice);
          }
        });
      }

      drawFineLightning(p1,p2,slice){
        const ctx=this.ctx;
        const dx=p2.x-p1.x, dy=p2.y-p1.y;
        const len=Math.hypot(dx,dy); if(len<6) return;
        const nx=dx/len, ny=dy/len;
        const px=-ny, py=nx;

        const lvlAvg=(p1.tier+p2.tier)/2;
        const c1=TIER[p1.tier], c2=TIER[p2.tier];
        const width = GAME_CONFIG.LIGHTNING_BASE_WIDTH * ((c1.widthMul+c2.widthMul)/2);
        const amp = Math.min(36, len * GAME_CONFIG.LIGHTNING_BASE_JITTER * ((c1.jitterMul+c2.jitterMul)/2));
        const N = 10 + Math.floor((lvlAvg-1)*0.5); // æ®µæ•¸
        const pts=[];

        for(let s=0;s<=N;s++){
          const t=s/N;
          const bx=p1.x + nx*len*t, by=p1.y + ny*len*t;
          const fall=1 - Math.abs(2*t-1);
          const seed=(p1.x*7.3+p1.y*13.1+p2.x*19.7+p2.y*3.1+s*97+slice*131)%10000;
          const r=EffectsRenderer.rand(seed);
          const off=(r-0.5)*2*amp*fall;
          pts.push({x:bx + px*off, y:by + py*off});
        }

        // å¤–å±¤æ·¡å…‰
        ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
        for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
        ctx.strokeStyle=`rgba(255,255,255,${0.12 + (c1.glow+c2.glow)/2})`;
        ctx.lineWidth=width+1.4; ctx.stroke();

        // ä¸»ç·šï¼ˆç´°ï¼‰ï¼šç”± p1 â†’ p2 çš„ç²‰è—æ¼¸å±¤
        const grad=ctx.createLinearGradient(p1.x,p1.y,p2.x,p2.y);
        grad.addColorStop(0, c1.color);
        grad.addColorStop(0.5, "#ffffff");
        grad.addColorStop(1, c2.color);
        ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
        for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
        ctx.strokeStyle=grad; ctx.lineWidth=width; ctx.stroke();

        // å¾®åˆ†æ”¯ï¼ˆå°‘é‡ï¼Œç´°çŸ­ï¼Œåƒ…é«˜ç­‰ç´šå‡ºç¾ï¼‰
        const branchCount = Math.min(3, Math.floor(((c1.branch+c2.branch)/2)));
        if(branchCount>0){
          for(let b=0;b<branchCount;b++){
            const idx = 1 + Math.floor((pts.length-2) * (b+1)/(branchCount+1));
            const base=pts[idx];
            // åˆ†æ”¯æ–¹å‘ï¼šç´„ç•¥åå‘å‚ç›´
            const dir = ((b%2) ? 1 : -1);
            const blen = Math.min(22, 6 + len*0.08); // çŸ­
            const jitter = (EffectsRenderer.rand(slice*17+b*.77)-.5)*6;
            ctx.beginPath();
            ctx.moveTo(base.x, base.y);
            ctx.lineTo(base.x + px*dir*blen + nx*jitter, base.y + py*dir*blen + ny*jitter);
            ctx.strokeStyle = b%2 ? c1.color : c2.color;
            ctx.globalAlpha = 0.7;
            ctx.lineWidth = Math.max(0.8, width*0.7);
            ctx.stroke();
            ctx.globalAlpha = 1;
          }
        }
      }
    }

    /* === è¼¸å…¥ç®¡ç†ï¼šé †åºé›·é›» + é€Ÿåº¦åˆ†ç´š + åœ“å½¢è§¸æ§ç‰¹æ•ˆ === */
    class AdvancedInputManager {
      constructor(gameEngine){
        this.gameEngine=gameEngine;
        const area=document.getElementById("gameArea");
        area.addEventListener("pointerdown", this.onDown.bind(this), {passive:false});
        area.addEventListener("pointermove", this.onMove.bind(this), {passive:false});
        area.addEventListener("pointerup",   this.onUp.bind(this),   {passive:false});
        area.addEventListener("pointercancel", this.onUp.bind(this), {passive:false});
        area.addEventListener("contextmenu", e=>e.preventDefault());
        area.addEventListener("dblclick", e=>e.preventDefault());
      }
      onDown(e){
        if(!GameState.isPlaying) return;
        e.preventDefault();
        const rect=e.currentTarget.getBoundingClientRect();
        const x=e.clientX-rect.left, y=e.clientY-rect.top;
        const id=e.pointerId; e.currentTarget.setPointerCapture(id);

        // å€åŸŸ â†’ ç©å®¶
        let playerId;
        if(GameState.mode==="single"){ playerId="single"; }
        else{
          // ä¸ŠåŠ player1ï¼Œä¸‹åŠ player2
          playerId = (y < rect.height/2) ? "player1" : "player2";
        }

        GameState.pointers.set(id,{playerId, element:e.currentTarget});

        // é€Ÿåº¦åˆ†ç´š
        const now=performance.now();
        const last=GameState.lastTapTime[playerId] || 0;
        const dt = last ? (now-last) : 1e9;
        const tps = 1000/dt;
        const tier = tpsToLevel(tps);
        GameState.lastTapTime[playerId]=now;

        const conf=TIER[tier];
        const color=conf.color;

        // æ´»èºæŒ‡æ¨™ï¼ˆå…‰æšˆï¼‰
        GameState.activePointers.set(id,{x,y,color,tier,playerId});

        // è¨ˆåˆ†ï¼ˆç„¡é€£æ“ŠåŠ æˆï¼‰
        GameState.scores[playerId]++; uiManager.updateScoreDisplay(); uiManager.animateScore(playerId);

        // tapTrail è¿½åŠ ï¼ˆé †åºé›·é›»ç”¨ï¼‰
        const trail=GameState.tapTrail[playerId];
        trail.push({x,y,color,tier,ts:now});
        const cutoff = now - GAME_CONFIG.TRAIL_WINDOW;
        while(trail.length>0 && (trail.length>GAME_CONFIG.TRAIL_MAX_POINTS || trail[0].ts<cutoff)) trail.shift();

        // è¦–è¦ºï¼šåœ“å½¢æ³¢ç´‹ + ç²’å­ +ï¼ˆå¯èƒ½ï¼‰RGB é–ƒçˆ
        effectsRenderer.addRipple(x,y,tier);
        this.createParticles(x,y,conf.particles,color);
        if(conf.rgbBurst){ const app=document.getElementById("app"); app.classList.add("rgb-burst"); setTimeout(()=>app.classList.remove("rgb-burst"), 480); }

        // æµ®å‹•åˆ†æ•¸ï¼ˆä¸Šæ–¹ç©å®¶ä¹Ÿéœ€é¡åƒï¼‰
        this.showTapNumber(playerId,x,y,color);

        // è²èˆ‡éœ‡å‹•
        audioManager.play("tap", .5); audioManager.vibrate();

        // å€å¡Š active
        if(GameState.mode==="dual"){
          const zone=document.querySelector(`.player-zone.${playerId}`); if(zone) zone.classList.add("active");
        }
      }
      onMove(e){
        if(!GameState.isPlaying) return;
        e.preventDefault();
        const rect=e.currentTarget.getBoundingClientRect();
        const x=e.clientX-rect.left, y=e.clientY-rect.top;
        const p=GameState.activePointers.get(e.pointerId); if(p){ p.x=x; p.y=y; }
      }
      onUp(e){
        const meta=GameState.pointers.get(e.pointerId);
        if(meta){
          try{ meta.element.releasePointerCapture(e.pointerId);}catch(_){}
          if(GameState.mode==="dual"){
            const zone=document.querySelector(`.player-zone.${meta.playerId}`); if(zone) zone.classList.remove("active");
          }
        }
        GameState.pointers.delete(e.pointerId); GameState.activePointers.delete(e.pointerId);
      }

      showTapNumber(playerId,x,y,color){
        const gameArea=document.getElementById("gameArea");
        const wrap=document.createElement("div");
        wrap.className="tap-number";
        if(GameState.mode==="dual" && playerId==="player1") wrap.classList.add("mirror");
        const inner=document.createElement("span");
        inner.className="inner";
        inner.textContent = GameState.scores[playerId];
        // éš¨æ©Ÿä½ç§»
        const j=22; const rx=(Math.random()-.5)*2*j; const ry=(Math.random()-.5)*2*j;
        wrap.style.left=`${x+rx}px`; wrap.style.top=`${y+ry}px`;
        inner.style.color=color; wrap.appendChild(inner); gameArea.appendChild(wrap);
        setTimeout(()=>wrap.remove(), GAME_CONFIG.TAP_NUMBER_LIFETIME);
      }

      createParticles(x,y,count,color){
        const area=document.getElementById("gameArea");
        for(let i=0;i<count;i++){
          const p=document.createElement("div"); p.className="particle";
          p.style.background=color; p.style.color=color;
          const ang=Math.random()*Math.PI*2, dist=16+Math.random()*26;
          p.style.left=`${x+Math.cos(ang)*dist}px`; p.style.top=`${y+Math.sin(ang)*dist}px`;
          area.appendChild(p); setTimeout(()=>p.remove(), GAME_CONFIG.PARTICLE_LIFETIME);
        }
      }
    }

    /* === éŠæˆ²å¼•æ“ === */
    class AdvancedGameEngine {
      constructor(){ this.animationFrame=null; this.startTime=0; this.lastCountdownSecond=null; this.isFullscreen=false; }
      async startSinglePlayer(){ await this.enterFullscreen(); this.startGame("single"); }
      async startDualPlayer(){ await this.enterFullscreen(); this.startGame("dual"); }

      async enterFullscreen(){
        try{
          const el=document.documentElement;
          if(el.requestFullscreen) await el.requestFullscreen();
          else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
          this.isFullscreen=true;
        }catch(_){}
      }
      exitFullscreen(){
        try{
          if(document.exitFullscreen) document.exitFullscreen();
          else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
          this.isFullscreen=false;
        }catch(_){}
      }

      startGame(mode){
        if(GameState.isPlaying) return;
        GameState.mode=mode; GameState.isPlaying=true;
        GameState.timeLeft=GameState.settings.gameDuration;
        GameState.scores={ single:0, player1:0, player2:0 };
        GameState.pointers.clear(); GameState.activePointers.clear();
        GameState.lastTapTime={ single:0, player1:0, player2:0 };
        GameState.tapTrail={ single:[], player1:[], player2:[] };
        GameState.colorIndex=0;

        document.getElementById("gameHeader").classList.toggle("hidden", mode==="dual");
        uiManager.showGameScreen(mode);
        uiManager.updateGameUI();
        uiManager.updateScoreDisplay();
        effectsRenderer.resize();

        this.startTime=performance.now();
        this.lastCountdownSecond=null;

        const loop=(ts)=>{
          if(!GameState.isPlaying) return;
          const elapsed=(ts - this.startTime)/1000;
          GameState.timeLeft=Math.max(0, GameState.settings.gameDuration - elapsed);
          uiManager.updateTimer();
          effectsRenderer.render(ts);

          if(GameState.timeLeft<=3 && GameState.timeLeft>0){
            const secs=Math.ceil(GameState.timeLeft);
            if(secs!==this.lastCountdownSecond){ audioManager.play("countdown"); this.lastCountdownSecond=secs; }
          }
          if(GameState.timeLeft<=0){ this.endGame(); return; }
          this.animationFrame=requestAnimationFrame(loop);
        };
        this.animationFrame=requestAnimationFrame(loop);
      }

      async endGame(){
        GameState.isPlaying=false;
        if(this.animationFrame){ cancelAnimationFrame(this.animationFrame); this.animationFrame=null; }

        const result=this.calculateResult();

        // å‹åˆ©æ‰æ’­ç…™ç«ï¼Œä¸”ç­‰å¾…æ’­æ”¾å®Œå†é¡¯ç¤ºçµæœ
        if(result.hasWinner){ await this.playFireworks(); audioManager.play("victory", .9); }
        uiManager.showResult(result);
      }

      calculateResult(){
        const r={ hasWinner:false, winner:null, score:0, score2:0 };
        if(GameState.mode==="single"){
          r.score=GameState.scores.single; r.hasWinner=r.score>0;
          storageManager.saveScore("single", r.score);
        }else{
          r.score=GameState.scores.player1; r.score2=GameState.scores.player2;
          if(r.score>r.score2){ r.winner="player1"; r.hasWinner=true; }
          else if(r.score2>r.score){ r.winner="player2"; r.hasWinner=true; }
          storageManager.saveScore("dual", Math.max(r.score,r.score2), Math.min(r.score,r.score2));
        }
        return r;
      }

      playFireworks(){
        const container=document.getElementById("fireworkContainer");
        const colors=["#f66fb9","#ffb2dc","#7ccaff","#52b7ff","#ffffff"];
        const count=18, duration=4600;
        return new Promise(resolve=>{
          for(let i=0;i<count;i++){
            setTimeout(()=>{
              const cx=Math.random()*window.innerWidth;
              const cy=Math.random()*(window.innerHeight*0.6)+window.innerHeight*0.2;
              for(let j=0;j<12;j++){
                const dot=document.createElement("div"); dot.className="firework";
                const c=colors[Math.floor(Math.random()*colors.length)];
                dot.style.background=c; dot.style.boxShadow=`0 0 10px ${c}`;
                dot.style.left=cx+"px"; dot.style.top=cy+"px";
                container.appendChild(dot);
                const ang=(j/12)*Math.PI*2, dist=100+Math.random()*120, dur=900+Math.random()*420;
                dot.animate([{ transform:"translate(0,0) scale(1)", opacity:1 },{ transform:`translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px) scale(0)`, opacity:0 }], { duration:dur, easing:"ease-out" }).addEventListener("finish", ()=>dot.remove());
              }
              audioManager.play("firework", .25);
            }, i*(duration/count));
          }
          setTimeout(()=>{ container.innerHTML=""; resolve(); }, duration+220);
        });
      }

      exitGame(){
        GameState.isPlaying=false;
        if(this.animationFrame){ cancelAnimationFrame(this.animationFrame); this.animationFrame=null; }
        this.exitFullscreen();
        uiManager.showMenuScreen();
      }
    }

    /* === å„²å­˜ === */
    class StorageManager {
      constructor(){ this.KEY="eliteTapBattle_FineLightning"; this.loadSettings(); }
      loadSettings(){ try{ const d=JSON.parse(localStorage.getItem(this.KEY)||"{}"); if(d.settings) Object.assign(GameState.settings,d.settings);}catch(_){ } }
      saveSettings(){ const d=this.loadData(); d.settings={...GameState.settings}; this.saveData(d); }
      saveScore(mode, score, score2=null){
        const d=this.loadData(); const rec={ mode, score, score2, date:new Date().toISOString(), ts:Date.now() };
        d.leaderboard=d.leaderboard||[]; d.leaderboard.push(rec);
        d.leaderboard.sort((a,b)=>b.score-a.score); d.leaderboard=d.leaderboard.slice(0,50);
        this.saveData(d);
      }
      getLeaderboard(mode=null, limit=10){
        const d=this.loadData(); let r=(d.leaderboard||[]);
        if(mode) r=r.filter(x=>x.mode===mode); return r.slice(0,limit);
      }
      clearData(){ if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŠæˆ²è¨˜éŒ„å—ï¼Ÿ")){ localStorage.removeItem(this.KEY); alert("è¨˜éŒ„å·²æ¸…é™¤ï¼"); } }
      loadData(){ try{ return JSON.parse(localStorage.getItem(this.KEY)||"{}"); }catch(_){ return {}; } }
      saveData(d){ try{ localStorage.setItem(this.KEY, JSON.stringify(d)); }catch(_){ alert("å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹æ¸…é™¤èˆŠè¨˜éŒ„ï¼"); } }
    }

    /* === UI === */
    class AdvancedUIManager {
      constructor(){
        // ä¸»é¸å–®
        document.getElementById("startSingleBtn").addEventListener("click", async ()=>{ await this.initAudio(); gameEngine.startSinglePlayer(); });
        document.getElementById("startDualBtn").addEventListener("click", async ()=>{ await this.initAudio(); gameEngine.startDualPlayer(); });
        document.getElementById("leaderboardBtn").addEventListener("click", ()=>{ this.updateLeaderboard(); this.showModal("leaderboardModal"); });
        document.getElementById("settingsBtn").addEventListener("click", ()=>{ this.showSettings(); });

        // éŠæˆ²æ§åˆ¶
        document.getElementById("gameExit").addEventListener("click", ()=>gameEngine.exitGame());

        // çµæœ
        document.getElementById("playAgainBtn").addEventListener("click", ()=>{
          this.hideModal("resultModal");
          if(GameState.mode==="single") gameEngine.startSinglePlayer(); else gameEngine.startDualPlayer();
        });
        document.getElementById("backToMenuBtn").addEventListener("click", ()=>{
          this.hideModal("resultModal"); gameEngine.exitGame();
        });

        // æ’è¡Œæ¦œ
        document.getElementById("closeLeaderboardBtn").addEventListener("click", ()=>this.hideModal("leaderboardModal"));
        document.getElementById("clearLeaderboardBtn").addEventListener("click", ()=>{ storageManager.clearData(); this.updateLeaderboard(); });

        // è¨­å®š
        document.getElementById("closeSettingsBtn").addEventListener("click", ()=>{ this.saveSettings(); this.hideModal("settingsModal"); });

        // éµç›¤ Esc
        document.addEventListener("keydown", (e)=>{ if(e.code==="Escape" && GameState.isPlaying) gameEngine.exitGame(); });

        // è¼‰å…¥è¨­å®š
        this.loadSettingsUI();
      }

      async initAudio(){ if(!audioManager.isInitialized) await audioManager.init(); }

      showGameScreen(mode){
        document.getElementById("menuScreen").classList.add("hidden");
        const gs=document.getElementById("gameScreen");
        gs.classList.add("active"); gs.setAttribute("aria-hidden","false");
        if(mode==="single"){
          document.getElementById("singlePlayerArea").style.display="flex";
          document.getElementById("dualPlayerArea").style.display="none";
        }else{
          document.getElementById("singlePlayerArea").style.display="none";
          document.getElementById("dualPlayerArea").style.display="grid";
        }
      }
      showMenuScreen(){
        document.getElementById("menuScreen").classList.remove("hidden");
        const gs=document.getElementById("gameScreen"); gs.classList.remove("active"); gs.setAttribute("aria-hidden","true");
      }

      updateGameUI(){
        document.getElementById("gameMode").textContent = GameState.mode==="single" ? "å–®äººæŒ‘æˆ°" : "é›™äººå°æˆ°";
        document.getElementById("hudModeP1").textContent = "é›™äººå°æˆ°";
        document.getElementById("hudModeP2").textContent = "é›™äººå°æˆ°";
      }
      updateScoreDisplay(){
        if(GameState.mode==="single"){ document.getElementById("singleScore").textContent=GameState.scores.single; }
        else{
          document.getElementById("player1Score").textContent=GameState.scores.player1;
          document.getElementById("player2Score").textContent=GameState.scores.player2;
        }
      }
      animateScore(playerId){
        const el=document.getElementById(`${playerId}Score`); if(!el) return;
        el.style.animation="none"; el.offsetHeight; el.style.animation="pulse .28s ease-in-out alternate";
      }
      updateTimer(){
        const t=Math.ceil(GameState.timeLeft);
        const tEl=document.getElementById("gameTimer");
        tEl.textContent=t;
        if(GameState.timeLeft<=5 && GameState.timeLeft>0){ tEl.style.color="var(--sky-600)"; tEl.style.animation="pulse .5s ease-in-out infinite alternate"; }
        else { tEl.style.color="var(--primary)"; tEl.style.animation=""; }
        // é›™äºº HUD
        document.getElementById("hudTimerP1").textContent=t;
        document.getElementById("hudTimerP2").textContent=t;
      }

      showResult(r){
        const modal=document.getElementById("resultModal");
        const title=document.getElementById("resultTitle");
        const score=document.getElementById("resultScore");
        if(GameState.mode==="single"){
          title.textContent="å–®äººæŒ‘æˆ°å®Œæˆï¼";
          score.textContent=`å¾—åˆ†ï¼š${r.score}`;
        }else{
          if(r.winner){ title.textContent=`ğŸ† ${r.winner==="player1"?"ç©å®¶ 1":"ç©å®¶ 2"} ç²å‹ï¼`; }
          else { title.textContent="ğŸ¤ å¹³æ‰‹ï¼"; }
          score.textContent=`${r.score} : ${r.score2}`;
        }
        modal.classList.add("show"); modal.setAttribute("aria-hidden","false");
      }

      showModal(id){ const m=document.getElementById(id); m.classList.add("show"); m.setAttribute("aria-hidden","false"); }
      hideModal(id){ const m=document.getElementById(id); m.classList.remove("show"); m.setAttribute("aria-hidden","true"); }

      showSettings(){
        document.getElementById("soundEnabled").checked=GameState.settings.soundEnabled;
        document.getElementById("vibrationEnabled").checked=GameState.settings.vibrationEnabled;
        document.getElementById("gameDuration").value=GameState.settings.gameDuration;
        this.showModal("settingsModal");
      }
      saveSettings(){
        GameState.settings.soundEnabled=document.getElementById("soundEnabled").checked;
        GameState.settings.vibrationEnabled=document.getElementById("vibrationEnabled").checked;
        GameState.settings.gameDuration=parseInt(document.getElementById("gameDuration").value,10);
        storageManager.saveSettings();
      }
      loadSettingsUI(){
        document.getElementById("soundEnabled").checked=GameState.settings.soundEnabled;
        document.getElementById("vibrationEnabled").checked=GameState.settings.vibrationEnabled;
        document.getElementById("gameDuration").value=GameState.settings.gameDuration;
      }

      updateLeaderboard(){
        const c=document.getElementById("leaderboardContent");
        const rec=storageManager.getLeaderboard(null,10);
        if(rec.length===0){ c.innerHTML='<p style="color:var(--text-secondary);text-align:center;">å°šç„¡è¨˜éŒ„</p>'; return; }
        c.innerHTML = `
          <div style="display:grid; gap:10px;">
            ${rec.map((r,i)=>{
              const date=new Date(r.date).toLocaleDateString("zh-TW");
              const modeText=r.mode==="single"?"å–®äºº":"é›™äºº";
              const scoreText=r.score2!=null?`${r.score} : ${r.score2}`:`${r.score}`;
              return `
                <div style="display:flex; align-items:center; gap:14px; padding:10px 12px; background:var(--bg-secondary); border-radius:14px; border-left:4px solid var(--primary);">
                  <div style="min-width:2rem; font-weight:800; color:var(--primary);">#${i+1}</div>
                  <div style="flex:1;">
                    <div style="font-weight:800;">${scoreText}</div>
                    <div style="font-size:12px; color:var(--text-secondary);">${modeText} â€¢ ${date}</div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }
    }

    // === åˆå§‹åŒ– ===
    let audioManager, effectsRenderer, inputManager, gameEngine, storageManager, uiManager;
    document.addEventListener("DOMContentLoaded", ()=>{
      audioManager = new AdvancedAudioManager();
      storageManager = new StorageManager();
      gameEngine = new AdvancedGameEngine();
      uiManager = new AdvancedUIManager();
      effectsRenderer = new EffectsRenderer("fxCanvas");
      inputManager = new AdvancedInputManager(gameEngine);
      window.addEventListener("orientationchange", ()=> setTimeout(()=>effectsRenderer.resize(), 250));
    });

    // é›¢é–‹å…¨å±æ™‚è‡ªå‹•çµæŸ
    document.addEventListener("fullscreenchange", ()=>{ if(!document.fullscreenElement && GameState.isPlaying){ gameEngine.exitGame(); } });

    // ç¦é›™æ“Šæ”¾å¤§èˆ‡æ‰‹å‹¢ç¸®æ”¾
    (function preventZoom(){
      let last=0;
      document.addEventListener("touchend",(e)=>{ const now=Date.now(); if(now-last<=300){ e.preventDefault(); } last=now; }, {passive:false});
      ["gesturestart","gesturechange","gestureend"].forEach(evt=> document.addEventListener(evt, e=>e.preventDefault()));
    })();
  </script>
</body>
</html>