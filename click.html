<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <!-- iOS å®‰å…¨å€ï¼‹é¿å…å·¥å…·åˆ—ä½”é«˜ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#f9a8d4" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Elite Tap Battle - å°ˆæ¥­é»æ“Šå°æˆ°</title>

  <style>
    /* === å°ˆæ¥­ç´šè‰²å½©ç³»çµ± === */
    :root {
      /* ç²‰è‰²å¯æ„›ç³»ï¼ˆåŠ å¼·ç²‰è‰²æ°›åœï¼‰ */
      --pink-50: #fdf2f8;
      --pink-100: #fde7f2;
      --pink-200: #fbd4e8;
      --pink-300: #f9b6db;
      --pink-400: #f590c8;
      --pink-500: #ef6fb6;
      --pink-600: #db3f99;
      --pink-700: #bf2e83;

      --purple-100: #efe7ff;
      --purple-200: #e2d4ff;
      --purple-400: #c084fc;
      --purple-500: #a855f7;
      --purple-600: #9333ea;

      --blue-100: #e8f0ff;
      --blue-400: #60a5fa;
      --blue-500: #3b82f6;

      --amber-500: #f59e0b;
      --emerald-500: #10b981;
      --red-500: #ef4444;
      --orange-500: #f97316;
      --cyan-500: #06b6d4;
      --lime-500: #84cc16;
      --fuchsia-500: #d946ef;

      /* ä¸­æ€§è‰² */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;

      /* èªç¾©åŒ–è‰²å½© */
      --primary: var(--pink-500);
      --primary-dark: var(--pink-600);
      --primary-light: var(--pink-300);

      --secondary: var(--purple-500);

      /* èƒŒæ™¯èˆ‡æ–‡å­— */
      --bg-primary: #ffffff;
      --bg-secondary: var(--gray-50);
      --bg-tertiary: var(--gray-100);
      --text-primary: var(--gray-900);
      --text-secondary: var(--gray-500);

      /* é™°å½±ç³»çµ± */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      /* é–“è·ç³»çµ± */
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-16: 4rem;

      /* åœ“è§’ç³»çµ± */
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      --radius-full: 9999px;

      /* å‹•ç•«æ™‚é–“ */
      --duration-fast: 150ms;
      --duration-normal: 300ms;

      /* å­—é«” */
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-2xl: 1.5rem;
      --font-size-4xl: 2.25rem;
      --font-size-6xl: 3.75rem;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: #111827;
        --bg-secondary: #0b1220;
        --bg-tertiary: #0f1626;
        --text-primary: #f3f4f6;
        --text-secondary: #9ca3af;
      }
    }

    /* åŸºç¤é‡ç½® */
    * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
    html, body {
      height: 100svh;
      width: 100vw;
      overflow: hidden;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      background: var(--bg-primary);
      color: var(--text-primary);
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
    }

    /* ä¸»å®¹å™¨ï¼šç²‰è‰²å¯æ„›æ¼¸å±¤ + ç²‰éœ§ */
    .app {
      position: fixed; inset: 0;
      height: 100svh; width: 100vw;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,182,211,0.35), transparent 60%),
        radial-gradient(1200px 800px at 80% 90%, rgba(255,170,220,0.35), transparent 60%),
        linear-gradient(135deg, var(--pink-100) 0%, var(--pink-50, #fff0f7) 40%, var(--purple-100) 100%);
    }

    /* RGB ç¬é–“å¼·åŒ–ï¼ˆæœ€é«˜é€Ÿæ™‚çŸ­æš«å¥—ç”¨ï¼‰ */
    .app.rgb-burst { animation: hueCycle 0.8s linear infinite; }
    @keyframes hueCycle { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(360deg); } }

    /* ä¸»é¸å–® */
    .menu-screen {
      height: 100%;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      gap: var(--space-10);
      padding: var(--space-8);
    }
    .menu-screen.hidden { opacity: 0; visibility: hidden; transition: all var(--duration-normal) ease; }

    .brand { text-align: center; }
    .brand-icon {
      width: 120px; height: 120px; margin: 0 auto var(--space-6);
      background: conic-gradient(from 0deg, #ffd6ea, #ffc7e4, #ffdff0, #ffd6ea);
      border-radius: 28px; display: grid; place-items: center;
      box-shadow: 0 18px 40px rgba(239, 111, 182, 0.35);
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{ transform: translateY(0);} 50%{ transform: translateY(-10px);} }
    .brand-title {
      font-size: 2.4rem; font-weight: 900; letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 60%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }
    .brand-subtitle { color: var(--text-secondary); margin-top: 6px; }

    .menu-buttons { display: grid; gap: var(--space-4); width: min(90vw, 360px); }
    .menu-btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 10px;
      padding: 16px 20px; border: 0; border-radius: 16px; font-weight: 700; cursor: pointer;
      box-shadow: var(--shadow-md); transition: transform var(--duration-fast) ease, box-shadow var(--duration-fast) ease;
      min-height: 64px;
    }
    .menu-btn:active { transform: scale(0.98); }
    .menu-btn-primary { color: #fff; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
    .menu-btn-primary:hover { box-shadow: 0 14px 32px rgba(239, 111, 182, 0.35); transform: translateY(-2px); }
    .menu-btn-secondary { background: var(--bg-primary); border: 2px solid var(--gray-200); color: var(--text-primary); }

    /* éŠæˆ²ç•«é¢ */
    .game-screen { position: absolute; inset: 0; display: none; flex-direction: column; }
    .game-screen.active { display: flex; }

    /* å–®äººæ¨¡å¼é ‚éƒ¨åˆ— */
    .game-header {
      position: absolute; left: 0; right: 0; top: 0;
      height: 80px; padding-top: env(safe-area-inset-top);
      background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(239,111,182,0.25);
      display: flex; align-items: center; justify-content: space-between;
      padding-left: var(--space-6); padding-right: var(--space-6);
      z-index: 100;
    }
    .game-header.hidden { display: none; }

    .game-timer { display: flex; align-items: center; gap: 8px; font-weight: 900; color: var(--primary); font-size: var(--font-size-2xl); }
    .game-mode { font-size: var(--font-size-sm); color: var(--text-secondary); background: var(--bg-tertiary); padding: 6px 10px; border-radius: 999px; }

    .game-exit { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 6px; border-radius: 10px; }
    .game-exit:hover { background: var(--bg-tertiary); color: var(--text-primary); }

    .game-area { position: relative; flex: 1; margin-top: calc(80px + env(safe-area-inset-top)); touch-action: none; overflow: hidden; }

    /* æ•ˆæœç•«å¸ƒ */
    .fx-canvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }

    /* å–®äººå€ */
    .single-player-area {
      position: absolute; inset: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--pink-100) 0%, var(--pink-200) 60%, var(--purple-100) 100%);
      z-index: 1;
    }

    /* é›™äººå€ */
    .dual-player-area { position: absolute; inset: 0; display: grid; z-index: 1; }
    @media (orientation: landscape) { .dual-player-area { grid-template-columns: 1fr 1fr; } }
    @media (orientation: portrait)  { .dual-player-area { grid-template-rows: 1fr 1fr; } }

    .player-zone {
      position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden;
      background: linear-gradient(135deg, var(--pink-100) 0%, var(--pink-200) 100%);
      transition: transform var(--duration-fast) ease;
    }
    .player-zone.player2 { background: linear-gradient(135deg, var(--purple-100) 0%, var(--purple-200) 100%); }
    /* é¢å°é¢é¡åƒï¼šplayer1 æ•´å€æ—‹è½‰ */
    .dual-player-area .player-zone.player1 { transform: rotate(180deg); }
    .player-zone.active { transform: rotate(180deg) scale(1.02); }
    .dual-player-area .player-zone.player2.active { transform: scale(1.02); }

    /* åˆ†éš”ç·š */
    .divider { position: absolute; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); z-index: 2; }
    @media (orientation: landscape) { .divider { left: 50%; top: 0; bottom: 0; width: 4px; transform: translateX(-50%); } }
    @media (orientation: portrait)  { .divider { top: 50%; left: 0; right: 0; height: 4px; transform: translateY(-50%); } }

    /* é›™äºº HUDï¼šæ™‚é–“ï¼‹æ¨¡å¼ï¼Œåˆ†åˆ¥å›ºå®šæ–¼å„è‡ªå€å¡Šé ‚é‚Š */
    .player-hud {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 8px; align-items: center; z-index: 10;
      padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.86); backdrop-filter: blur(8px);
      border: 1px solid rgba(239,111,182,0.25);
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      font-weight: 700;
    }
    .player-hud .hud-timer { color: var(--primary); }
    .player-hud .hud-mode  { color: var(--text-secondary); font-size: var(--font-size-sm); padding: 2px 8px; background: var(--bg-tertiary); border-radius: 999px; }

    /* æ–‡æ¡ˆ */
    .player-name { color: var(--text-secondary); font-weight: 600; margin-bottom: var(--space-6); }
    .score-display { font-size: var(--font-size-6xl); font-weight: 900; color: var(--primary); text-shadow: 0 6px 16px rgba(239,111,182,0.35); z-index: 3; }

    /* é»æ“Šæµ®æ•¸å­—ï¼šç”¨å¤–å±¤åšé¡åƒï¼Œå…§å±¤è·‘å‹•ç•«ï¼Œé¿å… transform è¡çª */
    .tap-number {
      position: absolute; z-index: 25; pointer-events: none;
      will-change: transform, opacity; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.35));
    }
    .tap-number .inner {
      font-size: var(--font-size-2xl); font-weight: 900; color: #fff;
      text-shadow: 0 0 10px currentColor, 0 2px 4px rgba(0, 0, 0, 0.5);
      animation: number-float 1s ease-out forwards;
      display: inline-block;
    }
    .tap-number.mirror { transform: rotate(180deg); }
    @keyframes number-float {
      0%   { transform: scale(0.85) translateY(0);   opacity: 0.9; }
      20%  { transform: scale(1.12) translateY(-8px); opacity: 1; }
      100% { transform: scale(0.95) translateY(-46px); opacity: 0; }
    }

    /* è¼•é‡ç²’å­ */
    .particle {
      position: absolute; width: 6px; height: 6px; border-radius: 50%;
      pointer-events: none; z-index: 15; opacity: 0.9; box-shadow: 0 0 6px currentColor;
      animation: particleFloat 900ms ease-out forwards;
      will-change: transform, opacity;
    }
    @keyframes particleFloat {
      0%   { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-60px) scale(0.4); opacity: 0; }
    }

    /* ç…™ç« */
    .firework-container { position: fixed; inset: 0; pointer-events: none; z-index: 200; }
    .firework { position: absolute; width: 4px; height: 4px; border-radius: 50%; }

    /* çµæœå½ˆçª— */
    .result-modal {
      position: fixed; inset: 0; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.8); z-index: 1000; opacity: 0; visibility: hidden; transition: all var(--duration-normal) ease;
    }
    .result-modal.show { opacity: 1; visibility: visible; }
    .result-content {
      background: var(--bg-primary); border-radius: var(--radius-2xl); padding: var(--space-8); text-align: center;
      box-shadow: var(--shadow-xl); transform: scale(0.92); transition: transform var(--duration-normal) ease;
    }
    .result-modal.show .result-content { transform: scale(1); }
    .result-title { font-size: 1.8rem; font-weight: 900; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 60%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    .result-score { margin-top: 10px; font-size: var(--font-size-4xl); font-weight: 800; color: var(--primary); }

    /* é€šç”¨æŒ‰éˆ• */
    .btn { border: 0; border-radius: 14px; padding: 12px 18px; font-weight: 700; cursor: pointer; }
    .btn-primary { color: #fff; background: linear-gradient(135deg, var(--primary) 0%, var(--pink-700) 100%); box-shadow: 0 10px 24px rgba(239,111,182,0.35); }
    .btn-secondary { background: var(--bg-secondary); border: 1px solid var(--gray-300); }

    /* å€’æ•¸å‹•ç•« */
    @keyframes pulse { from { transform: scale(1);} to { transform: scale(1.08);} }

    @media (max-width: 640px) {
      .game-header { height: 70px; }
      .game-area   { margin-top: calc(70px + env(safe-area-inset-top)); }
      .score-display { font-size: 2.6rem; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- ä¸»é¸å–® -->
    <div class="menu-screen" id="menuScreen">
      <div class="brand">
        <div class="brand-icon">
          <svg viewBox="0 0 24 24" width="54" height="54" aria-hidden="true">
            <path fill="#ef6fb6" d="M12 2l2.39 6.26L21 9.27l-5.18 4.87L17.18 21 12 18.26 6.82 21l1.36-6.86L3 9.27l6.61-1.01L12 2z"/>
          </svg>
        </div>
        <div class="brand-title">Elite Tap Battle</div>
        <div class="brand-subtitle">å°ˆæ¥­ç´šé»æ“Šå°æˆ°é«”é©—</div>
      </div>

      <div class="menu-buttons">
        <button class="menu-btn menu-btn-primary" id="startSingleBtn" aria-label="å–®äººæŒ‘æˆ°æ¨¡å¼">
          <svg class="icon" viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          å–®äººæŒ‘æˆ°æ¨¡å¼
        </button>
        <button class="menu-btn menu-btn-primary" id="startDualBtn" aria-label="é›™äººå°æˆ°æ¨¡å¼">
          <svg class="icon" viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M16 4a4 4 0 110 8 4 4 0 010-8zM8 4a4 4 0 110 8 4 4 0 010-8zM8 14c-2.67 0-8 1.34-8 4v2h12v-2c0-2.66-1.33-4-4-4zm8 0c-2.67 0-4 1.34-4 4v2h12v-2c0-2.66-5.33-4-8-4z"/></svg>
          é›™äººå°æˆ°æ¨¡å¼
        </button>
        <button class="menu-btn menu-btn-secondary" id="leaderboardBtn" aria-label="æ’è¡Œæ¦œ">
          <svg class="icon" viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M7 14H4v6h3v-6zm6-4h-3v10h3V10zm9-6h-5v16h5V4z"/></svg>
          æ’è¡Œæ¦œ
        </button>
        <button class="menu-btn menu-btn-secondary" id="settingsBtn" aria-label="éŠæˆ²è¨­å®š">
          <svg class="icon" viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7m7.43-2.53c.04-.32.07-.64.07-.97s-.03-.66-.07-.98l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46a.5.5 0 0 0-.61-.22l-2.49 1a7.03 7.03 0 0 0-1.69-.98l-.37-2.65A.5.5 0 0 0 13 2h-2a.5.5 0 0 0-.5.42l-.37 2.65c-.61.24-1.18.56-1.69.98l-2.49-1a.5.5 0 0 0-.61.22l-2 3.46a.5.5 0 0 0 .12.64L4.57 11c-.04.32-.07.65-.07.98s.03.65.07.97l-2.11 1.63a.5.5 0 0 0-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.51.42 1.08.74 1.69.98l.37 2.65c.04.24.25.42.5.42h2c.25 0 .46-.18.5-.42l.37-2.65c.61-.24 1.18-.56 1.69-.98l2.49 1c.22.08.49 0 .61-.22l2-3.46a.5.5 0 0 0-.12-.64z"/></svg>
          éŠæˆ²è¨­å®š
        </button>
      </div>
    </div>

    <!-- éŠæˆ²ç•«é¢ -->
    <div class="game-screen" id="gameScreen" aria-hidden="true">
      <!-- å–®äººæ¨¡å¼é ‚æ¬„ -->
      <div class="game-header" id="gameHeader">
        <div class="game-timer" aria-live="polite">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16m0-18a10 10 0 1 1 0 20 10 10 0 0 1 0-20m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5z"/></svg>
          <span id="gameTimer">30</span>
        </div>
        <div class="game-mode" id="gameMode">å–®äººæ¨¡å¼</div>
        <button class="game-exit" id="gameExit" aria-label="é›¢é–‹éŠæˆ²">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </div>

      <div class="game-area" id="gameArea">
        <canvas id="fxCanvas" class="fx-canvas"></canvas>

        <!-- å–®äºº -->
        <div class="single-player-area" id="singlePlayerArea" style="display:none">
          <div class="player-name">é–‹å§‹é»æ“ŠæŒ‘æˆ°ï¼</div>
          <div class="score-display" id="singleScore">0</div>
        </div>

        <!-- é›™äºº -->
        <div class="dual-player-area" id="dualPlayerArea" style="display:none">
          <div class="divider"></div>

          <div class="player-zone player1" data-player="1">
            <div class="player-hud">
              <div class="hud-timer" id="hudTimerP1">30</div>
              <div class="hud-mode" id="hudModeP1">é›™äººå°æˆ°</div>
            </div>
            <div class="player-name">ç©å®¶ 1</div>
            <div class="score-display" id="player1Score">0</div>
          </div>

          <div class="player-zone player2" data-player="2">
            <div class="player-hud">
              <div class="hud-timer" id="hudTimerP2">30</div>
              <div class="hud-mode" id="hudModeP2">é›™äººå°æˆ°</div>
            </div>
            <div class="player-name">ç©å®¶ 2</div>
            <div class="score-display" id="player2Score">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç…™ç« -->
    <div class="firework-container" id="fireworkContainer"></div>

    <!-- çµæœ -->
    <div class="result-modal" id="resultModal" aria-hidden="true" role="dialog" aria-labelledby="resultTitle">
      <div class="result-content">
        <h2 class="result-title" id="resultTitle">éŠæˆ²çµæŸï¼</h2>
        <div class="result-score" id="resultScore">0</div>
        <div style="display:flex; gap:12px; justify-content:center; margin-top: 18px;">
          <button class="btn btn-primary" id="playAgainBtn">å†ä¾†ä¸€å±€</button>
          <button class="btn btn-secondary" id="backToMenuBtn">è¿”å›ä¸»é¸å–®</button>
        </div>
      </div>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div class="result-modal" id="leaderboardModal" aria-hidden="true" role="dialog">
      <div class="result-content" style="max-width: 90vw; width: 560px;">
        <h2 class="result-title">æ’è¡Œæ¦œ</h2>
        <div id="leaderboardContent" style="margin-top: 12px;"></div>
        <div style="display:flex; gap:12px; justify-content:center; margin-top: 18px;">
          <button class="btn btn-secondary" id="clearLeaderboardBtn">æ¸…é™¤è¨˜éŒ„</button>
          <button class="btn btn-primary" id="closeLeaderboardBtn">é—œé–‰</button>
        </div>
      </div>
    </div>

    <!-- è¨­å®š -->
    <div class="result-modal" id="settingsModal" aria-hidden="true" role="dialog">
      <div class="result-content" style="max-width: 90vw; width: 560px; text-align:left;">
        <h2 class="result-title">éŠæˆ²è¨­å®š</h2>
        <div style="margin-top: 12px;">
          <label style="display:flex; align-items:center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" id="soundEnabled" /> éŸ³æ•ˆé–‹å•Ÿ
          </label>
          <label style="display:flex; align-items:center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" id="vibrationEnabled" /> éœ‡å‹•å›é¥‹
          </label>
          <label style="display:flex; align-items:center; gap: 10px;">
            éŠæˆ²æ™‚é–“ï¼š
            <select id="gameDuration" style="padding: 6px 8px;">
              <option value="15">15 ç§’</option>
              <option value="30" selected>30 ç§’</option>
              <option value="60">60 ç§’</option>
            </select>
          </label>
        </div>
        <div style="display:flex; justify-content:center; margin-top: 18px;">
          <button class="btn btn-primary" id="closeSettingsBtn">å„²å­˜è¨­å®š</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* éœéŸ³ console */
    (function() {
      const noop = ()=>{}; ["log","warn","error","info","debug","time","timeEnd"].forEach(m=>{ try{ console[m]=noop; }catch(e){} });
    })();

    /**
     * â¤ æ”¹ç‰ˆè¦é»
     * 1) é›·é›»æ•ˆæœä¾ã€é»æ“Šé †åºã€‘é€£ç·šï¼ˆå„ç©å®¶å„è‡ªçš„ tapTrailï¼‰
     * 2) é»æ“Šé€Ÿåº¦ç­‰ç´šï¼š10 ç´šï¼ˆæ¯ 0.5 taps/s ä¸€ç´šï¼Œæœ€é«˜ â‰¥5.0 taps/sï¼‰
     *    â†’ ä¸åŒé¡è‰²ã€ç·šå¯¬ã€æŠ–å‹•ã€å…‰æšˆã€ç²’å­æ•¸ï¼Œé€Ÿåº¦è¶Šå¿«è¶Šè¯éº—ï¼Œæœ€é«˜ç´šç¨é›£é”æˆ
     * 3) é›™äººå°æˆ°ï¼šé›™å´ HUD é¡¯ç¤ºæ™‚é–“èˆ‡æ¨¡å¼ï¼›ä¸Šæ–¹ç©å®¶ï¼ˆplayer1ï¼‰æµ®æ•¸å­—é¡åƒ
     * 4) å–®æ¬¡é»æ“Šï¼+1 åˆ†ï¼ˆç„¡é€£æ“ŠåŠ æˆï¼‰ï¼Œæµ®æ•¸å­—é¡¯ç¤ºç•¶å‰ç¸½åˆ†ï¼Œéš¨æ©Ÿä½ç§»ä¸¦ 1s æ¶ˆæ•£
     * 5) iOS å…¨å±èˆ‡ç¦ç¸®æ”¾æœ€ä½³åŒ–ã€ç„¡æ»¾å‹•
     */

    /* === éŠæˆ²ç‹€æ…‹ === */
    const GameState = {
      isPlaying: false,
      mode: "single",
      timeLeft: 30,
      scores: { single: 0, player1: 0, player2: 0 },
      settings: { soundEnabled: true, vibrationEnabled: true, gameDuration: 30 },
      pointers: new Map(),            // pointerId -> { playerId, element }
      activePointers: new Map(),      // pointerId -> { x, y, color, playerId, tier }
      lastTapTime: { single: 0, player1: 0, player2: 0 }, // ms
      tapTrail: { single: [], player1: [], player2: [] }, // æœ€è¿‘çš„é»æ“Šéˆ
      colorIndex: 0
    };

    const GAME_CONFIG = {
      VIBRATION_DURATION: 40,
      TAP_NUMBER_LIFETIME: 1000,
      PARTICLE_LIFETIME: 900,
      TRAIL_WINDOW: 700,           // åªæ¸²æŸ“æœ€è¿‘ 700ms çš„é€£é–
      TRAIL_MAX_POINTS: 40,
      LIGHTNING_BASE_WIDTH: 2.2,
      LIGHTNING_BASE_JITTER: 0.06  // ç›¸å°æ–¼æ®µé•·çš„æŠ–å‹•æ¯”ä¾‹
    };

    /* é€Ÿåº¦ç­‰ç´šï¼ˆtaps per secondï¼‰ã€‚level = 1..10 */
    const SPEED_STEP = 0.5; // æ¯ 0.5 taps/s å‡ä¸€ç´š
    function tpsToLevel(tps) {
      const lvl = Math.floor(tps / SPEED_STEP) + 1; // 0~0.49 -> 1, 0.5~0.99 -> 2, ...
      return Math.max(1, Math.min(10, lvl));
    }

    /* æ¯ç´šç‰¹æ•ˆåƒæ•¸ï¼ˆé¡è‰²ã€ç·šå¯¬ä¹˜æ•¸ã€æŠ–å‹•ä¹˜æ•¸ã€å…‰æšˆå¼·åº¦ã€ç²’å­æ•¸ç­‰ï¼‰ */
    const TIER = {
      1:  { name:"æš–èº«",   color:"#fde7f2", widthMul:1.00, jitterMul:0.80, glow:0.15, halo:20, particles:4 },
      2:  { name:"å¾®ç†±",   color:"#f9b6db", widthMul:1.05, jitterMul:0.90, glow:0.18, halo:22, particles:5 },
      3:  { name:"æ‰‹æ„Ÿ",   color:"#f590c8", widthMul:1.10, jitterMul:1.00, glow:0.20, halo:24, particles:6 },
      4:  { name:"é€²å…¥ç‹€æ³", color:"#ef6fb6", widthMul:1.15, jitterMul:1.10, glow:0.22, halo:26, particles:7 },
      5:  { name:"é †é¢¨",   color:"#db3f99", widthMul:1.22, jitterMul:1.15, glow:0.24, halo:28, particles:8 },
      6:  { name:"ç†±æ©Ÿ",   color:"#a855f7", widthMul:1.30, jitterMul:1.20, glow:0.26, halo:30, particles:9 },
      7:  { name:"å…¨é€Ÿ",   color:"#3b82f6", widthMul:1.38, jitterMul:1.25, glow:0.28, halo:32, particles:10 },
      8:  { name:"ç‹‚æš´",   color:"#06b6d4", widthMul:1.48, jitterMul:1.30, glow:0.30, halo:34, particles:12 },
      9:  { name:"é¢¨æš´",   color:"#10b981", widthMul:1.60, jitterMul:1.35, glow:0.33, halo:36, particles:14 },
      10: { name:"é›·ç¥",   color:"#ffffff", widthMul:1.80, jitterMul:1.45, glow:0.38, halo:40, particles:16, rgbBurst:true }
    };

    /* === éŸ³æ•ˆï¼ˆç°¡åŒ–ç‰ˆï¼‰ === */
    class AdvancedAudioManager {
      constructor(){ this.audioContext=null; this.masterGain=null; this.sounds={}; this.isInitialized=false; }
      async init(){
        if(this.isInitialized) return;
        try{
          this.audioContext = new (window.AudioContext||window.webkitAudioContext)({ latencyHint:"interactive", sampleRate:44100 });
          this.masterGain = this.audioContext.createGain(); this.masterGain.connect(this.audioContext.destination);
          if(this.audioContext.state==="suspended") await this.audioContext.resume();
          const sr = this.audioContext.sampleRate;
          this.sounds.tap = this.renderTap(sr);
          this.sounds.countdown = this.renderBeep(sr);
          this.sounds.victory = this.renderVictory(sr);
          this.sounds.firework = this.renderFirework(sr);
          this.isInitialized=true;
        }catch(e){}
      }
      renderTap(sr){ const n=Math.floor(sr*0.06), b=this.audioContext.createBuffer(1,n,sr), d=b.getChannelData(0); for(let i=0;i<n;i++){const t=i/sr; d[i]=Math.sin(2*Math.PI*(900-400*t)*t)*Math.exp(-t*28)*0.35;} return b; }
      renderBeep(sr){ const n=Math.floor(sr*0.18), b=this.audioContext.createBuffer(1,n,sr), d=b.getChannelData(0); for(let i=0;i<n;i++){const t=i/sr; d[i]=Math.sin(2*Math.PI*1000*t)*Math.exp(-t*12)*0.4;} return b; }
      renderVictory(sr){ const n=Math.floor(sr*0.9), b=this.audioContext.createBuffer(2,n,sr); const m=[261.63,329.63,392,523.25,659.25,784]; for(let c=0;c<2;c++){const d=b.getChannelData(c); for(let i=0;i<n;i++){const t=i/sr, idx=Math.floor(t*6)%m.length; d[i]=Math.sin(2*Math.PI*m[idx]*t)*Math.max(0,1-t)*0.24;}} return b; }
      renderFirework(sr){ const n=Math.floor(sr*0.35), b=this.audioContext.createBuffer(2,n,sr); for(let c=0;c<2;c++){const d=b.getChannelData(c); for(let i=0;i<n;i++){const t=i/sr; d[i]=(Math.random()-0.5)*2*Math.exp(-t*10)*0.3;}} return b; }
      play(name, vol=1){ if(!this.isInitialized||!GameState.settings.soundEnabled) return; const buf=this.sounds[name]; if(!buf) return; try{ const src=this.audioContext.createBufferSource(); const g=this.audioContext.createGain(); g.gain.value=vol; src.buffer=buf; src.connect(g); g.connect(this.masterGain); src.start(); }catch(e){} }
      vibrate(ms=40){ if(!GameState.settings.vibrationEnabled) return; if("vibrate" in navigator){ try{ navigator.vibrate(ms);}catch(e){} } }
    }

    /* === é›·é›»èˆ‡å…‰æšˆæ¸²æŸ“ï¼ˆä¾ç…§é»æ“Šé †åºï¼‰ === */
    class EffectsRenderer {
      constructor(id){
        this.canvas=document.getElementById(id);
        this.ctx=this.canvas.getContext("2d");
        this.dpr=Math.max(1, window.devicePixelRatio||1);
        this.resize= this.resize.bind(this);
        window.addEventListener("resize", this.resize);
        this.resize();
      }
      resize(){
        const r=this.canvas.getBoundingClientRect();
        this.canvas.width=Math.floor(r.width*this.dpr);
        this.canvas.height=Math.floor(r.height*this.dpr);
        this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0);
      }
      static rand(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }

      render(ts){
        const ctx=this.ctx;
        const w=this.canvas.clientWidth, h=this.canvas.clientHeight;
        ctx.clearRect(0,0,w,h);

        // æŒ‡å°–å…‰æšˆï¼ˆæ´»èºæŒ‡æ¨™ï¼‰
        for(const p of GameState.activePointers.values()){
          const halo = TIER[p.tier].halo;
          const grd = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,halo);
          grd.addColorStop(0, TIER[p.tier].color + "cc");
          grd.addColorStop(1, TIER[p.tier].color + "00");
          ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(p.x,p.y,halo,0,Math.PI*2); ctx.fill();
        }

        // ä¾ç©å®¶çš„ tapTrail åšæœ‰åºé›·é›»
        const now=performance.now();
        ["single","player1","player2"].forEach(pid=>{
          const trail = GameState.tapTrail[pid].filter(p=> now - p.ts <= GAME_CONFIG.TRAIL_WINDOW);
          GameState.tapTrail[pid] = trail.slice(-GAME_CONFIG.TRAIL_MAX_POINTS);
          if(trail.length<2) return;

          // ç”±ç¬¬ä¸€å€‹åˆ°æœ€å¾Œä¸€å€‹ä¾åºé€£
          for(let i=0;i<trail.length-1;i++){
            const a=trail[i], b=trail[i+1];
            this.drawLightning(a, b, ts);
          }
        });
      }

      drawLightning(p1, p2, ts){
        const ctx=this.ctx;
        const dx=p2.x-p1.x, dy=p2.y-p1.y;
        const len=Math.hypot(dx,dy); if(len<6) return;
        const nx=dx/len, ny=dy/len;
        const px=-ny, py=nx;

        const lvlAvg=(p1.tier+p2.tier)/2;
        const conf1=TIER[p1.tier], conf2=TIER[p2.tier];
        const width = GAME_CONFIG.LIGHTNING_BASE_WIDTH * (1 + (lvlAvg-1)*0.09) * ((conf1.widthMul+conf2.widthMul)/2);
        const amp = Math.min(44, len * GAME_CONFIG.LIGHTNING_BASE_JITTER * ((conf1.jitterMul+conf2.jitterMul)/2));
        const N = 12 + Math.floor((lvlAvg-1)*0.6); // æ›´é«˜ç­‰æ›´å¤šæ®µ

        const pts=[];
        const slice = Math.floor(ts/50);
        for(let s=0;s<=N;s++){
          const t=s/N;
          const bx=p1.x + nx*len*t, by=p1.y + ny*len*t;
          const fall=1 - Math.abs(2*t-1); // ä¸­æ®µæ›´æŠ–
          const seed=(p1.x*13.37+p1.y*7.11+p2.x*17.17+p2.y*19.19+s*97+slice*131)%10000;
          const r=EffectsRenderer.rand(seed);
          const off=(r-0.5)*2*amp*fall;
          pts.push({x: bx + px*off, y: by + py*off});
        }

        // å¤–å…‰æšˆ
        ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
        for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
        ctx.strokeStyle = `rgba(255,255,255,${0.15 + (conf1.glow+conf2.glow)/2})`;
        ctx.lineWidth = width+2; ctx.stroke();

        // ä¸»ç·šï¼šp1â†’p2 æ¼¸å±¤
        const grad=ctx.createLinearGradient(p1.x,p1.y,p2.x,p2.y);
        grad.addColorStop(0, conf1.color);
        grad.addColorStop(0.5, "#ffffff");
        grad.addColorStop(1, conf2.color);

        ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
        for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
        ctx.strokeStyle=grad; ctx.lineWidth=width; ctx.stroke();
      }
    }

    /* === è¼¸å…¥ç®¡ç†ï¼ˆå¤šæŒ‡ã€é€Ÿåº¦åˆ†ç´šã€é †åºé€£ç·šï¼‰ === */
    class AdvancedInputManager {
      constructor(gameEngine){
        this.gameEngine=gameEngine;
        const area=document.getElementById("gameArea");
        area.addEventListener("pointerdown", this.onDown.bind(this), {passive:false});
        area.addEventListener("pointermove", this.onMove.bind(this), {passive:false});
        area.addEventListener("pointerup",   this.onUp.bind(this),   {passive:false});
        area.addEventListener("pointercancel", this.onUp.bind(this), {passive:false});
        area.addEventListener("contextmenu", e=>e.preventDefault());
        area.addEventListener("dblclick", e=>e.preventDefault());
      }

      onDown(e){
        if(!GameState.isPlaying) return;
        e.preventDefault();
        const rect=e.currentTarget.getBoundingClientRect();
        const x=e.clientX-rect.left, y=e.clientY-rect.top;
        const id=e.pointerId; e.currentTarget.setPointerCapture(id);

        // è¾¨è­˜ç©å®¶å€
        let playerId;
        if(GameState.mode==="single"){ playerId="single"; }
        else{
          if(window.innerWidth>window.innerHeight){ playerId = x < rect.width/2 ? "player1":"player2"; }
          else{ playerId = y < rect.height/2 ? "player1":"player2"; }
        }

        GameState.pointers.set(id, {playerId, element:e.currentTarget});

        // é€Ÿåº¦åˆ†ç´š
        const now=performance.now();
        const last=GameState.lastTapTime[playerId] || 0;
        const dt = last ? (now - last) : 1e9;   // é¦–æ¬¡æ¥µå¤§
        const tps = 1000 / dt;
        const tier = tpsToLevel(tps);
        GameState.lastTapTime[playerId]=now;

        const tierConf = TIER[tier];
        const color = tierConf.color;

        // æ´»èºæŒ‡æ¨™ï¼ˆå…‰æšˆï¼‰
        GameState.activePointers.set(id, { x, y, color, playerId, tier });

        // åˆ†æ•¸ï¼ˆæ¯æ¬¡ +1ï¼‰
        GameState.scores[playerId]++; uiManager.updateScoreDisplay(); uiManager.animateScore(playerId);

        // TapTrail è¿½åŠ ï¼Œåšé †åºé›·é›»
        const trail = GameState.tapTrail[playerId];
        trail.push({ x, y, color, tier, ts: now });
        // ä¿®å‰ª trail
        const cutoff = now - GAME_CONFIG.TRAIL_WINDOW;
        while(trail.length > 0 && (trail.length>GAME_CONFIG.TRAIL_MAX_POINTS || trail[0].ts < cutoff)) trail.shift();

        // è¦–è¦ºï¼šæµ®æ•¸å­—ï¼ˆé¡¯ç¤ºç´¯è¨ˆåˆ†ï¼‰+ ç²’å­ï¼ˆä¾ tier æ•°é‡ï¼‰
        this.showTapNumber(playerId, x, y, color);
        this.createParticles(x, y, tierConf.particles, color);

        // æœ€é«˜ç­‰ç´šçµ¦çŸ­æš« RGB é–ƒçˆ
        if(tierConf.rgbBurst){
          const app=document.getElementById("app");
          app.classList.add("rgb-burst");
          setTimeout(()=>app.classList.remove("rgb-burst"), 500);
        }

        // éŸ³æ•ˆ/éœ‡å‹•
        audioManager.play("tap", 0.5); audioManager.vibrate();

        // æ©Ÿåˆ¶æ•ˆæœï¼šå€å¡Š active
        if(GameState.mode==="dual"){
          const zone=document.querySelector(`.player-zone.${playerId}`);
          if(zone) zone.classList.add("active");
        }
      }

      onMove(e){
        if(!GameState.isPlaying) return;
        e.preventDefault();
        const rect=e.currentTarget.getBoundingClientRect();
        const x=e.clientX-rect.left, y=e.clientY-rect.top;
        const p=GameState.activePointers.get(e.pointerId);
        if(p){ p.x=x; p.y=y; }
      }

      onUp(e){
        const meta=GameState.pointers.get(e.pointerId);
        if(meta){
          try{ meta.element.releasePointerCapture(e.pointerId);}catch(err){}
          if(GameState.mode==="dual"){
            const zone=document.querySelector(`.player-zone.${meta.playerId}`);
            if(zone) zone.classList.remove("active");
          }
        }
        GameState.pointers.delete(e.pointerId);
        GameState.activePointers.delete(e.pointerId);
      }

      showTapNumber(playerId, x, y, color){
        const gameArea=document.getElementById("gameArea");
        const wrap=document.createElement("div");
        wrap.className="tap-number";
        // é›™äººæ¨¡å¼æ™‚ï¼Œä¸Šæ–¹ç©å®¶ï¼ˆplayer1ï¼Œæ•´å€æ—‹è½‰ï¼‰æµ®æ•¸å­—ä¹Ÿé¡åƒ
        if(GameState.mode==="dual" && playerId==="player1") wrap.classList.add("mirror");

        const inner=document.createElement("span");
        inner.className="inner";
        inner.textContent = GameState.scores[playerId];

        // éš¨æ©Ÿä½ç§»
        const jitter=24;
        const rx=(Math.random()-0.5)*2*jitter;
        const ry=(Math.random()-0.5)*2*jitter;

        wrap.style.left = `${x+rx}px`;
        wrap.style.top  = `${y+ry}px`;
        inner.style.color = color;

        wrap.appendChild(inner);
        gameArea.appendChild(wrap);
        setTimeout(()=>wrap.remove(), GAME_CONFIG.TAP_NUMBER_LIFETIME);
      }

      createParticles(x, y, count, color){
        const area=document.getElementById("gameArea");
        for(let i=0;i<count;i++){
          const p=document.createElement("div");
          p.className="particle";
          p.style.background=color; p.style.color=color;
          const ang=Math.random()*Math.PI*2;
          const dist=18+Math.random()*28;
          p.style.left = `${x + Math.cos(ang)*dist}px`;
          p.style.top  = `${y + Math.sin(ang)*dist}px`;
          area.appendChild(p);
          setTimeout(()=>p.remove(), GAME_CONFIG.PARTICLE_LIFETIME);
        }
      }
    }

    /* === éŠæˆ²å¼•æ“ === */
    class AdvancedGameEngine {
      constructor(){ this.animationFrame=null; this.startTime=0; this.lastCountdownSecond=null; this.isFullscreen=false; }

      async startSinglePlayer(){ await this.enterFullscreen(); this.startGame("single"); }
      async startDualPlayer(){ await this.enterFullscreen(); this.startGame("dual"); }

      async enterFullscreen(){
        try{
          const el=document.documentElement;
          if(el.requestFullscreen) await el.requestFullscreen();
          else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
          this.isFullscreen=true;
        }catch(e){}
      }
      exitFullscreen(){
        try{
          if(document.exitFullscreen) document.exitFullscreen();
          else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
          this.isFullscreen=false;
        }catch(e){}
      }

      startGame(mode){
        if(GameState.isPlaying) return;
        GameState.mode=mode; GameState.isPlaying=true;
        GameState.timeLeft=GameState.settings.gameDuration;
        GameState.scores={ single:0, player1:0, player2:0 };
        GameState.pointers.clear(); GameState.activePointers.clear();
        GameState.lastTapTime={ single:0, player1:0, player2:0 };
        GameState.tapTrail={ single:[], player1:[], player2:[] };
        GameState.colorIndex=0;

        document.getElementById("gameHeader").classList.toggle("hidden", mode==="dual");
        uiManager.showGameScreen(mode);
        uiManager.updateGameUI();
        uiManager.updateScoreDisplay();
        effectsRenderer.resize();

        this.startTime=performance.now();
        this.lastCountdownSecond=null;

        const loop=(ts)=>{
          if(!GameState.isPlaying) return;
          const elapsed=(ts - this.startTime)/1000;
          GameState.timeLeft=Math.max(0, GameState.settings.gameDuration - elapsed);
          uiManager.updateTimer();
          effectsRenderer.render(ts);

          if(GameState.timeLeft<=3 && GameState.timeLeft>0){
            const secs=Math.ceil(GameState.timeLeft);
            if(secs!==this.lastCountdownSecond){ audioManager.play("countdown"); this.lastCountdownSecond=secs; }
          }

          if(GameState.timeLeft<=0){ this.endGame(); return; }
          this.animationFrame=requestAnimationFrame(loop);
        };
        this.animationFrame=requestAnimationFrame(loop);
      }

      async endGame(){
        GameState.isPlaying=false;
        if(this.animationFrame){ cancelAnimationFrame(this.animationFrame); this.animationFrame=null; }

        const result=this.calculateResult();

        // å‹åˆ©æ‰æ’­æ”¾ç…™ç«ï¼Œä¸¦ã€ç­‰å¾…æ’­æ”¾å®Œã€‘å†é¡¯ç¤ºçµæœ
        if(result.hasWinner){
          await this.playFireworks(); // ç­‰å¾…
          audioManager.play("victory", 0.9);
        }

        this.showGameResult(result);
      }

      calculateResult(){
        const r={ hasWinner:false, winner:null, score:0, score2:0 };
        if(GameState.mode==="single"){
          r.score=GameState.scores.single;
          r.hasWinner=r.score>0;
          storageManager.saveScore("single", r.score);
        }else{
          r.score=GameState.scores.player1; r.score2=GameState.scores.player2;
          if(r.score>r.score2){ r.winner="player1"; r.hasWinner=true; }
          else if(r.score2>r.score){ r.winner="player2"; r.hasWinner=true; }
          storageManager.saveScore("dual", Math.max(r.score,r.score2), Math.min(r.score,r.score2));
        }
        return r;
      }

      playFireworks(){
        const container=document.getElementById("fireworkContainer");
        const colors=["#ef6fb6","#a855f7","#3b82f6","#10b981","#f59e0b","#ffffff"];
        const count=18, duration=4500; // å‹•ç•«ç¸½é•·
        return new Promise(resolve=>{
          for(let i=0;i<count;i++){
            setTimeout(()=>{
              const cx=Math.random()*window.innerWidth;
              const cy=Math.random()*(window.innerHeight*0.6)+window.innerHeight*0.2;
              for(let j=0;j<12;j++){
                const dot=document.createElement("div"); dot.className="firework";
                const c=colors[Math.floor(Math.random()*colors.length)];
                dot.style.background=c; dot.style.boxShadow=`0 0 10px ${c}`;
                dot.style.left=cx+"px"; dot.style.top=cy+"px";
                container.appendChild(dot);
                const ang=(j/12)*Math.PI*2, dist=100+Math.random()*120, dur=900+Math.random()*400;
                dot.animate([{ transform:"translate(0,0) scale(1)", opacity:1 }, { transform:`translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px) scale(0)`, opacity:0 }], { duration:dur, easing:"ease-out" }).addEventListener("finish", ()=>dot.remove());
              }
              audioManager.play("firework", 0.25);
            }, i*(duration/count));
          }
          setTimeout(()=>{ container.innerHTML=""; resolve(); }, duration+200);
        });
      }

      showGameResult(result){ uiManager.showResult(result); }
      exitGame(){
        GameState.isPlaying=false;
        if(this.animationFrame){ cancelAnimationFrame(this.animationFrame); this.animationFrame=null; }
        this.exitFullscreen();
        uiManager.showMenuScreen();
      }
    }

    /* === å„²å­˜ === */
    class StorageManager {
      constructor(){ this.KEY="eliteTapBattleV2"; this.loadSettings(); }
      loadSettings(){ try{ const d=JSON.parse(localStorage.getItem(this.KEY)||"{}"); if(d.settings) Object.assign(GameState.settings,d.settings);}catch(e){} }
      saveSettings(){ const d=this.loadData(); d.settings={...GameState.settings}; this.saveData(d); }
      saveScore(mode, score, score2=null){
        const d=this.loadData(); const rec={ mode, score, score2, date:new Date().toISOString(), ts:Date.now() };
        d.leaderboard = d.leaderboard||[]; d.leaderboard.push(rec);
        d.leaderboard.sort((a,b)=>b.score-a.score); d.leaderboard=d.leaderboard.slice(0,50);
        this.saveData(d);
      }
      getLeaderboard(mode=null, limit=10){
        const d=this.loadData(); let r=(d.leaderboard||[]);
        if(mode) r=r.filter(x=>x.mode===mode); return r.slice(0,limit);
      }
      clearData(){ if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŠæˆ²è¨˜éŒ„å—ï¼Ÿ")){ localStorage.removeItem(this.KEY); alert("è¨˜éŒ„å·²æ¸…é™¤ï¼"); } }
      loadData(){ try{ return JSON.parse(localStorage.getItem(this.KEY)||"{}"); }catch(e){ return {}; } }
      saveData(d){ try{ localStorage.setItem(this.KEY, JSON.stringify(d)); }catch(e){ alert("å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹æ¸…é™¤èˆŠè¨˜éŒ„ï¼"); } }
    }

    /* === UI === */
    class AdvancedUIManager {
      constructor(){
        // ä¸»é¸å–®
        document.getElementById("startSingleBtn").addEventListener("click", async ()=>{ await this.initAudio(); gameEngine.startSinglePlayer(); });
        document.getElementById("startDualBtn").addEventListener("click", async ()=>{ await this.initAudio(); gameEngine.startDualPlayer(); });
        document.getElementById("leaderboardBtn").addEventListener("click", ()=>{ this.updateLeaderboard(); this.showModal("leaderboardModal"); });
        document.getElementById("settingsBtn").addEventListener("click", ()=>{ this.showSettings(); });

        // éŠæˆ²æ§åˆ¶
        document.getElementById("gameExit").addEventListener("click", ()=>gameEngine.exitGame());

        // çµæœ
        document.getElementById("playAgainBtn").addEventListener("click", ()=>{
          this.hideModal("resultModal");
          if(GameState.mode==="single") gameEngine.startSinglePlayer(); else gameEngine.startDualPlayer();
        });
        document.getElementById("backToMenuBtn").addEventListener("click", ()=>{
          this.hideModal("resultModal"); gameEngine.exitGame();
        });

        // æ’è¡Œæ¦œ
        document.getElementById("closeLeaderboardBtn").addEventListener("click", ()=>this.hideModal("leaderboardModal"));
        document.getElementById("clearLeaderboardBtn").addEventListener("click", ()=>{ storageManager.clearData(); this.updateLeaderboard(); });

        // è¨­å®š
        document.getElementById("closeSettingsBtn").addEventListener("click", ()=>{ this.saveSettings(); this.hideModal("settingsModal"); });

        // éµç›¤ Esc
        document.addEventListener("keydown", (e)=>{ if(e.code==="Escape" && GameState.isPlaying) gameEngine.exitGame(); });

        // è¼‰å…¥è¨­å®š
        this.loadSettingsUI();
      }

      async initAudio(){ if(!audioManager.isInitialized) await audioManager.init(); }

      showGameScreen(mode){
        document.getElementById("menuScreen").classList.add("hidden");
        document.getElementById("gameScreen").classList.add("active");
        document.getElementById("gameScreen").setAttribute("aria-hidden","false");
        if(mode==="single"){
          document.getElementById("singlePlayerArea").style.display="flex";
          document.getElementById("dualPlayerArea").style.display="none";
        }else{
          document.getElementById("singlePlayerArea").style.display="none";
          document.getElementById("dualPlayerArea").style.display="grid";
        }
      }
      showMenuScreen(){
        document.getElementById("menuScreen").classList.remove("hidden");
        const gs=document.getElementById("gameScreen");
        gs.classList.remove("active"); gs.setAttribute("aria-hidden","true");
      }

      updateGameUI(){
        document.getElementById("gameMode").textContent = GameState.mode==="single" ? "å–®äººæŒ‘æˆ°" : "é›™äººå°æˆ°";
        document.getElementById("hudModeP1").textContent = "é›™äººå°æˆ°";
        document.getElementById("hudModeP2").textContent = "é›™äººå°æˆ°";
      }

      updateScoreDisplay(){
        if(GameState.mode==="single"){
          document.getElementById("singleScore").textContent = GameState.scores.single;
        }else{
          document.getElementById("player1Score").textContent = GameState.scores.player1;
          document.getElementById("player2Score").textContent = GameState.scores.player2;
        }
      }
      animateScore(playerId){
        const el=document.getElementById(`${playerId}Score`); if(!el) return;
        el.style.animation="none"; el.offsetHeight; // reset
        el.style.animation="pulse 0.28s ease-in-out alternate";
      }

      updateTimer(){
        const t=Math.ceil(GameState.timeLeft);
        // å–®äººé ‚æ¬„
        const timerEl=document.getElementById("gameTimer");
        timerEl.textContent=t;
        if(GameState.timeLeft<=5 && GameState.timeLeft>0){ timerEl.style.color="var(--amber-500)"; timerEl.style.animation="pulse 0.5s ease-in-out infinite alternate"; }
        else { timerEl.style.color="var(--primary)"; timerEl.style.animation=""; }

        // é›™äºº HUD
        document.getElementById("hudTimerP1").textContent=t;
        document.getElementById("hudTimerP2").textContent=t;
      }

      showResult(r){
        const modal=document.getElementById("resultModal");
        const title=document.getElementById("resultTitle");
        const score=document.getElementById("resultScore");
        if(GameState.mode==="single"){
          title.textContent="å–®äººæŒ‘æˆ°å®Œæˆï¼";
          score.textContent=`å¾—åˆ†ï¼š${r.score}`;
        }else{
          if(r.winner){ title.textContent=`ğŸ† ${r.winner==="player1"?"ç©å®¶ 1":"ç©å®¶ 2"} ç²å‹ï¼`; }
          else { title.textContent="ğŸ¤ å¹³æ‰‹ï¼"; }
          score.textContent=`${r.score} : ${r.score2}`;
        }
        modal.classList.add("show"); modal.setAttribute("aria-hidden","false");
      }

      showModal(id){ const m=document.getElementById(id); m.classList.add("show"); m.setAttribute("aria-hidden","false"); }
      hideModal(id){ const m=document.getElementById(id); m.classList.remove("show"); m.setAttribute("aria-hidden","true"); }

      showSettings(){
        document.getElementById("soundEnabled").checked=GameState.settings.soundEnabled;
        document.getElementById("vibrationEnabled").checked=GameState.settings.vibrationEnabled;
        document.getElementById("gameDuration").value=GameState.settings.gameDuration;
        this.showModal("settingsModal");
      }
      saveSettings(){
        GameState.settings.soundEnabled=document.getElementById("soundEnabled").checked;
        GameState.settings.vibrationEnabled=document.getElementById("vibrationEnabled").checked;
        GameState.settings.gameDuration=parseInt(document.getElementById("gameDuration").value,10);
        storageManager.saveSettings();
      }
      loadSettingsUI(){
        document.getElementById("soundEnabled").checked=GameState.settings.soundEnabled;
        document.getElementById("vibrationEnabled").checked=GameState.settings.vibrationEnabled;
        document.getElementById("gameDuration").value=GameState.settings.gameDuration;
      }

      updateLeaderboard(){
        const c=document.getElementById("leaderboardContent");
        const rec=storageManager.getLeaderboard(null, 10);
        if(rec.length===0){ c.innerHTML='<p style="color:var(--text-secondary);text-align:center;">å°šç„¡è¨˜éŒ„</p>'; return; }
        c.innerHTML = `
          <div style="display:grid; gap:10px;">
            ${rec.map((r,i)=>{
              const date=new Date(r.date).toLocaleDateString("zh-TW");
              const modeText=r.mode==="single"?"å–®äºº":"é›™äºº";
              const scoreText=r.score2!=null ? `${r.score} : ${r.score2}` : `${r.score}`;
              return `
                <div style="display:flex; align-items:center; gap:14px; padding:10px 12px; background:var(--bg-secondary); border-radius:14px; border-left:4px solid var(--primary);">
                  <div style="min-width:2rem; font-weight:800; color:var(--primary);">#${i+1}</div>
                  <div style="flex:1;">
                    <div style="font-weight:800;">${scoreText}</div>
                    <div style="font-size:12px; color:var(--text-secondary);">${modeText} â€¢ ${date}</div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }
    }

    /* === åˆå§‹åŒ– === */
    let audioManager, effectsRenderer, inputManager, gameEngine, storageManager, uiManager;
    document.addEventListener("DOMContentLoaded", ()=>{
      audioManager = new AdvancedAudioManager();
      storageManager = new StorageManager();
      gameEngine = new AdvancedGameEngine();
      uiManager = new AdvancedUIManager();
      effectsRenderer = new EffectsRenderer("fxCanvas");
      inputManager = new AdvancedInputManager(gameEngine);

      // iOS å°ºå¯¸ä¿®æ­£
      window.addEventListener("orientationchange", ()=> setTimeout(()=>effectsRenderer.resize(), 250));
    });

    // é›¢é–‹å…¨å±æ™‚è‡ªå‹•çµæŸ
    document.addEventListener("fullscreenchange", ()=>{ if(!document.fullscreenElement && GameState.isPlaying){ gameEngine.exitGame(); } });

    // ç¦é›™æ“Šæ”¾å¤§èˆ‡æ‰‹å‹¢ç¸®æ”¾
    (function preventZoom(){
      let last=0;
      document.addEventListener("touchend", (e)=>{
        const now=Date.now(); if(now-last<=300){ e.preventDefault(); } last=now;
      }, {passive:false});
      ["gesturestart","gesturechange","gestureend"].forEach(evt=>{
        document.addEventListener(evt, e=>e.preventDefault());
      });
    })();
  </script>
</body>
</html>