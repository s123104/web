<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>è£ä¿®æ•™å­¸çŸ­è¦–é »</title>
  <style>
    /* åŸºæœ¬é‡ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
      color: #fff;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
      position: relative;
    }

    /* åˆ†é¡æŒ‰éˆ•å®¹å™¨ */
    .category-bar {
      position: fixed;
      top: 0; 
      left: 0; 
      right: 0;
      display: flex;
      align-items: center;
      overflow-x: scroll;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
      z-index: 999;
      padding: 0 10px;
      height: 50px;
      background: rgba(0,0,0,0.6);
    }
    .category {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 16px;
      margin: 0 4px;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      background: transparent;
      border-radius: 16px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .category.active {
      color: #fff;
      background: rgba(255,255,255,0.2);
      font-weight: 500;
    }

    /* å·¦å³æ»‘å‹•ç®­é ­æç¤º (è·³å‹•å‹•ç•«) */
    .slide-hint {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      padding: 6px 12px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 14px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
      animation: arrowBounce 1s infinite alternate ease-in-out;
      pointer-events: none;  /* ä¸å½±éŸ¿ä½¿ç”¨è€…æ“ä½œ */
    }
    .slide-hint i {
      font-size: 16px;
    }
    @keyframes arrowBounce {
      from { transform: translateX(0); }
      to   { transform: translateX(-6px); }
    }

    /* å½±ç‰‡ç®¡ç†æŒ‰éˆ• - å¾€ä¸‹ç§»ä¸€äº› */
    .video-manager-btn {
      position: fixed;
      bottom: 40px; /* å¾€ä¸‹ç§» */
      right: 16px;
      width: 44px;
      height: 44px;
      z-index: 3000;
      background: #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      user-select: none;
    }

    /* å½±ç‰‡å®¹å™¨ */
    .video-section {
      position: absolute;
      top: 50px; 
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }
    .video-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    .video-frame {
      width: 100%;
      height: 100%;
      background: #000;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* loading é®ç½© */
    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .loading-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* å½±ç‰‡è³‡è¨ŠåŠé€²åº¦æ¢ */
    .video-overlay {
      position: absolute;
      bottom: 0; 
      left: 0; 
      right: 0;
      padding: 16px;
      background: linear-gradient(transparent, rgba(0,0,0,0.6));
      z-index: 2;
    }
    .video-info {
      margin-bottom: 8px;
    }
    .video-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .video-description {
      font-size: 14px;
      line-height: 1.4;
      color: rgba(255,255,255,0.9);
    }
    .progress-bar {
      position: relative;
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.3);
      overflow: hidden;
    }
    .progress {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 0%;
      background: #fff;
      transition: width 0.1s linear;
    }

    /* é‡æ–°æ’­æ”¾æç¤ºå½ˆçª— */
    #replayModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #replayModal.active {
      display: flex;
    }
    #replayModal .modal-content {
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    #replayModal .modal-content button {
      margin: 0 8px;
      padding: 8px 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }

    /* ======== å½±ç‰‡ç®¡ç† Modal ======== */
    #videoManagerModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #videoManagerModal.active {
      display: flex;
    }
    .manager-content {
      background: #fff;
      color: #000;
      width: 90%;
      max-width: 600px;
      max-height: 80%;
      overflow: auto;
      border-radius: 8px;
      padding: 16px;
      position: relative;
    }
    .manager-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .manager-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .manager-close {
      cursor: pointer;
      background: #ccc;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
    }
    .video-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    .video-form label {
      font-size: 14px;
      font-weight: 500;
    }
    .video-form input, .video-form select {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .video-form button {
      padding: 8px;
      border: none;
      background: #3498db;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .video-list {
      margin-top: 8px;
      border-top: 1px solid #ddd;
      padding-top: 8px;
    }
    .video-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 8px;
      background: #f2f2f2;
      border-radius: 4px;
    }
    .video-item span {
      flex: 1;
      padding-right: 8px;
    }
    .edit-btn, .del-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 4px;
      font-size: 12px;
    }
    .edit-btn { background: #ffa500; color: #fff; }
    .del-btn { background: #e74c3c; color: #fff; }

    /* åŒ¯å‡ºæŒ‰éˆ• */
    .export-btn {
      margin-top: 8px;
      padding: 6px 12px;
      border: none;
      background: #2ecc71;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    /* ======= åˆ†é¡ç®¡ç†å€ ======= */
    .category-manage-section {
      margin-top: 16px;
      border-top: 1px solid #ddd;
      padding-top: 8px;
    }
    .cat-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .cat-form input {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .cat-list .cat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      border-radius: 4px;
      background: #f7f7f7;
      margin-bottom: 4px;
    }
    .cat-list .cat-del-btn {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
    }

    /* ä¸Šä¸‹æ»‘å‹•æç¤º - è·³å‹•å‹•ç•« */
    .upDown-hint {
      position: fixed;
      bottom: 120px; /* è·é›¢åº•éƒ¨å†å¾€ä¸Šé»ï¼Œé¿å…è“‹åˆ°é€²åº¦æ¢æˆ–ç®¡ç†æŒ‰éˆ• */
      left: 50%;
      transform: translateX(-50%);
      z-index: 1500;
      padding: 6px 12px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 14px;
      border-radius: 20px;
      display: none; /* åˆå§‹éš±è— */
      align-items: center;
      gap: 6px;
      pointer-events: none;
      animation: arrowUpDown 1s infinite alternate ease-in-out;
    }
    .upDown-hint i {
      font-size: 16px;
    }
    @keyframes arrowUpDown {
      from { transform: translate(-50%, 0); }
      to   { transform: translate(-50%, -6px); }
    }
  </style>

  <!-- fontawesome CDNï¼Œç”¨ä¾†é¡¯ç¤ºç®­é ­åœ–ç¤º -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- å·¦å³æ»‘å‹•æç¤º(ç®­é ­) -->
  <div class="slide-hint" id="slideHint">
    <i class="fa-solid fa-arrow-left-right"></i> 
    <span>æ»‘å‹•</span>
  </div>
  <!-- ä¸Šä¸‹æ»‘å‹•æç¤º(ç®­é ­) -->
  <div class="upDown-hint" id="upDownHint">
    <i class="fa-solid fa-arrow-up-down"></i>
    <span>ä¸Šä¸‹</span>
  </div>

  <!-- åˆ†é¡æŒ‰éˆ•åˆ— -->
  <div class="category-bar" id="categoryBar"></div>
  <!-- å½±ç‰‡ç®¡ç†æŒ‰éˆ• -->
  <div class="video-manager-btn" id="videoManagerBtn">ğŸ¥</div>

  <!-- å½±ç‰‡å®¹å™¨ -->
  <div class="video-section">
    <div class="video-container">
      <div class="video-frame" id="player"></div>
      <div class="video-overlay">
        <div class="video-info">
          <h2 class="video-title" id="videoTitle"></h2>
          <p class="video-description" id="videoDesc"></p>
        </div>
        <div class="progress-bar">
          <div class="progress" id="videoProgress"></div>
        </div>
      </div>
      <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>

  <!-- å…¨éƒ¨æ’­æ”¾å®Œç•¢å¾Œï¼Œæ˜¯å¦é‡æ–°æ’­æ”¾çš„å½ˆçª— -->
  <div id="replayModal">
    <div class="modal-content">
      <p>æ‚¨å·²ç¶“çœ‹éæ‰€æœ‰å½±ç‰‡ï¼Œæ˜¯å¦é‡æ–°è§€çœ‹ï¼Ÿ</p>
      <button id="replayYes">æ˜¯</button>
      <button id="replayNo">å¦</button>
    </div>
  </div>

  <!-- å½±ç‰‡ç®¡ç† Modal (æ–°å¢ / ç·¨è¼¯ / åˆªé™¤ / åŒ¯å‡º + åˆ†é¡ç®¡ç†) -->
  <div id="videoManagerModal">
    <div class="manager-content">
      <div class="manager-header">
        <h2>å½±ç‰‡ç®¡ç†</h2>
        <button class="manager-close" id="managerCloseBtn">é—œé–‰</button>
      </div>

      <!-- æ–°å¢ / ç·¨è¼¯ è¡¨å–® -->
      <form class="video-form" id="videoForm">
        <label for="videoLink">å½±ç‰‡é€£çµæˆ– ID</label>
        <input type="text" id="videoLink" placeholder="e.g. https://youtu.be/xxxx æˆ–ç›´æ¥è¼¸å…¥ID" />

        <label for="videoTitleInput">å½±ç‰‡æ¨™é¡Œ</label>
        <input type="text" id="videoTitleInput" placeholder="è«‹è¼¸å…¥å½±ç‰‡æ¨™é¡Œ" />

        <label for="videoCategory">é¸æ“‡åˆ†é¡</label>
        <select id="videoCategory">
          <!-- å‹•æ…‹æ’å…¥ allCategories -->
        </select>

        <button type="submit" id="addOrEditBtn">æ–°å¢å½±ç‰‡</button>
      </form>

      <!-- ä½¿ç”¨è€…è‡ªè¨‚å½±ç‰‡åˆ—è¡¨ -->
      <div class="video-list" id="videoList"></div>

      <!-- åŒ¯å‡ºæŒ‰éˆ• -->
      <button class="export-btn" id="exportBtn">åŒ¯å‡ºå…¨éƒ¨å½±ç‰‡æ–‡å­—</button>

      <!-- åˆ†é¡ç®¡ç†å€ -->
      <div class="category-manage-section">
        <h3>åˆ†é¡ç®¡ç†</h3>
        <form class="cat-form" id="catForm">
          <input type="text" id="catNameInput" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±" />
          <button type="submit" id="catAddBtn">æ–°å¢åˆ†é¡</button>
        </form>
        <div class="cat-list" id="catList"></div>
      </div>
    </div>
  </div>

  <script>
   // ============ é…ç½®å€ ============
    // é€™è£¡æ”¾ä¸€äº›ã€Œä¸çµ¦çœ‹ã€æˆ–æ˜¯ç›´æ¥æ›æ‰çš„å½±ç‰‡ ID
    const bannedVideoIds = ["é­¯ç­å°ºURL", "someBannedId1", "someBannedId2"];

    // å…§å»ºé è¨­å½±ç‰‡
    const defaultVideos = [
      // åˆ†é¡ï¼šå·¥å…·æ“ä½œ
      { id: '4eWtbt1DsLU', title: 'è¶³å¹¾åˆ†æ¿æ˜¯ä»€éº¼ï¼Ÿé€™å½±ç‰‡å‘Šè¨´ä½ ï¼', description: '', category: 'å·¥å…·æ“ä½œ' },
      { id: 'rAuk2qK-BRY', title: 'é‡˜æ§ä¸åªå¸¥ï¼Œé‚„è¶…å¥½ç”¨ï¼', description: '', category: 'å·¥å…·æ“ä½œ' },
      { id: '9Es8VaMrGPE', title: 'å¹³åœŸå™¨åˆ°åº•åœ¨å¹³å•¥ï¼Ÿç­”æ¡ˆåœ¨é€™ï¼', description: '', category: 'å·¥å…·æ“ä½œ' },
      { id: 'vhE16_8eh9g', title: 'å·å°ºä¹Ÿæœ‰çœ‰è§’ï¼Ÿå­¸èµ·ä¾†åˆ¥ä¸Ÿè‡‰ï¼', description: '', category: 'å·¥å…·æ“ä½œ' },
      { id: '8y5Uulpld2k', title: 'ä½ çŸ¥é“æ–‡å…¬å°ºçš„è¦å¾‹å—ï¼Ÿ çœ‹å®ŒåŒ…å­¸æœƒï¼', description: '', category: 'å·¥å…·æ“ä½œ' },
      { id: 'kzZ4wXOpRw4', title: 'æ³¥ä½œå·¥å…·å¤ªå¤šï¼Ÿé€™è£¡å¹«ä½ ææ‡‚ï¼', description: '', category: 'å·¥å…·æ“ä½œ' },
      { id: 'hy6KP-TJvyM', title: 'å·¥å…·è¡“èªå¤ªè¤‡é›œï¼Ÿä¸€çœ‹å°±ç§’æ‡‚ï¼', description: '', category: 'å·¥å…·æ“ä½œ' },
      // åˆ†é¡ï¼šå»ºæé¸æ“‡
      { id: 'ZTtns0-nIcQ', title: 'å¤¾æ¿åšåº¦æ€éº¼æŒ‘ï¼Ÿåˆ¥è¢«è€é—†å”¬çˆ›ï¼', description: '', category: 'å»ºæé¸æ“‡' },
      { id: 'YealWFoQUgs', title: 'é‘¿é¢åˆ‡ç£šé€™éº¼ç°¡å–®ï¼Ÿçœ‹å®Œç§’æœƒï¼', description: '', category: 'å»ºæé¸æ“‡' },
      { id: 'RyxE_6DPcGM', title: 'æ‰‹æä¿®é‚Šæ©Ÿè¶…ç¥ï¼ä¸ç”¨å·¥å…·äººä¹Ÿèƒ½ä¸Šæ‰‹ï¼', description: '', category: 'å»ºæé¸æ“‡' },
      { id: 'ZzP_sk4tefU', title: 'ç´…ç£šç‰†å¾ˆè®šï¼Ÿç¼ºé»ä½ ææ¸…æ¥šæ²’ï¼Ÿ', description: '', category: 'å»ºæé¸æ“‡' },
      // åˆ†é¡ï¼šæ–½å·¥ç´°ç¯€
      { id: 'F7xVuDDCCzc', title: 'åŒ–ç³æ± è™é‚Šæ”¾ï¼Ÿé€™æ˜¯è£ä¿®äººçš„å°æ’‡æ­¥ï¼', description: '', category: 'æ–½å·¥ç´°ç¯€' },
      { id: '7x383cfXMzQ', title: 'æœ¨ä½œéš”é–“è¶…ç°¡å–®ï¼Œä¸Šé›†', description: '', category: 'æ–½å·¥ç´°ç¯€' },
      { id: 'kdl7ade-xSA', title: 'æœ¨ä½œéš”é–“è¶…ç°¡å–®ï¼Œä¸‹é›†', description: '', category: 'æ–½å·¥ç´°ç¯€' },
      { id: 'XhwjdtcFcao', title: 'é˜²ç«å¡«å¡é€™éº¼çŒ›ï¼ç”¨å°ææ–™è¶…å®‰å¿ƒï¼', description: '', category: 'æ–½å·¥ç´°ç¯€' },
      { id: 'YqvhJnB-thE', title: 'é˜²ç«é–€è©²æ€éº¼é¸ï¼Ÿå½±ç‰‡è£¡æ•™ä½ å¥—è·¯ï¼', description: '', category: 'æ–½å·¥ç´°ç¯€' },
      { id: 'WTYfoTwF16s', title: 'æµ´å®¤è£ä¿®å°ç´°ç¯€ï¼Œæ²’æ³¨æ„å°±GGå•¦ï¼', description: '', category: 'æ–½å·¥ç´°ç¯€' },
      // åˆ†é¡ï¼šä¿®å¾©ä¿é¤Š
      { id: '4YB2_9_TnM8', title: 'ç£ç£šç©ºè‚¡ä¿®å¾©è¡“ï¼ŒçœéŒ¢åˆå¥½ç”¨ï¼', description: '', category: 'ä¿®å¾©ä¿é¤Š' },
      { id: 'fiWYdCzt5C4', title: 'è€å±‹å£ç™Œï¼Ÿæ•™ä½ ä¸€æ‹›å¾¹åº•è§£æ±ºï¼', description: '', category: 'ä¿®å¾©ä¿é¤Š' },
      // åˆ†é¡ï¼šç¾è§€æ”¶å°¾
      { id: 'kc2Y1QcQo8Y', title: 'å®¶ä¸­æ²¹æ¼†é¡è‰²æ€éº¼æŒ‘ï¼Ÿåˆ¥è¢«è€å©†ç½µçˆ†ï¼', description: '', category: 'ç¾è§€æ”¶å°¾' },
      { id: '73Zh6fl4swg', title: 'ç‡ˆå…·é¸å¾—å¥½ï¼Œå®¶è£¡ä¸€ç§’é«˜ç´šåŒ–ï¼', description: '', category: 'ç¾è§€æ”¶å°¾' },
      { id: 'py8hlbc3AOs', title: 'ç‡ˆæ³¡æ€éº¼é¸ï¼Ÿåˆ¥è£å®Œæ‰å‚»çœ¼ï¼', description: '', category: 'ç¾è§€æ”¶å°¾' },
      // åˆ†é¡ï¼šå°ˆæ¥­è¡“èª
      { id: 'eC52Ms4yUUQ', title: 'æ¡ˆå ´è¡“èªå¤§å…¬é–‹ï¼é€™äº›è©åˆ¥è£ä¸æ‡‚ï¼', description: '', category: 'å°ˆæ¥­è¡“èª' },
      // åˆ†é¡ï¼šç‰¹æ®Šæ–½å·¥
      { id: 'JDZxq_QDiT0', title: 'ç¾è€æ¿æ€éº¼è²¼æ‰ç‰¢ï¼Ÿé€™è£¡æœ‰ç§˜è¨£ï¼ä¸Šé›†', description: '', category: 'ç‰¹æ®Šæ–½å·¥' },
      { id: 'KovKnsBF7Ic', title: 'ç¾è€æ¿æ€éº¼è²¼æ‰ç‰¢ï¼Ÿé€™è£¡æœ‰ç§˜è¨£ï¼ä¸‹é›†', description: '', category: 'ç‰¹æ®Šæ–½å·¥' },
      { id: 'VotM_pXBV2Q', title: 'æ··å‡åœŸæŒ¯å‹•å™¨å¥½çŒ›ï¼è®“çµæ§‹æ›´æ‰å¯¦ï¼', description: '', category: 'ç‰¹æ®Šæ–½å·¥' }
    ];

    // å…§å»ºé è¨­åˆ†é¡
    const builtInCategories = [
      'å·¥å…·æ“ä½œ',
      'å»ºæé¸æ“‡',
      'æ–½å·¥ç´°ç¯€',
      'ä¿®å¾©ä¿é¤Š',
      'ç¾è§€æ”¶å°¾',
      'å°ˆæ¥­è¡“èª',
      'ç‰¹æ®Šæ–½å·¥'
    ];

    let allVideos = [];
    let allCategories = [];
    let validVideos = [];
    let currentCategoryIndex = 0;  // é è¨­ç¬¬ä¸€å€‹åˆ†é¡
    let currentVideoIndex = 0;
    let filteredVideos = [];
    let player;
    let isTransitioning = false;

    document.addEventListener('DOMContentLoaded', () => {
      loadAllDataFromLocal();
      filterOutBannedVideos();
      createCategoryButtons();
      initCategory(0);
      initYouTubePlayer();
      initVideoManagerUI();
    });

    // è®€å– + çµ„åˆè³‡æ–™
    function loadAllDataFromLocal() {
      const userVideosStr = localStorage.getItem('userVideos');
      let userVideos = [];
      if (userVideosStr) {
        try { userVideos = JSON.parse(userVideosStr); } catch(e){}
      }
      const userCatsStr = localStorage.getItem('userCategories');
      let userCats = [];
      if (userCatsStr) {
        try { userCats = JSON.parse(userCatsStr); } catch(e){}
      }
      allCategories = Array.from(new Set([...builtInCategories, ...userCats]));
      allVideos = [...defaultVideos, ...userVideos];
    }
    function saveUserVideosToLocal(vids) {
      localStorage.setItem('userVideos', JSON.stringify(vids));
    }
    function saveUserCategoriesToLocal(cats) {
      localStorage.setItem('userCategories', JSON.stringify(cats));
    }

    function filterOutBannedVideos() {
      validVideos = allVideos.filter(v => !bannedVideoIds.includes(v.id));
    }

    function createCategoryButtons() {
      const catBar = document.getElementById('categoryBar');
      catBar.innerHTML = '';
      allCategories.forEach((catName, idx) => {
        const catBtn = document.createElement('div');
        catBtn.classList.add('category');
        catBtn.textContent = catName;
        if (idx===0) catBtn.classList.add('active');
        catBtn.onclick = () => {
          document.querySelectorAll('.category').forEach(el=>el.classList.remove('active'));
          catBtn.classList.add('active');
          initCategory(idx);
        };
        catBar.appendChild(catBtn);
      });
    }
    function initCategory(catIndex) {
      currentCategoryIndex = catIndex;
      const targetCat = allCategories[currentCategoryIndex];
      filteredVideos = validVideos.filter(v => v.category === targetCat);
      currentVideoIndex = 0;
      // å¦‚æœå·²ç¶“æœ‰ playerï¼Œä¸”æœ‰å½±ç‰‡ï¼Œå°±load
      if(filteredVideos.length>0 && player) {
        loadVideo(filteredVideos[currentVideoIndex].id);
        updateVideoInfo();
      } else if(player && player.stopVideo){
        player.stopVideo();
        document.getElementById('videoTitle').textContent='';
        document.getElementById('videoDesc').textContent='';
      }
    }

    // YouTube
    function initYouTubePlayer() {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      window.onYouTubeIframeAPIReady = function(){
        player = new YT.Player('player', {
          height:'100%',width:'100%',
          videoId: filteredVideos[0]? filteredVideos[0].id : '',
          playerVars:{
            autoplay:1,controls:0,modestbranding:1,
            playsinline:1,rel:0,showinfo:0,loop:0,mute:0,vq:'hd1080'
          },
          events:{
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      };
    }
    function onPlayerReady(e){
      e.target.playVideo();
      // ä¸€é–‹å§‹å°±é¡¯ç¤ºç¬¬ä¸€éƒ¨å½±ç‰‡æ¨™é¡Œ
      if(filteredVideos.length > 0) {
        updateVideoInfo(); 
      }
      startProgressMonitor();

      // ç­‰2ç§’æª¢æŸ¥å½±ç‰‡æ˜¯å¦ç„¡æ•ˆ
      setTimeout(()=>{
        const duration = player.getDuration();
        if(duration<=0 && filteredVideos[currentVideoIndex]){
          markVideoAsWatched(filteredVideos[currentVideoIndex].id);
          playNextVideo();
        }
      },2000);

      // åˆå§‹åŒ–å·¦å³æ»‘å‹•æç¤º
      initScrollHint();
      // åˆå§‹åŒ–ä¸Šä¸‹æ»‘å‹•æç¤º
      showUpDownHint();
    }
    function onPlayerStateChange(e){
      if(e.data === YT.PlayerState.ENDED){
        markVideoAsWatched(filteredVideos[currentVideoIndex].id);
        playNextVideo();
      } else if(e.data === YT.PlayerState.PLAYING){
        hideLoading();
      } else if(e.data === YT.PlayerState.BUFFERING){
        showLoading();
      }
    }

    // æ’­æ”¾æ§åˆ¶
    function loadVideo(vidId){
      if(player && player.loadVideoById && vidId){
        showLoading();
        player.loadVideoById(vidId);
        updateVideoInfo();
      }
    }
    function playNextVideo(){
      if(isTransitioning) return;
      isTransitioning=true;
      while(currentVideoIndex<filteredVideos.length-1 && hasWatched(filteredVideos[currentVideoIndex+1].id)){
        currentVideoIndex++;
      }
      if(currentVideoIndex<filteredVideos.length-1){
        currentVideoIndex++;
        loadVideo(filteredVideos[currentVideoIndex].id);
      } else {
        if(currentCategoryIndex<allCategories.length-1){
          initCategory(++currentCategoryIndex);
          document.querySelectorAll('.category').forEach(el=>el.classList.remove('active'));
          document.querySelectorAll('.category')[currentCategoryIndex].classList.add('active');
        } else {
          showReplayModal();
        }
      }
      setTimeout(()=>{ isTransitioning=false; },300);
    }
    function playPreviousVideo(){
      if(isTransitioning||currentVideoIndex<=0) return;
      isTransitioning=true;
      currentVideoIndex--;
      loadVideo(filteredVideos[currentVideoIndex].id);
      setTimeout(()=>{ isTransitioning=false; },300);
    }

    // Watched
    function hasWatched(vidId){
      const watched = JSON.parse(localStorage.getItem('watchedVideos')||'[]');
      return watched.includes(vidId);
    }
    function markVideoAsWatched(vidId){
      let watched=JSON.parse(localStorage.getItem('watchedVideos')||'[]');
      if(!watched.includes(vidId)){
        watched.push(vidId);
        localStorage.setItem('watchedVideos',JSON.stringify(watched));
      }
    }
    function resetWatchedVideos(){
      localStorage.removeItem('watchedVideos');
    }

    function showReplayModal(){
      const replayModal=document.getElementById('replayModal');
      replayModal.classList.add('active');
      document.getElementById('replayYes').onclick=()=>{
        replayModal.classList.remove('active');
        resetWatchedVideos();
        currentCategoryIndex=0;
        currentVideoIndex=0;
        initCategory(currentCategoryIndex);
        document.querySelectorAll('.category').forEach(el=>el.classList.remove('active'));
        document.querySelectorAll('.category')[0].classList.add('active');
      };
      document.getElementById('replayNo').onclick=()=>{
        replayModal.classList.remove('active');
      };
    }

    // UI & é€²åº¦æ¢
    function updateVideoInfo(){
      const t=document.getElementById('videoTitle');
      const d=document.getElementById('videoDesc');
      if(filteredVideos[currentVideoIndex]){
        t.textContent = filteredVideos[currentVideoIndex].title || 'ç„¡æ¨™é¡Œ';
        d.textContent = filteredVideos[currentVideoIndex].description || '';
      } else {
        t.textContent='';
        d.textContent='';
      }
    }
    function showLoading(){
      document.getElementById('loadingOverlay').classList.add('active');
    }
    function hideLoading(){
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    function startProgressMonitor(){
      const bar=document.getElementById('videoProgress');
      function update(){
        if(player && player.getPlayerState()===YT.PlayerState.PLAYING){
          const ct=player.getCurrentTime();
          const du=player.getDuration();
          if(du>0){
            const per=(ct/du)*100;
            bar.style.width=per+'%';
          }
        }
        requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    }

    // æ‰‹å‹¢(ä¸Šä¸‹æ»‘åˆ‡å½±ç‰‡)
    let startY=0, startTime=0;
    document.body.addEventListener('touchstart', e=>{
      startY=e.touches[0].clientY;
      startTime=Date.now();
    }, {passive:true});
    document.body.addEventListener('touchend', e=>{
      const deltaY=e.changedTouches[0].clientY - startY;
      const deltaTime=Date.now()-startTime;
      if(Math.abs(deltaY)>50 && deltaTime<500){
        if(deltaY<0){
          playNextVideo();
        } else {
          playPreviousVideo();
        }
      }
    }, {passive:true});

    // å·¦å³æ»‘å‹•æç¤º
    function initScrollHint(){
      const catBar=document.getElementById('categoryBar');
      const slideHint=document.getElementById('slideHint');
      let hideTimer;
      function checkOverflow(){
        const overflow=catBar.scrollWidth>catBar.clientWidth;
        if(overflow){
          slideHint.style.display='flex';
          if(hideTimer) clearTimeout(hideTimer);
          hideTimer=setTimeout(()=>{ slideHint.style.display='none'; },3000);
        }
      }
      catBar.addEventListener('scroll',()=>{
        if(hideTimer) clearTimeout(hideTimer);
        hideTimer=setTimeout(()=>{
          slideHint.style.display='none';
        },3000);
      });
      setTimeout(checkOverflow,200);
    }

    // ä¸Šä¸‹æ»‘å‹•æç¤º
    function showUpDownHint(){
      const upDownHint=document.getElementById('upDownHint');
      // é¡¯ç¤ºä¸Šä¸‹æç¤º3ç§’
      upDownHint.style.display='flex';
      setTimeout(()=>{
        upDownHint.style.display='none';
      },3000);
    }

    // å½±ç‰‡ç®¡ç†
    function initVideoManagerUI(){
      const managerBtn=document.getElementById('videoManagerBtn');
      const managerModal=document.getElementById('videoManagerModal');
      const managerCloseBtn=document.getElementById('managerCloseBtn');
      const videoForm=document.getElementById('videoForm');
      const catForm=document.getElementById('catForm');
      const catNameInput=document.getElementById('catNameInput');
      const catList=document.getElementById('catList');
      const videoList=document.getElementById('videoList');
      const addOrEditBtn=document.getElementById('addOrEditBtn');
      const exportBtn=document.getElementById('exportBtn');
      const videoCategorySelect=document.getElementById('videoCategory');
      let editIndex=null;

      managerBtn.onclick=()=>{
        refreshVideoList();
        refreshCatList();
        refreshVideoFormCategories();
        managerModal.classList.add('active');
        editIndex=null;
        addOrEditBtn.textContent='æ–°å¢å½±ç‰‡';
        videoForm.reset();
      };
      managerCloseBtn.onclick=()=>{
        managerModal.classList.remove('active');
      };

      videoForm.onsubmit=(e)=>{
        e.preventDefault();
        const linkValue=document.getElementById('videoLink').value.trim();
        const titleValue=document.getElementById('videoTitleInput').value.trim();
        const catValue=videoCategorySelect.value;
        if(!linkValue||!titleValue){
          alert('é€£çµ/ID èˆ‡æ¨™é¡Œéƒ½ä¸å¯ç©ºç™½');
          return;
        }
        const parsedId=parseYouTubeId(linkValue);
        if(!parsedId){
          alert('ç„¡æ³•è§£ææ­¤é€£çµæˆ–ID');
          return;
        }
        let userVideos=getUserVideos();
        if(editIndex===null){
          // æ–°å¢
          userVideos.push({ id:parsedId, title:titleValue, description:'', category:catValue });
        } else {
          // ç·¨è¼¯
          userVideos[editIndex].id=parsedId;
          userVideos[editIndex].title=titleValue;
          userVideos[editIndex].category=catValue;
        }
        saveUserVideosToLocal(userVideos);
        reloadAllData();
        videoForm.reset();
        editIndex=null;
        addOrEditBtn.textContent='æ–°å¢å½±ç‰‡';
      };
      exportBtn.onclick=()=>{
        const exportText=generateExportText();
        const blob=new Blob([exportText], { type:'text/plain;charset=utf-8' });
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='all_videos.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('å·²åŒ¯å‡ºå…¨éƒ¨å½±ç‰‡æ–‡å­—ï¼');
      };
      catForm.onsubmit=(e)=>{
        e.preventDefault();
        const newCat=catNameInput.value.trim();
        if(!newCat){
          alert('åˆ†é¡åç¨±ä¸å¯ç©ºç™½');
          return;
        }
        let userCats=getUserCategories();
        if(!userCats.includes(newCat) && !builtInCategories.includes(newCat)){
          userCats.push(newCat);
        }
        saveUserCategoriesToLocal(userCats);
        catNameInput.value='';
        reloadAllData();
      };

      function refreshVideoList(){
        videoList.innerHTML='';
        const userVideos=getUserVideos();
        if(userVideos.length===0){
          videoList.innerHTML='<p style="text-align:center;">ï¼ˆå°šç„¡è‡ªè¨‚å½±ç‰‡ï¼‰</p>';
          return;
        }
        userVideos.forEach((v,i)=>{
          const div=document.createElement('div');
          div.classList.add('video-item');
          div.innerHTML=`
            <span>[${v.category}] ${v.title} (${v.id})</span>
            <div>
              <button class="edit-btn">ç·¨è¼¯</button>
              <button class="del-btn">åˆªé™¤</button>
            </div>
          `;
          const editBtn=div.querySelector('.edit-btn');
          const delBtn=div.querySelector('.del-btn');
          editBtn.onclick=()=>{
            editIndex=i;
            document.getElementById('videoLink').value=v.id;
            document.getElementById('videoTitleInput').value=v.title;
            videoCategorySelect.value=v.category;
            addOrEditBtn.textContent='å„²å­˜è®Šæ›´';
          };
          delBtn.onclick=()=>{
            if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${v.title}ã€å—ï¼Ÿ`)){
              userVideos.splice(i,1);
              saveUserVideosToLocal(userVideos);
              reloadAllData();
            }
          };
          videoList.appendChild(div);
        });
      }
      function refreshVideoFormCategories(){
        videoCategorySelect.innerHTML='';
        allCategories.forEach(cat=>{
          const opt=document.createElement('option');
          opt.value=cat;
          opt.textContent=cat;
          videoCategorySelect.appendChild(opt);
        });
      }
      function refreshCatList(){
        catList.innerHTML='';
        const userCats=getUserCategories();
        if(userCats.length===0){
          catList.innerHTML='<p style="text-align:center;">ï¼ˆå°šç„¡è‡ªè¨‚åˆ†é¡ï¼‰</p>';
          return;
        }
        userCats.forEach((c,idx)=>{
          const div=document.createElement('div');
          div.classList.add('cat-item');
          div.innerHTML=`
            <span>${c}</span>
            <button class="cat-del-btn">åˆªé™¤</button>
          `;
          const delBtn=div.querySelector('.cat-del-btn');
          delBtn.onclick=()=>{
            if(confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Œ${c}ã€å—ï¼Ÿ`)){
              userCats.splice(idx,1);
              saveUserCategoriesToLocal(userCats);
              reloadAllData();
            }
          };
          catList.appendChild(div);
        });
      }
      function reloadAllData(){
        loadAllDataFromLocal();
        filterOutBannedVideos();
        createCategoryButtons();
        initCategory(0);
        refreshVideoList();
        refreshCatList();
        refreshVideoFormCategories();
      }
    }

    // åŒ¯å‡ºæ–‡å­—
    function generateExportText(){
      let text='=== æ‰€æœ‰å½±ç‰‡æ¸…å–® (UTF-8) ===\n\n';
      const grouped={};
      allVideos.forEach(v=>{
        if(!grouped[v.category]) grouped[v.category]=[];
        grouped[v.category].push(v);
      });
      allCategories.forEach(cat=>{
        if(grouped[cat] && grouped[cat].length>0){
          text+=`ã€${cat}ã€‘\n`;
          grouped[cat].forEach((vid,idx)=>{
            const url=`https://youtu.be/${encodeURIComponent(vid.id)}`;
            text+=`  ${idx+1}. ${vid.title} (URL: ${url})\n`;
          });
          text+='\n';
        }
      });
      return text;
    }

    // å·¥å…·å‡½å¼
    function parseYouTubeId(input){
      if(/^[a-zA-Z0-9_-]{11,}$/.test(input)){
        return input;
      }
      const regShort=/youtu\.be\/([^?]+)/;
      const matchShort=input.match(regShort);
      if(matchShort&&matchShort[1]) return matchShort[1];
      const regLong=/v=([^&]+)/;
      const matchLong=input.match(regLong);
      if(matchLong&&matchLong[1]) return matchLong[1];
      return null;
    }
    function getUserVideos(){
      const str=localStorage.getItem('userVideos');
      let arr=[];
      if(str){
        try{arr=JSON.parse(str);}catch(e){}
      }
      return arr;
    }
    function getUserCategories(){
      const str=localStorage.getItem('userCategories');
      let arr=[];
      if(str){
        try{arr=JSON.parse(str);}catch(e){}
      }
      return arr;
    }
  </script>
</body>
</html>
