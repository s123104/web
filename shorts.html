<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>裝修教學短影音</title>
    <style>
      /* 基本重置 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #000;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Microsoft JhengHei", sans-serif;
        color: #fff;
        -webkit-user-select: none;
        user-select: none;
        touch-action: manipulation;
        position: relative;
      }

      /* 分類按鈕容器 */
      .category-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
        z-index: 999;
        padding: 0 10px;
        height: 50px;
        background: rgba(0, 0, 0, 0.6);
      }
      .category {
        flex: 0 0 auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 16px;
        margin: 0 4px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        background: transparent;
        border-radius: 16px;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }
      .category.active {
        color: #fff;
        background: rgba(255, 255, 255, 0.2);
        font-weight: 500;
      }

      /* 左右滑動箭頭提示 (跳動動畫) */
      .slide-hint {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        padding: 6px 12px;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        font-size: 14px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 6px;
        animation: arrowBounce 1s infinite alternate ease-in-out;
        pointer-events: none;
      }
      .slide-hint i {
        font-size: 16px;
      }
      @keyframes arrowBounce {
        from {
          transform: translateX(0);
        }
        to {
          transform: translateX(-6px);
        }
      }

      /* 影片容器 */
      .video-section {
        position: absolute;
        top: 50px;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
      }
      .video-container {
        width: 100%;
        height: 100%;
        position: relative;
      }
      .video-frame {
        width: 100%;
        height: 100%;
        background: #000;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      /* loading 遮罩 */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .loading-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* 影片資訊及進度條 + 影片管理按鈕 */
      .video-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.6));
        z-index: 2;
      }
      .video-info {
        margin-bottom: 8px;
        position: relative;
      }
      .video-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        padding-right: 40px; /* 預留空間給管理按鈕 */
      }
      .video-description {
        font-size: 14px;
        line-height: 1.4;
        color: rgba(255, 255, 255, 0.9);
      }
      .progress-bar {
        position: relative;
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        overflow: hidden;
      }
      .progress {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0%;
        background: #fff;
        transition: width 0.1s linear;
      }

      /* 影片管理按鈕 - 縮小放在標題同一行 */
      .video-manager-btn {
        position: absolute;
        top: 0;
        right: 0;
        transform: translate(-8px, -8px);
        width: 30px;
        height: 30px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        user-select: none;
        z-index: 3;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        transition: background 0.3s ease, box-shadow 0.3s ease,
          transform 0.2s ease;
      }

      .video-manager-btn:hover {
        background: rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
      }

      .video-manager-btn:active {
        transform: translate(-8px, -8px) scale(0.9);
      }

      .video-manager-btn img {
        width: 60%;
        height: 60%;
        object-fit: contain;
        filter: invert(1); /* 將黑色 icon 反轉成白色 */
      }

      /* 重新播放提示彈窗 */
      #replayModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      #replayModal.active {
        display: flex;
      }
      #replayModal .modal-content {
        background: #fff;
        color: #000;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      #replayModal .modal-content button {
        margin: 0 8px;
        padding: 8px 16px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
      }

      /* ======== 影片管理 Modal ======== */
      #videoManagerModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      #videoManagerModal.active {
        display: flex;
      }
      .manager-content {
        background: #fff;
        color: #000;
        width: 90%;
        max-width: 600px;
        max-height: 80%;
        overflow: auto;
        border-radius: 8px;
        padding: 16px;
        position: relative;
      }
      .manager-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      .manager-header h2 {
        margin: 0;
        font-size: 20px;
      }
      .manager-close {
        cursor: pointer;
        background: #ccc;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 14px;
      }
      .video-form {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
      }
      .video-form label {
        font-size: 14px;
        font-weight: 500;
      }
      .video-form input,
      .video-form select {
        padding: 6px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .video-form button {
        padding: 8px;
        border: none;
        background: #3498db;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
      }
      .video-list {
        margin-top: 8px;
        border-top: 1px solid #ddd;
        padding-top: 8px;
      }
      .video-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 8px;
        background: #f2f2f2;
        border-radius: 4px;
      }
      .video-item span {
        flex: 1;
        padding-right: 8px;
      }
      .edit-btn,
      .del-btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 4px;
        font-size: 12px;
      }
      .edit-btn {
        background: #ffa500;
        color: #fff;
      }
      .del-btn {
        background: #e74c3c;
        color: #fff;
      }

      /* 匯出按鈕 */
      .export-btn {
        margin-top: 8px;
        padding: 6px 12px;
        border: none;
        background: #2ecc71;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
      }

      /* ======= 分類管理區 ======= */
      .category-manage-section {
        margin-top: 16px;
        border-top: 1px solid #ddd;
        padding-top: 8px;
      }
      .cat-form {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
      }
      .cat-form input {
        padding: 6px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .cat-list .cat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 8px;
        border-radius: 4px;
        background: #f7f7f7;
        margin-bottom: 4px;
      }
      .cat-list .cat-del-btn {
        background: #e74c3c;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 12px;
        cursor: pointer;
      }

      /* 上下滑動提示 - 放在稍微下面 */
      .upDown-hint {
        position: fixed;
        bottom: 60px; /* 調整這邊來控制上下位置 */
        left: 50%;
        transform: translateX(-50%);
        z-index: 1500;
        padding: 6px 12px;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        font-size: 14px;
        border-radius: 20px;
        display: none;
        align-items: center;
        gap: 6px;
        pointer-events: none;
        animation: arrowUpDown 1s infinite alternate ease-in-out;
      }
      .upDown-hint i {
        font-size: 16px;
      }
      @keyframes arrowUpDown {
        from {
          transform: translate(-50%, 0);
        }
        to {
          transform: translate(-50%, -6px);
        }
      }

      /* 確保匯出選項彈窗初始隱藏且層級高於其他元素 */
      #exportOptionsModal {
        display: none;
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translateX(-50%);
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        z-index: 4000;
      }

      /* 調整管理按鈕的層級，確保可點擊 */
      #videoManagerBtn {
        position: relative;
        z-index: 5000;
      }
    </style>
    <!-- fontawesome CDN，用來顯示箭頭圖示 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- 左右滑動提示(箭頭) -->
    <div class="slide-hint" id="slideHint">
      <i class="fa-solid fa-arrow-left-right"></i>
      <span>滑動</span>
    </div>
    <!-- 上下滑動提示(箭頭) -->
    <div class="upDown-hint" id="upDownHint">
      <i class="fa-solid fa-arrow-up-down"></i>
      <span>標題列上下滑動切換影片</span>
    </div>

    <!-- 分類按鈕列 -->
    <div class="category-bar" id="categoryBar"></div>

    <!-- 影片容器 -->
    <div class="video-section">
      <div class="video-container">
        <div class="video-frame" id="player"></div>
        <div class="video-overlay">
          <div class="video-info">
            <h2 class="video-title" id="videoTitle"></h2>
            <!-- 小小管理按鈕放到標題區右上角 -->
            <div class="video-manager-btn" id="videoManagerBtn">
              <img src="img/project.png" alt="影片管理" />
            </div>

            <p class="video-description" id="videoDesc"></p>
          </div>
          <div class="progress-bar">
            <div class="progress" id="videoProgress"></div>
          </div>
        </div>
        <div class="loading-overlay" id="loadingOverlay">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>

    <!-- 全部播放完畢後，是否重新播放的彈窗 -->
    <div id="replayModal">
      <div class="modal-content">
        <p>您已經看過所有影片，是否重新觀看？</p>
        <button id="replayYes">是</button>
        <button id="replayNo">否</button>
      </div>
    </div>

    <!-- 影片管理 Modal -->
    <div id="videoManagerModal">
      <div class="manager-content">
        <div class="manager-header">
          <h2>影片管理</h2>
          <button class="manager-close" id="managerCloseBtn">關閉</button>
        </div>

        <!-- 新增 / 編輯 表單 -->
        <form class="video-form" id="videoForm">
          <label for="videoLink">影片連結或 ID</label>
          <input
            type="text"
            id="videoLink"
            placeholder="e.g. https://youtu.be/xxxx 或直接輸入ID"
          />

          <label for="videoTitleInput">影片標題</label>
          <input
            type="text"
            id="videoTitleInput"
            placeholder="請輸入影片標題"
          />

          <label for="videoCategory">選擇分類</label>
          <select id="videoCategory">
            <!-- 動態插入 allCategories -->
          </select>

          <button type="submit" id="addOrEditBtn">新增影片</button>
        </form>

        <!-- 使用者自訂影片列表 -->
        <div class="video-list" id="videoList"></div>

        <!-- 匯出按鈕 -->
        <button class="export-btn" id="exportBtn">匯出全部影片文字</button>

        <!-- 分類管理區 -->
        <div class="category-manage-section">
          <h3>分類管理</h3>
          <form class="cat-form" id="catForm">
            <input type="text" id="catNameInput" placeholder="輸入新分類名稱" />
            <button type="submit" id="catAddBtn">新增分類</button>
          </form>
          <div class="cat-list" id="catList"></div>
        </div>
      </div>
    </div>

    <!-- 匯出格式選擇彈窗 -->
    <div id="exportOptionsModal">
      <h3>選擇匯出格式</h3>
      <button id="exportClipboardBtn">複製到剪貼簿</button>
      <button id="exportTxtBtn">下載 txt</button>
      <button id="exportCsvBtn">下載 CSV</button>
      <button id="exportCancelBtn">取消</button>
    </div>

    <script>
      // ============ 配置區 ============

      const bannedVideoIds = ["魯班尺URL", "someBannedId1", "someBannedId2"];
      const builtInCategories = [
        "工具操作",
        "建材選擇",
        "施工細節",
        "修復保養",
        "美觀收尾",
        "專業術語",
        "特殊施工",
      ];

      let allVideos = [];
      let allCategories = [];
      let validVideos = [];
      let currentCategoryIndex = 0;
      let currentVideoIndex = 0;
      let filteredVideos = [];
      let player;
      let isTransitioning = false;
      let currentPage = 1;
      const itemsPerPage = 5;

      document.addEventListener("DOMContentLoaded", () => {
        initializeData();
      });

      // 匯入預設影片 CSV 並初始化資料
      async function initializeData() {
        loadAllDataFromLocal();
        const csvVideos = await loadDefaultVideosFromCSV("videos.csv");
        allVideos = [...csvVideos, ...getUserVideos()];
        const userCats = getUserCategories();
        allCategories = Array.from(
          new Set([...builtInCategories, ...userCats])
        );
        filterOutBannedVideos();
        createCategoryButtons();
        initCategory(0);
        initYouTubePlayer();
        initVideoManagerUI();
      }

      // 讀取 CSV 並解析為影片資料陣列
      async function loadDefaultVideosFromCSV(csvPath) {
        const response = await fetch(csvPath);
        const csvText = await response.text();
        const lines = csvText
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line);

        const headers = lines
          .shift()
          .split(",")
          .map((h) => h.trim());
        const videos = [];

        lines.forEach((line) => {
          const cols = line.split(",").map((col) => col.trim());
          const record = {};
          headers.forEach((header, idx) => {
            record[header] = cols[idx] || "";
          });
          const videoId = parseYouTubeId(record.url);
          if (videoId) {
            videos.push({
              id: videoId,
              title: record.title,
              description: record.description || "",
              category: record.category,
            });
          }
        });

        return videos;
      }

      function loadAllDataFromLocal() {
        const userVideosStr = localStorage.getItem("userVideos");
        let userVideos = [];
        if (userVideosStr) {
          try {
            userVideos = JSON.parse(userVideosStr);
          } catch (e) {}
        }
        const userCatsStr = localStorage.getItem("userCategories");
        let userCats = [];
        if (userCatsStr) {
          try {
            userCats = JSON.parse(userCatsStr);
          } catch (e) {}
        }
        allCategories = Array.from(
          new Set([...builtInCategories, ...userCats])
        );
        // allVideos 之後在 initializeData 重新設定
      }

      function saveUserVideosToLocal(vids) {
        localStorage.setItem("userVideos", JSON.stringify(vids));
      }
      function saveUserCategoriesToLocal(cats) {
        localStorage.setItem("userCategories", JSON.stringify(cats));
      }

      function filterOutBannedVideos() {
        validVideos = allVideos.filter((v) => !bannedVideoIds.includes(v.id));
      }

      function createCategoryButtons() {
        const catBar = document.getElementById("categoryBar");
        catBar.innerHTML = "";
        allCategories.forEach((catName, idx) => {
          const catBtn = document.createElement("div");
          catBtn.classList.add("category");
          catBtn.textContent = catName;
          if (idx === 0) catBtn.classList.add("active");
          catBtn.onclick = () => {
            document
              .querySelectorAll(".category")
              .forEach((el) => el.classList.remove("active"));
            catBtn.classList.add("active");
            initCategory(idx);
          };
          catBar.appendChild(catBtn);
        });
      }

      function initCategory(catIndex) {
        currentCategoryIndex = catIndex;
        const targetCat = allCategories[currentCategoryIndex];
        filteredVideos = validVideos.filter((v) => v.category === targetCat);
        currentVideoIndex = 0;
        currentPage = 1;
        if (filteredVideos.length > 0 && player) {
          loadVideo(filteredVideos[currentVideoIndex].id);
          updateVideoInfo();
        } else if (player && player.stopVideo) {
          player.stopVideo();
          document.getElementById("videoTitle").textContent = "";
          document.getElementById("videoDesc").textContent = "";
        }
      }

      function initYouTubePlayer() {
        const tag = document.createElement("script");
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScript = document.getElementsByTagName("script")[0];
        firstScript.parentNode.insertBefore(tag, firstScript);

        window.onYouTubeIframeAPIReady = function () {
          player = new YT.Player("player", {
            height: "100%",
            width: "100%",
            videoId: filteredVideos[0] ? filteredVideos[0].id : "",
            playerVars: {
              autoplay: 1,
              controls: 0,
              modestbranding: 1,
              playsinline: 1,
              rel: 0,
              showinfo: 0,
              loop: 0,
              mute: 0,
              vq: "hd1080",
            },
            events: {
              onReady: onPlayerReady,
              onStateChange: onPlayerStateChange,
            },
          });
        };
      }

      function onPlayerReady(e) {
        e.target.playVideo();
        if (filteredVideos.length > 0) updateVideoInfo();
        startProgressMonitor();
        setTimeout(() => {
          const duration = player.getDuration();
          if (duration <= 0 && filteredVideos[currentVideoIndex]) {
            markVideoAsWatched(filteredVideos[currentVideoIndex].id);
            playNextVideo();
          }
        }, 2000);
        initScrollHint();
        showUpDownHint();
      }

      function onPlayerStateChange(e) {
        if (e.data === YT.PlayerState.ENDED) {
          markVideoAsWatched(filteredVideos[currentVideoIndex].id);
          playNextVideo();
        } else if (e.data === YT.PlayerState.PLAYING) {
          hideLoading();
        } else if (e.data === YT.PlayerState.BUFFERING) {
          showLoading();
        }
      }

      function loadVideo(vidId) {
        if (player && player.loadVideoById && vidId) {
          showLoading();
          player.loadVideoById(vidId);
          updateVideoInfo();
        }
      }

      function playNextVideo() {
        if (isTransitioning) return;
        isTransitioning = true;
        while (
          currentVideoIndex < filteredVideos.length - 1 &&
          hasWatched(filteredVideos[currentVideoIndex + 1].id)
        ) {
          currentVideoIndex++;
        }
        if (currentVideoIndex < filteredVideos.length - 1) {
          currentVideoIndex++;
          loadVideo(filteredVideos[currentVideoIndex].id);
        } else {
          if (currentCategoryIndex < allCategories.length - 1) {
            initCategory(++currentCategoryIndex);
            document
              .querySelectorAll(".category")
              .forEach((el) => el.classList.remove("active"));
            document
              .querySelectorAll(".category")
              [currentCategoryIndex].classList.add("active");
          } else {
            showReplayModal();
          }
        }
        setTimeout(() => {
          isTransitioning = false;
        }, 300);
      }

      function playPreviousVideo() {
        if (isTransitioning || currentVideoIndex <= 0) return;
        isTransitioning = true;
        currentVideoIndex--;
        loadVideo(filteredVideos[currentVideoIndex].id);
        setTimeout(() => {
          isTransitioning = false;
        }, 300);
      }

      function hasWatched(vidId) {
        const watched = JSON.parse(
          localStorage.getItem("watchedVideos") || "[]"
        );
        return watched.includes(vidId);
      }

      function markVideoAsWatched(vidId) {
        let watched = JSON.parse(localStorage.getItem("watchedVideos") || "[]");
        if (!watched.includes(vidId)) {
          watched.push(vidId);
          localStorage.setItem("watchedVideos", JSON.stringify(watched));
        }
      }

      function resetWatchedVideos() {
        localStorage.removeItem("watchedVideos");
      }

      function showReplayModal() {
        const replayModal = document.getElementById("replayModal");
        replayModal.classList.add("active");
        document.getElementById("replayYes").onclick = () => {
          replayModal.classList.remove("active");
          resetWatchedVideos();
          currentCategoryIndex = 0;
          currentVideoIndex = 0;
          initCategory(currentCategoryIndex);
          document
            .querySelectorAll(".category")
            .forEach((el) => el.classList.remove("active"));
          document.querySelectorAll(".category")[0].classList.add("active");
        };
        document.getElementById("replayNo").onclick = () => {
          replayModal.classList.remove("active");
        };
      }

      function updateVideoInfo() {
        const t = document.getElementById("videoTitle");
        const d = document.getElementById("videoDesc");
        if (filteredVideos[currentVideoIndex]) {
          t.textContent = filteredVideos[currentVideoIndex].title || "無標題";
          d.textContent = filteredVideos[currentVideoIndex].description || "";
        } else {
          t.textContent = "";
          d.textContent = "";
        }
      }

      function showLoading() {
        document.getElementById("loadingOverlay").classList.add("active");
      }
      function hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("active");
      }

      function startProgressMonitor() {
        const bar = document.getElementById("videoProgress");
        function update() {
          if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
            const ct = player.getCurrentTime();
            const du = player.getDuration();
            if (du > 0) {
              const per = (ct / du) * 100;
              bar.style.width = per + "%";
            }
          }
          requestAnimationFrame(update);
        }
        requestAnimationFrame(update);
      }

      let startY = 0,
        startTime = 0;
      document.body.addEventListener(
        "touchstart",
        (e) => {
          startY = e.touches[0].clientY;
          startTime = Date.now();
        },
        { passive: true }
      );
      document.body.addEventListener(
        "touchend",
        (e) => {
          const deltaY = e.changedTouches[0].clientY - startY;
          const deltaTime = Date.now() - startTime;
          if (Math.abs(deltaY) > 50 && deltaTime < 500) {
            if (deltaY < 0) playNextVideo();
            else playPreviousVideo();
          }
        },
        { passive: true }
      );

      function initScrollHint() {
        const catBar = document.getElementById("categoryBar");
        const slideHint = document.getElementById("slideHint");
        let hideTimer;
        function checkOverflow() {
          const overflow = catBar.scrollWidth > catBar.clientWidth;
          if (overflow) {
            slideHint.style.display = "flex";
            if (hideTimer) clearTimeout(hideTimer);
            hideTimer = setTimeout(() => {
              slideHint.style.display = "none";
            }, 3000);
          }
        }
        catBar.addEventListener("scroll", () => {
          if (hideTimer) clearTimeout(hideTimer);
          hideTimer = setTimeout(() => {
            slideHint.style.display = "none";
          }, 3000);
        });
        setTimeout(checkOverflow, 200);
      }

      function showUpDownHint() {
        const upDownHint = document.getElementById("upDownHint");
        upDownHint.style.display = "flex";
        setTimeout(() => {
          upDownHint.style.display = "none";
        }, 3000);
      }

      function initVideoManagerUI() {
        const managerBtn = document.getElementById("videoManagerBtn");
        const managerModal = document.getElementById("videoManagerModal");
        const managerCloseBtn = document.getElementById("managerCloseBtn");
        const videoForm = document.getElementById("videoForm");
        const catForm = document.getElementById("catForm");
        const catNameInput = document.getElementById("catNameInput");
        const catList = document.getElementById("catList");
        const videoList = document.getElementById("videoList");
        const addOrEditBtn = document.getElementById("addOrEditBtn");
        const exportBtn = document.getElementById("exportBtn");
        const videoCategorySelect = document.getElementById("videoCategory");
        let editIndex = null;

        managerBtn.onclick = () => {
          refreshVideoList();
          refreshCatList();
          refreshVideoFormCategories();
          managerModal.classList.add("active");
          editIndex = null;
          addOrEditBtn.textContent = "新增影片";
          videoForm.reset();
        };
        managerCloseBtn.onclick = () => {
          managerModal.classList.remove("active");
        };

        videoForm.onsubmit = (e) => {
          e.preventDefault();
          const linkValue = document.getElementById("videoLink").value.trim();
          const titleValue = document
            .getElementById("videoTitleInput")
            .value.trim();
          const catValue = videoCategorySelect.value;
          if (!linkValue || !titleValue) {
            alert("連結/ID 與標題都不可空白");
            return;
          }
          const parsedId = parseYouTubeId(linkValue);
          if (!parsedId) {
            alert("無法解析此連結或ID");
            return;
          }

          let userVideos = getUserVideos();
          if (userVideos.some((v) => v.id === parsedId)) {
            alert("此影片已經存在，不可重複新增");
            return;
          }

          if (editIndex === null) {
            userVideos.push({
              id: parsedId,
              title: titleValue,
              description: "",
              category: catValue,
            });
          } else {
            userVideos[editIndex].id = parsedId;
            userVideos[editIndex].title = titleValue;
            userVideos[editIndex].category = catValue;
          }
          saveUserVideosToLocal(userVideos);
          reloadAllData();
          videoForm.reset();
          editIndex = null;
          addOrEditBtn.textContent = "新增影片";
        };

        exportBtn.onclick = () => {
          exportOptionsModal.style.display = "block";
        };

        catForm.onsubmit = (e) => {
          e.preventDefault();
          const newCat = catNameInput.value.trim();
          if (!newCat) {
            alert("分類名稱不可空白");
            return;
          }
          let userCats = getUserCategories();
          if (
            !userCats.includes(newCat) &&
            !builtInCategories.includes(newCat)
          ) {
            userCats.push(newCat);
          }
          saveUserCategoriesToLocal(userCats);
          catNameInput.value = "";
          reloadAllData();
        };

        function refreshVideoList() {
          // 此函式已於全域定義，重複定義請確保在 manager UI 內部調用的是全域函式
          window.refreshVideoList();
        }

        function refreshVideoFormCategories() {
          videoCategorySelect.innerHTML = "";
          allCategories.forEach((cat) => {
            const opt = document.createElement("option");
            opt.value = cat;
            opt.textContent = cat;
            videoCategorySelect.appendChild(opt);
          });
        }

        function refreshCatList() {
          catList.innerHTML = "";
          const userCats = getUserCategories();
          if (userCats.length === 0) {
            catList.innerHTML =
              '<p style="text-align:center;">（尚無自訂分類）</p>';
            return;
          }
          userCats.forEach((c, idx) => {
            const div = document.createElement("div");
            div.classList.add("cat-item");
            div.innerHTML = `
              <span>${c}</span>
              <button class="cat-del-btn">刪除</button>
            `;
            const delBtn = div.querySelector(".cat-del-btn");
            delBtn.onclick = () => {
              if (confirm(`確定要刪除分類「${c}」嗎？`)) {
                userCats.splice(idx, 1);
                saveUserCategoriesToLocal(userCats);
                reloadAllData();
              }
            };
            catList.appendChild(div);
          });
        }

        function reloadAllData() {
          loadAllDataFromLocal();
          const userVideos = getUserVideos();
          allVideos = [...userVideos]; // 注意：CSV 預設影片已在 initializeData 載入
          const userCats = getUserCategories();
          allCategories = Array.from(
            new Set([...builtInCategories, ...userCats])
          );
          filterOutBannedVideos();
          createCategoryButtons();
          initCategory(0);
          refreshVideoList();
          refreshCatList();
          refreshVideoFormCategories();
        }
      }

      function parseYouTubeId(input) {
        if (/^[a-zA-Z0-9_-]{11,}$/.test(input)) return input;
        const regShort = /youtu\.be\/([^?]+)/;
        const matchShort = input.match(regShort);
        if (matchShort && matchShort[1]) return matchShort[1];
        const regLong = /v=([^&]+)/;
        const matchLong = input.match(regLong);
        if (matchLong && matchLong[1]) return matchLong[1];
        const regShorts = /youtube\.com\/shorts\/([^?]+)/;
        const matchShorts = input.match(regShorts);
        if (matchShorts && matchShorts[1]) return matchShorts[1];
        const regEmbed = /youtube\.com\/embed\/([^?]+)/;
        const matchEmbed = input.match(regEmbed);
        if (matchEmbed && matchEmbed[1]) return matchEmbed[1];
        const regOld = /youtube\.com\/v\/([^?]+)/;
        const matchOld = input.match(regOld);
        if (matchOld && matchOld[1]) return matchOld[1];
        return null;
      }

      function getUserVideos() {
        const str = localStorage.getItem("userVideos");
        let arr = [];
        if (str) {
          try {
            arr = JSON.parse(str);
          } catch (e) {}
        }
        return arr;
      }
      function getUserCategories() {
        const str = localStorage.getItem("userCategories");
        let arr = [];
        if (str) {
          try {
            arr = JSON.parse(str);
          } catch (e) {}
        }
        return arr;
      }

      // 匯出相關
      const exportOptionsModal = document.getElementById("exportOptionsModal");
      const exportClipboardBtn = document.getElementById("exportClipboardBtn");
      const exportTxtBtn = document.getElementById("exportTxtBtn");
      const exportCsvBtn = document.getElementById("exportCsvBtn");
      const exportCancelBtn = document.getElementById("exportCancelBtn");

      exportClipboardBtn.onclick = () => {
        const exportText = generateExportText();
        navigator.clipboard
          .writeText(exportText)
          .then(() => alert("已複製到剪貼簿！"))
          .catch(() => alert("複製失敗"));
        exportOptionsModal.style.display = "none";
      };

      exportTxtBtn.onclick = () => {
        const exportText = generateExportText();
        const blob = new Blob([exportText], {
          type: "text/plain;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "all_videos.txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("已下載全部影片文字（txt）！");
        exportOptionsModal.style.display = "none";
      };

      exportCsvBtn.onclick = () => {
        let csvContent = "category,title,url,description\n";
        allVideos.forEach((v) => {
          const url = `https://youtu.be/${encodeURIComponent(v.id)}`;
          csvContent += `${v.category},"${v.title}",${url},"${
            v.description || ""
          }"\n`;
        });
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
        const urlBlob = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = urlBlob;
        a.download = "all_videos.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(urlBlob);
        alert("已下載全部影片資料（CSV）！");
        exportOptionsModal.style.display = "none";
      };

      exportCancelBtn.onclick = () => {
        exportOptionsModal.style.display = "none";
      };

      function generateExportText() {
        let text = "=== 所有影片清單 (UTF-8) ===\n\n";
        const grouped = {};
        allVideos.forEach((v) => {
          if (!grouped[v.category]) grouped[v.category] = [];
          grouped[v.category].push(v);
        });
        allCategories.forEach((cat) => {
          if (grouped[cat] && grouped[cat].length > 0) {
            text += `【${cat}】\n`;
            grouped[cat].forEach((vid, idx) => {
              const url = `https://youtu.be/${encodeURIComponent(vid.id)}`;
              text += `  ${idx + 1}. ${vid.title} (URL: ${url})\n`;
            });
            text += "\n";
          }
        });
        return text;
      }
    </script>
  </body>
</html>
