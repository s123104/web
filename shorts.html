<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>裝修教學短視頻</title>
  <style>
    /* 基本重置 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
      color: #fff;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
      position: relative;
    }

    /* 頂部提示區塊 */
    .top-hint {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      background: #222;
      color: #fff;
      font-size: 14px;
      padding: 4px 12px;
      line-height: 1.5;
    }
    .top-hint p {
      margin-bottom: 4px;
    }

    /* 分類按鈕容器 */
    .category-bar {
      position: fixed;
      top: 60px; /* 往下讓出 top-hint 的空間 */
      left: 0; 
      right: 0;
      display: flex;
      align-items: center;
      overflow-x: scroll;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
      z-index: 999;
      padding: 0 10px;
      height: 50px;
      background: rgba(0,0,0,0.6);
    }
    .category {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 16px;
      margin: 0 4px;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      background: transparent;
      border-radius: 16px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .category.active {
      color: #fff;
      background: rgba(255,255,255,0.2);
      font-weight: 500;
    }

    /* 管理影片按鈕 - 右下角，影片符號 🎥 */
    .video-manager-btn {
      position: fixed;
      bottom: 60px; 
      right: 16px;
      width: 44px;
      height: 44px;
      z-index: 3000;
      background: #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      user-select: none;
    }

    /* 左右滑動提示 */
    .scroll-hint {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 10px;
      font-size: 14px;
      background: rgba(0,0,0,0.6);
      border-radius: 12px;
      color: #fff;
      z-index: 999;
      display: none;
    }
    .scroll-hint.show {
      display: block;
      animation: hintFloat 1s ease-in-out infinite alternate;
    }
    @keyframes hintFloat { 
      from { transform: translateX(-50%) translateY(0); } 
      to { transform: translateX(-50%) translateY(-5px); } 
    }

    /* 影片容器 */
    .video-section {
      position: absolute;
      top: 110px; /* category-bar 下面 + top-hint */
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }
    .video-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    .video-frame {
      width: 100%;
      height: 100%;
      background: #000;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* loading 遮罩 */
    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .loading-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 影片資訊及進度條 */
    .video-overlay {
      position: absolute;
      bottom: 0; 
      left: 0; 
      right: 0;
      padding: 16px;
      background: linear-gradient(transparent, rgba(0,0,0,0.6));
      z-index: 2;
    }
    .video-info {
      margin-bottom: 8px;
    }
    .video-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .video-description {
      font-size: 14px;
      line-height: 1.4;
      color: rgba(255,255,255,0.9);
    }
    .progress-bar {
      position: relative;
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.3);
      overflow: hidden;
    }
    .progress {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 0%;
      background: #fff;
      transition: width 0.1s linear;
    }

    /* 重新播放提示彈窗 */
    #replayModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #replayModal.active {
      display: flex;
    }
    #replayModal .modal-content {
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    #replayModal .modal-content button {
      margin: 0 8px;
      padding: 8px 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }

    /* ======== 影片管理 Modal ======== */
    #videoManagerModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #videoManagerModal.active {
      display: flex;
    }
    .manager-content {
      background: #fff;
      color: #000;
      width: 90%;
      max-width: 600px;
      max-height: 80%;
      overflow: auto;
      border-radius: 8px;
      padding: 16px;
      position: relative;
    }
    .manager-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .manager-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .manager-close {
      cursor: pointer;
      background: #ccc;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
    }
    .video-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    .video-form label {
      font-size: 14px;
      font-weight: 500;
    }
    .video-form input, .video-form select {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .video-form button {
      padding: 8px;
      border: none;
      background: #3498db;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .video-list {
      margin-top: 8px;
      border-top: 1px solid #ddd;
      padding-top: 8px;
    }
    .video-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 8px;
      background: #f2f2f2;
      border-radius: 4px;
    }
    .video-item span {
      flex: 1;
      padding-right: 8px;
    }
    .edit-btn, .del-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 4px;
      font-size: 12px;
    }
    .edit-btn { background: #ffa500; color: #fff; }
    .del-btn { background: #e74c3c; color: #fff; }

    /* 匯出按鈕 */
    .export-btn {
      margin-top: 8px;
      padding: 6px 12px;
      border: none;
      background: #2ecc71;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    /* ======= 分類管理區 ======= */
    .category-manage-section {
      margin-top: 16px;
      border-top: 1px solid #ddd;
      padding-top: 8px;
    }
    .cat-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .cat-form input {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .cat-list .cat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      border-radius: 4px;
      background: #f7f7f7;
      margin-bottom: 4px;
    }
    .cat-list .cat-del-btn {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- 頂部提示：上下滑動、左右滑動說明 -->
  <div class="top-hint">
    <p>提示：左右滑動可以切換分類</p>
    <p>提示：上下滑動可以切換影片</p>
  </div>

  <!-- 分類按鈕列 -->
  <div class="category-bar" id="categoryBar"></div>
  <!-- 右下角管理按鈕 -->
  <div class="video-manager-btn" id="videoManagerBtn">🎥</div>

  <!-- 左右滑動提示 -->
  <div class="scroll-hint" id="scrollHint">左右滑動查看更多分類</div>
  
  <!-- 影片容器 -->
  <div class="video-section">
    <div class="video-container">
      <div class="video-frame" id="player"></div>
      <div class="video-overlay">
        <div class="video-info">
          <h2 class="video-title" id="videoTitle"></h2>
          <p class="video-description" id="videoDesc"></p>
        </div>
        <div class="progress-bar">
          <div class="progress" id="videoProgress"></div>
        </div>
      </div>
      <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>

  <!-- 全部播放完畢後，是否重新播放的彈窗 -->
  <div id="replayModal">
    <div class="modal-content">
      <p>您已經看過所有影片，是否重新觀看？</p>
      <button id="replayYes">是</button>
      <button id="replayNo">否</button>
    </div>
  </div>

  <!-- 影片管理 Modal (新增 / 編輯 / 刪除 / 匯出 + 分類管理) -->
  <div id="videoManagerModal">
    <div class="manager-content">
      <div class="manager-header">
        <h2>影片管理</h2>
        <button class="manager-close" id="managerCloseBtn">關閉</button>
      </div>

      <!-- 新增 / 編輯 表單 -->
      <form class="video-form" id="videoForm">
        <label for="videoLink">影片連結或 ID</label>
        <input type="text" id="videoLink" placeholder="e.g. https://youtu.be/xxxx 或直接輸入ID" />

        <label for="videoTitleInput">影片標題</label>
        <input type="text" id="videoTitleInput" placeholder="請輸入影片標題" />

        <label for="videoCategory">選擇分類</label>
        <select id="videoCategory">
          <!-- 動態插入 allCategories -->
        </select>

        <button type="submit" id="addOrEditBtn">新增影片</button>
      </form>

      <!-- 使用者自訂影片列表 -->
      <div class="video-list" id="videoList"></div>

      <!-- 匯出按鈕 -->
      <button class="export-btn" id="exportBtn">匯出全部影片文字</button>

      <!-- 分類管理區 -->
      <div class="category-manage-section">
        <h3>分類管理</h3>
        <form class="cat-form" id="catForm">
          <input type="text" id="catNameInput" placeholder="輸入新分類名稱" />
          <button type="submit" id="catAddBtn">新增分類</button>
        </form>
        <div class="cat-list" id="catList"></div>
      </div>
    </div>
  </div>

  <script>
    // ============ 配置區 ============
    // 這裡放一些「不給看」或是直接掛掉的影片 ID
    const bannedVideoIds = ["魯班尺URL", "someBannedId1", "someBannedId2"];

    // 內建預設影片
    const defaultVideos = [
      // 分類：工具操作
      { id: '4eWtbt1DsLU', title: '足幾分板是什麼？這影片告訴你！', description: '', category: '工具操作' },
      { id: 'rAuk2qK-BRY', title: '釘槍不只帥，還超好用！', description: '', category: '工具操作' },
      { id: '9Es8VaMrGPE', title: '平土器到底在平啥？答案在這！', description: '', category: '工具操作' },
      { id: 'vhE16_8eh9g', title: '卷尺也有眉角？學起來別丟臉！', description: '', category: '工具操作' },
      { id: 'kzZ4wXOpRw4', title: '泥作工具太多？這裡幫你搞懂！', description: '', category: '工具操作' },
      { id: 'hy6KP-TJvyM', title: '工具術語太複雜？一看就秒懂！', description: '', category: '工具操作' },
      // 分類：建材選擇
      { id: 'ZTtns0-nIcQ', title: '夾板厚度怎麼挑？別被老闆唬爛！', description: '', category: '建材選擇' },
      { id: 'YealWFoQUgs', title: '鑿面切磚這麼簡單？看完秒會！', description: '', category: '建材選擇' },
      { id: 'RyxE_6DPcGM', title: '手提修邊機超神！不用工具人也能上手！', description: '', category: '建材選擇' },
      { id: 'ZzP_sk4tefU', title: '紅磚牆很讚？缺點你搞清楚沒？', description: '', category: '建材選擇' },
      // 分類：施工細節
      { id: 'F7xVuDDCCzc', title: '化糞池虎邊放？這是裝修人的小撇步！', description: '', category: '施工細節' },
      { id: '7x383cfXMzQ', title: '木作隔間超簡單，上集', description: '', category: '施工細節' },
      { id: 'kdl7ade-xSA', title: '木作隔間超簡單，下集', description: '', category: '施工細節' },
      { id: 'XhwjdtcFcao', title: '防火填塞這麼猛！用對材料超安心！', description: '', category: '施工細節' },
      { id: 'YqvhJnB-thE', title: '防火門該怎麼選？影片裡教你套路！', description: '', category: '施工細節' },
      { id: 'WTYfoTwF16s', title: '浴室裝修小細節，沒注意就GG啦！', description: '', category: '施工細節' },
      // 分類：修復保養
      { id: '4YB2_9_TnM8', title: '磁磚空股修復術，省錢又好用！', description: '', category: '修復保養' },
      { id: 'fiWYdCzt5C4', title: '老屋壁癌？教你一招徹底解決！', description: '', category: '修復保養' },
      // 分類：美觀收尾
      { id: 'kc2Y1QcQo8Y', title: '家中油漆顏色怎麼挑？別被老婆罵爆！', description: '', category: '美觀收尾' },
      { id: '73Zh6fl4swg', title: '燈具選得好，家裡一秒高級化！', description: '', category: '美觀收尾' },
      { id: 'py8hlbc3AOs', title: '燈泡怎麼選？別裝完才傻眼！', description: '', category: '美觀收尾' },
      // 分類：專業術語
      { id: 'eC52Ms4yUUQ', title: '案場術語大公開！這些詞別裝不懂！', description: '', category: '專業術語' },
      { id: 'PM2dub2v179EhTjY', title: '你知道文公尺的規律嗎？ 看完包學會！', description: '', category: '專業術語' },
      // 分類：特殊施工
      { id: 'JDZxq_QDiT0', title: '美耐板怎麼貼才牢？這裡有秘訣！上集', description: '', category: '特殊施工' },
      { id: 'KovKnsBF7Ic', title: '美耐板怎麼貼才牢？這裡有秘訣！下集', description: '', category: '特殊施工' },
      { id: 'VotM_pXBV2Q', title: '混凝土振動器好猛！讓結構更扎實！', description: '', category: '特殊施工' }
    ];

    // 內建預設分類
    const builtInCategories = [
      '工具操作',
      '建材選擇',
      '施工細節',
      '修復保養',
      '美觀收尾',
      '專業術語',
      '特殊施工'
    ];


    let allVideos = [];
    let allCategories = [];
    let validVideos = [];
    let currentCategoryIndex = 0; // 預設第一個分類
    let currentVideoIndex = 0;
    let filteredVideos = [];
    let player;
    let isTransitioning = false;

    document.addEventListener('DOMContentLoaded', () => {
      loadAllDataFromLocal();
      filterOutBannedVideos();
      createCategoryButtons();
      initCategory(0);
      initYouTubePlayer();
      initScrollHint();
      initVideoManagerUI();
    });

    // ============ LocalStorage & 讀取 / 儲存 ============
    function loadAllDataFromLocal() {
      // 讀使用者自訂影片
      const userVideosStr = localStorage.getItem('userVideos');
      let userVideos = [];
      if (userVideosStr) {
        try {
          userVideos = JSON.parse(userVideosStr);
        } catch(e) {}
      }
      // 讀使用者自訂分類
      const userCatsStr = localStorage.getItem('userCategories');
      let userCats = [];
      if (userCatsStr) {
        try {
          userCats = JSON.parse(userCatsStr);
        } catch(e) {}
      }
      // 合併分類
      allCategories = Array.from(new Set([...builtInCategories, ...userCats]));
      // 合併影片
      allVideos = [...defaultVideos, ...userVideos];
    }
    function saveUserVideosToLocal(userVideos) {
      localStorage.setItem('userVideos', JSON.stringify(userVideos));
    }
    function saveUserCategoriesToLocal(userCats) {
      localStorage.setItem('userCategories', JSON.stringify(userCats));
    }

    // ============ 過濾被 ban 的影片 ============
    function filterOutBannedVideos() {
      validVideos = allVideos.filter(v => !bannedVideoIds.includes(v.id));
    }

    // ============ 分類按鈕 ============
    function createCategoryButtons() {
      const categoryBar = document.getElementById('categoryBar');
      categoryBar.innerHTML = '';
      allCategories.forEach((catName, idx) => {
        const catBtn = document.createElement('div');
        catBtn.classList.add('category');
        catBtn.textContent = catName;
        if (idx === 0) catBtn.classList.add('active');
        catBtn.addEventListener('click', () => {
          document.querySelectorAll('.category').forEach(el => el.classList.remove('active'));
          catBtn.classList.add('active');
          initCategory(idx);
        });
        categoryBar.appendChild(catBtn);
      });
    }
    function initCategory(catIndex) {
      currentCategoryIndex = catIndex;
      const targetCat = allCategories[currentCategoryIndex];
      filteredVideos = validVideos.filter(v => v.category === targetCat);
      currentVideoIndex = 0;
      if (filteredVideos.length > 0 && player) {
        loadVideo(filteredVideos[currentVideoIndex].id);
        updateVideoInfo();
      } else {
        if (player && player.stopVideo) {
          player.stopVideo();
        }
        document.getElementById('videoTitle').textContent = '';
        document.getElementById('videoDesc').textContent = '';
      }
    }

    // ============ YouTube Player ============
    function initYouTubePlayer() {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      window.onYouTubeIframeAPIReady = function() {
        player = new YT.Player('player', {
          height: '100%',
          width: '100%',
          videoId: filteredVideos[0] ? filteredVideos[0].id : '',
          playerVars: {
            autoplay: 1,
            controls: 0,
            modestbranding: 1,
            playsinline: 1,
            rel: 0,
            showinfo: 0,
            loop: 0,
            mute: 0,
            vq: 'hd1080'
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      };
    }
    function onPlayerReady(event) {
      event.target.playVideo();
      startProgressMonitor();
      // 若 duration=0 => 影片失效 => 跳下一支
      setTimeout(() => {
        const duration = player.getDuration();
        if (duration <= 0 && filteredVideos[currentVideoIndex]) {
          markVideoAsWatched(filteredVideos[currentVideoIndex].id);
          playNextVideo();
        }
      }, 2000);
    }
    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        markVideoAsWatched(filteredVideos[currentVideoIndex].id);
        playNextVideo();
      } else if (event.data === YT.PlayerState.PLAYING) {
        hideLoading();
      } else if (event.data === YT.PlayerState.BUFFERING) {
        showLoading();
      }
    }

    // ============ 播放控制 ============
    function loadVideo(videoId) {
      if (player && player.loadVideoById && videoId) {
        showLoading();
        player.loadVideoById(videoId);
        updateVideoInfo();
      }
    }
    function playNextVideo() {
      if (isTransitioning) return;
      isTransitioning = true;
      while (currentVideoIndex < filteredVideos.length - 1 && hasWatched(filteredVideos[currentVideoIndex + 1].id)) {
        currentVideoIndex++;
      }
      if (currentVideoIndex < filteredVideos.length - 1) {
        currentVideoIndex++;
        loadVideo(filteredVideos[currentVideoIndex].id);
      } else {
        if (currentCategoryIndex < allCategories.length - 1) {
          initCategory(++currentCategoryIndex);
          document.querySelectorAll('.category').forEach(el => el.classList.remove('active'));
          document.querySelectorAll('.category')[currentCategoryIndex].classList.add('active');
        } else {
          showReplayModal();
        }
      }
      setTimeout(() => { isTransitioning = false; }, 300);
    }
    function playPreviousVideo() {
      if (isTransitioning || currentVideoIndex <= 0) return;
      isTransitioning = true;
      currentVideoIndex--;
      loadVideo(filteredVideos[currentVideoIndex].id);
      setTimeout(() => { isTransitioning = false; }, 300);
    }

    // ============ Watched 紀錄 ============
    function hasWatched(videoId) {
      const watched = JSON.parse(localStorage.getItem('watchedVideos') || '[]');
      return watched.includes(videoId);
    }
    function markVideoAsWatched(videoId) {
      let watched = JSON.parse(localStorage.getItem('watchedVideos') || '[]');
      if (!watched.includes(videoId)) {
        watched.push(videoId);
        localStorage.setItem('watchedVideos', JSON.stringify(watched));
      }
    }
    function resetWatchedVideos() {
      localStorage.removeItem('watchedVideos');
    }

    // ============ 重播提示彈窗 ============
    function showReplayModal() {
      const replayModal = document.getElementById('replayModal');
      replayModal.classList.add('active');
      document.getElementById('replayYes').onclick = () => {
        replayModal.classList.remove('active');
        resetWatchedVideos();
        currentCategoryIndex = 0;
        currentVideoIndex = 0;
        initCategory(currentCategoryIndex);
        document.querySelectorAll('.category').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.category')[0].classList.add('active');
      };
      document.getElementById('replayNo').onclick = () => {
        replayModal.classList.remove('active');
      };
    }

    // ============ UI & 進度條 ============
    function updateVideoInfo() {
      const titleElem = document.getElementById('videoTitle');
      const descElem = document.getElementById('videoDesc');
      if (filteredVideos[currentVideoIndex]) {
        titleElem.textContent = filteredVideos[currentVideoIndex].title || '無標題';
        descElem.textContent = filteredVideos[currentVideoIndex].description || '';
      } else {
        titleElem.textContent = '';
        descElem.textContent = '';
      }
    }
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    function startProgressMonitor() {
      const progressBar = document.getElementById('videoProgress');
      function update() {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
          const currentTime = player.getCurrentTime();
          const duration = player.getDuration();
          if (duration > 0) {
            const percent = (currentTime / duration) * 100;
            progressBar.style.width = percent + '%';
          }
        }
        requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    }

    // ============ 上下滑換影片 ============
    let startY = 0, startTime = 0;
    document.body.addEventListener('touchstart', e => {
      startY = e.touches[0].clientY;
      startTime = Date.now();
    }, { passive: true });
    document.body.addEventListener('touchend', e => {
      const deltaY = e.changedTouches[0].clientY - startY;
      const deltaTime = Date.now() - startTime;
      if (Math.abs(deltaY) > 50 && deltaTime < 500) {
        if (deltaY < 0) {
          playNextVideo();
        } else {
          playPreviousVideo();
        }
      }
    }, { passive: true });

    // ============ 左右滑動提示 ============
    function initScrollHint() {
      const categoryBar = document.getElementById('categoryBar');
      const scrollHint = document.getElementById('scrollHint');
      let hideTimer;
      function checkOverflow() {
        const overflow = categoryBar.scrollWidth > categoryBar.clientWidth;
        if (overflow) {
          scrollHint.classList.add('show');
          if (hideTimer) clearTimeout(hideTimer);
          hideTimer = setTimeout(() => {
            scrollHint.classList.remove('show');
          }, 3000);
        }
      }
      categoryBar.addEventListener('scroll', () => {
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          scrollHint.classList.remove('show');
        }, 3000);
      });
      setTimeout(checkOverflow, 200);
    }

    // ============ 影片管理功能 ============
    function initVideoManagerUI() {
      const videoManagerBtn = document.getElementById('videoManagerBtn');
      const videoManagerModal = document.getElementById('videoManagerModal');
      const managerCloseBtn = document.getElementById('managerCloseBtn');
      const videoForm = document.getElementById('videoForm');
      const videoCategorySelect = document.getElementById('videoCategory');
      const addOrEditBtn = document.getElementById('addOrEditBtn');
      const videoList = document.getElementById('videoList');
      const exportBtn = document.getElementById('exportBtn');

      const catForm = document.getElementById('catForm');
      const catNameInput = document.getElementById('catNameInput');
      const catList = document.getElementById('catList');

      let editIndex = null; // 編輯哪個影片

      videoManagerBtn.onclick = () => {
        refreshVideoList();
        refreshCatList();
        refreshVideoFormCategories();
        videoManagerModal.classList.add('active');
        editIndex = null;
        addOrEditBtn.textContent = '新增影片';
        videoForm.reset();
      };
      managerCloseBtn.onclick = () => {
        videoManagerModal.classList.remove('active');
      };

      // 影片表單：新增 / 編輯
      videoForm.onsubmit = (e) => {
        e.preventDefault();
        const linkValue = document.getElementById('videoLink').value.trim();
        const titleValue = document.getElementById('videoTitleInput').value.trim();
        const catValue = videoCategorySelect.value;
        if (!linkValue || !titleValue) {
          alert('連結/ID 與標題都不可空白');
          return;
        }
        const parsedId = parseYouTubeId(linkValue);
        if (!parsedId) {
          alert('無法解析此連結或ID');
          return;
        }
        let userVideos = getUserVideos();
        if (editIndex === null) {
          // 新增
          userVideos.push({ id: parsedId, title: titleValue, description: '', category: catValue });
        } else {
          // 編輯
          userVideos[editIndex].id = parsedId;
          userVideos[editIndex].title = titleValue;
          userVideos[editIndex].category = catValue;
        }
        saveUserVideosToLocal(userVideos);
        reloadAllData();
        videoForm.reset();
        editIndex = null;
        addOrEditBtn.textContent = '新增影片';
      };

      // 匯出按鈕
      exportBtn.onclick = () => {
        const exportText = generateExportText();
        // 建立 txt 檔並下載
        const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'all_videos.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('已匯出全部影片文字！');
      };

      // 分類表單：新增
      catForm.onsubmit = (e) => {
        e.preventDefault();
        const newCat = catNameInput.value.trim();
        if (!newCat) {
          alert('分類名稱不可空白');
          return;
        }
        let userCats = getUserCategories();
        // 防止重複
        if (!userCats.includes(newCat) && !builtInCategories.includes(newCat)) {
          userCats.push(newCat);
        }
        saveUserCategoriesToLocal(userCats);
        catNameInput.value = '';
        reloadAllData();
      };

      // 刷新影片列表
      function refreshVideoList() {
        videoList.innerHTML = '';
        const userVideos = getUserVideos();
        if (userVideos.length === 0) {
          videoList.innerHTML = '<p style="text-align:center;">（尚無自訂影片）</p>';
          return;
        }
        userVideos.forEach((v, i) => {
          const div = document.createElement('div');
          div.classList.add('video-item');
          div.innerHTML = `
            <span>[${v.category}] ${v.title} (${v.id})</span>
            <div>
              <button class="edit-btn">編輯</button>
              <button class="del-btn">刪除</button>
            </div>
          `;
          const editBtn = div.querySelector('.edit-btn');
          const delBtn = div.querySelector('.del-btn');
          editBtn.onclick = () => {
            editIndex = i;
            document.getElementById('videoLink').value = v.id;
            document.getElementById('videoTitleInput').value = v.title;
            videoCategorySelect.value = v.category;
            addOrEditBtn.textContent = '儲存變更';
          };
          delBtn.onclick = () => {
            if (confirm(`確定要刪除「${v.title}」嗎？`)) {
              userVideos.splice(i, 1);
              saveUserVideosToLocal(userVideos);
              reloadAllData();
            }
          };
          videoList.appendChild(div);
        });
      }
      // 刷新表單中的分類下拉
      function refreshVideoFormCategories() {
        videoCategorySelect.innerHTML = '';
        allCategories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          videoCategorySelect.appendChild(opt);
        });
      }
      // 刷新分類列表
      function refreshCatList() {
        catList.innerHTML = '';
        const userCats = getUserCategories();
        if (userCats.length === 0) {
          catList.innerHTML = '<p style="text-align:center;">（尚無自訂分類）</p>';
          return;
        }
        userCats.forEach((c, idx) => {
          const div = document.createElement('div');
          div.classList.add('cat-item');
          div.innerHTML = `
            <span>${c}</span>
            <button class="cat-del-btn">刪除</button>
          `;
          const delBtn = div.querySelector('.cat-del-btn');
          delBtn.onclick = () => {
            if (confirm(`確定要刪除分類「${c}」嗎？`)) {
              userCats.splice(idx, 1);
              saveUserCategoriesToLocal(userCats);
              reloadAllData();
            }
          };
          catList.appendChild(div);
        });
      }

      // 重新載入所有資料
      function reloadAllData() {
        loadAllDataFromLocal();
        filterOutBannedVideos();
        createCategoryButtons();
        initCategory(0);
        refreshVideoList();
        refreshCatList();
        refreshVideoFormCategories();
      }
    }

    // ============ 取得自訂影片 / 分類 ============
    function getUserVideos() {
      const str = localStorage.getItem('userVideos');
      let arr = [];
      if (str) {
        try { arr = JSON.parse(str); } catch(e) {}
      }
      return arr;
    }
    function getUserCategories() {
      const str = localStorage.getItem('userCategories');
      let arr = [];
      if (str) {
        try { arr = JSON.parse(str); } catch(e) {}
      }
      return arr;
    }

    // ============ 匯出文字函式 ============
    function generateExportText() {
      let text = '=== 所有影片清單 (UTF-8) ===\n\n';
      const grouped = {};
      allVideos.forEach(v => {
        if (!grouped[v.category]) grouped[v.category] = [];
        grouped[v.category].push(v);
      });
      // 依 allCategories 順序輸出
      allCategories.forEach(cat => {
        if (grouped[cat] && grouped[cat].length > 0) {
          text += `【${cat}】\n`;
          grouped[cat].forEach((vid, idx) => {
            // 把ID轉成短網址 https://youtu.be/xxxx
            const url = `https://youtu.be/${encodeURIComponent(vid.id)}`;
            text += `  ${idx+1}. ${vid.title} (URL: ${url})\n`;
          });
          text += '\n';
        }
      });
      return text;
    }

    // ============ 解析ID函式 ============
    function parseYouTubeId(input) {
      // 若是直接 11 碼(或更多)的 ID
      if (/^[a-zA-Z0-9_-]{11,}$/.test(input)) {
        return input;
      }
      // 短網址 youtu.be/xxxx
      const regShort = /youtu\.be\/([^?]+)/;
      const matchShort = input.match(regShort);
      if (matchShort && matchShort[1]) return matchShort[1];

      // 長網址 watch?v=xxxx
      const regLong = /v=([^&]+)/;
      const matchLong = input.match(regLong);
      if (matchLong && matchLong[1]) return matchLong[1];

      return null;
    }
  </script>
</body>
</html>
