<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Office Error Analyzer â€“ æ¨¡æ…‹çª—ç‰ˆ</title>
  <!-- æ”¹ç”¨ markmap-view CDN -->
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.0/dist/browser/index.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";
      margin: 0; background: #f9fafb; color: #333;
    }
    header {
      background: #1e293b; color: #fff; padding: 1rem; font-weight: 700;
    }
    main {
      max-width: 960px; margin: auto; padding: 1.5rem;
    }
    label {
      display: block; font-size: .9rem; color: #475569; margin-top: .75rem;
    }
    textarea, input, button {
      font: inherit;
    }
    textarea {
      width: 100%; padding: .5rem;
      border: 1px solid #cbd5e1; border-radius: 4px;
      resize: vertical;
    }
    input[type="text"] {
      width: 100%; padding: .5rem;
      border: 1px solid #cbd5e1; border-radius: 4px;
    }
    .row {
      display: flex; gap: .5rem; margin: .5rem 0; flex-wrap: wrap;
    }
    button {
      cursor: pointer; border: none;
      padding: .6rem 1rem; border-radius: 4px; font-weight: 600;
    }
    button.primary {
      background: #2563eb; color: #fff;
    }
    button.outline {
      background: #fff; border: 1px solid #2563eb; color: #2563eb;
    }
    details {
      margin-top: .5rem; border: 1px solid #cbd5e1;
      border-radius: 4px; padding: .5rem;
    }
    summary {
      cursor: pointer; font-weight: 600;
    }
    pre {
      background: #e2e8f0; padding: 1rem; border-radius: 6px;
      overflow: auto; white-space: pre-wrap;
    }

    /* æ¨¡æ…‹çª—æ¨£å¼ */
    .modal {
      display: none; /* é è¨­éš±è— */
      position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff; margin: 3% auto;
      padding: 1rem; border-radius: 6px;
      width: 90%; max-width: 800px;
      height: 80%; overflow: hidden;
      position: relative;
    }
    .close {
      position: absolute; top: 0.5rem; right: 1rem;
      font-size: 2rem; font-weight: bold; color: #555;
      cursor: pointer;
    }
    #mindmap {
      width: 100%; height: 100%;
    }
  </style>
</head>
<body>
  <header>ğŸ“ è¾¦å…¬å®¤éŒ¯èª¤åˆ†æï¼ˆæ¨¡æ…‹çª—ç‰ˆï¼‰</header>
  <main>
    <label for="error">è¼¸å…¥éŒ¯èª¤äº‹ä»¶ï¼ˆå–®è¡Œï¼‰</label>
    <textarea id="error" rows="2" placeholder="ä¾‹ï¼šç™¼ç¥¨å¤§å¯«æ•¸å­—é–‹éŒ¯ï¼Œå®¢æˆ¶è¦æ±‚é‡é–‹"></textarea>

    <div class="row">
      <button class="primary" id="btn-api">API ç›´æ¥åˆ†æ</button>
      <button class="outline" id="btn-prompt">ç”¢ç”Ÿ Prompt (æ‰‹å‹•å» LLM è²¼)</button>
    </div>

    <details>
      <summary>ğŸ” API è¨­å®š (å¯é¸)</summary>
      <label for="provider">Provider (gpt / grok)</label>
      <input type="text" id="provider" placeholder="gpt" value="gpt">
      <label for="apikey">API Key</label>
      <input type="text" id="apikey" placeholder="sk-...">
    </details>

    <h3>ğŸ“¤ LLM Prompt</h3>
    <pre id="promptArea">(é»ã€Œç”¢ç”Ÿ Promptã€å¾Œé¡¯ç¤º)</pre>

    <h3>ğŸ“¥ è²¼å› JSONï¼ˆå¯å¤šè¡Œï¼å¤¾é›œ ```code```ï¼‰</h3>
    <label for="jsonInput">æŠŠ ChatGPT/Grok å›å‚³çš„ JSON è²¼åœ¨é€™ï¼š</label>
    <textarea id="jsonInput" rows="6" placeholder="è²¼ä¸Šå¤šè¡Œ JSONâ€¦"></textarea>
    <button class="primary" id="btn-render">æ¸²æŸ“æ€ç¶­å°åœ–</button>
  </main>

  <!-- æ¨¡æ…‹çª— -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="modalClose">&times;</span>
      <svg id="mindmap"></svg>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    // åˆ‡åˆ†æ¨™é»æˆ Markdown å­å½ˆ
    const splitBullets = txt =>
      txt.split(/[ï¼Œ,ã€ï¼›;ï¼ã€‚.]/).filter(Boolean)
         .map(t => '- ' + t.trim()).join('\n');

    // å»º LLM Prompt
    function buildPrompt(sentence) {
      return `ä½ æ˜¯è¾¦å…¬å®¤æµç¨‹ QA å°ˆå®¶ã€‚\n` +
             `æ ¹æ“šã€Œ${sentence}ã€ï¼Œå›å‚³ JSONï¼š\n` +
             `{\n  "reason":"â€¦",\n  "consequence":"â€¦",\n` +
             `  "mitigation":"â€¦",\n  "stakeholders":"â€¦",\n` +
             `  "bestFix":"â€¦" \n}\n` +
             `åƒ…è¼¸å‡º JSONï¼Œä¸è¦å¤šé¤˜æ–‡å­—ã€‚`;
    }

    // é¡¯ç¤º & é–‹å•Ÿæ¨¡æ…‹çª—
    function openModal() {
      $('#modal').style.display = 'block';
    }
    // é—œé–‰æ¨¡æ…‹çª—
    function closeModal() {
      $('#modal').style.display = 'none';
    }

    // æ¸²æŸ“æ€ç¶­å°åœ–åˆ° #mindmap è£¡ï¼Œä¸¦é–‹å•Ÿæ¨¡æ…‹çª—
    function renderMindMap(sentence, obj) {
      const md = `# ${sentence}
## åŸå› 
${splitBullets(obj.reason)}
## å¾Œæœ
${splitBullets(obj.consequence)}
## æ”¹å–„æ–¹æ¡ˆ
${splitBullets(obj.mitigation)}
## é—œè¯äººå“¡
${splitBullets(obj.stakeholders)}
## æœ€å„ªè§£
- ${obj.bestFix}`;
      $('#mindmap').innerHTML = '';
      // markmap-view å…¨åŸŸç‰©ä»¶
      window.markmap.Markmap.create('#mindmap', null, md);
      localStorage.setItem('lastError', JSON.stringify({ sentence, obj }));
      openModal();
    }

    // ç”¢ç”Ÿ Prompt
    $('#btn-prompt').onclick = () => {
      const s = $('#error').value.trim();
      if (!s) return alert('å…ˆå¡«éŒ¯èª¤æè¿°å•¦ï¼');
      $('#promptArea').textContent = buildPrompt(s);
    };

    // è²¼ JSON ä¸¦è§£æ
    $('#btn-render').onclick = () => {
      let raw = $('#jsonInput').value || '';
      raw = raw.trim();
      if (!raw) return alert('å…ˆè²¼ JSON å†æŒ‰é€™ï¼');

      // æ¸…ç†é›œè¨Š
      raw = raw.replace(/```[\s\S]*?```/g, '').trim();
      const first = raw.indexOf('{'), last = raw.lastIndexOf('}');
      if (first !== -1 && last > first) raw = raw.substring(first, last + 1);
      raw = raw.replace(/[;, \t\r\n]+$/g, '').replace(/^\uFEFF/, '');

      try {
        const obj = JSON.parse(raw);
        renderMindMap($('#error').value.trim(), obj);
        // åŒæ­¥å¡«å›ä¹¾æ·¨ JSON
        $('#jsonInput').value = JSON.stringify(obj, null, 2);
      } catch (e) {
        console.log('â€” Cleaned JSON to parse â€”\n', raw);
        console.error('ğŸ”¥ JSON parse error â†’', e);
        alert(
          `JSON è§£æå¤±æ•—ï¼š${e.message}\n\n` +
          `æ¸…ç†å¾Œå…§å®¹ï¼ˆå‰200å­—ï¼‰ï¼š\n${raw.substring(0,200)}${raw.length>200?'â€¦':''}`
        );
      }
    };

    // å‘¼å« LLM API
    async function callLLM(sentence, provider, key) {
      if (!key) throw new Error('API Key ä¸å¯ç©ºï¼');
      if (provider === 'gpt') {
        const body = {
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: 'ä½ æ˜¯è¾¦å…¬å®¤æµç¨‹ QA å°ˆå®¶ï¼Œè¼¸å‡º JSONã€‚' },
            { role: 'user', content: sentence }
          ],
          response_format: { type: 'json_object' }
        };
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${key}`
          },
          body: JSON.stringify(body)
        });
        const j = await res.json();
        return JSON.parse(j.choices[0].message.content);
      } else if (provider === 'grok') {
        const body = {
          model: 'grok-1',
          messages: [
            { role: 'system', content: 'ä½ æ˜¯è¾¦å…¬å®¤æµç¨‹ QA å°ˆå®¶ï¼Œè¼¸å‡º JSONã€‚' },
            { role: 'user', content: sentence }
          ]
        };
        const res = await fetch('https://api.grok.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${key}`
          },
          body: JSON.stringify(body)
        });
        const j = await res.json();
        return JSON.parse(j.choices[0].message.content);
      } else {
        throw new Error('ä¸æ”¯æ´çš„ provider');
      }
    }

    // API ç›´é€£è§¸ç™¼
    $('#btn-api').onclick = async () => {
      const s = $('#error').value.trim();
      if (!s) return alert('å…ˆå¡«éŒ¯èª¤æè¿°å•¦ï¼');
      const p = $('#provider').value.trim();
      const k = $('#apikey').value.trim();
      $('#promptArea').textContent = 'â³ åˆ†æä¸­â€¦';
      try {
        const obj = await callLLM(s, p, k);
        $('#promptArea').textContent = JSON.stringify(obj, null, 2);
        $('#jsonInput').value   = JSON.stringify(obj, null, 2);
        renderMindMap(s, obj);
      } catch (err) {
        console.error(err);
        alert('LLM å‘¼å«å¤±æ•—ï¼ŒCORS æˆ– Key æœ‰å•é¡Œï¼Ÿ');
      }
    };

    // é—œé–‰æ¨¡æ…‹çª—æŒ‰éˆ•
    $('#modalClose').onclick = closeModal;
    // é»èƒŒæ™¯ä¹Ÿé—œ
    window.onclick = e => {
      if (e.target.id === 'modal') closeModal();
    };

    // è¼‰å…¥ä¸Šæ¬¡ç´€éŒ„
    window.addEventListener('DOMContentLoaded', () => {
      const last = localStorage.getItem('lastError');
      if (last) {
        const { sentence, obj } = JSON.parse(last);
        $('#error').value     = sentence;
        $('#jsonInput').value = JSON.stringify(obj, null, 2);
        renderMindMap(sentence, obj);
      }
    });
  </script>
</body>
</html>