<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Office Error Analyzer â€“ Frontâ€‘End Only</title>
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.0/dist/browser/index.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue";margin:0;background:#f9fafb;color:#333}
    header{background:#1e293b;color:#fff;padding:1rem;font-weight:700}
    main{max-width:960px;margin:auto;padding:1.5rem}
    textarea,input,button{font:inherit}
    textarea{width:100%;height:5rem;padding:.5rem;resize:vertical;border:1px solid #cbd5e1;border-radius:4px}
    input[type=text]{width:100%;padding:.4rem;border:1px solid #cbd5e1;border-radius:4px}
    .row{display:flex;gap:.5rem;margin:.5rem 0}
    button{cursor:pointer;border:none;padding:.6rem 1rem;border-radius:4px;font-weight:600}
    button.primary{background:#2563eb;color:#fff}
    button.outline{background:#fff;border:1px solid #2563eb;color:#2563eb}
    #mindmap-wrap{border:1px solid #cbd5e1;border-radius:6px;margin-top:1rem;min-height:500px;overflow:hidden;background:#fff}
    pre{background:#e2e8f0;padding:1rem;border-radius:6px;overflow:auto}
    label{font-size:.85rem;color:#475569;font-weight:600}
  </style>
</head>
<body>
  <header>ğŸ“ è¾¦å…¬å®¤éŒ¯èª¤åˆ†æï¼ˆå‰ç«¯ç‰ˆï¼‰</header>
  <main>
    <label for="error">è¼¸å…¥éŒ¯èª¤äº‹ä»¶ï¼ˆå–®è¡Œï¼‰</label>
    <textarea id="error" placeholder="ä¾‹ï¼šç™¼ç¥¨å¤§å¯«æ•¸å­—é–‹éŒ¯ï¼Œå®¢æˆ¶è¦æ±‚é‡é–‹"></textarea>

    <div class="row">
      <button class="primary" id="btn-api">API ç›´æ¥åˆ†æ</button>
      <button class="outline" id="btn-prompt">ç”¢ç”Ÿ Prompt (æ‰‹å‹•)</button>
      <button class="outline" id="btn-paste">è²¼å› LLM JSON â†’ ç•«åœ–</button>
    </div>

    <details>
      <summary>ğŸ” API è¨­å®š (å¯é¸)</summary>
      <label>Provider (gpt / grok)</label>
      <input type="text" id="provider" placeholder="gpt" value="gpt">
      <label>API Key</label>
      <input type="text" id="apikey" placeholder="sk-..." />
    </details>

    <h3>ğŸ“¤ LLM Prompt / ğŸ“¥ å›å‚³ JSON</h3>
    <pre id="promptArea">(é€™è£¡æœƒç”¢ç”Ÿ prompt æˆ–è²¼å› JSON)</pre>

    <h3>ğŸ—ºï¸ MindMap</h3>
    <div id="mindmap-wrap">
      <svg id="mindmap" style="width:100%;height:100%"></svg>
    </div>
  </main>

  <script>
    /* ---------- å°å·¥å…· ---------- */
    const $ = (q) => document.querySelector(q)
    const splitBullets = (txt) =>
      txt.split(/[ï¼Œ,ã€ï¼›;ï¼ã€‚.]/).filter(Boolean).map((t) => `- ${t.trim()}`).join('\n')

    /* ---------- Prompt æ¨¡æ¿ ---------- */
    function buildPrompt(sentence) {
      return `ä½ æ˜¯è¾¦å…¬å®¤æµç¨‹ QA å°ˆå®¶ã€‚\næ ¹æ“šä»¥ä¸‹ã€ŒéŒ¯èª¤æè¿°ã€ï¼Œå›å‚³æ­¤ JSONï¼š\n{\n  "reason": "...",\n  "consequence": "...",\n  "mitigation": "...",\n  "stakeholders": "...",\n  "bestFix": "..." \n}\nåƒ…è¼¸å‡º JSONï¼Œä¸è¦åŠ è¨»è§£ã€‚\néŒ¯èª¤æè¿°ï¼šã€Œ${sentence}ã€`
    }

    /* ---------- Markdown -> Markmap ---------- */
    let mm // markmap instance
    function renderMindMap(sentence, obj) {
      const md = `# ${sentence}
## åŸå› 
${splitBullets(obj.reason)}
## å¾Œæœ
${splitBullets(obj.consequence)}
## æ”¹å–„æ–¹æ¡ˆ
${splitBullets(obj.mitigation)}
## é—œè¯äººå“¡
${splitBullets(obj.stakeholders)}
## æœ€å„ªè§£
- ${obj.bestFix}
`
      // remove old svg
      $('#mindmap').innerHTML = ''
      mm = window.markmap.Markmap.create('#mindmap', null, md)
      /* æœ¬åœ°ç´€éŒ„ */
      localStorage.setItem('lastError', JSON.stringify({ sentence, obj }))
    }

    /* ---------- æ‰‹å‹•æµç¨‹ ---------- */
    $('#btn-prompt').onclick = () => {
      const sentence = $('#error').value.trim()
      if (!sentence) return alert('å…ˆå¡«éŒ¯èª¤å•¦ï¼')
      const prompt = buildPrompt(sentence)
      $('#promptArea').textContent = prompt
    }

    $('#btn-paste').onclick = () => {
      const raw = prompt('è²¼ä¸Š GPT/Grok å›å‚³çš„ JSONï¼š')
      if (!raw) return
      try {
        const obj = JSON.parse(raw)
        renderMindMap($('#error').value.trim(), obj)
        $('#promptArea').textContent = raw
      } catch (e) {
        alert('JSON è§£æå¤±æ•—ï¼Œç¢ºèªæ ¼å¼ï¼')
      }
    }

    /* ---------- API ç›´é€£ ---------- */
    async function callLLM(sentence, provider, key) {
      if (provider === 'gpt') {
        const body = {
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: 'ä½ æ˜¯è¾¦å…¬å®¤æµç¨‹ QA å°ˆå®¶ï¼Œè¼¸å‡º JSONã€‚' },
            { role: 'user', content: sentence }
          ],
          response_format: { type: 'json_object' }
        }
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${key}`
          },
          body: JSON.stringify(body)
        })
        const data = await res.json()
        return JSON.parse(data.choices[0].message.content)
      } else if (provider === 'grok') {
        const body = {
          model: 'grok-1',
          messages: [
            { role: 'system', content: 'ä½ æ˜¯è¾¦å…¬å®¤æµç¨‹ QA å°ˆå®¶ï¼Œè¼¸å‡º JSONã€‚' },
            { role: 'user', content: sentence }
          ]
        }
        const res = await fetch('https://api.grok.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${key}`
          },
          body: JSON.stringify(body)
        })
        const data = await res.json()
        return JSON.parse(data.choices[0].message.content)
      } else {
        throw new Error('Unknown provider')
      }
    }

    $('#btn-api').onclick = async () => {
      const sentence = $('#error').value.trim()
      if (!sentence) return alert('å…ˆå¡«éŒ¯èª¤å•¦ï¼')
      const provider = $('#provider').value.trim() || 'gpt'
      const key = $('#apikey').value.trim()
      if (!key) return alert('è«‹å¡« API Keyï¼')
      $('#promptArea').textContent = 'â³ LLM åˆ†æä¸­â€¦'
      try {
        const obj = await callLLM(sentence, provider, key)
        $('#promptArea').textContent = JSON.stringify(obj, null, 2)
        renderMindMap(sentence, obj)
      } catch (err) {
        console.error(err)
        alert('å‘¼å« LLM å¤±æ•—ï¼ç€è¦½å™¨ CORS or Key éŒ¯ï¼Ÿ')
      }
    }

    /* ---------- è®€å–ä¸Šæ¬¡ ---------- */
    window.addEventListener('DOMContentLoaded', () => {
      const last = localStorage.getItem('lastError')
      if (last) {
        const { sentence, obj } = JSON.parse(last)
        $('#error').value = sentence
        renderMindMap(sentence, obj)
      }
    })
  </script>
</body>
</html>