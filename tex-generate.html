<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>TeX æª”æ¡ˆç”Ÿæˆå™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- å¼•å…¥ Google å­—é«”ã€Font Awesome å’Œ MathJax -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>TeX æª”æ¡ˆç”Ÿæˆå™¨</h1>
      <button id="toggle-theme" class="tooltip" aria-label="åˆ‡æ›æ·±æ·ºæ¨¡å¼">
        <i class="fas fa-moon"></i>
        <span class="tooltiptext">åˆ‡æ›æ·±æ·ºæ¨¡å¼</span>
      </button>

      <!-- è§£é‡‹å€å¡Š -->
      <div id="explanation">
        <h3>å€å¡Šé¡å‹èªªæ˜</h3>
        <p>
          <strong>é¡Œç›® (Example)ï¼š</strong> ç”¨æ–¼è¼¸å…¥é¡Œç›®çš„å…§å®¹ï¼Œæœƒè¢«åŒ…è£¹åœ¨
          <code>\\begin{Example}</code> å’Œ <code>\\end{Example}</code> ç’°å¢ƒä¸­ã€‚
        </p>
        <p>
          <strong>è§£ç­” (Answer)ï¼š</strong> ç”¨æ–¼è¼¸å…¥é¡Œç›®çš„è§£ç­”ï¼Œæœƒè¢«åŒ…è£¹åœ¨
          <code>\\begin{Answer}</code> å’Œ <code>\\end{Answer}</code> ç’°å¢ƒä¸­ã€‚
        </p>
        <p>
          <strong>ç¯€ (Section)ï¼š</strong> ç”¨æ–¼å»ºç«‹æ–°çš„ç« ç¯€ï¼Œè«‹è¼¸å…¥é¡ä¼¼
          <code>2. äºŒæ¬¡å°æ•¸æ¸¬è©¦</code> çš„æ ¼å¼ã€‚
        </p>
        <p>
          <strong>å°ç¯€ (Subsection)ï¼š</strong> ç”¨æ–¼å»ºç«‹æ–°çš„å°ç¯€ï¼Œè«‹è¼¸å…¥é¡ä¼¼
          <code>2.1 å°ç¯€æ¨™é¡Œ</code> çš„æ ¼å¼ã€‚
        </p>
        <p>
          <strong>å…¶ä»– (Other)ï¼š</strong>
          ç”¨æ–¼è¼¸å…¥å…¶ä»–è‡ªå®šç¾©çš„å…§å®¹ï¼Œä¸æœƒè¢«åŒ…è£¹åœ¨ä»»ä½•ç’°å¢ƒä¸­ï¼Œæ‚¨å¯ä»¥ç›´æ¥è¼¸å…¥ LaTeX
          ä»£ç¢¼ã€‚
        </p>
      </div>

      <!-- å…ƒè³‡æ–™å€å¡Š -->
      <div id="metadata">
        <h3>æ–‡ä»¶å…ƒè³‡æ–™</h3>
        <label for="title">æ¨™é¡Œ (Title)ï¼š</label>
        <input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šç·šæ€§ä»£æ•¸ç¿’é¡Œè§£ç­”" />
        <label for="author">ä½œè€… (Author)ï¼š</label>
        <input type="text" id="author" placeholder="ä¾‹å¦‚ï¼šæ—å°æ˜" />
        <label for="email">é›»å­éƒµä»¶ (Email)ï¼š</label>
        <input
          type="text"
          id="email"
          placeholder="ä¾‹å¦‚ï¼šlinxiaoming@example.com"
        />
        <label for="affiliation">å–®ä½ (Affiliation)ï¼š</label>
        <input
          type="text"
          id="affiliation"
          value="æ±æµ·æ•¸å­¸ç³»"
          placeholder="ä¾‹å¦‚ï¼šæ±æµ·æ•¸å­¸ç³»"
        />
        <label for="date">æ—¥æœŸ (Date)ï¼š</label>
        <input
          type="text"
          id="date"
          value="\today"
          placeholder="ä¾‹å¦‚ï¼š2024å¹´4æœˆ27æ—¥ æˆ– \today"
        />
      </div>

      <!-- å€å¡Šåˆ—è¡¨ -->
      <div id="blocks">
        <!-- å€å¡Šå°‡è¢«æ·»åŠ åˆ°é€™è£¡ -->
      </div>

      <!-- æ–°å¢å€å¡ŠæŒ‰éˆ• -->
      <button id="add-block" class="btn tooltip" aria-label="æ–°å¢å€å¡Š">
        â• æ–°å¢å€å¡Š
        <span class="tooltiptext">é»æ“Šæ–°å¢ä¸€å€‹æ–°çš„å€å¡Š</span>
      </button>

      <!-- ç”Ÿæˆçš„ TeX å…§å®¹ -->
      <h2>ç”Ÿæˆçš„ TeX å…§å®¹ï¼š</h2>
      <div id="tex-output-container">
        <!-- æ¨™é ­æ¬„ä½ -->
        <div id="tex-output-header">
          <input type="text" id="tex-filename" placeholder="ä¾‹å¦‚ï¼šé¡Œç›®.tex" />
        </div>
        <!-- ç¨‹å¼ç¢¼å€å¡Š -->
        <div class="copy-button-container">
          <pre><code id="tex-output" class="language-tex" readonly></code></pre>
          <!-- è¤‡è£½æŒ‰éˆ• -->
          <button id="copy-tex" class="tooltip" aria-label="è¤‡è£½ TeX å…§å®¹">
            <i class="fas fa-copy copy-icon"></i>
            <span class="copy-text">è¤‡è£½</span>
            <span class="tooltiptext">å°‡ TeX å…§å®¹è¤‡è£½åˆ°å‰ªè²¼ç°¿</span>
          </button>
        </div>
      </div>
      <!-- ä¸‹è¼‰ TeX æª”æ¡ˆæŒ‰éˆ• -->
      <button id="download-tex" class="btn tooltip" aria-label="ä¸‹è¼‰ TeX æª”æ¡ˆ">
        ğŸ’¾ ä¸‹è¼‰ TeX æª”æ¡ˆ
        <span class="tooltiptext">å°‡ç”Ÿæˆçš„ TeX å…§å®¹ä¸‹è¼‰ç‚º TeX æª”æ¡ˆ</span>
      </button>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

    <!-- JavaScript ç¨‹å¼ç¢¼ -->
    <script>
      let blockCount = 0;
      let draggedBlock = null;
      let placeholderExamples = {
        Example: "è«‹è¼¸å…¥é¡Œç›®ï¼Œä¾‹å¦‚ï¼š\n\næ±‚å¾®åˆ†æ–¹ç¨‹ \\( y' = y \\) çš„é€šè§£ã€‚",
        Answer:
          "è«‹è¼¸å…¥è§£ç­”ï¼Œä¾‹å¦‚ï¼š\n\né€šè§£ç‚º \\( y = Ce^{x} \\)ï¼Œå…¶ä¸­ \\( C \\) ç‚ºä»»æ„å¸¸æ•¸ã€‚",
        Section: "è«‹è¼¸å…¥ç« ç¯€æ¨™é¡Œï¼Œä¾‹å¦‚ï¼š2. äºŒæ¬¡å°æ•¸æ¸¬è©¦",
        Subsection: "è«‹è¼¸å…¥å°ç¯€æ¨™é¡Œï¼Œä¾‹å¦‚ï¼š2.1 å°ç¯€æ¨™é¡Œ",
        Other: "è«‹è¼¸å…¥å…¶ä»–å…§å®¹ï¼Œæ‚¨å¯ä»¥è¼¸å…¥ä»»ä½• LaTeX ä»£ç¢¼ã€‚",
      };

      // åŠ è¼‰æœ¬åœ°å„²å­˜çš„è³‡æ–™
      function loadFromLocalStorage() {
        // åŠ è¼‰å…ƒè³‡æ–™
        const metadata = JSON.parse(
          localStorage.getItem("texGeneratorMetadata")
        );
        if (metadata) {
          document.getElementById("title").value = metadata.title || "";
          document.getElementById("author").value = metadata.author || "";
          document.getElementById("email").value = metadata.email || "";
          document.getElementById("affiliation").value =
            metadata.affiliation || "";
          document.getElementById("date").value = metadata.date || "";
        }

        // åŠ è¼‰å€å¡Š
        const blocks = JSON.parse(localStorage.getItem("texGeneratorBlocks"));
        if (blocks && blocks.length > 0) {
          document.getElementById("blocks").innerHTML = "";
          blockCount = 0;
          for (let i = 0; i < blocks.length; i++) {
            const blockData = blocks[i];
            addBlock(blockData.type, blockData.content);
          }
        } else {
          // å¦‚æœæ²’æœ‰å€å¡Šï¼Œæ–°å¢ä¸€å€‹
          addBlock();
        }
        updateTeX();
      }

      // ä¿å­˜è³‡æ–™åˆ°æœ¬åœ°å„²å­˜
      function saveToLocalStorage() {
        // ä¿å­˜å…ƒè³‡æ–™
        const metadata = {
          title: document.getElementById("title").value,
          author: document.getElementById("author").value,
          email: document.getElementById("email").value,
          affiliation: document.getElementById("affiliation").value,
          date: document.getElementById("date").value,
        };
        localStorage.setItem("texGeneratorMetadata", JSON.stringify(metadata));

        // ä¿å­˜å€å¡Š
        const blocks = [];
        const blockElements = document.getElementsByClassName("block");
        for (let i = 0; i < blockElements.length; i++) {
          const select = blockElements[i].getElementsByTagName("select")[0];
          const textarea = blockElements[i].getElementsByTagName("textarea")[0];
          blocks.push({
            type: select.value,
            content: textarea.value,
          });
        }
        localStorage.setItem("texGeneratorBlocks", JSON.stringify(blocks));
      }

      function addBlock(type = "Example", content = "") {
        blockCount++;

        const blockDiv = document.createElement("div");
        blockDiv.className = "block";
        blockDiv.id = "block-" + blockCount;

        // æ¨™é¡Œåˆ—
        const topRow = document.createElement("div");
        topRow.className = "block-header";
        topRow.setAttribute("draggable", true);

        // æ¨™ç±¤
        const label = document.createElement("label");
        label.textContent = "å€å¡Š " + blockCount + ":";

        // ç§»é™¤å€å¡ŠæŒ‰éˆ•
        const removeButton = document.createElement("button");
        removeButton.className = "remove-block tooltip";
        removeButton.setAttribute("aria-label", "ç§»é™¤å€å¡Š");
        removeButton.innerHTML = "âœ–";
        const removeTooltip = document.createElement("span");
        removeTooltip.className = "tooltiptext";
        removeTooltip.innerText = "ç§»é™¤æ­¤å€å¡Š";
        removeButton.appendChild(removeTooltip);
        removeButton.onclick = function () {
          document.getElementById("blocks").removeChild(blockDiv);
          updateBlockLabels();
          updateTeX();
          saveToLocalStorage();
        };

        // çµ„è£æ¨™é¡Œåˆ—
        topRow.appendChild(label);
        topRow.appendChild(removeButton);

        // é¸æ“‡æ¡†
        const select = document.createElement("select");
        select.innerHTML = `
                        <option value="Example">é¡Œç›® (Example)</option>
                        <option value="Answer">è§£ç­” (Answer)</option>
                        <option value="Section">ç¯€ (Section)</option>
                        <option value="Subsection">å°ç¯€ (Subsection)</option>
                        <option value="Other">å…¶ä»– (Other)</option>
                    `;
        select.value = type;
        select.onchange = function () {
          const currentValue = select.value;
          textarea.readOnly = false;
          if (currentValue === "Section") {
            textarea.placeholder = "ä¾‹å¦‚ï¼š2. äºŒæ¬¡å°æ•¸æ¸¬è©¦";
          } else if (currentValue === "Subsection") {
            textarea.placeholder = "ä¾‹å¦‚ï¼š2.1 å°ç¯€æ¨™é¡Œ";
          } else {
            textarea.placeholder = placeholderExamples[currentValue];
          }
          updateTeX();
          updateMathPreview(textarea.value, mathPreview);
          saveToLocalStorage();
        };

        // æ–‡å­—è¼¸å…¥æ¡†
        const textarea = document.createElement("textarea");
        textarea.placeholder = placeholderExamples[select.value];
        textarea.value = content;
        textarea.classList.add("collapsed"); // åˆå§‹åŒ–ç‚ºæ”¶æŠ˜ç‹€æ…‹
        textarea.addEventListener("input", autoResize, false);

        // æ”¶æŠ˜åŠŸèƒ½
        textarea.addEventListener("focus", function () {
          // å±•é–‹
          textarea.classList.remove("collapsed");
        });
        textarea.addEventListener("blur", function () {
          // æ”¶æŠ˜
          textarea.classList.add("collapsed");
        });

        // å…§å®¹è¼¸å…¥æ™‚æ›´æ–° TeX å’Œæ•¸å­¸é è¦½
        textarea.addEventListener("input", function () {
          updateTeX();
          updateMathPreview(textarea.value, mathPreview);
          saveToLocalStorage();
        });

        // æ•¸å­¸é è¦½å€
        const mathPreview = document.createElement("div");
        mathPreview.className = "math-preview";

        // çµ„è£å€å¡Š
        blockDiv.appendChild(topRow);
        blockDiv.appendChild(select);
        blockDiv.appendChild(textarea);
        blockDiv.appendChild(mathPreview);

        // åŠ å…¥æ‹–æ”¾äº‹ä»¶åˆ° topRow
        topRow.addEventListener("dragstart", function (e) {
          draggedBlock = blockDiv;
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", blockDiv.id);
        });

        blockDiv.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          blockDiv.style.boxShadow = "0 0 10px var(--button-bg-color)";
        });

        blockDiv.addEventListener("dragleave", function (e) {
          blockDiv.style.boxShadow = "none";
        });

        blockDiv.addEventListener("drop", function (e) {
          e.preventDefault();
          blockDiv.style.boxShadow = "none";

          const draggedId = e.dataTransfer.getData("text/plain");
          const draggedBlock = document.getElementById(draggedId);

          if (draggedBlock && draggedBlock !== blockDiv) {
            const blocksContainer = document.getElementById("blocks");
            blocksContainer.insertBefore(draggedBlock, blockDiv);
            updateBlockLabels();
            updateTeX();
            saveToLocalStorage();
          }

          draggedBlock = null;
        });

        // æ·»åŠ åˆ°å€å¡Šå®¹å™¨
        document.getElementById("blocks").appendChild(blockDiv);

        // æ›´æ–°å€å¡Šæ¨™ç±¤å’Œ TeX
        updateBlockLabels();
        updateTeX();
      }

      function updateBlockLabels() {
        const blocks = document.getElementById("blocks").children;
        blockCount = blocks.length;
        for (let i = 0; i < blocks.length; i++) {
          const label = blocks[i].querySelector(".block-header label");
          label.textContent = "å€å¡Š " + (i + 1) + ":";

          const select = blocks[i].getElementsByTagName("select")[0];
          const textarea = blocks[i].getElementsByTagName("textarea")[0];

          textarea.readOnly = false;
          if (select.value === "Section") {
            textarea.placeholder = "ä¾‹å¦‚ï¼š2. äºŒæ¬¡å°æ•¸æ¸¬è©¦";
          } else if (select.value === "Subsection") {
            textarea.placeholder = "ä¾‹å¦‚ï¼š2.1 å°ç¯€æ¨™é¡Œ";
          } else {
            textarea.placeholder = placeholderExamples[select.value];
          }
        }
      }

      function updateTeX() {
        // å–å¾—æª”å
        let texFilename = document.getElementById("tex-filename").value.trim();
        if (!isFilenameManuallyEdited) {
          texFilename =
            document.getElementById("title").value.trim() !== ""
              ? document.getElementById("title").value.trim()
              : "output";
          document.getElementById("tex-filename").value = texFilename;
        }

        // ç¢ºä¿æª”åä»¥ .tex çµå°¾
        if (!texFilename.toLowerCase().endsWith(".tex")) {
          texFilename += ".tex";
        }

        // TeX æ¨¡æ¿çš„é–‹é ­
        let texContent = `% !Mode:: "TeX:UTF-8"
\\documentclass[12pt]{article}
\\usepackage{amsmath}%æ•¸å­¸ç¬¦è™Ÿ1
\\usepackage{CJKutf8}%ä¸­æ–‡è¡¨æ ¼
\\usepackage{amssymb}%æ•¸å­¸ç¬¦è™Ÿ2
\\usepackage{lmodern}%å­—å‹å¤§å°
\\usepackage{amsfonts}%æ•¸å­¸å­—å‹
\\usepackage{natbib}%åƒè€ƒæ–‡ç»
\\usepackage{graphics}%åœ–å‹
\\usepackage{epsfig}%EPSåœ–å‹
\\usepackage{subfigure}
\\usepackage{graphicx}
\\usepackage{fancybox}
\\usepackage{url}%è¼¸å…¥ç¶²å€
\\usepackage{tikz}
\\usepackage[lastexercise]{exercise}
\\usepackage{chngcntr}
\\usepackage{tcolorbox}
\\usepackage{listings}
\\usepackage{multirow}%å¤šåˆ—è¡¨æ ¼
\\usepackage[para,online,flushleft]{threeparttable}%è¡¨æ ¼è¨»è§£
\\usepackage{rotating}%è¡¨æ ¼æ—‹è½‰
\\usepackage{dcolumn}%è®“è¡¨æ ¼å°æ•¸é»å°é½Š
\\usepackage{caption}

%\\usepackage[table]{xcolor}

\\newcommand{\\gfcb}[1]{%
\\fcolorbox{white}{gray!10!}{\\quad\\strut #1\\quad}
} % gfcb := gray fcolorbox
\\newcommand{\\cop}[1]{%
\\gfcb{\\texttt{\\detokenize{#1}}} 
\\ensuremath{\\quad\\longrightarrow\\quad #1}
} % cop := code output

\\tcbset{arc=0mm,boxrule=1pt,colback=white,colframe=cyan,leftrule=3mm}
%\\usetikzlibrary{decorations.pathreplacing}
\\usepackage{float}
\\newtheorem{example}{Example}[subsection]
\\newtheorem{defin}{Definition}
\\usepackage{setspace} 
\\renewcommand{\\figurename}{åœ–}
\\renewcommand{\\tablename}{è¡¨}
\\renewcommand\\refname{åƒè€ƒæ–‡ç»}
%\\linespread{1.5}
%\\setcounter{section}{12}
\\renewcommand{\\abstractname}{æ‘˜è¦}
\\definecolor{bisque}{rgb}{.996,.891,.755}
\\definecolor{mypink}{cmyk}{.1,.8,.4,.1}  % cmyk æ¨¡å‹çš„ä¾‹å­ 
\\definecolor{Gray}{gray}{0.85}
\\definecolor{LightCyan}{rgb}{0.88,1,1}

\\newcolumntype{a}{>{\\columncolor{Gray}}c}
\\newcolumntype{b}{>{\\columncolor{white}}c}
%=============================================================================

\\title{${document.getElementById("title").value.trim()}}

\\author{${document.getElementById("author").value.trim()}\\footnote{${document
          .getElementById("email")
          .value.trim()}}\\\\
${document.getElementById("affiliation").value.trim()}.\\\\
%, å§“å\\footnote{é€£çµ¡è³‡è¨Šèˆ‡ç ”ç©¶å–®ä½}
%, ç ”ç©¶å–®ä½.\\\\
}

\\date{${document.getElementById("date").value.trim()}}

\\renewcommand{\\theExercise}{\\arabic{Exercise}}
\\renewcommand{\\AnswerHeader}{\\medskip\\noindent\\textcolor{red}{\\textbf{SOLUTION}}\\;}
\\renewcommand{\\ExerciseName}{EXAMPLE}
\\renewcommand{\\ExerciseHeader}{\\noindent\\textbf{\\ExerciseName\\;\\ExerciseHeaderNB}}
\\newenvironment{Example}{\\begin{tcolorbox}\\begin{Exercise}}{\\end{Exercise}\\end{tcolorbox}}
\\setlength{\\ExerciseSkipBefore}{0pt}
\\newcommand\\independent{\\protect\\mathpalette{\\protect\\independenT}{\\perp}}
\\def\\independenT#1#2{\\mathrel{\\rlap{$#1#2$}\\mkern2mu{#1#2}}}

\\begin{document}
\\begin{CJK}{UTF8}{bsmi}

\\maketitle

\\setstretch{1.5}`;

        // å–å¾—æ‰€æœ‰å€å¡Š
        const blocks = document.getElementsByClassName("block");
        for (let i = 0; i < blocks.length; i++) {
          const select = blocks[i].getElementsByTagName("select")[0];
          const textarea = blocks[i].getElementsByTagName("textarea")[0];

          const blockType = select.value;
          const content = textarea.value;

          // ç›´æ¥ä½¿ç”¨ä½¿ç”¨è€…çš„è¼¸å…¥ï¼Œä¸é€²è¡Œè½‰ç¾©
          const userContent = content;

          // æ·»åŠ æ¯å€‹å€å¡Šçš„ TeX å…§å®¹ï¼ˆä¸æ·»åŠ é¡å¤–çš„æ›è¡Œï¼‰
          if (blockType === "Example") {
            texContent += `
%=============ç¬¬ ${
              i + 1
            } é¡Œ =====================================================
\\begin{Example}
${userContent}
\\end{Example}`;
          } else if (blockType === "Answer") {
            texContent += `
\\begin{Answer}
${userContent}
\\end{Answer}`;
          } else if (blockType === "Section") {
            texContent += `
\\section*{${userContent}}`;
          } else if (blockType === "Subsection") {
            texContent += `
\\subsection*{${userContent}}`;
          } else {
            // å…¶ä»–è‡ªå®šç¾©å…§å®¹
            texContent += `
${userContent}`;
          }
        }

        // TeX æ¨¡æ¿çš„çµå°¾
        texContent += `
\\end{CJK}
\\end{document}`;

        // æ ¼å¼åŒ– TeX å…§å®¹
        texContent = formatTeXContent(texContent);

        // é¡¯ç¤ºç”Ÿæˆçš„ TeX å…§å®¹
        document.getElementById("tex-output").textContent = texContent;
      }

      function formatTeXContent(texContent) {
        const lines = texContent.split("\n");
        let formattedLines = [];
        let indentLevel = 0;
        const indentString = "  "; // å…©å€‹ç©ºæ ¼ä½œç‚ºç¸®æ’

        const beginRegex = /\\begin\{[^\}]+\}/g;
        const endRegex = /\\end\{[^\}]+\}/g;

        for (let line of lines) {
          let trimmedLine = line.trim();

          // èª¿æ•´ç¸®æ’ç´šåˆ¥
          let endMatches = trimmedLine.match(endRegex);
          if (endMatches) {
            indentLevel -= endMatches.length;
          }
          indentLevel = Math.max(indentLevel, 0);

          const indentedLine = indentString.repeat(indentLevel) + trimmedLine;
          formattedLines.push(indentedLine);

          let beginMatches = trimmedLine.match(beginRegex);
          if (beginMatches) {
            indentLevel += beginMatches.length;
          }
        }

        return formattedLines.join("\n");
      }

      function updateMathPreview(content, previewElement) {
        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼éæ¿¾å‡ºæ•¸å­¸å¼ï¼Œä¸¦ä½¿ç”¨ MathJax æ¸²æŸ“
        const mathRegex =
          /\$[^$]+\$|\\\[([\\\s\S]+?)\\\]|\\\(([\\\s\S]+?)\\\)/g;

        // è½‰ç¾© HTML ç‰¹æ®Šå­—ç¬¦
        let safeContent = content.replace(/&/g, "&amp;").replace(/</g, "&lt;");

        // ä¿ç•™æ›è¡Œç¬¦è™Ÿ
        safeContent = safeContent.replace(/\n/g, "<br>");

        // å°‡æ•¸å­¸å¼æ›¿æ›ç‚ºæ¸²æŸ“ç”¨çš„ span
        let renderedContent = safeContent.replace(mathRegex, function (match) {
          return `<span class="math-inline">${match}</span>`;
        });

        // å°‡æ¸²æŸ“å…§å®¹è¨­ç½®åˆ°é è¦½å€åŸŸ
        previewElement.innerHTML = renderedContent;
        MathJax.typesetPromise([previewElement]);
      }

      // è‡ªå‹•èª¿æ•´ textarea é«˜åº¦
      function autoResize() {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      }

      // é¡¯ç¤º Toast é€šçŸ¥
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000);
      }

      // ç•¶å…ƒè³‡æ–™è®ŠåŒ–æ™‚ï¼Œæ›´æ–° TeX ä¸¦ä¿å­˜
      const metadataInputs = document.querySelectorAll("#metadata input");
      let isFilenameManuallyEdited = false;

      document
        .getElementById("tex-filename")
        .addEventListener("input", function () {
          isFilenameManuallyEdited = true;
        });

      metadataInputs.forEach((input) => {
        input.addEventListener("input", function () {
          if (!isFilenameManuallyEdited) {
            let titleValue = document.getElementById("title").value.trim();
            let filename = titleValue !== "" ? titleValue : "output";
            document.getElementById("tex-filename").value = filename;
          }
          updateTeX();
          saveToLocalStorage();
        });
      });

      // æ–°å¢å€å¡ŠæŒ‰éˆ•
      document
        .getElementById("add-block")
        .addEventListener("click", function () {
          addBlock();
          saveToLocalStorage();
        });

      // åˆå§‹åŠ è¼‰è³‡æ–™
      loadFromLocalStorage();

      // å¯¦æ™‚æ›´æ–° TeX å…§å®¹
      document.getElementById("blocks").addEventListener("input", function () {
        updateTeX();
        saveToLocalStorage();
      });

      // è¤‡è£½ TeX å…§å®¹
      document
        .getElementById("copy-tex")
        .addEventListener("click", function () {
          const texContent = document.getElementById("tex-output").textContent;
          navigator.clipboard.writeText(texContent).then(
            function () {
              showToast("TeX å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
            },
            function (err) {
              showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
            }
          );
        });

      // ä¸‹è¼‰ TeX æª”æ¡ˆ
      function downloadTeX() {
        updateTeX(); // ç¢ºä¿å…§å®¹æ˜¯æœ€æ–°çš„
        const texContent = document.getElementById("tex-output").textContent;
        let filename = document.getElementById("tex-filename").value.trim();
        if (!filename.toLowerCase().endsWith(".tex")) {
          filename += ".tex";
        }
        const blob = new Blob([texContent], {
          type: "text/plain;charset=utf-8",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }

      document
        .getElementById("download-tex")
        .addEventListener("click", downloadTeX);

      // åˆ‡æ›æ·±æ·ºæ¨¡å¼
      const toggleThemeButton = document.getElementById("toggle-theme");
      toggleThemeButton.addEventListener("click", function () {
        if (document.documentElement.getAttribute("data-theme") === "dark") {
          document.documentElement.removeAttribute("data-theme");
          toggleThemeButton.innerHTML = '<i class="fas fa-moon"></i>';
        } else {
          document.documentElement.setAttribute("data-theme", "dark");
          toggleThemeButton.innerHTML = '<i class="fas fa-sun"></i>';
        }
      });

      // è‡ªå‹•æ ¹æ“šç³»çµ±è¨­å®šåˆ‡æ›æ·±æ·ºæ¨¡å¼
      const prefersDarkScheme = window.matchMedia(
        "(prefers-color-scheme: dark)"
      );

      function applyTheme(e) {
        if (e.matches) {
          document.documentElement.setAttribute("data-theme", "dark");
          toggleThemeButton.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
          document.documentElement.removeAttribute("data-theme");
          toggleThemeButton.innerHTML = '<i class="fas fa-moon"></i>';
        }
      }

      prefersDarkScheme.addEventListener("change", applyTheme);

      // åˆå§‹æ‡‰ç”¨ä¸»é¡Œ
      applyTheme(prefersDarkScheme);
    </script>
  </body>
</html>
