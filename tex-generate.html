<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>TeX æª”æ¡ˆç”Ÿæˆå™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- å¼•å…¥ Google å­—é«”ã€Font Awesome å’Œ MathJax -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
      /* å…¨åŸŸæ¨£å¼ */
      body {
        font-family: "Noto Sans TC", sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
      }
      :root {
        --bg-color: #ffffff;
        --text-color: #000000;
        --block-bg-color: #f9f9f9;
        --block-border-color: #dddddd;
        --button-bg-color: #007bff;
        --button-text-color: #ffffff;
        --button-hover-bg-color: #0056b3;
        --input-border-color: #cccccc;
        --input-focus-border-color: #007bff;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --copy-button-bg-color: #007bff;
        --copy-button-text-color: #ffffff;
        --copy-button-hover-bg-color: #0056b3;
        --tooltip-bg-color: #333333;
        --tooltip-text-color: #ffffff;
        --code-bg-color: #f5f5f5;
        --code-border-color: #e0e0e0;
        --toast-bg-color: rgba(0, 0, 0, 0.7);
        --toast-text-color: #ffffff;
      }
      [data-theme="dark"] {
        --bg-color: #121212;
        --text-color: #e0e0e0;
        --block-bg-color: #1e1e1e;
        --block-border-color: #333333;
        --button-bg-color: #1a73e8;
        --button-text-color: #ffffff;
        --button-hover-bg-color: #185abc;
        --input-border-color: #555555;
        --input-focus-border-color: #1a73e8;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --copy-button-bg-color: #1a73e8;
        --copy-button-text-color: #ffffff;
        --copy-button-hover-bg-color: #185abc;
        --tooltip-bg-color: #ffffff;
        --tooltip-text-color: #000000;
        --code-bg-color: #2d2d2d;
        --code-border-color: #444444;
        --toast-bg-color: rgba(255, 255, 255, 0.9);
        --toast-text-color: #000000;
      }
      /* ç‰ˆé¢é…ç½® */
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      /* æ¨™é¡Œæ¨£å¼ */
      h1,
      h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      /* æŒ‰éˆ•æ¨£å¼ */
      .btn {
        background-color: var(--button-bg-color);
        color: var(--button-text-color);
        border: none;
        padding: 10px 15px;
        margin: 5px 0;
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px;
        transition: background-color 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .btn:hover {
        background-color: var(--button-hover-bg-color);
      }
      /* è¼¸å…¥æ¡†æ¨£å¼ */
      input[type="text"],
      textarea,
      select {
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid var(--input-border-color);
        border-radius: 5px;
        background-color: var(--block-bg-color);
        color: var(--text-color);
        transition: border-color 0.3s;
        font-size: 16px;
      }
      input[type="text"]:focus,
      textarea:focus,
      select:focus {
        border-color: var(--input-focus-border-color);
        outline: none;
      }
      /* å€å¡Šæ¨£å¼ */
      .block {
        background-color: var(--block-bg-color);
        border: 1px solid var(--block-border-color);
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 6px var(--shadow-color);
        position: relative;
        transition: box-shadow 0.3s;
      }
      .block:hover {
        box-shadow: 0 6px 10px var(--shadow-color);
      }
      .block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: move; /* è¡¨ç¤ºå¯æ‹–å‹• */
      }
      .block-header label {
        font-weight: bold;
        margin: 0;
      }
      .block textarea {
        height: auto;
        min-height: 100px;
        overflow: hidden;
      }
      .math-preview {
        border-top: 1px solid var(--block-border-color);
        padding-top: 10px;
        margin-top: 10px;
        color: var(--text-color);
        white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
        line-height: 1.6; /* å¢åŠ è¡Œè· */
        font-size: 16px; /* èª¿æ•´å­—é«”å¤§å° */
      }
      /* èª¿æ•´ MathJax æ¸²æŸ“çš„å­—é«” */
      .mjx-chtml {
        font-size: 1em !important;
      }
      /* ç§»é™¤å€å¡ŠæŒ‰éˆ• */
      .remove-block {
        background: transparent;
        border: none;
        color: var(--text-color);
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
        transition: color 0.3s;
      }
      .remove-block:hover {
        color: var(--button-hover-bg-color);
      }
      /* è¤‡è£½æŒ‰éˆ• */
      .copy-button-container {
        position: relative;
      }
      #copy-tex {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: var(--copy-button-bg-color);
        border: none;
        color: var(--copy-button-text-color);
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 5px 10px;
        border-radius: 5px;
        transition: background-color 0.3s, transform 0.2s;
        z-index: 10;
      }
      #copy-tex:hover {
        background-color: var(--copy-button-hover-bg-color);
        transform: scale(1.05);
      }
      #copy-tex .copy-icon {
        margin-right: 5px;
      }
      /* æ‡¸æµ®å·¥å…·æç¤º */
      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: max-content;
        background-color: var(--tooltip-bg-color);
        color: var(--tooltip-text-color);
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%; /* ä¸Šæ–¹ */
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        white-space: pre-wrap;
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
      /* åˆ‡æ›æ¨¡å¼æŒ‰éˆ• */
      #toggle-theme {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: transparent;
        color: var(--text-color);
        border: none;
        cursor: pointer;
        font-size: 24px;
        transition: color 0.3s;
      }
      #toggle-theme:hover {
        color: var(--button-hover-bg-color);
      }
      /* ç”Ÿæˆçš„ TeX å…§å®¹ */
      #tex-output-container {
        position: relative;
        margin-bottom: 20px;
      }
      #tex-output-header {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }
      #tex-filename {
        flex: 1;
        padding: 8px;
        border: 1px solid var(--input-border-color);
        border-radius: 5px;
        background-color: var(--block-bg-color);
        color: var(--text-color);
        font-size: 16px;
      }
      /* ç¨‹å¼ç¢¼å€å¡Šæ¨£å¼ */
      pre {
        background-color: var(--code-bg-color);
        padding: 15px;
        border-radius: 5px;
        border: 1px solid var(--code-border-color);
        overflow-x: auto;
        font-size: 14px;
        position: relative;
      }
      code {
        font-family: Consolas, "Courier New", monospace;
        white-space: pre;
        color: var(--text-color);
      }
      /* è§£é‡‹å€å¡Šæ¨£å¼ */
      #explanation {
        background-color: var(--block-bg-color);
        border: 1px solid var(--block-border-color);
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px var(--shadow-color);
      }
      #explanation h3 {
        margin-top: 0;
      }
      /* å…ƒè³‡æ–™æ¨£å¼ */
      #metadata {
        background-color: var(--block-bg-color);
        border: 1px solid var(--block-border-color);
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px var(--shadow-color);
      }
      #metadata label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }
      /* æ–°å¢å€å¡ŠæŒ‰éˆ• */
      #add-block {
        background-color: #28a745;
        color: #ffffff;
        border: none;
        padding: 12px 0;
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px;
        transition: background-color 0.3s;
        width: 100%;
        margin-bottom: 20px;
      }
      #add-block:hover {
        background-color: #218838;
      }
      /* ä¸‹è¼‰æŒ‰éˆ•æ¨£å¼ */
      #download-tex {
        background-color: #17a2b8;
        color: #ffffff;
        border: none;
        padding: 12px;
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px;
        transition: background-color 0.3s;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #download-tex:hover {
        background-color: #117a8b;
      }
      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media screen and (max-width: 600px) {
        #toggle-theme {
          position: static;
          display: block;
          text-align: right;
          margin-bottom: 10px;
        }
        #copy-tex {
          position: absolute;
          top: 10px;
          right: 10px;
          /* Ensure it's above other elements */
          z-index: 10;
        }
        #tex-filename {
          font-size: 14px;
        }
      }
      /* Toast æ‡‰ç”¨æ¨£å¼ */
      #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: var(--toast-bg-color);
        color: var(--toast-text-color);
        text-align: center;
        border-radius: 5px;
        padding: 16px;
        position: fixed;
        z-index: 100;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 17px;
      }
      #toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }
      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>TeX æª”æ¡ˆç”Ÿæˆå™¨</h1>
      <button id="toggle-theme" class="tooltip" aria-label="åˆ‡æ›æ·±æ·ºæ¨¡å¼">
        <i class="fas fa-moon"></i>
        <span class="tooltiptext">åˆ‡æ›æ·±æ·ºæ¨¡å¼</span>
      </button>

      <!-- è§£é‡‹å€å¡Š -->
      <div id="explanation">
        <h3>å€å¡Šé¡å‹èªªæ˜</h3>
        <p>
          <strong>é¡Œç›® (Example)ï¼š</strong> ç”¨æ–¼è¼¸å…¥é¡Œç›®çš„å…§å®¹ï¼Œæœƒè¢«åŒ…è£¹åœ¨
          <code>\\begin{Example}</code> å’Œ <code>\\end{Example}</code> ç’°å¢ƒä¸­ã€‚
        </p>
        <p>
          <strong>è§£ç­” (Answer)ï¼š</strong> ç”¨æ–¼è¼¸å…¥é¡Œç›®çš„è§£ç­”ï¼Œæœƒè¢«åŒ…è£¹åœ¨
          <code>\\begin{Answer}</code> å’Œ <code>\\end{Answer}</code> ç’°å¢ƒä¸­ã€‚
        </p>
        <p>
          <strong>ç¯€ (Section)ï¼š</strong> ç”¨æ–¼å»ºç«‹æ–°çš„ç« ç¯€ï¼Œè«‹è¼¸å…¥é¡ä¼¼
          <code>2. äºŒæ¬¡å°æ•¸æ¸¬è©¦</code> çš„æ ¼å¼ã€‚
        </p>
        <p>
          <strong>å°ç¯€ (Subsection)ï¼š</strong> ç”¨æ–¼å»ºç«‹æ–°çš„å°ç¯€ï¼Œè«‹è¼¸å…¥é¡ä¼¼
          <code>2.1 å°ç¯€æ¨™é¡Œ</code> çš„æ ¼å¼ã€‚
        </p>
        <p>
          <strong>å…¶ä»– (Other)ï¼š</strong>
          ç”¨æ–¼è¼¸å…¥å…¶ä»–è‡ªå®šç¾©çš„å…§å®¹ï¼Œä¸æœƒè¢«åŒ…è£¹åœ¨ä»»ä½•ç’°å¢ƒä¸­ï¼Œæ‚¨å¯ä»¥ç›´æ¥è¼¸å…¥ LaTeX
          ä»£ç¢¼ã€‚
        </p>
      </div>

      <!-- å…ƒè³‡æ–™å€å¡Š -->
      <div id="metadata">
        <h3>æ–‡ä»¶å…ƒè³‡æ–™</h3>
        <label for="title">æ¨™é¡Œ (Title)ï¼š</label>
        <input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šç·šæ€§ä»£æ•¸ç¿’é¡Œè§£ç­”" />
        <label for="author">ä½œè€… (Author)ï¼š</label>
        <input type="text" id="author" placeholder="ä¾‹å¦‚ï¼šæ—å°æ˜" />
        <label for="email">é›»å­éƒµä»¶ (Email)ï¼š</label>
        <input
          type="text"
          id="email"
          placeholder="ä¾‹å¦‚ï¼šlinxiaoming@example.com"
        />
        <label for="affiliation">å–®ä½ (Affiliation)ï¼š</label>
        <input
          type="text"
          id="affiliation"
          value="æ±æµ·æ•¸å­¸ç³»"
          placeholder="ä¾‹å¦‚ï¼šæ±æµ·æ•¸å­¸ç³»"
        />
        <label for="date">æ—¥æœŸ (Date)ï¼š</label>
        <input
          type="text"
          id="date"
          value="\today"
          placeholder="ä¾‹å¦‚ï¼š2024å¹´4æœˆ27æ—¥ æˆ– \today"
        />
      </div>

      <!-- å€å¡Šåˆ—è¡¨ -->
      <div id="blocks">
        <!-- å€å¡Šå°‡è¢«æ·»åŠ åˆ°é€™è£¡ -->
      </div>

      <!-- æ–°å¢å€å¡ŠæŒ‰éˆ• -->
      <button id="add-block" class="btn tooltip" aria-label="æ–°å¢å€å¡Š">
        â• æ–°å¢å€å¡Š
        <span class="tooltiptext">é»æ“Šæ–°å¢ä¸€å€‹æ–°çš„å€å¡Š</span>
      </button>

      <!-- ç”Ÿæˆçš„ TeX å…§å®¹ -->
      <h2>ç”Ÿæˆçš„ TeX å…§å®¹ï¼š</h2>
      <div id="tex-output-container">
        <!-- æ¨™é ­æ¬„ä½ -->
        <div id="tex-output-header">
          <input type="text" id="tex-filename" placeholder="ä¾‹å¦‚ï¼šé¡Œç›®.tex" />
        </div>
        <!-- ç¨‹å¼ç¢¼å€å¡Š -->
        <div class="copy-button-container">
          <pre><code id="tex-output" class="language-tex" readonly></code></pre>
          <!-- è¤‡è£½æŒ‰éˆ• -->
          <button id="copy-tex" class="tooltip" aria-label="è¤‡è£½ TeX å…§å®¹">
            <i class="fas fa-copy copy-icon"></i>
            <span class="copy-text">è¤‡è£½</span>
            <span class="tooltiptext">å°‡ TeX å…§å®¹è¤‡è£½åˆ°å‰ªè²¼ç°¿</span>
          </button>
        </div>
      </div>
      <!-- ä¸‹è¼‰ TeX æª”æ¡ˆæŒ‰éˆ• -->
      <button id="download-tex" class="btn tooltip" aria-label="ä¸‹è¼‰ TeX æª”æ¡ˆ">
        ğŸ’¾ ä¸‹è¼‰ TeX æª”æ¡ˆ
        <span class="tooltiptext">å°‡ç”Ÿæˆçš„ TeX å…§å®¹ä¸‹è¼‰ç‚º TeX æª”æ¡ˆ</span>
      </button>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

    <script>
      let blockCount = 0;
      let draggedBlock = null;
      let placeholderExamples = {
        Example: "è«‹è¼¸å…¥é¡Œç›®ï¼Œä¾‹å¦‚ï¼š\n\næ±‚å¾®åˆ†æ–¹ç¨‹ \\( y' = y \\) çš„é€šè§£ã€‚",
        Answer:
          "è«‹è¼¸å…¥è§£ç­”ï¼Œä¾‹å¦‚ï¼š\n\né€šè§£ç‚º \\( y = Ce^{x} \\)ï¼Œå…¶ä¸­ \\( C \\) ç‚ºä»»æ„å¸¸æ•¸ã€‚",
        Section: "è«‹è¼¸å…¥ç« ç¯€æ¨™é¡Œï¼Œä¾‹å¦‚ï¼š2. äºŒæ¬¡å°æ•¸æ¸¬è©¦",
        Subsection: "è«‹è¼¸å…¥å°ç¯€æ¨™é¡Œï¼Œä¾‹å¦‚ï¼š2.1 å°ç¯€æ¨™é¡Œ",
        Other: "è«‹è¼¸å…¥å…¶ä»–å…§å®¹ï¼Œæ‚¨å¯ä»¥è¼¸å…¥ä»»ä½• LaTeX ä»£ç¢¼ã€‚",
      };

      function addBlock() {
        blockCount++;

        const blockDiv = document.createElement("div");
        blockDiv.className = "block";
        blockDiv.id = "block-" + blockCount;

        // æ¨™é¡Œåˆ—
        const topRow = document.createElement("div");
        topRow.className = "block-header";
        topRow.setAttribute("draggable", true);

        // æ¨™ç±¤
        const label = document.createElement("label");
        label.textContent = "å€å¡Š " + blockCount + ":";

        // ç§»é™¤å€å¡ŠæŒ‰éˆ•
        const removeButton = document.createElement("button");
        removeButton.className = "remove-block tooltip";
        removeButton.setAttribute("aria-label", "ç§»é™¤å€å¡Š");
        removeButton.innerHTML = "âœ–";
        const removeTooltip = document.createElement("span");
        removeTooltip.className = "tooltiptext";
        removeTooltip.innerText = "ç§»é™¤æ­¤å€å¡Š";
        removeButton.appendChild(removeTooltip);
        removeButton.onclick = function () {
          document.getElementById("blocks").removeChild(blockDiv);
          updateBlockLabels();
          updateTeX();
        };

        // çµ„è£æ¨™é¡Œåˆ—
        topRow.appendChild(label);
        topRow.appendChild(removeButton);

        // é¸æ“‡æ¡†
        const select = document.createElement("select");
        select.innerHTML = `
                    <option value="Example">é¡Œç›® (Example)</option>
                    <option value="Answer">è§£ç­” (Answer)</option>
                    <option value="Section">ç¯€ (Section)</option>
                    <option value="Subsection">å°ç¯€ (Subsection)</option>
                    <option value="Other">å…¶ä»– (Other)</option>
                `;
        select.onchange = function () {
          const currentValue = select.value;
          textarea.readOnly = false;
          if (currentValue === "Section") {
            textarea.placeholder = "ä¾‹å¦‚ï¼š2. äºŒæ¬¡å°æ•¸æ¸¬è©¦";
          } else if (currentValue === "Subsection") {
            textarea.placeholder = "ä¾‹å¦‚ï¼š2.1 å°ç¯€æ¨™é¡Œ";
          } else {
            textarea.placeholder = placeholderExamples[currentValue];
          }
          updateTeX();
          updateMathPreview(textarea.value, mathPreview);
        };

        // æ–‡å­—è¼¸å…¥æ¡†
        const textarea = document.createElement("textarea");
        textarea.placeholder = placeholderExamples[select.value];
        textarea.addEventListener("input", autoResize, false);

        // æ•¸å­¸é è¦½å€
        const mathPreview = document.createElement("div");
        mathPreview.className = "math-preview";

        // å…§å®¹è¼¸å…¥æ™‚æ›´æ–° TeX å’Œæ•¸å­¸é è¦½
        textarea.addEventListener("input", function () {
          updateTeX();
          updateMathPreview(textarea.value, mathPreview);
        });

        // çµ„è£å€å¡Š
        blockDiv.appendChild(topRow);
        blockDiv.appendChild(select);
        blockDiv.appendChild(textarea);
        blockDiv.appendChild(mathPreview);

        // åŠ å…¥æ‹–æ”¾äº‹ä»¶åˆ° topRow
        topRow.addEventListener("dragstart", function (e) {
          draggedBlock = blockDiv;
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", blockDiv.id);
        });

        blockDiv.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          blockDiv.style.boxShadow = "0 0 10px var(--button-bg-color)";
        });

        blockDiv.addEventListener("dragleave", function (e) {
          blockDiv.style.boxShadow = "none";
        });

        blockDiv.addEventListener("drop", function (e) {
          e.preventDefault();
          blockDiv.style.boxShadow = "none";

          const draggedId = e.dataTransfer.getData("text/plain");
          const draggedBlock = document.getElementById(draggedId);

          if (draggedBlock && draggedBlock !== blockDiv) {
            const blocksContainer = document.getElementById("blocks");
            blocksContainer.insertBefore(draggedBlock, blockDiv);
            updateBlockLabels();
            updateTeX();
          }

          draggedBlock = null;
        });

        // æ·»åŠ åˆ°å€å¡Šå®¹å™¨
        document.getElementById("blocks").appendChild(blockDiv);

        updateBlockLabels();
        updateTeX();
      }

      function updateBlockLabels() {
        const blocks = document.getElementById("blocks").children;
        blockCount = blocks.length;
        for (let i = 0; i < blocks.length; i++) {
          const label = blocks[i].querySelector(".block-header label");
          label.textContent = "å€å¡Š " + (i + 1) + ":";

          const select = blocks[i].getElementsByTagName("select")[0];
          const textarea = blocks[i].getElementsByTagName("textarea")[0];

          textarea.readOnly = false;
          if (select.value === "Section") {
            textarea.placeholder = "ä¾‹å¦‚ï¼š2. äºŒæ¬¡å°æ•¸æ¸¬è©¦";
          } else if (select.value === "Subsection") {
            textarea.placeholder = "ä¾‹å¦‚ï¼š2.1 å°ç¯€æ¨™é¡Œ";
          } else {
            textarea.placeholder = placeholderExamples[select.value];
          }
        }
      }

      function updateTeX() {
        // å–å¾—æª”å
        let texFilename = document.getElementById("tex-filename").value.trim();
        if (!isFilenameManuallyEdited) {
          texFilename =
            document.getElementById("title").value.trim() !== ""
              ? document.getElementById("title").value.trim()
              : "output";
          document.getElementById("tex-filename").value = texFilename;
        }

        // ç¢ºä¿æª”åä»¥ .tex çµå°¾
        if (!texFilename.toLowerCase().endsWith(".tex")) {
          texFilename += ".tex";
        }

        // TeX æ¨¡æ¿çš„é–‹é ­ï¼ˆä½¿ç”¨æ‚¨æä¾›çš„æ¨¡æ¿ï¼‰
        let texContent = `% !Mode:: "TeX:UTF-8"
\\documentclass[12pt]{article}
\\usepackage{amsmath}%æ•¸å­¸ç¬¦è™Ÿ1
\\usepackage{CJKutf8}%ä¸­æ–‡è¡¨æ ¼
\\usepackage{amssymb}%æ•¸å­¸ç¬¦è™Ÿ2
\\usepackage{lmodern}%å­—å‹å¤§å°
\\usepackage{amsfonts}%æ•¸å­¸å­—å‹
\\usepackage{natbib}%åƒè€ƒæ–‡ç»
\\usepackage{graphics}%åœ–å‹
\\usepackage{epsfig}%EPSåœ–å‹
\\usepackage{subfigure}
\\usepackage{graphicx}
\\usepackage{fancybox}
\\usepackage{url}%è¼¸å…¥ç¶²å€
\\usepackage{tikz}
\\usepackage[lastexercise]{exercise}
\\usepackage{chngcntr}
\\usepackage{tcolorbox}
\\usepackage{listings}
\\usepackage{multirow}%å¤šåˆ—è¡¨æ ¼
\\usepackage[para,online,flushleft]{threeparttable}%è¡¨æ ¼è¨»è§£
\\usepackage{rotating}%è¡¨æ ¼æ—‹è½‰
\\usepackage{dcolumn}%è®“è¡¨æ ¼å°æ•¸é»å°é½Š
\\usepackage{caption}

%\\usepackage[table]{xcolor}

\\newcommand{\\gfcb}[1]{%
\tcolorbox[sharp corners,colback=gray!10!white]{#1}
} % gfcb := gray fcolorbox
\\newcommand{\\cop}[1]{%
\\gfcb{\\texttt{\\detokenize{#1}}} 
\\ensuremath{\\quad\\longrightarrow\\quad #1}
} % cop := code output

\\tcbset{arc=0mm,boxrule=1pt,colback=white,colframe=cyan,leftrule=3mm}
%\\usetikzlibrary{decorations.pathreplacing}
\\usepackage{float}
\\newtheorem{example}{Example}[subsection]
\\newtheorem{defin}{Definition}
\\usepackage{setspace} 
\\renewcommand{\\figurename}{åœ–}
\\renewcommand{\\tablename}{è¡¨}
\\renewcommand\\refname{åƒè€ƒæ–‡ç»}
%\\linespread{1.5}
%\\setcounter{section}{12}
\\renewcommand{\\abstractname}{æ‘˜è¦}
\\definecolor{bisque}{rgb}{.996,.891,.755}
\\definecolor{mypink}{cmyk}{.1,.8,.4,.1}  % cmyk æ¨¡å‹çš„ä¾‹å­ 
\\definecolor{Gray}{gray}{0.85}
\\definecolor{LightCyan}{rgb}{0.88,1,1}

\\newcolumntype{a}{>{\\columncolor{Gray}}c}
\\newcolumntype{b}{>{\\columncolor{white}}c}
%=============================================================================

\\title{${document.getElementById("title").value.trim()}}

\\author{${document.getElementById("author").value.trim()}\\footnote{${document
          .getElementById("email")
          .value.trim()}}\\\\
${document.getElementById("affiliation").value.trim()}}

\\date{${document.getElementById("date").value.trim()}}

\\renewcommand{\\theExercise}{\\arabic{Exercise}}
\\renewcommand{\\AnswerHeader}{\\medskip\\noindent\\textcolor{red}{\\textbf{SOLUTION}}\\;}
\\renewcommand{\\ExerciseName}{EXAMPLE}
\\renewcommand{\\ExerciseHeader}{\\noindent\\textbf{\\ExerciseName\\;\\ExerciseHeaderNB}}
\\newenvironment{Example}{\\begin{tcolorbox}\\begin{Exercise}}{\\end{Exercise}\\end{tcolorbox}}
\\setlength{\\ExerciseSkipBefore}{0pt}
\\newcommand\\independent{\\protect\\mathpalette{\\protect\\independenT}{\\perp}}
\\def\\independenT#1#2{\\mathrel{\\rlap{$#1#2$}\\mkern2mu{#1#2}}}

\\begin{document}
\\begin{CJK}{UTF8}{bsmi}

\\maketitle

\\setstretch{1.5}`;

        // å–å¾—æ‰€æœ‰å€å¡Š
        const blocks = document.getElementsByClassName("block");
        for (let i = 0; i < blocks.length; i++) {
          const select = blocks[i].getElementsByTagName("select")[0];
          const textarea = blocks[i].getElementsByTagName("textarea")[0];

          const blockType = select.value;
          const content = textarea.value;

          // ç›´æ¥ä½¿ç”¨ä½¿ç”¨è€…çš„è¼¸å…¥ï¼Œä¸é€²è¡Œè½‰ç¾©
          const userContent = content;

          // æ·»åŠ æ¯å€‹å€å¡Šçš„ TeX å…§å®¹ï¼ˆä¸æ·»åŠ é¡å¤–çš„æ›è¡Œï¼‰
          if (blockType === "Example") {
            texContent += `%=============ç¬¬ ${
              i + 1
            } é¡Œ =====================================================
\\begin{Example}
${userContent}
\\end{Example}`;
          } else if (blockType === "Answer") {
            texContent += `\\begin{Answer}
${userContent}
\\end{Answer}`;
          } else if (blockType === "Section") {
            texContent += `\\section*{${userContent}}`;
          } else if (blockType === "Subsection") {
            texContent += `\\subsection*{${userContent}}`;
          } else {
            // å…¶ä»–è‡ªå®šç¾©å…§å®¹
            texContent += `${userContent}`;
          }
        }

        // TeX æ¨¡æ¿çš„çµå°¾
        texContent += `
\\end{CJK}
\\end{document}`;

        // é¡¯ç¤ºç”Ÿæˆçš„ TeX å…§å®¹
        document.getElementById("tex-output").textContent = texContent;
      }

      function updateMathPreview(content, previewElement) {
        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼éæ¿¾å‡ºæ•¸å­¸å¼ï¼Œä¸¦ä½¿ç”¨ MathJax æ¸²æŸ“
        const mathRegex =
          /\$[^$]+\$|\\\[([\\\s\S]+?)\\\]|\\\(([\\\s\S]+?)\\\)/g;

        // è½‰ç¾© HTML ç‰¹æ®Šå­—ç¬¦
        let safeContent = content.replace(/&/g, "&amp;").replace(/</g, "&lt;");

        // ä¿ç•™æ›è¡Œç¬¦è™Ÿ
        safeContent = safeContent.replace(/\n/g, "<br>");

        // å°‡æ•¸å­¸å¼æ›¿æ›ç‚ºæ¸²æŸ“ç”¨çš„ span
        let renderedContent = safeContent.replace(mathRegex, function (match) {
          return `<span class="math-inline">${match}</span>`;
        });

        // å°‡æ¸²æŸ“å…§å®¹è¨­ç½®åˆ°é è¦½å€åŸŸ
        previewElement.innerHTML = renderedContent;
        MathJax.typesetPromise([previewElement]);
      }

      // è‡ªå‹•èª¿æ•´ textarea é«˜åº¦
      function autoResize() {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      }

      // é¡¯ç¤º Toast é€šçŸ¥
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000);
      }

      // ç•¶å…ƒè³‡æ–™è®ŠåŒ–æ™‚ï¼Œæ›´æ–° TeX
      const metadataInputs = document.querySelectorAll("#metadata input");
      let isFilenameManuallyEdited = false;

      document
        .getElementById("tex-filename")
        .addEventListener("input", function () {
          isFilenameManuallyEdited = true;
        });

      metadataInputs.forEach((input) => {
        input.addEventListener("input", function () {
          if (!isFilenameManuallyEdited) {
            let titleValue = document.getElementById("title").value.trim();
            let filename = titleValue !== "" ? titleValue : "output";
            document.getElementById("tex-filename").value = filename;
          }
          updateTeX();
        });
      });

      // æ–°å¢å€å¡ŠæŒ‰éˆ•
      document
        .getElementById("add-block")
        .addEventListener("click", function () {
          addBlock();
        });

      // åˆå§‹æ–°å¢ä¸€å€‹å€å¡Š
      addBlock();

      // å¯¦æ™‚æ›´æ–° TeX å…§å®¹
      document.getElementById("blocks").addEventListener("input", updateTeX);

      // è¤‡è£½ TeX å…§å®¹
      document
        .getElementById("copy-tex")
        .addEventListener("click", function () {
          const texContent = document.getElementById("tex-output").textContent;
          navigator.clipboard.writeText(texContent).then(
            function () {
              showToast("TeX å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
            },
            function (err) {
              showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
            }
          );
        });

      // ä¸‹è¼‰ TeX æª”æ¡ˆ
      function downloadTeX() {
        updateTeX(); // ç¢ºä¿å…§å®¹æ˜¯æœ€æ–°çš„
        const texContent = document.getElementById("tex-output").textContent;
        let filename = document.getElementById("tex-filename").value.trim();
        if (!filename.toLowerCase().endsWith(".tex")) {
          filename += ".tex";
        }
        const blob = new Blob([texContent], {
          type: "text/plain;charset=utf-8",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }

      document
        .getElementById("download-tex")
        .addEventListener("click", downloadTeX);

      // åˆ‡æ›æ·±æ·ºæ¨¡å¼
      const toggleThemeButton = document.getElementById("toggle-theme");
      toggleThemeButton.addEventListener("click", function () {
        if (document.documentElement.getAttribute("data-theme") === "dark") {
          document.documentElement.removeAttribute("data-theme");
          toggleThemeButton.innerHTML = '<i class="fas fa-moon"></i>';
        } else {
          document.documentElement.setAttribute("data-theme", "dark");
          toggleThemeButton.innerHTML = '<i class="fas fa-sun"></i>';
        }
      });

      // è‡ªå‹•æ ¹æ“šç³»çµ±è¨­å®šåˆ‡æ›æ·±æ·ºæ¨¡å¼
      const prefersDarkScheme = window.matchMedia(
        "(prefers-color-scheme: dark)"
      );

      function applyTheme(e) {
        if (e.matches) {
          document.documentElement.setAttribute("data-theme", "dark");
          toggleThemeButton.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
          document.documentElement.removeAttribute("data-theme");
          toggleThemeButton.innerHTML = '<i class="fas fa-moon"></i>';
        }
      }

      prefersDarkScheme.addEventListener("change", applyTheme);

      // åˆå§‹æ‡‰ç”¨ä¸»é¡Œ
      applyTheme(prefersDarkScheme);
    </script>
  </body>
</html>
