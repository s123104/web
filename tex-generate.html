<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>TeX 檔案生成器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- 引入 Google 字體、Font Awesome 和 MathJax -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>TeX 檔案生成器</h1>
      <button id="toggle-theme" class="tooltip" aria-label="切換深淺模式">
        <i class="fas fa-moon"></i>
        <span class="tooltiptext">切換深淺模式</span>
      </button>

      <!-- 解釋區塊 -->
      <div id="explanation">
        <h3>區塊類型說明</h3>
        <p>
          <strong>題目 (Example)：</strong> 用於輸入題目的內容，會被包裹在
          <code>\\begin{Example}</code> 和 <code>\\end{Example}</code> 環境中。
        </p>
        <p>
          <strong>解答 (Answer)：</strong> 用於輸入題目的解答，會被包裹在
          <code>\\begin{Answer}</code> 和 <code>\\end{Answer}</code> 環境中。
        </p>
        <p>
          <strong>節 (Section)：</strong> 用於建立新的章節，請輸入類似
          <code>2. 二次導數測試</code> 的格式。
        </p>
        <p>
          <strong>小節 (Subsection)：</strong> 用於建立新的小節，請輸入類似
          <code>2.1 小節標題</code> 的格式。
        </p>
        <p>
          <strong>其他 (Other)：</strong>
          用於輸入其他自定義的內容，不會被包裹在任何環境中，您可以直接輸入 LaTeX
          代碼。
        </p>
      </div>

      <!-- 元資料區塊 -->
      <div id="metadata">
        <h3>文件元資料</h3>
        <label for="title">標題 (Title)：</label>
        <input type="text" id="title" placeholder="例如：線性代數習題解答" />
        <label for="author">作者 (Author)：</label>
        <input type="text" id="author" placeholder="例如：林小明" />
        <label for="email">電子郵件 (Email)：</label>
        <input
          type="text"
          id="email"
          placeholder="例如：linxiaoming@example.com"
        />
        <label for="affiliation">單位 (Affiliation)：</label>
        <input
          type="text"
          id="affiliation"
          value="東海數學系"
          placeholder="例如：東海數學系"
        />
        <label for="date">日期 (Date)：</label>
        <input
          type="text"
          id="date"
          value="\today"
          placeholder="例如：2024年4月27日 或 \today"
        />
      </div>

      <!-- 區塊列表 -->
      <div id="blocks">
        <!-- 區塊將被添加到這裡 -->
      </div>

      <!-- 新增區塊按鈕 -->
      <button id="add-block" class="btn tooltip" aria-label="新增區塊">
        ➕ 新增區塊
        <span class="tooltiptext">點擊新增一個新的區塊</span>
      </button>

      <!-- 生成的 TeX 內容 -->
      <h2>生成的 TeX 內容：</h2>
      <div id="tex-output-container">
        <!-- 標頭欄位 -->
        <div id="tex-output-header">
          <input type="text" id="tex-filename" placeholder="例如：題目.tex" />
        </div>
        <!-- 程式碼區塊 -->
        <div class="copy-button-container">
          <pre><code id="tex-output" class="language-tex" readonly></code></pre>
          <!-- 複製按鈕 -->
          <button id="copy-tex" class="tooltip" aria-label="複製 TeX 內容">
            <i class="fas fa-copy copy-icon"></i>
            <span class="copy-text">複製</span>
            <span class="tooltiptext">將 TeX 內容複製到剪貼簿</span>
          </button>
        </div>
      </div>
      <!-- 下載 TeX 檔案按鈕 -->
      <button id="download-tex" class="btn tooltip" aria-label="下載 TeX 檔案">
        💾 下載 TeX 檔案
        <span class="tooltiptext">將生成的 TeX 內容下載為 TeX 檔案</span>
      </button>
    </div>

    <!-- Toast 通知 -->
    <div id="toast">已複製到剪貼簿</div>

    <!-- JavaScript 程式碼 -->
    <script>
      let blockCount = 0;
      let draggedBlock = null;
      let placeholderExamples = {
        Example: "請輸入題目，例如：\n\n求微分方程 \\( y' = y \\) 的通解。",
        Answer:
          "請輸入解答，例如：\n\n通解為 \\( y = Ce^{x} \\)，其中 \\( C \\) 為任意常數。",
        Section: "請輸入章節標題，例如：2. 二次導數測試",
        Subsection: "請輸入小節標題，例如：2.1 小節標題",
        Other: "請輸入其他內容，您可以輸入任何 LaTeX 代碼。",
      };

      // 加載本地儲存的資料
      function loadFromLocalStorage() {
        // 加載元資料
        const metadata = JSON.parse(
          localStorage.getItem("texGeneratorMetadata")
        );
        if (metadata) {
          document.getElementById("title").value = metadata.title || "";
          document.getElementById("author").value = metadata.author || "";
          document.getElementById("email").value = metadata.email || "";
          document.getElementById("affiliation").value =
            metadata.affiliation || "";
          document.getElementById("date").value = metadata.date || "";
        }

        // 加載區塊
        const blocks = JSON.parse(localStorage.getItem("texGeneratorBlocks"));
        if (blocks && blocks.length > 0) {
          document.getElementById("blocks").innerHTML = "";
          blockCount = 0;
          for (let i = 0; i < blocks.length; i++) {
            const blockData = blocks[i];
            addBlock(blockData.type, blockData.content);
          }
        } else {
          // 如果沒有區塊，新增一個
          addBlock();
        }
        updateTeX();
      }

      // 保存資料到本地儲存
      function saveToLocalStorage() {
        // 保存元資料
        const metadata = {
          title: document.getElementById("title").value,
          author: document.getElementById("author").value,
          email: document.getElementById("email").value,
          affiliation: document.getElementById("affiliation").value,
          date: document.getElementById("date").value,
        };
        localStorage.setItem("texGeneratorMetadata", JSON.stringify(metadata));

        // 保存區塊
        const blocks = [];
        const blockElements = document.getElementsByClassName("block");
        for (let i = 0; i < blockElements.length; i++) {
          const select = blockElements[i].getElementsByTagName("select")[0];
          const textarea = blockElements[i].getElementsByTagName("textarea")[0];
          blocks.push({
            type: select.value,
            content: textarea.value,
          });
        }
        localStorage.setItem("texGeneratorBlocks", JSON.stringify(blocks));
      }

      function addBlock(type = "Example", content = "") {
        blockCount++;

        const blockDiv = document.createElement("div");
        blockDiv.className = "block";
        blockDiv.id = "block-" + blockCount;

        // 標題列
        const topRow = document.createElement("div");
        topRow.className = "block-header";
        topRow.setAttribute("draggable", true);

        // 標籤
        const label = document.createElement("label");
        label.textContent = "區塊 " + blockCount + ":";

        // 移除區塊按鈕
        const removeButton = document.createElement("button");
        removeButton.className = "remove-block tooltip";
        removeButton.setAttribute("aria-label", "移除區塊");
        removeButton.innerHTML = "✖";
        const removeTooltip = document.createElement("span");
        removeTooltip.className = "tooltiptext";
        removeTooltip.innerText = "移除此區塊";
        removeButton.appendChild(removeTooltip);
        removeButton.onclick = function () {
          document.getElementById("blocks").removeChild(blockDiv);
          updateBlockLabels();
          updateTeX();
          saveToLocalStorage();
        };

        // 組裝標題列
        topRow.appendChild(label);
        topRow.appendChild(removeButton);

        // 選擇框
        const select = document.createElement("select");
        select.innerHTML = `
                        <option value="Example">題目 (Example)</option>
                        <option value="Answer">解答 (Answer)</option>
                        <option value="Section">節 (Section)</option>
                        <option value="Subsection">小節 (Subsection)</option>
                        <option value="Other">其他 (Other)</option>
                    `;
        select.value = type;
        select.onchange = function () {
          const currentValue = select.value;
          textarea.readOnly = false;
          if (currentValue === "Section") {
            textarea.placeholder = "例如：2. 二次導數測試";
          } else if (currentValue === "Subsection") {
            textarea.placeholder = "例如：2.1 小節標題";
          } else {
            textarea.placeholder = placeholderExamples[currentValue];
          }
          updateTeX();
          updateMathPreview(textarea.value, mathPreview);
          saveToLocalStorage();
        };

        // 文字輸入框
        const textarea = document.createElement("textarea");
        textarea.placeholder = placeholderExamples[select.value];
        textarea.value = content;
        textarea.classList.add("collapsed"); // 初始化為收折狀態
        textarea.addEventListener("input", autoResize, false);

        // 收折功能
        textarea.addEventListener("focus", function () {
          // 展開
          textarea.classList.remove("collapsed");
        });
        textarea.addEventListener("blur", function () {
          // 收折
          textarea.classList.add("collapsed");
        });

        // 內容輸入時更新 TeX 和數學預覽
        textarea.addEventListener("input", function () {
          updateTeX();
          updateMathPreview(textarea.value, mathPreview);
          saveToLocalStorage();
        });

        // 數學預覽區
        const mathPreview = document.createElement("div");
        mathPreview.className = "math-preview";

        // 組裝區塊
        blockDiv.appendChild(topRow);
        blockDiv.appendChild(select);
        blockDiv.appendChild(textarea);
        blockDiv.appendChild(mathPreview);

        // 加入拖放事件到 topRow
        topRow.addEventListener("dragstart", function (e) {
          draggedBlock = blockDiv;
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", blockDiv.id);
        });

        blockDiv.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          blockDiv.style.boxShadow = "0 0 10px var(--button-bg-color)";
        });

        blockDiv.addEventListener("dragleave", function (e) {
          blockDiv.style.boxShadow = "none";
        });

        blockDiv.addEventListener("drop", function (e) {
          e.preventDefault();
          blockDiv.style.boxShadow = "none";

          const draggedId = e.dataTransfer.getData("text/plain");
          const draggedBlock = document.getElementById(draggedId);

          if (draggedBlock && draggedBlock !== blockDiv) {
            const blocksContainer = document.getElementById("blocks");
            blocksContainer.insertBefore(draggedBlock, blockDiv);
            updateBlockLabels();
            updateTeX();
            saveToLocalStorage();
          }

          draggedBlock = null;
        });

        // 添加到區塊容器
        document.getElementById("blocks").appendChild(blockDiv);

        // 更新區塊標籤和 TeX
        updateBlockLabels();
        updateTeX();
      }

      function updateBlockLabels() {
        const blocks = document.getElementById("blocks").children;
        blockCount = blocks.length;
        for (let i = 0; i < blocks.length; i++) {
          const label = blocks[i].querySelector(".block-header label");
          label.textContent = "區塊 " + (i + 1) + ":";

          const select = blocks[i].getElementsByTagName("select")[0];
          const textarea = blocks[i].getElementsByTagName("textarea")[0];

          textarea.readOnly = false;
          if (select.value === "Section") {
            textarea.placeholder = "例如：2. 二次導數測試";
          } else if (select.value === "Subsection") {
            textarea.placeholder = "例如：2.1 小節標題";
          } else {
            textarea.placeholder = placeholderExamples[select.value];
          }
        }
      }

      function updateTeX() {
        // 取得檔名
        let texFilename = document.getElementById("tex-filename").value.trim();
        if (!isFilenameManuallyEdited) {
          texFilename =
            document.getElementById("title").value.trim() !== ""
              ? document.getElementById("title").value.trim()
              : "output";
          document.getElementById("tex-filename").value = texFilename;
        }

        // 確保檔名以 .tex 結尾
        if (!texFilename.toLowerCase().endsWith(".tex")) {
          texFilename += ".tex";
        }

        // TeX 模板的開頭
        let texContent = `% !Mode:: "TeX:UTF-8"
\\documentclass[12pt]{article}
\\usepackage{amsmath}%數學符號1
\\usepackage{CJKutf8}%中文表格
\\usepackage{amssymb}%數學符號2
\\usepackage{lmodern}%字型大小
\\usepackage{amsfonts}%數學字型
\\usepackage{natbib}%參考文獻
\\usepackage{graphics}%圖型
\\usepackage{epsfig}%EPS圖型
\\usepackage{subfigure}
\\usepackage{graphicx}
\\usepackage{fancybox}
\\usepackage{url}%輸入網址
\\usepackage{tikz}
\\usepackage[lastexercise]{exercise}
\\usepackage{chngcntr}
\\usepackage{tcolorbox}
\\usepackage{listings}
\\usepackage{multirow}%多列表格
\\usepackage[para,online,flushleft]{threeparttable}%表格註解
\\usepackage{rotating}%表格旋轉
\\usepackage{dcolumn}%讓表格小數點對齊
\\usepackage{caption}

%\\usepackage[table]{xcolor}

\\newcommand{\\gfcb}[1]{%
\\fcolorbox{white}{gray!10!}{\\quad\\strut #1\\quad}
} % gfcb := gray fcolorbox
\\newcommand{\\cop}[1]{%
\\gfcb{\\texttt{\\detokenize{#1}}} 
\\ensuremath{\\quad\\longrightarrow\\quad #1}
} % cop := code output

\\tcbset{arc=0mm,boxrule=1pt,colback=white,colframe=cyan,leftrule=3mm}
%\\usetikzlibrary{decorations.pathreplacing}
\\usepackage{float}
\\newtheorem{example}{Example}[subsection]
\\newtheorem{defin}{Definition}
\\usepackage{setspace} 
\\renewcommand{\\figurename}{圖}
\\renewcommand{\\tablename}{表}
\\renewcommand\\refname{參考文獻}
%\\linespread{1.5}
%\\setcounter{section}{12}
\\renewcommand{\\abstractname}{摘要}
\\definecolor{bisque}{rgb}{.996,.891,.755}
\\definecolor{mypink}{cmyk}{.1,.8,.4,.1}  % cmyk 模型的例子 
\\definecolor{Gray}{gray}{0.85}
\\definecolor{LightCyan}{rgb}{0.88,1,1}

\\newcolumntype{a}{>{\\columncolor{Gray}}c}
\\newcolumntype{b}{>{\\columncolor{white}}c}
%=============================================================================

\\title{${document.getElementById("title").value.trim()}}

\\author{${document.getElementById("author").value.trim()}\\footnote{${document
          .getElementById("email")
          .value.trim()}}\\\\
${document.getElementById("affiliation").value.trim()}.\\\\
%, 姓名\\footnote{連絡資訊與研究單位}
%, 研究單位.\\\\
}

\\date{${document.getElementById("date").value.trim()}}

\\renewcommand{\\theExercise}{\\arabic{Exercise}}
\\renewcommand{\\AnswerHeader}{\\medskip\\noindent\\textcolor{red}{\\textbf{SOLUTION}}\\;}
\\renewcommand{\\ExerciseName}{EXAMPLE}
\\renewcommand{\\ExerciseHeader}{\\noindent\\textbf{\\ExerciseName\\;\\ExerciseHeaderNB}}
\\newenvironment{Example}{\\begin{tcolorbox}\\begin{Exercise}}{\\end{Exercise}\\end{tcolorbox}}
\\setlength{\\ExerciseSkipBefore}{0pt}
\\newcommand\\independent{\\protect\\mathpalette{\\protect\\independenT}{\\perp}}
\\def\\independenT#1#2{\\mathrel{\\rlap{$#1#2$}\\mkern2mu{#1#2}}}

\\begin{document}
\\begin{CJK}{UTF8}{bsmi}

\\maketitle

\\setstretch{1.5}`;

        // 取得所有區塊
        const blocks = document.getElementsByClassName("block");
        for (let i = 0; i < blocks.length; i++) {
          const select = blocks[i].getElementsByTagName("select")[0];
          const textarea = blocks[i].getElementsByTagName("textarea")[0];

          const blockType = select.value;
          const content = textarea.value;

          // 直接使用使用者的輸入，不進行轉義
          const userContent = content;

          // 添加每個區塊的 TeX 內容（不添加額外的換行）
          if (blockType === "Example") {
            texContent += `
%=============第 ${
              i + 1
            } 題 =====================================================
\\begin{Example}
${userContent}
\\end{Example}`;
          } else if (blockType === "Answer") {
            texContent += `
\\begin{Answer}
${userContent}
\\end{Answer}`;
          } else if (blockType === "Section") {
            texContent += `
\\section*{${userContent}}`;
          } else if (blockType === "Subsection") {
            texContent += `
\\subsection*{${userContent}}`;
          } else {
            // 其他自定義內容
            texContent += `
${userContent}`;
          }
        }

        // TeX 模板的結尾
        texContent += `
\\end{CJK}
\\end{document}`;

        // 格式化 TeX 內容
        texContent = formatTeXContent(texContent);

        // 顯示生成的 TeX 內容
        document.getElementById("tex-output").textContent = texContent;
      }

      function formatTeXContent(texContent) {
        const lines = texContent.split("\n");
        let formattedLines = [];
        let indentLevel = 0;
        const indentString = "  "; // 兩個空格作為縮排

        const beginRegex = /\\begin\{[^\}]+\}/g;
        const endRegex = /\\end\{[^\}]+\}/g;

        for (let line of lines) {
          let trimmedLine = line.trim();

          // 調整縮排級別
          let endMatches = trimmedLine.match(endRegex);
          if (endMatches) {
            indentLevel -= endMatches.length;
          }
          indentLevel = Math.max(indentLevel, 0);

          const indentedLine = indentString.repeat(indentLevel) + trimmedLine;
          formattedLines.push(indentedLine);

          let beginMatches = trimmedLine.match(beginRegex);
          if (beginMatches) {
            indentLevel += beginMatches.length;
          }
        }

        return formattedLines.join("\n");
      }

      function updateMathPreview(content, previewElement) {
        // 使用正則表達式過濾出數學式，並使用 MathJax 渲染
        const mathRegex =
          /\$[^$]+\$|\\\[([\\\s\S]+?)\\\]|\\\(([\\\s\S]+?)\\\)/g;

        // 轉義 HTML 特殊字符
        let safeContent = content.replace(/&/g, "&amp;").replace(/</g, "&lt;");

        // 保留換行符號
        safeContent = safeContent.replace(/\n/g, "<br>");

        // 將數學式替換為渲染用的 span
        let renderedContent = safeContent.replace(mathRegex, function (match) {
          return `<span class="math-inline">${match}</span>`;
        });

        // 將渲染內容設置到預覽區域
        previewElement.innerHTML = renderedContent;
        MathJax.typesetPromise([previewElement]);
      }

      // 自動調整 textarea 高度
      function autoResize() {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      }

      // 顯示 Toast 通知
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000);
      }

      // 當元資料變化時，更新 TeX 並保存
      const metadataInputs = document.querySelectorAll("#metadata input");
      let isFilenameManuallyEdited = false;

      document
        .getElementById("tex-filename")
        .addEventListener("input", function () {
          isFilenameManuallyEdited = true;
        });

      metadataInputs.forEach((input) => {
        input.addEventListener("input", function () {
          if (!isFilenameManuallyEdited) {
            let titleValue = document.getElementById("title").value.trim();
            let filename = titleValue !== "" ? titleValue : "output";
            document.getElementById("tex-filename").value = filename;
          }
          updateTeX();
          saveToLocalStorage();
        });
      });

      // 新增區塊按鈕
      document
        .getElementById("add-block")
        .addEventListener("click", function () {
          addBlock();
          saveToLocalStorage();
        });

      // 初始加載資料
      loadFromLocalStorage();

      // 實時更新 TeX 內容
      document.getElementById("blocks").addEventListener("input", function () {
        updateTeX();
        saveToLocalStorage();
      });

      // 複製 TeX 內容
      document
        .getElementById("copy-tex")
        .addEventListener("click", function () {
          const texContent = document.getElementById("tex-output").textContent;
          navigator.clipboard.writeText(texContent).then(
            function () {
              showToast("TeX 內容已複製到剪貼簿");
            },
            function (err) {
              showToast("複製失敗，請手動複製");
            }
          );
        });

      // 下載 TeX 檔案
      function downloadTeX() {
        updateTeX(); // 確保內容是最新的
        const texContent = document.getElementById("tex-output").textContent;
        let filename = document.getElementById("tex-filename").value.trim();
        if (!filename.toLowerCase().endsWith(".tex")) {
          filename += ".tex";
        }
        const blob = new Blob([texContent], {
          type: "text/plain;charset=utf-8",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }

      document
        .getElementById("download-tex")
        .addEventListener("click", downloadTeX);

      // 切換深淺模式
      const toggleThemeButton = document.getElementById("toggle-theme");
      toggleThemeButton.addEventListener("click", function () {
        if (document.documentElement.getAttribute("data-theme") === "dark") {
          document.documentElement.removeAttribute("data-theme");
          toggleThemeButton.innerHTML = '<i class="fas fa-moon"></i>';
        } else {
          document.documentElement.setAttribute("data-theme", "dark");
          toggleThemeButton.innerHTML = '<i class="fas fa-sun"></i>';
        }
      });

      // 自動根據系統設定切換深淺模式
      const prefersDarkScheme = window.matchMedia(
        "(prefers-color-scheme: dark)"
      );

      function applyTheme(e) {
        if (e.matches) {
          document.documentElement.setAttribute("data-theme", "dark");
          toggleThemeButton.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
          document.documentElement.removeAttribute("data-theme");
          toggleThemeButton.innerHTML = '<i class="fas fa-moon"></i>';
        }
      }

      prefersDarkScheme.addEventListener("change", applyTheme);

      // 初始應用主題
      applyTheme(prefersDarkScheme);
    </script>
  </body>
</html>
