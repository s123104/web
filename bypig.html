<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>加密貨幣交易平台 - 模擬大幅波動 K 線圖與交易介面</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <!-- 用最新版的 Lightweight Charts，支援 addCandlestickSeries -->
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <script type="importmap">
      {
        "imports": {
          "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js"
        }
      }
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        min-height: 100dvh;
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
          env(safe-area-inset-bottom) env(safe-area-inset-left);
        background-color: #0a0e17;
        color: #e5e5e5;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        overflow: hidden;
      }
      .app-container {
        display: flex;
        flex-direction: column;
        height: 100dvh;
      }
      .header {
        padding: 10px 15px;
        background-color: #151b29;
        border-bottom: 1px solid #2c3647;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .symbol-info h1 {
        font-size: 18px;
        margin-bottom: 4px;
      }
      .price-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .current-price {
        font-size: 16px;
        font-weight: bold;
      }
      .price-change {
        font-size: 14px;
        padding: 2px 6px;
        border-radius: 4px;
      }
      .price-change.positive {
        color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
      }
      .price-change.negative {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
      }
      .tab-switcher {
        display: flex;
        gap: 10px;
      }
      .tab-btn {
        padding: 8px 15px;
        background-color: transparent;
        border: 1px solid #2c3647;
        border-radius: 4px;
        color: #e5e5e5;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .tab-btn:hover {
        background-color: #1c2536;
      }
      .tab-btn.active {
        background-color: #1c2536;
        border-color: #3a7bd5;
      }
      .main-content {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 60px;
      }
      .content-section {
        display: none;
        flex: 1;
      }
      .content-section.active {
        display: block;
      }
      .timeframe-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 10px;
        background-color: #151b29;
      }
      .timeframe-btn {
        padding: 5px 10px;
        background-color: transparent;
        border: 1px solid #2c3647;
        border-radius: 4px;
        color: #e5e5e5;
        font-size: 12px;
        cursor: pointer;
      }
      .timeframe-btn.active {
        background-color: #1c2536;
        border-color: #3a7bd5;
      }
      .market-condition {
        padding: 3px;
        background-color: #151b29;
        text-align: center;
        margin-left: auto;
        margin-right: auto;
      }
      .market-condition label {
        margin-right: 10px;
        font-weight: bold;
      }
      .market-condition select {
        padding: 5px 8px;
        background-color: #151b29;
        border: 1px solid #2c3647;
        border-radius: 4px;
        color: #e5e5e5;
      }

      /* === K 線圖 & 成交量上下分離：上 80%，下 20% === */
      .chart-volume-container {
        display: flex;
        flex-direction: column;
        height: 400px; /* 可自行調整 */
        width: 100%;
      }
      .chart-area {
        flex: 0 0 80%;
        background-color: #151b29;
        position: relative;
      }
      .volume-area {
        flex: 0 0 20%;
        background-color: #151b29;
        border-top: 1px solid #2c3647;
        position: relative;
      }

      .indicators {
        display: flex;
        flex-wrap: wrap;
        padding: 10px;
        background-color: #151b29;
        border-top: 1px solid #2c3647;
      }
      .indicator {
        margin-right: 15px;
        font-size: 12px;
      }
      .indicator-name {
        color: #8c8c8c;
      }

      /* === 訂單簿在最下面 === */
      .orderbook-below-chart {
        padding: 15px;
        background-color: #151b29;
        border-top: 1px solid #2c3647;
      }
      .orderbook-below-chart h3 {
        margin-bottom: 15px;
        font-size: 16px;
      }
      .orderbook-below-chart .orderbook {
        position: relative;
      }
      .orderbook-below-chart .orderbook-header {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        padding: 8px 0;
        font-size: 13px;
        color: #8c8c8c;
        border-bottom: 1px solid #2c3647;
      }
      .orderbook-below-chart .orderbook-asks,
      .orderbook-below-chart .orderbook-bids {
        position: relative;
      }
      .orderbook-below-chart .orderbook-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        padding: 6px 0;
        font-size: 13px;
        position: relative;
        z-index: 1;
      }
      .orderbook-below-chart .depth-bar {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        z-index: -1;
      }
      .orderbook-below-chart .depth-bar.sell {
        background-color: rgba(220, 53, 69, 0.1);
      }
      .orderbook-below-chart .depth-bar.buy {
        background-color: rgba(40, 167, 69, 0.1);
      }
      .orderbook-below-chart .price.sell {
        color: #dc3545;
      }
      .orderbook-below-chart .price.buy {
        color: #28a745;
      }
      .orderbook-below-chart .orderbook-current-price {
        text-align: center;
        padding: 8px 0;
        background-color: #1c2536;
        margin: 5px 0;
      }
      .orderbook-below-chart .current {
        font-weight: bold;
        font-size: 14px;
      }

      /* === 交易介面：左下單 60%，右訂單簿 40% === */
      .trade-section {
        background-color: #151b29;
      }
      .trade-layout {
        display: flex;
        width: 100%;
      }
      .trade-form-container {
        flex: 6;
        border-right: 1px solid #2c3647;
        padding: 0 10px;
      }
      .trade-tabs {
        display: flex;
        padding: 10px;
        background-color: #151b29;
        border-bottom: 1px solid #2c3647;
      }
      .trade-tab-btn {
        flex: 1;
        padding: 8px;
        background-color: transparent;
        border: none;
        color: #e5e5e5;
        font-size: 14px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
      }
      .trade-tab-btn.active {
        border-bottom: 2px solid #3a7bd5;
        font-weight: bold;
      }
      .trade-content {
        display: none;
        padding: 8px;
        background-color: #151b29;
      }
      .trade-content.active {
        display: block;
      }
      .leverage-slider {
        margin-bottom: 10px;
      }
      .leverage-slider label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
      }
      .slider {
        width: 100%;
        height: 5px;
        background: #1c2536;
        border-radius: 5px;
        outline: none;
        -webkit-appearance: none;
      }
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #3a7bd5;
        cursor: pointer;
      }
      .leverage-marks {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
        font-size: 12px;
        color: #8c8c8c;
      }
      .order-input {
        margin-bottom: 10px;
      }
      .order-input label {
        display: block;
        margin-bottom: 3px;
        font-size: 14px;
      }
      .order-input input {
        width: 100%;
        padding: 8px;
        background-color: #1c2536;
        border: 1px solid #2c3647;
        border-radius: 4px;
        color: #e5e5e5;
        font-size: 14px;
      }
      .available-balance {
        margin-bottom: 10px;
        font-size: 13px;
        color: #8c8c8c;
      }
      .order-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .btn-long,
      .btn-short {
        padding: 12px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
        color: white;
        cursor: pointer;
      }
      .btn-long {
        background-color: #28a745;
      }
      .btn-short {
        background-color: #dc3545;
      }
      /* 交易區塊右側訂單簿 (40%) */
      .orderbook-right-container {
        flex: 4;
        padding: 10px;
        background-color: #151b29;
      }
      .orderbook-right-container .orderbook {
        position: relative;
      }
      .orderbook-right-container .orderbook-header {
        display: grid;
        grid-template-columns: 1fr 1fr;
        padding: 8px 0;
        font-size: 13px;
        color: #8c8c8c;
        border-bottom: 1px solid #2c3647;
      }
      .orderbook-right-container .orderbook-asks,
      .orderbook-right-container .orderbook-bids {
        position: relative;
      }
      .orderbook-right-container .orderbook-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        padding: 6px 0;
        font-size: 13px;
        position: relative;
        z-index: 1;
      }
      .orderbook-right-container .depth-bar {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        z-index: -1;
      }
      .orderbook-right-container .depth-bar.sell {
        background-color: rgba(220, 53, 69, 0.1);
      }
      .orderbook-right-container .depth-bar.buy {
        background-color: rgba(40, 167, 69, 0.1);
      }
      .orderbook-right-container .price.sell {
        color: #dc3545;
      }
      .orderbook-right-container .price.buy {
        color: #28a745;
      }
      .orderbook-right-container .orderbook-current-price {
        text-align: center;
        padding: 8px 0;
        background-color: #1c2536;
        margin: 5px 0;
      }
      .orderbook-right-container .current {
        font-weight: bold;
        font-size: 14px;
      }
      .positions-section {
        padding: 15px;
        background-color: #151b29;
        border-top: 1px solid #2c3647;
        border-bottom: 1px solid #2c3647;
      }
      .positions-section h3 {
        margin-bottom: 15px;
        font-size: 16px;
      }
      .position-card {
        background-color: #1c2536;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 10px;
      }
      .position-header {
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.05);
      }
      .position-symbol {
        font-weight: bold;
      }
      .position-type {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
      }
      .position-type.long {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
      }
      .position-type.short {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
      }
      .position-details {
        padding: 10px;
      }
      .position-info {
        margin-bottom: 15px;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 13px;
      }
      .info-row span:first-child {
        color: #8c8c8c;
      }
      .profit {
        color: #28a745;
      }
      .loss {
        color: #dc3545;
      }
      .position-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .position-btn {
        flex: 1;
        padding: 8px;
        background-color: #151b29;
        border: 1px solid #2c3647;
        border-radius: 4px;
        color: #e5e5e5;
        font-size: 12px;
        cursor: pointer;
      }
      .position-btn.close-btn {
        background-color: rgba(220, 53, 69, 0.1);
        border-color: #dc3545;
        color: #dc3545;
      }
      .bottom-nav {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #151b29;
        border-top: 1px solid #2c3647;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        padding: 8px 0;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
        z-index: 1000;
      }
      .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        background-color: transparent;
        border: none;
        color: #8c8c8c;
        font-size: 12px;
        cursor: pointer;
        padding: 8px;
      }
      .nav-btn i {
        font-size: 16px;
      }
      .nav-btn.active {
        color: #3a7bd5;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="app-container">
        <div class="header">
          <div class="symbol-info">
            <h1>ETHUSDT</h1>
            <div class="price-info">
              <span class="current-price">{{ currentPrice.toFixed(2) }}</span>
              <span
                :class="['price-change', priceChange >= 0 ? 'positive' : 'negative']"
              >
                {{ priceChange >= 0 ? '+' : '' }}{{ priceChange.toFixed(2) }}%
              </span>
            </div>
          </div>
          <div class="tab-switcher">
            <button
              :class="['tab-btn', currentTab==='chart' ? 'active' : '']"
              @click="switchToChart"
            >
              <i class="fas fa-chart-line"></i> 走勢圖
            </button>
            <button
              :class="['tab-btn', currentTab==='trade' ? 'active' : '']"
              @click="currentTab='trade'"
            >
              <i class="fas fa-exchange-alt"></i> 交易
            </button>
          </div>
        </div>
        <div class="main-content">
          <!-- 走勢圖 TAB -->
          <div
            v-if="currentTab==='chart'"
            class="content-section chart-section active"
          >
            <div class="timeframe-selector">
              <button
                v-for="frame in timeframes"
                :key="frame"
                :class="['timeframe-btn', selectedTimeframe===frame ? 'active' : '']"
                @click="selectTimeframe(frame)"
              >
                {{ frame }}
              </button>
            </div>
            <div class="market-condition">
              <label>市場狀態:</label>
              <select v-model="marketCondition">
                <option value="volatile">大幅波動</option>
                <option value="bull">牛市行情</option>
                <option value="sideways">橫盤行情</option>
                <option value="bear">熊市行情</option>
              </select>
            </div>
            <!-- 上面 80% K 線 + 下面 20% 成交量 -->
            <div class="chart-volume-container">
              <div class="chart-area" ref="chartRef"></div>
              <div class="volume-area" ref="volumeRef"></div>
            </div>
            <!-- 指標區 -->
            <div class="indicators">
              <div class="indicator">
                <span class="indicator-name">MA7:</span>
                <span class="indicator-value">{{ ma7Value || '--' }}</span>
              </div>
              <div class="indicator">
                <span class="indicator-name">MA14:</span>
                <span class="indicator-value">{{ ma14Value || '--' }}</span>
              </div>
              <div class="indicator">
                <span class="indicator-name">MA28:</span>
                <span class="indicator-value">{{ ma28Value || '--' }}</span>
              </div>
              <div class="indicator">
                <span class="indicator-name">MACD:</span>
                <span class="indicator-value">{{ macdValue || '--' }}</span>
              </div>
              <div class="indicator">
                <span class="indicator-name">RSI:</span>
                <span class="indicator-value">65.3</span>
              </div>
            </div>
            <!-- 原本的訂單簿區塊 (在走勢圖最下方) -->
            <div class="orderbook-below-chart">
              <h3>訂單簿</h3>
              <div class="orderbook">
                <div class="orderbook-header">
                  <span>價格</span>
                  <span>數量</span>
                  <span>總額</span>
                </div>
                <div class="orderbook-asks">
                  <div
                    v-for="ask in orderbookAsks"
                    :key="ask.price + 'chart'"
                    class="orderbook-row"
                  >
                    <span class="price sell">{{ ask.price.toFixed(2) }}</span>
                    <span class="amount">{{ ask.amount.toFixed(3) }}</span>
                    <span class="total"
                      >{{ (ask.price * ask.amount).toFixed(2) }}</span
                    >
                    <div
                      class="depth-bar sell"
                      :style="{ width: (ask.depth * 100) + '%' }"
                    ></div>
                  </div>
                </div>
                <div class="orderbook-current-price">
                  <span class="current">{{ currentPrice.toFixed(2) }}</span>
                </div>
                <div class="orderbook-bids">
                  <div
                    v-for="bid in orderbookBids"
                    :key="bid.price + 'chart'"
                    class="orderbook-row"
                  >
                    <span class="price buy">{{ bid.price.toFixed(2) }}</span>
                    <span class="amount">{{ bid.amount.toFixed(3) }}</span>
                    <span class="total"
                      >{{ (bid.price * bid.amount).toFixed(2) }}</span
                    >
                    <div
                      class="depth-bar buy"
                      :style="{ width: (bid.depth * 100) + '%' }"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 交易 TAB -->
          <div
            v-if="currentTab==='trade'"
            class="content-section trade-section active"
            id="trade-section"
          >
            <div class="trade-layout">
              <!-- 左下單 (60%) -->
              <div class="trade-form-container">
                <div class="trade-tabs">
                  <button
                    class="trade-tab-btn"
                    :class="{ active: tradeTab==='market' }"
                    @click="tradeTab='market'"
                  >
                    市價單
                  </button>
                  <button
                    class="trade-tab-btn"
                    :class="{ active: tradeTab==='limit' }"
                    @click="tradeTab='limit'"
                  >
                    限價單
                  </button>
                </div>
                <div
                  class="trade-content"
                  :class="{ active: tradeTab==='market' }"
                  v-if="tradeTab==='market'"
                >
                  <div class="leverage-slider">
                    <label
                      >槓桿倍數:
                      <span id="leverage-value"
                        >{{ leverageMarket }}x</span
                      ></label
                    >
                    <input
                      type="range"
                      min="1"
                      max="75"
                      v-model="leverageMarket"
                      class="slider"
                      id="leverage-slider"
                    />
                    <div class="leverage-marks">
                      <span>1x</span>
                      <span>25x</span>
                      <span>50x</span>
                      <span>75x</span>
                    </div>
                  </div>
                  <div class="order-input">
                    <label>數量 (ETH)</label>
                    <input
                      type="number"
                      step="0.001"
                      v-model="quantity"
                      min="0.001"
                    />
                  </div>
                  <div class="available-balance">
                    <span>可用資金: 31.35 USDT</span>
                  </div>
                  <div class="order-buttons">
                    <button
                      class="btn-long"
                      @click="placeOrder('long', 'market')"
                    >
                      <i class="fas fa-arrow-up"></i> 做多
                    </button>
                    <button
                      class="btn-short"
                      @click="placeOrder('short', 'market')"
                    >
                      <i class="fas fa-arrow-down"></i> 做空
                    </button>
                  </div>
                </div>
                <div
                  class="trade-content"
                  :class="{ active: tradeTab==='limit' }"
                  v-if="tradeTab==='limit'"
                >
                  <div class="leverage-slider">
                    <label
                      >槓桿倍數:
                      <span id="leverage-value-limit"
                        >{{ leverageLimit }}x</span
                      ></label
                    >
                    <input
                      type="range"
                      min="1"
                      max="75"
                      v-model="leverageLimit"
                      class="slider"
                      id="leverage-slider-limit"
                    />
                    <div class="leverage-marks">
                      <span>1x</span>
                      <span>25x</span>
                      <span>50x</span>
                      <span>75x</span>
                    </div>
                  </div>
                  <div class="order-input">
                    <label>價格 (USDT)</label>
                    <input
                      type="number"
                      step="0.01"
                      v-model="limitPrice"
                      min="0.01"
                    />
                  </div>
                  <div class="order-input">
                    <label>數量 (ETH)</label>
                    <input
                      type="number"
                      step="0.001"
                      v-model="quantity"
                      min="0.001"
                    />
                  </div>
                  <div class="available-balance">
                    <span>可用資金: 31.35 USDT</span>
                  </div>
                  <div class="order-buttons">
                    <button
                      class="btn-long"
                      @click="placeOrder('long', 'limit')"
                    >
                      <i class="fas fa-arrow-up"></i> 做多
                    </button>
                    <button
                      class="btn-short"
                      @click="placeOrder('short', 'limit')"
                    >
                      <i class="fas fa-arrow-down"></i> 做空
                    </button>
                  </div>
                </div>
              </div>
              <!-- 右側訂單簿 (只顯示 6 筆買、6 筆賣) -->
              <div class="orderbook-right-container">
                <div class="orderbook">
                  <div class="orderbook-header">
                    <span>價格</span>
                    <span>數量</span>
                  </div>
                  <div class="orderbook-asks">
                    <div
                      v-for="ask in tradeOrderbookAsks"
                      :key="ask.price + 'trade'"
                      class="orderbook-row"
                    >
                      <span class="price sell">{{ ask.price.toFixed(2) }}</span>
                      <span class="amount">{{ ask.amount.toFixed(3) }}</span>
                      <div
                        class="depth-bar sell"
                        :style="{ width: (ask.depth * 100) + '%' }"
                      ></div>
                    </div>
                  </div>
                  <div class="orderbook-current-price">
                    <span class="current">{{ currentPrice.toFixed(2) }}</span>
                  </div>
                  <div class="orderbook-bids">
                    <div
                      v-for="bid in tradeOrderbookBids"
                      :key="bid.price + 'trade'"
                      class="orderbook-row"
                    >
                      <span class="price buy">{{ bid.price.toFixed(2) }}</span>
                      <span class="amount">{{ bid.amount.toFixed(3) }}</span>
                      <div
                        class="depth-bar buy"
                        :style="{ width: (bid.depth * 100) + '%' }"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- 持倉區塊放在交易介面下方 -->
            <div class="positions-section">
              <h3>持倉</h3>
              <div class="position-card">
                <div class="position-header">
                  <span class="position-symbol">ETHUSDT</span>
                  <span class="position-type long"
                    >做多 {{ leverageMarket }}x</span
                  >
                </div>
                <div class="position-details">
                  <div class="position-info">
                    <div class="info-row">
                      <span>持倉數量:</span>
                      <span>0.025 ETH</span>
                    </div>
                    <div class="info-row">
                      <span>入場價格:</span>
                      <span>2120.45 USDT</span>
                    </div>
                    <div class="info-row">
                      <span>標記價格:</span>
                      <span>{{ currentPrice.toFixed(2) }} USDT</span>
                    </div>
                    <div class="info-row">
                      <span>強平價格:</span>
                      <span>1880.00 USDT</span>
                    </div>
                    <div class="info-row">
                      <span>未結盈虧:</span>
                      <span class="profit">+5.47 USDT (+1.20%)</span>
                    </div>
                  </div>
                  <div class="position-actions">
                    <button class="position-btn">
                      <i class="fas fa-stop-circle"></i> 止盈止損
                    </button>
                    <button class="position-btn">
                      <i class="fas fa-chart-area"></i> 追蹤出場
                    </button>
                    <button class="position-btn close-btn">
                      <i class="fas fa-hand-holding-usd"></i> 平倉
                    </button>
                  </div>
                </div>
              </div>
              <div class="position-card">
                <div class="position-header">
                  <span class="position-symbol">BTCUSDT</span>
                  <span class="position-type short">做空 20x</span>
                </div>
                <div class="position-details">
                  <div class="position-info">
                    <div class="info-row">
                      <span>持倉數量:</span>
                      <span>0.001 BTC</span>
                    </div>
                    <div class="info-row">
                      <span>入場價格:</span>
                      <span>50000.00 USDT</span>
                    </div>
                    <div class="info-row">
                      <span>標記價格:</span>
                      <span>49800.00 USDT</span>
                    </div>
                    <div class="info-row">
                      <span>強平價格:</span>
                      <span>52000.00 USDT</span>
                    </div>
                    <div class="info-row">
                      <span>未結盈虧:</span>
                      <span class="loss">-150.00 USDT (-0.30%)</span>
                    </div>
                  </div>
                  <div class="position-actions">
                    <button class="position-btn">
                      <i class="fas fa-stop-circle"></i> 止盈止損
                    </button>
                    <button class="position-btn">
                      <i class="fas fa-chart-area"></i> 追蹤出場
                    </button>
                    <button class="position-btn close-btn">
                      <i class="fas fa-hand-holding-usd"></i> 平倉
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- 持倉區塊結束 -->
          </div>
        </div>
        <div class="bottom-nav">
          <button class="nav-btn" @click="switchToChart">
            <i class="fas fa-home"></i>
            <span>行情</span>
          </button>
          <button class="nav-btn" @click="switchToChart">
            <i class="fas fa-chart-bar"></i>
            <span>走勢圖</span>
          </button>
          <button class="nav-btn" @click="currentTab='trade'">
            <i class="fas fa-exchange-alt"></i>
            <span>交易</span>
          </button>
          <button class="nav-btn">
            <i class="fas fa-wallet"></i>
            <span>資產</span>
          </button>
          <button class="nav-btn">
            <i class="fas fa-cog"></i>
            <span>設置</span>
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { createApp, ref, onMounted, watch, nextTick } from "vue";

      const app = createApp({
        setup() {
          const currentTab = ref("chart");
          // 預設交易頁籤改成限價單
          const tradeTab = ref("limit");
          const leverageMarket = ref(10);
          const leverageLimit = ref(34);
          const quantity = ref(0.01);
          const limitPrice = ref(2148.42);
          const currentPrice = ref(2148.42);
          const priceChange = ref(0.1);
          const selectedTimeframe = ref("1秒");
          const timeframes = [
            "1秒",
            "1分",
            "3分",
            "5分",
            "15分",
            "30分",
            "1小時",
            "4小時",
            "1天",
            "1週",
            "1月",
          ];
          const ma7Value = ref("--");
          const ma14Value = ref("--");
          const ma28Value = ref("--");
          const macdValue = ref("--");
          const chartRef = ref(null);
          const volumeRef = ref(null);
          const marketCondition = ref("volatile");

          // chart 頁面下方的訂單簿 (6 asks + 6 bids 也可以，但你沒特別說要改這個，我還是用同一個function)
          const orderbookAsks = ref([]);
          const orderbookBids = ref([]);

          // 交易頁面的訂單簿 (只要 6 asks, 6 bids)
          const tradeOrderbookAsks = ref([]);
          const tradeOrderbookBids = ref([]);

          let chartData = [];
          let mainChart = null;
          let volumeChart = null;
          let candlestickSeries = null;
          let volumeSeries = null;
          let retryCount = 0;
          const MAX_RETRIES = 5;

          onMounted(() => {
            initCharts();
            // init for chart tab
            initOrderbook();
            // init for trade tab (only 6 each)
            initTradeOrderbook();
            simulateRealTimeUpdates();
          });

          watch(currentTab, (newVal) => {
            if (newVal === "trade") {
              nextTick(() => {
                checkTradeSection();
              });
            }
            if (newVal === "chart") {
              nextTick(() => {
                if (mainChart) mainChart.timeScale().fitContent();
                if (volumeChart) volumeChart.timeScale().fitContent();
              });
            }
          });

          function checkTradeSection() {
            const tradeSection = document.getElementById("trade-section");
            if (!tradeSection) {
              console.error("【錯誤】找不到 #trade-section DOM 元素！");
            } else {
              console.log("✔ #trade-section DOM 元素存在");
            }
          }

          function initCharts() {
            if (
              typeof LightweightCharts !== "undefined" &&
              typeof LightweightCharts.createChart === "function" &&
              chartRef.value &&
              volumeRef.value
            ) {
              // 建立主走勢圖
              mainChart = LightweightCharts.createChart(chartRef.value, {
                width: chartRef.value.clientWidth,
                height: chartRef.value.clientHeight,
                layout: {
                  background: { color: "#151b29" },
                  textColor: "#e5e5e5",
                },
                grid: {
                  vertLines: { color: "#2c3647" },
                  horzLines: { color: "#2c3647" },
                },
                timeScale: {
                  timeVisible: true,
                  secondsVisible: false,
                },
                priceScale: {
                  borderColor: "#2c3647",
                },
              });

              candlestickSeries = mainChart.addCandlestickSeries({
                upColor: "#26a69a",
                downColor: "#ef5350",
                borderVisible: false,
                wickVisible: true,
              });

              // 建立成交量圖
              volumeChart = LightweightCharts.createChart(volumeRef.value, {
                width: volumeRef.value.clientWidth,
                height: volumeRef.value.clientHeight,
                layout: {
                  background: { color: "#151b29" },
                  textColor: "#e5e5e5",
                },
                grid: {
                  vertLines: { color: "#2c3647" },
                  horzLines: { color: "#2c3647" },
                },
                // 隱藏 timeScale
                timeScale: {
                  visible: false, // 把時間軸藏掉
                },
                priceScale: {
                  borderColor: "#2c3647",
                  scaleMargins: {
                    top: 0.05,
                    bottom: 0,
                  },
                },
              });

              volumeSeries = volumeChart.addHistogramSeries({
                priceFormat: { type: "volume" },
                color: "#26a69a",
              });

              // 初始化假資料
              chartData = generateInitialData();
              candlestickSeries.setData(chartData);
              setVolumeData(chartData);

              mainChart.timeScale().fitContent();
              volumeChart.timeScale().fitContent();

              // 同步 timeScales (主要是為了讓滑動對齊)
              syncTimeScales(mainChart, volumeChart);
            } else if (retryCount < MAX_RETRIES) {
              console.error("輕量圖尚未正確載入或 chartRef 未就緒，重試中...");
              retryCount++;
              setTimeout(initCharts, 1000 * retryCount);
            } else {
              console.error(
                "無法載入 TradingView Lightweight Charts，請確認網路連線或腳本 URL"
              );
            }
          }

          function syncTimeScales(chart1, chart2) {
            const onVisibleLogicalRangeChanged = () => {
              const range = chart1.timeScale().getVisibleLogicalRange();
              if (range) {
                chart2.timeScale().setVisibleLogicalRange(range);
              }
            };
            chart1
              .timeScale()
              .subscribeVisibleLogicalRangeChange(onVisibleLogicalRangeChanged);
            chart2.timeScale().subscribeVisibleLogicalRangeChange(() => {
              const range = chart2.timeScale().getVisibleLogicalRange();
              if (range) {
                chart1.timeScale().setVisibleLogicalRange(range);
              }
            });
          }

          function setVolumeData(data) {
            const volumeData = data.map((c) => {
              return {
                time: c.time,
                value: c.volume,
                color: c.close >= c.open ? "#26a69a" : "#ef5350",
              };
            });
            volumeSeries.setData(volumeData);
          }

          function generateInitialData() {
            const data = [];
            let basePrice = 2148;
            let currentTime =
              Date.now() - 100 * getIntervalMs(selectedTimeframe.value);
            const candleCount = 100;
            for (let i = 0; i < candleCount; i++) {
              let priceVariation;
              switch (marketCondition.value) {
                case "bull":
                  priceVariation = Math.abs(Math.random() * 20);
                  break;
                case "sideways":
                  priceVariation = (Math.random() - 0.5) * 5;
                  break;
                case "bear":
                  priceVariation = -Math.abs(Math.random() * 20);
                  break;
                default:
                  priceVariation = (Math.random() - 0.5) * 50;
              }
              const open = basePrice + priceVariation;
              const close = open + (Math.random() - 0.5) * 50;
              const high = Math.max(open, close) + Math.random() * 30;
              const low = Math.min(open, close) - Math.random() * 30;
              const volume = Math.floor(Math.random() * 1000) + 1; // 模擬交易量

              data.push({
                time: Math.floor(currentTime / 1000),
                open: parseFloat(open.toFixed(2)),
                high: parseFloat(high.toFixed(2)),
                low: parseFloat(low.toFixed(2)),
                close: parseFloat(close.toFixed(2)),
                volume,
              });
              basePrice = close;
              currentTime += getIntervalMs(selectedTimeframe.value);
            }
            return data;
          }

          function simulateRealTimeUpdates() {
            setInterval(() => {
              const lastCandle = chartData[chartData.length - 1];
              let newPrice;
              switch (marketCondition.value) {
                case "bull":
                  newPrice = lastCandle.close + Math.abs(Math.random() * 20);
                  break;
                case "sideways":
                  newPrice = lastCandle.close + (Math.random() - 0.5) * 5;
                  break;
                case "bear":
                  newPrice = lastCandle.close - Math.abs(Math.random() * 20);
                  break;
                default:
                  newPrice = lastCandle.close + (Math.random() - 0.5) * 50;
              }
              newPrice = parseFloat(newPrice.toFixed(2));
              const newVolume = Math.floor(Math.random() * 1000) + 1;

              currentPrice.value = newPrice;
              priceChange.value =
                ((newPrice - lastCandle.close) / lastCandle.close) * 100;

              const newCandle = {
                time: Math.floor(Date.now() / 1000),
                open: lastCandle.close,
                close: newPrice,
                high: Math.max(lastCandle.close, newPrice) + Math.random() * 20,
                low: Math.min(lastCandle.close, newPrice) - Math.random() * 20,
                volume: newVolume,
              };
              chartData.push(newCandle);

              // 更新走勢
              candlestickSeries.update(newCandle);
              // 更新成交量
              volumeSeries.update({
                time: newCandle.time,
                value: newCandle.volume,
                color:
                  newCandle.close >= newCandle.open ? "#26a69a" : "#ef5350",
              });

              // 指標
              ma7Value.value = calculateMA(7).toFixed(2) || "--";
              ma14Value.value = calculateMA(14).toFixed(2) || "--";
              ma28Value.value = calculateMA(28).toFixed(2) || "--";
              macdValue.value = "--";

              // 更新訂單簿
              updateOrderbook();
              updateTradeOrderbook();
            }, getIntervalMs(selectedTimeframe.value) / 2);
          }

          function calculateMA(period) {
            if (chartData.length < period) return 0;
            let sum = 0;
            for (let i = chartData.length - period; i < chartData.length; i++) {
              sum += chartData[i].close;
            }
            return sum / period;
          }

          function selectTimeframe(frame) {
            selectedTimeframe.value = frame;
            if (mainChart && volumeChart) {
              chartData = generateInitialData();
              candlestickSeries.setData(chartData);
              setVolumeData(chartData);
              mainChart.timeScale().fitContent();
              volumeChart.timeScale().fitContent();
            }
          }

          function getIntervalMs(frame) {
            const mappings = {
              "1秒": 1000,
              "1分": 60000,
              "3分": 180000,
              "5分": 300000,
              "15分": 900000,
              "30分": 1800000,
              "1小時": 3600000,
              "4小時": 14400000,
              "1天": 86400000,
              "1週": 604800000,
              "1月": 2592000000,
            };
            return mappings[frame] || 1000;
          }

          // chart tab 訂單簿 (預設 6 筆就好)
          function initOrderbook() {
            orderbookAsks.value = generateOrderbookSide("ask", 6);
            orderbookBids.value = generateOrderbookSide("bid", 6);
          }
          function updateOrderbook() {
            orderbookAsks.value = generateOrderbookSide("ask", 6);
            orderbookBids.value = generateOrderbookSide("bid", 6);
          }

          // trade tab 訂單簿 (6 筆)
          function initTradeOrderbook() {
            tradeOrderbookAsks.value = generateOrderbookSide("ask", 6);
            tradeOrderbookBids.value = generateOrderbookSide("bid", 6);
          }
          function updateTradeOrderbook() {
            tradeOrderbookAsks.value = generateOrderbookSide("ask", 6);
            tradeOrderbookBids.value = generateOrderbookSide("bid", 6);
          }

          // side = "ask" or "bid", count = 6
          function generateOrderbookSide(side, count) {
            const result = [];
            for (let i = 0; i < count; i++) {
              const price =
                side === "ask"
                  ? currentPrice.value + Math.random() * 20
                  : currentPrice.value - Math.random() * 20;
              const amount = 0.1 + Math.random() * 1.5;
              const depth = Math.random() * 0.3;
              result.push({ price, amount, depth });
            }
            if (side === "ask") {
              result.sort((a, b) => a.price - b.price);
            } else {
              result.sort((a, b) => b.price - a.price);
            }
            return result;
          }

          function placeOrder(type, orderType = "market") {
            const usedLeverage =
              orderType === "limit"
                ? leverageLimit.value
                : leverageMarket.value;
            console.log(
              `下單 ${type} ${orderType} 訂單，槓桿 ${usedLeverage}x，數量 ${
                quantity.value
              }，價格 ${
                orderType === "limit" ? limitPrice.value : currentPrice.value
              }`
            );
          }

          function switchToChart() {
            currentTab.value = "chart";
            nextTick(() => {
              if (mainChart) mainChart.timeScale().fitContent();
              if (volumeChart) volumeChart.timeScale().fitContent();
            });
          }

          return {
            currentTab,
            tradeTab,
            leverageMarket,
            leverageLimit,
            quantity,
            limitPrice,
            currentPrice,
            priceChange,
            selectedTimeframe,
            timeframes,
            ma7Value,
            ma14Value,
            ma28Value,
            macdValue,
            chartRef,
            volumeRef,
            marketCondition,
            selectTimeframe,
            placeOrder,
            orderbookAsks,
            orderbookBids,
            tradeOrderbookAsks,
            tradeOrderbookBids,
            switchToChart,
          };
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
