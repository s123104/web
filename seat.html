<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºèƒ½åº§ä½è¡¨ç”Ÿæˆå™¨</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª‘</text></svg>"
    />
    <!-- å¼•å…¥XLSXå’ŒFileSaver.jsåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
      :root {
        --primary-color: #4a90e2;
        --secondary-color: #f39c12;
        --background-color: #f5f7fa;
        --text-color: #333;
        --border-color: #e0e0e0;
        --disabled-color: #ccc;
        --seat-height: 80px; /* èª¿æ•´åº§ä½é«˜åº¦ */
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
        background-color: #ffffff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
      }

      .header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .header input {
        padding: 8px;
        font-size: 16px;
        width: 300px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      .podium {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background-color: var(--secondary-color);
        color: white;
        font-weight: bold;
        border-radius: 4px;
      }

      .seating-chart-container {
        overflow-x: auto;
        outline: none; /* ç§»é™¤ç„¦é»é‚Šæ¡† */
      }

      .seating-chart {
        display: grid;
        gap: 2px;
        justify-content: center;
        margin-bottom: 20px;
        outline: none; /* ç§»é™¤ç„¦é»é‚Šæ¡† */
      }

      .seating-chart .label-row {
        display: contents;
      }

      .seating-chart .label-cell {
        background-color: #f0f0f0;
        text-align: center;
        font-weight: bold;
        padding: 10px;
        border: 1px solid var(--border-color);
        min-width: 60px;
      }

      .seating-chart .seat {
        width: 100%;
        height: var(--seat-height);
        padding: 5px;
        text-align: center;
        background-color: #fff;
        border: 1px solid var(--border-color);
        cursor: grab;
        user-select: none;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 14px;
        box-sizing: border-box;
        position: relative;
      }

      .seating-chart .seat:active {
        cursor: grabbing;
      }

      .seat:hover {
        background-color: #e0f7fa;
      }

      .seat.disabled {
        background-color: var(--disabled-color) !important;
        cursor: not-allowed !important;
      }

      .seat .seat-id,
      .seat .seat-name {
        flex: 1;
        padding: 2px 0;
        border: none;
        background: transparent;
        text-align: center;
        outline: none;
        position: relative;
      }

      .seat .seat-id::before,
      .seat .seat-name::before {
        content: attr(data-placeholder);
        color: #aaa;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }

      .seat .seat-id:not(:empty)::before,
      .seat .seat-name:not(:empty)::before {
        content: "";
      }

      .seat .seat-id[contenteditable="true"],
      .seat .seat-name[contenteditable="true"] {
        border-bottom: 1px dashed #4a90e2;
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .button {
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-size: 16px;
        border-radius: 4px;
      }

      .button:hover {
        background-color: #3476c5;
      }

      #message {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        border-radius: 5px;
        display: none;
      }

      #message.success {
        background-color: #d4edda;
        color: #155724;
      }

      #message.error {
        background-color: #f8d7da;
        color: #721c24;
      }

      /* Modal Styles */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0, 0, 0, 0.5); /* Black w/ opacity */
      }

      .modal-content {
        background-color: #fefefe;
        margin: 10% auto; /* 10% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
        max-width: 500px;
        border-radius: 8px;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
      }

      .saved-list {
        list-style-type: none;
        padding: 0;
      }

      .saved-list li {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
      }

      .saved-list li:hover {
        background-color: #f0f0f0;
      }

      .description {
        text-align: center;
        margin-top: 30px;
        font-size: 14px;
        color: #555;
      }

      @media (max-width: 768px) {
        .seat {
          height: 60px;
          font-size: 12px;
        }

        .header input {
          width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>æ™ºèƒ½åº§ä½è¡¨ç”Ÿæˆå™¨</h1>

      <div class="header">
        <input type="text" id="className" placeholder="è«‹è¼¸å…¥ç­ç´šåç¨±" />
        <div>
          <label for="rows">æ’æ•¸ï¼š</label>
          <input type="number" id="rows" min="1" value="8" />
          <label for="columns">è¡Œæ•¸ï¼š</label>
          <input type="number" id="columns" min="1" value="10" />
        </div>
      </div>

      <div class="podium">è¬›å°</div>

      <div
        class="seating-chart-container"
        tabindex="0"
        id="seatingChartContainer"
      >
        <div class="seating-chart" id="seatingChart"></div>
      </div>

      <div class="button-group">
        <button class="button" onclick="randomlyArrangeSeats()">
          éš¨æ©Ÿæ’åº§
        </button>
        <button class="button" onclick="exportToExcel()">åŒ¯å‡º Excel</button>
        <button class="button" onclick="exportToWord()">åŒ¯å‡º Word</button>
        <button class="button" onclick="saveStudentList()">å„²å­˜å­¸ç”Ÿåå–®</button>
        <button class="button" onclick="openLoadModal()">è¼‰å…¥å­¸ç”Ÿåå–®</button>
      </div>

      <div id="message"></div>
    </div>

    <!-- Load Modal -->
    <div id="loadModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeLoadModal()">&times;</span>
        <h2>è¼‰å…¥å­¸ç”Ÿåå–®</h2>
        <ul class="saved-list" id="savedList"></ul>
      </div>
    </div>

    <!-- èªªæ˜æ–‡å­— -->
    <div class="description">å³éµé»æ“Šåº§ä½ä»¥ç¦ç”¨æˆ–å•Ÿç”¨è©²åº§ä½ã€‚</div>

    <script>
      let students = [];
      let disabledSeats = new Set();
      let rows = 8; // å°‡é è¨­æ’æ•¸æ”¹ç‚º8
      let columns = 10; // é è¨­è¡Œæ•¸ä¿æŒ10

      // å°‡æ•¸å­—è½‰ç‚ºåœ‹å­—
      function numberToChinese(number) {
        const mapping = [
          "ä¸€",
          "äºŒ",
          "ä¸‰",
          "å››",
          "äº”",
          "å…­",
          "ä¸ƒ",
          "å…«",
          "ä¹",
          "å",
          "åä¸€",
          "åäºŒ",
          "åä¸‰",
          "åå››",
          "åäº”",
          "åå…­",
          "åä¸ƒ",
          "åå…«",
          "åä¹",
          "äºŒå",
        ];
        return mapping[number - 1] || number;
      }

      // é¡¯ç¤ºè¨Šæ¯
      function showMessage(text, type) {
        const messageElement = document.getElementById("message");
        messageElement.textContent = text;
        messageElement.className = type;
        messageElement.style.display = "block";
        setTimeout(() => {
          messageElement.style.display = "none";
        }, 3000);
      }

      // ç”Ÿæˆåº§ä½è¡¨
      function generateSeatingChart() {
        const rowsInput = document.getElementById("rows");
        const columnsInput = document.getElementById("columns");

        rows = parseInt(rowsInput.value) || 8; // ä½¿ç”¨8ä½œç‚ºé è¨­å€¼
        columns = parseInt(columnsInput.value) || 10;

        const seatingChart = document.getElementById("seatingChart");
        seatingChart.innerHTML = "";
        seatingChart.style.gridTemplateColumns = `60px repeat(${columns}, 1fr)`; // èª¿æ•´ç¬¬ä¸€åˆ—ç‚ºæ¨™ç±¤åˆ—

        // æ·»åŠ ä¸Šæ–¹åˆ—æ¨™ç±¤ï¼ˆç¬¬å¹¾åˆ—ï¼‰
        const labelRow = document.createElement("div");
        labelRow.classList.add("label-row");

        // å·¦ä¸Šè§’ç©ºç™½
        const emptyLabel = document.createElement("div");
        emptyLabel.classList.add("label-cell");
        labelRow.appendChild(emptyLabel);

        for (let c = 1; c <= columns; c++) {
          const colLabel = document.createElement("div");
          colLabel.classList.add("label-cell");
          colLabel.textContent = numberToChinese(c);
          labelRow.appendChild(colLabel);
        }
        seatingChart.appendChild(labelRow);

        // æ·»åŠ åº§ä½å’Œè¡Œæ¨™ç±¤ï¼ˆç¬¬å¹¾æ’ï¼‰
        for (let r = 1; r <= rows; r++) {
          // è¡Œå®¹å™¨
          const rowDiv = document.createElement("div");
          rowDiv.classList.add("label-row");

          // è¡Œæ¨™ç±¤
          const rowLabel = document.createElement("div");
          rowLabel.classList.add("label-cell");
          rowLabel.textContent = numberToChinese(r);
          // å³éµç¦ç”¨æ•´æ’
          rowLabel.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            toggleRowDisabled(r);
          });
          rowDiv.appendChild(rowLabel);

          // åº§ä½
          for (let c = 1; c <= columns; c++) {
            const seat = document.createElement("div");
            seat.classList.add("seat");
            seat.dataset.row = r;
            seat.dataset.column = c;
            seat.dataset.index = (r - 1) * columns + c;

            // åˆå§‹é¡¯ç¤º
            seat.innerHTML = `
              <div class="seat-id" contenteditable="true" data-placeholder="åº§è™Ÿ"></div>
              <div class="seat-name" contenteditable="true" data-placeholder="å§“å"></div>
            `;
            rowDiv.appendChild(seat);

            // æ·»åŠ æ‹–æ›³äº‹ä»¶
            seat.setAttribute("draggable", "true");
            seat.addEventListener("dragstart", handleDragStart);
            seat.addEventListener("dragover", handleDragOver);
            seat.addEventListener("drop", handleDrop);
            seat.addEventListener("dragend", handleDragEnd);

            // æ·»åŠ å³éµç¦ç”¨åº§ä½äº‹ä»¶
            seat.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              toggleSeatDisabled(e);
            });
          }

          seatingChart.appendChild(rowDiv);
        }

        // æ›´æ–°åº§ä½ç‹€æ…‹
        updateSeatingChartState();
      }

      // ç¦ç”¨æˆ–å•Ÿç”¨æ•´æ’åº§ä½
      function toggleRowDisabled(rowNumber) {
        let action = "";
        for (let c = 1; c <= columns; c++) {
          const index = (rowNumber - 1) * columns + c;
          const seat = document.querySelector(`.seat[data-index='${index}']`);
          if (disabledSeats.has(index)) {
            disabledSeats.delete(index);
            seat.classList.remove("disabled");
            action = "å•Ÿç”¨";
          } else {
            // ç¦ç”¨åº§ä½å‰æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿ
            const seatId = seat.querySelector(".seat-id").textContent.trim();
            const seatName = seat
              .querySelector(".seat-name")
              .textContent.trim();
            if (seatId !== "" && seatName !== "") {
              const student = students.find(
                (s) => s.position === index.toString()
              );
              if (student) {
                const newSeat = findNextAvailableSeat();
                if (newSeat) {
                  // ç§»å‹•å­¸ç”Ÿåˆ°æ–°åº§ä½
                  newSeat.querySelector(".seat-id").textContent = student.id;
                  newSeat.querySelector(".seat-name").textContent =
                    student.name;
                  student.position = newSeat.dataset.index;
                } else {
                  showMessage(
                    `æ²’æœ‰è¶³å¤ çš„å¯ç”¨åº§ä½ä¾†ç§»å‹•å­¸ç”Ÿ "${student.name}"`,
                    "error"
                  );
                }
              }
            }
            disabledSeats.add(index);
            seat.classList.add("disabled");
            seat.querySelector(".seat-id").textContent = "";
            seat.querySelector(".seat-name").textContent = "";
            action = "ç¦ç”¨";
          }
        }
        showMessage(`ç¬¬${numberToChinese(rowNumber)}æ’å·²${action}`, "success");
      }

      // ç¦ç”¨æˆ–å•Ÿç”¨å–®ä¸€åº§ä½
      function toggleSeatDisabled(event) {
        const seat = event.currentTarget;
        const index = seat.dataset.index;

        if (disabledSeats.has(index)) {
          // å•Ÿç”¨åº§ä½
          disabledSeats.delete(index);
          seat.classList.remove("disabled");
          seat.querySelector(".seat-id").contentEditable = "true"; // æ¢å¾©å¯ç·¨è¼¯
          seat.querySelector(".seat-name").contentEditable = "true"; // æ¢å¾©å¯ç·¨è¼¯
          seat.querySelector(".seat-id").textContent = ""; // æ¸…ç©ºé¡¯ç¤ºçš„æ–œç·š
          seat.querySelector(".seat-name").textContent = "";
          showMessage("åº§ä½å·²å•Ÿç”¨", "success");
        } else {
          // ç¦ç”¨åº§ä½
          const seatId = seat.querySelector(".seat-id").textContent.trim();
          const seatName = seat.querySelector(".seat-name").textContent.trim();

          // å¦‚æœæœ‰å­¸ç”Ÿåœ¨è©²åº§ä½ä¸Šï¼Œå°‡å…¶ç§»å‹•åˆ°ä¸‹ä¸€å€‹å¯ç”¨åº§ä½
          if (seatId !== "" && seatName !== "") {
            const student = { id: seatId, name: seatName, position: index };
            const newSeat = findNextAvailableSeat();

            if (newSeat) {
              // ç§»å‹•å­¸ç”Ÿåˆ°æ–°çš„åº§ä½
              newSeat.querySelector(".seat-id").textContent = student.id;
              newSeat.querySelector(".seat-name").textContent = student.name;
              student.position = newSeat.dataset.index; // æ›´æ–°å­¸ç”Ÿä½ç½®
            } else {
              showMessage(
                `æ²’æœ‰è¶³å¤ çš„å¯ç”¨åº§ä½ä¾†ç§»å‹•å­¸ç”Ÿ "${student.name}"`,
                "error"
              );
              return;
            }
          }

          // å°‡åº§ä½è¨­ç‚ºç¦ç”¨ç‹€æ…‹ä¸¦é¡¯ç¤ºæ–œç·š
          disabledSeats.add(index);
          seat.classList.add("disabled");
          seat.querySelector(".seat-id").contentEditable = "false"; // ç¦æ­¢ç·¨è¼¯
          seat.querySelector(".seat-name").contentEditable = "false"; // ç¦æ­¢ç·¨è¼¯
          seat.querySelector(".seat-id").textContent = "ï¼"; // é¡¯ç¤ºæ–œç·š
          seat.querySelector(".seat-name").textContent = "";
          showMessage("åº§ä½å·²ç¦ç”¨", "success");
        }
      }

      // æŸ¥æ‰¾ä¸‹ä¸€å€‹å¯ç”¨åº§ä½
      function findNextAvailableSeat() {
        const seatingChart = document.getElementById("seatingChart");
        const availableSeats = Array.from(
          seatingChart.querySelectorAll(".seat")
        ).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) && // ä¸æ˜¯ç¦ç”¨ç‹€æ…‹
            seat.querySelector(".seat-name").textContent.trim() === "" // åº§ä½ç©ºç™½
        );

        return availableSeats.length > 0 ? availableSeats[0] : null;
      }

      // æ‹–æ›³äº¤æ›åº§ä½
      let draggedSeat = null;

      function handleDragStart(e) {
        if (this.classList.contains("disabled")) {
          e.preventDefault();
          return;
        }
        draggedSeat = this;
        e.dataTransfer.setData("text/plain", this.dataset.index);
        setTimeout(() => {
          this.classList.add("dragging");
        }, 0);
      }

      function handleDragOver(e) {
        e.preventDefault();
        if (this.classList.contains("disabled") || this === draggedSeat) return;
        this.classList.add("highlight");
      }

      function handleDrop(e) {
        e.preventDefault();
        this.classList.remove("highlight");
        const fromIndex = e.dataTransfer.getData("text/plain");
        const toIndex = this.dataset.index;

        if (fromIndex === toIndex) return;

        const fromSeat = document.querySelector(
          `.seat[data-index='${fromIndex}']`
        );
        const toSeat = document.querySelector(`.seat[data-index='${toIndex}']`);

        // äº¤æ›åº§ä½å…§å®¹
        const tempId = fromSeat.querySelector(".seat-id").textContent;
        const tempName = fromSeat.querySelector(".seat-name").textContent;

        fromSeat.querySelector(".seat-id").textContent =
          toSeat.querySelector(".seat-id").textContent;
        fromSeat.querySelector(".seat-name").textContent =
          toSeat.querySelector(".seat-name").textContent;

        toSeat.querySelector(".seat-id").textContent = tempId;
        toSeat.querySelector(".seat-name").textContent = tempName;

        // æ›´æ–°å­¸ç”Ÿä½ç½®
        updateStudentPosition(fromIndex, toIndex);

        // æ·»åŠ äº¤æ›å‹•ç•«
        fromSeat.classList.add("swapping");
        toSeat.classList.add("swapping");
        setTimeout(() => {
          fromSeat.classList.remove("swapping");
          toSeat.classList.remove("swapping");
        }, 500);

        showMessage("åº§ä½å·²äº¤æ›", "success");
      }

      function handleDragEnd(e) {
        this.classList.remove("dragging");
        document
          .querySelectorAll(".seat")
          .forEach((seat) => seat.classList.remove("highlight"));
      }

      // æ›´æ–°å­¸ç”Ÿåº§ä½ä½ç½®
      function updateStudentPosition(fromIndex, toIndex) {
        const fromStudent = students.find(
          (student) => student.position === fromIndex
        );
        const toStudent = students.find(
          (student) => student.position === toIndex
        );

        if (fromStudent) {
          fromStudent.position = toIndex;
        }

        if (toStudent) {
          toStudent.position = fromIndex;
        }
      }

      // éš¨æ©Ÿæ’åº§
      function randomlyArrangeSeats() {
        const seatingChart = document.getElementById("seatingChart");
        const availableSeats = Array.from(
          seatingChart.querySelectorAll(".seat")
        ).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) &&
            seat.querySelector(".seat-name").textContent.trim() !== ""
        );

        const shuffledStudents = shuffleArray([...students]);

        if (shuffledStudents.length > availableSeats.length) {
          showMessage(
            "å¯ç”¨åº§ä½ä¸è¶³ä»¥å®¹ç´æ‰€æœ‰å­¸ç”Ÿï¼Œè«‹å…ˆç¦ç”¨éƒ¨åˆ†åº§ä½æˆ–åˆªé™¤å¤šé¤˜çš„å­¸ç”Ÿã€‚",
            "error"
          );
          return;
        }

        // æ¸…é™¤æ‰€æœ‰å¯ç”¨åº§ä½çš„å­¸ç”Ÿè³‡è¨Š
        availableSeats.forEach((seat) => {
          seat.querySelector(".seat-id").textContent = "";
          seat.querySelector(".seat-name").textContent = "";
        });

        // åˆ†é…åº§ä½
        shuffledStudents.forEach((student, index) => {
          if (index < availableSeats.length) {
            const seat = availableSeats[index];
            seat.querySelector(".seat-id").textContent = student.id;
            seat.querySelector(".seat-name").textContent = student.name;
            student.position = seat.dataset.index;
          }
        });

        showMessage("åº§ä½å·²éš¨æ©Ÿæ’åˆ—", "success");
      }

      // æ´—ç‰Œç®—æ³•ï¼ˆFisher-Yates Shuffleï¼‰
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      // åŒ¯å‡ºç‚º Excel
      function exportToExcel() {
        const className = document.getElementById("className").value || "ç­ç´š";
        const timestamp = getFormattedTimestamp();
        const seatingChart = document.getElementById("seatingChart");
        const seats = seatingChart.querySelectorAll(".seat");

        const data = [];

        // æ·»åŠ æ¨™é¡Œè¡Œï¼Œåªé¡¯ç¤ºåˆ—çš„æ¨™ç±¤ï¼Œä¸æ·»åŠ å¤šé¤˜ç©ºç™½
        const headerRow = ["è¡Œ\\åˆ—"];
        for (let c = 1; c <= columns; c++) {
          headerRow.push(numberToChinese(c)); // åˆ—æ¨™ç±¤åªæ·»åŠ ä¸€æ¬¡ï¼Œä¸ç•™ç©ºæ ¼
        }
        data.push(headerRow);

        // æ·»åŠ æ¯ä¸€æ’åº§ä½çš„åº§è™Ÿå’Œå§“åï¼Œè¡Œæ¨™ç±¤åˆä½µå„²å­˜æ ¼
        for (let r = 1; r <= rows; r++) {
          const seatRow = [numberToChinese(r)]; // ç¬¬å¹¾è¡Œæ¨™ç±¤
          const seatNameRow = [""]; // ç©ºç™½å„²å­˜æ ¼ï¼Œå› ç‚ºè¡Œæ¨™ç±¤åˆä½µå„²å­˜æ ¼

          for (let c = 1; c <= columns; c++) {
            const index = (r - 1) * columns + c;
            const seat = seatingChart.querySelector(
              `.seat[data-index='${index}']`
            );
            if (seat) {
              if (disabledSeats.has(index.toString())) {
                seatRow.push(""); // ç¦ç”¨åº§ä½æ™‚ä¸é¡¯ç¤ºä»»ä½•å…§å®¹
                seatNameRow.push(""); // ç¦ç”¨åº§ä½æ™‚å§“åéƒ¨åˆ†ä¹Ÿç©ºç™½
              } else {
                const id = seat.querySelector(".seat-id").textContent.trim();
                const name = seat
                  .querySelector(".seat-name")
                  .textContent.trim();
                seatRow.push(id); // é¡¯ç¤ºåº§è™Ÿ
                seatNameRow.push(name); // é¡¯ç¤ºå§“å
              }
            } else {
              seatRow.push(""); // åº§è™Ÿéƒ¨åˆ†
              seatNameRow.push(""); // å§“åéƒ¨åˆ†
            }
          }

          // å°‡åº§è™Ÿå’Œå§“åè¡ŒåŠ å…¥data
          data.push(seatRow);
          data.push(seatNameRow);
        }

        const worksheet = XLSX.utils.aoa_to_sheet(data);

        // åˆä½µå„²å­˜æ ¼ï¼šè¡Œæ¨™ç±¤ (è¡Œçš„åº§è™Ÿå’Œå§“å)
        for (let i = 0; i < rows; i++) {
          const mergeRange = {
            s: { r: 2 * i + 1, c: 0 },
            e: { r: 2 * i + 2, c: 0 },
          };
          if (!worksheet["!merges"]) worksheet["!merges"] = [];
          worksheet["!merges"].push(mergeRange);
        }

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, `${className}åº§ä½è¡¨`);
        XLSX.writeFile(workbook, `${className}åº§ä½è¡¨_${timestamp}.xlsx`);
        showMessage("Excel æª”æ¡ˆå·²åŒ¯å‡º", "success");
      }

      // åŒ¯å‡ºç‚º Word
      function exportToWord() {
        const className = document.getElementById("className").value || "ç­ç´š";
        const timestamp = getFormattedTimestamp();
        const seatingChart = document.getElementById("seatingChart");
        const seats = seatingChart.querySelectorAll(".seat");

        let docContent = `<h1>${className}åº§ä½è¡¨</h1>`;
        docContent +=
          '<table border="1" style="border-collapse:collapse;width:100%;">';

        // æ·»åŠ æ¨™é¡Œè¡Œ
        docContent += "<tr><th>è¡Œ\\åˆ—</th>";
        for (let c = 1; c <= columns; c++) {
          docContent += `<th>${numberToChinese(c)}</th>`;
        }
        docContent += "</tr>";

        // æ·»åŠ æ¯ä¸€æ’
        for (let r = 1; r <= rows; r++) {
          docContent += `<tr><td>${numberToChinese(r)}</td>`;
          for (let c = 1; c <= columns; c++) {
            const index = (r - 1) * columns + c;
            const seat = seatingChart.querySelector(
              `.seat[data-index='${index}']`
            );
            if (seat) {
              if (disabledSeats.has(index.toString())) {
                docContent += `<td></td>`;
              } else {
                const id = seat.querySelector(".seat-id").textContent.trim();
                const name = seat
                  .querySelector(".seat-name")
                  .textContent.trim();
                docContent += `<td>${id}<br>${name}</td>`;
              }
            } else {
              docContent += "<td></td>";
            }
          }
          docContent += "</tr>";
        }

        docContent += "</table>";

        const blob = new Blob(["\ufeff", docContent], {
          type: "application/msword",
        });
        saveAs(blob, `${className}åº§ä½è¡¨_${timestamp}.doc`);
        showMessage("Word æª”æ¡ˆå·²åŒ¯å‡º", "success");
      }

      // å„²å­˜å­¸ç”Ÿåå–®åˆ° LocalStorage
      function saveStudentList() {
        const className = document.getElementById("className").value || "ç­ç´š";
        const timestamp = getFormattedTimestamp();
        const listName = prompt(
          "è«‹è¼¸å…¥å­¸ç”Ÿåå–®åç¨±ï¼š",
          `${className}_${timestamp}`
        );
        if (!listName) {
          showMessage("æœªè¼¸å…¥åå–®åç¨±ï¼Œå–æ¶ˆä¿å­˜ã€‚", "error");
          return;
        }

        const data = {
          className: className,
          timestamp: timestamp,
          rows: rows,
          columns: columns,
          students: students,
          disabledSeats: Array.from(disabledSeats),
        };

        // ç²å–å·²ä¿å­˜çš„åå–®
        let savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];

        // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒåç¨±çš„åå–®
        if (savedLists.find((list) => list.listName === listName)) {
          if (!confirm("å·²å­˜åœ¨ç›¸åŒåç¨±çš„åå–®ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ")) {
            showMessage("å–æ¶ˆä¿å­˜ã€‚", "error");
            return;
          }
          // è¦†è“‹å·²æœ‰åå–®
          savedLists = savedLists.filter((list) => list.listName !== listName);
        }

        // æ·»åŠ æ–°çš„åå–®
        savedLists.push({ listName: listName, data: data });

        // å„²å­˜å› LocalStorage
        localStorage.setItem("seatChartSavedLists", JSON.stringify(savedLists));
        showMessage("å­¸ç”Ÿåå–®å·²ä¿å­˜", "success");
      }

      // æ‰“é–‹è¼‰å…¥æ¨¡æ…‹çª—å£
      function openLoadModal() {
        const modal = document.getElementById("loadModal");
        const savedListContainer = document.getElementById("savedList");
        savedListContainer.innerHTML = "";

        const savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];

        if (savedLists.length === 0) {
          savedListContainer.innerHTML = "<li>æ²’æœ‰å·²ä¿å­˜çš„å­¸ç”Ÿåå–®ã€‚</li>";
        } else {
          savedLists.forEach((list, index) => {
            const li = document.createElement("li");
            li.textContent = list.listName;
            li.onclick = () => {
              loadStudentListByName(list.listName);
              closeLoadModal();
            };
            savedListContainer.appendChild(li);
          });
        }

        modal.style.display = "block";
      }

      // é—œé–‰è¼‰å…¥æ¨¡æ…‹çª—å£
      function closeLoadModal() {
        const modal = document.getElementById("loadModal");
        modal.style.display = "none";
      }

      // é»æ“Šæ¨¡æ…‹çª—å£å¤–éƒ¨é—œé–‰
      window.onclick = function (event) {
        const modal = document.getElementById("loadModal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      // è¼‰å…¥ç‰¹å®šåç¨±çš„å­¸ç”Ÿåå–®
      function loadStudentListByName(listName) {
        const savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];
        const list = savedLists.find((item) => item.listName === listName);
        if (!list) {
          showMessage("æ‰¾ä¸åˆ°é¸å®šçš„å­¸ç”Ÿåå–®ã€‚", "error");
          return;
        }

        const data = list.data;
        document.getElementById("className").value = data.className || "";
        document.getElementById("rows").value = data.rows || 8;
        document.getElementById("columns").value = data.columns || 10;
        rows = data.rows || 8;
        columns = data.columns || 10;
        students = data.students || [];
        disabledSeats = new Set(data.disabledSeats || []);

        generateSeatingChart();

        // æ›´æ–°åº§ä½ç‹€æ…‹
        updateSeatingChartState();

        // åˆ†é…å­¸ç”Ÿ
        students.forEach((student) => {
          const seat = document.querySelector(
            `.seat[data-index='${student.position}']`
          );
          if (seat && !disabledSeats.has(student.position)) {
            seat.querySelector(".seat-id").textContent = student.id;
            seat.querySelector(".seat-name").textContent = student.name;
          }
        });

        showMessage(`å·²è¼‰å…¥å­¸ç”Ÿåå–®ï¼šã€Œ${listName}ã€`, "success");
      }

      // æ›´æ–°åº§ä½è¡¨çš„ç¦ç”¨ç‹€æ…‹
      function updateSeatingChartState() {
        document.querySelectorAll(".seat").forEach((seat) => {
          const index = seat.dataset.index;
          if (disabledSeats.has(index)) {
            seat.classList.add("disabled");
            seat.querySelector(".seat-id").textContent = "";
            seat.querySelector(".seat-name").textContent = "";
          } else {
            seat.classList.remove("disabled");
          }
        });
      }

      // æª¢æ¸¬æ˜¯å¦ç‚ºå§“åï¼ˆå…¨ä¸­æ–‡ï¼‰
      function isChineseName(str) {
        const chineseRegex = /^[\u4e00-\u9fa5]+$/;
        return chineseRegex.test(str);
      }

      // æª¢æ¸¬æ˜¯å¦ç‚ºåº§è™Ÿæˆ–å­¸è™Ÿï¼ˆåŒ…å«æ•¸å­—æˆ–è‹±æ–‡å­—ç¬¦ï¼‰
      function isStudentId(str) {
        const idRegex = /^[A-Za-z0-9]+$/; // åƒ…æ•¸å­—æˆ–è‹±æ•¸æ··åˆ
        return idRegex.test(str) || /[A-Za-z0-9]/.test(str);
      }

      // è™•ç†è²¼ä¸Šäº‹ä»¶
      function handlePaste(e) {
        e.preventDefault();
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData("Text");

        const lines = pastedData.trim().split("\n");
        const newStudents = [];
        const duplicateCheck = new Set();
        let duplicates = false;

        lines.forEach((line, lineNumber) => {
          const fields = line.trim().split("\t");

          let id = "";
          let name = "";

          // æ ¹æ“šå…§å®¹é€²è¡Œåˆ¤æ–·ï¼šæœ‰è‹±æ–‡æˆ–æ•¸å­—çš„ç‚ºåº§è™Ÿï¼Œç´”ä¸­æ–‡çš„ç‚ºå§“å
          fields.forEach((field) => {
            if (isChineseName(field)) {
              name = field.trim(); // åˆ¤å®šç‚ºå§“å
            } else if (isStudentId(field)) {
              id = field.trim(); // åˆ¤å®šç‚ºåº§è™Ÿ
            }
          });

          // é©—è­‰æ˜¯å¦é‡è¤‡
          if (id && name) {
            if (
              students.some((s) => s.id === id || s.name === name) ||
              duplicateCheck.has(id) ||
              duplicateCheck.has(name)
            ) {
              duplicates = true;
              showMessage(
                `ç¬¬ ${lineNumber + 1} è¡Œæœ‰é‡è¤‡çš„åº§è™Ÿæˆ–å§“åï¼Œå·²è·³éã€‚`,
                "error"
              );
              return;
            }

            duplicateCheck.add(id);
            duplicateCheck.add(name);

            newStudents.push({ name: name, id: id });
          }
        });

        // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„å¯ç”¨åº§ä½
        const availableSeats = Array.from(
          document.querySelectorAll(".seat")
        ).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) &&
            seat.querySelector(".seat-name").textContent.trim() === ""
        ).length;

        if (newStudents.length > availableSeats) {
          showMessage(
            `å¯ç”¨åº§ä½ä¸è¶³ï¼Œæœ€å¤šå¯è²¼ä¸Š ${availableSeats} ä½å­¸ç”Ÿã€‚`,
            "error"
          );
          return;
        }

        // åˆ†é…å­¸ç”Ÿåˆ°åº§ä½
        distributeStudents(newStudents);
        showMessage("å­¸ç”Ÿè³‡æ–™å·²è²¼ä¸Š", "success");
      }

      // åˆ†é…å­¸ç”Ÿåˆ°åº§ä½
      function distributeStudents(newStudents) {
        const seatingChart = document.getElementById("seatingChart");
        const seats = Array.from(seatingChart.querySelectorAll(".seat")).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) &&
            seat.querySelector(".seat-name").textContent.trim() === ""
        );

        newStudents.forEach((student, index) => {
          if (index < seats.length) {
            const seat = seats[index];
            seat.querySelector(".seat-id").textContent = student.id;
            seat.querySelector(".seat-name").textContent = student.name;
            seat.dataset.studentId = student.id || "";
            students.push({
              name: student.name,
              id: student.id,
              position: seat.dataset.index,
            });
          }
        });
      }

      // äº‹ä»¶ç¶å®š
      document
        .getElementById("seatingChartContainer")
        .addEventListener("paste", handlePaste);

      // ç•¶æ’æ•¸æˆ–è¡Œæ•¸æ”¹è®Šæ™‚è‡ªå‹•ç”Ÿæˆåº§ä½è¡¨
      document
        .getElementById("rows")
        .addEventListener("change", generateSeatingChart);
      document
        .getElementById("columns")
        .addEventListener("change", generateSeatingChart);
      document.getElementById("className").addEventListener("input", () => {
        // ä¸å†è‡ªå‹•ä¿å­˜
      });

      // å…è¨±ç›´æ¥ç·¨è¼¯åº§è™Ÿå’Œå§“å
      document.addEventListener("input", function (e) {
        if (
          e.target.classList.contains("seat-id") ||
          e.target.classList.contains("seat-name")
        ) {
          const seat = e.target.parentElement;
          const id = seat.querySelector(".seat-id").textContent.trim();
          const name = seat.querySelector(".seat-name").textContent.trim();
          const index = seat.dataset.index;

          // æ›´æ–°å­¸ç”Ÿè³‡æ–™
          const student = students.find((s) => s.position === index);
          if (student) {
            // æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ”¹å°è‡´é‡è¤‡
            const duplicate = students.some(
              (s) => (s.id === id || s.name === name) && s.position !== index
            );
            if (duplicate) {
              showMessage(`åº§è™Ÿæˆ–å§“åé‡è¤‡ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚`, "error");
              // æ¢å¾©åŸä¾†çš„å€¼
              seat.querySelector(".seat-id").textContent = student.id;
              seat.querySelector(".seat-name").textContent = student.name;
              return;
            }

            student.id = id;
            student.name = name;
          } else {
            if (name !== "" && id !== "") {
              // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡
              const duplicate = students.some(
                (s) => s.id === id || s.name === name
              );
              if (duplicate) {
                showMessage(`åº§è™Ÿæˆ–å§“åé‡è¤‡ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚`, "error");
                // æ¸…é™¤è¼¸å…¥
                seat.querySelector(".seat-id").textContent = "";
                seat.querySelector(".seat-name").textContent = "";
                return;
              }

              students.push({ id: id, name: name, position: index });
            }
          }
          // ä¸å†è‡ªå‹•ä¿å­˜
        }
      });

      // åˆå§‹åŒ–åº§ä½è¡¨
      window.onload = function () {
        generateSeatingChart();
        document.getElementById("seatingChartContainer").focus();
      };

      // æ ¼å¼åŒ–æ™‚é–“æˆ³ï¼Œé¿å…æ–‡ä»¶åä¸­å‡ºç¾ä¸å…è¨±çš„å­—ç¬¦
      function getFormattedTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const seconds = String(now.getSeconds()).padStart(2, "0");
        return `${year}${month}${day}_${hours}${minutes}${seconds}`;
      }
    </script>
  </body>
</html>
