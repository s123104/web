<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>智能座位表生成器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
      :root {
        --primary-color: #4a90e2;
        --secondary-color: #f39c12;
        --background-color: #f5f7fa;
        --text-color: #333;
        --border-color: #e0e0e0;
        --disabled-color: #ccc;
        --seat-height: 80px;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      .container {
        max-width: 60%;
        margin: 0 auto;
        padding: 20px;
        background-color: #ffffff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
      }

      fieldset {
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        background: #fefefe;
      }

      legend {
        padding: 0 5px;
        font-weight: bold;
        color: var(--primary-color);
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        margin-right: 10px;
        position: relative;
      }

      .form-group label {
        margin-bottom: 5px;
        font-size: 14px;
        color: #555;
      }

      .form-group input,
      .form-group select,
      .form-group datalist {
        padding: 8px;
        font-size: 14px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      .row-col-layout {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .row-col-layout .line {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
      }

      .arrow-btn {
        width: 30px;
        height: 30px;
        background: #eee;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      .arrow-btn:hover {
        background: #ddd;
      }

      .direction-btn {
        padding: 5px 10px;
        background: #eee;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .direction-btn:hover {
        background: #ddd;
      }

      .podium {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background-color: var(--secondary-color);
        color: white;
        font-weight: bold;
        border-radius: 4px;
      }

      .seating-chart-container {
        overflow-x: auto;
        outline: none;
      }

      .seating-chart {
        display: grid;
        gap: 2px;
        justify-content: center;
        margin-bottom: 20px;
        outline: none;
      }

      .seating-chart .label-row {
        display: contents;
      }

      .seating-chart .label-cell {
        background-color: #f0f0f0;
        text-align: center;
        font-weight: bold;
        padding: 10px;
        border: 1px solid var(--border-color);
        min-width: 60px;
      }

      .seating-chart .seat {
        width: 100%;
        height: var(--seat-height);
        padding: 5px;
        text-align: center;
        background-color: #fff;
        border: 1px solid var(--border-color);
        cursor: grab;
        user-select: none;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 14px;
        box-sizing: border-box;
        position: relative;
      }

      .seating-chart .seat:active {
        cursor: grabbing;
      }

      .seat:hover {
        background-color: #e0f7fa;
      }

      .seat.disabled {
        background-color: var(--disabled-color) !important;
        cursor: not-allowed !important;
      }

      .seat.disabled .disabled-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(78, 78, 78, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
        z-index: 10;
        pointer-events: none;
      }

      /* 姓名和座號的分隔線一直顯示：第一行有底線 */
      .seat > div:nth-child(1) {
        border-bottom: 1px dashed var(--primary-color);
        padding-bottom: 2px;
      }

      .seat .seat-id,
      .seat .seat-name {
        flex: 1;
        padding: 2px 0;
        border: none;
        background: transparent;
        text-align: center;
        outline: none;
        position: relative;
        cursor: text;
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .button {
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-size: 16px;
        border-radius: 4px;
      }

      .button:hover {
        background-color: #3476c5;
      }

      #message {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        border-radius: 5px;
        display: none;
      }

      #message.success {
        background-color: #d4edda;
        color: #155724;
      }

      #message.error {
        background-color: #f8d7da;
        color: #721c24;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
      }

      .saved-list {
        list-style-type: none;
        padding: 0;
      }

      .saved-list li {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
      }

      .saved-list li:hover {
        background-color: #f0f0f0;
      }

      .description {
        text-align: center;
        margin-top: 30px;
        font-size: 14px;
        color: #555;
      }

      @media (max-width: 1680px) {
        .container {
          max-width: 100%;
        }
      }

      @media (max-width: 768px) {
        .container {
          max-width: 100%;
        }
        .seat {
          height: 60px;
          font-size: 12px;
        }
        .form-group input,
        .form-group select {
          width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>智能座位表生成器</h1>

      <fieldset>
        <legend>基本設定</legend>
        <div class="form-row">
          <div class="form-group">
            <label for="className">班級名稱</label>
            <input
              type="text"
              id="className"
              list="classOptions"
              placeholder="請輸入班級名稱"
            />
            <datalist id="classOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="examSubject">考試科目</label>
            <input
              type="text"
              id="examSubject"
              list="subjectOptions"
              placeholder="考試科目(可不填)"
            />
            <datalist id="subjectOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="examType">考試類型</label>
            <select id="examType">
              <option value="">不填</option>
              <option value="小考一">小考一</option>
              <option value="小考二">小考二</option>
              <option value="期中考">期中考</option>
              <option value="期末考">期末考</option>
            </select>
          </div>
          <div class="form-group">
            <label for="examTime">考試時間</label>
            <input type="datetime-local" id="examTime" />
          </div>
        </div>

        <div class="form-row">
          <div class="row-col-layout">
            <div class="line">
              排數：
              <button class="arrow-btn" id="rowDownBtn">◀</button>
              <input
                type="number"
                id="rows"
                min="1"
                value="8"
                style="width: 50px; text-align: center"
              />
              <button class="arrow-btn" id="rowUpBtn">▶</button>
              <button
                class="direction-btn"
                id="toggleVerticalBtn"
                title="上下對調"
              >
                ↕ 上下對調
              </button>
            </div>
            <div class="line">
              行數：
              <button class="arrow-btn" id="colDownBtn">◀</button>
              <input
                type="number"
                id="columns"
                min="1"
                value="10"
                style="width: 50px; text-align: center"
              />
              <button class="arrow-btn" id="colUpBtn">▶</button>
              <button
                class="direction-btn"
                id="toggleHorizontalBtn"
                title="左右對調"
              >
                ↔ 左右對調
              </button>
            </div>
            <div class="line">
              <button
                class="direction-btn"
                id="toggleNameOrderBtn"
                title="切換姓名與座號上下順序"
              >
                切換姓名/座號順序
              </button>
            </div>
          </div>
        </div>
      </fieldset>

      <div class="podium">講台</div>

      <div
        class="seating-chart-container"
        tabindex="0"
        id="seatingChartContainer"
      >
        <div class="seating-chart" id="seatingChart"></div>
      </div>

      <div class="button-group">
        <button class="button" onclick="randomlyArrangeSeats()">
          隨機排座
        </button>
        <button class="button" onclick="exportToExcel()">匯出 Excel</button>
        <button class="button" onclick="exportToWord()">匯出 Word</button>
        <button class="button" onclick="saveStudentList()">儲存名單</button>
        <button class="button" onclick="openLoadModal()">載入名單</button>
      </div>

      <div id="message"></div>
    </div>

    <!-- Load Modal -->
    <div id="loadModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeLoadModal()">&times;</span>
        <h2>載入學生名單</h2>
        <ul class="saved-list" id="savedList"></ul>
      </div>
    </div>

    <div class="description">
      提示： - 右鍵點擊座位以禁用或啟用該座位 - 點擊「座號」或「姓名」可編輯文字
      - (批量貼上時)長按並拖曳座位可交換位置
    </div>

    <script>
      let students = [];
      let disabledSeats = new Set();
      let rows = 8;
      let columns = 10;
      let horizontalReverse = true;
      let verticalReverse = false;
      let batchMode = false;
      let oldRows = rows;
      let oldColumns = columns;
      let nameFirst = false; // false=座號在上 姓名在下，true=姓名在上 座號在下

      let storedClasses = JSON.parse(
        localStorage.getItem("storedClasses") || "[]"
      );
      let storedSubjects = JSON.parse(
        localStorage.getItem("storedSubjects") || "[]"
      );

      updateDatalist("classOptions", storedClasses);
      updateDatalist("subjectOptions", storedSubjects);

      function updateDatalist(id, arr) {
        const dl = document.getElementById(id);
        dl.innerHTML = "";
        arr.forEach((item) => {
          let opt = document.createElement("option");
          opt.value = item;
          dl.appendChild(opt);
        });
      }

      function storeValue(inputId, arrName) {
        const val = document.getElementById(inputId).value.trim();
        if (val && !window[arrName].includes(val)) {
          window[arrName].push(val);
          localStorage.setItem(
            arrName === "storedClasses" ? "storedClasses" : "storedSubjects",
            JSON.stringify(window[arrName])
          );
          updateDatalist(
            arrName === "storedClasses" ? "classOptions" : "subjectOptions",
            window[arrName]
          );
        }
      }

      document
        .getElementById("className")
        .addEventListener("change", () =>
          storeValue("className", "storedClasses")
        );
      document
        .getElementById("examSubject")
        .addEventListener("change", () =>
          storeValue("examSubject", "storedSubjects")
        );

      function numberToChinese(number) {
        const mapping = [
          "一",
          "二",
          "三",
          "四",
          "五",
          "六",
          "七",
          "八",
          "九",
          "十",
          "十一",
          "十二",
          "十三",
          "十四",
          "十五",
          "十六",
          "十七",
          "十八",
          "十九",
          "二十",
        ];
        return mapping[number - 1] || number;
      }

      function showMessage(text, type) {
        const messageElement = document.getElementById("message");
        messageElement.textContent = text;
        messageElement.className = type;
        messageElement.style.display = "block";
        setTimeout(() => {
          messageElement.style.display = "none";
        }, 3000);
      }

      function generateSeatingChart() {
        const seatingChart = document.getElementById("seatingChart");
        seatingChart.innerHTML = "";

        seatingChart.style.gridTemplateColumns = `60px repeat(${columns}, 1fr)`;

        const labelRow = document.createElement("div");
        labelRow.classList.add("label-row");

        const emptyLabel = document.createElement("div");
        emptyLabel.classList.add("label-cell");
        labelRow.appendChild(emptyLabel);

        const columnOrder = horizontalReverse
          ? [...Array(columns).keys()].map((i) => columns - i)
          : [...Array(columns).keys()].map((i) => i + 1);

        for (let c of columnOrder) {
          const colLabel = document.createElement("div");
          colLabel.classList.add("label-cell");
          colLabel.textContent = numberToChinese(c);
          colLabel.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            toggleColumnDisabled(c);
          });
          labelRow.appendChild(colLabel);
        }
        seatingChart.appendChild(labelRow);

        const rowOrder = verticalReverse
          ? [...Array(rows).keys()].map((i) => rows - i)
          : [...Array(rows).keys()].map((i) => i + 1);

        for (let r of rowOrder) {
          const rowDiv = document.createElement("div");
          rowDiv.classList.add("label-row");

          const rowLabel = document.createElement("div");
          rowLabel.classList.add("label-cell");
          rowLabel.textContent = numberToChinese(r);
          rowLabel.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            toggleRowDisabled(r);
          });
          rowDiv.appendChild(rowLabel);

          for (let c of columnOrder) {
            const seat = document.createElement("div");
            seat.classList.add("seat");
            seat.title = "長按並拖曳可交換位置；點擊座號或姓名可編輯";
            seat.dataset.row = r;
            seat.dataset.column = c;
            const idx = (r - 1) * columns + c;
            seat.dataset.index = idx;

            if (nameFirst) {
              // 姓名在上 座號在下
              seat.innerHTML = `
            <div class="seat-name" data-placeholder="姓名"></div>
            <div class="seat-id" data-placeholder="座號"></div>
          `;
            } else {
              // 座號在上 姓名在下
              seat.innerHTML = `
            <div class="seat-id" data-placeholder="座號"></div>
            <div class="seat-name" data-placeholder="姓名"></div>
          `;
            }

            seat.setAttribute("draggable", "true");
            seat.addEventListener("dragstart", handleDragStart);
            seat.addEventListener("dragover", handleDragOver);
            seat.addEventListener("drop", handleDrop);
            seat.addEventListener("dragend", handleDragEnd);

            seat.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              toggleSeatDisabled(e);
            });

            // 點擊座號或姓名即可編輯
            seat.querySelector(".seat-id").addEventListener("click", (ev) => {
              toggleEditing(ev.target);
            });
            seat.querySelector(".seat-name").addEventListener("click", (ev) => {
              toggleEditing(ev.target);
            });

            rowDiv.appendChild(seat);
          }
          seatingChart.appendChild(rowDiv);
        }

        updateSeatingChartState();
        reloadStudentsToSeats();
        if (batchMode) {
          setAllSeatsEditable(false);
        } else {
          setAllSeatsEditable(true);
        }
      }

      function toggleEditing(element) {
        // 點擊文字區域即可編輯
        let editable = element.contentEditable === "true";
        element.contentEditable = editable ? "false" : "true";
        if (!editable) {
          // 剛剛從不可編輯變成可編輯，focus
          element.focus();
        } else {
          // 結束編輯，更新學生資料
          const seat = element.closest(".seat");
          const id = seat.querySelector(".seat-id").textContent.trim();
          const name = seat.querySelector(".seat-name").textContent.trim();
          const index = seat.dataset.index;
          const student = students.find((s) => s.position === index);
          if (student) {
            const dup = students.some(
              (s) => (s.id === id || s.name === name) && s.position !== index
            );
            if (dup) {
              showMessage("座號或姓名重複", "error");
              seat.querySelector(".seat-id").textContent = student.id;
              seat.querySelector(".seat-name").textContent = student.name;
            } else {
              student.id = id;
              student.name = name;
            }
          } else {
            if (name !== "" && id !== "") {
              const dup = students.some((s) => s.id === id || s.name === name);
              if (dup) {
                showMessage("座號或姓名重複", "error");
                seat.querySelector(".seat-id").textContent = "";
                seat.querySelector(".seat-name").textContent = "";
              } else {
                students.push({ id, name, position: index });
              }
            }
          }
        }
      }

      function setAllSeatsEditable(editable) {
        document.querySelectorAll(".seat").forEach((seat) => {
          const mode = editable && !batchMode ? "true" : "false";
          seat.querySelector(".seat-id").contentEditable = mode;
          seat.querySelector(".seat-name").contentEditable = mode;
        });
      }

      function toggleColumnDisabled(colNumber) {
        const seatsInColumn = Array.from(
          document.querySelectorAll(".seat")
        ).filter((s) => parseInt(s.dataset.column) === colNumber);

        const currentlyDisabled = seatsInColumn.every((s) =>
          disabledSeats.has(s.dataset.index)
        );

        if (!currentlyDisabled) {
          const occupantSeats = seatsInColumn.filter((seat) => {
            const seatId = seat.querySelector(".seat-id").textContent.trim();
            const seatName = seat
              .querySelector(".seat-name")
              .textContent.trim();
            return seatId !== "" && seatName !== "";
          });

          if (occupantSeats.length > 0) {
            occupantSeats.sort(
              (a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index)
            );
            const allSeats = Array.from(document.querySelectorAll(".seat"));
            const availableSeats = allSeats.filter(
              (s) =>
                !disabledSeats.has(s.dataset.index) &&
                s.querySelector(".seat-name").textContent.trim() === "" &&
                !seatsInColumn.includes(s)
            );

            const occupantCount = occupantSeats.length;
            if (availableSeats.length < occupantCount) {
              showMessage(`該列有${occupantCount}位學生無法移動`, "error");
              return;
            }

            for (let i = 0; i < occupantCount; i++) {
              const fromSeat = occupantSeats[i];
              const toSeat = availableSeats[i];
              moveStudent(fromSeat, toSeat);
            }
          }

          for (let seat of seatsInColumn) {
            disableSeat(seat);
          }
          showMessage(`第${numberToChinese(colNumber)}列已禁用`, "success");
        } else {
          for (let seat of seatsInColumn) {
            enableSeat(seat);
          }
          showMessage(`第${numberToChinese(colNumber)}列已啟用`, "success");
        }
      }

      function toggleRowDisabled(rowNumber) {
        const seatsInRow = Array.from(
          document.querySelectorAll(".seat")
        ).filter((s) => parseInt(s.dataset.row) === rowNumber);

        const currentlyDisabled = seatsInRow.every((s) =>
          disabledSeats.has(s.dataset.index)
        );

        if (!currentlyDisabled) {
          const occupantSeats = seatsInRow.filter((seat) => {
            const seatId = seat.querySelector(".seat-id").textContent.trim();
            const seatName = seat
              .querySelector(".seat-name")
              .textContent.trim();
            return seatId !== "" && seatName !== "";
          });

          if (occupantSeats.length > 0) {
            occupantSeats.sort(
              (a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index)
            );
            const allSeats = Array.from(document.querySelectorAll(".seat"));
            const availableSeats = allSeats.filter(
              (s) =>
                !disabledSeats.has(s.dataset.index) &&
                s.querySelector(".seat-name").textContent.trim() === "" &&
                !seatsInRow.includes(s)
            );

            const occupantCount = occupantSeats.length;
            if (availableSeats.length < occupantCount) {
              showMessage(
                `第${numberToChinese(
                  rowNumber
                )}排有${occupantCount}位學生無法移動`,
                "error"
              );
              return;
            }

            for (let i = 0; i < occupantCount; i++) {
              const fromSeat = occupantSeats[i];
              const toSeat = availableSeats[i];
              moveStudent(fromSeat, toSeat);
            }
          }

          for (let seat of seatsInRow) {
            disableSeat(seat);
          }
          showMessage(`第${numberToChinese(rowNumber)}排已禁用`, "success");
        } else {
          for (let seat of seatsInRow) {
            enableSeat(seat);
          }
          showMessage(`第${numberToChinese(rowNumber)}排已啟用`, "success");
        }
      }

      function toggleSeatDisabled(event) {
        const seat = event.currentTarget;
        const index = seat.dataset.index;

        if (disabledSeats.has(index)) {
          enableSeat(seat);
          showMessage("座位已啟用", "success");
        } else {
          const seatId = seat.querySelector(".seat-id").textContent.trim();
          const seatName = seat.querySelector(".seat-name").textContent.trim();

          if (seatId !== "" && seatName !== "") {
            const newSeat = findNextAvailableSeat(index);
            if (!newSeat) {
              showMessage(`沒有可用座位移動學生「${seatName}」`, "error");
              return;
            }
            moveStudent(seat, newSeat);
          }

          disableSeat(seat);
          showMessage("座位已禁用", "success");
        }
      }

      function disableSeat(seat) {
        const index = seat.dataset.index;
        disabledSeats.add(index);
        seat.classList.add("disabled");
        seat.querySelector(".seat-id").textContent = "";
        seat.querySelector(".seat-name").textContent = "";
        seat.querySelector(".seat-id").contentEditable = "false";
        seat.querySelector(".seat-name").contentEditable = "false";
        const overlay = document.createElement("div");
        overlay.classList.add("disabled-overlay");
        seat.appendChild(overlay);
        students = students.filter((s) => s.position !== index);
      }

      function enableSeat(seat) {
        const index = seat.dataset.index;
        disabledSeats.delete(index);
        seat.classList.remove("disabled");
        const overlay = seat.querySelector(".disabled-overlay");
        if (overlay) seat.removeChild(overlay);
        if (!batchMode) {
          seat.querySelector(".seat-id").contentEditable = "true";
          seat.querySelector(".seat-name").contentEditable = "true";
        } else {
          seat.querySelector(".seat-id").contentEditable = "false";
          seat.querySelector(".seat-name").contentEditable = "false";
        }
      }

      function moveStudent(fromSeat, toSeat) {
        const fromId = fromSeat.querySelector(".seat-id").textContent.trim();
        const fromName = fromSeat
          .querySelector(".seat-name")
          .textContent.trim();

        toSeat.querySelector(".seat-id").textContent = fromId;
        toSeat.querySelector(".seat-name").textContent = fromName;

        fromSeat.querySelector(".seat-id").textContent = "";
        fromSeat.querySelector(".seat-name").textContent = "";

        const stu = students.find(
          (st) => st.id === fromId && st.name === fromName
        );
        if (stu) stu.position = toSeat.dataset.index;
      }

      function findNextAvailableSeat(excludeIndex) {
        const availableSeats = Array.from(
          document.querySelectorAll(".seat")
        ).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) &&
            seat.querySelector(".seat-name").textContent.trim() === "" &&
            seat.dataset.index !== excludeIndex
        );
        return availableSeats.length > 0 ? availableSeats[0] : null;
      }

      let draggedSeat = null;

      function handleDragStart(e) {
        if (this.classList.contains("disabled")) {
          e.preventDefault();
          return;
        }
        draggedSeat = this;
        e.dataTransfer.setData("text/plain", this.dataset.index);
        setTimeout(() => {
          this.classList.add("dragging");
        }, 0);
      }

      function handleDragOver(e) {
        e.preventDefault();
        if (this.classList.contains("disabled") || this === draggedSeat) return;
        this.classList.add("highlight");
      }

      function handleDrop(e) {
        e.preventDefault();
        this.classList.remove("highlight");
        const fromIndex = e.dataTransfer.getData("text/plain");
        const toIndex = this.dataset.index;
        if (fromIndex === toIndex) return;

        const fromSeat = document.querySelector(
          `.seat[data-index='${fromIndex}']`
        );
        const toSeat = document.querySelector(`.seat[data-index='${toIndex}']`);

        if (toSeat.classList.contains("disabled")) {
          showMessage("無法拖曳到禁用位置", "error");
          return;
        }

        const tempId = fromSeat.querySelector(".seat-id").textContent;
        const tempName = fromSeat.querySelector(".seat-name").textContent;

        fromSeat.querySelector(".seat-id").textContent =
          toSeat.querySelector(".seat-id").textContent;
        fromSeat.querySelector(".seat-name").textContent =
          toSeat.querySelector(".seat-name").textContent;

        toSeat.querySelector(".seat-id").textContent = tempId;
        toSeat.querySelector(".seat-name").textContent = tempName;

        updateStudentPosition(fromIndex, toIndex);

        fromSeat.classList.add("swapping");
        toSeat.classList.add("swapping");
        setTimeout(() => {
          fromSeat.classList.remove("swapping");
          toSeat.classList.remove("swapping");
        }, 500);

        showMessage("座位已交換", "success");
      }

      function handleDragEnd(e) {
        this.classList.remove("dragging");
        document
          .querySelectorAll(".seat")
          .forEach((seat) => seat.classList.remove("highlight"));
      }

      function updateStudentPosition(fromIndex, toIndex) {
        const fromStudent = students.find((s) => s.position === fromIndex);
        const toStudent = students.find((s) => s.position === toIndex);

        if (fromStudent) {
          fromStudent.position = toIndex;
        }
        if (toStudent) {
          toStudent.position = fromIndex;
        }
      }

      function randomlyArrangeSeats() {
        const allSeats = Array.from(document.querySelectorAll(".seat")).filter(
          (seat) => !disabledSeats.has(seat.dataset.index)
        );

        const assignedStudents = students.filter((s) => {
          const seat = document.querySelector(
            `.seat[data-index='${s.position}']`
          );
          return seat && !disabledSeats.has(s.position);
        });

        if (assignedStudents.length > allSeats.length) {
          showMessage("可用座位不足，無法隨機排列", "error");
          return;
        }

        allSeats.forEach((seat) => {
          seat.querySelector(".seat-id").textContent = "";
          seat.querySelector(".seat-name").textContent = "";
        });

        const shuffled = shuffleArray([...assignedStudents]);

        shuffled.forEach((student, index) => {
          if (index < allSeats.length) {
            const seat = allSeats[index];
            seat.querySelector(".seat-id").textContent = student.id;
            seat.querySelector(".seat-name").textContent = student.name;
            student.position = seat.dataset.index;
          }
        });

        showMessage("座位已隨機排列", "success");
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function exportToExcel() {
        const className = document.getElementById("className").value || "班級";
        const examSubject = document.getElementById("examSubject").value || "";
        const examType = document.getElementById("examType").value || "";
        const examTime = document.getElementById("examTime").value || "";
        const timestamp = getFormattedTimestamp();

        const data = [];
        data.push([`${className}座位表`]);
        data.push([
          `考試科目：${examSubject}`,
          `考試類型：${examType}`,
          `考試時間：${examTime}`,
        ]);
        data.push([]);

        const columnOrder = horizontalReverse
          ? [...Array(columns).keys()].map((i) => columns - i)
          : [...Array(columns).keys()].map((i) => i + 1);

        const rowOrder = verticalReverse
          ? [...Array(rows).keys()].map((i) => rows - i)
          : [...Array(rows).keys()].map((i) => i + 1);

        const headerRow = ["行\\列"];
        columnOrder.forEach((c) => {
          headerRow.push(numberToChinese(c));
        });
        data.push(headerRow);

        for (let r of rowOrder) {
          const seatRow = [numberToChinese(r)];
          const seatNameRow = [""];

          for (let c of columnOrder) {
            const index = (r - 1) * columns + c;
            const seat = document.querySelector(`.seat[data-index='${index}']`);

            if (seat && !disabledSeats.has(index.toString())) {
              const id = seat.querySelector(".seat-id").textContent.trim();
              const name = seat.querySelector(".seat-name").textContent.trim();
              seatRow.push(id);
              seatNameRow.push(name);
            } else {
              seatRow.push("");
              seatNameRow.push("");
            }
          }

          data.push(seatRow);
          data.push(seatNameRow);
        }

        const worksheet = XLSX.utils.aoa_to_sheet(data);
        worksheet["!merges"] = worksheet["!merges"] || [];
        worksheet["!merges"].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } });
        worksheet["!merges"].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 1 } });

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, `${className}座位表`);
        XLSX.writeFile(workbook, `${className}座位表_${timestamp}.xlsx`);
        showMessage("Excel 檔案已匯出", "success");
      }

      function exportToWord() {
        const className = document.getElementById("className").value || "班級";
        const examSubject = document.getElementById("examSubject").value || "";
        const examType = document.getElementById("examType").value || "";
        const examTime = document.getElementById("examTime").value || "";
        const timestamp = getFormattedTimestamp();

        const columnOrder = horizontalReverse
          ? [...Array(columns).keys()].map((i) => columns - i)
          : [...Array(columns).keys()].map((i) => i + 1);

        const rowOrder = verticalReverse
          ? [...Array(rows).keys()].map((i) => rows - i)
          : [...Array(rows).keys()].map((i) => i + 1);

        let docContent = `<h1>${className}座位表</h1>`;
        docContent += `<p>考試科目：${examSubject}　考試類型：${examType}　考試時間：${examTime}</p>`;
        docContent +=
          '<table border="1" style="border-collapse:collapse;width:100%;">';

        docContent += "<tr><th>行\\列</th>";
        for (let c of columnOrder) {
          docContent += `<th>${numberToChinese(c)}</th>`;
        }
        docContent += "</tr>";

        for (let r of rowOrder) {
          docContent += `<tr><td>${numberToChinese(r)}</td>`;
          for (let c of columnOrder) {
            const index = (r - 1) * columns + c;
            const seat = document.querySelector(`.seat[data-index='${index}']`);
            if (seat && !disabledSeats.has(index.toString())) {
              const id = seat.querySelector(".seat-id").textContent.trim();
              const name = seat.querySelector(".seat-name").textContent.trim();
              docContent += `<td>${id}<br>${name}</td>`;
            } else {
              docContent += `<td></td>`;
            }
          }
          docContent += "</tr>";
        }

        docContent += "</table>";

        const blob = new Blob(["\ufeff", docContent], {
          type: "application/msword",
        });
        saveAs(blob, `${className}座位表_${timestamp}.doc`);
        showMessage("Word 檔案已匯出", "success");
      }

      function saveStudentList() {
        const className = document.getElementById("className").value || "班級";
        const examSubject = document.getElementById("examSubject").value || "";
        const examType = document.getElementById("examType").value || "";
        const examTime = document.getElementById("examTime").value || "";
        const timestamp = getFormattedTimestamp();
        const listName = prompt(
          "請輸入名單名稱：",
          `${className}_${timestamp}`
        );
        if (!listName) {
          showMessage("未輸入名單名稱，取消保存。", "error");
          return;
        }

        const data = {
          className,
          timestamp,
          rows,
          columns,
          students,
          disabledSeats: Array.from(disabledSeats),
          horizontalReverse,
          verticalReverse,
          examSubject,
          examType,
          examTime,
          nameFirst,
        };

        let savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];

        if (savedLists.find((list) => list.listName === listName)) {
          if (!confirm("已存在相同名稱的名單，是否要覆蓋？")) {
            showMessage("取消保存。", "error");
            return;
          }
          savedLists = savedLists.filter((list) => list.listName !== listName);
        }

        savedLists.push({ listName, data });
        localStorage.setItem("seatChartSavedLists", JSON.stringify(savedLists));
        showMessage("學生名單已保存", "success");
      }

      function openLoadModal() {
        const modal = document.getElementById("loadModal");
        const savedListContainer = document.getElementById("savedList");
        savedListContainer.innerHTML = "";

        const savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];

        if (savedLists.length === 0) {
          savedListContainer.innerHTML = "<li>沒有已保存的學生名單。</li>";
        } else {
          savedLists.forEach((list) => {
            const li = document.createElement("li");
            li.textContent = list.listName;
            li.onclick = () => {
              loadStudentListByName(list.listName);
              closeLoadModal();
            };
            savedListContainer.appendChild(li);
          });
        }

        modal.style.display = "block";
      }

      function closeLoadModal() {
        const modal = document.getElementById("loadModal");
        modal.style.display = "none";
      }

      window.onclick = function (event) {
        const modal = document.getElementById("loadModal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      function loadStudentListByName(listName) {
        const savedLists =
          JSON.parse(localStorage.getItem("seatChartSavedLists")) || [];
        const list = savedLists.find((item) => item.listName === listName);
        if (!list) {
          showMessage("找不到該學生名單", "error");
          return;
        }

        const data = list.data;
        document.getElementById("className").value = data.className || "";
        document.getElementById("examSubject").value = data.examSubject || "";
        document.getElementById("examType").value = data.examType || "";
        document.getElementById("examTime").value = data.examTime || "";
        nameFirst = data.nameFirst || false;

        setDimensionsSafely(data.rows, data.columns);
        students = data.students || [];
        disabledSeats = new Set(data.disabledSeats || []);
        horizontalReverse =
          data.horizontalReverse !== undefined ? data.horizontalReverse : true;
        verticalReverse =
          data.verticalReverse !== undefined ? data.verticalReverse : false;

        generateSeatingChart();
        showMessage(`已載入學生名單：「${listName}」`, "success");
      }

      function updateSeatingChartState() {
        document.querySelectorAll(".seat").forEach((seat) => {
          const index = seat.dataset.index;
          if (disabledSeats.has(index)) {
            seat.classList.add("disabled");
            seat.querySelector(".seat-id").textContent = "";
            seat.querySelector(".seat-name").textContent = "";
            seat.querySelector(".seat-id").contentEditable = "false";
            seat.querySelector(".seat-name").contentEditable = "false";
            const overlay = document.createElement("div");
            overlay.classList.add("disabled-overlay");
            seat.appendChild(overlay);
          } else {
            seat.classList.remove("disabled");
            const overlay = seat.querySelector(".disabled-overlay");
            if (overlay) seat.removeChild(overlay);
            if (!batchMode) {
              seat.querySelector(".seat-id").contentEditable = "true";
              seat.querySelector(".seat-name").contentEditable = "true";
            } else {
              seat.querySelector(".seat-id").contentEditable = "false";
              seat.querySelector(".seat-name").contentEditable = "false";
            }
          }
        });
      }

      function isChineseName(str) {
        const chineseRegex = /^[\u4e00-\u9fa5]+$/;
        return chineseRegex.test(str);
      }

      function isStudentId(str) {
        const idRegex = /^[A-Za-z0-9]+$/;
        return idRegex.test(str) || /[A-Za-z0-9]/.test(str);
      }

      function handlePaste(e) {
        e.preventDefault();
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData("Text");

        const lines = pastedData.trim().split("\n");
        const newStudents = [];
        const duplicateCheck = new Set();

        lines.forEach((line, lineNumber) => {
          const fields = line.trim().split("\t");
          let id = "";
          let name = "";
          fields.forEach((field) => {
            if (isChineseName(field.trim())) {
              name = field.trim();
            } else if (isStudentId(field.trim())) {
              id = field.trim();
            }
          });

          if (id && name) {
            if (
              students.some((s) => s.id === id || s.name === name) ||
              duplicateCheck.has(id) ||
              duplicateCheck.has(name)
            ) {
              showMessage(
                `第 ${lineNumber + 1} 行有重複座號或姓名，已跳過`,
                "error"
              );
              return;
            }
            duplicateCheck.add(id);
            duplicateCheck.add(name);
            newStudents.push({ name, id });
          }
        });

        const availableSeatsCount = Array.from(
          document.querySelectorAll(".seat")
        ).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) &&
            seat.querySelector(".seat-name").textContent.trim() === ""
        ).length;

        if (newStudents.length > availableSeatsCount) {
          showMessage(
            `可用座位不足，最多可貼上 ${availableSeatsCount} 位學生。`,
            "error"
          );
          return;
        }

        distributeStudents(newStudents);
        showMessage("學生資料已貼上", "success");
        batchMode = true;
        setAllSeatsEditable(false);
      }

      function distributeStudents(newStudents) {
        const seats = Array.from(document.querySelectorAll(".seat")).filter(
          (seat) =>
            !disabledSeats.has(seat.dataset.index) &&
            seat.querySelector(".seat-name").textContent.trim() === ""
        );

        newStudents.forEach((student, index) => {
          if (index < seats.length) {
            const seat = seats[index];
            seat.querySelector(".seat-id").textContent = student.id;
            seat.querySelector(".seat-name").textContent = student.name;
            seat.dataset.studentId = student.id || "";
            students.push({
              name: student.name,
              id: student.id,
              position: seat.dataset.index,
            });
          }
        });
      }

      function getFormattedTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const seconds = String(now.getSeconds()).padStart(2, "0");
        return `${year}${month}${day}_${hours}${minutes}${seconds}`;
      }

      function checkDimensionChange(newRows, newCols) {
        if (newRows < rows || newCols < columns) {
          const maxIndex = newRows * newCols;
          const outOfRangeSeats = Array.from(
            document.querySelectorAll(".seat")
          ).filter((s) => parseInt(s.dataset.index) > maxIndex);
          for (let seat of outOfRangeSeats) {
            const idx = seat.dataset.index;
            const seatId = seat.querySelector(".seat-id").textContent.trim();
            const seatName = seat
              .querySelector(".seat-name")
              .textContent.trim();
            if (seatId !== "" || seatName !== "" || disabledSeats.has(idx)) {
              return false;
            }
          }
        }
        return true;
      }

      function setDimensionsSafely(r, c) {
        if (checkDimensionChange(r, c)) {
          rows = r;
          columns = c;
          oldRows = rows;
          oldColumns = columns;
          generateSeatingChart();
        } else {
          showMessage(
            "請先解除相關禁用或清空超出範圍的座位再更改尺寸",
            "error"
          );
          document.getElementById("rows").value = oldRows;
          document.getElementById("columns").value = oldColumns;
        }
      }

      document.getElementById("rows").addEventListener("change", () => {
        const newR = parseInt(document.getElementById("rows").value);
        setDimensionsSafely(newR, columns);
      });
      document.getElementById("columns").addEventListener("change", () => {
        const newC = parseInt(document.getElementById("columns").value);
        setDimensionsSafely(rows, newC);
      });

      document.getElementById("rowUpBtn").addEventListener("click", () => {
        setDimensionsSafely(rows + 1, columns);
        document.getElementById("rows").value = rows;
      });
      document.getElementById("rowDownBtn").addEventListener("click", () => {
        if (rows > 1) {
          setDimensionsSafely(rows - 1, columns);
          document.getElementById("rows").value = rows;
        }
      });
      document.getElementById("colUpBtn").addEventListener("click", () => {
        setDimensionsSafely(rows, columns + 1);
        document.getElementById("columns").value = columns;
      });
      document.getElementById("colDownBtn").addEventListener("click", () => {
        if (columns > 1) {
          setDimensionsSafely(rows, columns - 1);
          document.getElementById("columns").value = columns;
        }
      });

      document
        .getElementById("toggleHorizontalBtn")
        .addEventListener("click", () => {
          horizontalReverse = !horizontalReverse;
          generateSeatingChart();
        });

      document
        .getElementById("toggleVerticalBtn")
        .addEventListener("click", () => {
          verticalReverse = !verticalReverse;
          generateSeatingChart();
        });

      document
        .getElementById("toggleNameOrderBtn")
        .addEventListener("click", () => {
          nameFirst = !nameFirst;
          generateSeatingChart();
        });

      function reloadStudentsToSeats() {
        document.querySelectorAll(".seat").forEach((seat) => {
          const stu = students.find((s) => s.position === seat.dataset.index);
          if (stu && !disabledSeats.has(seat.dataset.index)) {
            seat.querySelector(".seat-id").textContent = stu.id;
            seat.querySelector(".seat-name").textContent = stu.name;
          } else {
            if (!disabledSeats.has(seat.dataset.index)) {
              seat.querySelector(".seat-id").textContent = "";
              seat.querySelector(".seat-name").textContent = "";
            }
          }
        });
      }

      document
        .getElementById("seatingChartContainer")
        .addEventListener("paste", handlePaste);

      window.onload = function () {
        generateSeatingChart();
        document.getElementById("seatingChartContainer").focus();
      };
    </script>
  </body>
</html>
