<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>面積換算工具</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              100: '#dbeafe', 
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#2B76F9',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a'
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94A3B8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a'
            },
            accent: {
              highlight: '#FEF7C3',
              success: '#10b981',
              warning: '#f59e0b',
              error: '#ef4444'
            }
          },
          fontFamily: {
            sans: ['Inter', 'Noto Sans TC', 'sans-serif']
          },
          spacing: {
            '18': '4.5rem',
            '22': '5.5rem',
            '30': '7.5rem'
          }
        }
      }
    }
  </script>
  
  <style>
    /* Mobile-First 觸控優化樣式 */
    
    /* 觸控友好的輸入框 */
    .input-mobile {
      @apply h-14 px-4 py-3 text-lg rounded-xl border-2 border-secondary-200;
      @apply bg-white shadow-sm transition-all duration-300 ease-in-out;
      @apply focus:border-primary-500 focus:ring-4 focus:ring-primary-500/20;
      @apply hover:border-secondary-300;
      min-height: 3.5rem;
      touch-action: manipulation;
    }
    
    .input-highlighted {
      @apply bg-accent-highlight border-primary-400;
      @apply ring-4 ring-primary-200/50;
    }
    
    .input-calculating {
      @apply border-primary-300 bg-primary-50/30;
    }
    
    /* 輸入框容器 */
    .input-container {
      @apply relative mb-3 touch-none;
    }
    
    /* 左側標籤與圖標 */
    .input-label {
      @apply flex items-center mb-2 text-base font-medium text-secondary-700;
    }
    
    .input-icon {
      @apply w-5 h-5 text-primary-500 mr-2 flex-shrink-0;
    }
    
    /* 右側單位後綴 */
    .input-suffix {
      @apply absolute right-3 top-1/2 transform -translate-y-1/2;
      @apply text-secondary-500 font-medium pointer-events-none text-base;
    }
    
    /* Loading Spinner */
    .input-spinner {
      @apply absolute right-10 top-1/2 transform -translate-y-1/2;
      @apply text-primary-500 opacity-0 transition-opacity duration-200;
    }
    
    .input-spinner.visible {
      @apply opacity-100;
    }
    
    /* 粘底操作列 */
    .sticky-actions {
      @apply fixed bottom-0 left-0 right-0 z-40;
      @apply bg-white border-t border-secondary-200 shadow-lg;
      @apply px-4 py-3 safe-area-inset-bottom;
    }
    
    /* 大觸控按鈕 */
    .btn-mobile {
      @apply h-12 px-6 text-base font-semibold rounded-xl;
      @apply transition-all duration-200 ease-out;
      @apply active:scale-95 focus:outline-none focus:ring-4;
      min-height: 3rem;
      touch-action: manipulation;
    }
    
    .btn-primary-mobile {
      @apply bg-gradient-to-r from-primary-500 to-primary-600;
      @apply text-white shadow-lg;
      @apply hover:from-primary-600 hover:to-primary-700;
      @apply focus:ring-primary-500/30;
    }
    
    .btn-secondary-mobile {
      @apply bg-secondary-400 text-white;
      @apply hover:bg-secondary-500;
      @apply focus:ring-secondary-400/30;
    }
    
    /* 彩蛋按鈕 - 移動版優化 */
    .easter-egg-mobile {
      @apply fixed top-4 right-4 z-50;
      @apply w-8 h-8 rounded-full;
      @apply bg-gradient-to-r from-pink-400 to-purple-500;
      @apply shadow-md opacity-60;
      @apply flex items-center justify-center;
      @apply transition-all duration-300 ease-out;
      @apply active:scale-90;
      touch-action: manipulation;
    }
    
    .easter-egg-mobile:active {
      @apply opacity-100 scale-110;
    }
    
    /* 全螢幕 Modal */
    .modal-fullscreen {
      @apply fixed inset-0 z-[100] flex items-center justify-center;
      @apply bg-black/50 backdrop-blur-sm;
      @apply opacity-0 pointer-events-none;
      @apply transition-all duration-300 ease-out;
    }
    
    .modal-fullscreen.active {
      @apply opacity-100 pointer-events-auto;
    }
    
    .modal-content-mobile {
      @apply bg-white rounded-2xl p-6 mx-4;
      @apply max-w-sm w-full max-h-[80vh] overflow-y-auto;
      @apply transform scale-95 transition-all duration-300 ease-out;
      @apply shadow-2xl;
    }
    
    .modal-fullscreen.active .modal-content-mobile {
      @apply scale-100;
    }
    
    /* 響應式網格 */
    .grid-mobile {
      @apply grid gap-3;
      @apply grid-cols-1;
    }
    
    /* 橫向時兩欄 */
    @media (orientation: landscape) and (max-height: 600px) {
      .grid-mobile {
        @apply grid-cols-2 gap-2;
      }
      
      .input-container {
        @apply mb-2;
      }
      
      .input-mobile {
        @apply h-12 text-base;
        min-height: 3rem;
      }
    }
    
    /* 平板以上螢幕優化 */
    @media (min-width: 768px) {
      .grid-mobile {
        @apply grid-cols-2 gap-4;
      }
      
      .sticky-actions {
        @apply relative border-t-0 shadow-none px-0 py-0;
        @apply bg-transparent;
      }
    }
    
    @media (min-width: 1024px) {
      .grid-mobile {
        @apply grid-cols-4;
      }
    }
    
    /* 通知 Toast - 移動版 */
    .toast-mobile {
      @apply fixed top-4 left-4 right-4 z-50;
      @apply bg-white border border-secondary-200 rounded-xl shadow-xl;
      @apply p-4 transform -translate-y-full opacity-0;
      @apply transition-all duration-300 ease-out;
    }
    
    .toast-mobile.visible {
      @apply translate-y-0 opacity-100;
    }
    
    /* 無障礙焦點增強 */
    .focus-visible {
      @apply focus:outline-none;
    }
    
    /* 安全區域適配 */
    .safe-area-inset-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* 防止縮放 */
    .no-zoom {
      touch-action: manipulation;
    }
    
    /* 滾動優化 */
    .scroll-smooth {
      scroll-behavior: smooth;
    }
    
    /* 主內容區域 - 為粘底按鈕預留空間 */
    .main-content {
      @apply pb-20;
    }
    
    @media (min-width: 768px) {
      .main-content {
        @apply pb-8;
      }
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 font-sans no-zoom scroll-smooth">
  
  <!-- 簡化 Header -->
  <header class="bg-white shadow-sm border-b border-secondary-100 sticky top-0 z-30">
    <div class="px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 bg-gradient-to-r from-primary-500 to-primary-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-ruler-combined text-white text-sm"></i>
          </div>
          <div>
            <h1 class="text-lg font-bold text-secondary-800">面積換算</h1>
            <p class="text-xs text-secondary-500">精準快速轉換</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 主要內容區 -->
  <main class="main-content px-4 py-4">
    
    <!-- 使用提示卡片 -->
    <div class="bg-primary-50 border border-primary-200 rounded-xl p-4 mb-4">
      <div class="flex items-start space-x-2">
        <i class="fas fa-info-circle text-primary-500 mt-0.5 text-sm"></i>
        <div class="text-sm">
          <p class="font-medium text-primary-800 mb-1">快速使用</p>
          <p class="text-primary-700">選擇任一欄位輸入數值，系統將自動換算其他單位</p>
        </div>
      </div>
    </div>

    <!-- 換算輸入區域 -->
    <div class="bg-white rounded-2xl shadow-sm border border-secondary-100 p-4 mb-4">
      <form id="converter-form">
        
        <div class="grid-mobile" id="input-grid">
          
          <!-- 平方公尺 -->
          <div class="input-container">
            <label for="sqm" class="input-label">
              <i class="fas fa-square input-icon"></i>
              平方公尺
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="sqm" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="平方公尺數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">㎡</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-sqm"></i>
            </div>
          </div>

          <!-- 坪 -->
          <div class="input-container">
            <label for="ping" class="input-label">
              <i class="fas fa-home input-icon"></i>
              坪
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="ping" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="坪數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">坪</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-ping"></i>
            </div>
          </div>

          <!-- 公頃 -->
          <div class="input-container">
            <label for="hectare" class="input-label">
              <i class="fas fa-map input-icon"></i>
              公頃
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="hectare" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="公頃數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">ha</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-hectare"></i>
            </div>
          </div>

          <!-- 甲 -->
          <div class="input-container">
            <label for="jia" class="input-label">
              <i class="fas fa-seedling input-icon"></i>
              甲
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="jia" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="甲數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">甲</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-jia"></i>
            </div>
          </div>

          <!-- 分 -->
          <div class="input-container">
            <label for="fen" class="input-label">
              <i class="fas fa-leaf input-icon"></i>
              分
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="fen" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="分數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">分</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-fen"></i>
            </div>
          </div>

          <!-- 公畝 -->
          <div class="input-container">
            <label for="are" class="input-label">
              <i class="fas fa-chart-area input-icon"></i>
              公畝
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="are" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="公畝數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">a</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-are"></i>
            </div>
          </div>

          <!-- 英畝 -->
          <div class="input-container">
            <label for="acre" class="input-label">
              <i class="fas fa-flag input-icon"></i>
              英畝
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="acre" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="英畝數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">acre</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-acre"></i>
            </div>
          </div>

          <!-- 市畝 -->
          <div class="input-container">
            <label for="mu" class="input-label">
              <i class="fas fa-landmark input-icon"></i>
              市畝
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="mu" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="市畝數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">市畝</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-mu"></i>
            </div>
          </div>

        </div>

      </form>
    </div>

    <!-- 備註說明 -->
    <div class="bg-white rounded-xl border border-secondary-100 p-4">
      <details class="group">
        <summary class="cursor-pointer select-none">
          <div class="flex items-center justify-between">
            <h3 class="text-base font-semibold text-secondary-800 flex items-center">
              <i class="fas fa-info-circle text-primary-500 mr-2"></i>
              備註說明
            </h3>
            <i class="fas fa-chevron-down text-secondary-400 transform transition-transform duration-200 group-open:rotate-180"></i>
          </div>
        </summary>
        
        <div class="mt-3 pt-3 border-t border-secondary-100 space-y-3">
          <div class="bg-accent-highlight bg-opacity-50 border border-yellow-200 rounded-lg p-3">
            <ol class="text-sm text-secondary-700 space-y-1 list-decimal list-inside">
              <li>請先選擇換算的原始單位欄位，輸入數字資料。</li>
              <li>點擊 [計算]，會將輸入值(黃色)，換算為各種其他的單位值。</li>
            </ol>
          </div>
          
          <div class="bg-red-50 border border-red-200 rounded-lg p-3">
            <p class="text-sm text-red-700">
              <i class="fas fa-exclamation-triangle mr-1"></i>
              本查詢系統資料以各地政事務所為準，本系統資料僅供參考。
            </p>
          </div>
        </div>
      </details>
    </div>

  </main>

  <!-- 粘底操作列 -->
  <div class="sticky-actions">
    <div class="flex gap-3">
      <button 
        type="button" 
        id="clear-btn"
        class="btn-mobile btn-secondary-mobile flex-1 focus-visible"
        aria-label="清除所有輸入數值"
      >
        <i class="fas fa-eraser mr-2"></i>
        清除
      </button>
      
      <button 
        type="button" 
        id="copy-btn"
        class="btn-mobile btn-primary-mobile flex-1 focus-visible hidden"
        aria-label="複製換算結果"
      >
        <i class="fas fa-copy mr-2"></i>
        複製結果
      </button>
    </div>
  </div>

  <!-- 彩蛋按鈕 - 移動版 -->
  <div class="easter-egg-mobile" id="easter-egg">
    <i class="fas fa-magic text-white text-xs"></i>
  </div>

  <!-- 全螢幕彩蛋 Modal -->
  <div class="modal-fullscreen" id="easter-modal">
    <div class="modal-content-mobile">
      <div class="text-center">
        <div class="w-12 h-12 bg-gradient-to-r from-pink-400 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-rocket text-white text-lg"></i>
        </div>
        <h3 class="text-lg font-bold text-secondary-800 mb-2">🎉 發現隱藏功能！</h3>
        <p class="text-secondary-600 text-sm mb-4">你找到了我們的小秘密！這裡有個特別的面積知識：</p>
        
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-3 mb-4">
          <h4 class="font-semibold text-secondary-800 mb-2 text-sm">💡 有趣的面積比較</h4>
          <p class="text-xs text-secondary-700">
            台北101大樓的土地面積約為 <span class="font-bold text-primary-600">3,056 坪</span>，
            相當於 <span class="font-bold text-primary-600">10,100 ㎡</span>！
          </p>
        </div>
        
        <div class="flex gap-2">
          <button class="btn-mobile btn-primary-mobile text-sm flex-1" onclick="generateRandomConversion()">
            <i class="fas fa-dice mr-1"></i>
            隨機換算
          </button>
          <button class="btn-mobile btn-secondary-mobile text-sm flex-1" onclick="closeEasterEgg()">
            <i class="fas fa-times mr-1"></i>
            關閉
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 移動版通知 Toast -->
  <div id="toast" class="toast-mobile">
    <div class="flex items-center space-x-3">
      <div class="flex-shrink-0">
        <i id="toast-icon" class="fas fa-check-circle text-accent-success"></i>
      </div>
      <div class="flex-1">
        <p id="toast-message" class="text-sm font-medium text-secondary-800"></p>
      </div>
      <button onclick="hideToast()" class="flex-shrink-0 text-secondary-400">
        <i class="fas fa-times text-sm"></i>
      </button>
    </div>
  </div>

  <script>
    // ===== 核心變數與設定 =====
    
    // 換算係數 (以平方公尺為基準單位)
    const CONVERSION_FACTORS = {
      sqm: 1,                    // 平方公尺 (基準)
      ping: 0.3025,              // 坪
      hectare: 10000,            // 公頃
      jia: 3305.785,             // 甲
      fen: 330.578,              // 分
      are: 100,                  // 公畝
      acre: 4046.8564224,        // 英畝
      mu: 666.6667               // 市畝
    };
    
    // 防抖設定
    const DEBOUNCE_DELAY = 300; // 300ms 防抖延遲
    
    // 全域狀態
    let currentActiveInput = null;
    let lastCalculatedValues = {};
    let debounceTimers = {};
    
    // ===== DOM 元素引用 =====
    const clearBtn = document.getElementById('clear-btn');
    const copyBtn = document.getElementById('copy-btn');
    const easterEgg = document.getElementById('easter-egg');
    const easterModal = document.getElementById('easter-modal');
    
    // 所有輸入欄位和對應的 Spinner
    const inputs = {
      sqm: document.getElementById('sqm'),
      ping: document.getElementById('ping'),
      hectare: document.getElementById('hectare'),
      jia: document.getElementById('jia'),
      fen: document.getElementById('fen'),
      are: document.getElementById('are'),
      acre: document.getElementById('acre'),
      mu: document.getElementById('mu')
    };
    
    const spinners = {
      sqm: document.getElementById('spinner-sqm'),
      ping: document.getElementById('spinner-ping'),
      hectare: document.getElementById('spinner-hectare'),
      jia: document.getElementById('spinner-jia'),
      fen: document.getElementById('spinner-fen'),
      are: document.getElementById('spinner-are'),
      acre: document.getElementById('spinner-acre'),
      mu: document.getElementById('spinner-mu')
    };

    // ===== 防抖即時計算邏輯 =====
    
    /**
     * 防抖函數
     * @param {Function} func - 要執行的函數
     * @param {number} delay - 延遲時間 (ms)
     * @param {string} key - 唯一鍵值用於管理多個計時器
     */
    function debounce(func, delay, key) {
      return function(...args) {
        // 清除之前的計時器
        if (debounceTimers[key]) {
          clearTimeout(debounceTimers[key]);
        }
        
        // 設定新的計時器
        debounceTimers[key] = setTimeout(() => {
          func.apply(this, args);
          delete debounceTimers[key];
        }, delay);
      };
    }
    
    /**
     * 顯示計算中狀態
     * @param {string} sourceUnit - 來源單位
     */
    function showCalculating(sourceUnit) {
      // 顯示 Spinner
      spinners[sourceUnit].classList.add('visible');
      
      // 為輸入框添加計算中樣式
      inputs[sourceUnit].classList.add('input-calculating');
    }
    
    /**
     * 隱藏計算中狀態
     * @param {string} sourceUnit - 來源單位
     */
    function hideCalculating(sourceUnit) {
      // 隱藏 Spinner
      spinners[sourceUnit].classList.remove('visible');
      
      // 移除計算中樣式
      inputs[sourceUnit].classList.remove('input-calculating');
    }
    
    /**
     * 執行面積單位換算計算 (防抖版本)
     * @param {string} sourceUnit - 來源單位鍵值
     * @param {number} sourceValue - 來源數值
     */
    function calculateConversions(sourceUnit, sourceValue) {
      // 顯示計算狀態
      showCalculating(sourceUnit);
      
      if (!sourceValue || sourceValue <= 0) {
        hideCalculating(sourceUnit);
        return;
      }
      
      // 模擬計算延遲 (實際使用中可移除)
      setTimeout(() => {
        try {
          // 先轉換為平方公尺 (基準單位)
          const sqmValue = sourceUnit === 'sqm' 
            ? sourceValue 
            : sourceValue * CONVERSION_FACTORS[sourceUnit];
          
          // 計算所有其他單位的數值
          const results = {};
          
          Object.keys(CONVERSION_FACTORS).forEach(unit => {
            if (unit === sourceUnit) {
              results[unit] = sourceValue; // 保持原始輸入值
            } else if (unit === 'sqm') {
              results[unit] = sqmValue;
            } else {
              results[unit] = sqmValue / CONVERSION_FACTORS[unit];
            }
          });
          
          // 更新其他輸入欄位 (避免重新觸發事件)
          Object.keys(results).forEach(unit => {
            if (unit !== sourceUnit) {
              const formattedValue = parseFloat(results[unit].toFixed(6));
              // 暫時移除事件監聽器，避免循環觸發
              inputs[unit].removeEventListener('input', inputHandlers[unit]);
              inputs[unit].value = formattedValue;
              // 重新添加事件監聽器
              inputs[unit].addEventListener('input', inputHandlers[unit]);
            }
          });
          
          // 儲存計算結果
          lastCalculatedValues = results;
          
          // 顯示複製按鈕
          copyBtn.classList.remove('hidden');
          
          // 隱藏計算狀態
          hideCalculating(sourceUnit);
          
        } catch (error) {
          console.error('計算錯誤:', error);
          hideCalculating(sourceUnit);
          showToast('計算出現錯誤，請重試', 'error');
        }
      }, 100); // 100ms 模擬計算時間
    }
    
    /**
     * 清除所有輸入欄位並重置狀態
     */
    function clearAllInputs() {
      Object.values(inputs).forEach(input => {
        input.value = '';
        input.classList.remove('input-highlighted');
      });
      
      // 清除所有防抖計時器
      Object.keys(debounceTimers).forEach(key => {
        clearTimeout(debounceTimers[key]);
        delete debounceTimers[key];
      });
      
      // 隱藏所有 Spinner
      Object.values(spinners).forEach(spinner => {
        spinner.classList.remove('visible');
      });
      
      currentActiveInput = null;
      lastCalculatedValues = {};
      copyBtn.classList.add('hidden');
      
      showToast('已清除所有數值', 'info');
    }
    
    /**
     * 複製換算結果到剪貼簿
     */
    async function copyResults() {
      if (Object.keys(lastCalculatedValues).length === 0) {
        showToast('沒有可複製的結果', 'error');
        return;
      }
      
      // 格式化結果文字
      const resultText = Object.entries(lastCalculatedValues)
        .map(([unit, value]) => {
          const unitNames = {
            sqm: '平方公尺',
            ping: '坪',
            hectare: '公頃',
            jia: '甲',
            fen: '分',
            are: '公畝',
            acre: '英畝',
            mu: '市畝'
          };
          
          const formattedValue = parseFloat(value.toFixed(6));
          return `${unitNames[unit]}: ${formattedValue}`;
        })
        .join('\n');
      
      try {
        await navigator.clipboard.writeText(resultText);
        showToast('結果已複製！', 'success');
      } catch (err) {
        console.error('複製失敗:', err);
        showToast('複製失敗', 'error');
      }
    }

    // ===== 事件處理器設定 =====
    
    // 儲存每個輸入框的防抖處理器
    const inputHandlers = {};
    
    /**
     * 設定當前活動的輸入欄位 (互斥機制)
     * @param {string} activeUnit - 要設為活動的單位
     */
    function setActiveInput(activeUnit) {
      // 移除所有高亮樣式
      Object.values(inputs).forEach(input => {
        input.classList.remove('input-highlighted');
      });
      
      // 高亮當前活動欄位
      inputs[activeUnit].classList.add('input-highlighted');
      currentActiveInput = activeUnit;
      
      // 隱藏複製按鈕
      copyBtn.classList.add('hidden');
    }
    
    // 為每個輸入欄位設定防抖事件處理器
    Object.entries(inputs).forEach(([unit, input]) => {
      // 創建防抖版本的計算函數
      const debouncedCalculate = debounce((sourceUnit, sourceValue) => {
        calculateConversions(sourceUnit, sourceValue);
      }, DEBOUNCE_DELAY, unit);
      
      // 輸入事件處理器
      const inputHandler = (e) => {
        const value = parseFloat(e.target.value);
        
        // 設定為活動輸入
        setActiveInput(unit);
        
        if (e.target.value === '') {
          // 如果清空輸入，立即清空其他欄位
          Object.entries(inputs).forEach(([otherUnit, otherInput]) => {
            if (otherUnit !== unit) {
              otherInput.removeEventListener('input', inputHandlers[otherUnit]);
              otherInput.value = '';
              otherInput.addEventListener('input', inputHandlers[otherUnit]);
            }
          });
          return;
        }
        
        if (!isNaN(value) && value > 0) {
          // 清空其他欄位
          Object.entries(inputs).forEach(([otherUnit, otherInput]) => {
            if (otherUnit !== unit) {
              otherInput.removeEventListener('input', inputHandlers[otherUnit]);
              otherInput.value = '';
              otherInput.addEventListener('input', inputHandlers[otherUnit]);
            }
          });
          
          // 觸發防抖計算
          debouncedCalculate(unit, value);
        }
      };
      
      // 儲存處理器引用
      inputHandlers[unit] = inputHandler;
      
      // 綁定事件
      input.addEventListener('input', inputHandler);
      
      // 焦點事件
      input.addEventListener('focus', () => {
        setActiveInput(unit);
      });
      
      // 防止雙擊縮放 (iOS Safari)
      input.addEventListener('touchend', (e) => {
        e.preventDefault();
        input.focus();
      });
    });
    
    // 清除按鈕事件
    clearBtn.addEventListener('click', clearAllInputs);
    
    // 複製按鈕事件
    copyBtn.addEventListener('click', copyResults);

    // ===== 移動版通知系統 =====
    
    /**
     * 顯示通知 Toast
     * @param {string} message - 通知訊息
     * @param {string} type - 通知類型 ('success', 'error', 'warning', 'info')
     */
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const messageEl = document.getElementById('toast-message');
      
      // 設定圖示與樣式
      const styles = {
        success: { icon: 'fa-check-circle', color: 'text-accent-success' },
        error: { icon: 'fa-exclamation-circle', color: 'text-accent-error' },
        warning: { icon: 'fa-exclamation-triangle', color: 'text-accent-warning' },
        info: { icon: 'fa-info-circle', color: 'text-primary-500' }
      };
      
      const style = styles[type] || styles.info;
      icon.className = `fas ${style.icon} ${style.color}`;
      messageEl.textContent = message;
      
      // 顯示動畫
      toast.classList.add('visible');
      
      // 3秒後自動隱藏
      setTimeout(() => {
        hideToast();
      }, 3000);
    }
    
    /**
     * 隱藏通知 Toast
     */
    function hideToast() {
      const toast = document.getElementById('toast');
      toast.classList.remove('visible');
    }

    // ===== 彩蛋功能 =====
    
    let easterEggClicks = 0;
    let easterEggTimeout;
    
    // 彩蛋按鈕點擊事件
    easterEgg.addEventListener('click', (e) => {
      e.preventDefault();
      easterEggClicks++;
      
      // 清除之前的計時器
      clearTimeout(easterEggTimeout);
      
      // 3次點擊觸發彩蛋
      if (easterEggClicks >= 3) {
        showEasterEgg();
        easterEggClicks = 0;
      } else {
        // 1秒內沒有繼續點擊就重置計數
        easterEggTimeout = setTimeout(() => {
          easterEggClicks = 0;
        }, 1000);
      }
    });
    
    // 鍵盤彩蛋：輸入 "AREA" 觸發
    let keySequence = '';
    document.addEventListener('keydown', (e) => {
      keySequence += e.key.toLowerCase();
      
      if (keySequence.length > 4) {
        keySequence = keySequence.slice(-4);
      }
      
      if (keySequence === 'area') {
        showEasterEgg();
        keySequence = '';
      }
    });
    
    /**
     * 顯示彩蛋 Modal
     */
    function showEasterEgg() {
      easterModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    /**
     * 關閉彩蛋 Modal
     */
    function closeEasterEgg() {
      easterModal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    /**
     * 產生隨機換算示範
     */
    function generateRandomConversion() {
      const units = Object.keys(inputs);
      const randomUnit = units[Math.floor(Math.random() * units.length)];
      const randomValue = Math.floor(Math.random() * 1000) + 1;
      
      // 清除所有輸入
      clearAllInputs();
      
      // 設定隨機值
      inputs[randomUnit].value = randomValue;
      setActiveInput(randomUnit);
      
      // 執行計算
      calculateConversions(randomUnit, randomValue);
      
      // 關閉彩蛋
      closeEasterEgg();
      
      showToast(`隨機產生：${randomValue} 單位的換算`, 'success');
    }
    
    // 點擊 Modal 背景關閉
    easterModal.addEventListener('click', (e) => {
      if (e.target === easterModal) {
        closeEasterEgg();
      }
    });
    
    // ESC 鍵關閉彩蛋
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && easterModal.classList.contains('active')) {
        closeEasterEgg();
      }
    });

    // ===== 移動裝置優化 =====
    
    // 防止 iOS Safari 雙擊縮放
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // 防止橫向滾動
    document.addEventListener('touchmove', function(e) {
      if (e.touches.length > 1) {
        e.preventDefault();
      }
    }, { passive: false });
    
    // 視窗大小變化處理
    window.addEventListener('orientationchange', () => {
      // 延遲執行以確保視窗尺寸更新完成
      setTimeout(() => {
        // 強制重新計算視窗高度 (修復 iOS Safari 的視窗高度問題)
        window.scrollTo(0, 0);
      }, 500);
    });
    
    // 頁面可見性變化處理 (App 切換時清理狀態)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // 頁面隱藏時清理防抖計時器
        Object.keys(debounceTimers).forEach(key => {
          clearTimeout(debounceTimers[key]);
          delete debounceTimers[key];
        });
      }
    });

    // ===== 初始化 =====
    
    /**
     * 頁面載入完成後的初始化
     */
    document.addEventListener('DOMContentLoaded', () => {
      // 預設焦點到第一個輸入欄位
      inputs.sqm.focus();
      
      // 移動版歡迎訊息
      setTimeout(() => {
        showToast('輸入數值即可自動換算', 'info');
      }, 1000);
      
      // 檢測觸控設備
      if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
      }
    });
    
    // ===== 開發者工具 (僅開發模式) =====
    
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      window.areaConverter = {
        calculateConversions,
        clearAllInputs,
        showToast,
        inputs,
        CONVERSION_FACTORS,
        debounceTimers
      };
    }
    
  </script>

</body>
</html>