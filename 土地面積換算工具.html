<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>é¢ç©æ›ç®—å·¥å…·</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              100: '#dbeafe', 
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#2B76F9',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a'
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94A3B8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a'
            },
            accent: {
              highlight: '#FEF7C3',
              success: '#10b981',
              warning: '#f59e0b',
              error: '#ef4444'
            }
          },
          fontFamily: {
            sans: ['Inter', 'Noto Sans TC', 'sans-serif']
          },
          spacing: {
            '18': '4.5rem',
            '22': '5.5rem',
            '30': '7.5rem'
          }
        }
      }
    }
  </script>
  
  <style>
    /* Mobile-First è§¸æ§å„ªåŒ–æ¨£å¼ */
    
    /* è§¸æ§å‹å¥½çš„è¼¸å…¥æ¡† */
    .input-mobile {
      @apply h-14 px-4 py-3 text-lg rounded-xl border-2 border-secondary-200;
      @apply bg-white shadow-sm transition-all duration-300 ease-in-out;
      @apply focus:border-primary-500 focus:ring-4 focus:ring-primary-500/20;
      @apply hover:border-secondary-300;
      min-height: 3.5rem;
      touch-action: manipulation;
    }
    
    .input-highlighted {
      @apply bg-accent-highlight border-primary-400;
      @apply ring-4 ring-primary-200/50;
    }
    
    .input-calculating {
      @apply border-primary-300 bg-primary-50/30;
    }
    
    /* è¼¸å…¥æ¡†å®¹å™¨ */
    .input-container {
      @apply relative mb-3 touch-none;
    }
    
    /* å·¦å´æ¨™ç±¤èˆ‡åœ–æ¨™ */
    .input-label {
      @apply flex items-center mb-2 text-base font-medium text-secondary-700;
    }
    
    .input-icon {
      @apply w-5 h-5 text-primary-500 mr-2 flex-shrink-0;
    }
    
    /* å³å´å–®ä½å¾Œç¶´ */
    .input-suffix {
      @apply absolute right-3 top-1/2 transform -translate-y-1/2;
      @apply text-secondary-500 font-medium pointer-events-none text-base;
    }
    
    /* Loading Spinner */
    .input-spinner {
      @apply absolute right-10 top-1/2 transform -translate-y-1/2;
      @apply text-primary-500 opacity-0 transition-opacity duration-200;
    }
    
    .input-spinner.visible {
      @apply opacity-100;
    }
    
    /* ç²˜åº•æ“ä½œåˆ— */
    .sticky-actions {
      @apply fixed bottom-0 left-0 right-0 z-40;
      @apply bg-white border-t border-secondary-200 shadow-lg;
      @apply px-4 py-3 safe-area-inset-bottom;
    }
    
    /* å¤§è§¸æ§æŒ‰éˆ• */
    .btn-mobile {
      @apply h-12 px-6 text-base font-semibold rounded-xl;
      @apply transition-all duration-200 ease-out;
      @apply active:scale-95 focus:outline-none focus:ring-4;
      min-height: 3rem;
      touch-action: manipulation;
    }
    
    .btn-primary-mobile {
      @apply bg-gradient-to-r from-primary-500 to-primary-600;
      @apply text-white shadow-lg;
      @apply hover:from-primary-600 hover:to-primary-700;
      @apply focus:ring-primary-500/30;
    }
    
    .btn-secondary-mobile {
      @apply bg-secondary-400 text-white;
      @apply hover:bg-secondary-500;
      @apply focus:ring-secondary-400/30;
    }
    
    /* å½©è›‹æŒ‰éˆ• - ç§»å‹•ç‰ˆå„ªåŒ– */
    .easter-egg-mobile {
      @apply fixed top-4 right-4 z-50;
      @apply w-8 h-8 rounded-full;
      @apply bg-gradient-to-r from-pink-400 to-purple-500;
      @apply shadow-md opacity-60;
      @apply flex items-center justify-center;
      @apply transition-all duration-300 ease-out;
      @apply active:scale-90;
      touch-action: manipulation;
    }
    
    .easter-egg-mobile:active {
      @apply opacity-100 scale-110;
    }
    
    /* å…¨è¢å¹• Modal */
    .modal-fullscreen {
      @apply fixed inset-0 z-[100] flex items-center justify-center;
      @apply bg-black/50 backdrop-blur-sm;
      @apply opacity-0 pointer-events-none;
      @apply transition-all duration-300 ease-out;
    }
    
    .modal-fullscreen.active {
      @apply opacity-100 pointer-events-auto;
    }
    
    .modal-content-mobile {
      @apply bg-white rounded-2xl p-6 mx-4;
      @apply max-w-sm w-full max-h-[80vh] overflow-y-auto;
      @apply transform scale-95 transition-all duration-300 ease-out;
      @apply shadow-2xl;
    }
    
    .modal-fullscreen.active .modal-content-mobile {
      @apply scale-100;
    }
    
    /* éŸ¿æ‡‰å¼ç¶²æ ¼ */
    .grid-mobile {
      @apply grid gap-3;
      @apply grid-cols-1;
    }
    
    /* æ©«å‘æ™‚å…©æ¬„ */
    @media (orientation: landscape) and (max-height: 600px) {
      .grid-mobile {
        @apply grid-cols-2 gap-2;
      }
      
      .input-container {
        @apply mb-2;
      }
      
      .input-mobile {
        @apply h-12 text-base;
        min-height: 3rem;
      }
    }
    
    /* å¹³æ¿ä»¥ä¸Šè¢å¹•å„ªåŒ– */
    @media (min-width: 768px) {
      .grid-mobile {
        @apply grid-cols-2 gap-4;
      }
      
      .sticky-actions {
        @apply relative border-t-0 shadow-none px-0 py-0;
        @apply bg-transparent;
      }
    }
    
    @media (min-width: 1024px) {
      .grid-mobile {
        @apply grid-cols-4;
      }
    }
    
    /* é€šçŸ¥ Toast - ç§»å‹•ç‰ˆ */
    .toast-mobile {
      @apply fixed top-4 left-4 right-4 z-50;
      @apply bg-white border border-secondary-200 rounded-xl shadow-xl;
      @apply p-4 transform -translate-y-full opacity-0;
      @apply transition-all duration-300 ease-out;
    }
    
    .toast-mobile.visible {
      @apply translate-y-0 opacity-100;
    }
    
    /* ç„¡éšœç¤™ç„¦é»å¢å¼· */
    .focus-visible {
      @apply focus:outline-none;
    }
    
    /* å®‰å…¨å€åŸŸé©é… */
    .safe-area-inset-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* é˜²æ­¢ç¸®æ”¾ */
    .no-zoom {
      touch-action: manipulation;
    }
    
    /* æ»¾å‹•å„ªåŒ– */
    .scroll-smooth {
      scroll-behavior: smooth;
    }
    
    /* ä¸»å…§å®¹å€åŸŸ - ç‚ºç²˜åº•æŒ‰éˆ•é ç•™ç©ºé–“ */
    .main-content {
      @apply pb-20;
    }
    
    @media (min-width: 768px) {
      .main-content {
        @apply pb-8;
      }
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 font-sans no-zoom scroll-smooth">
  
  <!-- ç°¡åŒ– Header -->
  <header class="bg-white shadow-sm border-b border-secondary-100 sticky top-0 z-30">
    <div class="px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 bg-gradient-to-r from-primary-500 to-primary-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-ruler-combined text-white text-sm"></i>
          </div>
          <div>
            <h1 class="text-lg font-bold text-secondary-800">é¢ç©æ›ç®—</h1>
            <p class="text-xs text-secondary-500">ç²¾æº–å¿«é€Ÿè½‰æ›</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ä¸»è¦å…§å®¹å€ -->
  <main class="main-content px-4 py-4">
    
    <!-- ä½¿ç”¨æç¤ºå¡ç‰‡ -->
    <div class="bg-primary-50 border border-primary-200 rounded-xl p-4 mb-4">
      <div class="flex items-start space-x-2">
        <i class="fas fa-info-circle text-primary-500 mt-0.5 text-sm"></i>
        <div class="text-sm">
          <p class="font-medium text-primary-800 mb-1">å¿«é€Ÿä½¿ç”¨</p>
          <p class="text-primary-700">é¸æ“‡ä»»ä¸€æ¬„ä½è¼¸å…¥æ•¸å€¼ï¼Œç³»çµ±å°‡è‡ªå‹•æ›ç®—å…¶ä»–å–®ä½</p>
        </div>
      </div>
    </div>

    <!-- æ›ç®—è¼¸å…¥å€åŸŸ -->
    <div class="bg-white rounded-2xl shadow-sm border border-secondary-100 p-4 mb-4">
      <form id="converter-form">
        
        <div class="grid-mobile" id="input-grid">
          
          <!-- å¹³æ–¹å…¬å°º -->
          <div class="input-container">
            <label for="sqm" class="input-label">
              <i class="fas fa-square input-icon"></i>
              å¹³æ–¹å…¬å°º
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="sqm" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="å¹³æ–¹å…¬å°ºæ•¸å€¼è¼¸å…¥"
                autocomplete="off"
              >
              <span class="input-suffix">ã¡</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-sqm"></i>
            </div>
          </div>

          <!-- åª -->
          <div class="input-container">
            <label for="ping" class="input-label">
              <i class="fas fa-home input-icon"></i>
              åª
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="ping" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="åªæ•¸å€¼è¼¸å…¥"
                autocomplete="off"
              >
              <span class="input-suffix">åª</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-ping"></i>
            </div>
          </div>

          <!-- å…¬é ƒ -->
          <div class="input-container">
            <label for="hectare" class="input-label">
              <i class="fas fa-map input-icon"></i>
              å…¬é ƒ
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="hectare" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="å…¬é ƒæ•¸å€¼è¼¸å…¥"
                autocomplete="off"
              >
              <span class="input-suffix">ha</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-hectare"></i>
            </div>
          </div>

          <!-- ç”² -->
          <div class="input-container">
            <label for="jia" class="input-label">
              <i class="fas fa-seedling input-icon"></i>
              ç”²
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="jia" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="ç”²æ•¸å€¼è¼¸å…¥"
                autocomplete="off"
              >
              <span class="input-suffix">ç”²</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-jia"></i>
            </div>
          </div>

          <!-- åˆ† -->
          <div class="input-container">
            <label for="fen" class="input-label">
              <i class="fas fa-leaf input-icon"></i>
              åˆ†
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="fen" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="åˆ†æ•¸å€¼è¼¸å…¥"
                autocomplete="off"
              >
              <span class="input-suffix">åˆ†</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-fen"></i>
            </div>
          </div>

          <!-- å…¬ç• -->
          <div class="input-container">
            <label for="are" class="input-label">
              <i class="fas fa-chart-area input-icon"></i>
              å…¬ç•
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="are" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="å…¬ç•æ•¸å€¼è¼¸å…¥"
                autocomplete="off"
              >
              <span class="input-suffix">a</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-are"></i>
            </div>
          </div>

          <!-- è‹±ç• -->
          <div class="input-container">
            <label for="acre" class="input-label">
              <i class="fas fa-flag input-icon"></i>
              è‹±ç•
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="acre" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="è‹±ç•æ•¸å€¼è¼¸å…¥"
                autocomplete="off"
              >
              <span class="input-suffix">acre</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-acre"></i>
            </div>
          </div>

          <!-- å¸‚ç• -->
          <div class="input-container">
            <label for="mu" class="input-label">
              <i class="fas fa-landmark input-icon"></i>
              å¸‚ç•
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="mu" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="å¸‚ç•æ•¸å€¼è¼¸å…¥"
                autocomplete="off"
              >
              <span class="input-suffix">å¸‚ç•</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-mu"></i>
            </div>
          </div>

        </div>

      </form>
    </div>

    <!-- å‚™è¨»èªªæ˜ -->
    <div class="bg-white rounded-xl border border-secondary-100 p-4">
      <details class="group">
        <summary class="cursor-pointer select-none">
          <div class="flex items-center justify-between">
            <h3 class="text-base font-semibold text-secondary-800 flex items-center">
              <i class="fas fa-info-circle text-primary-500 mr-2"></i>
              å‚™è¨»èªªæ˜
            </h3>
            <i class="fas fa-chevron-down text-secondary-400 transform transition-transform duration-200 group-open:rotate-180"></i>
          </div>
        </summary>
        
        <div class="mt-3 pt-3 border-t border-secondary-100 space-y-3">
          <div class="bg-accent-highlight bg-opacity-50 border border-yellow-200 rounded-lg p-3">
            <ol class="text-sm text-secondary-700 space-y-1 list-decimal list-inside">
              <li>è«‹å…ˆé¸æ“‡æ›ç®—çš„åŸå§‹å–®ä½æ¬„ä½ï¼Œè¼¸å…¥æ•¸å­—è³‡æ–™ã€‚</li>
              <li>é»æ“Š [è¨ˆç®—]ï¼Œæœƒå°‡è¼¸å…¥å€¼(é»ƒè‰²)ï¼Œæ›ç®—ç‚ºå„ç¨®å…¶ä»–çš„å–®ä½å€¼ã€‚</li>
            </ol>
          </div>
          
          <div class="bg-red-50 border border-red-200 rounded-lg p-3">
            <p class="text-sm text-red-700">
              <i class="fas fa-exclamation-triangle mr-1"></i>
              æœ¬æŸ¥è©¢ç³»çµ±è³‡æ–™ä»¥å„åœ°æ”¿äº‹å‹™æ‰€ç‚ºæº–ï¼Œæœ¬ç³»çµ±è³‡æ–™åƒ…ä¾›åƒè€ƒã€‚
            </p>
          </div>
        </div>
      </details>
    </div>

  </main>

  <!-- ç²˜åº•æ“ä½œåˆ— -->
  <div class="sticky-actions">
    <div class="flex gap-3">
      <button 
        type="button" 
        id="clear-btn"
        class="btn-mobile btn-secondary-mobile flex-1 focus-visible"
        aria-label="æ¸…é™¤æ‰€æœ‰è¼¸å…¥æ•¸å€¼"
      >
        <i class="fas fa-eraser mr-2"></i>
        æ¸…é™¤
      </button>
      
      <button 
        type="button" 
        id="copy-btn"
        class="btn-mobile btn-primary-mobile flex-1 focus-visible hidden"
        aria-label="è¤‡è£½æ›ç®—çµæœ"
      >
        <i class="fas fa-copy mr-2"></i>
        è¤‡è£½çµæœ
      </button>
    </div>
  </div>

  <!-- å½©è›‹æŒ‰éˆ• - ç§»å‹•ç‰ˆ -->
  <div class="easter-egg-mobile" id="easter-egg">
    <i class="fas fa-magic text-white text-xs"></i>
  </div>

  <!-- å…¨è¢å¹•å½©è›‹ Modal -->
  <div class="modal-fullscreen" id="easter-modal">
    <div class="modal-content-mobile">
      <div class="text-center">
        <div class="w-12 h-12 bg-gradient-to-r from-pink-400 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-rocket text-white text-lg"></i>
        </div>
        <h3 class="text-lg font-bold text-secondary-800 mb-2">ğŸ‰ ç™¼ç¾éš±è—åŠŸèƒ½ï¼</h3>
        <p class="text-secondary-600 text-sm mb-4">ä½ æ‰¾åˆ°äº†æˆ‘å€‘çš„å°ç§˜å¯†ï¼é€™è£¡æœ‰å€‹ç‰¹åˆ¥çš„é¢ç©çŸ¥è­˜ï¼š</p>
        
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-3 mb-4">
          <h4 class="font-semibold text-secondary-800 mb-2 text-sm">ğŸ’¡ æœ‰è¶£çš„é¢ç©æ¯”è¼ƒ</h4>
          <p class="text-xs text-secondary-700">
            å°åŒ—101å¤§æ¨“çš„åœŸåœ°é¢ç©ç´„ç‚º <span class="font-bold text-primary-600">3,056 åª</span>ï¼Œ
            ç›¸ç•¶æ–¼ <span class="font-bold text-primary-600">10,100 ã¡</span>ï¼
          </p>
        </div>
        
        <div class="flex gap-2">
          <button class="btn-mobile btn-primary-mobile text-sm flex-1" onclick="generateRandomConversion()">
            <i class="fas fa-dice mr-1"></i>
            éš¨æ©Ÿæ›ç®—
          </button>
          <button class="btn-mobile btn-secondary-mobile text-sm flex-1" onclick="closeEasterEgg()">
            <i class="fas fa-times mr-1"></i>
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç§»å‹•ç‰ˆé€šçŸ¥ Toast -->
  <div id="toast" class="toast-mobile">
    <div class="flex items-center space-x-3">
      <div class="flex-shrink-0">
        <i id="toast-icon" class="fas fa-check-circle text-accent-success"></i>
      </div>
      <div class="flex-1">
        <p id="toast-message" class="text-sm font-medium text-secondary-800"></p>
      </div>
      <button onclick="hideToast()" class="flex-shrink-0 text-secondary-400">
        <i class="fas fa-times text-sm"></i>
      </button>
    </div>
  </div>

  <script>
    // ===== æ ¸å¿ƒè®Šæ•¸èˆ‡è¨­å®š =====
    
    // æ›ç®—ä¿‚æ•¸ (ä»¥å¹³æ–¹å…¬å°ºç‚ºåŸºæº–å–®ä½)
    const CONVERSION_FACTORS = {
      sqm: 1,                    // å¹³æ–¹å…¬å°º (åŸºæº–)
      ping: 0.3025,              // åª
      hectare: 10000,            // å…¬é ƒ
      jia: 3305.785,             // ç”²
      fen: 330.578,              // åˆ†
      are: 100,                  // å…¬ç•
      acre: 4046.8564224,        // è‹±ç•
      mu: 666.6667               // å¸‚ç•
    };
    
    // é˜²æŠ–è¨­å®š
    const DEBOUNCE_DELAY = 300; // 300ms é˜²æŠ–å»¶é²
    
    // å…¨åŸŸç‹€æ…‹
    let currentActiveInput = null;
    let lastCalculatedValues = {};
    let debounceTimers = {};
    
    // ===== DOM å…ƒç´ å¼•ç”¨ =====
    const clearBtn = document.getElementById('clear-btn');
    const copyBtn = document.getElementById('copy-btn');
    const easterEgg = document.getElementById('easter-egg');
    const easterModal = document.getElementById('easter-modal');
    
    // æ‰€æœ‰è¼¸å…¥æ¬„ä½å’Œå°æ‡‰çš„ Spinner
    const inputs = {
      sqm: document.getElementById('sqm'),
      ping: document.getElementById('ping'),
      hectare: document.getElementById('hectare'),
      jia: document.getElementById('jia'),
      fen: document.getElementById('fen'),
      are: document.getElementById('are'),
      acre: document.getElementById('acre'),
      mu: document.getElementById('mu')
    };
    
    const spinners = {
      sqm: document.getElementById('spinner-sqm'),
      ping: document.getElementById('spinner-ping'),
      hectare: document.getElementById('spinner-hectare'),
      jia: document.getElementById('spinner-jia'),
      fen: document.getElementById('spinner-fen'),
      are: document.getElementById('spinner-are'),
      acre: document.getElementById('spinner-acre'),
      mu: document.getElementById('spinner-mu')
    };

    // ===== é˜²æŠ–å³æ™‚è¨ˆç®—é‚è¼¯ =====
    
    /**
     * é˜²æŠ–å‡½æ•¸
     * @param {Function} func - è¦åŸ·è¡Œçš„å‡½æ•¸
     * @param {number} delay - å»¶é²æ™‚é–“ (ms)
     * @param {string} key - å”¯ä¸€éµå€¼ç”¨æ–¼ç®¡ç†å¤šå€‹è¨ˆæ™‚å™¨
     */
    function debounce(func, delay, key) {
      return function(...args) {
        // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
        if (debounceTimers[key]) {
          clearTimeout(debounceTimers[key]);
        }
        
        // è¨­å®šæ–°çš„è¨ˆæ™‚å™¨
        debounceTimers[key] = setTimeout(() => {
          func.apply(this, args);
          delete debounceTimers[key];
        }, delay);
      };
    }
    
    /**
     * é¡¯ç¤ºè¨ˆç®—ä¸­ç‹€æ…‹
     * @param {string} sourceUnit - ä¾†æºå–®ä½
     */
    function showCalculating(sourceUnit) {
      // é¡¯ç¤º Spinner
      spinners[sourceUnit].classList.add('visible');
      
      // ç‚ºè¼¸å…¥æ¡†æ·»åŠ è¨ˆç®—ä¸­æ¨£å¼
      inputs[sourceUnit].classList.add('input-calculating');
    }
    
    /**
     * éš±è—è¨ˆç®—ä¸­ç‹€æ…‹
     * @param {string} sourceUnit - ä¾†æºå–®ä½
     */
    function hideCalculating(sourceUnit) {
      // éš±è— Spinner
      spinners[sourceUnit].classList.remove('visible');
      
      // ç§»é™¤è¨ˆç®—ä¸­æ¨£å¼
      inputs[sourceUnit].classList.remove('input-calculating');
    }
    
    /**
     * åŸ·è¡Œé¢ç©å–®ä½æ›ç®—è¨ˆç®— (é˜²æŠ–ç‰ˆæœ¬)
     * @param {string} sourceUnit - ä¾†æºå–®ä½éµå€¼
     * @param {number} sourceValue - ä¾†æºæ•¸å€¼
     */
    function calculateConversions(sourceUnit, sourceValue) {
      // é¡¯ç¤ºè¨ˆç®—ç‹€æ…‹
      showCalculating(sourceUnit);
      
      if (!sourceValue || sourceValue <= 0) {
        hideCalculating(sourceUnit);
        return;
      }
      
      // æ¨¡æ“¬è¨ˆç®—å»¶é² (å¯¦éš›ä½¿ç”¨ä¸­å¯ç§»é™¤)
      setTimeout(() => {
        try {
          // å…ˆè½‰æ›ç‚ºå¹³æ–¹å…¬å°º (åŸºæº–å–®ä½)
          const sqmValue = sourceUnit === 'sqm' 
            ? sourceValue 
            : sourceValue * CONVERSION_FACTORS[sourceUnit];
          
          // è¨ˆç®—æ‰€æœ‰å…¶ä»–å–®ä½çš„æ•¸å€¼
          const results = {};
          
          Object.keys(CONVERSION_FACTORS).forEach(unit => {
            if (unit === sourceUnit) {
              results[unit] = sourceValue; // ä¿æŒåŸå§‹è¼¸å…¥å€¼
            } else if (unit === 'sqm') {
              results[unit] = sqmValue;
            } else {
              results[unit] = sqmValue / CONVERSION_FACTORS[unit];
            }
          });
          
          // æ›´æ–°å…¶ä»–è¼¸å…¥æ¬„ä½ (é¿å…é‡æ–°è§¸ç™¼äº‹ä»¶)
          Object.keys(results).forEach(unit => {
            if (unit !== sourceUnit) {
              const formattedValue = parseFloat(results[unit].toFixed(6));
              // æš«æ™‚ç§»é™¤äº‹ä»¶ç›£è½å™¨ï¼Œé¿å…å¾ªç’°è§¸ç™¼
              inputs[unit].removeEventListener('input', inputHandlers[unit]);
              inputs[unit].value = formattedValue;
              // é‡æ–°æ·»åŠ äº‹ä»¶ç›£è½å™¨
              inputs[unit].addEventListener('input', inputHandlers[unit]);
            }
          });
          
          // å„²å­˜è¨ˆç®—çµæœ
          lastCalculatedValues = results;
          
          // é¡¯ç¤ºè¤‡è£½æŒ‰éˆ•
          copyBtn.classList.remove('hidden');
          
          // éš±è—è¨ˆç®—ç‹€æ…‹
          hideCalculating(sourceUnit);
          
        } catch (error) {
          console.error('è¨ˆç®—éŒ¯èª¤:', error);
          hideCalculating(sourceUnit);
          showToast('è¨ˆç®—å‡ºç¾éŒ¯èª¤ï¼Œè«‹é‡è©¦', 'error');
        }
      }, 100); // 100ms æ¨¡æ“¬è¨ˆç®—æ™‚é–“
    }
    
    /**
     * æ¸…é™¤æ‰€æœ‰è¼¸å…¥æ¬„ä½ä¸¦é‡ç½®ç‹€æ…‹
     */
    function clearAllInputs() {
      Object.values(inputs).forEach(input => {
        input.value = '';
        input.classList.remove('input-highlighted');
      });
      
      // æ¸…é™¤æ‰€æœ‰é˜²æŠ–è¨ˆæ™‚å™¨
      Object.keys(debounceTimers).forEach(key => {
        clearTimeout(debounceTimers[key]);
        delete debounceTimers[key];
      });
      
      // éš±è—æ‰€æœ‰ Spinner
      Object.values(spinners).forEach(spinner => {
        spinner.classList.remove('visible');
      });
      
      currentActiveInput = null;
      lastCalculatedValues = {};
      copyBtn.classList.add('hidden');
      
      showToast('å·²æ¸…é™¤æ‰€æœ‰æ•¸å€¼', 'info');
    }
    
    /**
     * è¤‡è£½æ›ç®—çµæœåˆ°å‰ªè²¼ç°¿
     */
    async function copyResults() {
      if (Object.keys(lastCalculatedValues).length === 0) {
        showToast('æ²’æœ‰å¯è¤‡è£½çš„çµæœ', 'error');
        return;
      }
      
      // æ ¼å¼åŒ–çµæœæ–‡å­—
      const resultText = Object.entries(lastCalculatedValues)
        .map(([unit, value]) => {
          const unitNames = {
            sqm: 'å¹³æ–¹å…¬å°º',
            ping: 'åª',
            hectare: 'å…¬é ƒ',
            jia: 'ç”²',
            fen: 'åˆ†',
            are: 'å…¬ç•',
            acre: 'è‹±ç•',
            mu: 'å¸‚ç•'
          };
          
          const formattedValue = parseFloat(value.toFixed(6));
          return `${unitNames[unit]}: ${formattedValue}`;
        })
        .join('\n');
      
      try {
        await navigator.clipboard.writeText(resultText);
        showToast('çµæœå·²è¤‡è£½ï¼', 'success');
      } catch (err) {
        console.error('è¤‡è£½å¤±æ•—:', err);
        showToast('è¤‡è£½å¤±æ•—', 'error');
      }
    }

    // ===== äº‹ä»¶è™•ç†å™¨è¨­å®š =====
    
    // å„²å­˜æ¯å€‹è¼¸å…¥æ¡†çš„é˜²æŠ–è™•ç†å™¨
    const inputHandlers = {};
    
    /**
     * è¨­å®šç•¶å‰æ´»å‹•çš„è¼¸å…¥æ¬„ä½ (äº’æ–¥æ©Ÿåˆ¶)
     * @param {string} activeUnit - è¦è¨­ç‚ºæ´»å‹•çš„å–®ä½
     */
    function setActiveInput(activeUnit) {
      // ç§»é™¤æ‰€æœ‰é«˜äº®æ¨£å¼
      Object.values(inputs).forEach(input => {
        input.classList.remove('input-highlighted');
      });
      
      // é«˜äº®ç•¶å‰æ´»å‹•æ¬„ä½
      inputs[activeUnit].classList.add('input-highlighted');
      currentActiveInput = activeUnit;
      
      // éš±è—è¤‡è£½æŒ‰éˆ•
      copyBtn.classList.add('hidden');
    }
    
    // ç‚ºæ¯å€‹è¼¸å…¥æ¬„ä½è¨­å®šé˜²æŠ–äº‹ä»¶è™•ç†å™¨
    Object.entries(inputs).forEach(([unit, input]) => {
      // å‰µå»ºé˜²æŠ–ç‰ˆæœ¬çš„è¨ˆç®—å‡½æ•¸
      const debouncedCalculate = debounce((sourceUnit, sourceValue) => {
        calculateConversions(sourceUnit, sourceValue);
      }, DEBOUNCE_DELAY, unit);
      
      // è¼¸å…¥äº‹ä»¶è™•ç†å™¨
      const inputHandler = (e) => {
        const value = parseFloat(e.target.value);
        
        // è¨­å®šç‚ºæ´»å‹•è¼¸å…¥
        setActiveInput(unit);
        
        if (e.target.value === '') {
          // å¦‚æœæ¸…ç©ºè¼¸å…¥ï¼Œç«‹å³æ¸…ç©ºå…¶ä»–æ¬„ä½
          Object.entries(inputs).forEach(([otherUnit, otherInput]) => {
            if (otherUnit !== unit) {
              otherInput.removeEventListener('input', inputHandlers[otherUnit]);
              otherInput.value = '';
              otherInput.addEventListener('input', inputHandlers[otherUnit]);
            }
          });
          return;
        }
        
        if (!isNaN(value) && value > 0) {
          // æ¸…ç©ºå…¶ä»–æ¬„ä½
          Object.entries(inputs).forEach(([otherUnit, otherInput]) => {
            if (otherUnit !== unit) {
              otherInput.removeEventListener('input', inputHandlers[otherUnit]);
              otherInput.value = '';
              otherInput.addEventListener('input', inputHandlers[otherUnit]);
            }
          });
          
          // è§¸ç™¼é˜²æŠ–è¨ˆç®—
          debouncedCalculate(unit, value);
        }
      };
      
      // å„²å­˜è™•ç†å™¨å¼•ç”¨
      inputHandlers[unit] = inputHandler;
      
      // ç¶å®šäº‹ä»¶
      input.addEventListener('input', inputHandler);
      
      // ç„¦é»äº‹ä»¶
      input.addEventListener('focus', () => {
        setActiveInput(unit);
      });
      
      // é˜²æ­¢é›™æ“Šç¸®æ”¾ (iOS Safari)
      input.addEventListener('touchend', (e) => {
        e.preventDefault();
        input.focus();
      });
    });
    
    // æ¸…é™¤æŒ‰éˆ•äº‹ä»¶
    clearBtn.addEventListener('click', clearAllInputs);
    
    // è¤‡è£½æŒ‰éˆ•äº‹ä»¶
    copyBtn.addEventListener('click', copyResults);

    // ===== ç§»å‹•ç‰ˆé€šçŸ¥ç³»çµ± =====
    
    /**
     * é¡¯ç¤ºé€šçŸ¥ Toast
     * @param {string} message - é€šçŸ¥è¨Šæ¯
     * @param {string} type - é€šçŸ¥é¡å‹ ('success', 'error', 'warning', 'info')
     */
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const messageEl = document.getElementById('toast-message');
      
      // è¨­å®šåœ–ç¤ºèˆ‡æ¨£å¼
      const styles = {
        success: { icon: 'fa-check-circle', color: 'text-accent-success' },
        error: { icon: 'fa-exclamation-circle', color: 'text-accent-error' },
        warning: { icon: 'fa-exclamation-triangle', color: 'text-accent-warning' },
        info: { icon: 'fa-info-circle', color: 'text-primary-500' }
      };
      
      const style = styles[type] || styles.info;
      icon.className = `fas ${style.icon} ${style.color}`;
      messageEl.textContent = message;
      
      // é¡¯ç¤ºå‹•ç•«
      toast.classList.add('visible');
      
      // 3ç§’å¾Œè‡ªå‹•éš±è—
      setTimeout(() => {
        hideToast();
      }, 3000);
    }
    
    /**
     * éš±è—é€šçŸ¥ Toast
     */
    function hideToast() {
      const toast = document.getElementById('toast');
      toast.classList.remove('visible');
    }

    // ===== å½©è›‹åŠŸèƒ½ =====
    
    let easterEggClicks = 0;
    let easterEggTimeout;
    
    // å½©è›‹æŒ‰éˆ•é»æ“Šäº‹ä»¶
    easterEgg.addEventListener('click', (e) => {
      e.preventDefault();
      easterEggClicks++;
      
      // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
      clearTimeout(easterEggTimeout);
      
      // 3æ¬¡é»æ“Šè§¸ç™¼å½©è›‹
      if (easterEggClicks >= 3) {
        showEasterEgg();
        easterEggClicks = 0;
      } else {
        // 1ç§’å…§æ²’æœ‰ç¹¼çºŒé»æ“Šå°±é‡ç½®è¨ˆæ•¸
        easterEggTimeout = setTimeout(() => {
          easterEggClicks = 0;
        }, 1000);
      }
    });
    
    // éµç›¤å½©è›‹ï¼šè¼¸å…¥ "AREA" è§¸ç™¼
    let keySequence = '';
    document.addEventListener('keydown', (e) => {
      keySequence += e.key.toLowerCase();
      
      if (keySequence.length > 4) {
        keySequence = keySequence.slice(-4);
      }
      
      if (keySequence === 'area') {
        showEasterEgg();
        keySequence = '';
      }
    });
    
    /**
     * é¡¯ç¤ºå½©è›‹ Modal
     */
    function showEasterEgg() {
      easterModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    /**
     * é—œé–‰å½©è›‹ Modal
     */
    function closeEasterEgg() {
      easterModal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    /**
     * ç”¢ç”Ÿéš¨æ©Ÿæ›ç®—ç¤ºç¯„
     */
    function generateRandomConversion() {
      const units = Object.keys(inputs);
      const randomUnit = units[Math.floor(Math.random() * units.length)];
      const randomValue = Math.floor(Math.random() * 1000) + 1;
      
      // æ¸…é™¤æ‰€æœ‰è¼¸å…¥
      clearAllInputs();
      
      // è¨­å®šéš¨æ©Ÿå€¼
      inputs[randomUnit].value = randomValue;
      setActiveInput(randomUnit);
      
      // åŸ·è¡Œè¨ˆç®—
      calculateConversions(randomUnit, randomValue);
      
      // é—œé–‰å½©è›‹
      closeEasterEgg();
      
      showToast(`éš¨æ©Ÿç”¢ç”Ÿï¼š${randomValue} å–®ä½çš„æ›ç®—`, 'success');
    }
    
    // é»æ“Š Modal èƒŒæ™¯é—œé–‰
    easterModal.addEventListener('click', (e) => {
      if (e.target === easterModal) {
        closeEasterEgg();
      }
    });
    
    // ESC éµé—œé–‰å½©è›‹
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && easterModal.classList.contains('active')) {
        closeEasterEgg();
      }
    });

    // ===== ç§»å‹•è£ç½®å„ªåŒ– =====
    
    // é˜²æ­¢ iOS Safari é›™æ“Šç¸®æ”¾
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // é˜²æ­¢æ©«å‘æ»¾å‹•
    document.addEventListener('touchmove', function(e) {
      if (e.touches.length > 1) {
        e.preventDefault();
      }
    }, { passive: false });
    
    // è¦–çª—å¤§å°è®ŠåŒ–è™•ç†
    window.addEventListener('orientationchange', () => {
      // å»¶é²åŸ·è¡Œä»¥ç¢ºä¿è¦–çª—å°ºå¯¸æ›´æ–°å®Œæˆ
      setTimeout(() => {
        // å¼·åˆ¶é‡æ–°è¨ˆç®—è¦–çª—é«˜åº¦ (ä¿®å¾© iOS Safari çš„è¦–çª—é«˜åº¦å•é¡Œ)
        window.scrollTo(0, 0);
      }, 500);
    });
    
    // é é¢å¯è¦‹æ€§è®ŠåŒ–è™•ç† (App åˆ‡æ›æ™‚æ¸…ç†ç‹€æ…‹)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // é é¢éš±è—æ™‚æ¸…ç†é˜²æŠ–è¨ˆæ™‚å™¨
        Object.keys(debounceTimers).forEach(key => {
          clearTimeout(debounceTimers[key]);
          delete debounceTimers[key];
        });
      }
    });

    // ===== åˆå§‹åŒ– =====
    
    /**
     * é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', () => {
      // é è¨­ç„¦é»åˆ°ç¬¬ä¸€å€‹è¼¸å…¥æ¬„ä½
      inputs.sqm.focus();
      
      // ç§»å‹•ç‰ˆæ­¡è¿è¨Šæ¯
      setTimeout(() => {
        showToast('è¼¸å…¥æ•¸å€¼å³å¯è‡ªå‹•æ›ç®—', 'info');
      }, 1000);
      
      // æª¢æ¸¬è§¸æ§è¨­å‚™
      if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
      }
    });
    
    // ===== é–‹ç™¼è€…å·¥å…· (åƒ…é–‹ç™¼æ¨¡å¼) =====
    
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      window.areaConverter = {
        calculateConversions,
        clearAllInputs,
        showToast,
        inputs,
        CONVERSION_FACTORS,
        debounceTimers
      };
    }
    
  </script>

</body>
</html>