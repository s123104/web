<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>📱 面積換算工具 - 移動版</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              100: '#dbeafe', 
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#2B76F9', // Maintained from original if specific
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a'
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94A3B8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a'
            },
            accent: {
              highlight: '#FEF7C3', // yellow-ish for input highlight
              success: '#10b981',
              warning: '#f59e0b',
              error: '#ef4444'
            }
          },
          fontFamily: {
            sans: ['Inter', 'Noto Sans TC', 'sans-serif']
          },
          spacing: {
            '18': '4.5rem',
            '22': '5.5rem',
            '30': '7.5rem'
          }
        }
      }
    }
  </script>
  
  <style>
    /* Mobile-First 觸控優化樣式 */
    
    /* 觸控友好的輸入框 */
    .input-mobile {
      @apply h-14 px-4 py-3 text-lg rounded-xl border-2 border-secondary-200;
      @apply bg-white shadow-sm transition-all duration-300 ease-in-out;
      @apply focus:border-primary-500 focus:ring-4 focus:ring-primary-500/20;
      @apply hover:border-secondary-300;
      min-height: 3.5rem;
      touch-action: manipulation;
    }
    
    .input-highlighted {
      @apply bg-accent-highlight border-primary-400; /* Uses accent.highlight color */
      @apply ring-4 ring-primary-200/50;
    }
    
    .input-calculating {
      @apply border-primary-300 bg-primary-50/30;
    }
    
    /* 輸入框容器 */
    .input-container {
      @apply relative mb-3 touch-none;
    }
    
    /* 左側標籤與圖標 */
    .input-label {
      @apply flex items-center mb-2 text-base font-medium text-secondary-700;
    }
    
    .input-icon {
      @apply w-5 h-5 text-primary-500 mr-2 flex-shrink-0;
    }
    
    /* 右側單位後綴 */
    .input-suffix {
      @apply absolute right-3 top-1/2 transform -translate-y-1/2;
      @apply text-secondary-500 font-medium pointer-events-none text-base;
    }
    
    /* Loading Spinner */
    .input-spinner {
      @apply absolute right-10 top-1/2 transform -translate-y-1/2;
      @apply text-primary-500 opacity-0 transition-opacity duration-200;
    }
    
    .input-spinner.visible {
      @apply opacity-100;
    }
    
    /* 粘底操作列 */
    .sticky-actions {
      @apply fixed bottom-0 left-0 right-0 z-40;
      @apply bg-white border-t border-secondary-200 shadow-lg;
      @apply px-4 py-3 safe-area-inset-bottom;
    }
    
    /* 大觸控按鈕 */
    .btn-mobile {
      @apply h-12 px-6 text-base font-semibold rounded-xl;
      @apply transition-all duration-200 ease-out;
      @apply active:scale-95 focus:outline-none focus:ring-4;
      min-height: 3rem;
      touch-action: manipulation;
    }
    
    .btn-primary-mobile {
      @apply bg-gradient-to-r from-primary-500 to-primary-600;
      @apply text-white shadow-lg;
      @apply hover:from-primary-600 hover:to-primary-700;
      @apply focus:ring-primary-500/30;
    }
    
    .btn-secondary-mobile {
      @apply bg-secondary-400 text-white;
      @apply hover:bg-secondary-500;
      @apply focus:ring-secondary-400/30;
    }
    
    /* 彩蛋按鈕 - 移動版優化 */
    .easter-egg-mobile {
      @apply fixed top-4 right-4 z-50;
      @apply w-8 h-8 rounded-full;
      @apply bg-gradient-to-r from-pink-400 to-purple-500;
      @apply shadow-md opacity-60;
      @apply flex items-center justify-center;
      @apply transition-all duration-300 ease-out;
      @apply active:scale-90;
      touch-action: manipulation;
    }
    
    .easter-egg-mobile:active {
      @apply opacity-100 scale-110;
    }
    
    /* 全螢幕 Modal */
    .modal-fullscreen {
      @apply fixed inset-0 z-[100] flex items-center justify-center;
      @apply bg-black/50 backdrop-blur-sm;
      @apply opacity-0 pointer-events-none;
      @apply transition-all duration-300 ease-out;
    }
    
    .modal-fullscreen.active {
      @apply opacity-100 pointer-events-auto;
    }
    
    .modal-content-mobile {
      @apply bg-white rounded-2xl p-6 mx-4;
      @apply max-w-sm w-full max-h-[80vh] overflow-y-auto;
      @apply transform scale-95 transition-all duration-300 ease-out;
      @apply shadow-2xl;
    }
    
    .modal-fullscreen.active .modal-content-mobile {
      @apply scale-100;
    }
    
    /* 響應式網格 */
    .grid-mobile {
      @apply grid gap-3;
      @apply grid-cols-1;
    }
    
    /* 橫向時兩欄 */
    @media (orientation: landscape) and (max-height: 600px) {
      .grid-mobile {
        @apply grid-cols-2 gap-2;
      }
      
      .input-container {
        @apply mb-2;
      }
      
      .input-mobile {
        @apply h-12 text-base;
        min-height: 3rem;
      }
    }
    
    /* 平板以上螢幕優化 */
    @media (min-width: 768px) {
      .grid-mobile {
        @apply grid-cols-2 gap-4;
      }
      
      .sticky-actions {
        @apply relative border-t-0 shadow-none px-0 py-0;
        @apply bg-transparent;
      }
    }
    
    @media (min-width: 1024px) {
      .grid-mobile {
        @apply grid-cols-4; /* Adjusted for 8 items, 4 per row on large screens might be too wide, but following original logic. Consider 3 or 2 if needed. */
      }
    }
    
    /* 通知 Toast - 移動版 */
    .toast-mobile {
      @apply fixed top-4 left-4 right-4 z-50;
      @apply bg-white border border-secondary-200 rounded-xl shadow-xl;
      @apply p-4 transform -translate-y-full opacity-0;
      @apply transition-all duration-300 ease-out;
    }
    
    .toast-mobile.visible {
      @apply translate-y-0 opacity-100;
    }
    
    /* 無障礙焦點增強 */
    .focus-visible {
      @apply focus:outline-none;
    }
    
    /* 安全區域適配 */
    .safe-area-inset-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* 防止縮放 */
    .no-zoom {
      touch-action: manipulation;
    }
    
    /* 滾動優化 */
    .scroll-smooth {
      scroll-behavior: smooth;
    }
    
    /* 主內容區域 - 為粘底按鈕預留空間 */
    .main-content {
      @apply pb-20; /* Default padding for sticky actions */
    }
    
    @media (min-width: 768px) {
      .main-content {
        @apply pb-8; /* Reduced padding when actions are not sticky */
      }
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 font-sans no-zoom scroll-smooth">
  
  <header class="bg-white shadow-sm border-b border-secondary-100 sticky top-0 z-30">
    <div class="px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 bg-gradient-to-r from-primary-500 to-primary-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-ruler-combined text-white text-sm"></i>
          </div>
          <div>
            <h1 class="text-lg font-bold text-secondary-800">面積換算</h1>
            <p class="text-xs text-secondary-500">精準快速轉換</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content px-4 py-4">
    
    <div class="bg-primary-50 border border-primary-200 rounded-xl p-4 mb-4 shadow">
      <div class="flex items-start space-x-2">
        <i class="fas fa-info-circle text-primary-500 mt-0.5 text-sm"></i>
        <div class="text-sm">
          <p class="font-medium text-primary-800 mb-1">快速使用</p>
          <p class="text-primary-700">在下方任一欄位輸入數值，系統將自動為您換算其他單位。</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-secondary-100 p-4 mb-4">
      <form id="converter-form">
        
        <div class="grid-mobile" id="input-grid">
          
          <div class="input-container">
            <label for="sqm" class="input-label">
              <i class="fas fa-square input-icon"></i>
              平方公尺
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="sqm" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="平方公尺數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">㎡</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-sqm"></i>
            </div>
          </div>

          <div class="input-container">
            <label for="ping" class="input-label">
              <i class="fas fa-home input-icon"></i>
              坪
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="ping" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="坪數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">坪</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-ping"></i>
            </div>
          </div>

          <div class="input-container">
            <label for="hectare" class="input-label">
              <i class="fas fa-map input-icon"></i>
              公頃
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="hectare" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="公頃數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">ha</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-hectare"></i>
            </div>
          </div>

          <div class="input-container">
            <label for="jia" class="input-label">
              <i class="fas fa-seedling input-icon"></i>
              甲
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="jia" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="甲數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">甲</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-jia"></i>
            </div>
          </div>

          <div class="input-container">
            <label for="fen" class="input-label">
              <i class="fas fa-leaf input-icon"></i>
              分
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="fen" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="分數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">分</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-fen"></i>
            </div>
          </div>

          <div class="input-container">
            <label for="are" class="input-label">
              <i class="fas fa-chart-area input-icon"></i>
              公畝
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="are" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="公畝數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">a</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-are"></i>
            </div>
          </div>

          <div class="input-container">
            <label for="acre" class="input-label">
              <i class="fas fa-flag input-icon"></i>
              英畝
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="acre" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="英畝數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">acre</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-acre"></i>
            </div>
          </div>

          <div class="input-container">
            <label for="mu" class="input-label">
              <i class="fas fa-landmark input-icon"></i>
              市畝
            </label>
            <div class="relative">
              <input 
                type="number" 
                id="mu" 
                class="input-mobile w-full pr-16 focus-visible" 
                placeholder="0"
                step="any"
                inputmode="decimal"
                aria-label="市畝數值輸入"
                autocomplete="off"
              >
              <span class="input-suffix">市畝</span>
              <i class="fas fa-spinner fa-pulse input-spinner" id="spinner-mu"></i>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="bg-white rounded-xl border border-secondary-100 p-4 shadow">
      <details class="group">
        <summary class="cursor-pointer select-none">
          <div class="flex items-center justify-between">
            <h3 class="text-base font-semibold text-secondary-800 flex items-center">
              <i class="fas fa-book-open text-primary-500 mr-2"></i>
              使用說明與換算公式
            </h3>
            <i class="fas fa-chevron-down text-secondary-400 transform transition-transform duration-200 group-open:rotate-180"></i>
          </div>
        </summary>
        
        <div class="mt-4 pt-4 border-t border-secondary-100 space-y-4">
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 shadow-sm">
            <h4 class="text-md font-semibold text-blue-800 mb-2 flex items-center">
              <i class="fas fa-lightbulb text-blue-600 mr-2"></i>快速上手
            </h4>
            <ol class="text-sm text-blue-700 space-y-1.5 list-decimal list-inside pl-1">
              <li>在上方任一面積單位欄位中輸入數值。</li>
              <li>系統將即時自動為您換算並更新所有其他單位欄位。</li>
              <li>您目前正在輸入或最後修改的欄位會以<span class="font-semibold text-yellow-700 bg-yellow-200 px-1.5 py-0.5 rounded-md">黃色</span>標示。</li>
            </ol>
          </div>
        
          <div class="bg-green-50 border border-green-200 rounded-xl p-4 shadow-sm">
            <h4 class="text-md font-semibold text-green-800 mb-3 flex items-center">
              <i class="fas fa-calculator text-green-600 mr-2"></i>常用面積單位換算參考
            </h4>
            <div class="text-sm text-green-700 space-y-2">
              <div>
                <p class="font-medium text-green-800">平方公尺 (㎡) & 坪:</p>
                <ul class="list-disc list-inside pl-4 space-y-1 mt-1">
                  <li>1 平方公尺 (㎡) = 0.3025 坪</li>
                  <li>1 坪 = 3.3058 平方公尺 (㎡)</li>
                </ul>
              </div>
        
              <div class="pt-2 mt-2 border-t border-green-100">
                <p class="font-medium text-green-800">公頃 (ha):</p>
                <ul class="list-disc list-inside pl-4 space-y-1 mt-1">
                  <li>1 公頃 = 10,000 平方公尺 (㎡)</li>
                  <li>1 公頃 = 3,025 坪</li>
                  <li>1 公頃 = 100 公畝 (a)</li>
                  <li>1 公頃 = 1.0310 甲</li>
                </ul>
              </div>
              
              <div class="pt-2 mt-2 border-t border-green-100">
                <p class="font-medium text-green-800">甲:</p>
                <ul class="list-disc list-inside pl-4 space-y-1 mt-1">
                  <li>1 甲 (參考) = 0.9699 公頃 (ha)</li>
                  <li>1 甲 (參考) = 2,934 坪</li>
                  <li class="text-green-900 font-semibold">1 甲 (本工具定義) = 3305.785 平方公尺 (㎡)</li>
                </ul>
              </div>
        
              <div class="pt-2 mt-2 border-t border-green-100">
                <p class="font-medium text-green-800">分:</p>
                <ul class="list-disc list-inside pl-4 space-y-1 mt-1">
                  <li>1 分 (參考) = 0.0970 公頃 (ha)</li>
                  <li>1 分 (參考) = 293.4 坪</li>
                  <li class="text-green-900 font-semibold">1 分 (本工具定義) = 330.578 平方公尺 (㎡)</li>
                </ul>
              </div>
        
              <div class="pt-2 mt-2 border-t border-green-100">
                <p class="font-medium text-green-800">公畝 (a):</p>
                <ul class="list-disc list-inside pl-4 space-y-1 mt-1">
                  <li>1 公畝 = 100 平方公尺 (㎡)</li>
                  <li>1 公畝 = 30.25 坪</li>
                </ul>
              </div>
        
              <div class="pt-2 mt-2 border-t border-green-100">
                <p class="font-medium text-green-800">英畝 (acre):</p>
                <ul class="list-disc list-inside pl-4 space-y-1 mt-1">
                  <li>1 英畝 ≈ 4046.856 平方公尺 (㎡)</li>
                  <li>1 英畝 ≈ 1224.17 坪</li>
                </ul>
              </div>
        
              <div class="pt-2 mt-2 border-t border-green-100">
                <p class="font-medium text-green-800">市畝:</p>
                <ul class="list-disc list-inside pl-4 space-y-1 mt-1">
                  <li>1 市畝 ≈ 666.667 平方公尺 (㎡)</li> <li>1 市畝 ≈ 201.67 坪</li>
                </ul>
              </div>
            </div>
            <p class="text-xs text-green-600 mt-4 pt-3 border-t border-green-200">
              <i class="fas fa-info-circle mr-1"></i> 上述換算表部分數值 (標示為"參考") 可能因標準或地區而異。本工具的計算依據
              <a href="javascript:alert('本工具使用之換算係數 (以1單位轉換為平方公尺為基準):\n--------------------------------------------------\n平方公尺 (㎡): 1\n坪: 1 / 0.3025 ≈ 3.305785123966942\n公頃 (ha): 10000\n甲: 3305.785\n分: 330.578\n公畝 (a): 100\n英畝 (acre): 4046.8564224\n市畝: 666.6667\n--------------------------------------------------');" class="font-semibold underline hover:text-green-700">指定的轉換係數</a>。
            </p>
          </div>
          
          <div class="bg-red-50 border border-red-200 rounded-xl p-4 shadow-sm">
            <p class="text-sm text-red-700 flex items-start">
              <i class="fas fa-exclamation-triangle mr-2 mt-0.5 flex-shrink-0"></i>
              <span>本查詢系統換算結果僅供參考，實際地政資料請以各地政事務所登記為準。</span>
            </p>
          </div>
        </div>
      </details>
    </div>

  </main>

  <div class="sticky-actions">
    <div class="flex gap-3">
      <button 
        type="button" 
        id="clear-btn"
        class="btn-mobile btn-secondary-mobile flex-1 focus-visible"
        aria-label="清除所有輸入數值"
      >
        <i class="fas fa-eraser mr-2"></i>
        清除
      </button>
      
      <button 
        type="button" 
        id="copy-btn"
        class="btn-mobile btn-primary-mobile flex-1 focus-visible hidden"
        aria-label="複製換算結果"
      >
        <i class="fas fa-copy mr-2"></i>
        複製結果
      </button>
    </div>
  </div>

  <div class="easter-egg-mobile" id="easter-egg">
    <i class="fas fa-magic text-white text-xs"></i>
  </div>

  <div class="modal-fullscreen" id="easter-modal">
    <div class="modal-content-mobile">
      <div class="text-center">
        <div class="w-12 h-12 bg-gradient-to-r from-pink-400 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-rocket text-white text-lg"></i>
        </div>
        <h3 class="text-lg font-bold text-secondary-800 mb-2">🎉 發現隱藏功能！</h3>
        <p class="text-secondary-600 text-sm mb-4">你找到了我們的小秘密！這裡有個特別的面積知識：</p>
        
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-3 mb-4">
          <h4 class="font-semibold text-secondary-800 mb-2 text-sm">💡 有趣的面積比較</h4>
          <p class="text-xs text-secondary-700">
            台北101大樓的土地面積約為 <span class="font-bold text-primary-600">3,056 坪</span>，
            相當於 <span class="font-bold text-primary-600">10,100 ㎡</span>！
          </p>
        </div>
        
        <div class="flex gap-2">
          <button class="btn-mobile btn-primary-mobile text-sm flex-1" onclick="generateRandomConversion()">
            <i class="fas fa-dice mr-1"></i>
            隨機換算
          </button>
          <button class="btn-mobile btn-secondary-mobile text-sm flex-1" onclick="closeEasterEgg()">
            <i class="fas fa-times mr-1"></i>
            關閉
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast-mobile">
    <div class="flex items-center space-x-3">
      <div class="flex-shrink-0">
        <i id="toast-icon" class="fas fa-check-circle text-accent-success"></i>
      </div>
      <div class="flex-1">
        <p id="toast-message" class="text-sm font-medium text-secondary-800"></p>
      </div>
      <button onclick="hideToast()" class="flex-shrink-0 text-secondary-400">
        <i class="fas fa-times text-sm"></i>
      </button>
    </div>
  </div>

  <script>
    // ===== 核心變數與設定 =====
    
    // 換算係數 (以平方公尺為基準單位: 1 [unit] = X [sqm])
    const CONVERSION_FACTORS = {
      sqm: 1,                         // 1 平方公尺 = 1 ㎡
      ping: 1 / 0.3025,               // 1 坪 = (1 / 0.3025) ㎡ ≈ 3.305785123966942 ㎡ (derived from 1 ㎡ = 0.3025 坪)
      hectare: 10000,                 // 1 公頃 = 10000 ㎡
      jia: 3305.785,                  // 1 甲 = 3305.785 ㎡
      fen: 330.578,                   // 1 分 = 330.578 ㎡
      are: 100,                       // 1 公畝 = 100 ㎡
      acre: 4046.8564224,             // 1 英畝 = 4046.8564224 ㎡
      mu: 666.6667                    // 1 市畝 = 666.6667 ㎡ 
    };
    
    // 防抖設定
    const DEBOUNCE_DELAY = 300; // 300ms 防抖延遲
    
    // 全域狀態
    let currentActiveInput = null;
    let lastCalculatedValues = {};
    let debounceTimers = {};
    
    // ===== DOM 元素引用 =====
    const clearBtn = document.getElementById('clear-btn');
    const copyBtn = document.getElementById('copy-btn');
    const easterEgg = document.getElementById('easter-egg');
    const easterModal = document.getElementById('easter-modal');
    
    // 所有輸入欄位和對應的 Spinner
    const inputs = {
      sqm: document.getElementById('sqm'),
      ping: document.getElementById('ping'),
      hectare: document.getElementById('hectare'),
      jia: document.getElementById('jia'),
      fen: document.getElementById('fen'),
      are: document.getElementById('are'),
      acre: document.getElementById('acre'),
      mu: document.getElementById('mu')
    };
    
    const spinners = {
      sqm: document.getElementById('spinner-sqm'),
      ping: document.getElementById('spinner-ping'),
      hectare: document.getElementById('spinner-hectare'),
      jia: document.getElementById('spinner-jia'),
      fen: document.getElementById('spinner-fen'),
      are: document.getElementById('spinner-are'),
      acre: document.getElementById('spinner-acre'),
      mu: document.getElementById('spinner-mu')
    };

    // ===== 防抖即時計算邏輯 =====
    
    /**
     * 防抖函數
     * @param {Function} func - 要執行的函數
     * @param {number} delay - 延遲時間 (ms)
     * @param {string} key - 唯一鍵值用於管理多個計時器
     */
    function debounce(func, delay, key) {
      return function(...args) {
        if (debounceTimers[key]) {
          clearTimeout(debounceTimers[key]);
        }
        debounceTimers[key] = setTimeout(() => {
          func.apply(this, args);
          delete debounceTimers[key];
        }, delay);
      };
    }
    
    /**
     * 顯示計算中狀態
     * @param {string} sourceUnit - 來源單位
     */
    function showCalculating(sourceUnit) {
      spinners[sourceUnit].classList.add('visible');
      inputs[sourceUnit].classList.add('input-calculating');
    }
    
    /**
     * 隱藏計算中狀態
     * @param {string} sourceUnit - 來源單位
     */
    function hideCalculating(sourceUnit) {
      spinners[sourceUnit].classList.remove('visible');
      inputs[sourceUnit].classList.remove('input-calculating');
    }
    
    /**
     * 執行面積單位換算計算
     * @param {string} sourceUnit - 來源單位鍵值
     * @param {number} sourceValue - 來源數值
     */
    function calculateConversions(sourceUnit, sourceValue) {
      showCalculating(sourceUnit);
      
      if (sourceValue === null || sourceValue === undefined || sourceValue <= 0 || isNaN(sourceValue)) {
        // If input is cleared or invalid, clear all other fields silently except the source
        Object.keys(inputs).forEach(unit => {
            if (unit !== sourceUnit) {
                inputs[unit].removeEventListener('input', inputHandlers[unit]);
                inputs[unit].value = '';
                inputs[unit].addEventListener('input', inputHandlers[unit]);
            }
        });
        lastCalculatedValues = {};
        copyBtn.classList.add('hidden');
        hideCalculating(sourceUnit);
        return;
      }
      
      // Short delay to allow UI to update spinner, then calculate
      setTimeout(() => {
        try {
          const sqmValue = sourceValue * CONVERSION_FACTORS[sourceUnit];
          
          const results = {};
          Object.keys(CONVERSION_FACTORS).forEach(unit => {
            if (unit === sourceUnit) {
              results[unit] = sourceValue; 
            } else {
              results[unit] = sqmValue / CONVERSION_FACTORS[unit];
            }
          });
          
          Object.keys(results).forEach(unit => {
            if (unit !== sourceUnit) {
              // Display with a fixed number of decimal places
              const valToSet = parseFloat(results[unit].toFixed(6));
              inputs[unit].removeEventListener('input', inputHandlers[unit]);
              inputs[unit].value = (valToSet === 0 && results[unit] > 0) ? results[unit].toExponential(6) : (isNaN(valToSet) ? '' : valToSet);
              inputs[unit].addEventListener('input', inputHandlers[unit]);
            }
          });
          
          lastCalculatedValues = results;
          copyBtn.classList.remove('hidden');
          hideCalculating(sourceUnit);
          
        } catch (error) {
          console.error('計算錯誤:', error);
          hideCalculating(sourceUnit);
          showToast('計算出現錯誤，請重試', 'error');
        }
      }, 50); // Reduced calculation simulation delay
    }
    
    /**
     * 清除所有輸入欄位並重置狀態
     */
    function clearAllInputs() {
      Object.values(inputs).forEach(input => {
        input.value = '';
        input.classList.remove('input-highlighted', 'input-calculating');
      });
      
      Object.keys(debounceTimers).forEach(key => {
        clearTimeout(debounceTimers[key]);
        delete debounceTimers[key];
      });
      
      Object.values(spinners).forEach(spinner => spinner.classList.remove('visible'));
      
      currentActiveInput = null;
      lastCalculatedValues = {};
      copyBtn.classList.add('hidden');
      
      showToast('已清除所有數值', 'info');
      if (inputs.sqm) inputs.sqm.focus(); // Focus on the first input after clearing
    }
    
    /**
     * 複製換算結果到剪貼簿
     */
    async function copyResults() {
      if (Object.keys(lastCalculatedValues).length === 0 || !currentActiveInput) {
        showToast('沒有可複製的結果或未進行計算', 'warning');
        return;
      }
      
      const unitNames = {
        sqm: '平方公尺', ping: '坪', hectare: '公頃', jia: '甲',
        fen: '分', are: '公畝', acre: '英畝', mu: '市畝'
      };
      
      let resultText = `以 ${inputs[currentActiveInput].value} ${unitNames[currentActiveInput]} 為基準的換算結果:\n`;
      resultText += Object.entries(lastCalculatedValues)
        .map(([unit, value]) => {
          const formattedValue = parseFloat(value.toFixed(6));
          return `${unitNames[unit]}: ${formattedValue}`;
        })
        .join('\n');
      
      try {
        await navigator.clipboard.writeText(resultText);
        showToast('結果已複製！', 'success');
      } catch (err) {
        console.error('複製失敗:', err);
        showToast('複製失敗，瀏覽器可能不支援或未授予權限', 'error');
      }
    }

    // ===== 事件處理器設定 =====
    const inputHandlers = {};
    
    function setActiveInput(activeUnit) {
      Object.values(inputs).forEach(input => input.classList.remove('input-highlighted'));
      inputs[activeUnit].classList.add('input-highlighted');
      currentActiveInput = activeUnit;
    }
    
    Object.entries(inputs).forEach(([unit, inputElement]) => {
      const debouncedCalculate = debounce(calculateConversions, DEBOUNCE_DELAY, unit);
      
      const handler = (e) => {
        const valueStr = e.target.value;
        setActiveInput(unit);

        if (valueStr === '' || valueStr === null) {
            // If field is cleared, clear others via calculateConversions with a non-positive value
            debouncedCalculate(unit, 0); // Or null, depending on how calculateConversions handles it
            return;
        }

        const value = parseFloat(valueStr);
        
        if (!isNaN(value) && value >= 0) { // Allow 0 for clearing other fields or calculating from 0
          // Clear other fields immediately for responsiveness before debounced calculation
          Object.entries(inputs).forEach(([otherUnit, otherInput]) => {
            if (otherUnit !== unit) {
              otherInput.removeEventListener('input', inputHandlers[otherUnit]);
              otherInput.value = ''; // Clear visually
              otherInput.addEventListener('input', inputHandlers[otherUnit]);
            }
          });
          debouncedCalculate(unit, value);
        } else if (isNaN(value)) { // Handle non-numeric input if necessary, e.g. clear others
            Object.entries(inputs).forEach(([otherUnit, otherInput]) => {
                if (otherUnit !== unit) {
                    otherInput.removeEventListener('input', inputHandlers[otherUnit]);
                    otherInput.value = '';
                    otherInput.addEventListener('input', inputHandlers[otherUnit]);
                }
            });
            copyBtn.classList.add('hidden'); // Hide copy if input is invalid
        }
      };
      
      inputHandlers[unit] = handler;
      inputElement.addEventListener('input', handler);
      inputElement.addEventListener('focus', () => setActiveInput(unit));
      // Removed touchend listener for focus as it can interfere with native behavior. Standard focus should work.
    });
    
    clearBtn.addEventListener('click', clearAllInputs);
    copyBtn.addEventListener('click', copyResults);

    // ===== 移動版通知系統 =====
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const iconEl = document.getElementById('toast-icon'); // Renamed to avoid conflict
      const messageEl = document.getElementById('toast-message');
      
      const styles = {
        success: { iconClass: 'fa-check-circle', colorClass: 'text-accent-success' },
        error: { iconClass: 'fa-exclamation-circle', colorClass: 'text-accent-error' },
        warning: { iconClass: 'fa-exclamation-triangle', colorClass: 'text-accent-warning' },
        info: { iconClass: 'fa-info-circle', colorClass: 'text-primary-500' }
      };
      
      const style = styles[type] || styles.info;
      iconEl.className = `fas ${style.iconClass} ${style.colorClass}`;
      messageEl.textContent = message;
      
      toast.classList.add('visible');
      setTimeout(() => hideToast(), 3000);
    }
    
    function hideToast() {
      document.getElementById('toast').classList.remove('visible');
    }

    // ===== 彩蛋功能 =====
    let easterEggClicks = 0;
    let easterEggTimeout;
    
    easterEgg.addEventListener('click', (e) => {
      e.preventDefault();
      easterEggClicks++;
      clearTimeout(easterEggTimeout);
      if (easterEggClicks >= 3) {
        showEasterEgg();
        easterEggClicks = 0;
      } else {
        easterEggTimeout = setTimeout(() => easterEggClicks = 0, 1000);
      }
    });
    
    let keySequence = '';
    document.addEventListener('keydown', (e) => {
      if (document.activeElement && ['input', 'textarea'].includes(document.activeElement.tagName.toLowerCase())) return;
      keySequence += e.key.toLowerCase();
      if (keySequence.length > 4) keySequence = keySequence.slice(-4);
      if (keySequence === 'area') {
        showEasterEgg();
        keySequence = '';
      }
      if (e.key === 'Escape' && easterModal.classList.contains('active')) closeEasterEgg();
    });
    
    function showEasterEgg() {
      easterModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeEasterEgg() {
      easterModal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    function generateRandomConversion() {
      const unitsArray = Object.keys(inputs);
      const randomUnit = unitsArray[Math.floor(Math.random() * unitsArray.length)];
      const randomValue = parseFloat((Math.random() * (1000 - 1) + 1).toFixed(4)); // Random value between 1 and 1000
      
      clearAllInputs(); // Clear first
      
      inputs[randomUnit].value = randomValue;
      setActiveInput(randomUnit); // Set active before triggering calculation
      
      // Manually trigger the calculation for the specific input
      // This bypasses debounce for immediate effect in the easter egg
      calculateConversions(randomUnit, randomValue); 
      
      closeEasterEgg();
      showToast(`隨機換算: ${randomValue} ${inputs[randomUnit].labels[0].innerText.trim()}`, 'success');
    }
    
    easterModal.addEventListener('click', (e) => {
      if (e.target === easterModal) closeEasterEgg();
    });

    // ===== 移動裝置優化 =====
    let lastTouchEndPreventDoubleZoom = 0;
    document.addEventListener('touchend', function (event) {
      const now = Date.now();
      if (now - lastTouchEndPreventDoubleZoom <= 300) {
        event.preventDefault();
      }
      lastTouchEndPreventDoubleZoom = now;
    }, { passive: false }); // passive:false for preventDefault
    
    document.addEventListener('touchmove', function(e) {
      if (e.touches.length > 1 && document.body.classList.contains('no-zoom')) { // Only if no-zoom is active
        e.preventDefault();
      }
    }, { passive: false });
    
    window.addEventListener('orientationchange', () => {
      setTimeout(() => window.scrollTo(0,0) , 200); // Delay scroll to allow layout reflow
    });
    
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        Object.keys(debounceTimers).forEach(key => {
          clearTimeout(debounceTimers[key]);
          delete debounceTimers[key];
        });
      }
    });

    // ===== 初始化 =====
    document.addEventListener('DOMContentLoaded', () => {
      if (inputs.sqm) {
        inputs.sqm.focus();
        setActiveInput('sqm'); // Set sqm as active input by default
      }
      
      setTimeout(() => showToast('輸入數值即可自動換算面積', 'info'), 1000);
      
      if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        document.body.classList.add('touch-device');
      }
    });
    
  </script>

</body>
</html>
