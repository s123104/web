<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼å…”æ™ºé¬¥ - ç­–ç•¥å°æˆ°éŠæˆ²</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            touch-action: manipulation;
        }
        
        .game-title {
            margin: 10px 0;
            color: #333;
            text-align: center;
        }
        
        .game-container {
            width: 100%;
            max-width: 500px;
            height: 60vh;
            display: flex;
            flex-direction: column;
            perspective: 1000px;
            position: relative;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 100%;
            height: 100%;
            background-color: #d3c091;
            border: 3px solid #8b4513;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .cell {
            border: 1px solid #8b4513;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            position: relative;
        }
        
        .forest {
            background-color: #2f5233;
        }
        
        .pond {
            background-color: #3498db;
        }
        
        .mountain {
            background-color: #7f8c8d;
        }
        
        .carrot {
            color: #e67e22;
            font-size: 20px;
        }
        
        .meat {
            color: #c0392b;
            font-size: 20px;
        }
        
        .trap {
            color: #9b59b6;
            font-size: 18px;
        }
        
        .wolf {
            position: absolute;
            width: 80%;
            height: 80%;
            background-color: #333;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
        }
        
        .rabbit {
            position: absolute;
            width: 80%;
            height: 80%;
            background-color: #f5f5f5;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            z-index: 10;
        }
        
        .status-panel {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            padding: 10px;
            background-color: #e8e8e8;
            border: 3px solid #8b4513;
            margin-bottom: 10px;
        }
        
        .player-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 48%;
        }
        
        .wolf-status {
            background-color: #d5d5d5;
            padding: 5px;
            border-radius: 5px;
        }
        
        .rabbit-status {
            background-color: #d5d5d5;
            padding: 5px;
            border-radius: 5px;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 500px;
            margin-top: 10px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
        }
        
        .control-btn {
            width: 48%;
            padding: 10px 0;
            font-size: 16px;
            margin: 5px 0;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .wolf-btn {
            background-color: #333;
        }
        
        .rabbit-btn {
            background-color: #f39c12;
        }
        
        .action-btn {
            padding: 10px 0;
            font-size: 16px;
            margin: 5px 0;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .tutorial {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
            overflow-y: auto;
        }
        
        .tutorial h2 {
            margin-bottom: 20px;
        }
        
        .tutorial p {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .tutorial button {
            padding: 10px 20px;
            margin-top: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .game-over {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }
        
        .game-over h2 {
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .game-over p {
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .game-over button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .turn-indicator {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
            width: 100%;
            max-width: 500px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .resource-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .ability-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        @media (max-height: 700px) {
            .game-container {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <h1 class="game-title">ç‹¼å…”æ™ºé¬¥</h1>
    
    <div class="turn-indicator" id="turnIndicator">è¼ªåˆ° ç‹¼ç‹¼ è¡Œå‹•</div>
    
    <div class="status-panel">
        <div class="player-status wolf-status">
            <h3>ç‹¼ç‹¼</h3>
            <div class="resource-info">
                <span>èƒ½é‡: </span>
                <span id="wolfEnergy">3</span>
            </div>
            <div class="resource-info">
                <span>è‚‰: </span>
                <span id="wolfMeat">0</span>
            </div>
            <div class="ability-info">
                <span>é™·é˜±: </span>
                <span id="wolfTraps">2</span>
            </div>
            <div class="ability-info">
                <span>è¦–é‡: </span>
                <span id="wolfSight">2</span>
            </div>
        </div>
        <div class="player-status rabbit-status">
            <h3>å…”å…”</h3>
            <div class="resource-info">
                <span>èƒ½é‡: </span>
                <span id="rabbitEnergy">3</span>
            </div>
            <div class="resource-info">
                <span>èƒ¡è˜¿è””: </span>
                <span id="rabbitCarrots">0</span>
            </div>
            <div class="ability-info">
                <span>éš±å½¢: </span>
                <span id="rabbitInvisible">3</span>
            </div>
            <div class="ability-info">
                <span>æ´ç©´: </span>
                <span id="rabbitBurrows">1</span>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-board" id="gameBoard"></div>
    </div>
    
    <div class="controls">
        <div class="control-row">
            <button class="control-btn wolf-btn" id="wolfMove">ç‹¼ç‹¼ç§»å‹•</button>
            <button class="control-btn rabbit-btn" id="rabbitMove">å…”å…”ç§»å‹•</button>
        </div>
        <div class="control-row">
            <button class="control-btn wolf-btn" id="wolfTrap">è¨­ç½®é™·é˜±</button>
            <button class="control-btn rabbit-btn" id="rabbitBurrow">æŒ–æ˜æ´ç©´</button>
        </div>
        <div class="control-row">
            <button class="control-btn wolf-btn" id="wolfSense">å¢å¼·è¦–é‡</button>
            <button class="control-btn rabbit-btn" id="rabbitInvisible">éš±å½¢</button>
        </div>
        <button class="action-btn" id="endTurn">çµæŸå›åˆ</button>
    </div>
    
    <div class="tutorial" id="tutorial">
        <h2>éŠæˆ²è¦å‰‡</h2>
        <p><strong>éŠæˆ²ç›®æ¨™:</strong></p>
        <p>- ç‹¼ç‹¼: æ•æ‰å…”å…”æˆ–æ”¶é›†5å¡Šè‚‰</p>
        <p>- å…”å…”: æ”¶é›†8å€‹èƒ¡è˜¿è””æˆ–åœ¨20å›åˆå…§ä¸è¢«æ•æ‰</p>
        
        <p><strong>å›åˆåˆ¶:</strong></p>
        <p>- æ¯å›åˆé›™æ–¹å„æœ‰ä¸€æ¬¡è¡Œå‹•æ©Ÿæœƒ</p>
        <p>- è¡Œå‹•åŒ…æ‹¬ç§»å‹•æˆ–ä½¿ç”¨ç‰¹æ®Šèƒ½åŠ›</p>
        
        <p><strong>ç‹¼ç‹¼èƒ½åŠ›:</strong></p>
        <p>- è¨­ç½®é™·é˜±: åœ¨ç›¸é„°æ ¼å­æ”¾ç½®é™·é˜±ï¼Œå…”å…”è¸©ä¸­å°‡è¢«å®šèº«ä¸€å›åˆ</p>
        <p>- å¢å¼·è¦–é‡: æš«æ™‚çœ‹åˆ°æ›´é çš„è·é›¢ï¼Œå¯åœ¨é»‘æš—å€åŸŸé¡¯ç¤ºå…”å…”</p>
        
        <p><strong>å…”å…”èƒ½åŠ›:</strong></p>
        <p>- æŒ–æ˜æ´ç©´: å‰µå»ºå¯ä»¥åœ¨ä¸‹ä¸€å›åˆè·³èºçš„é€šé“</p>
        <p>- éš±å½¢: åœ¨ä¸€å›åˆå…§ä¸è¢«ç‹¼ç‹¼çœ‹åˆ°</p>
        
        <p><strong>åœ°å½¢:</strong></p>
        <p>- æ£®æ—: å…”å…”å¯ä»¥éš±è—ï¼Œç‹¼ç‹¼éœ€è¦å¢å¼·è¦–é‡æ‰èƒ½çœ‹åˆ°</p>
        <p>- å±±è„ˆ: ç„¡æ³•é€šéçš„éšœç¤™ç‰©</p>
        <p>- æ± å¡˜: å…”å…”å¯ä»¥é€šéï¼Œç‹¼ç‹¼ä¸è¡Œ</p>
        
        <p><strong>è³‡æº:</strong></p>
        <p>- è‚‰: ç‹¼ç‹¼æ”¶é›†ï¼Œæ¯å€‹æä¾›1èƒ½é‡</p>
        <p>- èƒ¡è˜¿è””: å…”å…”æ”¶é›†ï¼Œæ¯å€‹æä¾›1èƒ½é‡</p>
        
        <p><strong>è¦–é‡:</strong></p>
        <p>- ç‹¼ç‹¼åªèƒ½çœ‹åˆ°é™„è¿‘çš„å…”å…”ï¼Œé™¤éä½¿ç”¨å¢å¼·è¦–é‡</p>
        <p>- å…”å…”èƒ½çœ‹åˆ°å…¨åœ–ï¼Œä½†ç„¡æ³•çœ‹åˆ°éš±è—çš„é™·é˜±</p>
        
        <button id="startGame">é–‹å§‹éŠæˆ²</button>
    </div>
    
    <div class="game-over" id="gameOver">
        <h2 id="winnerText">éŠæˆ²çµæŸ</h2>
        <p id="resultText">çµæœè©³æƒ…</p>
        <button id="restartGame">é‡æ–°é–‹å§‹</button>
    </div>

    <script>
        // éŠæˆ²ç‹€æ…‹
        const gameState = {
            turn: 'wolf', // 'wolf' æˆ– 'rabbit'
            round: 1,
            maxRounds: 20,
            activeAction: null,
            wolfPosition: { x: 0, y: 0 },
            rabbitPosition: { x: 7, y: 7 },
            wolfEnergy: 3,
            rabbitEnergy: 3,
            wolfMeat: 0,
            rabbitCarrots: 0,
            wolfTraps: 2,
            rabbitBurrows: 1,
            wolfSight: 2,
            rabbitInvisible: 3,
            isRabbitInvisible: false,
            traps: [],
            burrows: [],
            resources: [],
            terrain: [],
            rabbitTrapped: false,
            wolfHasEnhancedVision: false
        };
        
        // éŠæˆ²æ¿å…ƒç´ 
        const gameBoard = document.getElementById('gameBoard');
        
        // éŠæˆ²æ§åˆ¶æŒ‰éˆ•
        const wolfMoveBtn = document.getElementById('wolfMove');
        const rabbitMoveBtn = document.getElementById('rabbitMove');
        const wolfTrapBtn = document.getElementById('wolfTrap');
        const rabbitBurrowBtn = document.getElementById('rabbitBurrow');
        const wolfSenseBtn = document.getElementById('wolfSense');
        const rabbitInvisibleBtn = document.getElementById('rabbitInvisible');
        const endTurnBtn = document.getElementById('endTurn');
        
        // æ•™å­¸å’ŒéŠæˆ²çµæŸå…ƒç´ 
        const tutorial = document.getElementById('tutorial');
        const startGameBtn = document.getElementById('startGame');
        const gameOver = document.getElementById('gameOver');
        const winnerText = document.getElementById('winnerText');
        const resultText = document.getElementById('resultText');
        const restartGameBtn = document.getElementById('restartGame');
        const turnIndicator = document.getElementById('turnIndicator');
        
        // è³‡æºé¡¯ç¤ºå…ƒç´ 
        const wolfEnergyText = document.getElementById('wolfEnergy');
        const rabbitEnergyText = document.getElementById('rabbitEnergy');
        const wolfMeatText = document.getElementById('wolfMeat');
        const rabbitCarrotsText = document.getElementById('rabbitCarrots');
        const wolfTrapsText = document.getElementById('wolfTraps');
        const rabbitBurrowsText = document.getElementById('rabbitBurrows');
        const wolfSightText = document.getElementById('wolfSight');
        const rabbitInvisibleText = document.getElementById('rabbitInvisible');
        
        // åˆå§‹åŒ–éŠæˆ²æ¿
        function initializeGameBoard() {
            gameBoard.innerHTML = '';
            
            // ç”Ÿæˆåœ°å½¢
            gameState.terrain = generateTerrain();
            
            // ç”Ÿæˆè³‡æº
            gameState.resources = generateResources();
            
            // å‰µå»ºéŠæˆ²æ ¼å­
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // è¨­ç½®åœ°å½¢
                    const terrainType = gameState.terrain.find(t => t.x === x && t.y === y);
                    if (terrainType) {
                        cell.classList.add(terrainType.type);
                        
                        if (terrainType.type === 'mountain') {
                            cell.innerHTML = 'â›°ï¸';
                        } else if (terrainType.type === 'forest') {
                            cell.innerHTML = 'ğŸŒ²';
                        } else if (terrainType.type === 'pond') {
                            cell.innerHTML = 'ğŸ’§';
                        }
                    }
                    
                    // è¨­ç½®è³‡æº
                    const resource = gameState.resources.find(r => r.x === x && r.y === y);
                    if (resource) {
                        const resourceSpan = document.createElement('span');
                        if (resource.type === 'carrot') {
                            resourceSpan.className = 'carrot';
                            resourceSpan.textContent = 'ğŸ¥•';
                        } else {
                            resourceSpan.className = 'meat';
                            resourceSpan.textContent = 'ğŸ–';
                        }
                        cell.appendChild(resourceSpan);
                    }
                    
                    cell.addEventListener('click', handleCellClick);
                    gameBoard.appendChild(cell);
                }
            }
            
            // æ”¾ç½®è§’è‰²
            placeCharacters();
        }
        
        // ç”Ÿæˆåœ°å½¢
        function generateTerrain() {
            const terrain = [];
            
            // å±±è„ˆ - ç„¡æ³•é€šé
            terrain.push({ x: 3, y: 3, type: 'mountain' });
            terrain.push({ x: 3, y: 4, type: 'mountain' });
            terrain.push({ x: 4, y: 3, type: 'mountain' });
            terrain.push({ x: 6, y: 1, type: 'mountain' });
            terrain.push({ x: 1, y: 6, type: 'mountain' });
            
            // æ£®æ— - å…”å­å¯éš±è—
            terrain.push({ x: 1, y: 1, type: 'forest' });
            terrain.push({ x: 1, y: 2, type: 'forest' });
            terrain.push({ x: 2, y: 1, type: 'forest' });
            terrain.push({ x: 2, y: 2, type: 'forest' });
            terrain.push({ x: 5, y: 5, type: 'forest' });
            terrain.push({ x: 5, y: 6, type: 'forest' });
            terrain.push({ x: 6, y: 5, type: 'forest' });
            
            // æ± å¡˜ - å…”å­å¯é€šéï¼Œç‹¼ä¸è¡Œ
            terrain.push({ x: 2, y: 5, type: 'pond' });
            terrain.push({ x: 3, y: 5, type: 'pond' });
            terrain.push({ x: 5, y: 2, type: 'pond' });
            
            return terrain;
        }
        
        // ç”Ÿæˆè³‡æº
        function generateResources() {
            const resources = [];
            
            // èƒ¡è˜¿è”” - å…”å­æ”¶é›†
            resources.push({ x: 2, y: 3, type: 'carrot' });
            resources.push({ x: 4, y: 1, type: 'carrot' });
            resources.push({ x: 5, y: 4, type: 'carrot' });
            resources.push({ x: 6, y: 6, type: 'carrot' });
            resources.push({ x: 1, y: 4, type: 'carrot' });
            resources.push({ x: 3, y: 6, type: 'carrot' });
            resources.push({ x: 4, y: 5, type: 'carrot' });
            resources.push({ x: 7, y: 2, type: 'carrot' });
            
            // è‚‰ - ç‹¼æ”¶é›†
            resources.push({ x: 4, y: 2, type: 'meat' });
            resources.push({ x: 6, y: 3, type: 'meat' });
            resources.push({ x: 1, y: 5, type: 'meat' });
            resources.push({ x: 3, y: 1, type: 'meat' });
            resources.push({ x: 5, y: 3, type: 'meat' });
            
            return resources;
        }
        
        // æ”¾ç½®è§’è‰²
        function placeCharacters() {
            const wolfCell = document.querySelector(`.cell[data-x="${gameState.wolfPosition.x}"][data-y="${gameState.wolfPosition.y}"]`);
            const wolf = document.createElement('div');
            wolf.className = 'wolf';
            wolf.textContent = 'ğŸº';
            wolfCell.appendChild(wolf);
            
            const rabbitCell = document.querySelector(`.cell[data-x="${gameState.rabbitPosition.x}"][data-y="${gameState.rabbitPosition.y}"]`);
            const rabbit = document.createElement('div');
            rabbit.className = 'rabbit';
            rabbit.textContent = 'ğŸ°';
            rabbitCell.appendChild(rabbit);
        }
        
        // è™•ç†æ ¼å­é»æ“Š
        function handleCellClick(e) {
            const x = parseInt(e.currentTarget.dataset.x);
            const y = parseInt(e.currentTarget.dataset.y);
            
            if (gameState.activeAction === 'wolfMove') {
                moveWolf(x, y);
            } else if (gameState.activeAction === 'rabbitMove') {
                moveRabbit(x, y);
            } else if (gameState.activeAction === 'wolfTrap') {
                placeWolfTrap(x, y);
            } else if (gameState.activeAction === 'rabbitBurrow') {
                placeRabbitBurrow(x, y);
            }
        }
        
        // ç‹¼ç§»å‹•
        function moveWolf(x, y) {
            if (!isValidWolfMove(x, y)) {
                alert('ä¸åˆæ³•çš„ç§»å‹•ï¼');
                return;
            }
            
            // ç§»é™¤åŸå…ˆä½ç½®çš„ç‹¼
            const oldWolfCell = document.querySelector(`.cell[data-x="${gameState.wolfPosition.x}"][data-y="${gameState.wolfPosition.y}"]`);
            const wolf = oldWolfCell.querySelector('.wolf');
            if (wolf) {
                oldWolfCell.removeChild(wolf);
            }
            
            // æ›´æ–°ç‹¼çš„ä½ç½®
            gameState.wolfPosition = { x, y };
            
            // åœ¨æ–°ä½ç½®æ”¾ç½®ç‹¼
            const newWolfCell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            const newWolf = document.createElement('div');
            newWolf.className = 'wolf';
            newWolf.textContent = 'ğŸº';
            newWolfCell.appendChild(newWolf);
            
            // æª¢æŸ¥æ˜¯å¦æ•æ‰åˆ°å…”å­
            if (x === gameState.rabbitPosition.x && y === gameState.rabbitPosition.y && !gameState.isRabbitInvisible) {
                endGame('wolf', 'ç‹¼ç‹¼æ•æ‰åˆ°äº†å…”å…”ï¼');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è‚‰
            const resourceIndex = gameState.resources.findIndex(r => r.x === x && r.y === y && r.type === 'meat');
            if (resourceIndex !== -1) {
                gameState.wolfMeat++;
                wolfMeatText.textContent = gameState.wolfMeat;
                gameState.resources.splice(resourceIndex, 1);
                
                // ç§»é™¤è‚‰å…ƒç´ 
                const meatElement = newWolfCell.querySelector('.meat');
                if (meatElement) {
                    newWolfCell.removeChild(meatElement);
                }
                
                // ç‹¼ç‹¼å‹åˆ©åˆ¤æ–·
                if (gameState.wolfMeat >= 5) {
                    endGame('wolf', 'ç‹¼ç‹¼æ”¶é›†äº†è¶³å¤ çš„è‚‰ï¼');
                    return;
                }
            }
            
            gameState.activeAction = null;
            resetActionButtons();
            
            // æ›´æ–°èƒ½é‡
            gameState.wolfEnergy--;
            wolfEnergyText.textContent = gameState.wolfEnergy;
            
            checkTurnEnd();
        }
        
        // å…”å­ç§»å‹•
        function moveRabbit(x, y) {
            if (gameState.rabbitTrapped) {
                alert('å…”å…”è¢«é™·é˜±å›°ä½ï¼Œæš«æ™‚ç„¡æ³•ç§»å‹•ï¼');
                return;
            }
            
            if (!isValidRabbitMove(x, y)) {
                alert('ä¸åˆæ³•çš„ç§»å‹•ï¼');
                return;
            }
            
            // ç§»é™¤åŸå…ˆä½ç½®çš„å…”å­
            const oldRabbitCell = document.querySelector(`.cell[data-x="${gameState.rabbitPosition.x}"][data-y="${gameState.rabbitPosition.y}"]`);
            const rabbit = oldRabbitCell.querySelector('.rabbit');
            if (rabbit) {
                oldRabbitCell.removeChild(rabbit);
            }
            
            // æ›´æ–°å…”å­çš„ä½ç½®
            gameState.rabbitPosition = { x, y };
            
            // åœ¨æ–°ä½ç½®æ”¾ç½®å…”å­
            const newRabbitCell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            const newRabbit = document.createElement('div');
            newRabbit.className = 'rabbit';
            newRabbit.textContent = 'ğŸ°';
            newRabbitCell.appendChild(newRabbit);
            
            // è¸©åˆ°é™·é˜±ï¼Ÿ
            const trapIndex = gameState.traps.findIndex(t => t.x === x && t.y === y);
            if (trapIndex !== -1) {
                gameState.rabbitTrapped = true;
                gameState.traps.splice(trapIndex, 1);
                alert('å…”å…”è¸©åˆ°äº†é™·é˜±ï¼Œå°‡ç„¡æ³•è¡Œå‹•ä¸€å›åˆï¼');
                
                // ç§»é™¤é™·é˜±
                const trapElement = newRabbitCell.querySelector('.trap');
                if (trapElement) {
                    newRabbitCell.removeChild(trapElement);
                }
            }
            
            // æ‹¿åˆ°èƒ¡è˜¿è””ï¼Ÿ
            const resourceIndex = gameState.resources.findIndex(r => r.x === x && r.y === y && r.type === 'carrot');
            if (resourceIndex !== -1) {
                gameState.rabbitCarrots++;
                rabbitCarrotsText.textContent = gameState.rabbitCarrots;
                gameState.resources.splice(resourceIndex, 1);
                
                // ç§»é™¤èƒ¡è˜¿è””
                const carrotElement = newRabbitCell.querySelector('.carrot');
                if (carrotElement) {
                    newRabbitCell.removeChild(carrotElement);
                }
                
                // å…”å…”å‹åˆ©åˆ¤æ–·
                if (gameState.rabbitCarrots >= 8) {
                    endGame('rabbit', 'å…”å…”æ”¶é›†äº†è¶³å¤ çš„èƒ¡è˜¿è””ï¼');
                    return;
                }
            }
            
            // åŒæ ¼é‡åˆ°ç‹¼
            if (x === gameState.wolfPosition.x && y === gameState.wolfPosition.y && !gameState.isRabbitInvisible) {
                endGame('wolf', 'ç‹¼ç‹¼æ•æ‰åˆ°äº†å…”å…”ï¼');
                return;
            }
            
            gameState.activeAction = null;
            resetActionButtons();
            
            // æ›´æ–°èƒ½é‡
            gameState.rabbitEnergy--;
            rabbitEnergyText.textContent = gameState.rabbitEnergy;
            
            checkTurnEnd();
        }
        
        // ç‹¼è¨­ç½®é™·é˜±
        function placeWolfTrap(x, y) {
            if (gameState.wolfTraps <= 0) {
                alert('æ²’æœ‰é™·é˜±å¯ç”¨å•¦ï¼');
                return;
            }
            
            // å¿…é ˆæ˜¯é„°è¿‘æ ¼
            if (!isAdjacentToWolf(x, y) || isTerrain(x, y, 'mountain') || isTerrain(x, y, 'pond')) {
                alert('ç„¡æ³•åœ¨é€™è£¡è¨­ç½®é™·é˜±ï¼');
                return;
            }
            
            if (gameState.traps.some(t => t.x === x && t.y === y)) {
                alert('é€™è£¡å·²ç¶“æœ‰é™·é˜±äº†ï¼');
                return;
            }
            
            // æ”¾é™·é˜±
            gameState.traps.push({ x, y });
            gameState.wolfTraps--;
            wolfTrapsText.textContent = gameState.wolfTraps;
            
            // é¡¯ç¤ºé™·é˜±ï¼ˆå°ç‹¼å¯è¦‹ï¼‰
            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            const trapSpan = document.createElement('span');
            trapSpan.className = 'trap';
            trapSpan.textContent = 'ğŸ”’';
            cell.appendChild(trapSpan);
            
            gameState.activeAction = null;
            resetActionButtons();
            
            // æ¶ˆè€—èƒ½é‡
            gameState.wolfEnergy--;
            wolfEnergyText.textContent = gameState.wolfEnergy;
            
            checkTurnEnd();
        }
        
        // å…”å…”æŒ–æ´
        function placeRabbitBurrow(x, y) {
            if (gameState.rabbitBurrows <= 0) {
                alert('æ²’æœ‰æ´ç©´å¯æŒ–äº†ï¼');
                return;
            }
            
            // å¿…é ˆç›¸é„°
            if (!isAdjacentToRabbit(x, y) || isTerrain(x, y, 'mountain') || isTerrain(x, y, 'pond')) {
                alert('ç„¡æ³•åœ¨é€™è£¡æŒ–æ´ï¼');
                return;
            }
            
            if (gameState.burrows.some(b => b.x === x && b.y === y)) {
                alert('é€™è£¡å·²ç¶“æœ‰æ´ç©´äº†ï¼');
                return;
            }
            
            gameState.burrows.push({ x, y });
            gameState.rabbitBurrows--;
            rabbitBurrowsText.textContent = gameState.rabbitBurrows;
            
            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            const burrowSpan = document.createElement('span');
            burrowSpan.className = 'trap'; // ç”¨trapçš„classåªæ˜¯ç‚ºäº†å·æ‡¶é¡¯ç¤ºï¼Œå¯¦éš›å¯æ”¹æˆburrow
            burrowSpan.textContent = 'ğŸ‡';
            cell.appendChild(burrowSpan);
            
            gameState.activeAction = null;
            resetActionButtons();
            
            // æ¶ˆè€—èƒ½é‡
            gameState.rabbitEnergy--;
            rabbitEnergyText.textContent = gameState.rabbitEnergy;
            
            checkTurnEnd();
        }
        
        // ç‹¼å¢å¼·è¦–é‡
        wolfSenseBtn.addEventListener('click', () => {
            if (gameState.turn !== 'wolf') return;
            if (gameState.wolfEnergy <= 0) {
                alert('èƒ½é‡ä¸è¶³ï¼Œç„¡æ³•å¢å¼·è¦–é‡ï¼');
                return;
            }
            gameState.wolfHasEnhancedVision = true;
            gameState.wolfSight = 4;
            wolfSightText.textContent = gameState.wolfSight;
            
            // ç‹¼ç”¨äº†å¢å¼·è¦–é‡å¾Œï¼Œæ¶ˆè€—èƒ½é‡
            gameState.wolfEnergy--;
            wolfEnergyText.textContent = gameState.wolfEnergy;
            
            // é€™å›åˆå°±ç®—ç”¨å®Œè¡Œå‹•
            checkTurnEnd();
        });
        
        // å…”å…”éš±å½¢
        rabbitInvisibleBtn.addEventListener('click', () => {
            if (gameState.turn !== 'rabbit') return;
            if (gameState.rabbitInvisible <= 0) {
                alert('éš±å½¢æ¬¡æ•¸ä¸è¶³ï¼');
                return;
            }
            if (gameState.rabbitEnergy <= 0) {
                alert('èƒ½é‡ä¸è¶³ï¼Œç„¡æ³•éš±å½¢ï¼');
                return;
            }
            
            gameState.isRabbitInvisible = true;
            gameState.rabbitInvisible--;
            rabbitInvisibleText.textContent = gameState.rabbitInvisible;
            
            // æ¶ˆè€—èƒ½é‡
            gameState.rabbitEnergy--;
            rabbitEnergyText.textContent = gameState.rabbitEnergy;
            
            checkTurnEnd();
        });
        
        // çµæŸå›åˆ
        endTurnBtn.addEventListener('click', () => {
            if (gameState.turn === 'wolf') {
                gameState.turn = 'rabbit';
                turnIndicator.textContent = 'è¼ªåˆ° å…”å…” è¡Œå‹•';
            } else {
                gameState.turn = 'wolf';
                turnIndicator.textContent = 'è¼ªåˆ° ç‹¼ç‹¼ è¡Œå‹•';
                gameState.round++;
            }
            
            // å¦‚æœå…”å…”éš±å½¢ï¼ŒåªæŒçºŒä¸€å›åˆ
            if (gameState.turn === 'wolf' && gameState.isRabbitInvisible) {
                gameState.isRabbitInvisible = false;
            }
            
            // å¦‚æœå…”å…”è¢«é™·é˜±å›°ä½ï¼Œåªå›°ä¸€å›åˆ
            if (gameState.turn === 'wolf' && gameState.rabbitTrapped) {
                gameState.rabbitTrapped = false;
            }
            
            // ç‹¼å¢å¼·è¦–é‡åªæŒçºŒä¸€å€‹å°æ‰‹å›åˆ
            if (gameState.turn === 'rabbit' && gameState.wolfHasEnhancedVision) {
                gameState.wolfHasEnhancedVision = false;
                gameState.wolfSight = 2;
                wolfSightText.textContent = 2;
            }
            
            checkRoundLimit();
            resetActionButtons();
        });
        
        // é–‹å§‹éŠæˆ²
        startGameBtn.addEventListener('click', () => {
            tutorial.style.display = 'none';
            initializeGameBoard();
        });
        
        // é‡æ–°é–‹å§‹
        restartGameBtn.addEventListener('click', () => {
            location.reload();
        });
        
        // ç‹¼ç§»å‹•æŒ‰éˆ•
        wolfMoveBtn.addEventListener('click', () => {
            if (gameState.turn === 'wolf' && gameState.wolfEnergy > 0) {
                gameState.activeAction = 'wolfMove';
            }
        });
        
        // å…”å­ç§»å‹•æŒ‰éˆ•
        rabbitMoveBtn.addEventListener('click', () => {
            if (gameState.turn === 'rabbit' && gameState.rabbitEnergy > 0) {
                gameState.activeAction = 'rabbitMove';
            }
        });
        
        // ç‹¼è¨­é™·é˜±æŒ‰éˆ•
        wolfTrapBtn.addEventListener('click', () => {
            if (gameState.turn === 'wolf' && gameState.wolfEnergy > 0) {
                gameState.activeAction = 'wolfTrap';
            }
        });
        
        // å…”å­æŒ–æ´æŒ‰éˆ•
        rabbitBurrowBtn.addEventListener('click', () => {
            if (gameState.turn === 'rabbit' && gameState.rabbitEnergy > 0) {
                gameState.activeAction = 'rabbitBurrow';
            }
        });
        
        // é©—è­‰ç‹¼çš„ç§»å‹•(ä¸€æ­¥è·é›¢+ä¸èƒ½èµ°æ± å¡˜æˆ–å±±)
        function isValidWolfMove(x, y) {
            const dx = Math.abs(x - gameState.wolfPosition.x);
            const dy = Math.abs(y - gameState.wolfPosition.y);
            if (dx + dy !== 1) return false; 
            if (isTerrain(x, y, 'mountain') || isTerrain(x, y, 'pond')) return false;
            return true;
        }
        
        // é©—è­‰å…”å­çš„ç§»å‹•(ä¸€æ­¥è·é›¢+èƒ½éæ± å¡˜ä½†ä¸èƒ½éå±±)
        function isValidRabbitMove(x, y) {
            const dx = Math.abs(x - gameState.rabbitPosition.x);
            const dy = Math.abs(y - gameState.rabbitPosition.y);
            if (dx + dy !== 1) return false; 
            if (isTerrain(x, y, 'mountain')) return false;
            return true;
        }
        
        // æ˜¯å¦ç‚ºç‰¹å®šåœ°å½¢
        function isTerrain(x, y, type) {
            return gameState.terrain.some(t => t.x === x && t.y === y && t.type === type);
        }
        
        // æ˜¯å¦ç›¸é„°ç‹¼
        function isAdjacentToWolf(x, y) {
            const dx = Math.abs(x - gameState.wolfPosition.x);
            const dy = Math.abs(y - gameState.wolfPosition.y);
            return (dx + dy === 1);
        }
        
        // æ˜¯å¦ç›¸é„°å…”å­
        function isAdjacentToRabbit(x, y) {
            const dx = Math.abs(x - gameState.rabbitPosition.x);
            const dy = Math.abs(y - gameState.rabbitPosition.y);
            return (dx + dy === 1);
        }
        
        // é‡ç½®å‹•ä½œæŒ‰éˆ•ç‹€æ…‹
        function resetActionButtons() {
            wolfMoveBtn.disabled = (gameState.turn !== 'wolf' || gameState.wolfEnergy <= 0);
            wolfTrapBtn.disabled = (gameState.turn !== 'wolf' || gameState.wolfEnergy <= 0);
            wolfSenseBtn.disabled = (gameState.turn !== 'wolf' || gameState.wolfEnergy <= 0);
            
            rabbitMoveBtn.disabled = (gameState.turn !== 'rabbit' || gameState.rabbitEnergy <= 0);
            rabbitBurrowBtn.disabled = (gameState.turn !== 'rabbit' || gameState.rabbitEnergy <= 0);
            rabbitInvisibleBtn.disabled = (gameState.turn !== 'rabbit' || gameState.rabbitEnergy <= 0 || gameState.rabbitInvisible <= 0);
        }
        
        // æª¢æŸ¥æ˜¯å¦è¦åˆ‡æ›å›åˆ
        function checkTurnEnd() {
            // å¦‚æœèƒ½é‡ç”¨å®Œï¼Œç›´æ¥çµæŸå›åˆ
            if (gameState.turn === 'wolf' && gameState.wolfEnergy <= 0) {
                endTurnBtn.click();
            } else if (gameState.turn === 'rabbit' && gameState.rabbitEnergy <= 0) {
                endTurnBtn.click();
            }
        }
        
        // æª¢æŸ¥å›åˆé™åˆ¶
        function checkRoundLimit() {
            if (gameState.round > gameState.maxRounds) {
                endGame('rabbit', 'å·²é”åˆ°20å›åˆï¼Œå…”å…”æˆåŠŸæ’éäº†ï¼');
            }
        }
        
        // éŠæˆ²çµæŸ
        function endGame(winner, reason) {
            gameOver.style.display = 'flex';
            if (winner === 'wolf') {
                winnerText.textContent = 'ç‹¼ç‹¼ç²å‹ï¼';
            } else {
                winnerText.textContent = 'å…”å…”ç²å‹ï¼';
            }
            resultText.textContent = reason;
        }
        
        // é è¨­å…ˆé¡¯ç¤ºæ•™å­¸
        tutorial.style.display = 'flex';
    </script>
</body>
</html>