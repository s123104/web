<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>å¯æ„›å…”å…”æ’ç­è¡¨</title>
    <link
      rel="icon"
      href="https://s123104.github.io/az.tool/img/magician-hat.png"
    />
    <style>
      /* åŸºæœ¬æ¨£å¼ */
      body,
      html {
        font-family: "Arial", sans-serif;
        background-color: #fff0f5;
        color: #ff69b4;
        margin: 0;
        padding: 0;
        font-size: 12px;
        height: 100%;
      }

      /* å®¹å™¨èˆ‡ä½ˆå±€ */
      .calendar-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #ffebee;
      }

      .header {
        text-align: center;
        padding: 10px;
        background-color: #ff69b4;
        color: white;
        position: relative;
        flex: 0 0 auto;
      }

      .title {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .title img {
        margin-right: 8px;
        height: 24px;
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
      }

      .nav-button {
        background-color: #ff1493;
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .nav-button:hover {
        background-color: #ff69b4;
      }

      .add-button {
        position: absolute;
        top: 5px;
        right: 10px;
        background-color: #ff1493;
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-size: 16px;
        line-height: 16px;
        cursor: pointer;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
      }

      .add-button:hover {
        background-color: #ff69b4;
      }

      /* é€±è¦–åœ– */
      .week-view {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
        flex: 1 1 auto;
      }

      .time-scale {
        position: relative;
        width: 45px;
        background-color: #ffd1dc;
        font-size: 8px;
        text-align: right;
        padding-top: 50px;
        padding-left: 2px;
      }

      .time-slot {
        position: relative;
        height: calc(100% / 17); /* æ¯å€‹æ™‚é–“æ®µä½”1/17çš„é«˜åº¦ */
      }

      .week-grid {
        display: flex;
        flex-grow: 1;
        overflow-y: auto;
      }

      .day-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #ff69b4;
        position: relative;
      }

      .day-column:last-child {
        border-right: none;
      }

      .day-header {
        text-align: center;
        padding: 5px 0;
        font-weight: bold;
        background-color: #ffd1dc;
        border-bottom: 1px solid #ff69b4;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .day-header:hover {
        background-color: #ffb6c1;
      }

      .day-content {
        flex-grow: 1;
        position: relative;
        overflow: hidden;
      }

      /* è¡Œç¨‹é …ç›® */
      .schedule-item {
        position: absolute;
        left: 2px;
        right: 2px;
        color: white;
        font-size: 7px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-around;
        border-radius: 8px;
        padding: 4px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        line-height: 1.2;
      }

      .schedule-item:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .vertical-line {
        display: inline-block;
        width: 1px;
        height: 8px;
        background-color: white;
        margin: 2px 0;
      }

      /* åˆªé™¤æŒ‰éˆ• */
      .schedule-item .delete-btn {
        background-color: #ff4c4c;
        border: none;
        color: white;
        font-size: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        cursor: pointer;
        position: absolute;
        top: 2px;
        right: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: background-color 0.3s;
      }

      .schedule-item .delete-btn:hover {
        background-color: #ff0000;
      }

      /* ç¸½å·¥æ™‚ */
      .total-hours {
        text-align: center;
        padding: 10px;
        font-weight: bold;
        background-color: #ff69b4;
        color: white;
        flex: 0 0 auto;
      }

      /* æ¨¡æ…‹æ¡† */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
      }

      /* ç•¶æ—¥å·¥ä½œåˆ—è¡¨ */
      .day-schedule-list {
        list-style-type: none;
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
      }

      .day-schedule-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        border-radius: 8px;
        background-color: white;
        margin-bottom: 5px;
        transition: background-color 0.3s;
      }

      .job-info {
        flex: 1;
        margin-right: 10px;
      }

      .job-actions {
        display: flex;
        gap: 0;
      }

      /* èª¿æ•´ .overlap-actions çš„æ¨£å¼ */
      .overlap-actions {
        display: flex;
        flex-wrap: wrap;
        justify-content: center; /* å°‡æŒ‰éˆ•å±…ä¸­å°é½Š */
        gap: 5px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        margin-top: 20px; /* èˆ‡ä¸Šæ–¹å…§å®¹çš„é–“è· */
      }

      /* æŒ‰éˆ•æ¨£å¼ */
      .action-btn,
      .delete-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.3s;
        color: white;
      }

      .edit-btn {
        background-color: #ff69b4;
      }

      .edit-btn:hover {
        background-color: #ff1493;
      }
      .del-btn {
        margin-left: 5px;
      }
      .delete-btn {
        background-color: #ff5781;
      }

      .delete-btn:hover {
        background-color: #ff1447;
      }

      /* åˆ‡æ›æŒ‰éˆ• */
      .toggle-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
      }

      .toggle-button {
        padding: 5px 15px;
        cursor: pointer;
        text-align: center;
        border-radius: 15px;
        color: white;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .toggle-button.single,
      .toggle-button.multi,
      .toggle-button.command {
        background-color: #ffb6c1;
      }

      .toggle-button.active {
        background-color: #ff1493;
      }

      /* è¡¨å–®æ¨£å¼ */
      label {
        display: block;
        margin: 10px 0 5px;
      }

      input[type="text"],
      input[type="date"],
      textarea {
        width: calc(100% - 10px);
        padding: 5px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }

      .time-input-wrapper {
        display: flex;
        align-items: center;
      }

      .time-input-wrapper select {
        width: 45%;
        margin: 5px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }

      .weekdays {
        display: flex;
        justify-content: space-between;
        margin: 10px 0;
      }

      /* .weekday {
        padding: 3px;
        margin-left: 3px;
        border-radius: 50%;
        background-color: #ff69b4;
        color: white;
        display: inline;
        align-items: center;
        justify-content: center;
        font-size: 0.8em;
      } */

      .weekday {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #ffb6c1;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s, transform 0.3s;
      }

      .weekday:hover {
        background-color: #ff69b4;
        transform: scale(1.1);
      }

      .weekday.selected {
        background-color: #ff1493;
      }

      button[type="submit"] {
        background-color: #ff1493;
        border: none;
        color: white;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: background-color 0.3s;
      }

      button[type="submit"]:hover {
        background-color: #ff69b4;
      }

      /* è‡ªå‹•å®Œæˆ */
      .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #fff;
        max-height: 150px;
        overflow-y: auto;
      }

      .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #d4d4d4;
      }

      .autocomplete-items div:hover {
        background-color: #e9e9e9;
      }

      .autocomplete-active {
        background-color: DodgerBlue !important;
        color: #ffffff;
      }

      /* æµ®å‹•æç¤ºçª— */
      .toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #ff1493;
        color: white;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1000;
        right: 30px;
        bottom: 30px;
        font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        transition: opacity 0.5s;
      }

      .toast.show {
        visibility: visible;
        opacity: 1;
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      @-webkit-keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @-webkit-keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      /* æ™‚é–“é‡ç–Šæ¨¡æ…‹æ¡† */
      .label {
        font-weight: bold;
        margin-bottom: 5px;
        text-align: center;
        width: 100%;
      }

      /* èª¿æ•´ .overlap-schedule å®¹å™¨çš„æ¨£å¼ */
      .overlap-schedule {
        display: flex;
        flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ— */
        align-items: center;
        margin-bottom: 20px;
        position: relative;
      }

      .original-schedule,
      .new-schedule {
        width: 100%;
        position: relative;
        margin-bottom: 15px;
      }

      /* èª¿æ•´ .schedule-details çš„æ¨£å¼ */
      .schedule-details {
        position: relative;
        padding: 10px 15px;
        border-radius: 10px;
        background-color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .schedule-info {
        margin-left: 15px;
      }

      /* æ–°çš„ color-block æ¨£å¼ */
      .color-block {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 8px;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.5),
          rgba(255, 255, 255, 0)
        );
      }

      .color-block::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 8px;
        background-color: var(--block-color);
        border-top-right-radius: 10px;
        border-bottom-right-radius: 10px;
      }

      /* ç®­é ­æ¨£å¼ */
      .arrow {
        width: 30px;
        height: 30px;
        background-image: url("https://s123104.github.io/az.tool/img/down-arrow.png");
        background-size: contain;
        background-repeat: no-repeat;
        animation: arrowBounce 2s infinite;
        margin-bottom: 15px;
      }

      /* ç®­é ­å‹•ç•« */
      @keyframes arrowBounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(10px);
        }
      }

      /* è¡Œå‹•è£ç½®èª¿æ•´ */
      @media (max-width: 600px) {
        .calendar-container {
          padding: 0;
          width: 100%;
        }

        .header {
          padding: 5px;
        }

        .title {
          font-size: 16px;
        }

        .nav-button,
        .add-button {
          padding: 3px 7px;
          font-size: 10px;
        }

        .add-button {
          width: 25px;
          height: 25px;
          line-height: 25px;
          font-size: 14px;
          top: 5px;
        }

        .time-scale {
          font-size: 7px;
          width: 40px;
        }

        .total-hours {
          padding: 5px;
          font-size: 10px;
        }

        .modal-content {
          width: 95%;
          max-width: 300px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea,
        button[type="submit"] {
          padding: 7px;
          margin: 3px 0;
        }

        button[type="submit"] {
          font-size: 14px;
        }

        .schedule-item {
          font-size: 7px;
          line-height: 1.1;
        }

        /* æ™‚é–“é‡ç–Šæ¨¡æ…‹æ¡†è¡Œå‹•è£ç½®èª¿æ•´ */
        .arrow {
          width: 30px;
          height: 30px;
        }

        .schedule-details {
          padding: 10px;
        }

        .color-block,
        .color-block::before {
          width: 6px;
        }
      }
    </style>
  </head>
  <body>
    <div class="calendar-container">
      <div class="header">
        <h1 class="title">
          <img
            src="https://s123104.github.io/az.tool/img/magician-hat.png"
            alt="magician hat"
          />
          å¯æ„›å…”å…”æ’ç­è¡¨
        </h1>
        <button class="add-button" id="addButton">+</button>
        <div class="navigation">
          <button class="nav-button" id="prevWeek">ä¸Šä¸€é€±</button>
          <button class="nav-button" id="nextWeek">ä¸‹ä¸€é€±</button>
        </div>
      </div>
      <div class="week-view">
        <div class="time-scale" id="timeScale"></div>
        <div class="week-grid">
          <!-- é€™äº›å…§å®¹ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
      <div class="total-hours" id="totalHours">æœ¬é€±ç¸½å·¥æ™‚ï¼š0å°æ™‚</div>
    </div>

    <!-- æ–°å¢å·¥ä½œæ¨¡æ…‹æ¡† -->
    <div id="modal-add" class="modal">
      <div class="modal-content">
        <span class="close" id="closeAdd">&times;</span>
        <div class="toggle-container">
          <div class="toggle-button single active" id="singleAddToggle">
            å–®æ¬¡
          </div>
          <div class="toggle-button multi" id="batchAddToggle">æ‰¹é‡</div>
          <div class="toggle-button command" id="commandToggle">æŒ‡ä»¤</div>
        </div>
        <div id="singleAddContainer">
          <h2>æ–°å¢å·¥ä½œ</h2>
          <form id="addForm" autocomplete="off">
            <label for="addJobName">å·¥ä½œåç¨±</label>
            <input
              type="text"
              id="addJobName"
              name="addJobName"
              maxlength="4"
              required
            />
            <label for="addJobDate">æ—¥æœŸ</label>
            <input type="date" id="addJobDate" name="addJobDate" required />
            <label for="addStartTime">é–‹å§‹æ™‚é–“</label>
            <div class="time-input-wrapper">
              <select id="addStartHour" name="addStartHour" required></select>
              :
              <select
                id="addStartMinute"
                name="addStartMinute"
                required
              ></select>
            </div>
            <label for="addEndTime">çµæŸæ™‚é–“</label>
            <div class="time-input-wrapper">
              <select id="addEndHour" name="addEndHour" required></select>
              :
              <select id="addEndMinute" name="addEndMinute" required></select>
            </div>
            <button type="submit">ä¿å­˜</button>
          </form>
        </div>
        <div id="batchAddContainer" style="display: none">
          <h2>æ‰¹é‡æ–°å¢å·¥ä½œ</h2>
          <form id="batchAddForm" autocomplete="off">
            <label for="batchAddJobName">å·¥ä½œåç¨±</label>
            <input
              type="text"
              id="batchAddJobName"
              name="batchAddJobName"
              maxlength="4"
              required
            />
            <label for="batchAddStartDate">é–‹å§‹æ—¥æœŸ</label>
            <input
              type="date"
              id="batchAddStartDate"
              name="batchAddStartDate"
              required
            />
            <label for="batchAddEndDate">çµæŸæ—¥æœŸ</label>
            <input
              type="date"
              id="batchAddEndDate"
              name="batchAddEndDate"
              required
            />
            <label for="batchAddStartTime">é–‹å§‹æ™‚é–“</label>
            <div class="time-input-wrapper">
              <select
                id="batchAddStartHour"
                name="batchAddStartHour"
                required
              ></select>
              :
              <select
                id="batchAddStartMinute"
                name="batchAddStartMinute"
                required
              ></select>
            </div>
            <label for="batchAddEndTime">çµæŸæ™‚é–“</label>
            <div class="time-input-wrapper">
              <select
                id="batchAddEndHour"
                name="batchAddEndHour"
                required
              ></select>
              :
              <select
                id="batchAddEndMinute"
                name="batchAddEndMinute"
                required
              ></select>
            </div>
            <div class="weekdays">
              <div class="weekday" data-day="1">ä¸€</div>
              <div class="weekday" data-day="2">äºŒ</div>
              <div class="weekday" data-day="3">ä¸‰</div>
              <div class="weekday" data-day="4">å››</div>
              <div class="weekday" data-day="5">äº”</div>
              <div class="weekday" data-day="6">å…­</div>
              <div class="weekday" data-day="0">æ—¥</div>
            </div>
            <button type="submit">æ‰¹é‡ä¿å­˜</button>
          </form>
        </div>
        <div id="commandContainer" style="display: none">
          <h2>æŒ‡ä»¤å¿«é€Ÿæ–°å¢</h2>
          <form id="commandForm" autocomplete="off">
            <label for="commandJobName">å·¥ä½œåç¨±</label>
            <input
              type="text"
              id="commandJobName"
              name="commandJobName"
              maxlength="4"
              required
            />
            <label for="commandInput">è¼¸å…¥æŒ‡ä»¤:</label>
            <textarea
              id="commandInput"
              name="commandInput"
              rows="5"
              required
            ></textarea>
            <details>
              <summary>é»æ­¤æŸ¥çœ‹æŒ‡ä»¤ç¯„ä¾‹</summary>
              <p>æ ¼å¼èªªæ˜:</p>
              <ul>
                <li>å·¥ä½œåç¨±: é€éä¸Šæ–¹ã€Œå·¥ä½œåç¨±ã€æ¬„ä½è¼¸å…¥ã€‚</li>
                <li>
                  æŒ‡ä»¤æ ¼å¼:
                  <ul>
                    <li>
                      å€é–“å…§ä¸æŒ‡å®šæ˜ŸæœŸ:
                      <ul>
                        <li>ç¯„ä¾‹ä¸€:10/10-10/13 12:00-20:30</li>
                        <li>ç¯„ä¾‹äºŒ:10/15~10/18 12.-20.5</li>
                      </ul>
                    </li>
                    <li>
                      å€é–“å…§æŒ‡å®šæ˜ŸæœŸ:
                      <ul>
                        <li>ç¯„ä¾‹ä¸€:10/10-10/13 12:00-20:30(ä¸€,ä¸‰,äº”)</li>
                        <li>ç¯„ä¾‹äºŒ:10/15~10/18 12.-20.5(ä¸€,ä¸‰,äº”)</li>
                      </ul>
                    </li>
                    <li>
                      å–®æ—¥:
                      <ul>
                        <li>ç¯„ä¾‹ä¸€:10/13 12:00-20:30</li>
                        <li>ç¯„ä¾‹äºŒ:10/13 12.-20.5</li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li>ç‰¹æ®Šè¦å‰‡: -~ç‚ºå€é–“ç¬¦è™Ÿ, 12.ç‚º12:00ç°¡å¯«, 12.5ç‚º12:30ç°¡å¯«</li>
              </ul>
            </details>
            <button type="submit">åŸ·è¡ŒæŒ‡ä»¤</button>
          </form>
        </div>
      </div>
    </div>

    <!-- ä¿®æ”¹å·¥ä½œæ¨¡æ…‹æ¡† -->
    <div id="modal-edit" class="modal">
      <div class="modal-content">
        <span class="close" id="closeEdit">&times;</span>
        <h2>ä¿®æ”¹å·¥ä½œ</h2>
        <form id="editForm" autocomplete="off">
          <label for="editJobName">å·¥ä½œåç¨±</label>
          <input
            type="text"
            id="editJobName"
            name="editJobName"
            maxlength="4"
            required
          />
          <label for="editJobDate">æ—¥æœŸ</label>
          <input type="date" id="editJobDate" name="editJobDate" required />
          <label for="editStartTime">é–‹å§‹æ™‚é–“</label>
          <div class="time-input-wrapper">
            <select id="editStartHour" name="editStartHour" required></select>
            :
            <select
              id="editStartMinute"
              name="editStartMinute"
              required
            ></select>
          </div>
          <label for="editEndTime">çµæŸæ™‚é–“</label>
          <div class="time-input-wrapper">
            <select id="editEndHour" name="editEndHour" required></select>
            :
            <select id="editEndMinute" name="editEndMinute" required></select>
          </div>
          <button type="submit">ä¿å­˜</button>
        </form>
      </div>
    </div>

    <!-- æ–°å¢çš„æ¨¡æ…‹æ¡†ï¼šæª¢è¦–ç•¶æ—¥å·¥ä½œ -->
    <div id="modal-view-day" class="modal">
      <div class="modal-content">
        <span class="close" id="closeViewDay">&times;</span>
        <h2 id="viewDayTitle">å·¥ä½œåˆ—è¡¨</h2>
        <ul id="dayScheduleList" class="day-schedule-list">
          <!-- å‹•æ…‹ç”Ÿæˆçš„å·¥ä½œé …ç›®å°‡æ’å…¥æ–¼æ­¤ -->
        </ul>
      </div>
    </div>

    <!-- æµ®å‹•æç¤ºçª— -->
    <div id="toast" class="toast"></div>
    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        // å–å¾— DOM å…ƒç´ çš„å¼•ç”¨
        const prevWeekBtn = document.getElementById("prevWeek");
        const nextWeekBtn = document.getElementById("nextWeek");
        const totalHoursElement = document.getElementById("totalHours");
        const addButton = document.getElementById("addButton");
        const modalAdd = document.getElementById("modal-add");
        const modalEdit = document.getElementById("modal-edit");
        const modalViewDay = document.getElementById("modal-view-day");
        const closeAddBtn = document.getElementById("closeAdd");
        const closeEditBtn = document.getElementById("closeEdit");
        const closeViewDayBtn = document.getElementById("closeViewDay");
        const addForm = document.getElementById("addForm");
        const batchAddForm = document.getElementById("batchAddForm");
        const commandForm = document.getElementById("commandForm");
        const singleAddToggle = document.getElementById("singleAddToggle");
        const batchAddToggle = document.getElementById("batchAddToggle");
        const commandToggle = document.getElementById("commandToggle");
        const singleAddContainer =
          document.getElementById("singleAddContainer");
        const batchAddContainer = document.getElementById("batchAddContainer");
        const commandContainer = document.getElementById("commandContainer");
        const editForm = document.getElementById("editForm");
        const viewDayTitle = document.getElementById("viewDayTitle");
        const dayScheduleList = document.getElementById("dayScheduleList");
        const jobNameInputAdd = document.getElementById("addJobName");
        const jobNameInputBatchAdd = document.getElementById("batchAddJobName");
        const jobNameInputEdit = document.getElementById("editJobName");
        const commandJobNameInput = document.getElementById("commandJobName");
        const commandInput = document.getElementById("commandInput");
        const toast = document.getElementById("toast");

        // å¾ localStorage ä¸­å–å¾—æˆ–åˆå§‹åŒ–è³‡æ–™
        let schedules = JSON.parse(localStorage.getItem("schedules")) || {};
        let jobNames = JSON.parse(localStorage.getItem("jobNames")) || [];
        let jobColors = JSON.parse(localStorage.getItem("jobColors")) || {};
        let currentEditKey = null;

        // å®šç¾©å¯ç”¨çš„é¡è‰²æ¸…å–®
        const colors = [
          "#ffc0cb",
          "#ffb6c1",
          "#ff69b4",
          "#ff1493",
          "#db7093",
          "#ff8c69",
          "#ff6347",
          "#ff4500",
          "#FFB3BA",
          "#FFDFBA",
          "#BAE1FF",
          "#D9BAFF",
          "#FFBAF2",
          "#FFC6FF",
          "#FFBAE5",
          "#FFBAB3",
          "#FFBAC6",
          "#FFD1BA",
          "#BAD1FF",
          "#D1BAFF",
          "#FFBAD1",
        ];

        // å–å¾—æ—¥æœŸçš„éµå€¼ï¼Œç”¨æ–¼å„²å­˜åœ¨ç‰©ä»¶ä¸­
        function getLocalDateKey(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        // è¨­å®šç•¶å‰é€±çš„èµ·å§‹æ—¥æœŸï¼ˆé€±ä¸€ï¼‰
        let currentWeekStart = getMonday(new Date());

        // å–å¾—æŒ‡å®šæ—¥æœŸæ‰€åœ¨é€±çš„é€±ä¸€æ—¥æœŸ
        function getMonday(d) {
          d = new Date(d);
          const day = d.getDay();
          const diff = d.getDate() - day + (day === 0 ? -6 : 1);
          return new Date(d.setDate(diff));
        }

        // æ›´æ–°é€±çš„é¡¯ç¤ºï¼ˆå‰ä¸€é€±æˆ–ä¸‹ä¸€é€±ï¼‰
        function updateWeek(direction) {
          currentWeekStart = new Date(
            currentWeekStart.getFullYear(),
            currentWeekStart.getMonth(),
            currentWeekStart.getDate() + direction * 7
          );
          generateWeekGrid();
          updateDates();
          updateTimeScale();
          requestAnimationFrame(() => {
            updateSchedule();
            updateTotalHours();
          });
        }

        // ç”Ÿæˆé€±è¦–åœ–çš„ç¶²æ ¼
        function generateWeekGrid() {
          const weekGrid = document.querySelector(".week-grid");
          weekGrid.innerHTML = "";
          for (let i = 0; i < 7; i++) {
            const dayColumn = document.createElement("div");
            dayColumn.classList.add("day-column");

            const dayHeader = document.createElement("div");
            dayHeader.classList.add("day-header");
            dayHeader.innerHTML = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"][i];
            dayHeader.dataset.dayIndex = i;
            dayColumn.appendChild(dayHeader);

            const dayContent = document.createElement("div");
            dayContent.classList.add("day-content");
            dayColumn.appendChild(dayContent);

            weekGrid.appendChild(dayColumn);

            // é»æ“Šæ—¥æ›†é ­éƒ¨ï¼Œæ‰“é–‹ç•¶æ—¥çš„è©³ç´°è¦–åœ–
            dayHeader.addEventListener("click", () => {
              const date = new Date(currentWeekStart);
              date.setDate(date.getDate() + i);
              const dateKey = getLocalDateKey(date);
              openViewDayModal(dateKey);
            });
          }
        }

        // æ›´æ–°é€±è¦–åœ–ä¸­çš„æ—¥æœŸé¡¯ç¤º
        function updateDates() {
          const dayHeaders = document.querySelectorAll(".day-header");
          for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + i);
            dayHeaders[i].innerHTML =
              ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"][i] +
              `<br>${date.getMonth() + 1}/${date.getDate()}`;
          }
        }

        // æ›´æ–°è¡Œç¨‹é¡¯ç¤º
        function updateSchedule() {
          const dayContents = document.querySelectorAll(".day-content");
          dayContents.forEach((content) => (content.innerHTML = ""));

          const dayContentHeight = dayContents[0].clientHeight;
          const totalMinutesInDay = 17 * 60; // å¾7é»åˆ°24é»ï¼Œå…±17å°æ™‚

          Object.keys(schedules).forEach((dateKey) => {
            const scheduleArray = schedules[dateKey];
            const scheduleDate = new Date(dateKey);
            const weekStartDate = new Date(currentWeekStart);
            const weekEndDate = new Date(
              weekStartDate.getFullYear(),
              weekStartDate.getMonth(),
              weekStartDate.getDate() + 7
            );

            if (scheduleDate >= weekStartDate && scheduleDate < weekEndDate) {
              scheduleArray.forEach((schedule) => {
                const { id, jobName, start, end } = schedule;
                const color = jobColors[jobName] || "#ff69b4";
                const dayIndex = (scheduleDate.getDay() + 6) % 7;
                const startTime = parseTime(start);
                const endTime = parseTime(end);

                if (!startTime || !endTime) {
                  console.error(`ç„¡æ³•è§£ææ™‚é–“: ${start} æˆ– ${end}`);
                  return;
                }

                const duration = (endTime - startTime) / 60000; // è½‰æ›ç‚ºåˆ†é˜
                const topPosition =
                  (((startTime.getHours() - 7) * 60 + startTime.getMinutes()) /
                    totalMinutesInDay) *
                  dayContentHeight;
                const height =
                  (duration / totalMinutesInDay) * dayContentHeight;
                if (topPosition < 0 || height <= 0) return;

                const scheduleItem = document.createElement("div");
                scheduleItem.classList.add("schedule-item");
                scheduleItem.style.top = `${topPosition}px`;
                scheduleItem.style.height = `${height}px`;
                scheduleItem.style.backgroundColor = color;
                scheduleItem.innerHTML = `
                  <div class="schedule-content">
                    <span>ğŸ°</span>
                    <br>${jobName}
                    <br>${formatTime(start)}
                    <br><span class="vertical-line"></span>
                    <br>${formatTime(end)}
                  </div>
                `;

                const deleteButton = document.createElement("button");
                deleteButton.classList.add("delete-btn");
                deleteButton.innerHTML = "X";
                deleteButton.addEventListener("click", (event) => {
                  event.stopPropagation();
                  deleteSchedule(dateKey, id, jobName, start, end);
                  scheduleItem.remove();
                  updateTotalHours();
                  showToast(`å·²åˆªé™¤å·¥ä½œ (${formatDate(dateKey)})`, "#ff1493");
                });
                scheduleItem.appendChild(deleteButton);

                scheduleItem.addEventListener("click", () =>
                  openEditModal(dateKey, id)
                );

                const content = dayContents[dayIndex];
                content.appendChild(scheduleItem);
              });
            }
          });
        }

        // æ›´æ–°æœ¬é€±ç¸½å·¥æ™‚
        function updateTotalHours() {
          let totalHours = 0;
          const weekStartDate = new Date(currentWeekStart);
          const weekEndDate = new Date(
            weekStartDate.getFullYear(),
            weekStartDate.getMonth(),
            weekStartDate.getDate() + 7
          );

          Object.keys(schedules).forEach((dateKey) => {
            const scheduleArray = schedules[dateKey];
            const scheduleDate = new Date(dateKey);
            if (scheduleDate >= weekStartDate && scheduleDate < weekEndDate) {
              scheduleArray.forEach((schedule) => {
                const { start, end } = schedule;
                const startTime = parseTime(start);
                const endTime = parseTime(end);
                if (!startTime || !endTime) {
                  console.error(`ç„¡æ³•è§£ææ™‚é–“: ${start} æˆ– ${end}`);
                  return;
                }
                const duration = (endTime - startTime) / 3600000; // è½‰æ›ç‚ºå°æ™‚
                totalHours += duration;
              });
            }
          });
          totalHoursElement.textContent = `æœ¬é€±ç¸½å·¥æ™‚ï¼š${totalHours.toFixed(
            1
          )} å°æ™‚`;
        }

        // è§£ææ™‚é–“å­—ä¸²ï¼Œæ”¯æ´å¤šç¨®æ ¼å¼
        function parseTime(timeStr) {
          if (timeStr.includes(":")) {
            const [hoursStr, minutesStr] = timeStr.split(":");
            const hours = parseInt(hoursStr, 10);
            const minutes = parseInt(minutesStr, 10);
            if (isNaN(hours) || isNaN(minutes)) {
              console.error(`ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼: ${timeStr}`);
              return null;
            }
            return new Date(0, 0, 0, hours, minutes);
          } else if (timeStr.includes(".")) {
            const parts = timeStr.split(".");
            const hours = parseInt(parts[0], 10);
            let minutes = 0;
            if (parts[1]) {
              if (parts[1].length === 1) {
                if (parts[1] === "5") {
                  minutes = 30;
                } else {
                  minutes = parseInt(parts[1], 10) * 10;
                }
              } else if (parts[1].length === 2) {
                minutes = parseInt(parts[1], 10);
              }
            }
            if (isNaN(hours) || isNaN(minutes)) {
              console.error(`ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼: ${timeStr}`);
              return null;
            }
            return new Date(0, 0, 0, hours, minutes);
          } else {
            const hours = parseInt(timeStr, 10);
            if (isNaN(hours)) {
              console.error(`ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼: ${timeStr}`);
              return null;
            }
            return new Date(0, 0, 0, hours, 0);
          }
        }

        // æ ¼å¼åŒ–æ™‚é–“ï¼Œç”¨æ–¼é¡¯ç¤º
        function formatTime(timeStr) {
          const [hours, minutes] = timeStr.split(":").map(Number);
          if (isNaN(hours) || isNaN(minutes)) {
            console.error(`ç„¡æ³•æ ¼å¼åŒ–æ™‚é–“: ${timeStr}`);
            return timeStr;
          }
          const period = hours < 12 ? "æ—©ä¸Š" : hours < 18 ? "ä¸‹åˆ" : "æ™šä¸Š";
          const formattedHours = hours % 12 || 12;
          return `${period} ${formattedHours}:${minutes
            .toString()
            .padStart(2, "0")}`;
        }

        // ç‚ºå·¥ä½œåç¨±å–å¾—é¡è‰²ï¼Œè‹¥ç„¡å‰‡åˆ†é…ä¸€å€‹æ–°çš„é¡è‰²
        function getColorForJob(jobName) {
          if (jobColors[jobName]) {
            return jobColors[jobName];
          } else {
            const usedColors = Object.values(jobColors);
            const availableColors = colors.filter(
              (color) => !usedColors.includes(color)
            );
            let color;
            if (availableColors.length > 0) {
              color =
                availableColors[
                  Math.floor(Math.random() * availableColors.length)
                ];
            } else {
              color = colors[Math.floor(Math.random() * colors.length)];
            }
            jobColors[jobName] = color;
            localStorage.setItem("jobColors", JSON.stringify(jobColors));
            return color;
          }
        }

        // é–‹å•Ÿæ–°å¢å·¥ä½œæ¨¡æ…‹æ¡†
        function openAddModal() {
          modalAdd.style.display = "block";
          resetAddForms();
        }

        // é—œé–‰æ–°å¢å·¥ä½œæ¨¡æ…‹æ¡†
        function closeAddModal() {
          modalAdd.style.display = "none";
        }

        // é–‹å•Ÿç·¨è¼¯å·¥ä½œæ¨¡æ…‹æ¡†
        function openEditModal(dateKey, scheduleId) {
          const schedule = schedules[dateKey].find((s) => s.id === scheduleId);
          if (!schedule) return;
          currentEditKey = { dateKey, scheduleId };
          document.getElementById("editJobName").value = schedule.jobName;
          document.getElementById("editJobDate").value = dateKey;

          const startTimeObj = parseTime(schedule.start);
          const endTimeObj = parseTime(schedule.end);

          if (!startTimeObj || !endTimeObj) {
            console.error(`ç„¡æ³•è§£ææ™‚é–“: ${schedule.start} æˆ– ${schedule.end}`);
            return;
          }

          const startHour = String(startTimeObj.getHours()).padStart(2, "0");
          const startMinute = String(startTimeObj.getMinutes()).padStart(
            2,
            "0"
          );
          const endHour = String(endTimeObj.getHours()).padStart(2, "0");
          const endMinute = String(endTimeObj.getMinutes()).padStart(2, "0");

          document.getElementById("editStartHour").value = startHour;
          document.getElementById("editStartMinute").value = startMinute;
          document.getElementById("editEndHour").value = endHour;
          document.getElementById("editEndMinute").value = endMinute;

          modalEdit.style.display = "block";
        }

        // é—œé–‰ç·¨è¼¯å·¥ä½œæ¨¡æ…‹æ¡†
        function closeEditModal() {
          modalEdit.style.display = "none";
          currentEditKey = null;
        }

        // é–‹å•ŸæŸ¥çœ‹ç•¶æ—¥å·¥ä½œæ¨¡æ…‹æ¡†
        function openViewDayModal(dateKey) {
          const date = new Date(dateKey);
          const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;

          // å–å¾—æ˜ŸæœŸå¹¾ä¸¦ç”Ÿæˆæ¨™ç±¤
          const weekdayIndex = getWeekdayIndex(dateKey);
          const weekday = getWeekday(dateKey);
          const weekdayTag = `<div class="weekday pink" data-day="${weekdayIndex}">${weekday}</div>`;

          // ä¿®æ”¹ç‚ºä½¿ç”¨ innerHTMLï¼Œä»¥åŒ…å« HTML æ¨™ç±¤
          viewDayTitle.innerHTML = `å·¥ä½œåˆ—è¡¨ - ${formattedDate} ${weekdayTag}`;

          populateDayScheduleList(dateKey);
          modalViewDay.style.display = "block";
        }

        // é—œé–‰æŸ¥çœ‹ç•¶æ—¥å·¥ä½œæ¨¡æ…‹æ¡†
        function closeViewDayModal() {
          modalViewDay.style.display = "none";
          dayScheduleList.innerHTML = "";
        }

        // å¡«å……ç•¶æ—¥çš„å·¥ä½œåˆ—è¡¨
        function populateDayScheduleList(dateKey) {
          dayScheduleList.innerHTML = "";
          const scheduleArray = schedules[dateKey] || [];

          scheduleArray.sort((a, b) => {
            const startA = parseTime(a.start).getTime();
            const startB = parseTime(b.start).getTime();
            return startA - startB;
          });

          if (scheduleArray.length === 0) {
            const noScheduleItem = document.createElement("li");
            noScheduleItem.textContent = "ç•¶æ—¥ç„¡ä»»ä½•å·¥ä½œã€‚";
            dayScheduleList.appendChild(noScheduleItem);
            return;
          }

          scheduleArray.forEach((schedule) => {
            const { id, jobName, start, end, color } = schedule;

            const listItem = document.createElement("li");
            listItem.classList.add("day-schedule-item");
            listItem.style.borderLeft = `4px solid ${color}`;

            const jobInfo = document.createElement("div");
            jobInfo.classList.add("job-info");
            jobInfo.innerHTML = `<strong>${jobName}</strong><br>${formatTime(
              start
            )} - ${formatTime(end)}`;
            listItem.appendChild(jobInfo);

            const actions = document.createElement("div");
            actions.classList.add("job-actions");

            const editBtn = document.createElement("button");
            editBtn.classList.add("action-btn", "edit-btn");
            editBtn.textContent = "ä¿®æ”¹";
            editBtn.addEventListener("click", () => {
              closeViewDayModal();
              openEditModal(dateKey, id);
            });
            actions.appendChild(editBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.classList.add("action-btn", "delete-btn", "del-btn");
            deleteBtn.textContent = "åˆªé™¤";
            deleteBtn.addEventListener("click", () => {
              deleteSchedule(dateKey, id, jobName, start, end);
              populateDayScheduleList(dateKey);
            });
            actions.appendChild(deleteBtn);

            listItem.appendChild(actions);
            dayScheduleList.appendChild(listItem);
          });
        }

        // åˆªé™¤å·¥ä½œ
        function deleteSchedule(dateKey, scheduleId, jobName, start, end) {
          if (schedules[dateKey]) {
            schedules[dateKey] = schedules[dateKey].filter(
              (s) => s.id !== scheduleId
            );
            if (schedules[dateKey].length === 0) {
              delete schedules[dateKey];
            }
            localStorage.setItem("schedules", JSON.stringify(schedules));
            updateSchedule();
            updateTotalHours();
            const color = jobColors[jobName] || "#ff1493";
            showToast(
              `å·²åˆªé™¤å·¥ä½œ: ${jobName} (${formatDate(dateKey)} ${formatTime(
                start
              )}-${formatTime(end)})`,
              color
            );
          }
        }

        // å°‹æ‰¾æ™‚é–“é‡ç–Šçš„å·¥ä½œ
        function findOverlaps(dateKey, newSchedule, ignoreScheduleId) {
          const overlaps = [];
          const scheduleArray = schedules[dateKey] || [];
          const newStart = parseTime(newSchedule.start).getTime();
          const newEnd = parseTime(newSchedule.end).getTime();
          for (const existingSchedule of scheduleArray) {
            if (ignoreScheduleId && existingSchedule.id === ignoreScheduleId) {
              continue;
            }
            const existingStart = parseTime(existingSchedule.start).getTime();
            const existingEnd = parseTime(existingSchedule.end).getTime();
            if (newStart < existingEnd && newEnd > existingStart) {
              overlaps.push(existingSchedule);
            }
          }
          return overlaps;
        }

        // å‰µå»ºæ™‚é–“é‡ç–Šçš„æ¨¡æ…‹æ¡†
        const overlapModal = document.createElement("div");
        overlapModal.id = "overlapModal";
        overlapModal.className = "modal";
        document.body.appendChild(overlapModal);

        // æ™‚é–“é‡ç–Šæ¨¡æ…‹æ¡†çš„å…§å®¹çµæ§‹
        overlapModal.innerHTML = `
          <div class="modal-content">
            <span class="close" id="closeOverlapModal">&times;</span>
            <h2>æ™‚é–“é‡ç–Š</h2>
            <div id="overlapContent"></div>
          </div>
        `;

        // å–å¾—é‡ç–Šæ¨¡æ…‹æ¡†å…§çš„å…ƒç´ 
        const closeOverlapModalBtn =
          document.getElementById("closeOverlapModal");
        const overlapContent = document.getElementById("overlapContent");

        // ç”¨æ–¼ç®¡ç†å¾…è™•ç†çš„é‡ç–Šå·¥ä½œ
        let pendingOverlaps = [];
        let pendingIndex = 0;
        let isBatch = false;
        let pendingDatesToAdd = [];

        // é¡¯ç¤ºæ™‚é–“é‡ç–Šçš„æ¨¡æ…‹æ¡†
        function showOverlapModal(overlaps, action) {
          pendingOverlaps = overlaps;
          pendingIndex = 0;
          isBatch = action === "batch";
          pendingDatesToAdd = [];
          updateOverlapModal();
          overlapModal.style.display = "block";
        }

        // æ›´æ–°æ™‚é–“é‡ç–Šæ¨¡æ…‹æ¡†çš„å…§å®¹
        function updateOverlapModal() {
          if (pendingIndex >= pendingOverlaps.length) {
            closeOverlapModal();
            return;
          }

          const currentOverlap = pendingOverlaps[pendingIndex];
          const { dateKey, overlap, newSchedule } = currentOverlap;
          const originalColor = jobColors[overlap.jobName] || "#ff69b4";
          const newColor = jobColors[newSchedule.jobName] || "#ff69b4";

          // å–å¾—æ˜ŸæœŸå¹¾ä¸¦ç”Ÿæˆæ¨™ç±¤
          const weekdayIndex = getWeekdayIndex(dateKey);
          const weekday = getWeekday(dateKey);
          const weekdayTag = `<div class="weekday pink" data-day="${weekdayIndex}">${weekday}</div>`;

          overlapContent.innerHTML = `
            <p>æ—¥æœŸï¼š${formatDate(dateKey)} ${weekdayTag}</p>
            <div class="overlap-schedule">
              <div class="original-schedule">
                <div class="label">åŸæ™‚æ®µ</div>
                <div class="schedule-details">
                  <div class="color-block" style="--block-color: ${originalColor};"></div>
                  <div class="schedule-info">
                    <p><strong>${overlap.jobName}</strong></p>
                    <p>${formatTime(overlap.start)} - ${formatTime(
            overlap.end
          )}</p>
                  </div>
                </div>
              </div>
              <div class="arrow"></div>
              <div class="new-schedule">
                <div class="label">æ–°æ™‚æ®µ</div>
                <div class="schedule-details">
                  <div class="color-block" style="--block-color: ${newColor};"></div>
                  <div class="schedule-info">
                    <p><strong>${newSchedule.jobName}</strong></p>
                    <p>${formatTime(newSchedule.start)} - ${formatTime(
            newSchedule.end
          )}</p>
                  </div>
                </div>
              </div>
            </div>
            <p>è«‹é¸æ“‡æ“ä½œï¼š</p>
            <div class="overlap-actions">
              <button id="replaceButton" class="action-btn edit-btn">å–ä»£</button>
              <button id="cancelOverlapButton" class="action-btn delete-btn">å–æ¶ˆ</button>
              <button id="replaceAllButton" class="action-btn edit-btn">
                å…¨éƒ¨å–ä»£(${pendingOverlaps.length - pendingIndex})
              </button>
              <button id="replaceAllCancelButton" class="action-btn delete-btn">
                å…¨éƒ¨å–æ¶ˆ(${pendingOverlaps.length - pendingIndex})
              </button>
            </div>
          `;

          // ç¶å®šæŒ‰éˆ•äº‹ä»¶
          attachOverlapActionListeners();
        }

        // ç¶å®šæ™‚é–“é‡ç–Šæ¨¡æ…‹æ¡†ä¸­çš„æŒ‰éˆ•äº‹ä»¶
        function attachOverlapActionListeners() {
          const replaceBtn = document.getElementById("replaceButton");
          const cancelBtn = document.getElementById("cancelOverlapButton");
          const replaceAllBtn = document.getElementById("replaceAllButton");
          const replaceAllCancelBtn = document.getElementById(
            "replaceAllCancelButton"
          );

          // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›£è½å™¨
          replaceBtn.replaceWith(replaceBtn.cloneNode(true));
          cancelBtn.replaceWith(cancelBtn.cloneNode(true));
          replaceAllBtn.replaceWith(replaceAllBtn.cloneNode(true));
          replaceAllCancelBtn.replaceWith(replaceAllCancelBtn.cloneNode(true));

          // é‡æ–°å–å¾—æŒ‰éˆ•å¼•ç”¨
          const newReplaceBtn = document.getElementById("replaceButton");
          const newCancelBtn = document.getElementById("cancelOverlapButton");
          const newReplaceAllBtn = document.getElementById("replaceAllButton");
          const newReplaceAllCancelBtn = document.getElementById(
            "replaceAllCancelButton"
          );

          // ç¶å®šäº‹ä»¶
          newReplaceBtn.addEventListener("click", () => {
            handleOverlapAction("replace");
          });

          newCancelBtn.addEventListener("click", () => {
            handleOverlapAction("cancel"); // å–®æ¬¡å–æ¶ˆ
          });

          newReplaceAllBtn.addEventListener("click", () => {
            handleOverlapAction("replaceAll");
          });

          newReplaceAllCancelBtn.addEventListener("click", () => {
            handleOverlapAction("cancelAll");
          });
        }

        // é—œé–‰æ™‚é–“é‡ç–Šæ¨¡æ…‹æ¡†
        function closeOverlapModal() {
          overlapModal.style.display = "none";
          pendingOverlaps = [];
          pendingIndex = 0;
          pendingDatesToAdd = [];
          isBatch = false;
        }

        // è™•ç†æ™‚é–“é‡ç–Šçš„æ“ä½œ
        function handleOverlapAction(action) {
          if (action === "replace") {
            // å–®æ¬¡å–ä»£
            const { dateKey, overlap, newSchedule } =
              pendingOverlaps[pendingIndex];
            const color = jobColors[newSchedule.jobName] || "#ff69b4";
            removeOverlap(dateKey, overlap);
            addScheduleToStorage(dateKey, newSchedule, newSchedule.jobName);
            showToast(
              `å·²å–ä»£å·¥ä½œ: ${overlap.jobName} è¢« ${
                newSchedule.jobName
              } (${formatDate(dateKey)} ${formatTime(
                newSchedule.start
              )}-${formatTime(newSchedule.end)})`,
              color
            );
            pendingIndex++;
            updateOverlapModal();
          } else if (action === "replaceAll") {
            // å…¨éƒ¨å–ä»£
            for (; pendingIndex < pendingOverlaps.length; pendingIndex++) {
              const { dateKey, overlap, newSchedule } =
                pendingOverlaps[pendingIndex];
              const color = jobColors[newSchedule.jobName] || "#ff69b4";
              removeOverlap(dateKey, overlap);
              addScheduleToStorage(dateKey, newSchedule, newSchedule.jobName);
              showToast(
                `å·²å–ä»£å·¥ä½œ: ${overlap.jobName} è¢« ${
                  newSchedule.jobName
                } (${formatDate(dateKey)} ${formatTime(
                  newSchedule.start
                )}-${formatTime(newSchedule.end)})`,
                color
              );
            }
            closeOverlapModal();
            updateSchedule();
            updateTotalHours();
          } else if (action === "cancel") {
            // å–®æ¬¡å–æ¶ˆï¼Œä¿ç•™åŸæœ‰çš„å·¥ä½œï¼Œä¸åšä»»ä½•å‹•ä½œ
            showToast(
              `å·²ä¿ç•™åŸå·¥ä½œ: ${
                pendingOverlaps[pendingIndex].overlap.jobName
              } (${formatDate(
                pendingOverlaps[pendingIndex].dateKey
              )} ${formatTime(
                pendingOverlaps[pendingIndex].overlap.start
              )}-${formatTime(pendingOverlaps[pendingIndex].overlap.end)})`,
              jobColors[pendingOverlaps[pendingIndex].overlap.jobName] ||
                "#ff69b4"
            );
            pendingIndex++;
            updateOverlapModal();
          } else if (action === "cancelAll") {
            // å…¨éƒ¨å–æ¶ˆï¼Œä¿ç•™åŸæœ‰çš„å·¥ä½œï¼Œä¸åšä»»ä½•å‹•ä½œ
            for (; pendingIndex < pendingOverlaps.length; pendingIndex++) {
              // ä¸é€²è¡Œä»»ä½•æ“ä½œï¼Œä¿ç•™åŸæœ‰çš„å·¥ä½œ
            }
            closeOverlapModal();
            showToast("å·²å–æ¶ˆæ–°å¢çš„å·¥ä½œï¼Œä¿ç•™åŸæœ‰çš„å·¥ä½œã€‚", "#ff69b4");
          }

          // å¦‚æœæ‰€æœ‰é‡ç–Šå·²è™•ç†ï¼Œå‰‡é—œé–‰æ¨¡æ…‹æ¡†
          if (pendingIndex >= pendingOverlaps.length) {
            closeOverlapModal();
          }
        }

        // ç§»é™¤é‡ç–Šçš„å·¥ä½œ
        function removeOverlap(dateKey, overlapSchedule) {
          if (schedules[dateKey]) {
            schedules[dateKey] = schedules[dateKey].filter(
              (s) => s.id !== overlapSchedule.id
            );
            if (schedules[dateKey].length === 0) {
              delete schedules[dateKey];
            }
            localStorage.setItem("schedules", JSON.stringify(schedules));
            updateSchedule();
            updateTotalHours();
          }
        }

        // æ·»åŠ å·¥ä½œåˆ°å„²å­˜ä¸­
        function addScheduleToStorage(dateKey, newSchedule, jobName) {
          if (!Array.isArray(schedules[dateKey])) {
            schedules[dateKey] = [];
          }
          schedules[dateKey].push(newSchedule);
          localStorage.setItem("schedules", JSON.stringify(schedules));
          if (!jobNames.includes(jobName)) {
            jobNames.push(jobName);
            localStorage.setItem("jobNames", JSON.stringify(jobNames));
          }
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message, color) {
          toast.textContent = message;
          toast.style.backgroundColor = color || "#ff1493";
          toast.className = "toast show";
          setTimeout(() => {
            toast.className = toast.className.replace("show", "");
            toast.style.backgroundColor = "";
          }, 3000);
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
          const date = new Date(dateStr);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        // å–å¾—æ˜ŸæœŸå¹¾çš„å‡½æ•¸ï¼Œè¿”å›ä¸­æ–‡çš„æ˜ŸæœŸ
        function getWeekday(dateStr) {
          const date = new Date(dateStr);
          const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
          return weekdays[date.getDay()];
        }

        // å–å¾—æ˜ŸæœŸå¹¾çš„ç´¢å¼•ï¼ˆ0-6ï¼‰ï¼Œ0ç‚ºæ˜ŸæœŸæ—¥
        function getWeekdayIndex(dateStr) {
          const date = new Date(dateStr);
          return date.getDay();
        }

        // å„²å­˜æ–°å¢çš„å–®æ¬¡å·¥ä½œ
        function saveAddSchedule() {
          const jobName = document.getElementById("addJobName").value.trim();
          const jobDate = document.getElementById("addJobDate").value;
          const startTime =
            document.getElementById("addStartHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("addStartMinute").value.padStart(2, "0");
          const endTime =
            document.getElementById("addEndHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("addEndMinute").value.padStart(2, "0");
          const color = getColorForJob(jobName);
          const scheduleId = Date.now() + Math.random();

          const newSchedule = {
            id: scheduleId,
            jobName,
            start: startTime,
            end: endTime,
            color,
          };

          const dateKey = getLocalDateKey(new Date(jobDate));

          const overlaps = findOverlaps(dateKey, newSchedule);
          if (overlaps.length > 0) {
            isBatch = false;
            const overlapData = overlaps.map((overlap) => ({
              dateKey,
              overlap,
              newSchedule,
            }));
            showOverlapModal(overlapData, "single");
            return;
          }

          addScheduleToStorage(dateKey, newSchedule, jobName);
          closeAddModal();
          updateSchedule();
          updateTotalHours();
          showToast(
            `å·²æ–°å¢å·¥ä½œ: ${jobName} (${formatDate(jobDate)} ${formatTime(
              startTime
            )}-${formatTime(endTime)})`,
            color
          );
        }

        // å„²å­˜æ‰¹é‡æ–°å¢çš„å·¥ä½œ
        function saveBatchAddSchedule() {
          const jobName = document
            .getElementById("batchAddJobName")
            .value.trim();
          const startDateInput =
            document.getElementById("batchAddStartDate").value;
          const endDateInput = document.getElementById("batchAddEndDate").value;
          const startDate = new Date(startDateInput);
          const endDate = new Date(endDateInput);
          const startTime =
            document
              .getElementById("batchAddStartHour")
              .value.padStart(2, "0") +
            ":" +
            document
              .getElementById("batchAddStartMinute")
              .value.padStart(2, "0");
          const endTime =
            document.getElementById("batchAddEndHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("batchAddEndMinute").value.padStart(2, "0");
          const selectedDays = Array.from(
            document.querySelectorAll(".weekday.selected")
          ).map((el) => parseInt(el.dataset.day));
          const color = getColorForJob(jobName);

          if (endDate < startDate) {
            alert("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸã€‚");
            return;
          }

          const datesToAdd = [];
          for (
            let date = new Date(startDate);
            date <= endDate;
            date.setDate(date.getDate() + 1)
          ) {
            if (selectedDays.includes(date.getDay())) {
              const dateKey = getLocalDateKey(new Date(date));
              const scheduleId = Date.now() + Math.random();

              const newSchedule = {
                id: scheduleId,
                jobName,
                start: startTime,
                end: endTime,
                color: color,
              };

              datesToAdd.push({ dateKey, newSchedule });
            }
          }

          handleBatchSchedules(datesToAdd, jobName, color);
          closeAddModal();
        }

        // è™•ç†æ‰¹é‡æ–°å¢çš„è¡Œç¨‹
        function handleBatchSchedules(datesToAdd, jobName, color) {
          let allOverlaps = [];
          let allNewSchedules = [];

          datesToAdd.forEach(({ dateKey, newSchedule }) => {
            const overlaps = findOverlaps(dateKey, newSchedule);
            if (overlaps.length > 0) {
              overlaps.forEach((overlap) => {
                allOverlaps.push({ dateKey, overlap, newSchedule });
              });
            } else {
              allNewSchedules.push({ dateKey, newSchedule });
            }
          });

          if (allOverlaps.length > 0) {
            isBatch = true;
            pendingOverlaps = allOverlaps;
            pendingIndex = 0;
            pendingDatesToAdd = allNewSchedules;
            showOverlapModal(pendingOverlaps, "batch");
          } else {
            allNewSchedules.forEach(({ dateKey, newSchedule }) => {
              addScheduleToStorage(dateKey, newSchedule, jobName);
            });
            updateSchedule();
            updateTotalHours();
            showToast(`å·²æ‰¹é‡æ–°å¢å·¥ä½œ: ${jobName}`, color);
          }
        }

        // å„²å­˜æŒ‡ä»¤æ–°å¢çš„è¡Œç¨‹
        function saveCommandSchedule() {
          const commandJobName = document
            .getElementById("commandJobName")
            .value.trim();
          const commandInputValue =
            document.getElementById("commandInput").value;
          const commands = commandInputValue
            .split("\n")
            .map((cmd) => cmd.trim())
            .filter((cmd) => cmd !== "");

          const jobName = commandJobName || "æŒ‡ä»¤æ–°å¢";
          const color = getColorForJob(jobName);

          const datesToAdd = [];

          commands.forEach((command) => {
            const parsedCommand = parseCommand(command);
            if (parsedCommand) {
              const { startDate, endDate, startTime, endTime, weekdays } =
                parsedCommand;

              for (
                let date = new Date(startDate);
                date <= endDate;
                date.setDate(date.getDate() + 1)
              ) {
                if (weekdays.length === 0 || weekdays.includes(date.getDay())) {
                  const dateKey = getLocalDateKey(new Date(date));
                  const scheduleId = Date.now() + Math.random();

                  const newSchedule = {
                    id: scheduleId,
                    jobName,
                    start: startTime,
                    end: endTime,
                    color: color,
                  };

                  datesToAdd.push({ dateKey, newSchedule });
                }
              }
            }
          });

          handleBatchSchedules(datesToAdd, jobName, color);
          closeAddModal();
        }

        // è§£ææŒ‡ä»¤æ–‡å­—ï¼Œè½‰æ›ç‚ºè¡Œç¨‹ç‰©ä»¶
        function parseCommand(command) {
          const commandRegex =
            /^(\d{1,2})\/(\d{1,2})(?:\s*[-~]\s*(\d{1,2})\/(\d{1,2}))?\s*([\d.:]{1,5})\s*[-~]\s*([\d.:]{1,5})(?:\s*[ï¼ˆ(]([^ï¼‰)]+)[)ï¼‰])?$/;
          const match = command.match(commandRegex);

          if (!match) {
            console.error(`æŒ‡ä»¤æ ¼å¼ä¸æ­£ç¢º: ${command}`);
            return null;
          }

          const startMonth = parseInt(match[1], 10);
          const startDay = parseInt(match[2], 10);
          const endMonth = match[3] ? parseInt(match[3], 10) : startMonth;
          const endDay = match[4] ? parseInt(match[4], 10) : startDay;
          const startTimeStr = match[5];
          const endTimeStr = match[6];
          const weekdaysStr = match[7] || "";

          const weekdays = weekdaysStr
            ? weekdaysStr
                .split(/[ã€,]/)
                .map((day) => "æ—¥ä¸€äºŒä¸‰å››äº”å…­".indexOf(day.trim()))
                .filter((day) => day !== -1)
            : [];

          const currentYear = new Date().getFullYear();

          const startDate = new Date(currentYear, startMonth - 1, startDay);
          const endDate = new Date(currentYear, endMonth - 1, endDay);

          const startTime = convertTime(startTimeStr);
          const endTime = convertTime(endTimeStr);

          if (!startTime || !endTime) {
            console.error(`ç„¡æ³•è§£ææ™‚é–“: ${startTimeStr} æˆ– ${endTimeStr}`);
            return null;
          }

          return {
            startDate,
            endDate,
            startTime,
            endTime,
            weekdays,
          };
        }

        // å°‡æ™‚é–“å­—ä¸²è½‰æ›ç‚ºæ¨™æº–æ ¼å¼
        function convertTime(timeStr) {
          if (timeStr.includes(":")) {
            const [hoursStr, minutesStr] = timeStr.split(":");
            const hours = parseInt(hoursStr, 10);
            const minutes = parseInt(minutesStr, 10);
            if (isNaN(hours) || isNaN(minutes)) {
              console.error(`ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼: ${timeStr}`);
              return null;
            }
            return `${String(hours).padStart(2, "0")}:${String(
              minutes
            ).padStart(2, "0")}`;
          } else if (timeStr.includes(".")) {
            const parts = timeStr.split(".");
            const hours = parseInt(parts[0], 10);
            let minutes = "00";
            if (parts[1]) {
              if (parts[1].length === 1) {
                if (parts[1] === "5") {
                  minutes = "30";
                } else {
                  minutes = `${parts[1]}0`;
                }
              } else if (parts[1].length === 2) {
                minutes = parts[1].padStart(2, "0");
              }
            }
            if (isNaN(hours) || isNaN(parseInt(minutes, 10))) {
              console.error(`ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼: ${timeStr}`);
              return null;
            }
            return `${String(hours).padStart(2, "0")}:${minutes}`;
          } else {
            const hours = parseInt(timeStr, 10);
            if (isNaN(hours)) {
              console.error(`ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼: ${timeStr}`);
              return null;
            }
            return `${String(hours).padStart(2, "0")}:00`;
          }
        }

        // åˆ‡æ›æ˜ŸæœŸçš„é¸æ“‡ç‹€æ…‹
        function toggleWeekdaySelection(event) {
          event.target.classList.toggle("selected");
        }

        // è‡ªå‹•å®ŒæˆåŠŸèƒ½
        function autocomplete(inp, arr) {
          let currentFocus;
          inp.addEventListener("input", function (e) {
            let a,
              b,
              i,
              val = this.value;
            closeAllLists();
            if (!val) {
              return false;
            }
            currentFocus = -1;
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            for (i = 0; i < arr.length; i++) {
              if (
                arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()
              ) {
                b = document.createElement("DIV");
                b.innerHTML =
                  "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                b.innerHTML += arr[i].substr(val.length);
                b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                b.addEventListener("click", function (e) {
                  inp.value = this.getElementsByTagName("input")[0].value;
                  closeAllLists();
                });
                a.appendChild(b);
              }
            }
          });
          inp.addEventListener("keydown", function (e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
              currentFocus++;
              addActive(x);
            } else if (e.keyCode == 38) {
              currentFocus--;
              addActive(x);
            } else if (e.keyCode == 13) {
              e.preventDefault();
              if (currentFocus > -1) {
                if (x) x[currentFocus].click();
              }
            }
          });
          function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = x.length - 1;
            x[currentFocus].classList.add("autocomplete-active");
          }
          function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
              x[i].classList.remove("autocomplete-active");
            }
          }
          function closeAllLists(elmnt) {
            let x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
              if (elmnt != x[i] && elmnt != inp) {
                x[i].parentNode.removeChild(x[i]);
              }
            }
          }
          document.addEventListener("click", function (e) {
            closeAllLists(e.target);
          });
        }

        // åˆ‡æ›æ–°å¢æ¨¡å¼ï¼ˆå–®æ¬¡ã€æ‰¹é‡ã€æŒ‡ä»¤ï¼‰
        function toggleAddMode(selectedMode) {
          singleAddToggle.classList.remove("active");
          batchAddToggle.classList.remove("active");
          commandToggle.classList.remove("active");

          singleAddContainer.style.display = "none";
          batchAddContainer.style.display = "none";
          commandContainer.style.display = "none";

          if (selectedMode === "single") {
            singleAddToggle.classList.add("active");
            singleAddContainer.style.display = "block";
          } else if (selectedMode === "multi") {
            batchAddToggle.classList.add("active");
            batchAddContainer.style.display = "block";
          } else if (selectedMode === "command") {
            commandToggle.classList.add("active");
            commandContainer.style.display = "block";
          }
        }

        // ç¶å®šäº‹ä»¶ç›£è½å™¨
        addButton.addEventListener("click", () => {
          openAddModal();
        });

        closeAddBtn.addEventListener("click", closeAddModal);
        closeEditBtn.addEventListener("click", closeEditModal);
        closeViewDayBtn.addEventListener("click", closeViewDayModal);
        closeOverlapModalBtn.addEventListener("click", closeOverlapModal);

        window.addEventListener("click", (event) => {
          if (event.target == modalAdd) {
            closeAddModal();
          }
          if (event.target == modalEdit) {
            closeEditModal();
          }
          if (event.target == modalViewDay) {
            closeViewDayModal();
          }
          if (event.target == overlapModal) {
            closeOverlapModal();
          }
        });

        singleAddToggle.addEventListener("click", () => {
          toggleAddMode("single");
        });

        batchAddToggle.addEventListener("click", () => {
          toggleAddMode("multi");
        });

        commandToggle.addEventListener("click", () => {
          toggleAddMode("command");
        });

        prevWeekBtn.addEventListener("click", () => updateWeek(-1));
        nextWeekBtn.addEventListener("click", () => updateWeek(1));

        addForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveAddSchedule();
        });

        batchAddForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveBatchAddSchedule();
        });

        commandForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveCommandSchedule();
        });

        editForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveEditSchedule();
        });

        // æ›´æ–°æ™‚é–“åˆ»åº¦
        function updateTimeScale() {
          const timeScale = document.querySelector(".time-scale");
          timeScale.innerHTML = "";

          for (let i = 7; i <= 23; i++) {
            const timeSlot = document.createElement("div");
            timeSlot.classList.add("time-slot");
            timeSlot.innerHTML = `${
              i < 12 ? "æ—©ä¸Š" : i < 18 ? "ä¸‹åˆ" : "æ™šä¸Š"
            } ${i % 12 || 12}:00`;
            timeScale.appendChild(timeSlot);
          }
        }

        // å¡«å……æ™‚é–“é¸é …
        function populateTimeOptions() {
          const hours = [...Array(24).keys()].map((i) =>
            String(i).padStart(2, "0")
          );
          const minutes = [];
          for (let i = 0; i < 60; i += 5) {
            minutes.push(String(i).padStart(2, "0"));
          }

          function addOptions(select, options) {
            select.innerHTML = "";
            options.forEach((option) => {
              const opt = document.createElement("option");
              opt.value = option;
              opt.textContent = option;
              select.appendChild(opt);
            });
          }

          [
            "addStartHour",
            "addEndHour",
            "editStartHour",
            "editEndHour",
            "batchAddStartHour",
            "batchAddEndHour",
          ].forEach((id) => {
            addOptions(document.getElementById(id), hours);
          });

          [
            "addStartMinute",
            "addEndMinute",
            "editStartMinute",
            "editEndMinute",
            "batchAddStartMinute",
            "batchAddEndMinute",
          ].forEach((id) => {
            addOptions(document.getElementById(id), minutes);
          });
        }

        // é‡ç½®æ–°å¢è¡¨å–®
        function resetAddForms() {
          addForm.reset();
          batchAddForm.reset();
          commandForm.reset();
          document.querySelectorAll(".weekday").forEach((day) => {
            day.classList.remove("selected");
          });
          toggleAddMode("single");
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        generateWeekGrid();
        updateDates();
        updateTimeScale();
        requestAnimationFrame(() => {
          updateSchedule();
          updateTotalHours();
        });
        autocomplete(jobNameInputAdd, jobNames);
        autocomplete(jobNameInputBatchAdd, jobNames);
        autocomplete(jobNameInputEdit, jobNames);
        autocomplete(commandJobNameInput, jobNames);
        populateTimeOptions();

        document.querySelectorAll(".weekday").forEach((day) => {
          day.addEventListener("click", toggleWeekdaySelection);
        });

        let lastTouchEnd = 0;
        document.addEventListener(
          "touchend",
          function (event) {
            let now = new Date().getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          },
          false
        );
      });

      // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•¸ï¼Œä¾›å…¶ä»–åœ°æ–¹ä½¿ç”¨
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      }
    </script>
  </body>
</html>
