<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>智慧 Prompt 生成器</title>
    <link rel="icon" href="img/ai.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="img/ai.ico" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@700&display=swap"
      rel="stylesheet"
    />
    <!-- 引入 JSZip 庫 -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      /* 原有樣式保持不變 */

      :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --danger: #ef4444;
        --danger-dark: #dc2626;
        --warning: #f59e0b;
        --warning-dark: #d97706;
        --success: #22c55e;
        --success-dark: #16a34a;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: all 0.2s ease;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        padding: 2rem;
        background-color: var(--gray-100);
        color: var(--gray-800);
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-md);
      }

      /* Modal 樣式 */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-md);
        max-width: 90%;
        width: 400px;
        transform: translateY(20px);
        transition: all 0.3s ease;
        position: relative;
      }

      .modal-backdrop.show .modal-content {
        transform: translateY(0);
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 1rem;
        font-family: "Playfair Display", serif;
      }

      .modal-body {
        margin-bottom: 1.5rem;
        color: var(--gray-600);
        font-size: 0.9375rem;
        line-height: 1.5;
      }

      .modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      .modal-btn {
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
      }

      .modal-btn-primary {
        background: var(--primary);
        color: white;
      }

      .modal-btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .modal-btn-secondary {
        background: var(--gray-100);
        color: var(--gray-700);
      }

      .modal-btn-secondary:hover {
        background: var(--gray-200);
      }

      /* 標題樣式 */
      .header {
        text-align: center;
        margin-bottom: 2.5rem;
        position: relative;
        padding-top: 1rem;
      }

      .logo {
        width: 64px;
        height: 64px;
        margin: 0 auto 1rem;
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .header .title-ch {
        font-family: "Playfair Display", "Dancing Script", serif;
        font-weight: 700;
        font-size: 2.25rem;
        background: linear-gradient(
          135deg,
          var(--primary),
          #818cf8 50%,
          #6366f1
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        display: inline-block;
        margin-bottom: 0.5rem;
      }

      .header .title-ch::after {
        content: "";
        position: absolute;
        bottom: -0.25rem;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(135deg, var(--primary), transparent);
        transform: scaleX(0.8);
        opacity: 0.5;
      }

      .header .title-en {
        font-family: "Dancing Script", cursive;
        font-size: 1.75rem;
        color: var(--gray-500);
        letter-spacing: 0.05em;
        margin-top: 0.75rem;
        transform: rotate(-2deg);
        display: block;
      }

      .header p {
        color: var(--gray-600);
        margin-top: 1rem;
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        .container {
          padding: 1rem;
        }

        .header {
          margin-bottom: 2rem;
        }

        .logo {
          width: 48px;
          height: 48px;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .header .title-en {
          font-size: 1rem;
        }

        .modal-content {
          padding: 1.5rem;
        }
      }

      /* 上傳區域樣式 */
      .upload-section {
        margin-bottom: 2rem;
        padding: 2rem;
        border: 2px dashed var(--gray-300);
        border-radius: 0.75rem;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.3s ease;
      }

      .upload-section:hover,
      .upload-section.drag-over {
        border-color: var(--primary);
        background: #f5f7ff;
      }

      .upload-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 1rem;
        color: var(--gray-400);
      }

      .upload-section:hover .upload-icon {
        color: var(--primary);
        transform: scale(1.1);
      }

      .file-input {
        display: none;
      }

      .upload-button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        margin-top: 1rem;
      }

      .upload-button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .upload-button svg {
        width: 20px;
        height: 20px;
      }

      /* 隱私設定區域 */
      .privacy-settings {
        margin: 1.5rem 0;
        padding: 1.25rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid var(--gray-200);
      }

      .privacy-settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .privacy-settings-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .privacy-settings-icon {
        color: var(--warning);
      }

      .privacy-options {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.75rem;
      }

      .privacy-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
      }

      .privacy-option:hover {
        background: var(--gray-100);
      }

      .privacy-checkbox {
        appearance: none;
        width: 1.125rem;
        height: 1.125rem;
        border: 2px solid var(--gray-400);
        border-radius: 0.25rem;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .privacy-checkbox:checked {
        background: var(--primary);
        border-color: var(--primary);
      }

      .privacy-checkbox:checked::after {
        content: "";
        position: absolute;
        top: 0.125rem;
        left: 0.3125rem;
        width: 0.375rem;
        height: 0.625rem;
        border: solid white;
        border-width: 0 0.125rem 0.125rem 0;
        transform: rotate(45deg);
      }

      .privacy-label {
        font-size: 0.875rem;
        color: var(--gray-700);
        cursor: pointer;
      }

      .privacy-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.125rem 0.375rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 500;
        margin-left: 0.375rem;
      }

      .badge-sensitive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      /* 文件列表樣式 */
      .file-list {
        margin-top: 2rem;
        margin-bottom: 2rem;
        display: grid;
        gap: 0.75rem;
      }

      .file-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .file-list-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
      }

      .download-all-button {
        background: var(--success);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
      }

      .download-all-button:hover {
        background: var(--success-dark);
        transform: translateY(-1px);
      }

      .download-all-button svg {
        width: 20px;
        height: 20px;
      }

      .file-item {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: 0.5rem;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--gray-200);
        transform-origin: center;
        animation: slideIn 0.3s ease;
      }

      .file-item.sensitive-file {
        border-left: 3px solid var(--warning);
      }

      .file-item.hidden-file {
        opacity: 0.6;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .file-item:hover {
        background: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
      }

      .file-item.dragging {
        opacity: 0.5;
        background: var(--gray-100);
        box-shadow: var(--shadow-md);
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .file-icon {
        width: 24px;
        height: 24px;
        color: var(--primary);
      }

      .file-icon.sensitive {
        color: var(--warning);
      }

      .file-path {
        color: var(--gray-700);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .file-actions {
        display: flex;
        gap: 0.5rem;
      }

      /* 空檔案樣式 */
      .empty-file {
        background-color: #fafafa;
      }

      .empty-file .file-path::after {
        content: " (空)";
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-left: 0.25rem;
      }

      .tag-empty {
        background: rgba(107, 114, 128, 0.1);
        color: var(--gray-500);
      }

      .action-btn {
        background: transparent;
        color: var(--gray-400);
        border: none;
        padding: 0.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        background: var(--gray-100);
      }

      .action-btn.download:hover {
        color: var(--success);
        background: var(--gray-100);
      }

      .action-btn.delete:hover {
        color: var(--danger);
        background: var(--gray-100);
      }

      .action-btn.toggle-sensitive:hover {
        color: var(--warning);
        background: var(--gray-100);
      }

      .action-btn svg {
        width: 20px;
        height: 20px;
      }

      /* 版本控制樣式 */
      .version-control {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--gray-200);
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .version-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        outline: none;
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .version-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
      }

      .save-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
      }

      .save-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .save-btn svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      .saved-versions {
        margin-top: 1.5rem;
        display: grid;
        gap: 0.75rem;
      }

      .version-item {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--gray-200);
        animation: fadeIn 0.3s ease;
        transition: all 0.2s ease;
      }

      .version-item:hover {
        background: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
      }

      .version-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .version-name {
        font-weight: 500;
        color: var(--gray-800);
      }

      .version-time {
        font-size: 0.75rem;
        color: var(--gray-500);
        line-height: 1.4;
      }

      .version-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .delete-version-btn {
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: var(--danger);
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .delete-version-btn:hover {
        background: var(--gray-100);
        color: var(--danger-dark);
      }

      .delete-version-btn svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      /* 輸出區域樣式 */
      .output-container {
        position: relative;
        margin-top: 1.5rem;
        display: none;
      }

      .output-container.show {
        display: block;
      }

      .copy-btn-container {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
      }

      .output-tabs {
        display: flex;
        margin-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .output-tab {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-right: 0.75rem;
        color: var(--gray-600);
        transition: all 0.2s ease;
      }

      .output-tab:hover {
        color: var(--primary);
      }

      .output-tab.active {
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
        font-weight: 500;
      }

      .copy-btn {
        display: flex;
        gap: 0.25rem;
        align-items: center;
        padding: 0.25rem 1rem;
        background: var(--gray-50);
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.75rem;
        color: var(--gray-600);
        transition: all 0.2s ease;
      }

      .copy-btn:hover {
        background: var(--gray-100);
      }

      .copy-btn svg {
        width: 1rem;
        height: 1rem;
      }

      .copy-btn.copied {
        background: var(--gray-100);
        color: var(--gray-700);
      }

      .output {
        background: var(--gray-800);
        color: var(--gray-100);
        padding: 1.5rem;
        border-radius: 0.75rem;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        position: relative;
        overflow-x: auto;
      }

      .output-pane {
        display: none;
      }

      .output-pane.active {
        display: block;
      }

      /* 新增吐司訊息樣式 */
      #toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      /* 響應式調整 */
      @media (max-width: 768px) {
        .privacy-options {
          grid-template-columns: 1fr;
        }

        .version-actions {
          flex-direction: column;
          gap: 0.25rem;
        }

        .version-actions .save-btn {
          padding: 0.4rem 0.75rem;
          font-size: 0.8125rem;
        }

        .version-item {
          flex-direction: column;
          gap: 0.75rem;
          align-items: flex-start;
        }

        .version-info {
          width: 100%;
        }

        .version-actions {
          width: 100%;
          flex-direction: row;
          justify-content: flex-end;
        }

        .copy-btn {
          padding: 0.25rem 0.75rem;
        }

        .file-list-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .download-all-button {
          width: 100%;
          justify-content: center;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 新增的預設隱藏標籤 */
      .tag {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 500;
        margin-left: 0.375rem;
      }

      .tag-sensitive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      .tag-hidden {
        background: rgba(107, 114, 128, 0.1);
        color: var(--gray-500);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <svg
          class="logo"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 2L2 7L12 12L22 7L12 2Z"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M2 17L12 22L22 17"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M2 12L12 17L22 12"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <circle cx="12" cy="12" r="2" fill="var(--primary)" />
        </svg>
        <h1>
          <span class="title-ch">智慧 Prompt 生成器</span>
          <span class="title-en">Smart Prompt Generator</span>
        </h1>
        <p>快速整理並生成結構化的 AI 提示文件</p>
      </div>

      <div class="upload-section" id="dropZone">
        <svg
          class="upload-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
        <input
          type="file"
          id="fileInput"
          class="file-input"
          multiple
          webkitdirectory
          directory
        />
        <p>拖放檔案或資料夾至此，或</p>
        <button
          class="upload-button"
          onclick="document.getElementById('fileInput').click()"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          選擇檔案或資料夾
        </button>
      </div>

      <!-- 隱私設定區域 -->
      <div class="privacy-settings" id="privacySettings" style="display: none">
        <div class="privacy-settings-header">
          <div class="privacy-settings-title">
            <svg
              class="privacy-settings-icon"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            隱私檔案設定
          </div>
          <button class="action-btn toggle-all" id="toggleAllPrivacy">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            全部顯示/隱藏
          </button>
        </div>
        <div class="privacy-options" id="privacyOptions">
          <!-- 隱私選項將在這裡動態生成 -->
        </div>
      </div>

      <div class="file-list" id="fileList">
        <!-- 檔案列表將在有檔案時動態生成 -->
      </div>

      <div class="version-control">
        <input
          type="text"
          class="version-input"
          id="versionName"
          placeholder="輸入版本名稱"
        />
        <button class="save-btn" onclick="saveVersion()">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
            />
            <polyline points="17 21 17 13 7 13 7 21" />
            <polyline points="7 3 7 8 15 8" />
          </svg>
          儲存版本
        </button>
      </div>

      <div class="saved-versions" id="savedVersions"></div>

      <div class="output-container" id="outputContainer">
        <div class="output-tabs">
          <div class="output-tab active" data-tab="content">檔案內容</div>
          <div class="output-tab" data-tab="structure">檔案結構</div>
        </div>
        <div class="copy-btn-container">
          <button class="copy-btn" onclick="copyOutput()" id="copyButton">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              class="icon-xs"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z"
                fill="currentColor"
              />
            </svg>
            複製
          </button>
        </div>
        <div class="output-pane active" id="contentPane">
          <pre class="output" id="output"></pre>
        </div>
        <div class="output-pane" id="structurePane">
          <pre class="output" id="structureOutput"></pre>
        </div>
      </div>
    </div>

    <!-- 模態框 -->
    <div id="modal" class="modal-backdrop">
      <div class="modal-content">
        <div class="modal-title" id="modalTitle"></div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>

    <!-- 吐司訊息容器 -->
    <div id="toast"></div>

    <script>
      let files = [];
      let savedVersions = [];
      let draggedItem = null;

      // 定義敏感性和隱私檔案擴展名
      const sensitiveExtensions = [
        "env",
        "env.example",
        "htpasswd",
        "pem",
        "key",
        "cert",
        "credentials",
        "secret",
      ];

      // 定義文本和二進位檔案的擴展名
      const textExtensions = [
        "js",
        "py",
        "java",
        "cpp",
        "html",
        "css",
        "jsx",
        "ts",
        "tsx",
        "php",
        "blade.php",
        "json",
        "md",
        "txt",
        "csv",
        "xml",
        "yml",
        "yaml",
        "sql",
        "conf",
        "gitignore",
        "dockerignore",
        "ps1",
        "sh",
        "env",
        "env.example",
        "htpasswd",
        "log",
        "config",
        "ini",
      ];

      const binaryExtensions = [
        "jpg",
        "jpeg",
        "png",
        "gif",
        "bmp",
        "svg",
        "ico",
        "pdf",
        "zip",
        "rar",
        "7z",
        "exe",
        "dll",
        "bin",
      ];

      // 初始化
      document.addEventListener("DOMContentLoaded", () => {
        setupDragAndDrop();
        setupFileInput();
        loadSavedVersions();
        setupOutputTabs();
      });

      // 設置輸出標籤頁切換
      function setupOutputTabs() {
        const tabs = document.querySelectorAll(".output-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            // 移除所有標籤頁和面板的 active 類
            document
              .querySelectorAll(".output-tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".output-pane")
              .forEach((p) => p.classList.remove("active"));

            // 添加當前標籤頁和對應面板的 active 類
            tab.classList.add("active");
            const tabId = tab.getAttribute("data-tab");
            document.getElementById(`${tabId}Pane`).classList.add("active");
          });
        });
      }

      // 從 localStorage 載入已儲存的版本
      function loadSavedVersions() {
        try {
          const savedData = localStorage.getItem("promptVersions");
          if (savedData) {
            savedVersions = JSON.parse(savedData);
            updateVersionsList();
          }
        } catch (err) {
          console.error("載入版本失敗:", err);
        }
      }

      // 儲存版本到 localStorage
      function saveVersionsToStorage() {
        try {
          localStorage.setItem("promptVersions", JSON.stringify(savedVersions));
        } catch (err) {
          console.error("儲存版本失敗:", err);
        }
      }

      // 設置拖放功能
      function setupDragAndDrop() {
        const dropZone = document.getElementById("dropZone");

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("drag-over");
        });

        dropZone.addEventListener("dragleave", () => {
          dropZone.classList.remove("drag-over");
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("drag-over");
          handleFiles(e.dataTransfer.files);
        });
      }

      // 設置文件輸入
      function setupFileInput() {
        document.getElementById("fileInput").addEventListener("change", (e) => {
          handleFiles(e.target.files);
        });
      }

      // 處理文件
      async function handleFiles(fileList) {
        let failedFiles = [];
        let hasSensitiveFiles = false;

        for (const file of fileList) {
          // 檢查是否為檔案
          if (!file.type && file.size === 0 && !file.name) {
            console.warn(`跳過非檔案項目：未知檔案`);
            continue;
          }

          try {
            console.log(`開始讀取檔案：${file.name}，大小：${file.size} 字節`);
            const { content, type, isEmpty } = await readFileContent(file);
            const fileName = file.name.toLowerCase();
            const filePath = file.webkitRelativePath || file.name;

            // 檢查是否為敏感檔案
            const isSensitive = checkIfSensitiveFile(fileName, filePath);
            if (isSensitive) {
              hasSensitiveFiles = true;
            }

            files.push({
              id: Math.random().toString(36).substr(2, 9),
              name: file.name,
              path: filePath,
              content,
              type,
              isSensitive,
              isHidden: isSensitive, // 預設隱藏敏感檔案
              isEmpty: isEmpty || file.size === 0, // 明確標記空檔案
            });

            if (isEmpty || file.size === 0) {
              console.log(`檔案 ${file.name} 是空檔案`);
            }

            console.log(`成功讀取檔案：${file.name}`);
          } catch (err) {
            console.error(`讀取檔案失敗：${file.name}`, err);
            failedFiles.push(file.name);
          }
        }

        if (failedFiles.length > 0) {
          showModal(
            "讀取部分檔案失敗",
            `無法讀取以下檔案：\n${failedFiles.join("\n")}`,
            [{ text: "確認", onClick: "hideModal()", primary: true }]
          );
        }

        if (hasSensitiveFiles) {
          showModal(
            "偵測到敏感檔案",
            "已自動標記並隱藏可能包含敏感資訊的檔案。您可以在「隱私檔案設定」中調整顯示設定。",
            [{ text: "了解", onClick: "hideModal()", primary: true }]
          );
        }

        // 最後添加調試輸出
        console.log("處理後的檔案列表:", files);
        console.log("空檔案數量:", files.filter((f) => f.isEmpty).length);
        console.log(
          "空檔案列表:",
          files.filter((f) => f.isEmpty).map((f) => f.name)
        );

        updateUI();
        updatePrivacySettings();

        // 設置切換全部隱私檔案顯示/隱藏的按鈕
        document
          .getElementById("toggleAllPrivacy")
          .addEventListener("click", toggleAllPrivacyFiles);
      }

      // 檢查是否為敏感檔案
      function checkIfSensitiveFile(fileName, filePath) {
        // 檢查檔案副檔名或名稱特徵
        if (
          fileName.endsWith(".env") ||
          fileName.includes(".env.") ||
          fileName.endsWith(".htpasswd") ||
          fileName.endsWith(".pem") ||
          fileName.endsWith(".key") ||
          fileName === ".gitignore" ||
          fileName === ".dockerignore"
        ) {
          return true;
        }

        // 檢查檔案路徑中的關鍵字
        const sensitiveKeywords = [
          "secret",
          "password",
          "credential",
          "token",
          "auth",
          "key",
          "pem",
          "cert",
        ];
        const lowerPath = filePath.toLowerCase();

        return sensitiveKeywords.some((keyword) => lowerPath.includes(keyword));
      }

      // 更新隱私設定區域
      function updatePrivacySettings() {
        const privacySettings = document.getElementById("privacySettings");
        const privacyOptions = document.getElementById("privacyOptions");

        // 檢查是否有敏感檔案
        const sensitiveFiles = files.filter((file) => file.isSensitive);

        if (sensitiveFiles.length > 0) {
          privacySettings.style.display = "block";

          // 清除現有選項
          privacyOptions.innerHTML = "";

          // 生成隱私選項
          sensitiveFiles.forEach((file) => {
            const optionDiv = document.createElement("div");
            optionDiv.className = "privacy-option";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "privacy-checkbox";
            checkbox.id = `privacy-${file.id}`;
            checkbox.checked = !file.isHidden;
            checkbox.addEventListener("change", () =>
              toggleFileVisibility(file.id, !checkbox.checked)
            );

            const label = document.createElement("label");
            label.className = "privacy-label";
            label.htmlFor = `privacy-${file.id}`;
            label.textContent = file.path;

            const badge = document.createElement("span");
            badge.className = "privacy-badge badge-sensitive";
            badge.textContent = "敏感";

            label.appendChild(badge);
            optionDiv.appendChild(checkbox);
            optionDiv.appendChild(label);
            privacyOptions.appendChild(optionDiv);
          });
        } else {
          privacySettings.style.display = "none";
        }
      }

      // 切換檔案可見性
      function toggleFileVisibility(fileId, isHidden) {
        const fileIndex = files.findIndex((f) => f.id === fileId);
        if (fileIndex !== -1) {
          files[fileIndex].isHidden = isHidden;
          updateUI();
        }
      }

      // 切換所有隱私檔案的顯示/隱藏
      function toggleAllPrivacyFiles() {
        // 檢查目前是否有隱藏的敏感檔案
        const hasHiddenFiles = files.some(
          (file) => file.isSensitive && file.isHidden
        );

        // 根據目前狀態切換所有敏感檔案的顯示/隱藏
        files.forEach((file) => {
          if (file.isSensitive) {
            file.isHidden = !hasHiddenFiles;
          }
        });

        // 更新 UI 和隱私設定
        updateUI();
        updatePrivacySettings();
      }

      // 讀取文件內容
      function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          const ext = file.name.split(".").pop().toLowerCase();
          const fileName = file.name.toLowerCase();
          let typeCategory = "binary";

          // 檢查文件是否為空
          if (file.size === 0) {
            // 對於空檔案，直接返回空內容但標記為文字類型
            resolve({ content: "", type: "text", isEmpty: true });
            return;
          }

          if (
            textExtensions.includes(ext) ||
            fileName === ".gitignore" ||
            fileName === ".dockerignore" ||
            fileName.endsWith(".env") ||
            fileName.includes(".env.")
          ) {
            typeCategory = "text";
          } else if (binaryExtensions.includes(ext)) {
            typeCategory = "binary";
          } else {
            // 嘗試識別無擴展名的文本文件
            if (
              file.type.startsWith("text/") ||
              file.type === "application/json" ||
              file.type === "application/xml"
            ) {
              typeCategory = "text";
            } else {
              typeCategory = "binary";
            }
          }

          if (typeCategory === "text") {
            reader.onload = (e) => {
              const content = e.target.result || "";
              const isEmpty = content.length === 0;
              resolve({ content, type: "text", isEmpty });
            };
            reader.onerror = (e) => {
              console.error(`FileReader 錯誤：${file.name}`, e);
              reject(e);
            };
            reader.readAsText(file);
          } else {
            reader.onload = (e) => {
              const content = e.target.result;
              const isEmpty = content && content.byteLength === 0;
              resolve({ content, type: "binary", isEmpty });
            };
            reader.onerror = (e) => {
              console.error(`FileReader 錯誤：${file.name}`, e);
              reject(e);
            };
            reader.readAsArrayBuffer(file);
          }
        });
      }
      // 獲取文件類型
      function getFileType(filename) {
        const ext = filename.split(".").pop().toLowerCase();

        // 新增對 .md 的明確處理
        if (
          textExtensions.includes(ext) ||
          filename === ".gitignore" ||
          filename === ".dockerignore" ||
          filename.endsWith(".env") ||
          filename.includes(".env.") ||
          ext === "md"
        ) {
          return "text";
        } else if (binaryExtensions.includes(ext)) {
          return "binary";
        } else {
          return "unknown";
        }
      }

      // 獲取文件語言 (用於程式碼高亮)
      function getFileLanguage(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const fileName = filename.toLowerCase();

        // 特殊檔案類型處理
        if (fileName === ".gitignore" || fileName === ".dockerignore") {
          return "text";
        }

        if (fileName.endsWith(".env") || fileName.includes(".env.")) {
          return "env";
        }

        if (fileName.endsWith(".htpasswd")) {
          return "htpasswd";
        }

        if (ext === "ps1") {
          return "powershell";
        }

        if (ext === "sh") {
          return "bash";
        }

        if (ext === "conf") {
          return "nginx";
        }

        if (ext === "md") {
          return "markdown";
        }

        // 一般檔案類型處理
        const extToLanguage = {
          js: "javascript",
          jsx: "jsx",
          ts: "typescript",
          tsx: "tsx",
          py: "python",
          java: "java",
          cpp: "cpp",
          c: "c",
          cs: "csharp",
          php: "php",
          html: "html",
          css: "css",
          json: "json",
          xml: "xml",
          md: "markdown",
          sql: "sql",
          yml: "yaml",
          yaml: "yaml",
        };

        return extToLanguage[ext] || "text";
      }
      // 更新UI
      function updateUI() {
        updateFileList();
        updateOutput();
        updateVersionsList();
      }

      // 更新文件列表
      function updateFileList() {
        const fileList = document.getElementById("fileList");

        if (files.length === 0) {
          fileList.innerHTML = "";
          return;
        }

        // 清除現有列表內容
        fileList.innerHTML = `
        <div class="file-list-header">
          <h2>檔案列表</h2>
          <button class="download-all-button" onclick="downloadAllFiles()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
              <polyline points="12 15 12 3" />
              <path d="M16 11l-4 4-4-4" />
            </svg>
            下載全部
          </button>
        </div>
      `;

        files.forEach((file, index) => {
          // 跳過隱藏的檔案
          if (file.isHidden) {
            return;
          }

          const fileItem = document.createElement("div");
          fileItem.classList.add("file-item");
          if (file.isSensitive) {
            fileItem.classList.add("sensitive-file");
          }
          if (file.isEmpty) {
            fileItem.classList.add("empty-file"); // 可以添加一個特殊的 CSS 類
          }
          fileItem.setAttribute("draggable", "true");
          fileItem.dataset.index = index;

          // 根據文件類型顯示不同的圖示和內容
          let displayContent = "";
          let icon = "";

          const fileName = file.name.toLowerCase();
          const ext = file.name.split(".").pop().toLowerCase();

          // 首先檢查是否為空檔案
          if (file.isEmpty) {
            icon = `
        <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
          <polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      `;
            displayContent = `<span class="file-path">${file.path} <span class="tag">空檔案</span></span>`;
          }
          // 然後檢查各種特殊檔案類型...
          else if (file.type === "text") {
            // 特殊文件類型處理
            if (fileName.endsWith(".env") || fileName.includes(".env.")) {
              icon = `
              <svg class="file-icon sensitive" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            `;
              displayContent = `<span class="file-path">${file.path} <span class="tag tag-sensitive">環境配置</span></span>`;
            } else if (fileName.endsWith(".htpasswd")) {
              icon = `
              <svg class="file-icon sensitive" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            `;
              displayContent = `<span class="file-path">${file.path} <span class="tag tag-sensitive">密碼檔</span></span>`;
            } else if (
              fileName === ".gitignore" ||
              fileName === ".dockerignore"
            ) {
              icon = `
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8 0-4.42 3.58-8 8-8 4.42 0 8 3.58 8 8 0 4.42-3.58 8-8 8z"/>
                <line x1="8" y1="12" x2="16" y2="12"/>
              </svg>
            `;
              displayContent = `<span class="file-path">${file.path} <span class="tag">忽略檔</span></span>`;
            } else if (ext === "conf") {
              icon = `
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
            `;
              displayContent = `<span class="file-path">${file.path} <span class="tag">設定檔</span></span>`;
            } else if (ext === "sh") {
              icon = `
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 21V8a3 3 0 0 1 3-3h5.379a2 2 0 0 1 1.414.586l5.621 5.621a2 2 0 0 1 .586 1.414V21a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1z"></path>
                <path d="M14 3v4a2 2 0 0 0 2 2h4"></path>
                <line x1="8" y1="15" x2="10" y2="17"></line>
                <line x1="11" y1="15" x2="13" y2="17"></line>
                <line x1="14" y1="15" x2="16" y2="17"></line>
              </svg>
            `;
              displayContent = `<span class="file-path">${file.path} <span class="tag">Shell 腳本</span></span>`;
            } else if (ext === "ps1") {
              icon = `
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 21V8a3 3 0 0 1 3-3h5.379a2 2 0 0 1 1.414.586l5.621 5.621a2 2 0 0 1 .586 1.414V21a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1z"></path>
                <path d="M14 3v4a2 2 0 0 0 2 2h4"></path>
                <polyline points="10,12 14,16"></polyline>
                <polyline points="14,12 10,16"></polyline>
              </svg>
            `;
              displayContent = `<span class="file-path">${file.path} <span class="tag">PowerShell</span></span>`;
            } else if (ext === "sql") {
              icon = `
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16v16H4V4z"></path>
                <polyline points="4 10 12 14 20 10"></polyline>
              </svg>
            `;
              displayContent = `<span class="file-path">${file.path} <span class="tag">SQL 檔案</span></span>`;
            } else {
              icon = `
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
            `;
              displayContent = `<span class="file-path">${file.path}</span>`;
            }
          } else if (file.type === "binary") {
            icon = `
            <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
          `;
            displayContent = `<span class="file-path">${file.path} <span class="tag">二進位檔案</span></span>`;
          } else if (ext === "md") {
            icon = `
            <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
          `;
            displayContent = `<span class="file-path">${file.path} <span class="tag">Markdown</span></span>`;
          } else {
            icon = `
            <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
          `;
            displayContent = `<span class="file-path">${file.path} <span class="tag">未知類型</span></span>`;
          }

          fileItem.innerHTML = `
          <div class="file-info">
            ${icon}
            ${displayContent}
          </div>
          <div class="file-actions">
            <button class="action-btn download" onclick="downloadFile('${
              file.id
            }')" title="下載檔案">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
              <button class="action-btn delete" onclick="deleteFile('${
                file.id
              }')" title="刪除檔案">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
              ${
                file.isSensitive
                  ? `
              <button class="action-btn toggle-sensitive" onclick="toggleFileVisibility('${file.id}', true)" title="隱藏敏感檔案">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                  <line x1="3" y1="3" x2="21" y2="21"></line>
                </svg>
              </button>
              `
                  : ""
              }
            </div>
          `;

          // 設置拖放排序事件
          fileItem.addEventListener("dragstart", handleDragStart);
          fileItem.addEventListener("dragend", handleDragEnd);
          fileItem.addEventListener("dragover", handleDragOver);
          fileItem.addEventListener("drop", handleDrop);

          fileList.appendChild(fileItem);
        });
      }

      // 刪除文件
      function deleteFile(id) {
        files = files.filter((file) => file.id !== id);
        updateUI();
        updatePrivacySettings();
      }

      // 下載單個文件
      function downloadFile(id) {
        const file = files.find((f) => f.id === id);
        if (!file) {
          showModal("下載失敗", "找不到該檔案。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          return;
        }

        let blob;
        let filename = file.name;

        if (file.type === "text") {
          blob = new Blob([file.content], { type: "text/plain" });
        } else if (file.type === "binary") {
          blob = new Blob([file.content]);
        } else {
          blob = new Blob([file.content]);
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        showToast(`已下載：${filename}`);
      }

      // 下載全部文件
      async function downloadAllFiles() {
        if (files.length === 0) {
          showToast("沒有檔案可供下載");
          return;
        }

        if (typeof JSZip === "undefined") {
          showModal("下載失敗", "JSZip 未正確載入，無法壓縮檔案。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          console.error("JSZip 未定義");
          return;
        }

        const zip = new JSZip();

        files.forEach((file) => {
          if (file.type === "text") {
            zip.file(file.path, file.content);
          } else if (file.type === "binary") {
            zip.file(file.path, file.content, { binary: true });
          } else {
            zip.file(file.path, file.content);
          }
        });

        try {
          const blob = await zip.generateAsync({ type: "blob" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "all_files.zip";
          a.click();
          URL.revokeObjectURL(url);

          showToast("已下載全部檔案");
        } catch (err) {
          console.error("下載失敗:", err);
          showModal("下載失敗", "下載失敗，請稍後再試。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
        }
      }

      // 產生檔案架構
      function generateFileStructure() {
        let structure = "# 檔案結構\n\n```\n";
        const dirMap = {};

        // 建立目錄映射 - 確保所有檔案都被處理，不論是否為空
        files.forEach((file) => {
          const parts = file.path.split("/");
          let currentPath = "";

          for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            const parentPath = i === 0 ? "" : parts.slice(0, i).join("/");
            const path = i === 0 ? part : `${parentPath}/${part}`;

            if (!dirMap[path]) {
              dirMap[path] = {
                name: part,
                parent: parentPath,
                isDir: true,
              };
            }

            currentPath = path;
          }

          // 添加檔案 - 所有檔案都應該加入，包括空檔案
          const fileName = parts[parts.length - 1];
          const filePath =
            parts.length > 1 ? `${currentPath}/${fileName}` : fileName;

          dirMap[filePath] = {
            name: fileName,
            parent: currentPath,
            isDir: false,
            isHidden: file.isHidden,
            isSensitive: file.isSensitive,
            isEmpty: !file.content || file.content.length === 0, // 標記空檔案
          };
        });

        // 建立結構字串
        function buildStructure(path, indent = 0) {
          let result = "";

          const children = Object.values(dirMap).filter(
            (item) => item.parent === path
          );

          const dirs = children.filter((item) => item.isDir);
          const fileItems = children.filter((item) => !item.isDir);

          dirs.sort((a, b) => a.name.localeCompare(b.name));
          fileItems.sort((a, b) => a.name.localeCompare(b.name));

          dirs.forEach((dir) => {
            result += `${" ".repeat(indent)}📁 ${dir.name}/\n`;
            result += buildStructure(
              dir.name === ""
                ? dir.name
                : path
                ? `${path}/${dir.name}`
                : dir.name,
              indent + 2
            );
          });

          fileItems.forEach((file) => {
            if (!file.isHidden) {
              if (file.isSensitive) {
                result += `${" ".repeat(indent)}🔒 ${file.name}${
                  file.isEmpty ? " (空檔案)" : ""
                }\n`;
              } else if (file.isEmpty) {
                result += `${" ".repeat(indent)}📄 ${file.name} (空檔案)\n`;
              } else {
                result += `${" ".repeat(indent)}📄 ${file.name}\n`;
              }
            }
          });

          return result;
        }

        structure += buildStructure("");
        structure += "```\n\n";

        // 添加敏感文件列表
        const sensitiveFiles = files.filter(
          (file) => file.isSensitive && !file.isHidden
        );
        if (sensitiveFiles.length > 0) {
          structure += "## 敏感檔案列表\n\n";
          sensitiveFiles.forEach((file) => {
            structure += `- 🔒 \`${file.path}\`${
              !file.content || file.content.length === 0 ? " (空檔案)" : ""
            }\n`;
          });
          structure += "\n";
        }

        // 添加空檔案列表
        const emptyFiles = files.filter(
          (file) =>
            !file.isHidden && (!file.content || file.content.length === 0)
        );
        if (emptyFiles.length > 0) {
          structure += "## 空檔案列表\n\n";
          emptyFiles.forEach((file) => {
            structure += `- 📄 \`${file.path}\` (空檔案)\n`;
          });
          structure += "\n";
        }

        // 添加隱藏文件列表
        const hiddenFiles = files.filter((file) => file.isHidden);
        if (hiddenFiles.length > 0) {
          structure += "## 隱藏檔案列表\n\n";
          hiddenFiles.forEach((file) => {
            structure += `- 👁️‍🗨️ \`${file.path}\`${
              !file.content || file.content.length === 0 ? " (空檔案)" : ""
            }\n`;
          });
        }

        return structure;
      }

      // 產生輸出
      function updateOutput() {
        const outputContainer = document.getElementById("outputContainer");

        if (files.length === 0) {
          outputContainer.classList.remove("show");
          return;
        }

        // 更新檔案內容輸出
        let output = "";
        const visibleFiles = files.filter((f) => !f.isHidden);

        // 以路徑分組檔案
        const paths = new Set(
          visibleFiles.map((f) => f.path.split("/").slice(0, -1).join("/"))
        );

        paths.forEach((path) => {
          if (path) {
            output += `\n## ${path}\n\n`;
            const pathFiles = visibleFiles.filter((f) =>
              f.path.startsWith(path + "/")
            );
            pathFiles.forEach((file) => {
              if (file.isEmpty) {
                output += `### ${file.name}\n<空檔案>\n\n`;
              } else if (file.type === "text") {
                // 根據檔案類型選擇正確的語言標記
                const language = getFileLanguage(file.name);
                output += `### ${file.name}\n\`\`\`${language}\n${file.content}\n\`\`\`\n\n`;
              } else if (file.type === "binary") {
                output += `### ${file.name}\n（二進位檔案）\n\n`;
              } else {
                output += `### ${file.name}\n（未知類型）\n\n`;
              }
            });
          }
        });

        const rootFiles = visibleFiles.filter((f) => !f.path.includes("/"));
        rootFiles.forEach((file) => {
          if (file.isEmpty) {
            output += `### ${file.name}\n<空檔案>\n\n`;
          } else if (file.type === "text") {
            // 根據檔案類型選擇正確的語言標記
            const language = getFileLanguage(file.name);
            output += `### ${file.name}\n\`\`\`${language}\n${file.content}\n\`\`\`\n\n`;
          } else if (file.type === "binary") {
            output += `### ${file.name}\n（二進位檔案）\n\n`;
          } else {
            output += `### ${file.name}\n（未知類型）\n\n`;
          }
        });

        document.getElementById("output").textContent = output;

        // 更新檔案結構輸出
        const structure = generateFileStructure();
        document.getElementById("structureOutput").textContent = structure;

        outputContainer.classList.add("show");
      }

      // 複製輸出到剪貼簿
      async function copyOutput() {
        // 獲取當前活動的面板
        const activePane = document.querySelector(".output-pane.active");
        const output = activePane.querySelector("pre").textContent;
        const copyButton = document.getElementById("copyButton");

        try {
          await navigator.clipboard.writeText(output);

          // 更新按鈕外觀
          copyButton.classList.add("copied");
          copyButton.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-xs">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M18.0633 5.67387C18.5196 5.98499 18.6374 6.60712 18.3262 7.06343L10.8262 18.0634C10.6585 18.3095 10.3898 18.4679 10.0934 18.4957C9.79688 18.5235 9.50345 18.4178 9.29289 18.2072L4.79289 13.7072C4.40237 13.3167 4.40237 12.6835 4.79289 12.293C5.18342 11.9025 5.81658 11.9025 6.20711 12.293L9.85368 15.9396L16.6738 5.93676 C16.6738 5.93676 16.9849 5.48045 17.607 5.36275 18.0633 5.67387Z" fill="currentColor"/>
            </svg>
            已複製
          `;

          // 2秒後恢復原狀
          setTimeout(() => {
            copyButton.classList.remove("copied");
            copyButton.innerHTML = `
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-xs">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"/>
              </svg>
              複製
            `;
          }, 2000);
        } catch (err) {
          console.error("複製失敗:", err);
          showModal("複製失敗", "無法複製到剪貼簿，請手動選取複製。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
        }
      }

      // 儲存版本
      function saveVersion() {
        const versionName = document.getElementById("versionName").value.trim();
        if (!versionName) {
          showModal("儲存失敗", "請輸入版本名稱。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          return;
        }

        // 檢查是否有敏感檔案
        const sensitiveFiles = files.filter((file) => file.isSensitive);
        if (sensitiveFiles.length > 0) {
          showModal(
            "檔案包含敏感資訊",
            `注意：此版本包含 ${sensitiveFiles.length} 個敏感文件，請確認是否要保存這些資訊。`,
            [
              { text: "取消", onClick: "hideModal()", primary: false },
              {
                text: "確認儲存",
                onClick: "confirmSaveVersion()",
                primary: true,
              },
            ]
          );
          return;
        }

        confirmSaveVersion();
      }

      // 確認儲存版本
      function confirmSaveVersion() {
        const versionName = document.getElementById("versionName").value.trim();

        const newVersion = {
          id: Math.random().toString(36).substr(2, 9),
          name: versionName,
          files: [...files],
          created: new Date().toISOString(),
          updated: new Date().toISOString(),
        };

        savedVersions.push(newVersion);
        document.getElementById("versionName").value = "";

        saveVersionsToStorage();
        updateVersionsList();
        hideModal();

        showToast("版本已成功儲存");
      }

      // 顯示模態框
      function showModal(title, message, actions) {
        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modalTitle");
        const modalBody = document.getElementById("modalBody");
        const modalActions = document.getElementById("modalActions");

        modalTitle.textContent = title;
        modalBody.textContent = message;
        modalActions.innerHTML = actions
          .map(
            (action) => `
              <button class="modal-btn ${
                action.primary ? "modal-btn-primary" : "modal-btn-secondary"
              }" onclick="${action.onClick}">
                ${action.text}
              </button>
            `
          )
          .join("");

        modal.classList.add("show");
      }

      // 關閉模態框
      function hideModal() {
        const modal = document.getElementById("modal");
        modal.classList.remove("show");
      }

      // 更新版本列表
      function updateVersionsList() {
        const versionsList = document.getElementById("savedVersions");
        versionsList.innerHTML = savedVersions
          .map(
            (version) => `
              <div class="version-item">
                <div class="version-info">
                  <span class="version-name">${version.name}</span>
                  <span class="version-time">
                    建立：${formatDate(version.created)}<br>
                    更新：${formatDate(version.updated)}
                  </span>
                </div>
                <div class="version-actions">
                  <button class="save-btn" onclick="loadVersion('${
                    version.id
                  }')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25rem; height: 1.25rem;">
                      <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                    載入
                  </button>
                  <button class="delete-version-btn" onclick="deleteVersion('${
                    version.id
                  }')" title="刪除版本">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            `
          )
          .join("");
      }

      // 格式化日期
      function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getFullYear()}/${(date.getMonth() + 1)
          .toString()
          .padStart(2, "0")}/${date
          .getDate()
          .toString()
          .padStart(2, "0")} ${date
          .getHours()
          .toString()
          .padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
      }

      // 載入版本
      function loadVersion(id) {
        const version = savedVersions.find((v) => v.id === id);
        if (version) {
          files = [...version.files];
          version.updated = new Date().toISOString();
          saveVersionsToStorage();
          updateUI();
          updatePrivacySettings();

          showToast("版本已成功載入");
        }
      }

      // 刪除版本
      function deleteVersion(id) {
        showModal("確認刪除", "確定要刪除此版本嗎？此操作無法復原。", [
          {
            text: "取消",
            onClick: "hideModal()",
            primary: false,
          },
          {
            text: "確定刪除",
            onClick: `confirmDeleteVersion('${id}')`,
            primary: true,
          },
        ]);
      }

      // 確認刪除版本
      function confirmDeleteVersion(id) {
        savedVersions = savedVersions.filter((v) => v.id !== id);
        saveVersionsToStorage();
        updateVersionsList();
        hideModal();
      }

      // 新增吐司訊息函式
      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.style.display = "block";
        toast.style.opacity = "1";

        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => {
            toast.style.display = "none";
          }, 500);
        }, duration);
      }

      // 文件拖放排序
      function handleDragStart(e) {
        draggedItem = e.currentTarget;
        e.currentTarget.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      }

      function handleDragEnd(e) {
        e.currentTarget.classList.remove("dragging");
        draggedItem = null;
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";

        const target = e.currentTarget;
        if (target && target !== draggedItem) {
          const rect = target.getBoundingClientRect();
          const offset = e.clientY - rect.top;
          if (offset > rect.height / 2) {
            target.style["border-bottom"] = "2px solid var(--primary)";
            target.style["border-top"] = "";
          } else {
            target.style["border-top"] = "2px solid var(--primary)";
            target.style["border-bottom"] = "";
          }
        }
      }

      function handleDrop(e) {
        e.preventDefault();
        const target = e.currentTarget;
        if (target && target !== draggedItem) {
          const rect = target.getBoundingClientRect();
          const offset = e.clientY - rect.top;
          const dropIndex = parseInt(target.dataset.index);

          const draggedIndex = parseInt(draggedItem.dataset.index);

          if (offset > rect.height / 2) {
            // Move below
            files.splice(dropIndex + 1, 0, files.splice(draggedIndex, 1)[0]);
          } else {
            // Move above
            files.splice(dropIndex, 0, files.splice(draggedIndex, 1)[0]);
          }

          updateUI();
        }

        // 清除排序樣式
        const fileItems = document.querySelectorAll(".file-item");
        fileItems.forEach((item) => {
          item.style["border-bottom"] = "";
          item.style["border-top"] = "";
        });
      }
    </script>
  </body>
</html>
