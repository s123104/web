<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>智慧 Prompt 生成器</title>
    <link rel="icon" href="img/ai.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="img/ai.ico" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@700&display=swap"
      rel="stylesheet"
    />
    <!-- 引入 JSZip 庫 -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      /* 原有樣式保持不變 */

      :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --danger: #ef4444;
        --danger-dark: #dc2626;
        --success: #22c55e;
        --success-dark: #16a34a;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: all 0.2s ease;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        padding: 2rem;
        background-color: var(--gray-100);
        color: var(--gray-800);
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-md);
      }

      /* Modal 樣式 */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-md);
        max-width: 90%;
        width: 400px;
        transform: translateY(20px);
        transition: all 0.3s ease;
        position: relative;
      }

      .modal-backdrop.show .modal-content {
        transform: translateY(0);
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 1rem;
        font-family: "Playfair Display", serif;
      }

      .modal-body {
        margin-bottom: 1.5rem;
        color: var(--gray-600);
        font-size: 0.9375rem;
        line-height: 1.5;
      }

      .modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      .modal-btn {
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
      }

      .modal-btn-primary {
        background: var(--primary);
        color: white;
      }

      .modal-btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .modal-btn-secondary {
        background: var(--gray-100);
        color: var(--gray-700);
      }

      .modal-btn-secondary:hover {
        background: var(--gray-200);
      }

      /* 標題樣式 */
      .header {
        text-align: center;
        margin-bottom: 2.5rem;
        position: relative;
        padding-top: 1rem;
      }

      .logo {
        width: 64px;
        height: 64px;
        margin: 0 auto 1rem;
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .header .title-ch {
        font-family: "Playfair Display", "Dancing Script", serif;
        font-weight: 700;
        font-size: 2.25rem;
        background: linear-gradient(
          135deg,
          var(--primary),
          #818cf8 50%,
          #6366f1
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        display: inline-block;
        margin-bottom: 0.5rem;
      }

      .header .title-ch::after {
        content: "";
        position: absolute;
        bottom: -0.25rem;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(135deg, var(--primary), transparent);
        transform: scaleX(0.8);
        opacity: 0.5;
      }

      .header .title-en {
        font-family: "Dancing Script", cursive;
        font-size: 1.75rem;
        color: var(--gray-500);
        letter-spacing: 0.05em;
        margin-top: 0.75rem;
        transform: rotate(-2deg);
        display: block;
      }

      .header p {
        color: var(--gray-600);
        margin-top: 1rem;
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        .container {
          padding: 1rem;
        }

        .header {
          margin-bottom: 2rem;
        }

        .logo {
          width: 48px;
          height: 48px;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .header .title-en {
          font-size: 1rem;
        }

        .modal-content {
          padding: 1.5rem;
        }
      }

      /* 上傳區域樣式 */
      .upload-section {
        margin-bottom: 2rem;
        padding: 2rem;
        border: 2px dashed var(--gray-300);
        border-radius: 0.75rem;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.3s ease;
      }

      .upload-section:hover,
      .upload-section.drag-over {
        border-color: var(--primary);
        background: #f5f7ff;
      }

      .upload-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 1rem;
        color: var(--gray-400);
      }

      .upload-section:hover .upload-icon {
        color: var(--primary);
        transform: scale(1.1);
      }

      .file-input {
        display: none;
      }

      .upload-button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        margin-top: 1rem;
      }

      .upload-button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .upload-button svg {
        width: 20px;
        height: 20px;
      }

      /* 文件列表樣式 */
      .file-list {
        margin-top: 2rem;
        margin-bottom: 2rem;
        display: grid;
        gap: 0.75rem;
      }

      .file-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .file-list-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
      }

      .download-all-button {
        background: var(--success);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
      }

      .download-all-button:hover {
        background: var(--success-dark);
        transform: translateY(-1px);
      }

      .download-all-button svg {
        width: 20px;
        height: 20px;
      }

      .file-item {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: 0.5rem;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--gray-200);
        transform-origin: center;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .file-item:hover {
        background: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
      }

      .file-item.dragging {
        opacity: 0.5;
        background: var(--gray-100);
        box-shadow: var(--shadow-md);
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .file-icon {
        width: 24px;
        height: 24px;
        color: var(--primary);
      }

      .file-path {
        color: var(--gray-700);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        font-size: 0.875rem;
      }

      .file-actions {
        display: flex;
        gap: 0.5rem;
      }

      .action-btn {
        background: transparent;
        color: var(--gray-400);
        border: none;
        padding: 0.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        background: var(--gray-100);
      }

      .action-btn.download:hover {
        color: var(--success);
        background: var(--gray-100);
      }

      .action-btn.delete:hover {
        color: var(--danger);
        background: var(--gray-100);
      }

      .action-btn svg {
        width: 20px;
        height: 20px;
      }

      /* 版本控制樣式 */
      .version-control {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--gray-200);
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .version-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        outline: none;
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .version-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
      }

      .save-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
      }

      .save-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .save-btn svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      .saved-versions {
        margin-top: 1.5rem;
        display: grid;
        gap: 0.75rem;
      }

      .version-item {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--gray-200);
        animation: fadeIn 0.3s ease;
        transition: all 0.2s ease;
      }

      .version-item:hover {
        background: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
      }

      .version-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .version-name {
        font-weight: 500;
        color: var(--gray-800);
      }

      .version-time {
        font-size: 0.75rem;
        color: var(--gray-500);
        line-height: 1.4;
      }

      .version-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .delete-version-btn {
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: var(--danger);
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .delete-version-btn:hover {
        background: var(--gray-100);
        color: var(--danger-dark);
      }

      .delete-version-btn svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      /* 輸出區域樣式 */
      .output-container {
        position: relative;
        margin-top: 1.5rem;
        display: none;
      }

      .output-container.show {
        display: block;
      }

      .copy-btn-container {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
      }

      .copy-btn {
        display: flex;
        gap: 0.25rem;
        align-items: center;
        padding: 0.25rem 1rem;
        background: var(--gray-50);
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.75rem;
        color: var(--gray-600);
        transition: all 0.2s ease;
      }

      .copy-btn:hover {
        background: var(--gray-100);
      }

      .copy-btn svg {
        width: 1rem;
        height: 1rem;
      }

      .copy-btn.copied {
        background: var(--gray-100);
        color: var(--gray-700);
      }

      .output {
        background: var(--gray-800);
        color: var(--gray-100);
        padding: 1.5rem;
        border-radius: 0.75rem;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        position: relative;
        overflow-x: auto;
      }

      /* 新增吐司訊息樣式 */
      #toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      /* 響應式調整 */
      @media (max-width: 768px) {
        .version-actions {
          flex-direction: column;
          gap: 0.25rem;
        }

        .version-actions .save-btn {
          padding: 0.4rem 0.75rem;
          font-size: 0.8125rem;
        }

        .version-item {
          flex-direction: column;
          gap: 0.75rem;
          align-items: flex-start;
        }

        .version-info {
          width: 100%;
        }

        .version-actions {
          width: 100%;
          flex-direction: row;
          justify-content: flex-end;
        }

        .copy-btn {
          padding: 0.25rem 0.75rem;
        }

        .file-list-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .download-all-button {
          width: 100%;
          justify-content: center;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <svg
          class="logo"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 2L2 7L12 12L22 7L12 2Z"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M2 17L12 22L22 17"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M2 12L12 17L22 12"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <circle cx="12" cy="12" r="2" fill="var(--primary)" />
        </svg>
        <h1>
          <span class="title-ch">智慧 Prompt 生成器</span>
          <span class="title-en">Smart Prompt Generator</span>
        </h1>
        <p>快速整理並生成結構化的 AI 提示文件</p>
      </div>

      <div class="upload-section" id="dropZone">
        <svg
          class="upload-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
        <input
          type="file"
          id="fileInput"
          class="file-input"
          multiple
          webkitdirectory
          directory
        />
        <p>拖放檔案或資料夾至此，或</p>
        <button
          class="upload-button"
          onclick="document.getElementById('fileInput').click()"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          選擇檔案或資料夾
        </button>
      </div>

      <div class="file-list" id="fileList">
        <!-- 檔案列表將在有檔案時動態生成 -->
      </div>

      <div class="version-control">
        <input
          type="text"
          class="version-input"
          id="versionName"
          placeholder="輸入版本名稱"
        />
        <button class="save-btn" onclick="saveVersion()">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
            />
            <polyline points="17 21 17 13 7 13 7 21" />
            <polyline points="7 3 7 8 15 8" />
          </svg>
          儲存版本
        </button>
      </div>

      <div class="saved-versions" id="savedVersions"></div>

      <div class="output-container">
        <div class="copy-btn-container">
          <button class="copy-btn" onclick="copyOutput()" id="copyButton">
            <!-- 複製按鈕 SVG 保持不變 -->
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              class="icon-xs"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z"
                fill="currentColor"
              />
            </svg>
            複製
          </button>
        </div>
        <pre class="output" id="output"></pre>
      </div>
    </div>

    <!-- 模態框 -->
    <div id="modal" class="modal-backdrop">
      <div class="modal-content">
        <div class="modal-title" id="modalTitle"></div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>

    <!-- 吐司訊息容器 -->
    <div id="toast"></div>

    <script>
      let files = [];
      let savedVersions = [];
      let draggedItem = null;

      // 定義文本和二進位檔案的擴展名
      const textExtensions = [
        "js",
        "py",
        "java",
        "cpp",
        "html",
        "css",
        "jsx",
        "ts",
        "tsx",
        "php",
        "blade.php",
        "json",
        "md",
        "txt",
        "csv",
        "xml",
        "yml",
        "yaml",
        "sql", // 新增此行
      ];
      const binaryExtensions = [
        "jpg",
        "jpeg",
        "png",
        "gif",
        "bmp",
        "svg",
        "ico",
        "pdf",
        "zip",
        "rar",
        "7z",
        "exe",
        "dll",
        "bin",
      ];

      // 初始化
      document.addEventListener("DOMContentLoaded", () => {
        setupDragAndDrop();
        setupFileInput();
        loadSavedVersions();
      });

      // 從 localStorage 載入已儲存的版本
      function loadSavedVersions() {
        try {
          const savedData = localStorage.getItem("promptVersions");
          if (savedData) {
            savedVersions = JSON.parse(savedData);
            updateVersionsList();
          }
        } catch (err) {
          console.error("載入版本失敗:", err);
        }
      }

      // 儲存版本到 localStorage
      function saveVersionsToStorage() {
        try {
          localStorage.setItem("promptVersions", JSON.stringify(savedVersions));
        } catch (err) {
          console.error("儲存版本失敗:", err);
        }
      }

      // 設置拖放功能
      function setupDragAndDrop() {
        const dropZone = document.getElementById("dropZone");

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("drag-over");
        });

        dropZone.addEventListener("dragleave", () => {
          dropZone.classList.remove("drag-over");
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("drag-over");
          handleFiles(e.dataTransfer.files);
        });
      }

      // 設置文件輸入
      function setupFileInput() {
        document.getElementById("fileInput").addEventListener("change", (e) => {
          handleFiles(e.target.files);
        });
      }

      // 處理文件
      async function handleFiles(fileList) {
        let failedFiles = [];
        for (const file of fileList) {
          // 檢查是否為檔案
          if (!file.type && file.size === 0) {
            console.warn(`跳過非檔案項目：${file.name}`);
            continue;
          }

          try {
            console.log(`開始讀取檔案：${file.name}`);
            const { content, type } = await readFileContent(file);
            files.push({
              id: Math.random().toString(36).substr(2, 9),
              name: file.name,
              path: file.webkitRelativePath || file.name,
              content,
              type,
            });
            console.log(`成功讀取檔案：${file.name}`);
          } catch (err) {
            console.error(`讀取檔案失敗：${file.name}`, err);
            failedFiles.push(file.name);
          }
        }

        if (failedFiles.length > 0) {
          showModal(
            "讀取部分檔案失敗",
            `無法讀取以下檔案：\n${failedFiles.join("\n")}`,
            [{ text: "確認", onClick: "hideModal()", primary: true }]
          );
        }

        updateUI();
      }

      // 讀取文件內容
      function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          const ext = file.name.split(".").pop().toLowerCase();
          let typeCategory = "binary";

          if (textExtensions.includes(ext)) {
            typeCategory = "text";
          } else if (binaryExtensions.includes(ext)) {
            typeCategory = "binary";
          } else {
            // 默認處理為二進位
            typeCategory = "binary";
          }

          if (typeCategory === "text") {
            reader.onload = (e) =>
              resolve({ content: e.target.result, type: "text" });
            reader.onerror = (e) => {
              console.error(`FileReader 錯誤：${file.name}`, e);
              reject(e);
            };
            reader.readAsText(file);
          } else {
            // 對於二進位檔案，讀取為 ArrayBuffer
            reader.onload = (e) =>
              resolve({ content: e.target.result, type: "binary" });
            reader.onerror = (e) => {
              console.error(`FileReader 錯誤：${file.name}`, e);
              reject(e);
            };
            reader.readAsArrayBuffer(file);
          }
        });
      }

      // 獲取文件類型
      function getFileType(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        if (textExtensions.includes(ext)) {
          return "text";
        } else if (binaryExtensions.includes(ext)) {
          return "binary";
        } else {
          return "unknown";
        }
      }

      // 更新UI
      function updateUI() {
        updateFileList();
        updateOutput();
        updateVersionsList();
      }

      // 更新文件列表
      function updateFileList() {
        const fileList = document.getElementById("fileList");

        if (files.length === 0) {
          fileList.innerHTML = "";
          return;
        }

        // 清除現有列表內容
        fileList.innerHTML = `
          <div class="file-list-header">
            <h2>檔案列表</h2>
            <button class="download-all-button" onclick="downloadAllFiles()">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
                <polyline points="12 15 12 3" />
                <path d="M16 11l-4 4-4-4" />
              </svg>
              下載全部
            </button>
          </div>
        `;

        files.forEach((file, index) => {
          const fileItem = document.createElement("div");
          fileItem.classList.add("file-item");
          fileItem.setAttribute("draggable", "true");
          fileItem.dataset.index = index;

          // 根據文件類型顯示不同的圖示和內容
          let displayContent = "";
          let icon = "";
          if (file.type === "text") {
            const ext = file.name.split(".").pop().toLowerCase();
            if (ext === "sql") {
              icon = `
                <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 4h16v16H4V4z"></path>
                  <polyline points="4 10 12 14 20 10"></polyline>
                </svg>
              `;
              displayContent = `<span class="file-path">${file.path} (SQL 檔案)</span>`;
            } else {
              icon = `
                <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                  <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
              `;
              displayContent = `<span class="file-path">${file.path}</span>`;
            }
          } else if (file.type === "binary") {
            icon = `
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
            `;
            displayContent = `<span class="file-path">${file.path} (二進位檔案)</span>`;
          } else {
            icon = `
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
            `;
            displayContent = `<span class="file-path">${file.path} (未知類型)</span>`;
          }

          fileItem.innerHTML = `
            <div class="file-info">
              ${icon}
              ${displayContent}
            </div>
            <div class="file-actions">
              <button class="action-btn download" onclick="downloadFile('${file.id}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                  <path d="M12 15l-4-4"></path>
                  <path d="M12 15l4-4"></path>
                </svg>
                下載
              </button>
              <button class="action-btn delete" onclick="deleteFile('${file.id}')" title="刪除檔案">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          `;

          // 設置拖放排序事件
          fileItem.addEventListener("dragstart", handleDragStart);
          fileItem.addEventListener("dragend", handleDragEnd);
          fileItem.addEventListener("dragover", handleDragOver);
          fileItem.addEventListener("drop", handleDrop);

          fileList.appendChild(fileItem);
        });
      }

      // 刪除文件
      function deleteFile(id) {
        files = files.filter((file) => file.id !== id);
        updateUI();
      }

      // 下載單個文件
      function downloadFile(id) {
        const file = files.find((f) => f.id === id);
        if (!file) {
          showModal("下載失敗", "找不到該檔案。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          return;
        }

        let blob;
        let filename = file.name;

        if (file.type === "text") {
          blob = new Blob([file.content], { type: "text/plain" });
        } else if (file.type === "binary") {
          blob = new Blob([file.content]);
        } else {
          blob = new Blob([file.content]);
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        showToast(`已下載：${filename}`);
      }

      // 下載全部文件
      async function downloadAllFiles() {
        if (files.length === 0) {
          showToast("沒有檔案可供下載");
          return;
        }

        if (typeof JSZip === "undefined") {
          showModal("下載失敗", "JSZip 未正確載入，無法壓縮檔案。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          console.error("JSZip 未定義");
          return;
        }

        const zip = new JSZip();

        files.forEach((file) => {
          if (file.type === "text") {
            zip.file(file.path, file.content);
          } else if (file.type === "binary") {
            zip.file(file.path, file.content, { binary: true });
          } else {
            zip.file(file.path, file.content);
          }
        });

        try {
          const blob = await zip.generateAsync({ type: "blob" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "all_files.zip";
          a.click();
          URL.revokeObjectURL(url);

          showToast("已下載全部檔案");
        } catch (err) {
          console.error("下載失敗:", err);
          showModal("下載失敗", "下載失敗，請稍後再試。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
        }
      }

      // 產生輸出
      function updateOutput() {
        const outputContainer = document.querySelector(".output-container");

        if (files.length === 0) {
          outputContainer.classList.remove("show");
          return;
        }

        let output = "";
        const paths = new Set(
          files.map((f) => f.path.split("/").slice(0, -1).join("/"))
        );

        paths.forEach((path) => {
          if (path) {
            output += `\n## ${path}\n\n`;
            const pathFiles = files.filter((f) =>
              f.path.startsWith(path + "/")
            );
            pathFiles.forEach((file) => {
              if (file.type === "text") {
                const ext = file.name.split(".").pop().toLowerCase();
                if (ext === "sql") {
                  output += `### ${file.name}\n\`\`\`sql\n${file.content}\n\`\`\`\n\n`;
                } else {
                  output += `### ${file.name}\n\`\`\`${file.type}\n${file.content}\n\`\`\`\n\n`;
                }
              } else if (file.type === "binary") {
                output += `### ${file.name}\n（二進位檔案）\n\n`;
              } else {
                output += `### ${file.name}\n（未知類型）\n\n`;
              }
            });
          }
        });

        const rootFiles = files.filter((f) => !f.path.includes("/"));
        rootFiles.forEach((file) => {
          if (file.type === "text") {
            const ext = file.name.split(".").pop().toLowerCase();
            if (ext === "sql") {
              output += `### ${file.name}\n\`\`\`sql\n${file.content}\n\`\`\`\n\n`;
            } else {
              output += `### ${file.name}\n\`\`\`${file.type}\n${file.content}\n\`\`\`\n\n`;
            }
          } else if (file.type === "binary") {
            output += `### ${file.name}\n（二進位檔案）\n\n`;
          } else {
            output += `### ${file.name}\n（未知類型）\n\n`;
          }
        });

        document.getElementById("output").textContent = output;
        outputContainer.classList.add("show");
      }

      // 複製輸出到剪貼簿
      async function copyOutput() {
        const output = document.getElementById("output").textContent;
        const copyButton = document.getElementById("copyButton");

        try {
          await navigator.clipboard.writeText(output);

          // 更新按鈕外觀
          copyButton.classList.add("copied");
          copyButton.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-xs">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M18.0633 5.67387C18.5196 5.98499 18.6374 6.60712 18.3262 7.06343L10.8262 18.0634C10.6585 18.3095 10.3898 18.4679 10.0934 18.4957C9.79688 18.5235 9.50345 18.4178 9.29289 18.2072L4.79289 13.7072C4.40237 13.3167 4.40237 12.6835 4.79289 12.293C5.18342 11.9025 5.81658 11.9025 6.20711 12.293L9.85368 15.9396L16.6738 5.93676 C16.6738 5.93676C16.9849 5.48045 17.607 5.36275 18.0633 5.67387Z" fill="currentColor"/>
            </svg>
            已複製
          `;

          // 2秒後恢復原狀
          setTimeout(() => {
            copyButton.classList.remove("copied");
            copyButton.innerHTML = `
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-xs">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"/>
              </svg>
              複製
            `;
          }, 2000);
        } catch (err) {
          console.error("複製失敗:", err);
          showModal("複製失敗", "無法複製到剪貼簿，請手動選取複製。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
        }
      }

      // 儲存版本
      function saveVersion() {
        const versionName = document.getElementById("versionName").value.trim();
        if (!versionName) {
          showModal("儲存失敗", "請輸入版本名稱。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          return;
        }

        const newVersion = {
          id: Math.random().toString(36).substr(2, 9),
          name: versionName,
          files: [...files],
          created: new Date().toISOString(),
          updated: new Date().toISOString(),
        };

        savedVersions.push(newVersion);
        document.getElementById("versionName").value = "";

        saveVersionsToStorage();
        updateVersionsList();

        showToast("版本已成功儲存");
      }

      // 顯示模態框
      function showModal(title, message, actions) {
        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modalTitle");
        const modalBody = document.getElementById("modalBody");
        const modalActions = document.getElementById("modalActions");

        modalTitle.textContent = title;
        modalBody.textContent = message;
        modalActions.innerHTML = actions
          .map(
            (action) => `
              <button class="modal-btn ${
                action.primary ? "modal-btn-primary" : "modal-btn-secondary"
              }" onclick="${action.onClick}">
                ${action.text}
              </button>
            `
          )
          .join("");

        modal.classList.add("show");
      }

      // 關閉模態框
      function hideModal() {
        const modal = document.getElementById("modal");
        modal.classList.remove("show");
      }

      // 更新版本列表
      function updateVersionsList() {
        const versionsList = document.getElementById("savedVersions");
        versionsList.innerHTML = savedVersions
          .map(
            (version) => `
              <div class="version-item">
                <div class="version-info">
                  <span class="version-name">${version.name}</span>
                  <span class="version-time">
                    建立：${formatDate(version.created)}<br>
                    更新：${formatDate(version.updated)}
                  </span>
                </div>
                <div class="version-actions">
                  <button class="save-btn" onclick="loadVersion('${
                    version.id
                  }')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25rem; height: 1.25rem;">
                      <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                    載入
                  </button>
                  <button class="delete-version-btn" onclick="deleteVersion('${
                    version.id
                  }')" title="刪除版本">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            `
          )
          .join("");
      }

      // 格式化日期
      function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getFullYear()}/${(date.getMonth() + 1)
          .toString()
          .padStart(2, "0")}/${date
          .getDate()
          .toString()
          .padStart(2, "0")} ${date
          .getHours()
          .toString()
          .padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
      }

      // 載入版本
      function loadVersion(id) {
        const version = savedVersions.find((v) => v.id === id);
        if (version) {
          files = [...version.files];
          version.updated = new Date().toISOString();
          saveVersionsToStorage();
          updateUI();

          showToast("版本已成功載入");
        }
      }

      // 刪除版本
      function deleteVersion(id) {
        showModal("確認刪除", "確定要刪除此版本嗎？此操作無法復原。", [
          {
            text: "取消",
            onClick: "hideModal()",
            primary: false,
          },
          {
            text: "確定刪除",
            onClick: `confirmDeleteVersion('${id}')`,
            primary: true,
          },
        ]);
      }

      // 確認刪除版本
      function confirmDeleteVersion(id) {
        savedVersions = savedVersions.filter((v) => v.id !== id);
        saveVersionsToStorage();
        updateVersionsList();
        hideModal();
      }

      // 新增吐司訊息函式
      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.style.display = "block";
        toast.style.opacity = "1";

        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => {
            toast.style.display = "none";
          }, 500);
        }, duration);
      }

      // 文件拖放排序
      function handleDragStart(e) {
        draggedItem = e.currentTarget;
        e.currentTarget.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      }

      function handleDragEnd(e) {
        e.currentTarget.classList.remove("dragging");
        draggedItem = null;
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";

        const target = e.currentTarget;
        if (target && target !== draggedItem) {
          const rect = target.getBoundingClientRect();
          const offset = e.clientY - rect.top;
          if (offset > rect.height / 2) {
            target.style["border-bottom"] = "2px solid var(--primary)";
            target.style["border-top"] = "";
          } else {
            target.style["border-top"] = "2px solid var(--primary)";
            target.style["border-bottom"] = "";
          }
        }
      }

      function handleDrop(e) {
        e.preventDefault();
        const target = e.currentTarget;
        if (target && target !== draggedItem) {
          const rect = target.getBoundingClientRect();
          const offset = e.clientY - rect.top;
          const dropIndex = parseInt(target.dataset.index);

          const draggedIndex = parseInt(draggedItem.dataset.index);

          if (offset > rect.height / 2) {
            // Move below
            files.splice(dropIndex + 1, 0, files.splice(draggedIndex, 1)[0]);
          } else {
            // Move above
            files.splice(dropIndex, 0, files.splice(draggedIndex, 1)[0]);
          }

          updateUI();
        }

        // 清除排序樣式
        const fileItems = document.querySelectorAll(".file-item");
        fileItems.forEach((item) => {
          item.style["border-bottom"] = "";
          item.style["border-top"] = "";
        });
      }
    </script>
  </body>
</html>
