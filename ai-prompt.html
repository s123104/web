<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>智慧 Prompt 生成器</title>
    <link rel="icon" href="img/ai.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="img/ai.ico" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@700&display=swap"
      rel="stylesheet"
    />
    <!-- 引入 JSZip 庫 -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      /* 原有樣式保持不變 */

      :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --danger: #ef4444;
        --danger-dark: #dc2626;
        --warning: #f59e0b;
        --warning-dark: #d97706;
        --success: #22c55e;
        --success-dark: #16a34a;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: all 0.2s ease;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        padding: 2rem;
        background-color: var(--gray-100);
        color: var(--gray-800);
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-md);
      }

      /* Modal 樣式 */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-md);
        max-width: 90%;
        width: 400px;
        transform: translateY(20px);
        transition: all 0.3s ease;
        position: relative;
      }

      .modal-backdrop.show .modal-content {
        transform: translateY(0);
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 1rem;
        font-family: "Playfair Display", serif;
      }

      .modal-body {
        margin-bottom: 1.5rem;
        color: var(--gray-600);
        font-size: 0.9375rem;
        line-height: 1.5;
      }

      .modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      .modal-btn {
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
      }

      .modal-btn-primary {
        background: var(--primary);
        color: white;
      }

      .modal-btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .modal-btn-secondary {
        background: var(--gray-100);
        color: var(--gray-700);
      }

      .modal-btn-secondary:hover {
        background: var(--gray-200);
      }

      /* 標題樣式 */
      .header {
        text-align: center;
        margin-bottom: 2.5rem;
        position: relative;
        padding-top: 1rem;
      }

      .logo {
        width: 64px;
        height: 64px;
        margin: 0 auto 1rem;
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .header .title-ch {
        font-family: "Playfair Display", "Dancing Script", serif;
        font-weight: 700;
        font-size: 2.25rem;
        background: linear-gradient(
          135deg,
          var(--primary),
          #818cf8 50%,
          #6366f1
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        display: inline-block;
        margin-bottom: 0.5rem;
      }

      .header .title-ch::after {
        content: "";
        position: absolute;
        bottom: -0.25rem;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(135deg, var(--primary), transparent);
        transform: scaleX(0.8);
        opacity: 0.5;
      }

      .header .title-en {
        font-family: "Dancing Script", cursive;
        font-size: 1.75rem;
        color: var(--gray-500);
        letter-spacing: 0.05em;
        margin-top: 0.75rem;
        transform: rotate(-2deg);
        display: block;
      }

      .header p {
        color: var(--gray-600);
        margin-top: 1rem;
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        .container {
          padding: 1rem;
        }

        .header {
          margin-bottom: 2rem;
        }

        .logo {
          width: 48px;
          height: 48px;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .header .title-en {
          font-size: 1rem;
        }

        .modal-content {
          padding: 1.5rem;
        }
      }

      /* 上傳區域樣式 */
      .upload-section {
        margin-bottom: 2rem;
        padding: 2rem;
        border: 2px dashed var(--gray-300);
        border-radius: 0.75rem;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.3s ease;
      }

      .upload-section:hover,
      .upload-section.drag-over {
        border-color: var(--primary);
        background: #f5f7ff;
      }

      .upload-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 1rem;
        color: var(--gray-400);
      }

      .upload-section:hover .upload-icon {
        color: var(--primary);
        transform: scale(1.1);
      }

      .file-input {
        display: none;
      }

      .upload-button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        margin-top: 1rem;
      }

      .upload-button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .upload-button svg {
        width: 20px;
        height: 20px;
      }

      /* 隱私設定區域 */
      .privacy-settings {
        margin: 1.5rem 0;
        padding: 1.25rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid var(--gray-200);
      }

      .privacy-settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .privacy-settings-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .privacy-settings-icon {
        color: var(--warning);
      }

      .privacy-options {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.75rem;
      }

      .privacy-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
      }

      .privacy-option:hover {
        background: var(--gray-100);
      }

      .privacy-checkbox {
        appearance: none;
        width: 1.125rem;
        height: 1.125rem;
        border: 2px solid var(--gray-400);
        border-radius: 0.25rem;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .privacy-checkbox:checked {
        background: var(--primary);
        border-color: var(--primary);
      }

      .privacy-checkbox:checked::after {
        content: "";
        position: absolute;
        top: 0.125rem;
        left: 0.3125rem;
        width: 0.375rem;
        height: 0.625rem;
        border: solid white;
        border-width: 0 0.125rem 0.125rem 0;
        transform: rotate(45deg);
      }

      .privacy-label {
        font-size: 0.875rem;
        color: var(--gray-700);
        cursor: pointer;
      }

      .privacy-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.125rem 0.375rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 500;
        margin-left: 0.375rem;
      }

      .badge-sensitive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      /* 文件列表樣式 */
      .file-list {
        margin-top: 2rem;
        margin-bottom: 2rem;
        display: grid;
        gap: 0.75rem;
      }

      .file-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .file-list-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
      }

      .download-all-button {
        background: var(--success);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
      }

      .download-all-button:hover {
        background: var(--success-dark);
        transform: translateY(-1px);
      }

      .download-all-button svg {
        width: 20px;
        height: 20px;
      }

      .file-item {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: 0.5rem;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--gray-200);
        transform-origin: center;
        animation: slideIn 0.3s ease;
      }

      .file-item.sensitive-file {
        border-left: 3px solid var(--warning);
      }

      .file-item.hidden-file {
        opacity: 0.6;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .file-item:hover {
        background: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
      }

      .file-item.dragging {
        opacity: 0.5;
        background: var(--gray-100);
        box-shadow: var(--shadow-md);
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .file-icon {
        width: 24px;
        height: 24px;
        color: var(--primary);
      }

      .file-icon.sensitive {
        color: var(--warning);
      }

      .file-path {
        color: var(--gray-700);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .file-actions {
        display: flex;
        gap: 0.5rem;
      }

      /* 空檔案樣式 */
      .empty-file {
        background-color: #fafafa;
      }

      .empty-file .file-path::after {
        content: " (空)";
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-left: 0.25rem;
      }

      .tag-empty {
        background: rgba(107, 114, 128, 0.1);
        color: var(--gray-500);
      }

      .action-btn {
        background: transparent;
        color: var(--gray-400);
        border: none;
        padding: 0.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        background: var(--gray-100);
      }

      .action-btn.download:hover {
        color: var(--success);
        background: var(--gray-100);
      }

      .action-btn.delete:hover {
        color: var(--danger);
        background: var(--gray-100);
      }

      .action-btn.toggle-sensitive:hover {
        color: var(--warning);
        background: var(--gray-100);
      }

      .action-btn svg {
        width: 20px;
        height: 20px;
      }

      /* 版本控制樣式 */
      .version-control {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--gray-200);
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .version-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        outline: none;
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .version-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
      }

      .save-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
      }

      .save-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .save-btn svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      .saved-versions {
        margin-top: 1.5rem;
        display: grid;
        gap: 0.75rem;
      }

      .version-item {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--gray-200);
        animation: fadeIn 0.3s ease;
        transition: all 0.2s ease;
      }

      .version-item:hover {
        background: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
      }

      .version-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .version-name {
        font-weight: 500;
        color: var(--gray-800);
      }

      .version-time {
        font-size: 0.75rem;
        color: var(--gray-500);
        line-height: 1.4;
      }

      .version-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .delete-version-btn {
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: var(--danger);
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .delete-version-btn:hover {
        background: var(--gray-100);
        color: var(--danger-dark);
      }

      .delete-version-btn svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      /* 輸出區域樣式 */
      .output-container {
        position: relative;
        margin-top: 1.5rem;
        display: none;
      }

      .output-container.show {
        display: block;
      }

      .copy-btn-container {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
      }

      .output-tabs {
        display: flex;
        margin-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .output-tab {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-right: 0.75rem;
        color: var(--gray-600);
        transition: all 0.2s ease;
      }

      .output-tab:hover {
        color: var(--primary);
      }

      .output-tab.active {
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
        font-weight: 500;
      }

      .copy-btn {
        display: flex;
        gap: 0.25rem;
        align-items: center;
        padding: 0.25rem 1rem;
        background: var(--gray-50);
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.75rem;
        color: var(--gray-600);
        transition: all 0.2s ease;
      }

      .copy-btn:hover {
        background: var(--gray-100);
      }

      .copy-btn svg {
        width: 1rem;
        height: 1rem;
      }

      .copy-btn.copied {
        background: var(--gray-100);
        color: var(--gray-700);
      }

      .output {
        background: var(--gray-800);
        color: var(--gray-100);
        padding: 1.5rem;
        border-radius: 0.75rem;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        position: relative;
        overflow-x: auto;
      }

      .output-pane {
        display: none;
      }

      .output-pane.active {
        display: block;
      }

      /* 新增吐司訊息樣式 */
      #toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      /* 響應式調整 */
      @media (max-width: 768px) {
        .privacy-options {
          grid-template-columns: 1fr;
        }

        .version-actions {
          flex-direction: column;
          gap: 0.25rem;
        }

        .version-actions .save-btn {
          padding: 0.4rem 0.75rem;
          font-size: 0.8125rem;
        }

        .version-item {
          flex-direction: column;
          gap: 0.75rem;
          align-items: flex-start;
        }

        .version-info {
          width: 100%;
        }

        .version-actions {
          width: 100%;
          flex-direction: row;
          justify-content: flex-end;
        }

        .copy-btn {
          padding: 0.25rem 0.75rem;
        }

        .file-list-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .download-all-button {
          width: 100%;
          justify-content: center;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 新增的預設隱藏標籤 */
      .tag {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 500;
        margin-left: 0.375rem;
      }

      .tag-sensitive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      .tag-hidden {
        background: rgba(107, 114, 128, 0.1);
        color: var(--gray-500);
      }

      /* 在原有 CSS 基礎上添加 */

      /* 日誌控制相關樣式 */
      .privacy-category-header {
        margin-bottom: 0.75rem;
      }

      .privacy-category-header h3 {
        font-size: 0.95rem;
        color: var(--gray-700);
        margin-bottom: 0.25rem;
      }

      .privacy-category-header p {
        font-size: 0.8125rem;
        color: var(--gray-500);
      }

      .log-length-control {
        margin-top: 0.5rem;
        margin-left: 1.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .log-length-control input[type="range"] {
        flex: 1;
        height: 0.375rem;
        -webkit-appearance: none;
        background: var(--gray-300);
        border-radius: 0.25rem;
        outline: none;
      }

      .log-length-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .log-length-control input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }

      .log-length-value {
        font-size: 0.75rem;
        color: var(--gray-600);
        white-space: nowrap;
        min-width: 5.5rem;
      }

      /* 不同類型檔案的徽章樣式 */
      .badge-env {
        background: rgba(79, 70, 229, 0.1);
        color: var(--primary);
      }

      .badge-log {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
      }

      .badge-sensitive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      /* 處理中的視覺樣式 */
      .processing {
        position: relative;
      }

      .processing::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: var(--gray-700);
      }

      /* 檔案類型分類樣式 */
      .file-item.log-file {
        border-left: 3px solid var(--warning);
      }

      .file-item.env-file {
        border-left: 3px solid var(--primary);
      }

      /* 檔案處理進度顯示 */
      .progress-indicator {
        width: 100%;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: center;
      }

      .progress-text {
        font-size: 1.125rem;
        font-weight: 500;
        color: var(--gray-700);
      }

      .progress-bar {
        width: 100%;
        height: 0.5rem;
        background: var(--gray-200);
        border-radius: 1rem;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 1rem;
        transition: width 0.3s ease;
      }

      .progress-stats {
        font-size: 0.875rem;
        color: var(--gray-500);
      }

      /* 增強拖曳區域樣式 */
      .upload-section.drag-over {
        background-color: rgba(79, 70, 229, 0.1);
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        transform: scale(1.02);
      }

      .drop-instructions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: var(--gray-600);
        background: var(--gray-50);
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
      }

      .drop-instructions-title {
        font-weight: 500;
        color: var(--gray-700);
      }

      .drop-instructions ul {
        padding-left: 1.25rem;
      }

      .drop-instructions li {
        margin-bottom: 0.25rem;
      }
      /* 日誌控制相關樣式 */
      .log-days-control {
        margin-top: 0.5rem;
        margin-left: 1.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .log-days-control label {
        font-size: 0.8125rem;
        color: var(--gray-600);
      }

      .log-days-control input[type="range"] {
        flex: 1;
        height: 0.375rem;
        -webkit-appearance: none;
        background: var(--gray-300);
        border-radius: 0.25rem;
        outline: none;
      }

      .log-days-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: var(--warning);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .log-days-control input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }

      .log-days-value {
        font-size: 0.75rem;
        color: var(--gray-600);
        white-space: nowrap;
        min-width: 3rem;
        text-align: right;
      }

      /* 機密檔案警告樣式 */
      .secret-warning {
        background-color: rgba(239, 68, 68, 0.05);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-left: 3px solid var(--danger);
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1.5rem 0;
        color: var(--gray-700);
      }

      .secret-warning-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--danger);
      }

      .secret-warning-title svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      .secret-warning-message {
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .secret-file-list {
        margin-top: 0.5rem;
        padding-left: 1.5rem;
        font-size: 0.8125rem;
        color: var(--gray-600);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
      }

      /* 隱私設定區塊的樣式 */
      .privacy-section {
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
      }

      .privacy-section:hover {
        box-shadow: var(--shadow-md);
      }

      .sensitive-section {
        background: linear-gradient(
          to right,
          rgba(79, 70, 229, 0.05),
          rgba(79, 70, 229, 0.01)
        );
        border-left: 3px solid var(--primary);
      }

      .log-section {
        background: linear-gradient(
          to right,
          rgba(245, 158, 11, 0.05),
          rgba(245, 158, 11, 0.01)
        );
        border-left: 3px solid var(--warning);
        margin-top: 1.5rem;
      }

      /* 標題與控制按鈕樣式 */
      .privacy-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .privacy-section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .privacy-section-title h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-800);
        margin: 0;
      }

      .privacy-icon {
        color: var(--primary);
      }

      .log-icon {
        color: var(--warning);
      }

      .privacy-section-controls {
        display: flex;
        gap: 0.5rem;
      }

      .control-btn {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        background: var(--gray-100);
        border: none;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
        color: var(--gray-700);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .control-btn:hover {
        background: var(--gray-200);
      }

      .control-btn svg {
        width: 1rem;
        height: 1rem;
      }

      .toggle-all-btn {
        font-weight: 500;
      }

      .privacy-section-description {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin: 0 0 1.25rem 0;
      }

      /* 全局日誌天數控制樣式 */
      .global-log-days-control {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.25rem;
        box-shadow: var(--shadow-sm);
      }

      .days-control-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .days-control-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--gray-700);
      }

      .days-control-icon {
        width: 1.125rem;
        height: 1.125rem;
        color: var(--warning);
      }

      .days-value {
        font-weight: 600;
        color: var(--warning);
        background: rgba(245, 158, 11, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
      }

      .days-slider-container {
        padding: 0.25rem 0.5rem;
      }

      .days-slider {
        width: 100%;
        height: 0.375rem;
        -webkit-appearance: none;
        background: linear-gradient(to right, var(--warning), #f59e0b);
        border-radius: 0.25rem;
        outline: none;
        margin-bottom: 0.5rem;
      }

      .days-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 1.125rem;
        height: 1.125rem;
        border-radius: 50%;
        background: white;
        border: 2px solid var(--warning);
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.2s ease;
      }

      .days-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        background: var(--warning);
      }

      .days-labels {
        display: flex;
        justify-content: space-between;
        padding: 0 0.25rem;
      }

      .days-labels span {
        font-size: 0.6875rem;
        color: var(--gray-500);
        position: relative;
      }

      .days-labels span::before {
        content: "|";
        position: absolute;
        top: -0.5rem;
        left: 50%;
        transform: translateX(-50%);
        color: var(--gray-300);
        font-size: 0.75rem;
      }

      /* 改善隱私選項的布局 */
      .privacy-option {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        transition: all 0.2s ease;
      }

      .privacy-option:hover {
        border-color: var(--gray-300);
        box-shadow: var(--shadow-sm);
      }

      .privacy-checkbox {
        appearance: none;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid var(--gray-400);
        border-radius: 0.25rem;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-right: 0.75rem;
        flex-shrink: 0; /* 防止縮小 */
      }

      .privacy-checkbox:checked {
        background: var(--primary);
        border-color: var(--primary);
      }

      .privacy-checkbox:checked::after {
        content: "";
        position: absolute;
        top: 0.2rem;
        left: 0.35rem;
        width: 0.35rem;
        height: 0.6rem;
        border: solid white;
        border-width: 0 0.125rem 0.125rem 0;
        transform: rotate(45deg);
      }

      /* 修改標籤容器以確保正確的彈性布局 */
      .privacy-label {
        display: flex;
        align-items: center;
        width: 100%;
        font-size: 0.875rem;
        color: var(--gray-700);
        cursor: pointer;
      }

      /* 文件路徑文本可以縮小 */
      .file-path-text {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 0.75rem;
        min-width: 0; /* 允許縮小到最小 */
      }

      /* 確保標籤不會縮小 */
      .file-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        flex-shrink: 0; /* 防止標籤縮小 */
        white-space: nowrap; /* 防止標籤換行 */
      }

      .badge-log {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
      }

      .badge-sensitive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      .badge-env {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981; /* Emerald 600 */
      }

      /* 針對窄屏幕的響應式調整 */
      @media (max-width: 480px) {
        .privacy-option {
          flex-wrap: wrap;
        }

        .privacy-label {
          margin-top: 0.5rem;
          width: 100%;
        }

        .file-path-text {
          max-width: 100%;
          margin-bottom: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <svg
          class="logo"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 2L2 7L12 12L22 7L12 2Z"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M2 17L12 22L22 17"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M2 12L12 17L22 12"
            stroke="var(--primary)"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <circle cx="12" cy="12" r="2" fill="var(--primary)" />
        </svg>
        <h1>
          <span class="title-ch">智慧 Prompt 生成器</span>
          <span class="title-en">Smart Prompt Generator</span>
        </h1>
        <p>快速整理並生成結構化的 AI 提示文件</p>
      </div>

      <div class="upload-section" id="dropZone">
        <svg
          class="upload-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
        <input
          type="file"
          id="fileInput"
          class="file-input"
          multiple
          webkitdirectory
          directory
        />
        <p>拖放檔案或資料夾至此，或</p>
        <button
          class="upload-button"
          onclick="document.getElementById('fileInput').click()"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          選擇檔案或資料夾
        </button>
      </div>

      <!-- 隱私設定區域 -->
      <div class="privacy-settings" id="privacySettings" style="display: none">
        <div class="privacy-settings-header">
          <div class="privacy-settings-title">
            <svg
              class="privacy-settings-icon"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            隱私檔案設定
          </div>
          <button class="action-btn toggle-all" id="toggleAllPrivacy">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            全部顯示/隱藏
          </button>
        </div>
        <div class="privacy-options" id="privacyOptions">
          <!-- 隱私選項將在這裡動態生成 -->
        </div>
      </div>

      <div class="file-list" id="fileList">
        <!-- 檔案列表將在有檔案時動態生成 -->
      </div>

      <div class="version-control">
        <input
          type="text"
          class="version-input"
          id="versionName"
          placeholder="輸入版本名稱"
        />
        <button class="save-btn" onclick="saveVersion()">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
            />
            <polyline points="17 21 17 13 7 13 7 21" />
            <polyline points="7 3 7 8 15 8" />
          </svg>
          儲存版本
        </button>
      </div>

      <div class="saved-versions" id="savedVersions"></div>

      <div class="output-container" id="outputContainer">
        <div class="output-tabs">
          <div class="output-tab active" data-tab="content">檔案內容</div>
          <div class="output-tab" data-tab="structure">檔案結構</div>
        </div>
        <div class="copy-btn-container">
          <button class="copy-btn" onclick="copyOutput()" id="copyButton">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              class="icon-xs"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z"
                fill="currentColor"
              />
            </svg>
            複製
          </button>
        </div>
        <div class="output-pane active" id="contentPane">
          <pre class="output" id="output"></pre>
        </div>
        <div class="output-pane" id="structurePane">
          <pre class="output" id="structureOutput"></pre>
        </div>
      </div>
    </div>

    <!-- 模態框 -->
    <div id="modal" class="modal-backdrop">
      <div class="modal-content">
        <div class="modal-title" id="modalTitle"></div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>

    <!-- 吐司訊息容器 -->
    <div id="toast"></div>

    <script>
      let files = [];
      let savedVersions = [];
      let draggedItem = null;

      // 定義敏感性和隱私檔案擴展名
      const sensitiveExtensions = [
        "env",
        "env.example",
        "htpasswd",
        "pem",
        "key",
        "cert",
        "credentials",
        "secret",
      ];

      // 定義文本和二進位檔案的擴展名
      const textExtensions = [
        "js",
        "py",
        "java",
        "cpp",
        "html",
        "css",
        "jsx",
        "ts",
        "tsx",
        "php",
        "blade.php",
        "json",
        "md",
        "txt",
        "csv",
        "xml",
        "yml",
        "yaml",
        "sql",
        "conf",
        "gitignore",
        "dockerignore",
        "ps1",
        "sh",
        "env",
        "env.example",
        "htpasswd",
        "log",
        "config",
        "ini",
      ];

      const binaryExtensions = [
        "jpg",
        "jpeg",
        "png",
        "gif",
        "bmp",
        "svg",
        "ico",
        "pdf",
        "zip",
        "rar",
        "7z",
        "exe",
        "dll",
        "bin",
      ];

      // 初始化
      document.addEventListener("DOMContentLoaded", () => {
        setupDragAndDrop();
        setupFileInput();
        loadSavedVersions();
        setupOutputTabs();
      });

      // 設置輸出標籤頁切換
      function setupOutputTabs() {
        const tabs = document.querySelectorAll(".output-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            // 移除所有標籤頁和面板的 active 類
            document
              .querySelectorAll(".output-tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".output-pane")
              .forEach((p) => p.classList.remove("active"));

            // 添加當前標籤頁和對應面板的 active 類
            tab.classList.add("active");
            const tabId = tab.getAttribute("data-tab");
            document.getElementById(`${tabId}Pane`).classList.add("active");
          });
        });
      }

      // 從 localStorage 載入已儲存的版本
      function loadSavedVersions() {
        try {
          const savedData = localStorage.getItem("promptVersions");
          if (savedData) {
            savedVersions = JSON.parse(savedData);
            updateVersionsList();
          }
        } catch (err) {
          console.error("載入版本失敗:", err);
        }
      }

      // 儲存版本到 localStorage
      function saveVersionsToStorage() {
        try {
          localStorage.setItem("promptVersions", JSON.stringify(savedVersions));
        } catch (err) {
          console.error("儲存版本失敗:", err);
        }
      }

      // 修改拖放處理函數
      function setupDragAndDrop() {
        const dropZone = document.getElementById("dropZone");

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("drag-over");
        });

        dropZone.addEventListener("dragleave", () => {
          dropZone.classList.remove("drag-over");
        });

        dropZone.addEventListener("drop", async (e) => {
          e.preventDefault();
          dropZone.classList.remove("drag-over");

          // 顯示處理中訊息
          showToast("正在處理檔案，請稍候...", 10000);

          // 處理資料夾和檔案
          const items = e.dataTransfer.items;
          const entries = [];

          if (items && items[0] && items[0].webkitGetAsEntry) {
            // 使用 DataTransfer items 處理資料夾結構
            for (let i = 0; i < items.length; i++) {
              const item = items[i];
              if (item.kind === "file") {
                const entry = item.webkitGetAsEntry();
                if (entry) {
                  entries.push(entry);
                }
              }
            }

            // 遞迴處理所有檔案及資料夾
            await processEntries(entries);
          } else {
            // 退回到普通檔案處理方式
            handleFiles(e.dataTransfer.files);
          }
        });
      }

      // 遞迴處理資料夾和檔案，保留完整結構
      async function processEntries(entries) {
        const allFiles = [];
        let totalEntries = 0;
        let processedEntries = 0;
        let lastUpdateTime = Date.now();

        // 顯示進度指示器
        const dropZone = document.getElementById("dropZone");
        const originalText = dropZone.innerHTML;
        dropZone.classList.add("processing");

        function updateProgress() {
          if (totalEntries > 0) {
            const percent = Math.round((processedEntries / totalEntries) * 100);
            const now = Date.now();

            // 限制更新頻率，避免頻繁重繪降低性能
            if (now - lastUpdateTime > 200) {
              dropZone.innerHTML = `
                    <div class="progress-indicator">
                        <div class="progress-text">處理中... ${percent}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%"></div>
                        </div>
                        <div class="progress-stats">
                            已處理 ${processedEntries} / ${totalEntries} 個檔案
                        </div>
                    </div>
                `;
              lastUpdateTime = now;
            }
          }
        }

        // 計算檔案總數
        async function countEntries(entry, path = "") {
          return new Promise(async (resolve) => {
            if (entry.isFile) {
              totalEntries++;
              resolve(1);
            } else if (entry.isDirectory) {
              const dirReader = entry.createReader();

              dirReader.readEntries(
                async (entries) => {
                  let count = 0;

                  for (const e of entries) {
                    count += await countEntries(
                      e,
                      path ? `${path}/${entry.name}` : entry.name
                    );
                  }

                  resolve(count);
                },
                () => resolve(0)
              );
            } else {
              resolve(0);
            }
          });
        }

        // 先計算檔案總數
        for (const entry of entries) {
          await countEntries(entry);
        }

        updateProgress();

        // 更新處理單一 entry 的函數
        async function processEntry(entry, path = "") {
          return new Promise(async (resolve) => {
            const fullPath = path ? `${path}/${entry.name}` : entry.name;
            // 如果是 .git 資料夾或其內部檔案，直接跳過
            if (entry.name === ".git" || fullPath.includes("/.git/")) {
              console.log(`跳過 Git 相關檔案/資料夾: ${fullPath}`);
              processedEntries++;
              updateProgress();
              resolve();
              return;
            }

            if (entry.isFile) {
              // 先檢查檔案是否為敏感檔案
              const fileName = entry.name.toLowerCase();
              const fullPath = path ? `${path}/${entry.name}` : entry.name;

              // 檢查是否為 .env 檔案
              if (fileName.endsWith(".env") || fileName.includes(".env.")) {
                console.log(`跳過敏感檔案: ${fullPath}`);
                processedEntries++;
                updateProgress();
                resolve();
                return;
              }

              // 檢查是否匹配 gitignore 規則
              if (
                gitignorePatterns.length > 0 &&
                isIgnoredByGitignore(fullPath, gitignorePatterns)
              ) {
                console.log(`根據 .gitignore 規則跳過: ${fullPath}`);
                processedEntries++;
                updateProgress();
                resolve();
                return;
              }

              entry.file(
                (file) => {
                  // 設定相對路徑
                  const fileWithPath = new File([file], entry.name, {
                    type: file.type,
                  });
                  fileWithPath.webkitRelativePath = fullPath;

                  allFiles.push(fileWithPath);
                  processedEntries++;
                  updateProgress();
                  resolve();
                },
                () => {
                  processedEntries++;
                  updateProgress();
                  resolve();
                }
              );
            } else if (entry.isDirectory) {
              const dirReader = entry.createReader();
              const dirPath = path ? `${path}/${entry.name}` : entry.name;

              // 讀取資料夾內容
              dirReader.readEntries(async (entries) => {
                const promises = entries.map((e) => processEntry(e, dirPath));
                await Promise.all(promises);
                resolve();
              }, resolve);
            } else {
              resolve();
            }
          });
        }

        // 處理所有 entries
        await Promise.all(entries.map((entry) => processEntry(entry)));

        // 恢復原始狀態
        dropZone.classList.remove("processing");
        dropZone.innerHTML = originalText;

        // 處理收集到的檔案
        if (allFiles.length > 0) {
          await handleFiles(allFiles);
          showToast(`成功處理 ${allFiles.length} 個檔案`);
        } else {
          showToast("未找到任何檔案");
        }
      }
      // 新增：遞迴處理資料夾和檔案
      async function processEntries(entries) {
        const allFiles = [];

        // 處理單一 entry (檔案或資料夾)
        async function processEntry(entry, path = "") {
          return new Promise(async (resolve) => {
            if (entry.isFile) {
              // 處理檔案
              entry.file((file) => {
                // 設定相對路徑
                const fullPath = path ? `${path}/${entry.name}` : entry.name;

                // 創建一個新的 File 物件，附帶相對路徑資訊
                const fileWithPath = new File([file], entry.name, {
                  type: file.type,
                });
                fileWithPath.webkitRelativePath = fullPath;

                allFiles.push(fileWithPath);
                resolve();
              }, resolve);
            } else if (entry.isDirectory) {
              // 處理資料夾
              const dirReader = entry.createReader();
              const dirPath = path ? `${path}/${entry.name}` : entry.name;

              // 讀取資料夾內容
              dirReader.readEntries(async (entries) => {
                const promises = entries.map((e) => processEntry(e, dirPath));
                await Promise.all(promises);
                resolve();
              }, resolve);
            } else {
              resolve();
            }
          });
        }

        // 處理所有 entries
        await Promise.all(entries.map((entry) => processEntry(entry)));

        // 處理收集到的檔案
        if (allFiles.length > 0) {
          await handleFiles(allFiles);
        } else {
          showToast("未找到任何檔案");
        }
      }

      // 擴展應該被忽略的系統檔案列表
      function isSystemOrHiddenFile(fileName, filePath) {
        // 常見的系統和隱藏檔案
        const systemFiles = [
          ".DS_Store", // macOS 目錄資訊檔案
          "Thumbs.db", // Windows 縮圖快取
          "desktop.ini", // Windows 資料夾設定
          ".directory", // KDE 資料夾設定
          "__MACOSX", // macOS 資源檔案資料夾
          "._*", // macOS 資源檔案
          ".AppleDouble", // macOS 檔案屬性
          ".LSOverride", // macOS 檔案屬性
        ];

        // 檢查檔名是否在系統檔案列表中
        for (const pattern of systemFiles) {
          if (pattern.includes("*")) {
            // 處理萬用字元模式 (如 ._*)
            const regex = new RegExp("^" + pattern.replace("*", ".*") + "$");
            if (regex.test(fileName)) {
              return true;
            }
          } else if (fileName === pattern || filePath.endsWith("/" + pattern)) {
            return true;
          }
        }

        return false;
      }

      // 擴展機密文件的檢查函數，增加對 .git 資料夾的阻擋
      function isSecretFile(fileName, filePath) {
        // 檢查是否為系統或隱藏檔案
        if (isSystemOrHiddenFile(fileName, filePath)) {
          return true;
        }
        // 檢查是否為 .git 資料夾或其內部檔案
        if (
          filePath.includes("/.git/") ||
          filePath === ".git" ||
          filePath.startsWith(".git/")
        ) {
          return true;
        }

        // 檢查 .env 文件
        if (fileName.endsWith(".env") || fileName.includes(".env.")) {
          return true;
        }

        // 檢查其他可能的機密文件
        const secretPatterns = [
          ".pem",
          ".key",
          ".cert",
          ".p12",
          ".pfx",
          ".keystore",
          "secret",
          "credentials",
          "password",
          "id_rsa",
          "id_dsa",
          ".htpasswd",
        ];

        for (const pattern of secretPatterns) {
          if (fileName.includes(pattern) || filePath.includes(pattern)) {
            return true;
          }
        }

        return false;
      }

      // 修改檔案處理函數，絕對禁止上傳機密文件
      async function handleFiles(fileList) {
        // 將 fileList 轉換為數組以便於操作
        const filesArray = Array.from(fileList);
        let failedFiles = [];
        let skippedSecretFiles = [];
        let hasSensitiveFiles = false;
        let hasGitignore = false;

        // 先檢查是否有 .gitignore 文件
        const gitignoreFile = filesArray.find(
          (file) =>
            file.name === ".gitignore" ||
            file.webkitRelativePath.endsWith("/.gitignore")
        );

        // 如果找到 .gitignore，先讀取其內容
        if (gitignoreFile) {
          hasGitignore = true;
          try {
            const { content } = await readFileContent(gitignoreFile);
            gitignorePatterns = parseGitignoreContent(content);
          } catch (err) {
            console.error("讀取 .gitignore 失敗", err);
          }
        }

        // 處理所有檔案，應用 gitignore 規則
        for (const file of filesArray) {
          // 檢查是否為檔案
          if (!file.type && file.size === 0 && !file.name.includes(".")) {
            console.warn(`跳過資料夾項目：${file.name || "未知"}`);
            continue;
          }

          try {
            const filePath = file.webkitRelativePath || file.name;
            const fileName = file.name.toLowerCase();

            // 檢查是否為機密文件
            if (isSecretFile(fileName, filePath)) {
              console.log(`跳過機密檔案：${filePath}`);
              skippedSecretFiles.push(filePath);
              continue;
            }

            // 檢查是否匹配 gitignore 規則
            if (
              hasGitignore &&
              isIgnoredByGitignore(filePath, gitignorePatterns)
            ) {
              console.log(`根據 .gitignore 規則忽略：${filePath}`);
              continue;
            }

            // 繼續讀取其他檔案
            console.log(`開始讀取檔案：${filePath}，大小：${file.size} 字節`);
            const { content, type, isEmpty } = await readFileContent(file);

            // 檢查是否為敏感檔案
            const isSensitive = checkIfSensitiveFile(fileName, filePath);
            if (isSensitive) {
              hasSensitiveFiles = true;
            }

            // 檢查是否為日誌檔案
            const isLogFile =
              fileName.endsWith(".log") ||
              filePath.includes("/logs/") ||
              filePath.includes("/log/");

            let fileCategory = "normal";
            if (isLogFile) {
              fileCategory = "log";
            } else if (isSensitive) {
              fileCategory = "sensitive";
            }

            // 檢查是否為 Dockerfile
            const isDockerfile =
              fileName === "dockerfile" || fileName.includes("dockerfile");

            files.push({
              id: Math.random().toString(36).substr(2, 9),
              name: file.name,
              path: filePath,
              content,
              type: isDockerfile ? "text" : type, // 確保 Dockerfile 被視為文字檔案
              isSensitive,
              isHidden: isSensitive, // 預設隱藏敏感檔案
              isEmpty: isEmpty || file.size === 0,
              fileCategory,
              // 對於日誌檔案，添加日誌特定屬性
              ...(isLogFile
                ? {
                    displayDays: 1, // 預設顯示天數
                    totalLength: content ? content.length : 0,
                    parsedContent: isLogFile ? parseLogContent(content) : null,
                  }
                : {}),
            });
          } catch (err) {
            console.error(`讀取檔案失敗：${file.name}`, err);
            failedFiles.push(file.name);
          }
        }

        // 處理各種提示
        if (skippedSecretFiles.length > 0) {
          showModal(
            "已跳過機密檔案",
            `為了保護您的資訊安全，以下機密檔案已被跳過：\n\n${skippedSecretFiles.join(
              "\n"
            )}`,
            [{ text: "了解", onClick: "hideModal()", primary: true }]
          );
        }

        if (hasGitignore) {
          showToast("已套用 .gitignore 忽略規則");
        }

        if (failedFiles.length > 0) {
          showModal(
            "讀取部分檔案失敗",
            `無法讀取以下檔案：\n${failedFiles.join("\n")}`,
            [{ text: "確認", onClick: "hideModal()", primary: true }]
          );
        }

        if (hasSensitiveFiles) {
          showModal(
            "偵測到敏感檔案",
            "已自動標記並隱藏可能包含敏感資訊的檔案。您可以在「隱私檔案設定」中調整顯示設定。",
            [{ text: "了解", onClick: "hideModal()", primary: true }]
          );
        }

        updateUI();
        updatePrivacySettings();
      }

      // 解析日誌內容，按日期分組
      function parseLogContent(content) {
        if (!content) return [];

        const lines = content.split("\n");
        const dateRegex = /\b(\d{4}[-/]\d{1,2}[-/]\d{1,2})\b/;
        const timeRegex = /\b(\d{1,2}:\d{1,2}:\d{1,2}(?:\.\d+)?)\b/;

        // 日誌條目分組
        const entriesByDate = {};
        let currentDate = "unknown";
        let currentEntries = [];

        lines.forEach((line) => {
          // 嘗試從行中提取日期
          const dateMatch = line.match(dateRegex);
          if (dateMatch) {
            const foundDate = normalizeDate(dateMatch[1]);

            // 如果找到新日期，儲存當前條目並重新開始
            if (foundDate !== currentDate && currentEntries.length > 0) {
              if (!entriesByDate[currentDate]) {
                entriesByDate[currentDate] = [];
              }
              entriesByDate[currentDate] =
                entriesByDate[currentDate].concat(currentEntries);
              currentEntries = [];
            }

            currentDate = foundDate;
          }

          // 添加到當前日期的條目中
          currentEntries.push(line);
        });

        // 存儲最後一批條目
        if (currentEntries.length > 0) {
          if (!entriesByDate[currentDate]) {
            entriesByDate[currentDate] = [];
          }
          entriesByDate[currentDate] =
            entriesByDate[currentDate].concat(currentEntries);
        }

        return entriesByDate;
      }

      // 標準化日期格式
      function normalizeDate(dateStr) {
        // 將各種日期格式（如 2023/05/12 或 2023-5-12）轉為標準格式（如 2023-05-12）
        const parts = dateStr.split(/[-/]/);
        if (parts.length === 3) {
          const year = parts[0];
          const month = parts[1].padStart(2, "0");
          const day = parts[2].padStart(2, "0");
          return `${year}-${month}-${day}`;
        }
        return dateStr;
      }

      // 獲取今天的日期字串
      function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // 獲取前N天的日期字串
      function getDateString(daysAgo) {
        const date = new Date();
        date.setDate(date.getDate() - daysAgo);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // 生成日誌的 Markdown 顯示內容
      function generateLogMarkdown(file) {
        const parsedContent = file.parsedContent || {};
        const displayDays = file.displayDays || 1;
        let markdown = "";

        // 開始日誌內容區塊
        markdown += `<div class="log-content">`;

        // 日誌標題與資訊
        markdown += `
        <div class="log-header">
            <div class="log-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                ${file.name}
            </div>
            <div class="log-info">顯示最近 ${displayDays} 天的日誌</div>
        </div>
    `;

        // 獲取要顯示的日期範圍
        const datesToShow = [];
        for (let i = 0; i < displayDays; i++) {
          datesToShow.push(getDateString(i));
        }

        // 找到匹配的日期條目
        let hasContent = false;

        // 按照日期從最近到最早的順序處理
        datesToShow
          .sort()
          .reverse()
          .forEach((date) => {
            if (parsedContent[date]) {
              hasContent = true;

              // 添加日期區塊
              markdown += `<div class="log-date-section">`;
              markdown += `<div class="log-date-header">${date}</div>`;

              // 添加該日的日誌內容
              markdown += "```log\n";
              markdown += parsedContent[date].join("\n");
              markdown += "\n```\n";

              markdown += `</div>`;
            }
          });

        if (!hasContent) {
          markdown += `<div style="padding: 1rem; color: var(--gray-500); text-align: center;">找不到指定日期範圍內的日誌條目</div>`;
        }

        // 結束日誌內容區塊
        markdown += `</div>`;

        return markdown;
      }
      // 更新日誌顯示天數
      function updateLogDisplayDays(fileId, days) {
        const fileIndex = files.findIndex((f) => f.id === fileId);
        if (fileIndex !== -1) {
          files[fileIndex].displayDays = days;
          updateUI();
        }
      }

      // 全域變數存儲 gitignore 規則
      let gitignorePatterns = [];

      // 優化 gitignore 內容解析
      function parseGitignoreContent(content) {
        return content
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line && !line.startsWith("#"))
          .map((pattern) => {
            // 處理 gitignore 的特殊符號
            let processedPattern = pattern;

            // 檢查是否為否定模式
            const isNegated = pattern.startsWith("!");
            if (isNegated) {
              processedPattern = pattern.substring(1);
            }

            // 處理目錄標記
            if (processedPattern.endsWith("/")) {
              processedPattern = processedPattern.slice(0, -1);
            }

            // 轉換 gitignore 模式為正則表達式
            let regexPattern = "";

            if (processedPattern.startsWith("/")) {
              // 開頭為 '/' 表示根目錄開始匹配
              regexPattern = "^" + processedPattern.substring(1);
            } else {
              // 一般模式
              regexPattern = processedPattern;

              // 如果沒有路徑分隔符且不以 * 開頭，匹配任何路徑
              if (
                !regexPattern.includes("/") &&
                !regexPattern.startsWith("*")
              ) {
                regexPattern = `(^|/)${regexPattern}`;
              }
            }

            // 處理特殊字元
            regexPattern = regexPattern
              .replace(/\./g, "\\.") // 轉義點號
              .replace(/\*/g, ".*") // * 轉為任意字元
              .replace(/\?/g, ".") // ? 轉為單一字元
              .replace(/\//g, "\\/"); // 轉義斜線

            // 處理雙星號 (匹配任意目錄層級)
            regexPattern = regexPattern.replace(/\.\*\.\*/g, ".*");

            // 如果沒有明確的路徑分隔符，允許匹配任意層級
            if (!pattern.includes("/")) {
              regexPattern = `(^|.*\\/)${regexPattern}(\\/.*)?\$`;
            } else {
              regexPattern = `^${regexPattern}(\\/.*)?\$`;
            }

            return {
              pattern: new RegExp(regexPattern),
              isNegated,
            };
          });
      }

      // 檢查文件是否被 gitignore 忽略
      function isIgnoredByGitignore(filePath, patterns) {
        let ignored = false;

        // 依次應用每條規則
        for (const { pattern, isNegated } of patterns) {
          if (pattern.test(filePath)) {
            ignored = !isNegated; // 否定模式則不忽略
          }
        }

        return ignored;
      }

      // 檢查文件是否匹配 gitignore 規則
      function isIgnoredByGitignore(filePath, patterns) {
        // 預設不忽略
        let ignored = false;

        // 依次應用每個規則
        for (const { pattern, isNegated } of patterns) {
          if (pattern.test(filePath)) {
            // 如果匹配了否定模式，不忽略
            if (isNegated) {
              ignored = false;
            } else {
              // 匹配了普通模式，忽略
              ignored = true;
            }
          }
        }

        return ignored;
      }

      // 自定義檔案分類器
      function categorizeFile(file) {
        const filePath = file.webkitRelativePath || file.name;
        const fileName = file.name.toLowerCase();

        // 環境變數檔案
        if (fileName.endsWith(".env") || fileName.includes(".env.")) {
          return "env";
        }

        // 日誌檔案
        if (
          fileName.endsWith(".log") ||
          filePath.includes("/logs/") ||
          filePath.includes("/log/")
        ) {
          return "log";
        }

        // 敏感檔案
        if (checkIfSensitiveFile(fileName, filePath)) {
          return "sensitive";
        }

        // 一般檔案
        return "normal";
      } // 檢查文件是否匹配 gitignore 規則

      // 設置文件輸入
      function setupFileInput() {
        document.getElementById("fileInput").addEventListener("change", (e) => {
          handleFiles(e.target.files);
        });
      }

      // 檢查是否為敏感檔案
      function checkIfSensitiveFile(fileName, filePath) {
        // 檢查檔案副檔名或名稱特徵
        if (
          fileName.endsWith(".env") ||
          fileName.includes(".env.") ||
          fileName.endsWith(".htpasswd") ||
          fileName.endsWith(".pem") ||
          fileName.endsWith(".key") ||
          fileName === ".gitignore" ||
          fileName === ".dockerignore"
        ) {
          return true;
        }

        // 檢查檔案路徑中的關鍵字
        const sensitiveKeywords = [
          "secret",
          "password",
          "credential",
          "token",
          "auth",
          "key",
          "pem",
          "cert",
        ];
        const lowerPath = filePath.toLowerCase();

        return sensitiveKeywords.some((keyword) => lowerPath.includes(keyword));
      }

      // 更新隱私設定區域
      function updatePrivacySettings() {
        const privacySettings = document.getElementById("privacySettings");

        // 檢查是否有敏感檔案或日誌檔案
        const sensitiveFiles = files.filter((file) => file.isSensitive);
        const logFiles = files.filter((file) => file.fileCategory === "log");

        if (sensitiveFiles.length === 0 && logFiles.length === 0) {
          privacySettings.style.display = "none";
          return;
        }

        // 重新建構設定區域
        privacySettings.style.display = "block";
        privacySettings.innerHTML = "";

        // 1. 敏感檔案區塊
        if (sensitiveFiles.length > 0) {
          const sensitiveSection = document.createElement("div");
          sensitiveSection.className = "privacy-section sensitive-section";

          // 敏感檔案標題與控制按鈕
          const sensitiveHeader = document.createElement("div");
          sensitiveHeader.className = "privacy-section-header";
          sensitiveHeader.innerHTML = `
            <div class="privacy-section-title">
                <svg class="privacy-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <h3>敏感檔案設定</h3>
            </div>
            <div class="privacy-section-controls">
                <button class="control-btn toggle-all-btn" id="toggleAllSensitive">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>全部顯示</span>
                </button>
            </div>
        `;
          sensitiveSection.appendChild(sensitiveHeader);

          // 敏感檔案描述
          const sensitiveDesc = document.createElement("p");
          sensitiveDesc.className = "privacy-section-description";
          sensitiveDesc.textContent =
            "這些檔案可能包含敏感資訊，預設為隱藏狀態";
          sensitiveSection.appendChild(sensitiveDesc);

          // 敏感檔案選項容器
          const sensitiveOptions = document.createElement("div");
          sensitiveOptions.className = "privacy-options";
          sensitiveFiles.forEach((file) => {
            sensitiveOptions.appendChild(createPrivacyOption(file));
          });
          sensitiveSection.appendChild(sensitiveOptions);

          // 添加敏感檔案區塊到設定區域
          privacySettings.appendChild(sensitiveSection);

          // 設置切換按鈕事件
          document
            .getElementById("toggleAllSensitive")
            .addEventListener("click", function () {
              toggleAllSensitiveFiles();
              updateToggleButtonText(
                this,
                "全部顯示",
                "全部隱藏",
                files.some(
                  (file) =>
                    file.isSensitive &&
                    file.fileCategory !== "log" &&
                    !file.isHidden
                )
              );
            });
        }

        // 2. 日誌檔案區塊
        if (logFiles.length > 0) {
          const logSection = document.createElement("div");
          logSection.className = "privacy-section log-section";

          // 日誌檔案標題與控制按鈕
          const logHeader = document.createElement("div");
          logHeader.className = "privacy-section-header";
          logHeader.innerHTML = `
            <div class="privacy-section-title">
                <svg class="privacy-icon log-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <h3>日誌檔案設定</h3>
            </div>
            <div class="privacy-section-controls">
                <button class="control-btn toggle-all-btn" id="toggleAllLogs">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>全部顯示</span>
                </button>
            </div>
        `;
          logSection.appendChild(logHeader);

          // 日誌檔案描述
          const logDesc = document.createElement("p");
          logDesc.className = "privacy-section-description";
          logDesc.textContent = "設定所有日誌檔案的顯示範圍";
          logSection.appendChild(logDesc);

          // 全局日誌天數控制
          const globalDaysControl = document.createElement("div");
          globalDaysControl.className = "global-log-days-control";
          globalDaysControl.innerHTML = `
            <div class="days-control-header">
                <div class="days-control-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="days-control-icon">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>顯示最近日誌天數</span>
                </div>
                <div class="days-value" id="globalDaysValue">1 天</div>
            </div>
            <div class="days-slider-container">
                <input type="range" 
                       id="globalLogDays" 
                       class="days-slider"
                       min="1" 
                       max="30" 
                       step="1" 
                       value="1">
                <div class="days-labels">
                    <span>1天</span>
                    <span>7天</span>
                    <span>14天</span>
                    <span>30天</span>
                </div>
            </div>
        `;
          logSection.appendChild(globalDaysControl);

          // 日誌檔案選項容器
          const logOptions = document.createElement("div");
          logOptions.className = "privacy-options";
          logFiles.forEach((file) => {
            logOptions.appendChild(createPrivacyOption(file));
          });
          logSection.appendChild(logOptions);

          // 添加日誌檔案區塊到設定區域
          privacySettings.appendChild(logSection);

          // 設置切換按鈕事件
          document
            .getElementById("toggleAllLogs")
            .addEventListener("click", function () {
              toggleAllLogFiles();
              updateToggleButtonText(
                this,
                "全部顯示",
                "全部隱藏",
                files.some(
                  (file) => file.fileCategory === "log" && !file.isHidden
                )
              );
            });

          // 設置全局日誌天數控制事件
          document
            .getElementById("globalLogDays")
            .addEventListener("input", function (e) {
              const days = parseInt(e.target.value);
              document.getElementById(
                "globalDaysValue"
              ).textContent = `${days} 天`;
              updateAllLogDisplayDays(days);
            });
        }
      }

      // 更新切換按鈕文字
      function updateToggleButtonText(
        button,
        showText,
        hideText,
        isAnyVisible
      ) {
        const textSpan = button.querySelector("span");
        textSpan.textContent = isAnyVisible ? hideText : showText;
      }

      // 更新所有日誌檔案的顯示天數
      function updateAllLogDisplayDays(days) {
        files.forEach((file) => {
          if (file.fileCategory === "log") {
            file.displayDays = days;
          }
        });
        updateUI();
      }

      // 切換所有日誌檔案的顯示/隱藏
      function toggleAllLogFiles() {
        // 檢查目前是否有隱藏的日誌檔案
        const hasHiddenLogs = files.some(
          (file) => file.fileCategory === "log" && file.isHidden
        );

        // 根據目前狀態切換所有日誌檔案的顯示/隱藏
        files.forEach((file) => {
          if (file.fileCategory === "log") {
            file.isHidden = !hasHiddenLogs;
          }
        });

        // 更新 UI
        updateUI();
        updatePrivacySettings();
      }

      // 切換所有敏感檔案的顯示/隱藏
      function toggleAllSensitiveFiles() {
        // 檢查目前是否有隱藏的敏感檔案
        const hasHiddenFiles = files.some(
          (file) =>
            file.isSensitive && file.fileCategory !== "log" && file.isHidden
        );

        // 根據目前狀態切換所有敏感檔案的顯示/隱藏
        files.forEach((file) => {
          if (file.isSensitive && file.fileCategory !== "log") {
            file.isHidden = !hasHiddenFiles;
          }
        });

        // 更新 UI
        updateUI();
        updatePrivacySettings();
      }

      // 建立隱私選項元素
      function createPrivacyOption(file) {
        const optionDiv = document.createElement("div");
        optionDiv.className = "privacy-option";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "privacy-checkbox";
        checkbox.id = `privacy-${file.id}`;
        checkbox.checked = !file.isHidden;
        checkbox.addEventListener("change", () =>
          toggleFileVisibility(file.id, !checkbox.checked)
        );

        const label = document.createElement("label");
        label.className = "privacy-label";
        label.htmlFor = `privacy-${file.id}`;

        // 檔案路徑
        const pathSpan = document.createElement("span");
        pathSpan.textContent = file.path;
        pathSpan.className = "file-path-text";
        label.appendChild(pathSpan);

        // 根據檔案類型添加不同標籤
        const badge = document.createElement("span");
        badge.className = "file-badge";

        if (file.fileCategory === "env") {
          badge.className += " badge-env";
          badge.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            環境變數
        `;
        } else if (file.fileCategory === "log") {
          badge.className += " badge-log";
          badge.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            日誌檔案
        `;
        } else if (file.isSensitive) {
          badge.className += " badge-sensitive";
          badge.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            敏感
        `;
        }

        label.appendChild(badge);
        optionDiv.appendChild(checkbox);
        optionDiv.appendChild(label);

        return optionDiv;
      }
      // 更新日誌檔案顯示長度
      function updateLogDisplayLength(fileId, newLength) {
        const fileIndex = files.findIndex((f) => f.id === fileId);
        if (fileIndex !== -1) {
          files[fileIndex].displayLength = newLength;
          files[fileIndex].isTruncated =
            newLength < files[fileIndex].totalLength;
          updateUI();
        }
      }

      // 格式化位元組量為易讀格式
      function formatBytes(bytes) {
        if (bytes < 1024) {
          return bytes + " 字元";
        } else {
          return (bytes / 1024).toFixed(1) + " KB";
        }
      }

      // 切換檔案可見性
      function toggleFileVisibility(fileId, isHidden) {
        const fileIndex = files.findIndex((f) => f.id === fileId);
        if (fileIndex !== -1) {
          files[fileIndex].isHidden = isHidden;
          updateUI();
        }
      }

      // 切換所有隱私檔案的顯示/隱藏
      function toggleAllPrivacyFiles() {
        // 檢查目前是否有隱藏的敏感檔案
        const hasHiddenFiles = files.some(
          (file) => file.isSensitive && file.isHidden
        );

        // 根據目前狀態切換所有敏感檔案的顯示/隱藏
        files.forEach((file) => {
          if (file.isSensitive) {
            file.isHidden = !hasHiddenFiles;
          }
        });

        // 更新 UI 和隱私設定
        updateUI();
        updatePrivacySettings();
      }

      // 更新文件內容讀取函數，正確處理 Dockerfile
      function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          const ext = file.name.split(".").pop().toLowerCase();
          const fileName = file.name.toLowerCase();
          let typeCategory = "binary";

          // 檢查文件是否為空
          if (file.size === 0) {
            resolve({ content: "", type: "text", isEmpty: true });
            return;
          }

          // 檢查是否為 Dockerfile
          if (fileName === "dockerfile" || fileName.includes("dockerfile")) {
            typeCategory = "text";
          }
          // 檢查其他文字檔案類型
          else if (
            textExtensions.includes(ext) ||
            fileName === ".gitignore" ||
            fileName === ".dockerignore"
          ) {
            typeCategory = "text";
          } else if (binaryExtensions.includes(ext)) {
            typeCategory = "binary";
          } else {
            // 嘗試識別無擴展名的文本文件
            if (
              file.type.startsWith("text/") ||
              file.type === "application/json" ||
              file.type === "application/xml"
            ) {
              typeCategory = "text";
            } else {
              typeCategory = "binary";
            }
          }

          if (typeCategory === "text") {
            reader.onload = (e) => {
              const content = e.target.result || "";
              const isEmpty = content.length === 0;
              resolve({ content, type: "text", isEmpty });
            };
            reader.onerror = (e) => {
              console.error(`FileReader 錯誤：${file.name}`, e);
              reject(e);
            };
            reader.readAsText(file);
          } else {
            reader.onload = (e) => {
              const content = e.target.result;
              const isEmpty = content && content.byteLength === 0;
              resolve({ content, type: "binary", isEmpty });
            };
            reader.onerror = (e) => {
              console.error(`FileReader 錯誤：${file.name}`, e);
              reject(e);
            };
            reader.readAsArrayBuffer(file);
          }
        });
      }

      // 獲取文件語言 (用於程式碼高亮)，增加 Dockerfile 支援
      function getFileLanguage(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const fileName = filename.toLowerCase();

        // 處理 Dockerfile
        if (fileName === "dockerfile" || fileName.includes("dockerfile")) {
          return "dockerfile";
        }

        // 處理其他特殊檔案類型
        if (fileName === ".gitignore" || fileName === ".dockerignore") {
          return "text";
        }

        if (fileName.endsWith(".env") || fileName.includes(".env.")) {
          return "env";
        }

        // ... 其他檔案類型處理 ...

        const extToLanguage = {
          js: "javascript",
          jsx: "jsx",
          ts: "typescript",
          tsx: "tsx",
          py: "python",
          java: "java",
          cpp: "cpp",
          c: "c",
          cs: "csharp",
          php: "php",
          html: "html",
          css: "css",
          json: "json",
          xml: "xml",
          md: "markdown",
          sql: "sql",
          yml: "yaml",
          yaml: "yaml",
        };

        return extToLanguage[ext] || "text";
      }

      // 獲取文件類型
      function getFileType(filename) {
        const ext = filename.split(".").pop().toLowerCase();

        // 新增對 .md 的明確處理
        if (
          textExtensions.includes(ext) ||
          filename === ".gitignore" ||
          filename === ".dockerignore" ||
          filename.endsWith(".env") ||
          filename.includes(".env.") ||
          ext === "md"
        ) {
          return "text";
        } else if (binaryExtensions.includes(ext)) {
          return "binary";
        } else {
          return "unknown";
        }
      }

      // 更新UI
      function updateUI() {
        updateFileList();
        updateOutput();
        updateVersionsList();
      }

      // 更新檔案列表顯示
      function updateFileList() {
        const fileList = document.getElementById("fileList");

        if (files.length === 0) {
          fileList.innerHTML = "";
          return;
        }

        // 清除現有列表內容
        fileList.innerHTML = `
        <div class="file-list-header">
            <h2>檔案列表</h2>
            <button class="download-all-button" onclick="downloadAllFiles()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                    <polyline points="12 15 12 3" />
                    <path d="M16 11l-4 4-4-4" />
                </svg>
                下載全部
            </button>
        </div>
    `;

        // 對檔案進行分類排序
        const sortedFiles = [...files].sort((a, b) => {
          // 先按照資料夾路徑排序
          const pathA = a.path.split("/").slice(0, -1).join("/");
          const pathB = b.path.split("/").slice(0, -1).join("/");

          if (pathA !== pathB) {
            return pathA.localeCompare(pathB);
          }

          // 同一目錄下，先顯示目錄結構相關檔案(.gitignore 等)
          const specialFileA = isSpecialFile(a.name);
          const specialFileB = isSpecialFile(b.name);

          if (specialFileA && !specialFileB) return -1;
          if (!specialFileA && specialFileB) return 1;

          // 其次按照檔案名稱排序
          return a.name.localeCompare(b.name);
        });

        // 建立目錄路徑映射，以便分組顯示
        const directoryMap = {};

        sortedFiles.forEach((file, index) => {
          // 跳過隱藏的檔案
          if (file.isHidden) {
            return;
          }

          const pathParts = file.path.split("/");
          const directory =
            pathParts.length > 1 ? pathParts.slice(0, -1).join("/") : "/";

          if (!directoryMap[directory]) {
            directoryMap[directory] = [];
          }

          directoryMap[directory].push({ file, index });
        });

        // 依目錄分組顯示檔案
        Object.keys(directoryMap)
          .sort()
          .forEach((directory) => {
            if (directory !== "/") {
              // 添加目錄標題
              const directoryHeader = document.createElement("div");
              directoryHeader.className = "directory-header";
              directoryHeader.innerHTML = `
                <div class="directory-name">
                    <svg class="directory-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    ${directory}
                </div>
            `;
              fileList.appendChild(directoryHeader);
            }

            // 添加該目錄下的檔案
            directoryMap[directory].forEach(({ file, index }) => {
              const fileItem = createFileItem(file, index);
              fileList.appendChild(fileItem);
            });
          });
      }

      // 判斷是否為特殊檔案
      function isSpecialFile(fileName) {
        return (
          fileName === ".gitignore" ||
          fileName === ".dockerignore" ||
          fileName.endsWith(".env") ||
          fileName.includes(".env.")
        );
      }

      // 建立單一檔案元素
      function createFileItem(file, index) {
        const fileItem = document.createElement("div");
        fileItem.classList.add("file-item");

        // 根據檔案類型添加不同的樣式
        if (file.fileCategory === "env") {
          fileItem.classList.add("env-file");
        } else if (file.fileCategory === "log") {
          fileItem.classList.add("log-file");
        } else if (file.isSensitive) {
          fileItem.classList.add("sensitive-file");
        }

        if (file.isEmpty) {
          fileItem.classList.add("empty-file");
        }

        fileItem.setAttribute("draggable", "true");
        fileItem.dataset.index = index;

        // 準備檔案圖示與顯示內容
        let displayContent = "";
        let icon = "";

        const fileName = file.name.toLowerCase();
        const ext = file.name.split(".").pop().toLowerCase();

        // 根據檔案類型選擇適當的圖示和顯示內容
        if (file.isEmpty) {
          icon = `
            <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
        `;
          displayContent = `<span class="file-path">${file.path} <span class="tag tag-empty">空檔案</span></span>`;
        } else if (file.fileCategory === "env") {
          icon = `
            <svg class="file-icon sensitive" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        `;
          displayContent = `<span class="file-path">${file.path} <span class="tag badge-env">環境變數</span></span>`;
        } else if (file.fileCategory === "log") {
          icon = `
            <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <line x1="10" y1="9" x2="8" y2="9"></line>
            </svg>
        `;
          const logSize = formatBytes(file.totalLength);
          displayContent = `<span class="file-path">${file.path} <span class="tag badge-log">日誌 ${logSize}</span></span>`;
        } else if (file.type === "text") {
          // 處理特殊文字檔案...
          if (fileName === ".gitignore" || fileName === ".dockerignore") {
            icon = `
                <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8 0-4.42 3.58-8 8-8 4.42 0 8 3.58 8 8 0 4.42-3.58 8-8 8z"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
            `;
            displayContent = `<span class="file-path">${file.path} <span class="tag">忽略檔</span></span>`;
          } else {
            // 其他文字檔案...
            icon = `
                <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
            `;
            displayContent = `<span class="file-path">${file.path}</span>`;
          }
        } else if (file.type === "binary") {
          icon = `
            <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
        `;
          displayContent = `<span class="file-path">${file.path} <span class="tag">二進位檔案</span></span>`;
        } else {
          icon = `
            <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
        `;
          displayContent = `<span class="file-path">${file.path} <span class="tag">未知類型</span></span>`;
        }

        // 建立檔案操作按鈕
        const fileActions = `
        <div class="file-actions">
            <button class="action-btn download" onclick="downloadFile('${
              file.id
            }')" title="下載檔案">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>
            <button class="action-btn delete" onclick="deleteFile('${
              file.id
            }')" title="刪除檔案">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
            ${
              file.isSensitive ||
              file.fileCategory === "env" ||
              file.fileCategory === "log"
                ? `<button class="action-btn toggle-sensitive" onclick="toggleFileVisibility('${file.id}', true)" title="隱藏檔案">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                    <line x1="3" y1="3" x2="21" y2="21"></line>
                </svg>
            </button>`
                : ""
            }
        </div>
    `;

        // 組裝最終的檔案項目內容
        fileItem.innerHTML = `
        <div class="file-info">
            ${icon}
            ${displayContent}
        </div>
        ${fileActions}
    `;

        // 設置拖放排序事件
        fileItem.addEventListener("dragstart", handleDragStart);
        fileItem.addEventListener("dragend", handleDragEnd);
        fileItem.addEventListener("dragover", handleDragOver);
        fileItem.addEventListener("drop", handleDrop);

        return fileItem;
      } // 刪除文件
      function deleteFile(id) {
        files = files.filter((file) => file.id !== id);
        updateUI();
        updatePrivacySettings();
      }

      // 下載單個文件
      function downloadFile(id) {
        const file = files.find((f) => f.id === id);
        if (!file) {
          showModal("下載失敗", "找不到該檔案。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          return;
        }

        let blob;
        let filename = file.name;

        if (file.type === "text") {
          blob = new Blob([file.content], { type: "text/plain" });
        } else if (file.type === "binary") {
          blob = new Blob([file.content]);
        } else {
          blob = new Blob([file.content]);
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        showToast(`已下載：${filename}`);
      }

      // 下載全部文件
      async function downloadAllFiles() {
        if (files.length === 0) {
          showToast("沒有檔案可供下載");
          return;
        }

        if (typeof JSZip === "undefined") {
          showModal("下載失敗", "JSZip 未正確載入，無法壓縮檔案。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          console.error("JSZip 未定義");
          return;
        }

        const zip = new JSZip();

        files.forEach((file) => {
          if (file.type === "text") {
            zip.file(file.path, file.content);
          } else if (file.type === "binary") {
            zip.file(file.path, file.content, { binary: true });
          } else {
            zip.file(file.path, file.content);
          }
        });

        try {
          const blob = await zip.generateAsync({ type: "blob" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "all_files.zip";
          a.click();
          URL.revokeObjectURL(url);

          showToast("已下載全部檔案");
        } catch (err) {
          console.error("下載失敗:", err);
          showModal("下載失敗", "下載失敗，請稍後再試。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
        }
      }

      // 產生檔案架構
      function generateFileStructure() {
        let structure = "# 檔案結構\n\n```\n";
        const dirMap = {};

        // 建立目錄映射
        files.forEach((file) => {
          const parts = file.path.split("/");
          let currentPath = "";

          for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            const parentPath = i === 0 ? "" : parts.slice(0, i).join("/");
            const path = i === 0 ? part : `${parentPath}/${part}`;

            if (!dirMap[path]) {
              dirMap[path] = {
                name: part,
                parent: parentPath,
                isDir: true,
              };
            }

            currentPath = path;
          }

          // 添加檔案
          const fileName = parts[parts.length - 1];
          const filePath =
            parts.length > 1 ? `${currentPath}/${fileName}` : fileName;

          dirMap[filePath] = {
            name: fileName,
            parent: currentPath,
            isDir: false,
            isHidden: file.isHidden,
            isSensitive: file.isSensitive,
            isEmpty: file.isEmpty,
            fileCategory: file.fileCategory,
          };
        });

        // 建立結構字串
        function buildStructure(path, indent = 0) {
          let result = "";

          const children = Object.values(dirMap).filter(
            (item) => item.parent === path
          );

          const dirs = children.filter((item) => item.isDir);
          const fileItems = children.filter((item) => !item.isDir);

          dirs.sort((a, b) => a.name.localeCompare(b.name));
          fileItems.sort((a, b) => a.name.localeCompare(b.name));

          dirs.forEach((dir) => {
            result += `${" ".repeat(indent)}📁 ${dir.name}/\n`;
            result += buildStructure(
              dir.name === ""
                ? dir.name
                : path
                ? `${path}/${dir.name}`
                : dir.name,
              indent + 2
            );
          });

          fileItems.forEach((file) => {
            if (!file.isHidden) {
              if (file.fileCategory === "env") {
                result += `${" ".repeat(indent)}🔑 ${file.name}${
                  file.isEmpty ? " (空檔案)" : ""
                }\n`;
              } else if (file.fileCategory === "log") {
                result += `${" ".repeat(indent)}📝 ${file.name}${
                  file.isEmpty ? " (空檔案)" : ""
                }\n`;
              } else if (file.isSensitive) {
                result += `${" ".repeat(indent)}🔒 ${file.name}${
                  file.isEmpty ? " (空檔案)" : ""
                }\n`;
              } else if (file.isEmpty) {
                result += `${" ".repeat(indent)}📄 ${file.name} (空檔案)\n`;
              } else {
                result += `${" ".repeat(indent)}📄 ${file.name}\n`;
              }
            }
          });

          return result;
        }

        structure += buildStructure("");
        structure += "```\n\n";

        // 添加檔案分類列表

        // 環境變數檔案列表
        const envFiles = files.filter(
          (file) => file.fileCategory === "env" && !file.isHidden
        );
        if (envFiles.length > 0) {
          structure += "## 環境變數檔案\n\n";
          envFiles.forEach((file) => {
            structure += `- 🔑 \`${file.path}\`${
              file.isEmpty ? " (空檔案)" : ""
            }\n`;
          });
          structure += "\n";
        }

        // 日誌檔案列表
        const logFiles = files.filter(
          (file) => file.fileCategory === "log" && !file.isHidden
        );
        if (logFiles.length > 0) {
          structure += "## 日誌檔案\n\n";
          logFiles.forEach((file) => {
            const size = file.totalLength
              ? formatBytes(file.totalLength)
              : "空";
            structure += `- 📝 \`${file.path}\` (${size})\n`;
          });
          structure += "\n";
        }

        // 敏感檔案列表
        const sensitiveFiles = files.filter(
          (file) =>
            file.isSensitive &&
            !file.isHidden &&
            file.fileCategory !== "env" &&
            file.fileCategory !== "log"
        );
        if (sensitiveFiles.length > 0) {
          structure += "## 敏感檔案\n\n";
          sensitiveFiles.forEach((file) => {
            structure += `- 🔒 \`${file.path}\`${
              file.isEmpty ? " (空檔案)" : ""
            }\n`;
          });
          structure += "\n";
        }

        // 添加空檔案列表
        const emptyFiles = files.filter(
          (file) => !file.isHidden && file.isEmpty
        );
        if (emptyFiles.length > 0) {
          structure += "## 空檔案列表\n\n";
          emptyFiles.forEach((file) => {
            structure += `- 📄 \`${file.path}\` (空檔案)\n`;
          });
          structure += "\n";
        }

        // 添加隱藏文件列表
        const hiddenFiles = files.filter((file) => file.isHidden);
        if (hiddenFiles.length > 0) {
          structure += "## 隱藏檔案列表\n\n";
          hiddenFiles.forEach((file) => {
            let icon = "👁️‍🗨️";
            if (file.fileCategory === "env") {
              icon = "🔑";
            } else if (file.fileCategory === "log") {
              icon = "📝";
            } else if (file.isSensitive) {
              icon = "🔒";
            }

            structure += `- ${icon} \`${file.path}\`${
              file.isEmpty ? " (空檔案)" : ""
            }\n`;
          });
        }

        return structure;
      }

      // 添加目錄樣式
      const directoryStyles = `
    .directory-header {
        padding: 0.75rem;
        margin-top: 0.5rem;
        margin-bottom: 0.25rem;
        background: var(--gray-100);
        border-radius: 0.5rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        color: var(--gray-700);
    }
    
    .directory-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .directory-icon {
        width: 20px;
        height: 20px;
        color: var(--primary);
    }
    
    /* 拖曳相關樣式 */
    .drag-highlight {
        background-color: rgba(79, 70, 229, 0.1);
        outline: 2px dashed var(--primary);
    }
    
    .drag-highlight-directory {
        background-color: rgba(79, 70, 229, 0.1);
        outline: 2px dashed var(--primary);
    }
`;

      // 插入樣式到頁面
      function addStyleToPage(styleText) {
        const styleElement = document.createElement("style");
        styleElement.textContent = styleText;
        document.head.appendChild(styleElement);
      }

      // 初始化時添加樣式
      document.addEventListener("DOMContentLoaded", () => {
        addStyleToPage(directoryStyles);
        // 其他初始化...
      });

      // 增強型拖放目錄處理
      async function processEntries(entries) {
        const allFiles = [];
        let totalEntries = 0;
        let processedEntries = 0;
        let lastUpdateTime = Date.now();

        // 顯示進度指示器
        const dropZone = document.getElementById("dropZone");
        const originalText = dropZone.innerHTML;
        dropZone.classList.add("processing");

        function updateProgress() {
          if (totalEntries > 0) {
            const percent = Math.round((processedEntries / totalEntries) * 100);
            const now = Date.now();

            // 限制更新頻率，避免頻繁重繪降低性能
            if (now - lastUpdateTime > 200) {
              dropZone.innerHTML = `
                    <div class="progress-indicator">
                        <div class="progress-text">處理中... ${percent}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%"></div>
                        </div>
                        <div class="progress-stats">
                            已處理 ${processedEntries} / ${totalEntries} 個檔案
                        </div>
                    </div>
                `;
              lastUpdateTime = now;
            }
          }
        }

        // 計算檔案總數
        async function countEntries(entry, path = "") {
          return new Promise(async (resolve) => {
            if (entry.isFile) {
              totalEntries++;
              resolve(1);
            } else if (entry.isDirectory) {
              const dirReader = entry.createReader();

              dirReader.readEntries(
                async (entries) => {
                  let count = 0;

                  for (const e of entries) {
                    count += await countEntries(
                      e,
                      path ? `${path}/${entry.name}` : entry.name
                    );
                  }

                  resolve(count);
                },
                () => resolve(0)
              );
            } else {
              resolve(0);
            }
          });
        }

        // 先計算檔案總數
        for (const entry of entries) {
          await countEntries(entry);
        }

        updateProgress();

        // 處理單一 entry (檔案或資料夾)
        async function processEntry(entry, path = "") {
          return new Promise(async (resolve) => {
            if (entry.isFile) {
              entry.file(
                (file) => {
                  // 設定相對路徑
                  const fullPath = path ? `${path}/${entry.name}` : entry.name;

                  // 創建一個新的 File 物件，附帶相對路徑資訊
                  const fileWithPath = new File([file], entry.name, {
                    type: file.type,
                  });
                  fileWithPath.webkitRelativePath = fullPath;

                  allFiles.push(fileWithPath);
                  processedEntries++;
                  updateProgress();
                  resolve();
                },
                () => {
                  processedEntries++;
                  updateProgress();
                  resolve();
                }
              );
            } else if (entry.isDirectory) {
              const dirReader = entry.createReader();
              const dirPath = path ? `${path}/${entry.name}` : entry.name;

              // 讀取資料夾內容
              dirReader.readEntries(async (entries) => {
                const promises = entries.map((e) => processEntry(e, dirPath));
                await Promise.all(promises);
                resolve();
              }, resolve);
            } else {
              resolve();
            }
          });
        }

        // 處理所有 entries
        await Promise.all(entries.map((entry) => processEntry(entry)));

        // 恢復原始狀態
        dropZone.classList.remove("processing");
        dropZone.innerHTML = originalText;

        // 處理收集到的檔案
        if (allFiles.length > 0) {
          await handleFiles(allFiles);
          showToast(`成功處理 ${allFiles.length} 個檔案`);
        } else {
          showToast("未找到任何檔案");
        }
      }

      // 更新產生輸出的函數
      function updateOutput() {
        const outputContainer = document.getElementById("outputContainer");

        if (files.length === 0) {
          outputContainer.classList.remove("show");
          return;
        }

        // 更新檔案內容輸出
        let output = "";
        const visibleFiles = files.filter((f) => !f.isHidden);

        // 以路徑分組檔案
        const paths = new Set(
          visibleFiles.map((f) => f.path.split("/").slice(0, -1).join("/"))
        );

        paths.forEach((path) => {
          if (path) {
            output += `\n## ${path}\n\n`;
            const pathFiles = visibleFiles.filter((f) =>
              f.path.startsWith(path + "/")
            );
            pathFiles.forEach((file) => {
              if (file.isEmpty) {
                output += `### ${file.name}\n<空檔案>\n\n`;
              } else if (file.type === "text") {
                // 日誌檔案使用特殊的 Markdown 格式顯示
                if (file.fileCategory === "log") {
                  output += generateLogMarkdown(file);
                } else {
                  const language = getFileLanguage(file.name);
                  output += `### ${file.name}\n\`\`\`${language}\n${file.content}\n\`\`\`\n\n`;
                }
              } else if (file.type === "binary") {
                output += `### ${file.name}\n（二進位檔案）\n\n`;
              } else {
                output += `### ${file.name}\n（未知類型）\n\n`;
              }
            });
          }
        });

        // 處理根目錄檔案
        const rootFiles = visibleFiles.filter((f) => !f.path.includes("/"));
        rootFiles.forEach((file) => {
          if (file.isEmpty) {
            output += `### ${file.name}\n<空檔案>\n\n`;
          } else if (file.type === "text") {
            // 日誌檔案使用特殊的 Markdown 格式顯示
            if (file.fileCategory === "log") {
              output += generateLogMarkdown(file);
            } else {
              const language = getFileLanguage(file.name);
              output += `### ${file.name}\n\`\`\`${language}\n${file.content}\n\`\`\`\n\n`;
            }
          } else if (file.type === "binary") {
            output += `### ${file.name}\n（二進位檔案）\n\n`;
          } else {
            output += `### ${file.name}\n（未知類型）\n\n`;
          }
        });

        document.getElementById("output").textContent = output;

        // 更新檔案結構輸出
        const structure = generateFileStructure();
        document.getElementById("structureOutput").textContent = structure;

        outputContainer.classList.add("show");
      }

      // 獲取日誌檔案的顯示內容
      function getLogDisplayContent(file) {
        // 預設顯示最新的部分（末尾）
        const content = file.content || "";
        const displayLength = file.displayLength || 2000;

        if (content.length <= displayLength) {
          return content;
        }

        // 從結尾開始截取指定長度
        return `[...日誌前部分省略...]\n\n${content.substring(
          content.length - displayLength
        )}`;
      }

      // 複製輸出到剪貼簿
      async function copyOutput() {
        // 獲取當前活動的面板
        const activePane = document.querySelector(".output-pane.active");
        const output = activePane.querySelector("pre").textContent;
        const copyButton = document.getElementById("copyButton");

        try {
          await navigator.clipboard.writeText(output);

          // 更新按鈕外觀
          copyButton.classList.add("copied");
          copyButton.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-xs">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M18.0633 5.67387C18.5196 5.98499 18.6374 6.60712 18.3262 7.06343L10.8262 18.0634C10.6585 18.3095 10.3898 18.4679 10.0934 18.4957C9.79688 18.5235 9.50345 18.4178 9.29289 18.2072L4.79289 13.7072C4.40237 13.3167 4.40237 12.6835 4.79289 12.293C5.18342 11.9025 5.81658 11.9025 6.20711 12.293L9.85368 15.9396L16.6738 5.93676 C16.6738 5.93676 16.9849 5.48045 17.607 5.36275 18.0633 5.67387Z" fill="currentColor"/>
            </svg>
            已複製
          `;

          // 2秒後恢復原狀
          setTimeout(() => {
            copyButton.classList.remove("copied");
            copyButton.innerHTML = `
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-xs">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"/>
              </svg>
              複製
            `;
          }, 2000);
        } catch (err) {
          console.error("複製失敗:", err);
          showModal("複製失敗", "無法複製到剪貼簿，請手動選取複製。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
        }
      }

      // 儲存版本
      function saveVersion() {
        const versionName = document.getElementById("versionName").value.trim();
        if (!versionName) {
          showModal("儲存失敗", "請輸入版本名稱。", [
            { text: "確認", onClick: "hideModal()", primary: true },
          ]);
          return;
        }

        // 檢查是否有敏感檔案
        const sensitiveFiles = files.filter((file) => file.isSensitive);
        if (sensitiveFiles.length > 0) {
          showModal(
            "檔案包含敏感資訊",
            `注意：此版本包含 ${sensitiveFiles.length} 個敏感文件，請確認是否要保存這些資訊。`,
            [
              { text: "取消", onClick: "hideModal()", primary: false },
              {
                text: "確認儲存",
                onClick: "confirmSaveVersion()",
                primary: true,
              },
            ]
          );
          return;
        }

        confirmSaveVersion();
      }

      // 確認儲存版本
      function confirmSaveVersion() {
        const versionName = document.getElementById("versionName").value.trim();

        const newVersion = {
          id: Math.random().toString(36).substr(2, 9),
          name: versionName,
          files: [...files],
          created: new Date().toISOString(),
          updated: new Date().toISOString(),
        };

        savedVersions.push(newVersion);
        document.getElementById("versionName").value = "";

        saveVersionsToStorage();
        updateVersionsList();
        hideModal();

        showToast("版本已成功儲存");
      }

      // 顯示模態框
      function showModal(title, message, actions) {
        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modalTitle");
        const modalBody = document.getElementById("modalBody");
        const modalActions = document.getElementById("modalActions");

        modalTitle.textContent = title;
        modalBody.textContent = message;
        modalActions.innerHTML = actions
          .map(
            (action) => `
              <button class="modal-btn ${
                action.primary ? "modal-btn-primary" : "modal-btn-secondary"
              }" onclick="${action.onClick}">
                ${action.text}
              </button>
            `
          )
          .join("");

        modal.classList.add("show");
      }

      // 關閉模態框
      function hideModal() {
        const modal = document.getElementById("modal");
        modal.classList.remove("show");
      }

      // 更新版本列表
      function updateVersionsList() {
        const versionsList = document.getElementById("savedVersions");
        versionsList.innerHTML = savedVersions
          .map(
            (version) => `
              <div class="version-item">
                <div class="version-info">
                  <span class="version-name">${version.name}</span>
                  <span class="version-time">
                    建立：${formatDate(version.created)}<br>
                    更新：${formatDate(version.updated)}
                  </span>
                </div>
                <div class="version-actions">
                  <button class="save-btn" onclick="loadVersion('${
                    version.id
                  }')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25rem; height: 1.25rem;">
                      <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                    載入
                  </button>
                  <button class="delete-version-btn" onclick="deleteVersion('${
                    version.id
                  }')" title="刪除版本">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            `
          )
          .join("");
      }

      // 格式化日期
      function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getFullYear()}/${(date.getMonth() + 1)
          .toString()
          .padStart(2, "0")}/${date
          .getDate()
          .toString()
          .padStart(2, "0")} ${date
          .getHours()
          .toString()
          .padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
      }

      // 載入版本
      function loadVersion(id) {
        const version = savedVersions.find((v) => v.id === id);
        if (version) {
          files = [...version.files];
          version.updated = new Date().toISOString();
          saveVersionsToStorage();
          updateUI();
          updatePrivacySettings();

          showToast("版本已成功載入");
        }
      }

      // 刪除版本
      function deleteVersion(id) {
        showModal("確認刪除", "確定要刪除此版本嗎？此操作無法復原。", [
          {
            text: "取消",
            onClick: "hideModal()",
            primary: false,
          },
          {
            text: "確定刪除",
            onClick: `confirmDeleteVersion('${id}')`,
            primary: true,
          },
        ]);
      }

      // 確認刪除版本
      function confirmDeleteVersion(id) {
        savedVersions = savedVersions.filter((v) => v.id !== id);
        saveVersionsToStorage();
        updateVersionsList();
        hideModal();
      }

      // 新增吐司訊息函式
      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.style.display = "block";
        toast.style.opacity = "1";

        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => {
            toast.style.display = "none";
          }, 500);
        }, duration);
      }

      // 文件拖放排序
      function handleDragStart(e) {
        draggedItem = e.currentTarget;
        e.currentTarget.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      }

      function handleDragEnd(e) {
        e.currentTarget.classList.remove("dragging");
        draggedItem = null;
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";

        const target = e.currentTarget;
        if (target && target !== draggedItem) {
          const rect = target.getBoundingClientRect();
          const offset = e.clientY - rect.top;
          if (offset > rect.height / 2) {
            target.style["border-bottom"] = "2px solid var(--primary)";
            target.style["border-top"] = "";
          } else {
            target.style["border-top"] = "2px solid var(--primary)";
            target.style["border-bottom"] = "";
          }
        }
      }

      function handleDrop(e) {
        e.preventDefault();
        const target = e.currentTarget;
        if (target && target !== draggedItem) {
          const rect = target.getBoundingClientRect();
          const offset = e.clientY - rect.top;
          const dropIndex = parseInt(target.dataset.index);

          const draggedIndex = parseInt(draggedItem.dataset.index);

          if (offset > rect.height / 2) {
            // Move below
            files.splice(dropIndex + 1, 0, files.splice(draggedIndex, 1)[0]);
          } else {
            // Move above
            files.splice(dropIndex, 0, files.splice(draggedIndex, 1)[0]);
          }

          updateUI();
        }

        // 清除排序樣式
        const fileItems = document.querySelectorAll(".file-item");
        fileItems.forEach((item) => {
          item.style["border-bottom"] = "";
          item.style["border-top"] = "";
        });
      }

      // 顯示機密檔案警告
      function showSecretFilesWarning(secretFiles) {
        // 創建警告元素
        const warningElement = document.createElement("div");
        warningElement.className = "secret-warning";

        // 填充警告內容
        warningElement.innerHTML = `
        <div class="secret-warning-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            機密檔案安全警告
        </div>
        <div class="secret-warning-message">
            系統已阻止上傳包含機密資訊的檔案。這些檔案通常包含敏感資訊如密碼、API密鑰等，不應該被分享。
        </div>
        <ul class="secret-file-list">
            ${secretFiles.map((file) => `<li>${file}</li>`).join("")}
        </ul>
    `;

        // 插入到 dropZone 之後
        const dropZone = document.getElementById("dropZone");
        dropZone.parentNode.insertBefore(warningElement, dropZone.nextSibling);

        // 設置自動消失計時器
        setTimeout(() => {
          warningElement.style.opacity = "0";
          setTimeout(() => {
            warningElement.parentNode.removeChild(warningElement);
          }, 500);
        }, 10000); // 10秒後自動消失
      }
    </script>
  </body>
</html>
