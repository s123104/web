<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã€é—‡é»’å¥§ç¾©ã€è½‰æ›é™£</title>

    <style>
      /* ===========================
       å…¨å±€æ¨£å¼å’Œè®Šæ•¸
       =========================== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      }
      :root {
        --primary-color: #ff0055;
        --secondary-color: #00ffff;
        --bg-color: #0a0a2a;
        --text-color: #fff;
        --glow-color: rgba(255, 0, 85, 0.7);
        --power-bg: rgba(0, 255, 255, 0.2);
        --power-glow: var(--secondary-color);
        --toast-bg: rgba(0, 0, 0, 0.7);
        --toast-color: #fff;
        --achievement-bg: rgba(0, 0, 0, 0.85);
        --achievement-text-color: #fff;
        --button-hover-bg: #ff66aa;
        --overlay-bg: rgba(0, 0, 0, 0.85);
        --rgb-animation-duration: 0.5s;
      }
      body {
        background: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        line-height: 1.6;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        position: relative;
      }

      /* ===========================
       Fireworks Canvas
       =========================== */
      #fireworks-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      .container {
        position: relative;
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
        z-index: 2;
        width: 100%;
        max-width: 800px;
      }

      .header {
        text-align: center;
        margin: 0.5rem 0;
        position: relative;
      }
      .title {
        font-size: clamp(1.2rem, 5vw, 2.5rem);
        margin-bottom: 0.5rem;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        display: inline-block;
        text-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
      }
      .subtitle {
        font-size: clamp(0.9rem, 3vw, 1.2rem);
        color: var(--secondary-color);
        opacity: 0.8;
        margin-bottom: 2rem;
      }

      .converter-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin: 2rem 0;
        width: 100%;
      }
      @media (min-width: 768px) {
        .converter-container {
          flex-direction: row;
        }
      }

      .input-section,
      .output-section {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--primary-color);
        border-radius: 10px;
        padding: 1rem;
        position: relative;
        overflow: hidden;
      }

      .section-header {
        font-size: 1.2rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .section-header::before {
        content: "âš¡";
        animation: flash 1s infinite;
      }
      @keyframes flash {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      textarea {
        width: 100%;
        height: 100px; /* èª¿æ•´é«˜åº¦ */
        background: rgba(0, 0, 0, 0.3);
        border: none;
        border-radius: 5px;
        padding: 1rem;
        color: var(--text-color);
        font-size: 1rem;
        resize: none;
        outline: none;
        font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      }
      @media (min-width: 768px) {
        textarea {
          height: 100px; /* æ¡Œé¢ç‰ˆé«˜åº¦æ›´å° */
        }
      }

      .magic-border {
        position: absolute;
        inset: 0;
        border: 2px solid transparent;
        border-radius: 10px;
        animation: borderGlow 3s linear infinite;
        pointer-events: none;
      }
      @keyframes borderGlow {
        0% {
          border-color: var(--primary-color);
        }
        50% {
          border-color: var(--secondary-color);
        }
        100% {
          border-color: var(--primary-color);
        }
      }

      .status {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        font-size: 0.9rem;
        color: var(--secondary-color);
        opacity: 0.8;
      }

      .power-level-container {
        margin-top: 1rem;
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        height: 20px;
        position: relative;
      }
      .power-level-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
        transition: width 0.5s ease-in-out;
      }
      .power-level-text {
        text-align: center;
        margin-top: 0.5rem;
        font-size: 1rem;
        color: var(--secondary-color);
        animation: pulseGlow 2s infinite;
      }
      @keyframes pulseGlow {
        0% {
          text-shadow: 0 0 10px var(--secondary-color),
            0 0 20px var(--secondary-color);
        }
        50% {
          text-shadow: 0 0 20px var(--secondary-color),
            0 0 30px var(--secondary-color);
        }
        100% {
          text-shadow: 0 0 10px var(--secondary-color),
            0 0 20px var(--secondary-color);
        }
      }

      /* åŠ åˆ†å‹•ç•« */
      .score-animation {
        position: absolute;
        background: rgba(255, 255, 255, 0.9);
        color: var(--primary-color);
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        animation: floatUp 2s forwards;
        pointer-events: none;
        z-index: 3;
        opacity: 0;
        font-size: 0.9rem;
      }
      @keyframes floatUp {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-50px) scale(1.5);
        }
      }

      /* æˆå°±å‹•ç•«è¦†è“‹å±¤ */
      .achievement-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--overlay-bg);
        color: var(--achievement-text-color);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease-in-out;
      }
      .achievement-overlay.active {
        opacity: 1;
        pointer-events: all;
      }
      .achievement-content {
        text-align: center;
        width: 100%;
        max-width: 600px;
        padding: 2rem;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.1);
        position: relative;
        animation: zoomIn 1s ease-out;
      }
      @keyframes zoomIn {
        from {
          transform: scale(0.5);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .achievement-content svg,
      .achievement-content .fas.fa-trophy {
        width: 100px;
        height: 100px;
        margin-bottom: 1rem;
        animation: trophyGlow 2s infinite;
      }
      @keyframes trophyGlow {
        0%,
        100% {
          filter: drop-shadow(0 0 10px var(--primary-color));
        }
        50% {
          filter: drop-shadow(0 0 20px var(--secondary-color));
        }
      }
      .achievement-title {
        font-size: clamp(1.5rem, 5vw, 3rem);
        margin-bottom: 1rem;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
      }
      .achievement-description {
        font-size: clamp(1rem, 3vw, 1.5rem);
        margin-bottom: 1.5rem;
      }

      /* æŒ‰éˆ•æ¨£å¼ */
      .copy-button,
      .listen-button,
      .record-button {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: #fff;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        transition: transform 0.2s, box-shadow 0.3s, background 0.3s;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .buttons-container {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 10px;
      }

      /* RGBå‹•ç•« */
      .rgb-animation {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        pointer-events: none;
        background: radial-gradient(
          circle,
          rgba(255, 0, 0, 0.5),
          rgba(0, 255, 0, 0.5),
          rgba(0, 0, 255, 0.5)
        );
        opacity: 0;
        animation: rgbFlash var(--rgb-animation-duration) forwards;
      }
      @keyframes rgbFlash {
        0% {
          opacity: 1;
          transform: scale(0.8);
        }
        100% {
          opacity: 0;
          transform: scale(1.5);
        }
      }
      .copy-button::before,
      .listen-button::before,
      .record-button::before {
        content: "";
        position: absolute;
        width: 300%;
        height: 300%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(45deg);
        background: rgba(255, 255, 255, 0.2);
        opacity: 0;
        transition: opacity 0.3s;
      }
      .copy-button:hover::before,
      .listen-button:hover::before,
      .record-button:hover::before {
        opacity: 1;
      }
      .copy-button:hover,
      .listen-button:hover,
      .record-button:hover {
        background: var(--button-hover-bg);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      /* Toast */
      .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 15;
      }
      .toast {
        min-width: 200px;
        background: var(--toast-bg);
        color: var(--toast-color);
        padding: 0.75rem 1rem;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        opacity: 0;
        animation: fadeIn 0.5s forwards, fadeOut 0.5s forwards 2.5s;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      @keyframes fadeOut {
        to {
          opacity: 0;
        }
      }

      .recording {
        background: red;
      }
    </style>
  </head>
  <body>
    <!-- ç…™ç«Canvas -->
    <canvas id="fireworks-canvas"></canvas>

    <!-- æˆå°±è¦†è“‹å±¤ -->
    <div class="achievement-overlay" id="achievementOverlay">
      <div class="achievement-content">
        <i class="fas fa-trophy"></i>
        <div class="achievement-title">ğŸŒŸ å°ç£é«’è©±ç‹ ğŸŒŸ</div>
        <div class="achievement-description">
          æ­å–œä½ é”åˆ°æœ€é«˜éˆåŠ›å€¼ï¼Œæˆç‚ºçœŸæ­£çš„å°ç£é«’è©±ç‹ï¼
        </div>
      </div>
    </div>

    <!-- Toastå®¹å™¨ -->
    <div class="toast-container" id="toast-container"></div>

    <div class="container">
      <div class="header">
        <h1 class="title">ã€é—‡é»’å¥§ç¾©ã€è½‰æ›é™£</h1>
        <p class="subtitle">âœ§è§£æ”¾å¾ç­‰éˆé­‚ä¹‹æŸç¸›ï¼Œå±•ç¾çœŸå¯¦ä¹‹èªâœ§</p>
      </div>

      <div class="converter-container">
        <!-- è¼¸å…¥å€ -->
        <div class="input-section">
          <div class="section-header">ã€å¾ä¹‹çœŸè¨€ã€</div>
          <textarea id="input" placeholder="åœ¨æ­¤å¯«ä¸‹æ±ä¹‹å¯†èª..."></textarea>
          <div class="buttons-container">
            <button class="record-button" id="record-input" title="èªéŸ³è¼¸å…¥">
              ğŸ¤
            </button>
            <button
              class="listen-button"
              id="listen-input"
              title="è†è½è¼¸å…¥å…§å®¹"
            >
              ğŸ”ˆ
            </button>
          </div>
          <div class="magic-border"></div>
          <div class="status" id="input-status"></div>
          <div class="power-level-container">
            <div class="power-level-bar" id="power-bar"></div>
          </div>
          <div class="power-level-text">éˆåŠ›å€¼: <span id="power">0%</span></div>
        </div>

        <!-- è¼¸å‡ºå€ -->
        <div class="output-section">
          <div class="section-header">ã€è½‰åŒ–çµç•Œã€</div>
          <textarea id="output" readonly></textarea>
          <div class="buttons-container">
            <button class="copy-button" id="copy-button" title="è¤‡è£½çµæœ">
              ğŸ”—
            </button>
            <button
              class="listen-button"
              id="listen-output"
              title="è†è½è½‰æ›çµæœ"
            >
              ğŸ”ˆ
            </button>
          </div>
          <div class="magic-border"></div>
          <div class="status" id="output-status"></div>
        </div>
      </div>
    </div>

    <!-- Font Awesome (çç›ƒåœ–ç¤º) -->
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
    <!-- pinyin4js (ä¸­æ–‡â†’æ‹¼éŸ³) -->
    <script src="https://cdn.jsdelivr.net/npm/pinyin4js/dist/pinyin4js.min.js"></script>

    <!-- éŸ³æ•ˆ -->
    <audio
      id="typing-sound"
      src="https://www.myinstants.com/media/sounds/keyboard-click.mp3"
      preload="auto"
    ></audio>
    <audio
      id="copy-sound"
      src="https://www.myinstants.com/media/sounds/success.mp3"
      preload="auto"
    ></audio>
    <audio
      id="achievement-sound"
      src="https://www.myinstants.com/media/sounds/fireworks.mp3"
      preload="auto"
    ></audio>

    <script>
      /* ======= å­—å…¸å€ ======= */
      const dictionary = {
        ç‹¼: "Lan",
        æ‰: "diau",
        ç: "Jen",
        ç : "ju",
        å•¦: "la",
        æˆ‘: "Wou",
        æƒ³: "siang",
        ç©: "wong",
        å±: "pi",
        çœ¼: "yan",
        æ´¾: "pai",
        å°: "duai",
        å¥½: "Hau",
        åˆº: "tsi",
        æ¿€: "chi",
        å–”: "ah",
        ä¹Ÿ: "ye",
        ç™¢: "Yang",
        è¬›: "Gong",
        ä¸‰: "san",
        å°: "xiao",
        å¹¹: "Gan",
        ä½ : "ni",
        å¨˜: "niang",
        é›: "ji",
        æ°: "bai",
        å‹’: "lei",
      };
      const reverseDictionary = Object.entries(dictionary).reduce(
        (acc, [ch, py]) => {
          acc[py.toLowerCase()] = ch;
          return acc;
        },
        {}
      );

      /* ======= é«’è©±å­—å…¸ ======= */
      const badWords = [
        { word: "å¹¹ä½ å…¨å®¶", weight: 30 },
        { word: "å¹¹ä½ å¨˜", weight: 20 },
        { word: "å¹¹ä½ è€å¸«", weight: 20 },
        { word: "å¹¹", weight: 15 },
        { word: "é åŒ—", weight: 10 },
        { word: "é å¤­", weight: 10 },
        { word: "é›æ°", weight: 15 },
        { word: "é›å·´æ¯›", weight: 15 },
        { word: "åŒ—ä¸ƒ", weight: 10 },
        { word: "ä¸‰å°", weight: 10 },
        { word: "æ‡¶è¶´æ¯›å•¦", weight: 8 },
        { word: "å±å•¦", weight: 8 },
        { word: "å‚»é€¼", weight: 15 },
        { word: "å‚»é€¼ç©æ„", weight: 15 },
        { word: "å»ä½ çš„", weight: 15 },
        { word: "å»åƒå±å•¦", weight: 15 },
        { word: "æ­»ä¸‰å…«", weight: 15 },
        { word: "æ­»æ©Ÿæ°", weight: 15 },
        { word: "è‡­é›æ°", weight: 15 },
        { word: "è‡­ä½ åª½çš„", weight: 15 },
        { word: "åª½çš„è¡Œ", weight: 10 },

        { word: "é ", weight: 10 },
        { word: "ç™½ç™¡", weight: 15 },
        { word: "è±¬è…¦", weight: 15 },
        { word: "å»¢ç‰©", weight: 15 },
        { word: "åƒåœ¾", weight: 10 },
        { word: "æ­»äºº", weight: 15 },
        { word: "æ™ºéšœ", weight: 15 },
        { word: "å¼±æ™º", weight: 15 },
        { word: "æ­»å…¨å®¶", weight: 30 },

        { word: "å•Š", weight: 2 },
        { word: "å•¦", weight: 2 },
        { word: "å˜›", weight: 2 },
        { word: "å–”", weight: 2 },
        { word: "å“¦", weight: 2 },
        { word: "é½å‘¦", weight: 4 },

        { word: "ç¬‘æ­»", weight: 4 },
        { word: "ç¬‘çˆ›", weight: 4 },
        { word: "ç„¡è¨€è–¯æ¢", weight: 4 },
        { word: "åŒ—çˆ›", weight: 6 },
        { word: "ç™½ç—´å“¦", weight: 6 },
        { word: "ç¬‘é¼ ", weight: 4 },
        { word: "å‚»çœ¼è²“å’ª", weight: 6 },
        { word: "ç„¡èŠæ­»", weight: 4 },
        { word: "çœŸç„¡èŠ", weight: 4 },

        { word: "ä½ ç˜‹äº†", weight: 8 },
        { word: "æ‰€ä»¥å‘¢ï¼Ÿç„¶å¾Œå’§ï¼Ÿ", weight: 6 },
        { word: "çœ¼ç›å¹¹æ˜¯ä¸æ˜¯ï¼Ÿ", weight: 8 },
        { word: "è·ªä¸‹ä¾†æ±‚æˆ‘å•Šï¼", weight: 10 },
        { word: "ä¸è¦é¬§æ¬¸ï¼", weight: 4 },

        { word: "gan ni quanjia", weight: 30 },
        { word: "gan ni laoshi", weight: 20 },
        { word: "gan nian", weight: 20 },
        { word: "gan", weight: 15 },
        { word: "kao bei", weight: 10 },
        { word: "kao yao", weight: 10 },
        { word: "jibai", weight: 15 },
        { word: "jiba mao", weight: 15 },
        { word: "beiqi", weight: 10 },
        { word: "sanshao", weight: 10 },
        { word: "lanpa mao la", weight: 8 },
        { word: "pila", weight: 8 },
        { word: "shabi", weight: 15 },
        { word: "shabi wanyi", weight: 15 },
        { word: "qu nide", weight: 15 },
        { word: "qu chi shi la", weight: 15 },
        { word: "si sanba", weight: 15 },
        { word: "si jibi", weight: 15 },
        { word: "chou jibai", weight: 15 },
        { word: "chou ni mama de", weight: 15 },
        { word: "ma de xing", weight: 10 },

        { word: "a", weight: 2 },
        { word: "la", weight: 2 },
        { word: "ma", weight: 2 },
        { word: "wo", weight: 2 },
        { word: "o", weight: 2 },
        { word: "houyou", weight: 4 },

        { word: "xiaosi", weight: 4 },
        { word: "xiaolan", weight: 4 },
        { word: "wuyanshutiao", weight: 4 },
        { word: "beilan", weight: 6 },
        { word: "baichi o", weight: 6 },
        { word: "xiaoshu", weight: 4 },
        { word: "shayan maomi", weight: 6 },
        { word: "wuliaosi", weight: 4 },
        { word: "zhenwuliao", weight: 4 },

        { word: "ni feng le", weight: 8 },
        { word: "suoyine? ranhou lie?", weight: 6 },
        { word: "yanjing gan shifou?", weight: 8 },
        { word: "gui xialai qiuwu a!", weight: 10 },
        { word: "buyao nao e!", weight: 4 },
      ];

      // é˜²æŠ–
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // æ˜¯å¦å«ä¸­æ–‡
      function hasChinese(str) {
        return /[\u4e00-\u9fa5]/.test(str);
      }

      // æ–‡å­—è½‰æ‹¼éŸ³ / æ‹¼éŸ³è½‰ä¸­æ–‡
      function detectAndConvert(text) {
        if (!text) return "";
        if (hasChinese(text)) {
          // æœ‰ä¸­æ–‡ â†’ è½‰æ‹¼éŸ³
          return PinyinHelper.convertToPinyinString(
            text,
            " ",
            PinyinFormat.WITHOUT_TONE
          );
        } else {
          // ç„¡ä¸­æ–‡ â†’ è¦–ç‚ºæ‹¼éŸ³ï¼Œè½‰ä¸­æ–‡
          return text
            .split(/\s+/)
            .map((word) => reverseDictionary[word.toLowerCase()] || word)
            .join("");
        }
      }

      // åŠ åˆ†å‹•ç•«
      function triggerScoreAnimation(word, weight) {
        const container = document.querySelector(".input-section");
        const animation = document.createElement("div");
        animation.classList.add("score-animation");
        animation.textContent = `+${weight}% (${word})`;
        animation.style.left = Math.random() * 80 + "%";
        animation.style.top = Math.random() * 80 + "%";
        container.appendChild(animation);
        setTimeout(() => animation.remove(), 2000);
      }

      // é€ƒé€¸æ­£å‰‡
      function escapeRegExp(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      // ===========
      // æ‰“å­—éŸ³æ•ˆ
      // ===========
      const typingSound = document.getElementById("typing-sound");
      let isTyping = false;
      let typingTimer = null;

      // ä½¿ç”¨è€…æ¯æ¬¡è¼¸å…¥æ™‚ï¼ŒæŒçºŒæ’­æ”¾
      function startTypingSound() {
        if (!isTyping) {
          isTyping = true;
          typingSound.loop = true; // æŒçºŒæ’­æ”¾
          typingSound.currentTime = 0;
          typingSound.play();
        }
        // é‡ç½®å€’æ•¸è¨ˆæ™‚
        if (typingTimer) clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          stopTypingSound();
        }, 500); // åœæ­¢è¼¸å…¥ 0.5 ç§’å¾Œåœæ­¢
      }

      function stopTypingSound() {
        if (isTyping) {
          isTyping = false;
          typingSound.pause();
          typingSound.currentTime = 0;
          typingSound.loop = false;
        }
      }

      // ================
      // éˆåŠ›å€¼: æ”¹æˆã€Œé‡æ–°æƒæã€ç¢ºä¿å¢æ¸›éƒ½ç”Ÿæ•ˆ
      // ================
      function updatePowerLevel(text) {
        let newPower = 0;

        // æƒææ•´æ®µæ–‡å­—
        badWords.forEach((item) => {
          const regex = new RegExp(`(${escapeRegExp(item.word)})`, "gi");
          const matches = text.match(regex);
          if (matches) {
            // è¨ˆåˆ† (matches.length æ¬¡)
            newPower += matches.length * item.weight;
            // æ’­åŠ åˆ†å‹•ç•« (å¯çœ‹éœ€æ±‚è¦ä¸è¦é¡¯ç¤º)
            matches.forEach((match) => {
              triggerScoreAnimation(match, item.weight);
            });
          }
        });

        // ä¸å¯è¶…é100
        if (newPower > 100) {
          newPower = 100;
        }

        // æ›´æ–° UI
        const powerElement = document.getElementById("power");
        const powerBar = document.getElementById("power-bar");
        powerElement.textContent = newPower + "%";
        powerBar.style.width = newPower + "%";

        // è‹¥æ»¿100 â†’ è§¸ç™¼æˆå°±
        if (newPower >= 100) {
          triggerAchievement();
        }
      }

      // æˆå°±
      function triggerAchievement() {
        const achievementOverlay =
          document.getElementById("achievementOverlay");
        if (!achievementOverlay.classList.contains("active")) {
          achievementOverlay.classList.add("active");
          startFireworks();
          playAchievementSound();
        }
      }

      // Toast
      function showToast(msg) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.classList.add("toast");
        toast.textContent = msg;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // ==========================
      // é˜²æŠ–å¾ŒçœŸæ­£åŸ·è¡Œçš„é‚è¼¯
      // ==========================
      const handleInput = debounce(function (e) {
        const text = e.target.value.trim();
        // è½‰æ›
        const result = detectAndConvert(text);
        const outputElement = document.getElementById("output");
        // é¡¯ç¤ºé€å­—æ‰“å­—æ•ˆæœ (è‹¥ä¸æƒ³é€å­—å¯ç›´æ¥ setValue)
        outputElement.value = ""; // å…ˆæ¸…ç©º
        let idx = 0;
        const interval = setInterval(() => {
          if (idx < result.length) {
            outputElement.value += result[idx];
            outputElement.scrollTop = outputElement.scrollHeight;
            idx++;
          } else {
            clearInterval(interval);
          }
        }, 30);

        // é‡æ–°è¨ˆç®—éˆåŠ›å€¼ â†’ å¯æ¸›åˆ†
        updatePowerLevel(text);
      }, 500);

      // ç¶å®šè¼¸å…¥äº‹ä»¶
      const inputField = document.getElementById("input");
      inputField.addEventListener("input", (e) => {
        // 1) å…ˆè§¸ç™¼æ‰“å­—éŸ³æ•ˆ
        startTypingSound();
        // 2) å†åŸ·è¡Œæ–‡å­—è½‰æ›(é˜²æŠ–)
        handleInput(e);
      });

      // è¤‡è£½
      document
        .getElementById("copy-button")
        .addEventListener("click", async () => {
          const output = document.getElementById("output").value;
          try {
            await navigator.clipboard.writeText(output);
            showToast("çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
            playCopySound();
            triggerRGBAnimation(document.getElementById("copy-button"));
          } catch {
            showToast("ç„¡æ³•è¤‡è£½çµæœã€‚");
          }
        });

      // é—œé–‰æˆå°±å‹•ç•«
      const achievementOverlay = document.getElementById("achievementOverlay");
      achievementOverlay.addEventListener("click", () => {
        achievementOverlay.classList.remove("active");
        stopFireworks();
      });

      // èªéŸ³è¼¸å…¥
      const recordButton = document.getElementById("record-input");
      let recognition;
      let isRecording = false;

      if (
        "webkitSpeechRecognition" in window ||
        "SpeechRecognition" in window
      ) {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = "zh-TW";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = (event) => {
          const speechResult = event.results[0][0].transcript;
          inputField.value = speechResult;
          handleInput({ target: inputField });
          triggerRGBAnimation(recordButton);
        };
        recognition.onerror = (event) => {
          console.error("èªéŸ³è­˜åˆ¥éŒ¯èª¤:", event.error);
          showToast("èªéŸ³è­˜åˆ¥ç™¼ç”ŸéŒ¯èª¤ã€‚");
        };
      } else {
        recordButton.disabled = true;
        recordButton.title = "ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥åŠŸèƒ½ã€‚";
      }

      recordButton.addEventListener("click", () => {
        if (isRecording) {
          recognition.stop();
          isRecording = false;
          recordButton.classList.remove("recording");
        } else {
          recognition.start();
          isRecording = true;
          recordButton.classList.add("recording");
          triggerRGBAnimation(recordButton);
        }
      });

      // è†è½ã€Œè¼¸å…¥ã€å…§å®¹
      document.getElementById("listen-input").addEventListener("click", () => {
        const text = inputField.value.trim();
        if (!text) {
          showToast("æ²’æœ‰å…§å®¹å¯ä»¥è†è½ã€‚");
          return;
        }
        speakText(text);
        triggerRGBAnimation(document.getElementById("listen-input"));
      });

      // è†è½ã€Œè½‰æ›ã€çµæœ
      document.getElementById("listen-output").addEventListener("click", () => {
        const text = document.getElementById("output").value.trim();
        if (!text) {
          showToast("æ²’æœ‰å…§å®¹å¯ä»¥è†è½ã€‚");
          return;
        }
        speakText(text);
        triggerRGBAnimation(document.getElementById("listen-output"));
      });

      // æ‰“å­—éŸ³(åŸç”Ÿé€£æ’­æ”¹ç‚ºloopæ©Ÿåˆ¶)
      function playCopySound() {
        const copySound = document.getElementById("copy-sound");
        copySound.currentTime = 0;
        copySound.play();
      }
      function playAchievementSound() {
        const achievementSound = document.getElementById("achievement-sound");
        achievementSound.currentTime = 0;
        achievementSound.play();
      }

      // ç„¡éœ€API â†’ ç€è¦½å™¨å…§å»º speechSynthesis
      function speakText(text) {
        if (!("speechSynthesis" in window)) {
          showToast("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆåŠŸèƒ½ã€‚");
          return;
        }
        const utter = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const isChinese = hasChinese(text);
        const targetLang = isChinese ? "zh-TW" : "en-US";
        let chosenVoice = null;
        for (const v of voices) {
          if (v.lang.toLowerCase().includes(targetLang.toLowerCase())) {
            chosenVoice = v;
            break;
          }
        }
        if (chosenVoice) {
          utter.voice = chosenVoice;
        }
        window.speechSynthesis.speak(utter);
      }

      // RGBå‹•ç•«
      function triggerRGBAnimation(btn) {
        const anim = document.createElement("div");
        anim.classList.add("rgb-animation");
        btn.appendChild(anim);
        anim.addEventListener("animationend", () => anim.remove());
      }

      // ==============
      // ç…™ç«
      // ==============
      const canvas = document.getElementById("fireworks-canvas");
      const ctx = canvas.getContext("2d");
      let fireworks = [];
      let particles = [];
      let animationRunning = false;
      let fireworkInterval;

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      class Firework {
        constructor(x, y, targetY) {
          this.x = x;
          this.y = y;
          this.targetY = targetY;
          this.speed = Math.random() * 5 + 4;
          this.angle = Math.random() * Math.PI * 2;
          this.velX = Math.cos(this.angle) * this.speed;
          this.velY = Math.sin(this.angle) * this.speed;
          this.distanceTraveled = 0;
          this.distanceToTarget = Math.sqrt((x - x) ** 2 + (y - targetY) ** 2);
          this.exploded = false;
        }
        update() {
          this.x += this.velX;
          this.y += this.velY;
          this.distanceTraveled = Math.sqrt(
            (this.x - this.x) ** 2 + (this.y - this.targetY) ** 2
          );
          if (this.distanceTraveled >= this.distanceToTarget) {
            this.explode();
            this.exploded = true;
          }
        }
        explode() {
          const particleCount = 150;
          for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle(this.x, this.y));
          }
        }
        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
          ctx.fillStyle = "white";
          ctx.fill();
        }
      }

      class Particle {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.speed = Math.random() * 7 + 3;
          this.angle = Math.random() * Math.PI * 2;
          this.velX = Math.cos(this.angle) * this.speed;
          this.velY = Math.sin(this.angle) * this.speed;
          this.gravity = 0.05;
          this.lifetime = 200;
          this.opacity = 1;
          this.color = `hsl(${Math.random() * 360}, 100%, 50%)`;
          this.size = Math.random() * 2 + 1;
        }
        update() {
          this.velY += this.gravity;
          this.x += this.velX;
          this.y += this.velY;
          this.lifetime--;
          this.opacity = this.lifetime / 200;
          this.velX *= 0.98;
          this.velY *= 0.98;
        }
        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(${hslToRgb(this.color)}, ${this.opacity})`;
          ctx.fill();
        }
      }

      function hslToRgb(hsl) {
        const hslValues = hsl.match(/\d+/g).map(Number);
        let [h, s, l] = hslValues;
        s /= 100;
        l /= 100;

        const k = (n) => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = (n) =>
          l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));

        const r = Math.round(255 * f(0));
        const g = Math.round(255 * f(8));
        const b = Math.round(255 * f(4));
        return `${r}, ${g}, ${b}`;
      }

      function animate() {
        if (!animationRunning) return;
        ctx.globalCompositeOperation = "destination-out";
        ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.globalCompositeOperation = "lighter";

        fireworks.forEach((firework, idx) => {
          firework.update();
          firework.draw();
          if (firework.exploded) {
            fireworks.splice(idx, 1);
          }
        });

        particles.forEach((particle, idx) => {
          particle.update();
          particle.draw();
          if (particle.lifetime <= 0) {
            particles.splice(idx, 1);
          }
        });
        requestAnimationFrame(animate);
      }

      function startFireworks() {
        if (!animationRunning) {
          animationRunning = true;
          animate();
          fireworkInterval = setInterval(() => {
            const x = Math.random() * canvas.width;
            const y = canvas.height;
            const targetY = Math.random() * (canvas.height / 2);
            fireworks.push(new Firework(x, y, targetY));
          }, 500);
        }
      }

      function stopFireworks() {
        animationRunning = false;
        clearInterval(fireworkInterval);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        fireworks = [];
        particles = [];
      }
    </script>
  </body>
</html>
