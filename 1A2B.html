<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#3b82f6">
    <meta name="color-scheme" content="light dark">
    
    <title>進階版 1A2B 對話式遊戲 | 智慧猜數字挑戰</title>
    <meta name="description" content="結合升級系統、成就徽章、兒童模式的進階 1A2B 猜數字遊戲，支援 3-6 位數難度調整">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+TC:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'Noto Sans TC', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        },
                        success: {
                            50: '#f0fdf4',
                            500: '#22c55e',
                            700: '#15803d'
                        },
                        warning: {
                            50: '#fffbeb',
                            500: '#f59e0b',
                            700: '#d97706'
                        },
                        error: {
                            50: '#fef2f2',
                            500: '#ef4444',
                            700: '#dc2626'
                        }
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.6s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-gentle': 'pulse 2s infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'celebrate': 'celebrate 0.8s ease-out'
                    }
                }
            }
        }
    </script>
    
    <style>
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes wiggle {
            0%, 7% { transform: rotateZ(0); }
            15% { transform: rotateZ(-15deg); }
            20% { transform: rotateZ(10deg); }
            25% { transform: rotateZ(-10deg); }
            30% { transform: rotateZ(6deg); }
            35% { transform: rotateZ(-4deg); }
            40%, 100% { transform: rotateZ(0); }
        }
        
        @keyframes celebrate {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.2) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-2deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .number-input {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            letter-spacing: 0.3em;
            text-align: center;
        }
        
        .achievement-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #f59e0b 100%);
            animation: pulse 2s infinite;
        }
        
        .game-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .chat-bot {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .chat-user {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .difficulty-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 font-sans">
    <!-- 遊戲容器 -->
    <div id="gameContainer" class="min-h-screen flex flex-col">
        
        <!-- 頂部狀態列 -->
        <header class="bg-white/80 backdrop-blur-sm border-b border-gray-200 px-4 py-3 sticky top-0 z-50">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-brain text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg text-gray-800">1A2B 智慧挑戰</h1>
                        <p class="text-sm text-gray-600" id="playerLevel">等級 1 新手玩家</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-center">
                        <div class="text-xs text-gray-500">經驗值</div>
                        <div class="text-sm font-semibold text-blue-600" id="expDisplay">0 XP</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">遊戲次數</div>
                        <div class="text-sm font-semibold text-green-600" id="gamesPlayed">0</div>
                    </div>
                    <button id="settingsBtn" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主要內容區域 -->
        <main class="flex-1 max-w-4xl mx-auto w-full px-4 py-6">
            
            <!-- 歡迎畫面 -->
            <div id="welcomeScreen" class="text-center space-y-8">
                <div class="space-y-4">
                    <div class="inline-block p-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full animate-bounce-in">
                        <i class="fas fa-gamepad text-white text-4xl"></i>
                    </div>
                    <h2 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        歡迎來到 1A2B 智慧挑戰！
                    </h2>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                        這是一個結合升級系統、成就徽章的進階猜數字遊戲。挑戰您的邏輯思維，從 3 位數開始，逐步解鎖更高難度！
                    </p>
                </div>

                <!-- 難度選擇 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-w-4xl mx-auto">
                    <div class="difficulty-card bg-white rounded-xl p-6 shadow-lg border-2 border-green-200 cursor-pointer transition-all duration-300" data-digits="3">
                        <div class="text-center space-y-3">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                                <i class="fas fa-seedling text-green-600 text-xl"></i>
                            </div>
                            <h3 class="font-bold text-lg text-gray-800">初級模式</h3>
                            <p class="text-sm text-gray-600">3 位數字</p>
                            <div class="text-xs text-green-600 font-medium">✨ 適合新手</div>
                        </div>
                    </div>

                    <div class="difficulty-card bg-white rounded-xl p-6 shadow-lg border-2 border-blue-200 cursor-pointer transition-all duration-300" data-digits="4">
                        <div class="text-center space-y-3">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto">
                                <i class="fas fa-star text-blue-600 text-xl"></i>
                            </div>
                            <h3 class="font-bold text-lg text-gray-800">標準模式</h3>
                            <p class="text-sm text-gray-600">4 位數字</p>
                            <div class="text-xs text-blue-600 font-medium">🎯 經典玩法</div>
                        </div>
                    </div>

                    <div class="difficulty-card bg-white rounded-xl p-6 shadow-lg border-2 border-orange-200 cursor-pointer transition-all duration-300" data-digits="5" id="hardMode">
                        <div class="text-center space-y-3">
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto">
                                <i class="fas fa-fire text-orange-600 text-xl"></i>
                            </div>
                            <h3 class="font-bold text-lg text-gray-800">進階模式</h3>
                            <p class="text-sm text-gray-600">5 位數字</p>
                            <div class="text-xs text-orange-600 font-medium">🔥 挑戰思維</div>
                        </div>
                    </div>

                    <div class="difficulty-card bg-white rounded-xl p-6 shadow-lg border-2 border-purple-200 cursor-pointer transition-all duration-300 opacity-50" data-digits="6" id="expertMode">
                        <div class="text-center space-y-3">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto">
                                <i class="fas fa-crown text-purple-600 text-xl"></i>
                            </div>
                            <h3 class="font-bold text-lg text-gray-800">大師模式</h3>
                            <p class="text-sm text-gray-600">6 位數字</p>
                            <div class="text-xs text-purple-600 font-medium">🔒 需等級 5</div>
                        </div>
                    </div>
                </div>

                <!-- 兒童模式開關 -->
                <div class="flex items-center justify-center space-x-3 bg-white rounded-xl p-4 shadow-lg max-w-md mx-auto">
                    <i class="fas fa-child text-yellow-500 text-xl"></i>
                    <span class="font-medium text-gray-700">兒童友善模式</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="childModeToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>

            <!-- 遊戲畫面 -->
            <div id="gameScreen" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- 對話區域 -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                                        <i class="fas fa-robot text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold">AI 助手小藍</h3>
                                        <p class="text-sm opacity-90">正在幫您分析邏輯...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="chatArea" class="h-80 overflow-y-auto p-4 space-y-3 bg-gray-50">
                                <!-- 對話內容將在這裡動態生成 -->
                            </div>
                        </div>

                        <!-- 輸入區域 -->
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                            <div class="space-y-4">
                                <div class="flex items-center space-x-2">
                                    <label class="font-medium text-gray-700">第 <span id="currentRound">1</span> 回合</label>
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300" style="width: 6.67%"></div>
                                    </div>
                                    <span class="text-sm text-gray-500">最多 15 回合</span>
                                </div>
                                
                                <div class="flex space-x-3">
                                    <input 
                                        type="text" 
                                        id="guessInput" 
                                        class="flex-1 number-input px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all"
                                        placeholder="輸入您的猜測..."
                                        maxlength="6"
                                    >
                                    <button 
                                        id="submitGuess" 
                                        class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-300 font-medium"
                                    >
                                        提交 <i class="fas fa-paper-plane ml-1"></i>
                                    </button>
                                </div>

                                <!-- 兒童模式提示 -->
                                <div id="childHints" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-yellow-700">
                                            <i class="fas fa-lightbulb mr-1"></i>
                                            還有 <span id="hintsLeft">3</span> 次提示機會
                                        </span>
                                        <button id="useHint" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 transition-colors">
                                            使用提示 ✨
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 側邊資訊區 -->
                    <div class="space-y-4">
                        <!-- 遊戲狀態 -->
                        <div class="stat-card rounded-xl p-4 border border-gray-200">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                                遊戲狀態
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">目標位數：</span>
                                    <span id="targetDigits" class="font-medium text-blue-600">4</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">已用時間：</span>
                                    <span id="gameTimer" class="font-medium text-green-600">00:00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">目前回合：</span>
                                    <span id="roundDisplay" class="font-medium text-orange-600">1/15</span>
                                </div>
                            </div>
                        </div>

                        <!-- 歷史記錄 -->
                        <div class="stat-card rounded-xl p-4 border border-gray-200">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-history mr-2 text-purple-500"></i>
                                猜測記錄
                            </h3>
                            <div id="guessHistory" class="space-y-2 text-sm max-h-40 overflow-y-auto">
                                <p class="text-gray-500 text-center py-4">尚無記錄</p>
                            </div>
                        </div>

                        <!-- 成就展示 -->
                        <div class="stat-card rounded-xl p-4 border border-gray-200">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-trophy mr-2 text-yellow-500"></i>
                                成就徽章
                            </h3>
                            <div id="achievementDisplay" class="grid grid-cols-3 gap-2">
                                <!-- 成就徽章將在這裡動態生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 遊戲結束畫面 -->
            <div id="gameEndScreen" class="hidden text-center space-y-6">
                <div class="space-y-4">
                    <div id="victoryIcon" class="inline-block p-6 bg-gradient-to-r from-green-400 to-blue-500 rounded-full animate-celebrate">
                        <i class="fas fa-trophy text-white text-5xl"></i>
                    </div>
                    <h2 id="gameEndTitle" class="text-4xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                        恭喜過關！
                    </h2>
                    <p id="gameEndMessage" class="text-lg text-gray-600 max-w-2xl mx-auto">
                        您在第 X 回合成功猜出答案！
                    </p>
                </div>

                <!-- 成績統計 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto">
                    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                        <div class="text-center space-y-2">
                            <i class="fas fa-clock text-blue-500 text-2xl"></i>
                            <h3 class="font-semibold text-gray-800">遊戲時間</h3>
                            <p id="finalTime" class="text-2xl font-bold text-blue-600">02:34</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                        <div class="text-center space-y-2">
                            <i class="fas fa-target text-green-500 text-2xl"></i>
                            <h3 class="font-semibold text-gray-800">完成回合</h3>
                            <p id="finalRounds" class="text-2xl font-bold text-green-600">7</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                        <div class="text-center space-y-2">
                            <i class="fas fa-star text-yellow-500 text-2xl"></i>
                            <h3 class="font-semibold text-gray-800">獲得經驗</h3>
                            <p id="expGained" class="text-2xl font-bold text-yellow-600">+50 XP</p>
                        </div>
                    </div>
                </div>

                <!-- 新解鎖內容 -->
                <div id="unlockedContent" class="hidden space-y-4">
                    <h3 class="text-xl font-semibold text-purple-600">🎉 新內容解鎖！</h3>
                    <div id="unlockedItems" class="flex flex-wrap justify-center gap-3">
                        <!-- 解鎖項目將在這裡顯示 -->
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
                    <button id="playAgainBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-300 font-medium">
                        <i class="fas fa-redo mr-2"></i>再玩一次
                    </button>
                    <button id="changeDifficultyBtn" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-300 font-medium">
                        <i class="fas fa-cogs mr-2"></i>更換難度
                    </button>
                </div>
            </div>

        </main>

        <!-- 設定面板 -->
        <div id="settingsPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-gray-800">遊戲設定</h2>
                        <button id="closeSettings" class="text-gray-500 hover:text-gray-700 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- 個人統計 -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700 border-b pb-2">個人統計</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                <div class="text-blue-600 font-bold text-lg" id="totalGames">0</div>
                                <div class="text-gray-600">總遊戲數</div>
                            </div>
                            <div class="text-center p-3 bg-green-50 rounded-lg">
                                <div class="text-green-600 font-bold text-lg" id="winRate">0%</div>
                                <div class="text-gray-600">勝率</div>
                            </div>
                            <div class="text-center p-3 bg-purple-50 rounded-lg">
                                <div class="text-purple-600 font-bold text-lg" id="avgRounds">0</div>
                                <div class="text-gray-600">平均回合</div>
                            </div>
                            <div class="text-center p-3 bg-yellow-50 rounded-lg">
                                <div class="text-yellow-600 font-bold text-lg" id="bestScore">-</div>
                                <div class="text-gray-600">最佳成績</div>
                            </div>
                        </div>
                    </div>

                    <!-- 排行榜 -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700 border-b pb-2">本地排行榜</h3>
                        <div id="leaderboard" class="space-y-2 text-sm">
                            <!-- 排行榜內容 -->
                        </div>
                    </div>

                    <!-- 數據管理 -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700 border-b pb-2">數據管理</h3>
                        <div class="space-y-2">
                            <button id="exportData" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-download mr-2"></i>匯出遊戲數據
                            </button>
                            <button id="resetData" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                <i class="fas fa-trash mr-2"></i>重置所有數據
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 成就解鎖通知 -->
        <div id="achievementNotification" class="hidden fixed top-4 right-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-lg shadow-lg z-50 animate-slide-up">
            <div class="flex items-center space-x-3">
                <i class="fas fa-trophy text-2xl"></i>
                <div>
                    <div class="font-bold">成就解鎖！</div>
                    <div id="achievementText" class="text-sm opacity-90"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== 遊戲核心類別定義 =====
        
        class Game1A2B {
            constructor() {
                this.gameState = {
                    isPlaying: false,
                    currentScreen: 'welcome', // welcome, game, end
                    digits: 4,
                    maxRounds: 15,
                    currentRound: 1,
                    target: '',
                    guesses: [],
                    startTime: null,
                    childMode: false,
                    hintsUsed: 0,
                    maxHints: 3
                };
                
                this.playerData = this.loadPlayerData();
                this.achievements = this.initAchievements();
                this.gameTimer = null;
                
                this.initEventListeners();
                this.updateUI();
                this.checkUnlockedModes();
            }
            
            // 載入玩家數據
            loadPlayerData() {
                const defaultData = {
                    uid: this.generateUID(),
                    level: 1,
                    experience: 0,
                    gamesPlayed: 0,
                    gamesWon: 0,
                    bestScores: {
                        3: null,
                        4: null,
                        5: null,
                        6: null
                    },
                    unlockedModes: {
                        3: true,
                        4: true,
                        5: false,
                        6: false
                    },
                    achievements: [],
                    history: []
                };
                
                const saved = localStorage.getItem('1a2b_player_data');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        return { ...defaultData, ...data };
                    } catch (e) {
                        console.warn('無法載入玩家數據，使用預設值');
                        return defaultData;
                    }
                }
                
                this.savePlayerData(defaultData);
                return defaultData;
            }
            
            // 儲存玩家數據
            savePlayerData(data = null) {
                const dataToSave = data || this.playerData;
                localStorage.setItem('1a2b_player_data', JSON.stringify(dataToSave));
            }
            
            // 生成唯一識別碼
            generateUID() {
                return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            // 初始化成就系統
            initAchievements() {
                return {
                    firstWin: { name: '初試啼聲', desc: '完成第一場遊戲', icon: 'fa-baby', earned: false },
                    speedRunner: { name: '閃電猜手', desc: '在 5 回合內完成 4 位數', icon: 'fa-bolt', earned: false },
                    persistent: { name: '鍥而不捨', desc: '完成 10 場遊戲', icon: 'fa-mountain', earned: false },
                    genius: { name: '數字天才', desc: '完成 6 位數挑戰', icon: 'fa-brain', earned: false },
                    perfectGame: { name: '完美遊戲', desc: '未使用提示完成困難模式', icon: 'fa-crown', earned: false },
                    veteran: { name: '遊戲老兵', desc: '達到等級 5', icon: 'fa-medal', earned: false }
                };
            }
            
            // 檢查解鎖模式
            checkUnlockedModes() {
                // 根據等級解鎖模式
                if (this.playerData.level >= 3) {
                    this.playerData.unlockedModes[5] = true;
                }
                if (this.playerData.level >= 5) {
                    this.playerData.unlockedModes[6] = true;
                }
                
                // 更新UI
                const hardMode = document.getElementById('hardMode');
                const expertMode = document.getElementById('expertMode');
                
                if (this.playerData.unlockedModes[5]) {
                    hardMode.classList.remove('opacity-50');
                } else {
                    hardMode.classList.add('opacity-50');
                }
                
                if (this.playerData.unlockedModes[6]) {
                    expertMode.classList.remove('opacity-50');
                    expertMode.querySelector('.text-xs').innerHTML = '👑 大師挑戰';
                } else {
                    expertMode.classList.add('opacity-50');
                }
            }
            
            // 初始化事件監聽器
            initEventListeners() {
                // 難度選擇
                document.querySelectorAll('.difficulty-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const digits = parseInt(e.currentTarget.dataset.digits);
                        if (this.playerData.unlockedModes[digits]) {
                            this.startNewGame(digits);
                        } else {
                            this.showNotification('此模式尚未解鎖！需要達到更高等級', 'warning');
                        }
                    });
                });
                
                // 兒童模式切換
                document.getElementById('childModeToggle').addEventListener('change', (e) => {
                    this.gameState.childMode = e.target.checked;
                });
                
                // 遊戲輸入
                const guessInput = document.getElementById('guessInput');
                const submitBtn = document.getElementById('submitGuess');
                
                guessInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.submitGuess();
                    }
                    
                    // 只允許數字輸入
                    if (!/\d/.test(e.key) && !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
                
                guessInput.addEventListener('input', (e) => {
                    // 移除重複數字
                    let value = e.target.value;
                    let uniqueValue = '';
                    for (let char of value) {
                        if (!uniqueValue.includes(char)) {
                            uniqueValue += char;
                        }
                    }
                    if (value !== uniqueValue) {
                        e.target.value = uniqueValue;
                    }
                });
                
                submitBtn.addEventListener('click', () => this.submitGuess());
                
                // 提示按鈕
                document.getElementById('useHint').addEventListener('click', () => this.useHint());
                
                // 遊戲結束按鈕
                document.getElementById('playAgainBtn').addEventListener('click', () => {
                    this.startNewGame(this.gameState.digits);
                });
                
                document.getElementById('changeDifficultyBtn').addEventListener('click', () => {
                    this.showScreen('welcome');
                });
                
                // 設定面板
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    document.getElementById('settingsPanel').classList.remove('hidden');
                    this.updateSettingsPanel();
                });
                
                document.getElementById('closeSettings').addEventListener('click', () => {
                    document.getElementById('settingsPanel').classList.add('hidden');
                });
                
                // 數據管理
                document.getElementById('exportData').addEventListener('click', () => this.exportData());
                document.getElementById('resetData').addEventListener('click', () => this.resetData());
            }
            
            // 開始新遊戲
            startNewGame(digits) {
                this.gameState = {
                    ...this.gameState,
                    isPlaying: true,
                    digits: digits,
                    currentRound: 1,
                    target: this.generateTarget(digits),
                    guesses: [],
                    startTime: Date.now(),
                    hintsUsed: 0
                };
                
                this.showScreen('game');
                this.startTimer();
                this.updateGameUI();
                this.addChatMessage('bot', this.getWelcomeMessage(digits));
                
                document.getElementById('guessInput').focus();
            }
            
            // 生成目標數字
            generateTarget(digits) {
                const available = '0123456789'.split('');
                let target = '';
                
                for (let i = 0; i < digits; i++) {
                    const randomIndex = Math.floor(Math.random() * available.length);
                    target += available[randomIndex];
                    available.splice(randomIndex, 1);
                }
                
                console.log('目標數字（開發用）:', target); // 開發時可用
                return target;
            }
            
            // 獲得歡迎訊息
            getWelcomeMessage(digits) {
                const messages = {
                    3: '歡迎來到初級模式！我幫您準備了一個 3 位數字，每個數字都不相同喔！🌟',
                    4: '準備好了嗎？這是經典的 4 位數挑戰！運用邏輯推理找出答案吧！🎯',
                    5: '哇！進階模式需要更強的邏輯思維，5 位數字等著您來破解！🔥',
                    6: '恭喜進入大師級挑戰！6 位數字是真正高手的戰場！👑'
                };
                
                let message = messages[digits] || '讓我們開始這場智慧挑戰！';
                
                if (this.gameState.childMode) {
                    message += '\n\n🎈 兒童模式已啟動：\n🔵 = A（數字和位置都對）\n🟡 = B（數字對但位置不對）\n您還可以使用 3 次提示喔！';
                }
                
                return message;
            }
            
            // 提交猜測
            submitGuess() {
                const input = document.getElementById('guessInput');
                const guess = input.value.trim();
                
                if (!this.validateGuess(guess)) {
                    return;
                }
                
                const result = this.calculateResult(guess, this.gameState.target);
                this.gameState.guesses.push({ guess, result, round: this.gameState.currentRound });
                
                // 更新聊天
                this.addChatMessage('user', `我猜：${guess}`);
                this.addChatMessage('bot', this.formatResult(result, guess));
                
                // 檢查是否獲勝
                if (result.A === this.gameState.digits) {
                    this.endGame(true);
                    return;
                }
                
                // 檢查是否達到最大回合數
                if (this.gameState.currentRound >= this.gameState.maxRounds) {
                    this.endGame(false);
                    return;
                }
                
                this.gameState.currentRound++;
                this.updateGameUI();
                input.value = '';
                input.focus();
            }
            
            // 驗證猜測
            validateGuess(guess) {
                if (guess.length !== this.gameState.digits) {
                    this.showNotification(`請輸入 ${this.gameState.digits} 位數字`, 'warning');
                    return false;
                }
                
                if (!/^\d+$/.test(guess)) {
                    this.showNotification('只能輸入數字', 'warning');
                    return false;
                }
                
                if (new Set(guess).size !== guess.length) {
                    this.showNotification('數字不能重複', 'warning');
                    return false;
                }
                
                return true;
            }
            
            // 計算結果
            calculateResult(guess, target) {
                let A = 0, B = 0;
                
                for (let i = 0; i < guess.length; i++) {
                    if (guess[i] === target[i]) {
                        A++;
                    } else if (target.includes(guess[i])) {
                        B++;
                    }
                }
                
                return { A, B };
            }
            
            // 格式化結果訊息
            formatResult(result, guess) {
                let message = `結果：${result.A}A${result.B}B`;
                
                if (this.gameState.childMode) {
                    message += '\n' + '🔵'.repeat(result.A) + '🟡'.repeat(result.B);
                }
                
                // 根據結果給予鼓勵
                if (result.A === this.gameState.digits) {
                    message += '\n\n🎉 太棒了！您成功破解了密碼！';
                } else if (result.A > 0) {
                    message += `\n\n很好！有 ${result.A} 個數字位置完全正確！`;
                } else if (result.B > 0) {
                    message += `\n\n不錯！有 ${result.B} 個數字存在但位置需要調整！`;
                } else {
                    message += '\n\n這些數字都不在答案中，試試其他數字吧！';
                }
                
                return message;
            }
            
            // 使用提示
            useHint() {
                if (this.gameState.hintsUsed >= this.gameState.maxHints) {
                    this.showNotification('提示次數已用完', 'warning');
                    return;
                }
                
                this.gameState.hintsUsed++;
                
                // 隨機給出一個位置的正確數字
                const randomIndex = Math.floor(Math.random() * this.gameState.target.length);
                const hintDigit = this.gameState.target[randomIndex];
                
                this.addChatMessage('bot', `💡 提示：第 ${randomIndex + 1} 位數字是 ${hintDigit}`);
                
                document.getElementById('hintsLeft').textContent = this.gameState.maxHints - this.gameState.hintsUsed;
                
                if (this.gameState.hintsUsed >= this.gameState.maxHints) {
                    document.getElementById('useHint').disabled = true;
                    document.getElementById('useHint').textContent = '提示已用完';
                }
            }
            
            // 遊戲結束
            endGame(won) {
                this.gameState.isPlaying = false;
                clearInterval(this.gameTimer);
                
                const endTime = Date.now();
                const totalTime = Math.floor((endTime - this.gameState.startTime) / 1000);
                const rounds = won ? this.gameState.currentRound : this.gameState.maxRounds;
                
                // 記錄遊戲歷史
                const gameRecord = {
                    date: new Date().toISOString().split('T')[0],
                    digits: this.gameState.digits,
                    won: won,
                    rounds: rounds,
                    time: totalTime,
                    hintsUsed: this.gameState.hintsUsed,
                    target: this.gameState.target
                };
                
                this.playerData.history.push(gameRecord);
                this.playerData.gamesPlayed++;
                
                if (won) {
                    this.playerData.gamesWon++;
                    
                    // 更新最佳成績
                    const currentBest = this.playerData.bestScores[this.gameState.digits];
                    if (!currentBest || rounds < currentBest) {
                        this.playerData.bestScores[this.gameState.digits] = rounds;
                    }
                    
                    // 計算經驗值
                    const expGained = this.calculateExperience(rounds, totalTime, this.gameState.digits, this.gameState.hintsUsed);
                    this.playerData.experience += expGained;
                    
                    // 檢查升級
                    this.checkLevelUp();
                    
                    // 檢查成就
                    this.checkAchievements();
                    
                    this.showGameEndScreen(true, rounds, totalTime, expGained);
                } else {
                    this.addChatMessage('bot', `遊戲結束！正確答案是：${this.gameState.target}`);
                    this.showGameEndScreen(false, rounds, totalTime, 0);
                }
                
                this.savePlayerData();
            }
            
            // 計算經驗值
            calculateExperience(rounds, time, digits, hints) {
                let baseExp = digits * 10; // 基礎經驗
                
                // 回合數獎勵（越少回合越多經驗）
                const roundBonus = Math.max(0, (15 - rounds) * 5);
                
                // 時間獎勵（越快越多經驗）
                const timeBonus = Math.max(0, Math.floor((300 - time) / 10));
                
                // 提示懲罰
                const hintPenalty = hints * 10;
                
                return Math.max(10, baseExp + roundBonus + timeBonus - hintPenalty);
            }
            
            // 檢查升級
            checkLevelUp() {
                const requiredExp = this.playerData.level * 100;
                if (this.playerData.experience >= requiredExp) {
                    this.playerData.level++;
                    this.playerData.experience -= requiredExp;
                    this.showNotification(`🎉 恭喜升級到等級 ${this.playerData.level}！`, 'success');
                    this.checkUnlockedModes();
                }
            }
            
            // 檢查成就
            checkAchievements() {
                const newAchievements = [];
                
                // 初試啼聲
                if (this.playerData.gamesWon === 1 && !this.playerData.achievements.includes('firstWin')) {
                    newAchievements.push('firstWin');
                }
                
                // 閃電猜手
                if (this.gameState.digits === 4 && this.gameState.currentRound <= 5 && !this.playerData.achievements.includes('speedRunner')) {
                    newAchievements.push('speedRunner');
                }
                
                // 鍥而不捨
                if (this.playerData.gamesPlayed >= 10 && !this.playerData.achievements.includes('persistent')) {
                    newAchievements.push('persistent');
                }
                
                // 數字天才
                if (this.gameState.digits === 6 && !this.playerData.achievements.includes('genius')) {
                    newAchievements.push('genius');
                }
                
                // 完美遊戲
                if (this.gameState.digits >= 5 && this.gameState.hintsUsed === 0 && !this.playerData.achievements.includes('perfectGame')) {
                    newAchievements.push('perfectGame');
                }
                
                // 遊戲老兵
                if (this.playerData.level >= 5 && !this.playerData.achievements.includes('veteran')) {
                    newAchievements.push('veteran');
                }
                
                // 顯示新成就
                newAchievements.forEach(achievementId => {
                    this.playerData.achievements.push(achievementId);
                    this.showAchievementUnlock(achievementId);
                });
            }
            
            // 顯示成就解鎖
            showAchievementUnlock(achievementId) {
                const achievement = this.achievements[achievementId];
                const notification = document.getElementById('achievementNotification');
                const text = document.getElementById('achievementText');
                
                text.textContent = `${achievement.name}: ${achievement.desc}`;
                notification.classList.remove('hidden');
                
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 4000);
            }
            
            // 顯示遊戲結束畫面
            showGameEndScreen(won, rounds, time, exp) {
                const title = document.getElementById('gameEndTitle');
                const message = document.getElementById('gameEndMessage');
                const icon = document.getElementById('victoryIcon');
                
                if (won) {
                    title.textContent = '🎉 恭喜過關！';
                    message.textContent = `您在第 ${rounds} 回合成功猜出 ${this.gameState.digits} 位數字！`;
                    icon.innerHTML = '<i class="fas fa-trophy text-white text-5xl"></i>';
                } else {
                    title.textContent = '😅 再接再厲！';
                    message.textContent = `很遺憾，正確答案是 ${this.gameState.target}，下次再挑戰吧！`;
                    icon.innerHTML = '<i class="fas fa-heart text-white text-5xl"></i>';
                }
                
                // 更新統計
                document.getElementById('finalTime').textContent = this.formatTime(time);
                document.getElementById('finalRounds').textContent = rounds;
                document.getElementById('expGained').textContent = `+${exp} XP`;
                
                this.showScreen('end');
            }
            
            // 格式化時間
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            // 開始計時器
            startTimer() {
                this.gameTimer = setInterval(() => {
                    if (this.gameState.startTime) {
                        const elapsed = Math.floor((Date.now() - this.gameState.startTime) / 1000);
                        document.getElementById('gameTimer').textContent = this.formatTime(elapsed);
                    }
                }, 1000);
            }
            
            // 添加聊天訊息
            addChatMessage(sender, message) {
                const chatArea = document.getElementById('chatArea');
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;
                
                messageDiv.innerHTML = `
                    <div class="chat-bubble chat-${sender} px-4 py-2 rounded-lg">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                `;
                
                chatArea.appendChild(messageDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            }
            
            // 更新遊戲UI
            updateGameUI() {
                document.getElementById('targetDigits').textContent = this.gameState.digits;
                document.getElementById('currentRound').textContent = this.gameState.currentRound;
                document.getElementById('roundDisplay').textContent = `${this.gameState.currentRound}/${this.gameState.maxRounds}`;
                
                // 更新進度條
                const progress = (this.gameState.currentRound / this.gameState.maxRounds) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
                
                // 更新猜測歷史
                this.updateGuessHistory();
                
                // 更新兒童模式UI
                if (this.gameState.childMode) {
                    document.getElementById('childHints').classList.remove('hidden');
                    document.getElementById('hintsLeft').textContent = this.gameState.maxHints - this.gameState.hintsUsed;
                } else {
                    document.getElementById('childHints').classList.add('hidden');
                }
                
                // 更新輸入框佔位符
                document.getElementById('guessInput').placeholder = `輸入 ${this.gameState.digits} 位數字...`;
                document.getElementById('guessInput').maxLength = this.gameState.digits;
            }
            
            // 更新猜測歷史
            updateGuessHistory() {
                const historyDiv = document.getElementById('guessHistory');
                
                if (this.gameState.guesses.length === 0) {
                    historyDiv.innerHTML = '<p class="text-gray-500 text-center py-4">尚無記錄</p>';
                    return;
                }
                
                historyDiv.innerHTML = this.gameState.guesses.slice(-5).reverse().map(item => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-mono">${item.guess}</span>
                        <span class="text-sm font-medium text-blue-600">${item.result.A}A${item.result.B}B</span>
                    </div>
                `).join('');
            }
            
            // 更新整體UI
            updateUI() {
                document.getElementById('playerLevel').textContent = `等級 ${this.playerData.level} ${this.getLevelTitle()}`;
                document.getElementById('expDisplay').textContent = `${this.playerData.experience} XP`;
                document.getElementById('gamesPlayed').textContent = this.playerData.gamesPlayed;
                
                this.updateAchievementDisplay();
            }
            
            // 獲得等級稱號
            getLevelTitle() {
                const titles = {
                    1: '新手玩家',
                    2: '見習猜手',
                    3: '邏輯達人',
                    4: '推理專家',
                    5: '數字大師'
                };
                return titles[Math.min(this.playerData.level, 5)] || '傳奇玩家';
            }
            
            // 更新成就顯示
            updateAchievementDisplay() {
                const achievementDiv = document.getElementById('achievementDisplay');
                
                achievementDiv.innerHTML = Object.entries(this.achievements).map(([id, achievement]) => {
                    const earned = this.playerData.achievements.includes(id);
                    return `
                        <div class="text-center p-2 rounded-lg border ${earned ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200'}" title="${achievement.desc}">
                            <i class="fas ${achievement.icon} text-lg ${earned ? 'text-yellow-600' : 'text-gray-400'}"></i>
                            <div class="text-xs mt-1 ${earned ? 'text-yellow-700' : 'text-gray-500'}">${achievement.name}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // 顯示指定畫面
            showScreen(screen) {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('gameEndScreen').classList.add('hidden');
                
                document.getElementById(`${screen}Screen`).classList.remove('hidden');
                this.gameState.currentScreen = screen;
                
                if (screen === 'game') {
                    document.getElementById('chatArea').innerHTML = '';
                }
            }
            
            // 顯示通知
            showNotification(message, type = 'info') {
                // 簡單的通知實現
                const colors = {
                    success: 'bg-green-500',
                    warning: 'bg-yellow-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500'
                };
                
                const notification = document.createElement('div');
                notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-up`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
            
            // 更新設定面板
            updateSettingsPanel() {
                document.getElementById('totalGames').textContent = this.playerData.gamesPlayed;
                document.getElementById('winRate').textContent = this.playerData.gamesPlayed > 0 ? 
                    Math.round((this.playerData.gamesWon / this.playerData.gamesPlayed) * 100) + '%' : '0%';
                
                // 計算平均回合數
                const avgRounds = this.playerData.history.filter(g => g.won).length > 0 ?
                    Math.round(this.playerData.history.filter(g => g.won).reduce((sum, g) => sum + g.rounds, 0) / this.playerData.history.filter(g => g.won).length) : 0;
                document.getElementById('avgRounds').textContent = avgRounds;
                
                // 最佳成績
                const bestScore = Math.min(...Object.values(this.playerData.bestScores).filter(s => s !== null));
                document.getElementById('bestScore').textContent = isFinite(bestScore) ? bestScore : '-';
                
                // 排行榜
                this.updateLeaderboard();
            }
            
            // 更新排行榜
            updateLeaderboard() {
                const leaderboard = document.getElementById('leaderboard');
                const topGames = this.playerData.history
                    .filter(g => g.won)
                    .sort((a, b) => a.rounds - b.rounds)
                    .slice(0, 5);
                
                if (topGames.length === 0) {
                    leaderboard.innerHTML = '<p class="text-gray-500 text-center py-4">暫無記錄</p>';
                    return;
                }
                
                leaderboard.innerHTML = topGames.map((game, index) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-bold text-${index === 0 ? 'yellow' : index === 1 ? 'gray' : 'orange'}-600">#${index + 1}</span>
                        <span>${game.digits}位數 - ${game.rounds}回合</span>
                        <span class="text-xs text-gray-500">${game.date}</span>
                    </div>
                `).join('');
            }
            
            // 匯出數據
            exportData() {
                const dataStr = JSON.stringify(this.playerData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `1a2b_game_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                this.showNotification('數據已匯出', 'success');
            }
            
            // 重置數據
            resetData() {
                if (confirm('確定要重置所有遊戲數據嗎？此操作無法復原！')) {
                    localStorage.removeItem('1a2b_player_data');
                    location.reload();
                }
            }
        }
        
        // 初始化遊戲
        document.addEventListener('DOMContentLoaded', () => {
            window.game = new Game1A2B();
        });
    </script>
</body>
</html>