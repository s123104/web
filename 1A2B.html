<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>進階版1A2B對話式遊戲 🧠</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1'
                        },
                        secondary: {
                            50: '#fef3c7',
                            100: '#fde68a',
                            500: '#f59e0b',
                            600: '#d97706'
                        },
                        neutral: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a'
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'Noto Sans TC', 'system-ui', 'sans-serif']
                    },
                    spacing: {
                        '18': '4.5rem',
                        '88': '22rem'
                    }
                }
            }
        }
    </script>
    
    <style>
        /* 自訂CSS增強 */
        .game-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-a {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
        }
        
        .result-b {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
        }
        
        .achievement-badge {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px #ffd700; }
            to { box-shadow: 0 0 20px #ffd700, 0 0 30px #ffd700; }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-primary-50 to-secondary-50 min-h-screen font-sans">
    <!-- Header 區域 -->
    <header class="bg-white shadow-sm border-b border-neutral-200">
        <div class="max-w-4xl mx-auto px-4 py-4 sm:px-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-brain text-primary-600 text-2xl"></i>
                    <h1 class="text-xl sm:text-2xl font-bold text-neutral-800 tracking-tight">1A2B 智慧遊戲</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- 使用者等級顯示 -->
                    <div class="hidden sm:flex items-center space-x-2 bg-primary-50 px-3 py-1 rounded-full">
                        <i class="fas fa-star text-secondary-500"></i>
                        <span class="text-sm font-medium text-primary-700" id="userLevel">Lv.1</span>
                    </div>
                    <!-- 設定按鈕 -->
                    <button id="settingsBtn" class="p-2 text-neutral-600 hover:text-primary-600 transition-colors duration-200">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要內容區域 -->
    <main class="max-w-4xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        
        <!-- 遊戲狀態面板 -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="game-card rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-primary-600" id="currentRound">0</div>
                <div class="text-sm text-neutral-600">回合數</div>
            </div>
            <div class="game-card rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-secondary-600" id="gameTime">00:00</div>
                <div class="text-sm text-neutral-600">遊戲時間</div>
            </div>
            <div class="game-card rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-neutral-700" id="difficulty">4位數</div>
                <div class="text-sm text-neutral-600">遊戲難度</div>
            </div>
        </div>

        <!-- 對話式遊戲介面 -->
        <div class="game-card rounded-2xl p-6 mb-6">
            
            <!-- 遊戲對話區域 -->
            <div id="gameDialog" class="space-y-4 mb-6 h-64 overflow-y-auto">
                <!-- 對話內容將動態添加 -->
            </div>

            <!-- 遊戲控制區域 -->
            <div id="gameControls" class="space-y-4">
                
                <!-- 難度選擇 (初始狀態) -->
                <div id="difficultySelection" class="text-center">
                    <h3 class="text-lg font-semibold text-neutral-800 mb-4">🎯 選擇遊戲難度</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <button class="difficulty-btn bg-green-100 hover:bg-green-200 text-green-800 px-4 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105" data-digits="3">
                            3位數 😊
                        </button>
                        <button class="difficulty-btn bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105" data-digits="4">
                            4位數 🤔
                        </button>
                        <button class="difficulty-btn bg-orange-100 hover:bg-orange-200 text-orange-800 px-4 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105" data-digits="5">
                            5位數 😤
                        </button>
                        <button id="hardMode" class="difficulty-btn bg-red-100 hover:bg-red-200 text-red-800 px-4 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105 opacity-50 cursor-not-allowed" data-digits="6" disabled>
                            6位數 🔒
                        </button>
                    </div>
                    
                    <!-- 兒童模式開關 -->
                    <div class="mt-4 flex items-center justify-center space-x-3">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="childMode" class="rounded border-neutral-300 text-primary-600 focus:ring-primary-500">
                            <span class="text-sm font-medium text-neutral-700">👶 兒童提示模式</span>
                        </label>
                    </div>
                </div>

                <!-- 猜測輸入區域 (遊戲中) -->
                <div id="guessInput" class="hidden">
                    <div class="flex space-x-3">
                        <input type="text" id="numberInput" placeholder="輸入您的猜測..." 
                               class="flex-1 px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-lg text-center font-mono tracking-widest">
                        <button id="submitGuess" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                            猜測 🎯
                        </button>
                    </div>
                    
                    <!-- 兒童模式提示區域 -->
                    <div id="childHints" class="hidden mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="text-sm font-medium text-yellow-800 mb-2">💡 提示說明:</div>
                        <div class="text-xs text-yellow-700 space-y-1">
                            <div>🔵 表示數字和位置都正確 (A)</div>
                            <div>🟡 表示數字正確但位置錯誤 (B)</div>
                            <div class="mt-2">
                                <button id="showHint" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs transition-colors duration-200">
                                    使用提示 (剩餘: <span id="hintCount">3</span>次)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 遊戲結束控制 -->
                <div id="gameEndControls" class="hidden text-center space-y-3">
                    <button id="newGameBtn" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                        🔄 開始新遊戲
                    </button>
                    <button id="viewStatsBtn" class="bg-neutral-600 hover:bg-neutral-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                        📊 查看統計
                    </button>
                </div>
            </div>
        </div>

        <!-- 歷史記錄面板 -->
        <div id="historyPanel" class="game-card rounded-2xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-neutral-800 mb-4 flex items-center">
                <i class="fas fa-history text-primary-600 mr-2"></i>
                本局記錄
            </h3>
            <div id="gameHistory" class="space-y-2 max-h-48 overflow-y-auto">
                <div class="text-sm text-neutral-600 text-center py-8">尚未開始遊戲</div>
            </div>
        </div>

        <!-- 成就與統計面板 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- 成就徽章 -->
            <div class="game-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-neutral-800 mb-4 flex items-center">
                    <i class="fas fa-trophy text-secondary-600 mr-2"></i>
                    成就徽章
                </h3>
                <div id="achievements" class="grid grid-cols-2 gap-3">
                    <!-- 成就徽章將動態添加 -->
                </div>
            </div>

            <!-- 最佳記錄 -->
            <div class="game-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-neutral-800 mb-4 flex items-center">
                    <i class="fas fa-medal text-primary-600 mr-2"></i>
                    最佳記錄
                </h3>
                <div id="bestRecords" class="space-y-3">
                    <!-- 最佳記錄將動態添加 -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-12 py-6 text-center text-sm text-neutral-600">
        <div class="max-w-4xl mx-auto px-4">
            <p>🧠 1A2B智慧遊戲 - 訓練邏輯思維的最佳選擇</p>
            <p class="mt-1">Made with ❤️ by AI Assistant</p>
        </div>
    </footer>

    <!-- 隱藏彩蛋按鈕 -->
    <div id="easterEggBtn" class="fixed bottom-4 right-4 w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 opacity-70 hover:opacity-100">
        <i class="fas fa-magic text-white text-lg"></i>
    </div>

    <!-- 設定彈窗 -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 mx-4 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-neutral-800">⚙️ 遊戲設定</h3>
                <button id="closeSettings" class="text-neutral-500 hover:text-neutral-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-2">🎵 音效設定</label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="soundEnabled" checked class="rounded border-neutral-300 text-primary-600 focus:ring-primary-500">
                        <span class="text-sm">啟用音效</span>
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-2">📊 重置數據</label>
                    <button id="resetData" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm transition-colors duration-200">
                        清除所有遊戲記錄
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 彩蛋模態框 -->
    <div id="easterEggModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-8 mx-4 w-full max-w-md text-center text-white">
            <h3 class="text-2xl font-bold mb-4">🎉 恭喜發現彩蛋！</h3>
            <p class="mb-4">您已解鎖特殊成就：「探索者」！</p>
            <div class="text-6xl mb-4">🔮</div>
            <p class="text-sm mb-6">傳說中，只有真正的智者才能發現這個隱藏的秘密...</p>
            <button id="closeEasterEgg" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors duration-200">
                繼續探索 ✨
            </button>
        </div>
    </div>

    <script>
        // 遊戲主類別 - 模組化管理整個遊戲狀態與邏輯
        class Game1A2B {
            constructor() {
                this.gameState = {
                    isPlaying: false,
                    answer: '',
                    rounds: 0,
                    maxRounds: 15,
                    digits: 4,
                    childMode: false,
                    hintsUsed: 0,
                    maxHints: 3,
                    startTime: null,
                    gameHistory: []
                };
                
                this.userData = this.loadUserData();
                this.achievements = this.initAchievements();
                this.timer = null;
                this.easterEggClicks = 0;
                
                this.init();
            }

            // 初始化遊戲
            init() {
                this.bindEvents();
                this.updateUI();
                this.addWelcomeMessage();
                this.checkEasterEgg();
            }

            // 事件綁定 - 集中管理所有UI交互
            bindEvents() {
                // 難度選擇
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (!e.target.disabled) {
                            this.startGame(parseInt(e.target.dataset.digits));
                        }
                    });
                });

                // 猜測提交
                document.getElementById('submitGuess').addEventListener('click', () => this.submitGuess());
                document.getElementById('numberInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.submitGuess();
                });

                // 新遊戲
                document.getElementById('newGameBtn').addEventListener('click', () => this.resetGame());
                
                // 設定相關
                document.getElementById('settingsBtn').addEventListener('click', () => this.showSettings());
                document.getElementById('closeSettings').addEventListener('click', () => this.hideSettings());
                document.getElementById('resetData').addEventListener('click', () => this.resetUserData());

                // 兒童模式
                document.getElementById('childMode').addEventListener('change', (e) => {
                    this.gameState.childMode = e.target.checked;
                });

                // 提示按鈕
                document.getElementById('showHint').addEventListener('click', () => this.showHint());

                // 彩蛋相關
                document.getElementById('easterEggBtn').addEventListener('click', () => this.triggerEasterEgg());
                document.getElementById('closeEasterEgg').addEventListener('click', () => this.hideEasterEgg());

                // 統計查看
                document.getElementById('viewStatsBtn').addEventListener('click', () => this.showStats());
            }

            // 開始新遊戲
            startGame(digits) {
                this.gameState = {
                    ...this.gameState,
                    isPlaying: true,
                    answer: this.generateAnswer(digits),
                    digits: digits,
                    rounds: 0,
                    hintsUsed: 0,
                    startTime: new Date(),
                    gameHistory: [],
                    childMode: document.getElementById('childMode').checked
                };

                this.updateUI();
                this.startTimer();
                this.addMessage(`🎮 遊戲開始！我已經想好了一個${digits}位數的數字，請開始猜測吧！`, 'system');
                
                if (this.gameState.childMode) {
                    this.addMessage(`👶 兒童模式已啟用，您可以使用視覺提示輔助遊戲！`, 'system');
                }
            }

            // 生成隨機答案 - 確保數字不重複
            generateAnswer(digits) {
                const numbers = '0123456789'.split('');
                let answer = '';
                
                // 第一位不能是0
                const firstDigit = Math.floor(Math.random() * 9) + 1;
                answer += firstDigit;
                numbers.splice(firstDigit, 1);
                
                // 生成剩餘位數
                for (let i = 1; i < digits; i++) {
                    const randomIndex = Math.floor(Math.random() * numbers.length);
                    answer += numbers[randomIndex];
                    numbers.splice(randomIndex, 1);
                }
                
                return answer;
            }

            // 提交猜測
            submitGuess() {
                const input = document.getElementById('numberInput');
                const guess = input.value.trim();
                
                if (!this.validateGuess(guess)) return;

                const result = this.calculateResult(guess, this.gameState.answer);
                this.gameState.rounds++;
                this.gameState.gameHistory.push({ guess, result, round: this.gameState.rounds });

                this.addGuessMessage(guess, result);
                
                // 檢查遊戲結束條件
                if (result.A === this.gameState.digits) {
                    this.endGame(true);
                } else if (this.gameState.rounds >= this.gameState.maxRounds) {
                    this.endGame(false);
                } else {
                    input.value = '';
                    this.updateUI();
                }
            }

            // 驗證猜測輸入
            validateGuess(guess) {
                if (guess.length !== this.gameState.digits) {
                    this.addMessage(`❌ 請輸入${this.gameState.digits}位數！`, 'error');
                    return false;
                }

                if (!/^\d+$/.test(guess)) {
                    this.addMessage(`❌ 請只輸入數字！`, 'error');
                    return false;
                }

                if (new Set(guess).size !== guess.length) {
                    this.addMessage(`❌ 數字不能重複！`, 'error');
                    return false;
                }

                return true;
            }

            // 計算A和B的結果
            calculateResult(guess, answer) {
                let A = 0, B = 0;
                
                for (let i = 0; i < guess.length; i++) {
                    if (guess[i] === answer[i]) {
                        A++;
                    } else if (answer.includes(guess[i])) {
                        B++;
                    }
                }
                
                return { A, B };
            }

            // 添加猜測結果訊息
            addGuessMessage(guess, result) {
                const resultText = `${result.A}A${result.B}B`;
                
                // 主對話區顯示
                this.addMessage(`第${this.gameState.rounds}回合：猜測 ${guess} → ${resultText}`, 'user');
                
                // 歷史記錄區顯示
                this.updateHistoryPanel();
                
                // 兒童模式視覺化
                if (this.gameState.childMode) {
                    this.showVisualResult(guess, result);
                }
            }

            // 兒童模式視覺化結果
            showVisualResult(guess, result) {
                const visual = '🔵'.repeat(result.A) + '🟡'.repeat(result.B) + '⚫'.repeat(this.gameState.digits - result.A - result.B);
                this.addMessage(`視覺提示：${visual}`, 'hint');
            }

            // 結束遊戲
            endGame(won) {
                this.gameState.isPlaying = false;
                this.stopTimer();
                
                const timeSpent = this.getGameTime();
                const score = {
                    won,
                    rounds: this.gameState.rounds,
                    time: timeSpent,
                    difficulty: `${this.gameState.digits}位數`,
                    hintsUsed: this.gameState.hintsUsed,
                    answer: this.gameState.answer
                };

                if (won) {
                    this.addMessage(`🎉 恭喜！您在第${this.gameState.rounds}回合猜中了答案：${this.gameState.answer}`, 'success');
                    this.addMessage(`⏱️ 用時：${timeSpent}`, 'success');
                    this.updateUserData(score);
                    this.checkAchievements(score);
                } else {
                    this.addMessage(`😢 遊戲結束！答案是：${this.gameState.answer}`, 'error');
                    this.addMessage(`💪 別灰心，再試一次吧！`, 'system');
                }

                this.updateUI();
            }

            // 計算A和B，並提供提示功能
            showHint() {
                if (this.gameState.hintsUsed >= this.gameState.maxHints) {
                    this.addMessage(`❌ 提示次數已用完！`, 'error');
                    return;
                }

                this.gameState.hintsUsed++;
                
                // 提供部分位置提示
                const hintIndex = Math.floor(Math.random() * this.gameState.digits);
                const hintDigit = this.gameState.answer[hintIndex];
                
                this.addMessage(`💡 提示：第${hintIndex + 1}位是數字 ${hintDigit}`, 'hint');
                this.updateUI();
            }

            // 添加對話訊息 - 支援不同類型的訊息樣式
            addMessage(text, type = 'system') {
                const dialog = document.getElementById('gameDialog');
                const messageDiv = document.createElement('div');
                messageDiv.className = `slide-in p-3 rounded-lg ${this.getMessageStyle(type)}`;
                messageDiv.textContent = text;
                
                dialog.appendChild(messageDiv);
                dialog.scrollTop = dialog.scrollHeight;
            }

            // 取得訊息樣式
            getMessageStyle(type) {
                const styles = {
                    system: 'bg-blue-50 text-blue-800 border-l-4 border-blue-400',
                    user: 'bg-green-50 text-green-800 border-l-4 border-green-400',
                    error: 'bg-red-50 text-red-800 border-l-4 border-red-400',
                    success: 'bg-emerald-50 text-emerald-800 border-l-4 border-emerald-400',
                    hint: 'bg-yellow-50 text-yellow-800 border-l-4 border-yellow-400'
                };
                return styles[type] || styles.system;
            }

            // 更新歷史記錄面板
            updateHistoryPanel() {
                const historyEl = document.getElementById('gameHistory');
                historyEl.innerHTML = '';
                
                if (this.gameState.gameHistory.length === 0) {
                    historyEl.innerHTML = '<div class="text-sm text-neutral-600 text-center py-4">尚無記錄</div>';
                    return;
                }

                this.gameState.gameHistory.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'flex justify-between items-center py-2 px-3 bg-neutral-50 rounded-lg text-sm';
                    entryDiv.innerHTML = `
                        <span class="font-mono">${entry.guess}</span>
                        <span class="font-semibold">${entry.result.A}A${entry.result.B}B</span>
                    `;
                    historyEl.appendChild(entryDiv);
                });
            }

            // 計時器管理
            startTimer() {
                this.timer = setInterval(() => {
                    document.getElementById('gameTime').textContent = this.getGameTime();
                }, 1000);
            }

            stopTimer() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
            }

            getGameTime() {
                if (!this.gameState.startTime) return '00:00';
                const diff = new Date() - this.gameState.startTime;
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // 使用者資料管理 - LocalStorage 持久化
            loadUserData() {
                const defaultData = {
                    uid: this.generateUID(),
                    level: 1,
                    experience: 0,
                    gamesPlayed: 0,
                    gamesWon: 0,
                    bestScores: {},
                    unlockedFeatures: [],
                    history: [],
                    achievements: []
                };

                const saved = localStorage.getItem('1a2b_userdata');
                return saved ? { ...defaultData, ...JSON.parse(saved) } : defaultData;
            }

            saveUserData() {
                localStorage.setItem('1a2b_userdata', JSON.stringify(this.userData));
            }

            updateUserData(score) {
                this.userData.gamesPlayed++;
                if (score.won) {
                    this.userData.gamesWon++;
                    
                    // 更新最佳記錄
                    const key = score.difficulty;
                    if (!this.userData.bestScores[key] || score.rounds < this.userData.bestScores[key].rounds) {
                        this.userData.bestScores[key] = {
                            rounds: score.rounds,
                            time: score.time,
                            date: new Date().toLocaleDateString()
                        };
                    }
                    
                    // 增加經驗值
                    this.addExperience(score);
                }

                // 添加歷史記錄
                this.userData.history.unshift({
                    date: new Date().toLocaleDateString(),
                    difficulty: score.difficulty,
                    rounds: score.rounds,
                    time: score.time,
                    won: score.won,
                    hintsUsed: score.hintsUsed
                });

                // 保持最近20場記錄
                this.userData.history = this.userData.history.slice(0, 20);
                
                this.saveUserData();
                this.updateUI();
            }

            // 經驗值與升級系統
            addExperience(score) {
                let exp = 10; // 基礎經驗

                // 難度加成
                exp += (score.difficulty.length - 2) * 5;
                
                // 回合數加成（越少回合越高分）
                exp += Math.max(0, 20 - score.rounds);
                
                // 無提示加成
                if (score.hintsUsed === 0) exp += 15;

                this.userData.experience += exp;
                
                // 檢查升級
                this.checkLevelUp();
            }

            checkLevelUp() {
                const newLevel = Math.floor(this.userData.experience / 100) + 1;
                if (newLevel > this.userData.level) {
                    this.userData.level = newLevel;
                    this.addMessage(`🎊 恭喜升級到 Lv.${newLevel}！`, 'success');
                    this.checkUnlocks();
                }
            }

            checkUnlocks() {
                // 解鎖6位數模式
                if (this.userData.level >= 5 && !this.userData.unlockedFeatures.includes('6digits')) {
                    this.userData.unlockedFeatures.push('6digits');
                    this.addMessage(`🔓 解鎖新功能：6位數困難模式！`, 'success');
                    document.getElementById('hardMode').disabled = false;
                    document.getElementById('hardMode').classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            // 成就系統
            initAchievements() {
                return [
                    { id: 'first_win', name: '初次勝利', desc: '完成第一場遊戲', icon: '🏆', unlocked: false },
                    { id: 'quick_win', name: '神速猜手', desc: '5回合內完成4位數', icon: '⚡', unlocked: false },
                    { id: 'perfect_game', name: '完美遊戲', desc: '不使用提示完成遊戲', icon: '💎', unlocked: false },
                    { id: 'hard_mode', name: '挑戰者', desc: '完成6位數困難模式', icon: '🔥', unlocked: false },
                    { id: 'explorer', name: '探索者', desc: '發現隱藏彩蛋', icon: '🔮', unlocked: false },
                    { id: 'veteran', name: '老手', desc: '遊玩達到50場', icon: '🎖️', unlocked: false }
                ];
            }

            checkAchievements(score) {
                const achievements = [];

                // 檢查各種成就條件
                if (score.won && !this.userData.achievements.includes('first_win')) {
                    achievements.push('first_win');
                }

                if (score.won && score.rounds <= 5 && score.difficulty === '4位數' && !this.userData.achievements.includes('quick_win')) {
                    achievements.push('quick_win');
                }

                if (score.won && score.hintsUsed === 0 && !this.userData.achievements.includes('perfect_game')) {
                    achievements.push('perfect_game');
                }

                if (score.won && score.difficulty === '6位數' && !this.userData.achievements.includes('hard_mode')) {
                    achievements.push('hard_mode');
                }

                if (this.userData.gamesPlayed >= 50 && !this.userData.achievements.includes('veteran')) {
                    achievements.push('veteran');
                }

                // 解鎖新成就
                achievements.forEach(id => {
                    this.userData.achievements.push(id);
                    const achievement = this.achievements.find(a => a.id === id);
                    achievement.unlocked = true;
                    this.addMessage(`🏆 解鎖成就：${achievement.name} - ${achievement.desc}`, 'success');
                });

                this.updateUI();
            }

            // 彩蛋功能
            checkEasterEgg() {
                // 監聽特殊按鍵組合
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                        this.triggerEasterEgg();
                    }
                });
            }

            triggerEasterEgg() {
                this.easterEggClicks++;
                
                if (this.easterEggClicks >= 3) {
                    document.getElementById('easterEggModal').classList.remove('hidden');
                    document.getElementById('easterEggModal').classList.add('flex');
                    
                    // 解鎖探索者成就
                    if (!this.userData.achievements.includes('explorer')) {
                        this.userData.achievements.push('explorer');
                        const achievement = this.achievements.find(a => a.id === 'explorer');
                        achievement.unlocked = true;
                        this.saveUserData();
                    }
                    
                    this.easterEggClicks = 0;
                }
            }

            hideEasterEgg() {
                document.getElementById('easterEggModal').classList.add('hidden');
                document.getElementById('easterEggModal').classList.remove('flex');
            }

            // UI更新方法
            updateUI() {
                // 更新遊戲狀態顯示
                document.getElementById('currentRound').textContent = this.gameState.rounds;
                document.getElementById('difficulty').textContent = `${this.gameState.digits}位數`;
                document.getElementById('userLevel').textContent = `Lv.${this.userData.level}`;

                // 根據遊戲狀態顯示/隱藏控制項
                if (this.gameState.isPlaying) {
                    document.getElementById('difficultySelection').classList.add('hidden');
                    document.getElementById('guessInput').classList.remove('hidden');
                    document.getElementById('gameEndControls').classList.add('hidden');
                    
                    // 兒童模式提示
                    if (this.gameState.childMode) {
                        document.getElementById('childHints').classList.remove('hidden');
                        document.getElementById('hintCount').textContent = this.gameState.maxHints - this.gameState.hintsUsed;
                    } else {
                        document.getElementById('childHints').classList.add('hidden');
                    }
                } else {
                    document.getElementById('difficultySelection').classList.remove('hidden');
                    document.getElementById('guessInput').classList.add('hidden');
                    
                    if (this.gameState.rounds > 0) {
                        document.getElementById('gameEndControls').classList.remove('hidden');
                    }
                }

                // 更新成就顯示
                this.updateAchievementsDisplay();
                
                // 更新最佳記錄顯示
                this.updateBestRecordsDisplay();
                
                // 檢查解鎖狀態
                this.updateUnlockStatus();
            }

            updateAchievementsDisplay() {
                const container = document.getElementById('achievements');
                container.innerHTML = '';

                this.achievements.forEach(achievement => {
                    const achievementEl = document.createElement('div');
                    achievementEl.className = `p-3 rounded-lg text-center transition-all duration-200 ${
                        achievement.unlocked 
                            ? 'achievement-badge text-white transform hover:scale-105' 
                            : 'bg-neutral-100 text-neutral-600'
                    }`;
                    
                    achievementEl.innerHTML = `
                        <div class="text-2xl mb-1">${achievement.icon}</div>
                        <div class="text-xs font-medium">${achievement.name}</div>
                        <div class="text-xs opacity-75">${achievement.desc}</div>
                    `;
                    
                    container.appendChild(achievementEl);
                });
            }

            updateBestRecordsDisplay() {
                const container = document.getElementById('bestRecords');
                container.innerHTML = '';

                if (Object.keys(this.userData.bestScores).length === 0) {
                    container.innerHTML = '<div class="text-sm text-neutral-600 text-center py-4">尚無記錄</div>';
                    return;
                }

                Object.entries(this.userData.bestScores).forEach(([difficulty, record]) => {
                    const recordEl = document.createElement('div');
                    recordEl.className = 'flex justify-between items-center p-3 bg-neutral-50 rounded-lg';
                    recordEl.innerHTML = `
                        <div>
                            <div class="font-medium text-neutral-800">${difficulty}</div>
                            <div class="text-xs text-neutral-600">${record.date}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-primary-600">${record.rounds}回合</div>
                            <div class="text-xs text-neutral-600">${record.time}</div>
                        </div>
                    `;
                    container.appendChild(recordEl);
                });
            }

            updateUnlockStatus() {
                // 更新6位數按鈕解鎖狀態
                const hardModeBtn = document.getElementById('hardMode');
                if (this.userData.unlockedFeatures.includes('6digits')) {
                    hardModeBtn.disabled = false;
                    hardModeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            // 輔助方法
            generateUID() {
                return Math.random().toString(36).substr(2, 9);
            }

            addWelcomeMessage() {
                this.addMessage('🎯 歡迎來到1A2B智慧遊戲！', 'system');
                this.addMessage('💡 規則說明：A表示數字和位置都正確，B表示數字正確但位置錯誤', 'system');
                this.addMessage('🎮 請選擇遊戲難度開始挑戰！', 'system');
            }

            resetGame() {
                this.gameState = {
                    ...this.gameState,
                    isPlaying: false,
                    rounds: 0,
                    gameHistory: []
                };
                
                this.stopTimer();
                document.getElementById('gameTime').textContent = '00:00';
                document.getElementById('gameDialog').innerHTML = '';
                document.getElementById('gameHistory').innerHTML = '<div class="text-sm text-neutral-600 text-center py-4">尚無記錄</div>';
                
                this.addWelcomeMessage();
                this.updateUI();
            }

            showSettings() {
                document.getElementById('settingsModal').classList.remove('hidden');
                document.getElementById('settingsModal').classList.add('flex');
            }

            hideSettings() {
                document.getElementById('settingsModal').classList.add('hidden');
                document.getElementById('settingsModal').classList.remove('flex');
            }

            resetUserData() {
                if (confirm('確定要清除所有遊戲記錄嗎？此操作無法復原！')) {
                    localStorage.removeItem('1a2b_userdata');
                    location.reload();
                }
            }

            showStats() {
                const winRate = this.userData.gamesPlayed > 0 ? 
                    Math.round((this.userData.gamesWon / this.userData.gamesPlayed) * 100) : 0;
                
                this.addMessage(`📊 您的統計數據：`, 'system');
                this.addMessage(`🎮 總遊戲場次：${this.userData.gamesPlayed}`, 'system');
                this.addMessage(`🏆 勝利場次：${this.userData.gamesWon}`, 'system');
                this.addMessage(`📈 勝率：${winRate}%`, 'system');
                this.addMessage(`⭐ 當前等級：Lv.${this.userData.level}`, 'system');
                this.addMessage(`💫 經驗值：${this.userData.experience}`, 'system');
            }
        }

        // 啟動遊戲 - DOM載入完成後初始化
        document.addEventListener('DOMContentLoaded', () => {
            const game = new Game1A2B();
            
            // 添加滾動動畫效果
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('slide-in');
                    }
                });
            });

            document.querySelectorAll('.game-card').forEach(card => {
                observer.observe(card);
            });
        });
    </script>
</body>
</html>